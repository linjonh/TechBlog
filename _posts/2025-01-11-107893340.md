---
layout: post
title: 微信小程序授权登录绑定手机号接口小程序
date: 2025-01-11 09:32:11 +0800
categories: [微信小程序]
tags: []
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=107893340
    alt: 微信小程序授权登录绑定手机号接口小程序
artid: 107893340
render_with_liquid: false
---
<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     微信小程序授权登录、绑定手机号(接口+小程序)
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <p>
    </p>
    <div class="toc">
     <h4>
      微信小程序授权登录、绑定手机号含接口和小程序
     </h4>
     <ul>
      <li>
       <ul>
        <li>
         <a href="#1_2" rel="nofollow">
          1、小程序授权登录
         </a>
        </li>
        <li>
         <ul>
          <li>
           <a href="#11_api_3" rel="nofollow">
            1.1、 微信公众平台小程序登录服务端api地址：
           </a>
          </li>
          <li>
           <a href="#12__5" rel="nofollow">
            1.2、 登录流程：
           </a>
          </li>
          <li>
           <a href="#13_GET__7" rel="nofollow">
            1.3、 请求地址(GET 请求)：
           </a>
          </li>
          <li>
           <a href="#14__9" rel="nofollow">
            1.4、 请求参数：
           </a>
          </li>
          <li>
           <a href="#15__JSON__17" rel="nofollow">
            1.5、 返回的 JSON 数据包
           </a>
          </li>
          <li>
           <a href="#16__26" rel="nofollow">
            1.6、 表结构
           </a>
          </li>
          <li>
           <a href="#17__28" rel="nofollow">
            1.7、 后台接口编写
           </a>
          </li>
          <li>
           <a href="#18__232" rel="nofollow">
            1.8、 小程序扫码
           </a>
          </li>
         </ul>
        </li>
        <li>
         <a href="#2__283" rel="nofollow">
          2、 获取手机号
         </a>
        </li>
        <li>
         <ul>
          <li>
           <a href="#21__284" rel="nofollow">
            2.1、 微信公众平台小程序获取手机号说明地址：
           </a>
          </li>
          <li>
           <a href="#22__286" rel="nofollow">
            2.2、 获取手机号
           </a>
          </li>
          <li>
           <a href="#23__294" rel="nofollow">
            2.3、 后台接口编写
           </a>
          </li>
          <li>
           <a href="#24__348" rel="nofollow">
            2.4、 小程序端
           </a>
          </li>
         </ul>
        </li>
        <li>
         <a href="#3__408" rel="nofollow">
          3、 充值(小程序支付)
         </a>
        </li>
        <li>
         <ul>
          <li>
           <a href="#31_409" rel="nofollow">
            3.1、微信支付官方地址：
           </a>
          </li>
          <li>
           <a href="#32_422" rel="nofollow">
            3.2、业务流程时序图
           </a>
          </li>
          <li>
           <a href="#33__439" rel="nofollow">
            3.3、 后台接口
           </a>
          </li>
          <li>
           <ul>
            <li>
             <a href="#34sdk_440" rel="nofollow">
              3.4、支付我采用sdk进行实现，地址：
             </a>
            </li>
            <li>
             <a href="#35SDKXML_575" rel="nofollow">
              3.5、不用SDK，手动编写，需要自己对参数值进行XML转义，提供工具类如下：
             </a>
            </li>
            <li>
             <a href="#36_747" rel="nofollow">
              3.6、小程序端调用
             </a>
            </li>
           </ul>
          </li>
         </ul>
        </li>
        <li>
         <a href="#4GitHub_790" rel="nofollow">
          4、GitHub地址：
         </a>
        </li>
       </ul>
      </li>
     </ul>
    </div>
    <br/>
    本篇博客主要为了记录小程序授权登录和绑定手机号功能的实现，包含小程序端和API(java语言开发)。
    <p>
    </p>
    <h3>
     <a id="1_2">
     </a>
     1、小程序授权登录
    </h3>
    <h4>
     <a id="11_api_3">
     </a>
     1.1、 微信公众平台小程序登录服务端api地址：
    </h4>
    <p>
     <a href="https://developers.weixin.qq.com/miniprogram/dev/api-backend/open-api/login/auth.code2Session.html" rel="nofollow">
      https://developers.weixin.qq.com/miniprogram/dev/api-backend/open-api/login/auth.code2Session.html
     </a>
    </p>
    <h4>
     <a id="12__5">
     </a>
     1.2、 登录流程：
    </h4>
    <p>
     登录凭证校验。通过 wx.login 接口(小程序操作)获得临时登录凭证 code 后传到开发者服务器调用此接口完成登录流程。
    </p>
    <h4>
     <a id="13_GET__7">
     </a>
     1.3、 请求地址(GET 请求)：
    </h4>
    <p>
     https://api.weixin.qq.com/sns/jscode2session?appid=APPID&amp;secret=SECRET&amp;js_code=JSCODE&amp;grant_type=authorization_code
    </p>
    <h4>
     <a id="14__9">
     </a>
     1.4、 请求参数：
    </h4>
    <table>
     <thead>
      <tr>
       <th>
        属性
       </th>
       <th>
        类型
       </th>
       <th>
        默认值
       </th>
       <th>
        必填
       </th>
       <th>
        说明
       </th>
      </tr>
     </thead>
     <tbody>
      <tr>
       <td>
        appid
       </td>
       <td>
        string
       </td>
       <td>
       </td>
       <td>
        是
       </td>
       <td>
        小程序 appId
       </td>
      </tr>
      <tr>
       <td>
        secret
       </td>
       <td>
        string
       </td>
       <td>
       </td>
       <td>
        是
       </td>
       <td>
        小程序 appSecret
       </td>
      </tr>
      <tr>
       <td>
        js_code
       </td>
       <td>
        string
       </td>
       <td>
       </td>
       <td>
        是
       </td>
       <td>
        登录时获取的 code
       </td>
      </tr>
      <tr>
       <td>
        grant_type
       </td>
       <td>
        string
       </td>
       <td>
       </td>
       <td>
        是
       </td>
       <td>
        授权类型，此处只需填写 authorization_code
       </td>
      </tr>
     </tbody>
    </table>
    <h4>
     <a id="15__JSON__17">
     </a>
     1.5、 返回的 JSON 数据包
    </h4>
    <table>
     <thead>
      <tr>
       <th>
        属性
       </th>
       <th>
        类型
       </th>
       <th>
        说明
       </th>
      </tr>
     </thead>
     <tbody>
      <tr>
       <td>
        openid
       </td>
       <td>
        string
       </td>
       <td>
        用户唯一标识
       </td>
      </tr>
      <tr>
       <td>
        session_key
       </td>
       <td>
        string
       </td>
       <td>
        会话密钥
       </td>
      </tr>
      <tr>
       <td>
        unionid
       </td>
       <td>
        string
       </td>
       <td>
        用户在开放平台的唯一标识符，在满足 UnionID 下发条件的情况下会返回。
       </td>
      </tr>
      <tr>
       <td>
        errcode
       </td>
       <td>
        number
       </td>
       <td>
        错误码
       </td>
      </tr>
      <tr>
       <td>
        errmsg
       </td>
       <td>
        string
       </td>
       <td>
        错误信息
       </td>
      </tr>
     </tbody>
    </table>
    <h4>
     <a id="16__26">
     </a>
     1.6、 表结构
    </h4>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/913619e16666be54662fef6f8aa7541a.png"/>
    </p>
    <h4>
     <a id="17__28">
     </a>
     1.7、 后台接口编写
    </h4>
    <pre><code class="prism language-java"><span class="token annotation punctuation">@ApiOperation</span><span class="token punctuation">(</span><span class="token string">"微信授权登陆"</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"/wxUserLogin"</span><span class="token punctuation">,</span> method <span class="token operator">=</span> RequestMethod<span class="token punctuation">.</span>POST<span class="token punctuation">)</span>
<span class="token annotation punctuation">@ResponseBody</span>
<span class="token annotation punctuation">@ApiImplicitParams</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
  <span class="token annotation punctuation">@ApiImplicitParam</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"code"</span><span class="token punctuation">,</span> value <span class="token operator">=</span> <span class="token string">"CODE"</span><span class="token punctuation">,</span> required <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span> dataType <span class="token operator">=</span> <span class="token string">"String"</span><span class="token punctuation">,</span> paramType <span class="token operator">=</span> <span class="token string">"query"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token annotation punctuation">@ApiImplicitParam</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"avatar"</span><span class="token punctuation">,</span> value <span class="token operator">=</span> <span class="token string">"avatarUrl"</span><span class="token punctuation">,</span> required <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span> dataType <span class="token operator">=</span> <span class="token string">"String"</span><span class="token punctuation">,</span> paramType <span class="token operator">=</span> <span class="token string">"query"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token annotation punctuation">@ApiImplicitParam</span><span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">"nickName"</span><span class="token punctuation">,</span>value<span class="token operator">=</span><span class="token string">"昵称"</span><span class="token punctuation">,</span>required <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span>dataType <span class="token operator">=</span> <span class="token string">"String"</span><span class="token punctuation">,</span>paramType <span class="token operator">=</span> <span class="token string">"query"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> CommonResult <span class="token function">wxUserLogin</span><span class="token punctuation">(</span>String code<span class="token punctuation">,</span> String avatar<span class="token punctuation">,</span> String nickName<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{<!-- --></span>
    Map<span class="token generics function"><span class="token punctuation">&lt;</span>String<span class="token punctuation">,</span> Object<span class="token punctuation">&gt;</span></span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token operator">&lt;</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    StringBuffer buffer<span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuffer</span><span class="token punctuation">(</span><span class="token string">"https://api.weixin.qq.com/sns/jscode2session?appid="</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>appId<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">"&amp;secret="</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>appIdSecret<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">"&amp;js_code="</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">"&amp;grant_type=authorization_code"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    String jsonString <span class="token operator">=</span> HttpRequest<span class="token punctuation">.</span><span class="token function">sendGet</span><span class="token punctuation">(</span>buffer<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    JSONObject jsStrs <span class="token operator">=</span> JSONObject<span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>jsonString<span class="token punctuation">)</span><span class="token punctuation">;</span>
    String openId <span class="token operator">=</span> jsStrs<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">"openid"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    String sessionKey <span class="token operator">=</span> jsStrs<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">"session_key"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"openId"</span><span class="token punctuation">,</span> openId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"sessionKey"</span><span class="token punctuation">,</span> sessionKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
    map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"mobileFlag"</span><span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>openId <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//查询用户信息</span>
        User user <span class="token operator">=</span>userService<span class="token punctuation">.</span><span class="token function">getUserByOpenId</span><span class="token punctuation">(</span>openId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>user<span class="token operator">==</span>null<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            user<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            user<span class="token punctuation">.</span><span class="token function">setNickName</span><span class="token punctuation">(</span>nickName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            user<span class="token punctuation">.</span><span class="token function">setOpenId</span><span class="token punctuation">(</span>openId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            user<span class="token punctuation">.</span><span class="token function">setHeadPortrait</span><span class="token punctuation">(</span>avatar<span class="token punctuation">)</span><span class="token punctuation">;</span>
            userService<span class="token punctuation">.</span><span class="token function">insertUser</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getMobile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">!=</span>null<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"mobileFlag"</span><span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"user"</span><span class="token punctuation">,</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">CommonResult</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span><span class="token string">"操作成功"</span><span class="token punctuation">,</span>map<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <pre><code class="prism language-java"><span class="token annotation punctuation">@EnableAutoConfiguration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HttpRequest</span> <span class="token punctuation">{<!-- --></span>
<span class="token keyword">public</span> <span class="token keyword">static</span> String <span class="token function">sendGet</span><span class="token punctuation">(</span>String url<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{<!-- --></span>
    String result <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span> 
    BufferedReader in <span class="token operator">=</span> null<span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
        URL realUrl <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URL</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 打开和URL之间的连接</span>
        URLConnection connection <span class="token operator">=</span> realUrl<span class="token punctuation">.</span><span class="token function">openConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 设置通用的请求属性</span>
        connection<span class="token punctuation">.</span><span class="token function">setRequestProperty</span><span class="token punctuation">(</span><span class="token string">"accept"</span><span class="token punctuation">,</span> <span class="token string">"*/*"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        connection<span class="token punctuation">.</span><span class="token function">setRequestProperty</span><span class="token punctuation">(</span><span class="token string">"Accept-Charset"</span><span class="token punctuation">,</span> <span class="token string">"UTF-8"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        connection<span class="token punctuation">.</span><span class="token function">setRequestProperty</span><span class="token punctuation">(</span><span class="token string">"contentType"</span><span class="token punctuation">,</span> <span class="token string">"UTF-8"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        connection<span class="token punctuation">.</span><span class="token function">setRequestProperty</span><span class="token punctuation">(</span><span class="token string">"connection"</span><span class="token punctuation">,</span> <span class="token string">"Keep-Alive"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        connection<span class="token punctuation">.</span><span class="token function">setRequestProperty</span><span class="token punctuation">(</span><span class="token string">"Content-type"</span><span class="token punctuation">,</span> <span class="token string">"application/x-www-form-urlencoded;charset=UTF-8"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        connection<span class="token punctuation">.</span><span class="token function">setRequestProperty</span><span class="token punctuation">(</span><span class="token string">"user-agent"</span><span class="token punctuation">,</span>
                <span class="token string">"Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1;SV1)"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 建立实际的连接</span>
        connection<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">/</span><span class="token operator">/</span> 获取所有响应头字段
        Map<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> List<span class="token generics function"><span class="token punctuation">&lt;</span>String<span class="token punctuation">&gt;</span></span><span class="token operator">&gt;</span> map <span class="token operator">=</span> connection<span class="token punctuation">.</span><span class="token function">getHeaderFields</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">/</span><span class="token operator">/</span> 遍历所有的响应头字段
        <span class="token keyword">for</span> <span class="token punctuation">(</span>String key <span class="token operator">:</span> map<span class="token punctuation">.</span><span class="token function">keySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>key <span class="token operator">+</span> <span class="token string">"---&gt;"</span> <span class="token operator">+</span> map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token operator">/</span><span class="token operator">/</span> 定义 BufferedReader输入流来读取URL的响应
        in <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BufferedReader</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">InputStreamReader</span><span class="token punctuation">(</span>connection<span class="token punctuation">.</span><span class="token function">getInputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"UTF-8"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        String line<span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>line <span class="token operator">=</span> in<span class="token punctuation">.</span><span class="token function">readLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            result <span class="token operator">+=</span> line<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"发送GET请求出现异常！"</span> <span class="token operator">+</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Exception</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token operator">/</span><span class="token operator">/</span> 使用<span class="token keyword">finally</span>块来关闭输入流
    <span class="token keyword">finally</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>in <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                in<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e2<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            e2<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">/**
 * 向指定 URL 发送POST方法的请求
 * 
 * @param url
 *            发送请求的 URL
 * @param param
 *            请求参数，请求参数应该是 name1=value1&amp;name2=value2 的形式。
 * @return 所代表远程资源的响应结果
 */</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> String <span class="token function">sendPost</span><span class="token punctuation">(</span>String url<span class="token punctuation">,</span> String param<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	OutputStreamWriter out <span class="token operator">=</span> null<span class="token punctuation">;</span>
    BufferedReader in <span class="token operator">=</span> null<span class="token punctuation">;</span>
    String result <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
        URL realUrl <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URL</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 打开和URL之间的连接</span>
        URLConnection conn <span class="token operator">=</span> realUrl<span class="token punctuation">.</span><span class="token function">openConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 设置通用的请求属性</span>
        conn<span class="token punctuation">.</span><span class="token function">setRequestProperty</span><span class="token punctuation">(</span><span class="token string">"accept"</span><span class="token punctuation">,</span> <span class="token string">"*/*"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        conn<span class="token punctuation">.</span><span class="token function">setRequestProperty</span><span class="token punctuation">(</span><span class="token string">"connection"</span><span class="token punctuation">,</span> <span class="token string">"Keep-Alive"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        conn<span class="token punctuation">.</span><span class="token function">setRequestProperty</span><span class="token punctuation">(</span><span class="token string">"user-agent"</span><span class="token punctuation">,</span>
                <span class="token string">"Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1;SV1)"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//设置请求编码格式</span>
        conn<span class="token punctuation">.</span><span class="token function">setRequestProperty</span><span class="token punctuation">(</span><span class="token string">"Accept-Charset"</span><span class="token punctuation">,</span> <span class="token string">"UTF-8"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        conn<span class="token punctuation">.</span><span class="token function">setRequestProperty</span><span class="token punctuation">(</span><span class="token string">"contentType"</span><span class="token punctuation">,</span> <span class="token string">"UTF-8"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">/</span><span class="token operator">/</span> 发送POST请求必须设置如下两行
        conn<span class="token punctuation">.</span><span class="token function">setDoOutput</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        conn<span class="token punctuation">.</span><span class="token function">setDoInput</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">/</span><span class="token operator">/</span> 获取URLConnection对象对应的输出流
        out <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OutputStreamWriter</span><span class="token punctuation">(</span>conn<span class="token punctuation">.</span><span class="token function">getOutputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"UTF-8"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
        <span class="token operator">/</span><span class="token operator">/</span> 发送请求参数
        out<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>param<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">/</span><span class="token operator">/</span> flush输出流的缓冲
        out<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">/</span><span class="token operator">/</span> 定义BufferedReader输入流来读取URL的响应
        in <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BufferedReader</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">InputStreamReader</span><span class="token punctuation">(</span>conn<span class="token punctuation">.</span><span class="token function">getInputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">"UTF-8"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        String line<span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>line <span class="token operator">=</span> in<span class="token punctuation">.</span><span class="token function">readLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            result <span class="token operator">+=</span> line<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"发送 POST 请求出现异常！"</span><span class="token operator">+</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token operator">/</span><span class="token operator">/</span>使用<span class="token keyword">finally</span>块来关闭输出流、输入流
    <span class="token keyword">finally</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">try</span><span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>out<span class="token operator">!=</span>null<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                out<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>in<span class="token operator">!=</span>null<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                in<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">catch</span><span class="token punctuation">(</span>IOException ex<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            ex<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span>    
<span class="token keyword">public</span> <span class="token keyword">static</span> String <span class="token function">sendPost1</span><span class="token punctuation">(</span>String url<span class="token punctuation">,</span> String dataparam<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    String result <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>
    BufferedReader in <span class="token operator">=</span> null<span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">/*"/GPServer/"+ method +*/</span>
    String urlNameString <span class="token operator">=</span> url<span class="token punctuation">;</span>
        URL realUrl <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URL</span><span class="token punctuation">(</span>urlNameString<span class="token punctuation">)</span><span class="token punctuation">;</span>
        URLConnection connection <span class="token operator">=</span> realUrl<span class="token punctuation">.</span><span class="token function">openConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//设置网络请求时间最多为5秒；</span>
        connection<span class="token punctuation">.</span><span class="token function">setConnectTimeout</span><span class="token punctuation">(</span><span class="token number">5000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">//读取网页请求结果时间为15秒</span>
        connection<span class="token punctuation">.</span><span class="token function">setReadTimeout</span><span class="token punctuation">(</span><span class="token number">25000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//设置网络请求时间最多为5秒；</span>
        <span class="token comment">// 设置通用的请求属性</span>
        connection<span class="token punctuation">.</span><span class="token function">setRequestProperty</span><span class="token punctuation">(</span><span class="token string">"accept"</span><span class="token punctuation">,</span> <span class="token string">"*/*"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        connection<span class="token punctuation">.</span><span class="token function">setRequestProperty</span><span class="token punctuation">(</span><span class="token string">"connection"</span><span class="token punctuation">,</span> <span class="token string">"Keep-Alive"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        connection<span class="token punctuation">.</span><span class="token function">setRequestProperty</span><span class="token punctuation">(</span><span class="token string">"user-agent"</span><span class="token punctuation">,</span>
                <span class="token string">"Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1;SV1)"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        connection<span class="token punctuation">.</span><span class="token function">setDoOutput</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
        connection<span class="token punctuation">.</span><span class="token function">setDoInput</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
        <span class="token comment">//设置请求编码格式</span>
        connection<span class="token punctuation">.</span><span class="token function">setRequestProperty</span><span class="token punctuation">(</span><span class="token string">"Accept-Charset"</span><span class="token punctuation">,</span> <span class="token string">"UTF-8"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        connection<span class="token punctuation">.</span><span class="token function">setRequestProperty</span><span class="token punctuation">(</span><span class="token string">"contentType"</span><span class="token punctuation">,</span> <span class="token string">"UTF-8"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">/</span><span class="token operator">/</span> 获取URLConnection对象对应的输出流  
<span class="token operator">/</span><span class="token operator">/</span>            String dataparam<span class="token operator">=</span><span class="token string">"f=pjson&amp;name=张三"</span><span class="token punctuation">;</span>
       <span class="token operator">/</span><span class="token operator">/</span>文件流编码设置
        OutputStreamWriter out <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OutputStreamWriter</span><span class="token punctuation">(</span>connection<span class="token punctuation">.</span><span class="token function">getOutputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"UTF-8"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
        out<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>dataparam<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">/</span><span class="token operator">/</span>错误方式，这种方式容易出现乱码
        <span class="token operator">/</span><span class="token operator">/</span> PrintWriter out <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PrintWriter</span><span class="token punctuation">(</span>connection<span class="token punctuation">.</span><span class="token function">getOutputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
        <span class="token operator">/</span><span class="token operator">/</span> flush输出流的缓冲  
        out<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
        in <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BufferedReader</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">InputStreamReader</span><span class="token punctuation">(</span>connection<span class="token punctuation">.</span><span class="token function">getInputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">"UTF-8"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        String line<span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>line <span class="token operator">=</span> in<span class="token punctuation">.</span><span class="token function">readLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            result <span class="token operator">+=</span> line<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    	e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token operator">/</span><span class="token operator">/</span> 使用<span class="token keyword">finally</span>块来关闭输入流
    <span class="token keyword">finally</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>in <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                in<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e2<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            e2<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <h4>
     <a id="18__232">
     </a>
     1.8、 小程序扫码
    </h4>
    <pre><code class="prism language-java">wx<span class="token punctuation">.</span><span class="token function">getSetting</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
 success<span class="token operator">:</span> res <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">{<!-- --></span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>res<span class="token punctuation">.</span>authSetting<span class="token punctuation">[</span><span class="token string">'scope.userInfo'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    var that <span class="token operator">=</span> <span class="token keyword">this</span>
    <span class="token comment">// 登录</span>
    wx<span class="token punctuation">.</span><span class="token function">login</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
      success<span class="token operator">:</span> res <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 发送 res.code 到后台换取 openId, sessionKey</span>
        wx<span class="token punctuation">.</span><span class="token function">getUserInfo</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
          withCredentials<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
          success<span class="token operator">:</span> function <span class="token punctuation">(</span>res_user<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            that<span class="token punctuation">.</span>globalData<span class="token punctuation">.</span>userInfo <span class="token operator">=</span> res_user<span class="token punctuation">.</span>userInfo<span class="token punctuation">;</span>
            debugger
            wx<span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
              url<span class="token operator">:</span> <span class="token function">getApp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>globalData<span class="token punctuation">.</span>servsers <span class="token operator">+</span> <span class="token string">'/custom/api/wxUserLogin'</span><span class="token punctuation">,</span>
              data<span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> code<span class="token operator">:</span> res<span class="token punctuation">.</span>code<span class="token punctuation">,</span> avatar<span class="token operator">:</span> res_user<span class="token punctuation">.</span>userInfo<span class="token punctuation">.</span>avatarUrl<span class="token punctuation">,</span>nickName<span class="token operator">:</span> res_user<span class="token punctuation">.</span>userInfo<span class="token punctuation">.</span>nickName <span class="token punctuation">}</span><span class="token punctuation">,</span>
              method<span class="token operator">:</span> <span class="token string">'POST'</span><span class="token punctuation">,</span>
              header<span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token string">"Content-Type"</span><span class="token operator">:</span> <span class="token string">"application/x-www-form-urlencoded"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
              success<span class="token operator">:</span> function <span class="token punctuation">(</span>res<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
               console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>JSON<span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                that<span class="token punctuation">.</span>globalData<span class="token punctuation">.</span>openId <span class="token operator">=</span> res<span class="token punctuation">.</span>data<span class="token punctuation">.</span>openId<span class="token punctuation">;</span>
                that<span class="token punctuation">.</span>globalData<span class="token punctuation">.</span>sessionKey <span class="token operator">=</span> res<span class="token punctuation">.</span>data<span class="token punctuation">.</span>sessionKey<span class="token punctuation">;</span>
                that<span class="token punctuation">.</span>globalData<span class="token punctuation">.</span>userInfo <span class="token operator">=</span> res<span class="token punctuation">.</span>data<span class="token punctuation">.</span>user<span class="token punctuation">;</span>
                wx<span class="token punctuation">.</span><span class="token function">hideLoading</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token punctuation">}</span><span class="token punctuation">,</span> fail<span class="token operator">:</span> function <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                wx<span class="token punctuation">.</span><span class="token function">hideLoading</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token comment">// });</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span> fail<span class="token operator">:</span> function <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            debugger<span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token comment">// }</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span> fail<span class="token operator">:</span> function <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        debugger<span class="token punctuation">;</span>
        wx<span class="token punctuation">.</span><span class="token function">hideLoading</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token comment">// }</span>
    <span class="token comment">// })</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// wx.redirectTo({<!-- --></span>
    <span class="token comment">//   url: '/pages/getuser/index',</span>
    <span class="token comment">// })</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre>
    <h3>
     <a id="2__283">
     </a>
     2、 获取手机号
    </h3>
    <h4>
     <a id="21__284">
     </a>
     2.1、 微信公众平台小程序获取手机号说明地址：
    </h4>
    <p>
     <a href="https://developers.weixin.qq.com/miniprogram/dev/framework/open-ability/getPhoneNumber.html" rel="nofollow">
      https://developers.weixin.qq.com/miniprogram/dev/framework/open-ability/getPhoneNumber.html
     </a>
    </p>
    <h4>
     <a id="22__286">
     </a>
     2.2、 获取手机号
    </h4>
    <p>
     获取微信用户绑定的手机号，需先调用wx.login接口。
     <br/>
     因为需要用户主动触发才能发起获取手机号接口，所以该功能不由 API 来调用，需用 button 组件的点击来触发。
     <br/>
     <strong>
      注意
     </strong>
     目前该接口针对非个人开发者，且完成了认证的小程序开放（不包含海外主体）。需谨慎使用，若用户举报较多或被发现在不必要场景下使用，微信有权永久回收该小程序的该接口权限。
     <br/>
     <strong>
      使用方法
     </strong>
     <br/>
     需要将 button 组件 open-type 的值设置为 getPhoneNumber，当用户点击并同意之后，可以通过 bindgetphonenumber 事件回调获取到微信服务器返回的加密数据， 然后在第三方服务端结合 session_key 以及 app_id 进行解密获取手机号。
     <br/>
     <strong>
      注意
     </strong>
     <br/>
     在回调中调用 wx.login 登录，可能会刷新登录态。此时服务器使用 code 换取的 sessionKey 不是加密时使用的 sessionKey，导致解密失败。建议开发者提前进行 login；或者在回调中先使用 checkSession 进行登录态检查，避免 login 刷新登录态。
    </p>
    <h4>
     <a id="23__294">
     </a>
     2.3、 后台接口编写
    </h4>
    <pre><code class="prism language-java"><span class="token comment">//Controller层</span>
<span class="token annotation punctuation">@ApiOperation</span><span class="token punctuation">(</span><span class="token string">"绑定手机号码"</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"/bindMobile"</span><span class="token punctuation">,</span> method <span class="token operator">=</span> RequestMethod<span class="token punctuation">.</span>POST<span class="token punctuation">)</span>
<span class="token annotation punctuation">@ResponseBody</span>
<span class="token annotation punctuation">@ApiImplicitParams</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
        <span class="token annotation punctuation">@ApiImplicitParam</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"openId"</span><span class="token punctuation">,</span> value <span class="token operator">=</span> <span class="token string">"OPENID"</span><span class="token punctuation">,</span> required <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span> dataType <span class="token operator">=</span> <span class="token string">"String"</span><span class="token punctuation">,</span> paramType <span class="token operator">=</span> <span class="token string">"query"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token annotation punctuation">@ApiImplicitParam</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"id"</span><span class="token punctuation">,</span> value <span class="token operator">=</span> <span class="token string">"用户id"</span><span class="token punctuation">,</span> required <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span> dataType <span class="token operator">=</span> <span class="token string">"Long"</span><span class="token punctuation">,</span> paramType <span class="token operator">=</span> <span class="token string">"query"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token annotation punctuation">@ApiImplicitParam</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"encrypData"</span><span class="token punctuation">,</span> value <span class="token operator">=</span> <span class="token string">"encrypData"</span><span class="token punctuation">,</span> required <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span> dataType <span class="token operator">=</span> <span class="token string">"String"</span><span class="token punctuation">,</span> paramType <span class="token operator">=</span> <span class="token string">"query"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token annotation punctuation">@ApiImplicitParam</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"iv"</span><span class="token punctuation">,</span> value <span class="token operator">=</span> <span class="token string">"iv"</span><span class="token punctuation">,</span> required <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span> dataType <span class="token operator">=</span> <span class="token string">"String"</span><span class="token punctuation">,</span> paramType <span class="token operator">=</span> <span class="token string">"query"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token annotation punctuation">@ApiImplicitParam</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"sessionKey"</span><span class="token punctuation">,</span> value <span class="token operator">=</span> <span class="token string">"sessionKey"</span><span class="token punctuation">,</span> required <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span> dataType <span class="token operator">=</span> <span class="token string">"String"</span><span class="token punctuation">,</span> paramType <span class="token operator">=</span> <span class="token string">"query"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> CommonResult <span class="token function">bindMobile</span><span class="token punctuation">(</span>String openId<span class="token punctuation">,</span> Long id<span class="token punctuation">,</span> String encrypData<span class="token punctuation">,</span> String iv<span class="token punctuation">,</span> String sessionKey <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
        User user <span class="token operator">=</span> userService<span class="token punctuation">.</span><span class="token function">getUserByIdAndOpenId</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span>openId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>user<span class="token operator">==</span>null<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">CommonResult</span><span class="token punctuation">(</span><span class="token number">203</span><span class="token punctuation">,</span><span class="token string">"用户校验失败"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"Bind_RequestJson==================&gt;&gt;&gt;&gt; openId="</span><span class="token operator">+</span>openId<span class="token operator">+</span><span class="token string">",encrypData="</span><span class="token operator">+</span>encrypData<span class="token operator">+</span><span class="token string">",iv="</span><span class="token operator">+</span>iv<span class="token operator">+</span><span class="token string">",sessionKey:"</span><span class="token operator">+</span>sessionKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> userService<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>user<span class="token punctuation">,</span>encrypData<span class="token punctuation">,</span> iv<span class="token punctuation">,</span> sessionKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"BindError===&gt;"</span><span class="token operator">+</span>e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">CommonResult</span><span class="token punctuation">(</span><span class="token number">203</span><span class="token punctuation">,</span><span class="token string">"操作失败"</span><span class="token punctuation">,</span>e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">//Service层</span>
<span class="token annotation punctuation">@Override</span>
 <span class="token keyword">public</span> CommonResult <span class="token function">bind</span><span class="token punctuation">(</span>User user<span class="token punctuation">,</span> String encrypData<span class="token punctuation">,</span> String iv<span class="token punctuation">,</span> String sessionKey<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
     String str <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>
     Map map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
         str <span class="token operator">=</span> AESDecodeUtils<span class="token punctuation">.</span><span class="token function">decrypt</span><span class="token punctuation">(</span>encrypData<span class="token punctuation">,</span> iv<span class="token punctuation">,</span> sessionKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
         e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">CommonResult</span><span class="token punctuation">(</span><span class="token number">203</span><span class="token punctuation">,</span><span class="token string">"获取手机号码失败"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
     JSONObject jsStrs <span class="token operator">=</span> JSONObject<span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span>
     String phoneNumber <span class="token operator">=</span> jsStrs<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">"phoneNumber"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>StringUtils<span class="token punctuation">.</span><span class="token function">isNotBlank</span><span class="token punctuation">(</span>phoneNumber<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
         <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">CommonResult</span><span class="token punctuation">(</span><span class="token number">203</span><span class="token punctuation">,</span><span class="token string">"获取手机号码失败"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
     user<span class="token punctuation">.</span><span class="token function">setMobile</span><span class="token punctuation">(</span>phoneNumber<span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">updateUser</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
     map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"mobileFlag"</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"user"</span><span class="token punctuation">,</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">CommonResult</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span><span class="token string">"绑定手机号成功"</span><span class="token punctuation">,</span> map<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>

 <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">updateUser</span><span class="token punctuation">(</span>User user<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
     <span class="token keyword">return</span> userMapper<span class="token punctuation">.</span><span class="token function">updateUser</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
</code></pre>
    <h4>
     <a id="24__348">
     </a>
     2.4、 小程序端
    </h4>
    <pre><code class="prism language-java"><span class="token operator">&lt;</span>button open<span class="token operator">-</span>type<span class="token operator">=</span><span class="token string">"getPhoneNumber"</span> style<span class="token operator">=</span><span class="token string">"background-color: #4c5870;color: #ffffff;margin: 20px;border-radius:0px"</span> bindgetphonenumber<span class="token operator">=</span><span class="token string">"getPhoneNumber"</span><span class="token operator">&gt;</span>手机号授权<span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span>
</code></pre>
    <pre><code class="prism language-java">getPhoneNumber<span class="token operator">:</span> function <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
 var encryptedData <span class="token operator">=</span> e<span class="token punctuation">.</span>detail<span class="token punctuation">.</span>encryptedData<span class="token punctuation">;</span>
 var iv <span class="token operator">=</span> e<span class="token punctuation">.</span>detail<span class="token punctuation">.</span>iv<span class="token punctuation">;</span>
 var thatss <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span>detail<span class="token punctuation">.</span>errMsg <span class="token operator">==</span> <span class="token string">'getPhoneNumber:fail user deny'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">//用户点击拒绝</span>
wx<span class="token punctuation">.</span><span class="token function">showModal</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
  title<span class="token operator">:</span> <span class="token string">'手机号未授权'</span><span class="token punctuation">,</span>
  content<span class="token operator">:</span> <span class="token string">'如需正常使用小程序功能，请按确定后并重新点击【手机号授权】按钮，然后选择【允许】'</span><span class="token punctuation">,</span>
  showCancel<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  success<span class="token operator">:</span> function <span class="token punctuation">(</span>res<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>res<span class="token punctuation">.</span>confirm<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
wx<span class="token punctuation">.</span><span class="token function">showLoading</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
  title<span class="token operator">:</span> <span class="token string">'Loading...'</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
wx<span class="token punctuation">.</span><span class="token function">login</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
  success<span class="token operator">:</span> function <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    wx<span class="token punctuation">.</span><span class="token function">getUserInfo</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
      success<span class="token operator">:</span> function <span class="token punctuation">(</span>res<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        let promise <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span>function <span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token function">getApp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>globalData<span class="token punctuation">.</span>userInfo <span class="token operator">=</span> res<span class="token punctuation">.</span>userInfo<span class="token punctuation">;</span>
          wx<span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
            url<span class="token operator">:</span> <span class="token function">getApp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>globalData<span class="token punctuation">.</span>servsers <span class="token operator">+</span> <span class="token string">'/api/wechat/custom/wxUserLogin'</span><span class="token punctuation">,</span>
            data<span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> code<span class="token operator">:</span> res<span class="token punctuation">.</span>code<span class="token punctuation">,</span> avatar<span class="token operator">:</span> res_user<span class="token punctuation">.</span>userInfo<span class="token punctuation">.</span>avatarUrl<span class="token punctuation">,</span> nickName<span class="token operator">:</span> res_user<span class="token punctuation">.</span>userInfo<span class="token punctuation">.</span>nickName <span class="token punctuation">}</span><span class="token punctuation">,</span>
            method<span class="token operator">:</span> <span class="token string">'POST'</span><span class="token punctuation">,</span>
            header<span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token string">"Content-Type"</span><span class="token operator">:</span> <span class="token string">"application/x-www-form-urlencoded"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
            success<span class="token operator">:</span> function <span class="token punctuation">(</span>res<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
              console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>JSON<span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              that<span class="token punctuation">.</span>globalData<span class="token punctuation">.</span>openId <span class="token operator">=</span> res<span class="token punctuation">.</span>data<span class="token punctuation">.</span>openId<span class="token punctuation">;</span>
              that<span class="token punctuation">.</span>globalData<span class="token punctuation">.</span>sessionKey <span class="token operator">=</span> res<span class="token punctuation">.</span>data<span class="token punctuation">.</span>sessionKey<span class="token punctuation">;</span>
              that<span class="token punctuation">.</span>globalData<span class="token punctuation">.</span>userInfo <span class="token operator">=</span> res<span class="token punctuation">.</span>data<span class="token punctuation">.</span>user<span class="token punctuation">;</span>
              wx<span class="token punctuation">.</span><span class="token function">hideLoading</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span> fail<span class="token operator">:</span> function <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
              wx<span class="token punctuation">.</span><span class="token function">hideLoading</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      fail<span class="token operator">:</span> function <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        wx<span class="token punctuation">.</span><span class="token function">hideLoading</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        debugger<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> fail<span class="token operator">:</span> function <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    wx<span class="token punctuation">.</span><span class="token function">hideLoading</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    debugger<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <h3>
     <a id="3__408">
     </a>
     3、 充值(小程序支付)
    </h3>
    <h4>
     <a id="31_409">
     </a>
     3.1、微信支付官方地址：
    </h4>
    <p>
     <a href="https://developers.weixin.qq.com/miniprogram/dev/api/open-api/payment/wx.requestPayment.html" rel="nofollow">
      https://developers.weixin.qq.com/miniprogram/dev/api/open-api/payment/wx.requestPayment.html
     </a>
     <br/>
     <strong>
      参数
     </strong>
    </p>
    <table>
     <thead>
      <tr>
       <th>
        属性
       </th>
       <th>
        类型
       </th>
       <th>
        默认值
       </th>
       <th>
        必填
       </th>
       <th>
        说明
       </th>
      </tr>
     </thead>
     <tbody>
      <tr>
       <td>
        timeStamp
       </td>
       <td>
        string
       </td>
       <td>
        是
       </td>
       <td>
        时间戳，从 1970 年 1 月 1 日 00:00:00 至今的秒数，即当前的时间
       </td>
       <td>
       </td>
      </tr>
      <tr>
       <td>
        nonceStr
       </td>
       <td>
        string
       </td>
       <td>
        是
       </td>
       <td>
        随机字符串，长度为32个字符以下
       </td>
       <td>
       </td>
      </tr>
      <tr>
       <td>
        package
       </td>
       <td>
        string
       </td>
       <td>
        是
       </td>
       <td>
        统一下单接口返回的 prepay_id 参数值，提交格式如：prepay_id=***
       </td>
       <td>
       </td>
      </tr>
      <tr>
       <td>
        signType
       </td>
       <td>
        string
       </td>
       <td>
        MD5
       </td>
       <td>
        否
       </td>
       <td>
        签名算法
       </td>
      </tr>
      <tr>
       <td>
        paySign
       </td>
       <td>
        string
       </td>
       <td>
        是
       </td>
       <td>
        签名，具体签名方案参见
        <a href="https://pay.weixin.qq.com/wiki/doc/api/wxa/wxa_api.php?chapter=7_7&amp;index=3" rel="nofollow">
         小程序支付接口文档
        </a>
       </td>
       <td>
       </td>
      </tr>
      <tr>
       <td>
        success
       </td>
       <td>
        function
       </td>
       <td>
        否
       </td>
       <td>
        接口调用成功的回调函数
       </td>
       <td>
       </td>
      </tr>
      <tr>
       <td>
        fail
       </td>
       <td>
        function
       </td>
       <td>
        否
       </td>
       <td>
        接口调用失败的回调函数
       </td>
       <td>
       </td>
      </tr>
      <tr>
       <td>
        complete
       </td>
       <td>
        function
       </td>
       <td>
        否
       </td>
       <td>
        接口调用结束的回调函数（调用成功、失败都会执行）
       </td>
       <td>
       </td>
      </tr>
     </tbody>
    </table>
    <h4>
     <a id="32_422">
     </a>
     3.2、业务流程时序图
    </h4>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/e49dd36d357827dc3915441c96b21585.jpeg#pic_center">
      <br/>
      1、用户进入小程序
      <br/>
      2、用户使用小程序进行支付(商户系统，就是我们所开发的程序)
      <br/>
      3、调用小程序登录API(目的是为了获取用户的openId,这一步，我们可以在授权登录的时候做)
      <br/>
      4、验证身份成功后异步返回openId
      <br/>
      5、生成商户订单(在我们的数据库添加一条待支付状态的订单记录)
      <br/>
      6、调用支付统一下单API(目的是为了获取预支付单号)
      <br/>
      7、返回预付单信息(prepay_id即预支付单号)，实际需要先执行6、7再执行5把预支付单号存到订单记录中，是为了解决当下未付款订单从未支付订单列表再次支付的问题。
      <br/>
      8、组合appId、nonceStr、prepay_id、signType、timeStamp、key得到支付签名paySign
      <br/>
      9、返回支付所需要的5个参数和sign
      <br/>
      10、用户确认支付
      <br/>
      11、鉴权调用微信后台支付
      <br/>
      12、异步返回给微信小程序支付结果
      <br/>
      13、小程序展示支付结果
      <br/>
      14、同步推送支付结果给我们所开发的程序(我们设置的notify_url通知地址的路径)。
      <br/>
      15、根据微信后台返回给我们的微信状态更新订单状态成功返回成功，失败返回失败并添加支付失败记录。
     </img>
    </p>
    <h4>
     <a id="33__439">
     </a>
     3.3、 后台接口
    </h4>
    <h5>
     <a id="34sdk_440">
     </a>
     3.4、支付我采用sdk进行实现，地址：
    </h5>
    <p>
     <a href="https://github.com/Wechat-Group/WxJava">
      https://github.com/Wechat-Group/WxJava
     </a>
     <br/>
     由于支付需要商户号和商户秘钥，这里就不在把此部分代码放入GitHub,下面是我工作中实现的支付接口代码：
    </p>
    <pre><code class="prism language-java"><span class="token annotation punctuation">@Log</span><span class="token punctuation">(</span>title <span class="token operator">=</span> <span class="token string">"统一下单"</span><span class="token punctuation">,</span> businessType <span class="token operator">=</span> BusinessType<span class="token punctuation">.</span>INSERT<span class="token punctuation">)</span>
<span class="token annotation punctuation">@ApiOperation</span><span class="token punctuation">(</span><span class="token string">"微信支付统一下单"</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@ApiImplicitParams</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
  <span class="token annotation punctuation">@ApiImplicitParam</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"openId"</span><span class="token punctuation">,</span> value <span class="token operator">=</span> <span class="token string">"openId"</span><span class="token punctuation">,</span> required <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span> dataType <span class="token operator">=</span> <span class="token string">"String"</span><span class="token punctuation">,</span> paramType <span class="token operator">=</span> <span class="token string">"query"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token annotation punctuation">@ApiImplicitParam</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"employeeId"</span><span class="token punctuation">,</span> value <span class="token operator">=</span> <span class="token string">"员工id"</span><span class="token punctuation">,</span> required <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span> dataType <span class="token operator">=</span> <span class="token string">"Long"</span><span class="token punctuation">,</span> paramType <span class="token operator">=</span> <span class="token string">"query"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token annotation punctuation">@ApiImplicitParam</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"amount"</span><span class="token punctuation">,</span> value <span class="token operator">=</span> <span class="token string">"金额"</span><span class="token punctuation">,</span> required <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span> dataType <span class="token operator">=</span> <span class="token string">"Double"</span><span class="token punctuation">,</span> paramType <span class="token operator">=</span> <span class="token string">"query"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">"/placeOrder"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> RequestResult <span class="token function">add</span><span class="token punctuation">(</span>String openId<span class="token punctuation">,</span> Long employeeId<span class="token punctuation">,</span> Double amount<span class="token punctuation">,</span>HttpServletRequest request<span class="token punctuation">)</span> <span class="token keyword">throws</span> WxPayException <span class="token punctuation">{<!-- --></span>
ZjEmployee zjEmployee <span class="token operator">=</span> zjEmployeeService<span class="token punctuation">.</span><span class="token function">selectZjEmployeeDetailById</span><span class="token punctuation">(</span>employeeId<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>zjEmployee <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
 <span class="token keyword">return</span> RequestResult<span class="token punctuation">.</span><span class="token function">employee_error</span><span class="token punctuation">(</span><span class="token string">"无效用户！"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">if</span><span class="token punctuation">(</span>amount<span class="token operator">&gt;</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
ZjRechargeRecord zjRechargeRecord <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ZjRechargeRecord</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> cent <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Double</span><span class="token punctuation">(</span>amount <span class="token operator">*</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">intValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
String formatStr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SimpleDateFormat</span><span class="token punctuation">(</span><span class="token string">"yyyyMMddHHmmssSSS"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
zjRechargeRecord<span class="token punctuation">.</span><span class="token function">setTransactionNum</span><span class="token punctuation">(</span><span class="token string">"ZJ"</span> <span class="token operator">+</span> formatStr <span class="token operator">+</span> <span class="token keyword">new</span> <span class="token class-name">DecimalFormat</span><span class="token punctuation">(</span><span class="token string">"0"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span>amount<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
zjRechargeRecord<span class="token punctuation">.</span><span class="token function">setRechargeTime</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
zjRechargeRecord<span class="token punctuation">.</span><span class="token function">setEmployeeId</span><span class="token punctuation">(</span>employeeId<span class="token punctuation">)</span><span class="token punctuation">;</span>
zjRechargeRecord<span class="token punctuation">.</span><span class="token function">setAmount</span><span class="token punctuation">(</span>amount<span class="token punctuation">)</span><span class="token punctuation">;</span>
zjRechargeRecord<span class="token punctuation">.</span><span class="token function">setPayStatus</span><span class="token punctuation">(</span><span class="token string">"1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//设置充值类型为个人充值</span>
zjRechargeRecord<span class="token punctuation">.</span><span class="token function">setRechargeType</span><span class="token punctuation">(</span><span class="token string">"2"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
WxPayUnifiedOrderRequest wxPayRequest<span class="token operator">=</span> WxPayUnifiedOrderRequest<span class="token punctuation">.</span><span class="token function">newBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//设置随机字符串</span>
wxPayRequest<span class="token punctuation">.</span><span class="token function">setNonceStr</span><span class="token punctuation">(</span>RandomUtil<span class="token punctuation">.</span><span class="token function">getRandomString</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//设置body</span>
wxPayRequest<span class="token punctuation">.</span><span class="token function">setBody</span><span class="token punctuation">(</span><span class="token string">"充值餐费金额"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//设置商户订单号</span>
wxPayRequest<span class="token punctuation">.</span><span class="token function">setOutTradeNo</span><span class="token punctuation">(</span>zjRechargeRecord<span class="token punctuation">.</span><span class="token function">getTransactionNum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//设置币种</span>
wxPayRequest<span class="token punctuation">.</span><span class="token function">setFeeType</span><span class="token punctuation">(</span><span class="token string">"CNY"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//设置标价金额</span>
wxPayRequest<span class="token punctuation">.</span><span class="token function">setTotalFee</span><span class="token punctuation">(</span>cent<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//设置终端ip</span>
wxPayRequest<span class="token punctuation">.</span><span class="token function">setSpbillCreateIp</span><span class="token punctuation">(</span><span class="token function">getIp</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//设置通知地址</span>
wxPayRequest<span class="token punctuation">.</span><span class="token function">setNotifyUrl</span><span class="token punctuation">(</span>AppletConfig<span class="token punctuation">.</span>IMGURLPREFIX<span class="token operator">+</span><span class="token string">"/api/wechat/notify/order"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//设置交易类型</span>
wxPayRequest<span class="token punctuation">.</span><span class="token function">setTradeType</span><span class="token punctuation">(</span><span class="token string">"JSAPI"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//设置用户标识</span>
wxPayRequest<span class="token punctuation">.</span><span class="token function">setOpenid</span><span class="token punctuation">(</span>openId<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//设置签名方式</span>
wxPayRequest<span class="token punctuation">.</span><span class="token function">setSignType</span><span class="token punctuation">(</span><span class="token string">"MD5"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
WxPayUnifiedOrderResult wxPayUnifiedOrderResult<span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>wxService<span class="token punctuation">.</span><span class="token function">unifiedOrder</span><span class="token punctuation">(</span>wxPayRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">boolean</span> addOrderFlag<span class="token operator">=</span><span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token string">"OK"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>wxPayUnifiedOrderResult<span class="token punctuation">.</span><span class="token function">getReturnMsg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
  zjRechargeRecord<span class="token punctuation">.</span><span class="token function">setWxOrderNum</span><span class="token punctuation">(</span>wxPayUnifiedOrderResult<span class="token punctuation">.</span><span class="token function">getPrepayId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  addOrderFlag<span class="token operator">=</span>zjRechargeRecordService<span class="token punctuation">.</span><span class="token function">insertZjRechargeRecord</span><span class="token punctuation">(</span>zjRechargeRecord<span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token number">0</span><span class="token operator">?</span><span class="token boolean">true</span><span class="token operator">:</span><span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">if</span><span class="token punctuation">(</span>addOrderFlag<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
 StringBuffer buffer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 String timeStamp <span class="token operator">=</span>String<span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>System<span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 buffer<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">"appId="</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>wxPayUnifiedOrderResult<span class="token punctuation">.</span><span class="token function">getAppid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">"&amp;nonceStr="</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>wxPayUnifiedOrderResult<span class="token punctuation">.</span><span class="token function">getNonceStr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">"&amp;package=prepay_id="</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>wxPayUnifiedOrderResult<span class="token punctuation">.</span><span class="token function">getPrepayId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">"&amp;signType=MD5&amp;timeStamp="</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>timeStamp<span class="token punctuation">)</span>
         <span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">"&amp;key="</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>AppletConfig<span class="token punctuation">.</span>APIKEY<span class="token punctuation">)</span><span class="token punctuation">;</span>
 String paySign<span class="token operator">=</span> Md5Utils<span class="token punctuation">.</span><span class="token function">MD5Encode</span><span class="token punctuation">(</span>buffer<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"UTF-8"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toUpperCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 Map map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"paySign"</span><span class="token punctuation">,</span>paySign<span class="token punctuation">)</span><span class="token punctuation">;</span>
 map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"timeStamp"</span><span class="token punctuation">,</span>timeStamp<span class="token punctuation">)</span><span class="token punctuation">;</span>
 map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"nonceStr"</span><span class="token punctuation">,</span>wxPayUnifiedOrderResult<span class="token punctuation">.</span><span class="token function">getNonceStr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"signType"</span><span class="token punctuation">,</span><span class="token string">"MD5"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"package"</span><span class="token punctuation">,</span><span class="token string">"prepay_id="</span><span class="token operator">+</span>wxPayUnifiedOrderResult<span class="token punctuation">.</span><span class="token function">getPrepayId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> RequestResult<span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span>map<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
  <span class="token keyword">return</span> RequestResult<span class="token punctuation">.</span><span class="token function">employee_error</span><span class="token punctuation">(</span><span class="token string">"下单失败请稍后再试!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
 <span class="token keyword">return</span> RequestResult<span class="token punctuation">.</span><span class="token function">employee_error</span><span class="token punctuation">(</span><span class="token string">"充值金额必须大于0！"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <pre><code class="prism language-java"><span class="token comment">/**
  *  支付回调通知处理
  * @param xmlData
  * @return
  * @throws WxPayException
  */</span>
<span class="token annotation punctuation">@Log</span><span class="token punctuation">(</span>title <span class="token operator">=</span> <span class="token string">"充值支付"</span><span class="token punctuation">,</span> businessType <span class="token operator">=</span> BusinessType<span class="token punctuation">.</span>INSERT<span class="token punctuation">)</span>
<span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">"/notify/order"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> String <span class="token function">parseOrderNotifyResult</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> String xmlData<span class="token punctuation">)</span> <span class="token keyword">throws</span> WxPayException <span class="token punctuation">{<!-- --></span>
 <span class="token keyword">final</span> WxPayOrderNotifyResult notifyResult <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>wxService<span class="token punctuation">.</span><span class="token function">parseOrderNotifyResult</span><span class="token punctuation">(</span>xmlData<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token string">"SUCCESS"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>notifyResult<span class="token punctuation">.</span><span class="token function">getResultCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
     <span class="token keyword">boolean</span> addMountFlag <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
     ZjRechargeRecord zjRechargeRecord <span class="token operator">=</span> zjRechargeRecordService<span class="token punctuation">.</span><span class="token function">getZjRechargeRecordByTransactionNum</span><span class="token punctuation">(</span>notifyResult<span class="token punctuation">.</span><span class="token function">getOutTradeNo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token keyword">if</span><span class="token punctuation">(</span>zjRechargeRecord<span class="token operator">==</span>null<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
         WxPayNotifyResponse<span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">"充值失败请联系管理员"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
         zjRechargeRecord<span class="token punctuation">.</span><span class="token function">setPayStatus</span><span class="token punctuation">(</span><span class="token string">"2"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         zjRechargeRecordService<span class="token punctuation">.</span><span class="token function">updateZjRechargeRecord</span><span class="token punctuation">(</span>zjRechargeRecord<span class="token punctuation">)</span><span class="token punctuation">;</span>
         addMountFlag <span class="token operator">=</span> zjEmployeeService<span class="token punctuation">.</span><span class="token function">rechargeByPriceAndId</span><span class="token punctuation">(</span>zjRechargeRecord<span class="token punctuation">.</span><span class="token function">getAmount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> zjRechargeRecord<span class="token punctuation">.</span><span class="token function">getEmployeeId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">?</span> <span class="token boolean">true</span> <span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
         <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>addMountFlag<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
             ZjRechargeFailLog zjRechargeFailLog<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">ZjRechargeFailLog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
             zjRechargeFailLog<span class="token punctuation">.</span><span class="token function">setTransactionNum</span><span class="token punctuation">(</span>zjRechargeRecord<span class="token punctuation">.</span><span class="token function">getTransactionNum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
             zjRechargeFailLog<span class="token punctuation">.</span><span class="token function">setWxOrderNum</span><span class="token punctuation">(</span>zjRechargeRecord<span class="token punctuation">.</span><span class="token function">getWxOrderNum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
             zjRechargeFailLog<span class="token punctuation">.</span><span class="token function">setEmployeeId</span><span class="token punctuation">(</span>zjRechargeRecord<span class="token punctuation">.</span><span class="token function">getEmployeeId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
             zjRechargeFailLog<span class="token punctuation">.</span><span class="token function">setAmount</span><span class="token punctuation">(</span>zjRechargeRecord<span class="token punctuation">.</span><span class="token function">getAmount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
             zjRechargeFailLog<span class="token punctuation">.</span><span class="token function">setRechargeTime</span><span class="token punctuation">(</span>zjRechargeRecord<span class="token punctuation">.</span><span class="token function">getRechargeTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
             zjRechargeFailLogService<span class="token punctuation">.</span><span class="token function">insertZjRechargeFailLog</span><span class="token punctuation">(</span>zjRechargeFailLog<span class="token punctuation">)</span><span class="token punctuation">;</span>
             WxPayNotifyResponse<span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">"充值失败请联系管理员"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token punctuation">}</span>
     <span class="token keyword">return</span> WxPayNotifyResponse<span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span><span class="token string">"成功"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
     <span class="token keyword">return</span> WxPayNotifyResponse<span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span>notifyResult<span class="token punctuation">.</span><span class="token function">getReturnMsg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> String <span class="token function">getIp</span><span class="token punctuation">(</span>HttpServletRequest request<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
   String ip <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getHeader</span><span class="token punctuation">(</span><span class="token string">"X-Forwarded-For"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span>StringUtils<span class="token punctuation">.</span><span class="token function">isNotEmpty</span><span class="token punctuation">(</span>ip<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token string">"unKnown"</span><span class="token punctuation">.</span><span class="token function">equalsIgnoreCase</span><span class="token punctuation">(</span>ip<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
       <span class="token comment">//多次反向代理后会有多个ip值，第一个ip才是真实ip</span>
       <span class="token keyword">int</span> index <span class="token operator">=</span> ip<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token keyword">if</span> <span class="token punctuation">(</span>index <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
           <span class="token keyword">return</span> ip<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> index<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
           <span class="token keyword">return</span> ip<span class="token punctuation">;</span>
       <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>
   ip <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getHeader</span><span class="token punctuation">(</span><span class="token string">"X-Real-IP"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span>StringUtils<span class="token punctuation">.</span><span class="token function">isNotEmpty</span><span class="token punctuation">(</span>ip<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token string">"unKnown"</span><span class="token punctuation">.</span><span class="token function">equalsIgnoreCase</span><span class="token punctuation">(</span>ip<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
       <span class="token keyword">return</span> ip<span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
       <span class="token keyword">return</span> InetAddress<span class="token punctuation">.</span><span class="token function">getLocalHost</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getHostAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
       <span class="token keyword">return</span> <span class="token string">"127.0.0.1"</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <h5>
     <a id="35SDKXML_575">
     </a>
     3.5、不用SDK，手动编写，需要自己对参数值进行XML转义，提供工具类如下：
    </h5>
    <p>
     参数值转义后的结果示例：
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/1cbc32612c6eee3ae92cea6bbececa1e.png">
      代码：
     </img>
    </p>
    <pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PayCommonUtil</span> <span class="token punctuation">{<!-- --></span>
<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">static</span> Logger logger <span class="token operator">=</span> LoggerFactory<span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span>PayCommonUtil<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token keyword">public</span> <span class="token keyword">static</span> Map<span class="token generics function"><span class="token punctuation">&lt;</span>String<span class="token punctuation">,</span> String<span class="token punctuation">&gt;</span></span> <span class="token function">weixinPrePay</span><span class="token punctuation">(</span>String openid<span class="token punctuation">,</span> String sn<span class="token punctuation">,</span><span class="token keyword">int</span> totalAmount<span class="token punctuation">,</span>  
        String body<span class="token punctuation">,</span> String request<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>  
    SortedMap<span class="token generics function"><span class="token punctuation">&lt;</span>String<span class="token punctuation">,</span> Object<span class="token punctuation">&gt;</span></span> parameterMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TreeMap</span><span class="token generics function"><span class="token punctuation">&lt;</span>String<span class="token punctuation">,</span> Object<span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
    parameterMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"appid"</span><span class="token punctuation">,</span> AppletConfig<span class="token punctuation">.</span>APPID<span class="token punctuation">)</span><span class="token punctuation">;</span>
    parameterMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"mch_id"</span><span class="token punctuation">,</span> AppletConfig<span class="token punctuation">.</span>MCHID<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//设置32位随机字符串</span>
    parameterMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"nonce_str"</span><span class="token punctuation">,</span> RandomUtil<span class="token punctuation">.</span><span class="token function">getRandomString</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    parameterMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"body"</span><span class="token punctuation">,</span> body<span class="token punctuation">)</span><span class="token punctuation">;</span> 
    parameterMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"out_trade_no"</span><span class="token punctuation">,</span> sn<span class="token punctuation">)</span><span class="token punctuation">;</span>  
    parameterMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"fee_type"</span><span class="token punctuation">,</span> <span class="token string">"CNY"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
    parameterMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"total_fee"</span><span class="token punctuation">,</span> totalAmount<span class="token operator">+</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
    parameterMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"spbill_create_ip"</span><span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">;</span>  
    parameterMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"notify_url"</span><span class="token punctuation">,</span> <span class="token string">"自己设置的接收通知结果的url"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
    parameterMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"trade_type"</span><span class="token punctuation">,</span> <span class="token string">"JSAPI"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
    parameterMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"openid"</span><span class="token punctuation">,</span> openid<span class="token punctuation">)</span><span class="token punctuation">;</span>  
    String sign <span class="token operator">=</span> PayCommonUtil<span class="token punctuation">.</span><span class="token function">createSign</span><span class="token punctuation">(</span><span class="token string">"UTF-8"</span><span class="token punctuation">,</span> parameterMap<span class="token punctuation">,</span>AppletConfig<span class="token punctuation">.</span>APIKEY<span class="token punctuation">)</span><span class="token punctuation">;</span>
    parameterMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"sign"</span><span class="token punctuation">,</span> sign<span class="token punctuation">)</span><span class="token punctuation">;</span>  
    String requestXML <span class="token operator">=</span> PayCommonUtil<span class="token punctuation">.</span><span class="token function">getRequestXml</span><span class="token punctuation">(</span>parameterMap<span class="token punctuation">)</span><span class="token punctuation">;</span>  
    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>requestXML<span class="token punctuation">)</span><span class="token punctuation">;</span>  
    String result <span class="token operator">=</span> PayCommonUtil<span class="token punctuation">.</span><span class="token function">httpsRequest</span><span class="token punctuation">(</span>  
            <span class="token string">"https://api.mch.weixin.qq.com/pay/unifiedorder"</span><span class="token punctuation">,</span> <span class="token string">"POST"</span><span class="token punctuation">,</span>  
            requestXML<span class="token punctuation">)</span><span class="token punctuation">;</span>  
    Map<span class="token generics function"><span class="token punctuation">&lt;</span>String<span class="token punctuation">,</span> String<span class="token punctuation">&gt;</span></span> map <span class="token operator">=</span> null<span class="token punctuation">;</span>  
    <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>  
        map <span class="token operator">=</span> PayCommonUtil<span class="token punctuation">.</span><span class="token function">doXMLParse</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">JDOMException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>  
logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"生成微信支付失败=============================&gt;&gt;&gt;&gt;weixinPrePay-JDOMException："</span><span class="token operator">+</span>e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
        <span class="token comment">// TODO Auto-generated catch block  </span>
        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>  
logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"生成微信支付失败=============================&gt;&gt;&gt;&gt;weixinPrePay-IOException:"</span><span class="token operator">+</span>e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// TODO Auto-generated catch block  </span>
        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token punctuation">}</span>  
    <span class="token keyword">return</span> map<span class="token punctuation">;</span>  
<span class="token punctuation">}</span>
<span class="token comment">//拼接xml</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> String <span class="token function">getRequestXml</span><span class="token punctuation">(</span>SortedMap<span class="token generics function"><span class="token punctuation">&lt;</span>String<span class="token punctuation">,</span> Object<span class="token punctuation">&gt;</span></span> parameters<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    StringBuffer sb <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">"&lt;xml&gt;"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    Set es <span class="token operator">=</span> parameters<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    Iterator it <span class="token operator">=</span> es<span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>it<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        Map<span class="token punctuation">.</span>Entry entry <span class="token operator">=</span> <span class="token punctuation">(</span>Map<span class="token punctuation">.</span>Entry<span class="token punctuation">)</span> it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        String key <span class="token operator">=</span> <span class="token punctuation">(</span>String<span class="token punctuation">)</span> entry<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        String value <span class="token operator">=</span> <span class="token punctuation">(</span>String<span class="token punctuation">)</span> entry<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">"attach"</span><span class="token punctuation">.</span><span class="token function">equalsIgnoreCase</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token string">"body"</span><span class="token punctuation">.</span><span class="token function">equalsIgnoreCase</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token string">"sign"</span><span class="token punctuation">.</span><span class="token function">equalsIgnoreCase</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">"&lt;"</span> <span class="token operator">+</span> key <span class="token operator">+</span> <span class="token string">"&gt;"</span> <span class="token operator">+</span> <span class="token string">"&lt;![CDATA["</span> <span class="token operator">+</span> value <span class="token operator">+</span> <span class="token string">"]]&gt;&lt;/"</span> <span class="token operator">+</span> key <span class="token operator">+</span> <span class="token string">"&gt;"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">"&lt;"</span> <span class="token operator">+</span> key <span class="token operator">+</span> <span class="token string">"&gt;"</span> <span class="token operator">+</span> value <span class="token operator">+</span> <span class="token string">"&lt;/"</span> <span class="token operator">+</span> key <span class="token operator">+</span> <span class="token string">"&gt;"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">"&lt;/xml&gt;"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> sb<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">//通过签名算法算出签名值</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> String <span class="token function">createSign</span><span class="token punctuation">(</span>String characterEncoding<span class="token punctuation">,</span> SortedMap<span class="token generics function"><span class="token punctuation">&lt;</span>String<span class="token punctuation">,</span> Object<span class="token punctuation">&gt;</span></span> parameters<span class="token punctuation">,</span> String apiKey<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    StringBuffer sb <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    Set es <span class="token operator">=</span> parameters<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    Iterator it <span class="token operator">=</span> es<span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>it<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        Map<span class="token punctuation">.</span>Entry entry <span class="token operator">=</span> <span class="token punctuation">(</span>Map<span class="token punctuation">.</span>Entry<span class="token punctuation">)</span> it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        String k <span class="token operator">=</span> <span class="token punctuation">(</span>String<span class="token punctuation">)</span> entry<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        Object v <span class="token operator">=</span> entry<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>null <span class="token operator">!=</span> v <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token string">""</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token string">"sign"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token string">"key"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>k <span class="token operator">+</span> <span class="token string">"="</span> <span class="token operator">+</span> v <span class="token operator">+</span> <span class="token string">"&amp;"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">"key="</span> <span class="token operator">+</span> apiKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>sb<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    String sign <span class="token operator">=</span> Md5Utils<span class="token punctuation">.</span><span class="token function">MD5Encode</span><span class="token punctuation">(</span>sb<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> characterEncoding<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toUpperCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> sign<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> String <span class="token function">httpsRequest</span><span class="token punctuation">(</span>String requestUrl<span class="token punctuation">,</span> String requestMethod<span class="token punctuation">,</span> String outputStr<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
        URL url <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URL</span><span class="token punctuation">(</span>requestUrl<span class="token punctuation">)</span><span class="token punctuation">;</span>
        HttpURLConnection conn <span class="token operator">=</span> <span class="token punctuation">(</span>HttpURLConnection<span class="token punctuation">)</span> url<span class="token punctuation">.</span><span class="token function">openConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        conn<span class="token punctuation">.</span><span class="token function">setDoOutput</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        conn<span class="token punctuation">.</span><span class="token function">setDoInput</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        conn<span class="token punctuation">.</span><span class="token function">setUseCaches</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        conn<span class="token punctuation">.</span><span class="token function">setRequestMethod</span><span class="token punctuation">(</span>requestMethod<span class="token punctuation">)</span><span class="token punctuation">;</span>
        conn<span class="token punctuation">.</span><span class="token function">setRequestProperty</span><span class="token punctuation">(</span><span class="token string">"content-type"</span><span class="token punctuation">,</span> <span class="token string">"application/x-www-form-urlencoded"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>null <span class="token operator">!=</span> outputStr<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            OutputStream outputStream <span class="token operator">=</span> conn<span class="token punctuation">.</span><span class="token function">getOutputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            outputStream<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>outputStr<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token string">"UTF-8"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            outputStream<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        InputStream inputStream <span class="token operator">=</span> conn<span class="token punctuation">.</span><span class="token function">getInputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        InputStreamReader inputStreamReader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">InputStreamReader</span><span class="token punctuation">(</span>inputStream<span class="token punctuation">,</span> <span class="token string">"utf-8"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        BufferedReader bufferedReader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BufferedReader</span><span class="token punctuation">(</span>inputStreamReader<span class="token punctuation">)</span><span class="token punctuation">;</span>
        String str <span class="token operator">=</span> null<span class="token punctuation">;</span>
        StringBuffer buffer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>str <span class="token operator">=</span> bufferedReader<span class="token punctuation">.</span><span class="token function">readLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            buffer<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        bufferedReader<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        inputStreamReader<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        inputStream<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        conn<span class="token punctuation">.</span><span class="token function">disconnect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> buffer<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ConnectException</span> ce<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"连接异常"</span> <span class="token operator">+</span> ce<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"请求"</span> <span class="token operator">+</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> null<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">//xml解析</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> Map <span class="token function">doXMLParse</span><span class="token punctuation">(</span>String strxml<span class="token punctuation">)</span> <span class="token keyword">throws</span>  IOException<span class="token punctuation">,</span> JDOMException <span class="token punctuation">{<!-- --></span>
    strxml <span class="token operator">=</span> strxml<span class="token punctuation">.</span><span class="token function">replaceFirst</span><span class="token punctuation">(</span><span class="token string">"encoding=\".*\""</span><span class="token punctuation">,</span> <span class="token string">"encoding=\"UTF-8\""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>null <span class="token operator">==</span> strxml <span class="token operator">||</span> <span class="token string">""</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>strxml<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> null<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    Map m <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    InputStream in <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ByteArrayInputStream</span><span class="token punctuation">(</span>strxml<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token string">"UTF-8"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    SAXBuilder builder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SAXBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    Document doc <span class="token operator">=</span> builder<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span>in<span class="token punctuation">)</span><span class="token punctuation">;</span>
    Element root <span class="token operator">=</span> doc<span class="token punctuation">.</span><span class="token function">getRootElement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    List list <span class="token operator">=</span> root<span class="token punctuation">.</span><span class="token function">getChildren</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    Iterator it <span class="token operator">=</span> list<span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>it<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        Element e <span class="token operator">=</span> <span class="token punctuation">(</span>Element<span class="token punctuation">)</span> it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        String k <span class="token operator">=</span> e<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        String v <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>
        List children <span class="token operator">=</span> e<span class="token punctuation">.</span><span class="token function">getChildren</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>children<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            v <span class="token operator">=</span> e<span class="token punctuation">.</span><span class="token function">getTextNormalize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            v <span class="token operator">=</span> <span class="token function">getChildrenText</span><span class="token punctuation">(</span>children<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    	System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>k<span class="token operator">+</span><span class="token string">"-"</span><span class="token operator">+</span>v<span class="token punctuation">)</span><span class="token punctuation">;</span>
        m<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>k<span class="token punctuation">,</span> v<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    in<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> m<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> String <span class="token function">getChildrenText</span><span class="token punctuation">(</span>List children<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    StringBuffer sb <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>children<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        Iterator it <span class="token operator">=</span> children<span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>it<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            Element e <span class="token operator">=</span> <span class="token punctuation">(</span>Element<span class="token punctuation">)</span> it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            String name <span class="token operator">=</span> e<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            String value <span class="token operator">=</span> e<span class="token punctuation">.</span><span class="token function">getTextNormalize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            List list <span class="token operator">=</span> e<span class="token punctuation">.</span><span class="token function">getChildren</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">"&lt;"</span> <span class="token operator">+</span> name <span class="token operator">+</span> <span class="token string">"&gt;"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>list<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token function">getChildrenText</span><span class="token punctuation">(</span>list<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
            sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">"&lt;/"</span> <span class="token operator">+</span> name <span class="token operator">+</span> <span class="token string">"&gt;"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> sb<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     需要在pom中加入jdom依赖，用于解析xml
    </p>
    <pre><code class="prism language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.jdom<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>jdom<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.1.3<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre>
    <h5>
     <a id="36_747">
     </a>
     3.6、小程序端调用
    </h5>
    <p>
     需要先调用我们的统一下单接口得到参数，再调用wx.wx.requestPayment进行扣款操作
    </p>
    <pre><code class="prism language-java">let openId <span class="token operator">=</span> wx<span class="token punctuation">.</span><span class="token function">getStorageSync</span><span class="token punctuation">(</span><span class="token string">'openId'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
let <span class="token punctuation">{<!-- --></span> amount<span class="token punctuation">,</span> userData <span class="token punctuation">}</span> <span class="token operator">=</span><span class="token keyword">this</span><span class="token punctuation">.</span>data<span class="token punctuation">;</span>
<span class="token function">Req</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
url<span class="token operator">:</span><span class="token string">'/api/wechat/placeOrder'</span><span class="token punctuation">,</span>
method<span class="token operator">:</span><span class="token string">"POST"</span><span class="token punctuation">,</span>
data<span class="token operator">:</span><span class="token punctuation">{<!-- --></span> employeeId<span class="token operator">:</span>userData<span class="token punctuation">.</span>id<span class="token punctuation">,</span> openId<span class="token punctuation">,</span> amount <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">{<!-- --></span>
let <span class="token punctuation">{<!-- --></span> data <span class="token punctuation">}</span> <span class="token operator">=</span>res<span class="token punctuation">.</span>data<span class="token punctuation">;</span>
wx<span class="token punctuation">.</span><span class="token function">requestPayment</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
  timeStamp<span class="token operator">:</span> data<span class="token punctuation">.</span>timeStamp<span class="token punctuation">,</span><span class="token comment">//时间戳</span>
  nonceStr<span class="token operator">:</span> data<span class="token punctuation">.</span>nonceStr<span class="token punctuation">,</span><span class="token comment">//随机字符串</span>
  <span class="token keyword">package</span><span class="token operator">:</span> data<span class="token punctuation">.</span><span class="token keyword">package</span><span class="token punctuation">,</span><span class="token comment">//prepay_id</span>
  signType<span class="token operator">:</span> <span class="token string">'MD5'</span><span class="token punctuation">,</span><span class="token comment">//签名算法</span>
  paySign<span class="token operator">:</span> data<span class="token punctuation">.</span>paySign<span class="token punctuation">,</span><span class="token comment">//签名</span>
  success <span class="token punctuation">(</span>res<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> 
    let <span class="token punctuation">{<!-- --></span> errMsg <span class="token punctuation">}</span> <span class="token operator">=</span>res<span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>errMsg <span class="token operator">==</span> <span class="token string">"requestPayment:ok"</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token function">Req</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
        url<span class="token operator">:</span><span class="token string">'/api/wechat/getPersonalInfo'</span><span class="token punctuation">,</span>
        method<span class="token operator">:</span><span class="token string">"GET"</span><span class="token punctuation">,</span>
        data<span class="token operator">:</span><span class="token punctuation">{<!-- --></span> employeeId<span class="token operator">:</span>userData<span class="token punctuation">.</span>id <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">{<!-- --></span>
        let <span class="token punctuation">{<!-- --></span> data <span class="token punctuation">}</span> <span class="token operator">=</span>res<span class="token punctuation">.</span>data<span class="token punctuation">;</span>
        wx<span class="token punctuation">.</span><span class="token function">setStorageSync</span><span class="token punctuation">(</span><span class="token string">'userData'</span><span class="token punctuation">,</span> JSON<span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        wx<span class="token punctuation">.</span><span class="token function">switchTab</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
          url<span class="token operator">:</span> <span class="token string">'/pages/index/index'</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token operator">=</span><span class="token operator">&gt;</span><span class="token punctuation">{<!-- --></span>
  
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
      
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  fail <span class="token punctuation">(</span>res<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> 

  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token operator">=</span><span class="token operator">&gt;</span><span class="token punctuation">{<!-- --></span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre>
    <h3>
     <a id="4GitHub_790">
     </a>
     4、GitHub地址：
    </h3>
    <p>
     GitHub上SpringBoot工程中仅提供授权登录、绑定手机号的完整代码，微信支付青参照博客充值(小程序支付)这一章节，另会附上user表sql、小程序部分代码，由于小程序是使用我个人申请注册的，故只可以正常演示登录授权功能、获取手机号和充值功能小程序秘钥等需要在开发时替换成项目中申请的小程序的秘钥。amy_demo文件夹下为小程序代码，wechat-applet文件夹下为后台接口代码。
     <br/>
     附上GitHub地址：
     <br/>
     <a href="https://github.com/Amywang1996/wechat">
      https://github.com/Amywang1996/wechat
     </a>
     <br/>
     <strong>
      如有不足之处，欢迎交流，提醒更正O(∩_∩)O~！
     </strong>
    </p>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
</div>


