---
layout: post
title: "uniapp小程序通过公众号发模板消息"
date: 2024-12-24 18:45:42 +0800
description: "这功能的一个难点是怎么用户的公众号信息和小程序关联起来，这样才能将信息给他有两种方法实现（用户得关注"
keywords: "uniapp 小程序联合公众号群发消息"
categories: ['未分类']
tags: ['小程序', 'App']
artid: "120967487"
image:
  path: https://api.vvhan.com/api/bing?rand=sj&artid=120967487
  alt: "uniapp小程序通过公众号发模板消息"
render_with_liquid: false
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     uniapp小程序通过公众号发模板消息
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <p>
     <strong>
      这功能的一个难点是怎么将用户的公众号信息和小程序关联起来，这样才能将信息准确的发给他
     </strong>
     <br/>
     有两种方法实现（用户得关注了公众号）：
     <br/>
     <strong>
      第一种
     </strong>
     ：通过unionId来关联，小程序的openid和公众号的openid是不同的，当我们将小程序和公众号关联起来后，unionId是一样的，只有当我们在微信“开放”平台将小程序和公众号绑定后才能拿到。
     <br/>
     拿到unionId的方法：通过getUserProfile拿到用户信息，然后将encryptdata、iv传给后台，通过解密encryptdata来获得unionId，这样我们可以让后台通过unionId来获取用户在公众号上的openid，并将用户小程序的信息和公众号的信息关联起来，这样就可以指定的发模板消息给他了（模板消息由后台发送）
    </p>
    <p>
     <a href="https://developers.weixin.qq.com/miniprogram/dev/framework/open-ability/union-id.html" rel="nofollow">
      unionId机制链接
     </a>
    </p>
    <p>
     <a href="https://developers.weixin.qq.com/miniprogram/dev/framework/open-ability/signature.html" rel="nofollow">
      encryptdata解密
     </a>
    </p>
    <p>
     <strong>
      第二种
     </strong>
     ：通过公众号授权来获取用户公众号的openid，然后后台就可以将他们关联起来了。
     <br/>
     这种方法会跳转h5页面，所以要用web-view（跳转页面要在公众开发平台》》开发管理里配业务域名）来实现，
     <strong>
      并且还要用一个专门的h5页面来接收授权后获取到的公众号code值，不然授权后你拿不到code值，你也返回不了小程序
     </strong>
    </p>
    <p>
     <strong>
      在登录或注册的页面就跳到该web-view页面
     </strong>
    </p>
    <pre><code class="prism language-javascript"><span class="token operator">&lt;</span>template<span class="token operator">&gt;</span>
	<span class="token operator">&lt;</span>view<span class="token operator">&gt;</span>
		<span class="token operator">&lt;</span>web<span class="token operator">-</span>view v<span class="token operator">-</span><span class="token keyword">if</span><span class="token operator">=</span><span class="token string">"isShow"</span> src<span class="token operator">=</span><span class="token string">"接收code的h5页面地址"</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>web<span class="token operator">-</span>view<span class="token operator">&gt;</span>
	<span class="token operator">&lt;</span><span class="token operator">/</span>view<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>template<span class="token operator">&gt;</span>

<span class="token operator">&lt;</span>script<span class="token operator">&gt;</span>
<span class="token keyword">export</span> <span class="token keyword">default</span><span class="token punctuation">{<!-- --></span>
<span class="token comment">//公众号授权页面 https://open.weixin.qq.com/connect/oauth2/authorize?appid=公众号的appid&amp;redirect_uri=接收code的h5页面&amp;response_type=code&amp;scope=snsapi_base&amp;state=123#wechat_redirect</span>
<span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
<span class="token keyword">return</span><span class="token punctuation">{<!-- --></span>
isShow<span class="token operator">:</span><span class="token boolean">true</span>
<span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token function">onLoad</span><span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token keyword">if</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>code<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
<span class="token keyword">this</span><span class="token punctuation">.</span>isShow <span class="token operator">=</span> <span class="token boolean">false</span>
<span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
<span class="token keyword">this</span><span class="token punctuation">.</span>isShow <span class="token operator">=</span> <span class="token boolean">true</span>
<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
</code></pre>
<p>
<strong>
接收公众号 code 值的 h5 页面
</strong>
</p>
<pre><code class="prism language-javascript"><span class="token operator">&lt;</span><span class="token operator">!</span><span class="token constant">DOCTYPE</span> html<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>html<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>head<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>meta charset<span class="token operator">=</span><span class="token string">"UTF-8"</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>meta name<span class="token operator">=</span><span class="token string">"viewport"</span> content<span class="token operator">=</span>"width<span class="token operator">=</span>device<span class="token operator">-</span>width<span class="token punctuation">,</span>
user<span class="token operator">-</span>scalable<span class="token operator">=</span>no<span class="token punctuation">,</span>initial<span class="token operator">-</span>scale<span class="token operator">=</span><span class="token number">1.0</span><span class="token punctuation">,</span>maximum<span class="token operator">=</span><span class="token number">1.0</span><span class="token punctuation">,</span>minimum<span class="token operator">=</span><span class="token number">1.0</span>"<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>title<span class="token operator">&gt;</span>授权<span class="token operator">&lt;</span><span class="token operator">/</span>title<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> 引入 jquery<span class="token operator">--</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>script src<span class="token operator">=</span><span class="token string">"https://cdn.bootcdn.net/ajax/libs/jquery/3.5.1/jquery.min.js"</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> 引入 <span class="token number">1.3</span><span class="token number">.2</span>的 js<span class="token operator">-</span>sdk 文件 <span class="token operator">--</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>script src<span class="token operator">=</span><span class="token string">"https://res.wx.qq.com/open/js/jweixin-1.3.2.js"</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>head<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>body<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>body<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>script<span class="token operator">&gt;</span>
<span class="token keyword">function</span> <span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token keyword">var</span> code <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> local <span class="token operator">=</span> window<span class="token punctuation">.</span>location<span class="token punctuation">.</span>href<span class="token punctuation">;</span> <span class="token comment">// 获取页面 url</span>
<span class="token keyword">var</span> appid <span class="token operator">=</span> <span class="token string">"公众号 appid"</span><span class="token punctuation">;</span>
code <span class="token operator">=</span> <span class="token function">getUrlCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>code<span class="token punctuation">;</span> <span class="token comment">// 截取 code</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>code <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> code <span class="token operator">===</span> <span class="token string">""</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token comment">// 如果没有 code，则去请求</span>
window<span class="token punctuation">.</span>location<span class="token punctuation">.</span>href <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">https://open.weixin.qq.com/connect/oauth2/authorize?appid=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span>appid<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&amp;redirect_uri=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span><span class="token function">encodeURIComponent</span><span class="token punctuation">(</span>
	                local
	            <span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&amp;response_type=code&amp;scope=snsapi_userinfo&amp;state=123#wechat_redirect</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
<span class="token comment">// scope=snsapi_base 静默授权,自动跳转到回调页的 特点：用户无感知；</span>
<span class="token comment">// scope=snsapi_userinfo 非静默授权，第一次有弹框</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
<span class="token comment">// 你自己的业务逻辑</span>
<span class="token comment">// 在这里跳回自己的小程序，并且把获取到的 code 传递给小程序</span>
<span class="token comment">//参考文档：https://developers.weixin.qq.com/miniprogram/dev/component/web-view.html</span>
wx<span class="token punctuation">.</span>miniProgram<span class="token punctuation">.</span><span class="token function">redirectTo</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
url<span class="token operator">:</span> <span class="token string">'/pages/要返回的小程序页面?code='</span> <span class="token operator">+</span> code
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">// 截取 url 中的 code 方法</span>
<span class="token keyword">function</span> <span class="token function">getUrlCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token keyword">var</span> url <span class="token operator">=</span> location<span class="token punctuation">.</span>search<span class="token punctuation">;</span>
<span class="token keyword">var</span> theRequest <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>url<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">"?"</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token keyword">var</span> str <span class="token operator">=</span> url<span class="token punctuation">.</span><span class="token function">substr</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> strs <span class="token operator">=</span> str<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">"&amp;"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> strs<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
theRequest<span class="token punctuation">[</span>strs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">"="</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> strs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">"="</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">return</span> theRequest<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>html<span class="token operator">&gt;</span>
</code></pre>
<p>
如果你拿到 code 值后要跳转到 tabbar 页面，这时还要添加一个小程序的页面来处理将 code 值才行，不然你在 tabbar 页面的 onload 方法里是拿不到传过来的 code 值，
<strong>
tabbar 页面加载一次后再切回来只执行 onshow
</strong>
</p>
<pre><code class="prism language-javascript"><span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> 接收公众号授权后得到的 code 值，并传给后台将该用户的小程序和公众号关联起来 <span class="token operator">--</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>template<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>view style<span class="token operator">=</span><span class="token string">"position: absolute;width: 100%;height: 100%;display: flex;justify-content: center;align-items: center;"</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>view style<span class="token operator">=</span><span class="token string">"font-size: 32rpx;color: #888;"</span><span class="token operator">&gt;</span>正在登录中，请稍后<span class="token operator">...</span><span class="token punctuation">.</span><span class="token operator">&lt;</span><span class="token operator">/</span>view<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>view<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>template<span class="token operator">&gt;</span>

<span class="token operator">&lt;</span>script<span class="token operator">&gt;</span>
<span class="token keyword">export</span> <span class="token keyword">default</span><span class="token punctuation">{<!-- --></span>
<span class="token function">onLoad</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token comment">// 在这里可以调后台接口，把拿到的 code 传给后台，获取 openid</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>$api<span class="token punctuation">.</span><span class="token function">bindWechat</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>code<span class="token operator">:</span>e<span class="token punctuation">.</span>code<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=&gt;</span><span class="token punctuation">{<!-- --></span>
<span class="token keyword">if</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>code <span class="token operator">==</span> <span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
uni<span class="token punctuation">.</span><span class="token function">switchTab</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
url<span class="token operator">:</span><span class="token string">'/pages/index/index'</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
uni<span class="token punctuation">.</span><span class="token function">showToast</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
title<span class="token operator">:</span><span class="token string">'信息绑定失败'</span><span class="token punctuation">,</span>
icon<span class="token operator">:</span><span class="token string">'none'</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token parameter">s</span> <span class="token operator">=&gt;</span><span class="token punctuation">{<!-- --></span>
uni<span class="token punctuation">.</span><span class="token function">hideToast</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
uni<span class="token punctuation">.</span><span class="token function">switchTab</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
url<span class="token operator">:</span><span class="token string">'/pages/index/index'</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token number">1500</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=&gt;</span><span class="token punctuation">{<!-- --></span>
uni<span class="token punctuation">.</span><span class="token function">showToast</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
title<span class="token operator">:</span><span class="token string">'信息绑定失败'</span><span class="token punctuation">,</span>
icon<span class="token operator">:</span><span class="token string">'none'</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token parameter">s</span> <span class="token operator">=&gt;</span><span class="token punctuation">{<!-- --></span>
uni<span class="token punctuation">.</span><span class="token function">hideToast</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
uni<span class="token punctuation">.</span><span class="token function">switchTab</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
url<span class="token operator">:</span><span class="token string">'/pages/index/index'</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token number">1500</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>

</code></pre>

   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f62:6c6f672e6373646e2e6e65742f6d305f34363937383039362f:61727469636c652f64657461696c732f313230393637343837" class_="artid" style="display:none">
 </p>
</div>
