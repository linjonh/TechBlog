---
layout: post
title: "环境配置反向SSH家中电脑连接校园内网服务器"
date: 2025-01-14 18:36:01 +0800
description: "1. 需求描述1.1 具体情境实验室有一台校园内网GPU服务器，校园内网的特点是只允许内网机器主动访"
keywords: "怎么在家里连接学校服务器"
categories: ['环境配置', '深度学习']
tags: ['无标签']
artid: "95373985"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=95373985
    alt: "环境配置反向SSH家中电脑连接校园内网服务器"
render_with_liquid: false
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     【环境配置】反向SSH——家中电脑连接校园内网服务器
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-tomorrow-night-eighties" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <h3>
     <a id="1__0">
     </a>
     1. 需求描述
    </h3>
    <h5>
     <a id="11__1">
     </a>
     1.1 具体情境
    </h5>
    <p>
     实验室有一台校园内网GPU服务器，校园内网的特点是只允许内网机器主动访问外网机器，而不允许外网机器主动访问内网机器。
    </p>
    <p>
     现在需要使用家中的电脑（无公网IP的机器，其可能是另一个单位内网或家用路由器分配IP的机器），通过ssh控制校园内网的GPU服务器。
    </p>
    <h5>
     <a id="12__6">
     </a>
     1.2 实现思路
    </h5>
    <p>
     假设校园内网的GPU服务器为机器A，在家中的电脑为机器C，具有公网IP的云服务器为B（公网IP的机器B需要购买阿里云或者腾讯云的服务器）。
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/30775501f0b63c46b9c67ee30cf473a2.png"/>
    </p>
    <p>
     由于机器B具有公网IP，机器C和机器A都可以通过主动连接找到机器B，所以我们可以将B作为A与B之间的桥梁。
    </p>
    <p>
     首先使用机器 A 通过反向 ssh 连接机器 B ，然后机器 C 使用 ssh 连接 B 就可以通过该反向 ssh 对 A 进行操作了。
    </p>
    <h5>
     <a id="13__15">
     </a>
     1.3 实现要求
    </h5>
    <ul>
     <li>
      能使用家中的电脑 C 通过 ssh 对校园内网GPU服务器 A 进行操作
     </li>
     <li>
      每当GPU服务器 A 开机，就自动连接云服务器 B （前提是要确保机器A能访问外网）
     </li>
    </ul>
    <h3>
     <a id="2___A__21">
     </a>
     2. 配置过程 （以下指令全部在机器 A 中执行）
    </h3>
    <pre><code>校园内网GPU服务器（机器A）：
公网IP：无
用户名：gpu401


腾讯云（机器B）：
公网IP: 666.666.666.666
用户名：ubuntu

</code></pre>
    <h5>
     <a id="21_autossh_AB_34">
     </a>
     2.1 配置autossh免密登陆 (A连接B)
    </h5>
    <pre><code class="prism language-ruby"><span class="token comment"># 设置ssh免密码登录，使得 A 能免密码登录 B</span>
ssh<span class="token operator">-</span>keygen <span class="token operator">-</span>t rsa <span class="token comment"># 一路回车,生成的id_rsa.pub文件在~/.ssh/文件夹里面。</span>
<span class="token comment"># 将 A 中的这个key推送到vps，使用如下命令进行推送到 B</span>
ssh<span class="token operator">-</span>copy<span class="token operator">-</span>id <span class="token operator">-</span>i <span class="token operator">~</span><span class="token operator">/</span><span class="token punctuation">.</span>ssh<span class="token operator">/</span>id_rsa<span class="token punctuation">.</span>pub ubuntu@<span class="token number">666.666</span><span class="token number">.666</span><span class="token number">.666</span> <span class="token operator">-</span>p <span class="token number">22</span>

<span class="token comment"># 安装autossh，其能确保 A-B 之间的 反向 ssh 能断线自动重连</span>
apt<span class="token operator">-</span>get install autossh

<span class="token comment"># 测试 autossh + 免密登录是否成功。</span>
autossh <span class="token operator">-</span><span class="token constant">M</span> <span class="token number">9991</span> <span class="token operator">-</span><span class="token constant">NfR</span> <span class="token number">8990</span><span class="token symbol">:localhost</span><span class="token punctuation">:</span><span class="token number">22</span> ubuntu@<span class="token number">666.666</span><span class="token number">.666</span><span class="token number">.666</span>

<span class="token string">''</span>'
    如果该测试指令在 <span class="token constant">A</span> 执行后，当 <span class="token constant">B</span> 执行指令 <span class="token string">'watch -n 1 netstat -tnlp'</span> 能
    看到以下红框的端口号，则说明测试通过。
<span class="token string">''</span>'
</code></pre>
    <p>
     <img alt="[外链图片转存失败(img-1geVStzi-1562760515809)(715FB3E711184BC9B5BE7FCBBD510187)]" src="https://i-blog.csdnimg.cn/blog_migrate/957501b73b4a8f9d9d1ae1a5d351e614.png"/>
    </p>
    <h5>
     <a id="22__A_ssh_55">
     </a>
     2.2 配置 A 开机启动反向ssh
    </h5>
    <pre><code class="prism language-ruby"><span class="token comment"># 使用systemctl来控制服务的注册以及启动</span>

<span class="token comment"># 创建autossh.service</span>
vim <span class="token operator">/</span>lib<span class="token operator">/</span>systemd<span class="token operator">/</span>system<span class="token operator">/</span>autossh<span class="token punctuation">.</span>service

<span class="token comment"># 将下面的内容加进去</span>
<span class="token punctuation">[</span><span class="token constant">Unit</span><span class="token punctuation">]</span>
<span class="token constant">Description</span><span class="token operator">=</span><span class="token constant">Auto</span> <span class="token constant">SSH</span> <span class="token constant">Tunnel</span>
<span class="token constant">After</span><span class="token operator">=</span>network<span class="token operator">-</span>online<span class="token punctuation">.</span>target
<span class="token punctuation">[</span><span class="token constant">Service</span><span class="token punctuation">]</span>
<span class="token constant">User</span><span class="token operator">=</span>gpu401
<span class="token constant">Type</span><span class="token operator">=</span>simple
<span class="token constant">ExecStart</span><span class="token operator">=</span><span class="token operator">/</span>usr<span class="token operator">/</span>bin<span class="token operator">/</span>autossh <span class="token operator">-</span><span class="token constant">NR</span> <span class="token number">9888</span><span class="token symbol">:localhost</span><span class="token punctuation">:</span><span class="token number">22</span> <span class="token operator">-</span>i <span class="token operator">/</span>home<span class="token regex">/gpu401/</span><span class="token punctuation">.</span>ssh<span class="token operator">/</span>id_rsa ubuntu@<span class="token number">666.666</span><span class="token number">.666</span><span class="token number">.666</span> <span class="token operator">-</span>p <span class="token number">22</span> <span class="token operator">&gt;</span><span class="token operator">&gt;</span> <span class="token operator">/</span>dev<span class="token operator">/</span>null <span class="token number">2</span><span class="token operator">&gt;</span><span class="token operator">&amp;</span><span class="token number">1</span>
<span class="token constant">ExecReload</span><span class="token operator">=</span><span class="token operator">/</span>bin<span class="token operator">/</span>kill <span class="token operator">-</span><span class="token constant">HUP</span> <span class="token variable">$MAINPID</span>
<span class="token constant">ExecStop</span><span class="token operator">=</span><span class="token operator">/</span>bin<span class="token operator">/</span>kill <span class="token operator">-</span><span class="token constant">TERM</span> <span class="token variable">$MAINPID</span>
<span class="token constant">KillMode</span><span class="token operator">=</span>process
<span class="token constant">Restart</span><span class="token operator">=</span>no
<span class="token punctuation">[</span><span class="token constant">Install</span><span class="token punctuation">]</span>
<span class="token constant">WantedBy</span><span class="token operator">=</span>multi<span class="token operator">-</span>user<span class="token punctuation">.</span>target
<span class="token constant">WantedBy</span><span class="token operator">=</span>graphical<span class="token punctuation">.</span>target
</code></pre>
    <p>
     注意，由于当时是使用了 机器A 中的用户 gpu401 来免密登录 机器B 的， 因此上述配置文件中
     <code>
      [Service]
     </code>
     的
     <code>
      User
     </code>
     和
     <code>
      ExecStart
     </code>
     都需要进行正确配置。
    </p>
    <pre><code class="prism language-ruby"><span class="token comment"># 之后执行</span>
systemctl enable autossh
systemctl start autossh

<span class="token comment"># 使用以下指令，查看是否成功启动</span>
systemctl status autossh

<span class="token string">''</span>'
    如果运行成功，当 <span class="token constant">B</span> 执行指令 <span class="token string">'watch -n 1 netstat -tnlp'</span> 能
    看到以下红框的端口号，则说明测试通过。
<span class="token string">''</span>'
</code></pre>
    <p>
     <img alt="[外链图片转存失败(img-j7HtYCa2-1562760515810)(40B54C728F2540319A67D4E272AD2C32)]" src="https://i-blog.csdnimg.cn/blog_migrate/caa674b7c8e5825df22ce4f7ea48d5a0.png"/>
    </p>
    <h3>
     <a id="3_C_96">
     </a>
     3. 使用示例（以下指令全部在机器C中执行）
    </h3>
    <h5>
     <a id="31__C__A_97">
     </a>
     3.1 使用机器 C 登录 机器A
    </h5>
    <pre><code class="prism language-ruby"><span class="token comment"># 首先机器 C 通过 ssh 登录机器 B，然后在 shell 中输入以下指令登录机器A：</span>
ssh <span class="token operator">-</span>p <span class="token number">9888</span> gpu401@<span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span>
</code></pre>
    <h5>
     <a id="32__103">
     </a>
     3.2 上\下传文件
    </h5>
    <pre><code class="prism language-ruby"><span class="token comment"># 从机器 A 下载整个目录到机器 B</span>
scp <span class="token operator">-</span>r username<span class="token variable">@servername</span><span class="token punctuation">:</span><span class="token operator">/</span>var<span class="token operator">/</span>www<span class="token operator">/</span>remote_dir<span class="token operator">/</span>（远程目录） <span class="token operator">/</span>var<span class="token operator">/</span>www<span class="token operator">/</span>local_dir（本地目录）

<span class="token comment"># 从机器 A 上传目录到机器 B</span>
scp <span class="token operator">-</span>r local_dir username<span class="token variable">@servername</span><span class="token symbol">:remote_dir</span>

<span class="token comment"># 上传文件同理，取消参数 '-r' 即可</span>
scp local_fileName username<span class="token variable">@servername</span><span class="token symbol">:remote_dir</span>
</code></pre>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f626c6f672e63:73646e2e6e65742f6d6164655f696e5f6368696e615f746f6f:2f61727469636c652f64657461696c732f3935333733393835" class_="artid" style="display:none">
 </p>
</div>


