---
layout: post
title: "rk3568PCIE30x2-调试"
date: 2024-11-12 08:00:00 +0800
description: "文章描述了在RK356x平台上遇到的PCIe连接问题，涉及PCIE30x1设备收不到信息，以及通过修"
keywords: "invalid prsnt-gpios property in node"
categories: ['']
tags: ['服务器', '前端', 'Java']
artid: "137594052"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=137594052
    alt: "rk3568PCIE30x2-调试"
render_with_liquid: false
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     rk3568PCIE30x2 调试
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="htmledit_views" id="content_views">
    <p style="margin-left:.0001pt;text-align:justify;">
     硬件电路为PCIE30x1
    </p>
    <p style="margin-left:.0001pt;text-align:justify;">
     收不到设备信息
    </p>
    <p style="margin-left:.0001pt;text-align:justify;">
     root@RK356x-Tronlong:~# lspci
    </p>
    <p style="margin-left:.0001pt;text-align:justify;">
     0002:20:00.0 PCI bridge: Rockchip Inc. RK3399 PCI Express Root Port Device 3566 (rev 01)
    </p>
    <p style="margin-left:.0001pt;text-align:justify;">
    </p>
    <p style="margin-left:.0001pt;text-align:justify;">
     内核打印信息
    </p>
    <p style="margin-left:.0001pt;text-align:justify;">
     root@RK356x-Tronlong:~# dmesg |grep pci
    </p>
    <p style="margin-left:.0001pt;text-align:justify;">
     [    0.155560] reg-fixed-voltage pcie30-avdd0v9: Looking up vin-supply from device tree
    </p>
    <p style="margin-left:.0001pt;text-align:justify;">
     [    0.155570] pcie30_avdd0v9: supplied by vcc3v3_sys
    </p>
    <p style="margin-left:.0001pt;text-align:justify;">
     [    0.155637] pcie30_avdd0v9: 900 mV
    </p>
    <p style="margin-left:.0001pt;text-align:justify;">
     [    0.155853] reg-fixed-voltage pcie30-avdd0v9: pcie30_avdd0v9 supplying 900000uV
    </p>
    <p style="margin-left:.0001pt;text-align:justify;">
     [    0.155978] reg-fixed-voltage pcie30-avdd1v8: Looking up vin-supply from device tree
    </p>
    <p style="margin-left:.0001pt;text-align:justify;">
     [    0.155990] pcie30_avdd1v8: supplied by vcc3v3_sys
    </p>
    <p style="margin-left:.0001pt;text-align:justify;">
     [    0.156056] pcie30_avdd1v8: 1800 mV
    </p>
    <p style="margin-left:.0001pt;text-align:justify;">
     [    0.156247] reg-fixed-voltage pcie30-avdd1v8: pcie30_avdd1v8 supplying 1800000uV
    </p>
    <p style="margin-left:.0001pt;text-align:justify;">
     [    0.157206] reg-fixed-voltage vcc3v3-pcie-fake: Looking up vin-supply from device tree
    </p>
    <p style="margin-left:.0001pt;text-align:justify;">
     [    0.157218] vcc3v3_pcie_fake: supplied by dc_12v
    </p>
    <p style="margin-left:.0001pt;text-align:justify;">
     [    0.157285] vcc3v3_pcie_fake: 3300 mV
    </p>
    <p style="margin-left:.0001pt;text-align:justify;">
     [    0.157482] reg-fixed-voltage vcc3v3-pcie-fake: vcc3v3_pcie_fake supplying 3300000uV
    </p>
    <p style="margin-left:.0001pt;text-align:justify;">
     [    0.282390] rk-pcie 3c0000000.pcie: invalid prsnt-gpios property in node
    </p>
    <p style="margin-left:.0001pt;text-align:justify;">
     [    0.282429] rk-pcie 3c0000000.pcie: Looking up vpcie3v3-supply from device tree
    </p>
    <p style="margin-left:.0001pt;text-align:justify;">
     [    0.282529] rk-pcie 3c0000000.pcie: Linked as a consumer to regulator.15
    </p>
    <p style="margin-left:.0001pt;text-align:justify;">
     [    0.282658] rk-pcie 3c0800000.pcie: invalid prsnt-gpios property in node
    </p>
    <p style="margin-left:.0001pt;text-align:justify;">
     [    0.282686] rk-pcie 3c0800000.pcie: Looking up vpcie3v3-supply from device tree
    </p>
    <p style="margin-left:.0001pt;text-align:justify;">
     [    0.282762] rk-pcie 3c0800000.pcie: Linked as a consumer to regulator.15
    </p>
    <p style="margin-left:.0001pt;text-align:justify;">
     [    0.282897] rk-pcie 3c0000000.pcie: use outband MSI support
    </p>
    <p style="margin-left:.0001pt;text-align:justify;">
     [    0.282922] rk-pcie 3c0000000.pcie: Missing *config* reg space
    </p>
    <p style="margin-left:.0001pt;text-align:justify;">
     [    0.282937] rk-pcie 3c0000000.pcie: host bridge /pcie@fe260000 ranges:
    </p>
    <p style="margin-left:.0001pt;text-align:justify;">
     [    0.282961] rk-pcie 3c0000000.pcie:   err 0xf4000000..0xf40fffff -&gt; 0xf4000000
    </p>
    <p style="margin-left:.0001pt;text-align:justify;">
     [    0.282985] rk-pcie 3c0000000.pcie:    IO 0xf4100000..0xf41fffff -&gt; 0xf4100000
    </p>
    <p style="margin-left:.0001pt;text-align:justify;">
     [    0.283009] rk-pcie 3c0000000.pcie:   MEM 0xf4200000..0xf5ffffff -&gt; 0xf4200000
    </p>
    <p style="margin-left:.0001pt;text-align:justify;">
     [    0.283028] rk-pcie 3c0000000.pcie:   MEM 0x300000000..0x33fffffff -&gt; 0x300000000
    </p>
    <p style="margin-left:.0001pt;text-align:justify;">
     [    0.291640] snps pcie3phy FW update! size 8192
    </p>
    <p style="margin-left:.0001pt;text-align:justify;">
     [    0.305668] rk-pcie 3c0800000.pcie: use outband MSI support
    </p>
    <p style="margin-left:.0001pt;text-align:justify;">
     [    0.305698] rk-pcie 3c0800000.pcie: Missing *config* reg space
    </p>
    <p style="margin-left:.0001pt;text-align:justify;">
     [    0.305720] rk-pcie 3c0800000.pcie: host bridge /pcie@fe280000 ranges:
    </p>
    <p style="margin-left:.0001pt;text-align:justify;">
     [    0.305753] rk-pcie 3c0800000.pcie:   err 0xf0000000..0xf00fffff -&gt; 0xf0000000
    </p>
    <p style="margin-left:.0001pt;text-align:justify;">
     [    0.305779] rk-pcie 3c0800000.pcie:    IO 0xf0100000..0xf01fffff -&gt; 0xf0100000
    </p>
    <p style="margin-left:.0001pt;text-align:justify;">
     [    0.305815] rk-pcie 3c0800000.pcie:   MEM 0xf0200000..0xf1ffffff -&gt; 0xf0200000
    </p>
    <p style="margin-left:.0001pt;text-align:justify;">
     [    0.305837] rk-pcie 3c0800000.pcie:   MEM 0x380000000..0x3bfffffff -&gt; 0x380000000
    </p>
    <p style="margin-left:.0001pt;text-align:justify;">
     [    0.693407] ehci-pci: EHCI PCI platform driver
    </p>
    <p style="margin-left:.0001pt;text-align:justify;">
     [    1.289077] rk-pcie 3c0000000.pcie: PCIe Linking... LTSSM is 0x3
    </p>
    <p style="margin-left:.0001pt;text-align:justify;">
     [    1.315743] rk-pcie 3c0800000.pcie: PCIe Linking... LTSSM is 0x0
    </p>
    <p style="margin-left:.0001pt;text-align:justify;">
     [    2.301295] rk-pcie 3c0000000.pcie: PCIe Linking... LTSSM is 0x3
    </p>
    <p style="margin-left:.0001pt;text-align:justify;">
     [    2.438067] rk-pcie 3c0800000.pcie: PCIe Link up, LTSSM is 0x7
    </p>
    <p style="margin-left:.0001pt;text-align:justify;">
     [    2.438258] rk-pcie 3c0800000.pcie: PCI host bridge to bus 0002:20
    </p>
    <p style="margin-left:.0001pt;text-align:justify;">
     [    2.438285] pci_bus 0002:20: root bus resource [bus 20-2f]
    </p>
    <p style="margin-left:.0001pt;text-align:justify;">
     [    2.438302] pci_bus 0002:20: root bus resource [??? 0xf0000000-0xf00fffff flags 0x0]
    </p>
    <p style="margin-left:.0001pt;text-align:justify;">
     [    2.438319] pci_bus 0002:20: root bus resource [io  0x100000-0x1fffff] (bus address [0xf0100000-0xf01fffff])
    </p>
    <p style="margin-left:.0001pt;text-align:justify;">
     [    2.438333] pci_bus 0002:20: root bus resource [mem 0xf0200000-0xf1ffffff]
    </p>
    <p style="margin-left:.0001pt;text-align:justify;">
     [    2.438347] pci_bus 0002:20: root bus resource [mem 0x380000000-0x3bfffffff pref]
    </p>
    <p style="margin-left:.0001pt;text-align:justify;">
     [    2.438392] pci 0002:20:00.0: [1d87:3566] type 01 class 0x060400
    </p>
    <p style="margin-left:.0001pt;text-align:justify;">
     [    2.438425] pci 0002:20:00.0: reg 0x10: [mem 0x00000000-0x3fffffff 64bit]
    </p>
    <p style="margin-left:.0001pt;text-align:justify;">
     [    2.438435] pci 0002:20:00.0: reg 0x38: [mem 0x00000000-0x0000ffff pref]
    </p>
    <p style="margin-left:.0001pt;text-align:justify;">
     [    2.438498] pci 0002:20:00.0: supports D1 D2
    </p>
    <p style="margin-left:.0001pt;text-align:justify;">
     [    2.438503] pci 0002:20:00.0: PME# supported from D0 D1 D3hot
    </p>
    <p style="margin-left:.0001pt;text-align:justify;">
     [    2.450057] pci 0002:20:00.0: bridge configuration invalid ([bus 00-00]), reconfiguring
    </p>
    <p style="margin-left:.0001pt;text-align:justify;">
     [    2.461394] pci_bus 0002:21: busn_res: [bus 21-2f] end is updated to 21
    </p>
    <p style="margin-left:.0001pt;text-align:justify;">
     [    2.461440] pci 0002:20:00.0: BAR 0: no space for [mem size 0x40000000 64bit]
    </p>
    <p style="margin-left:.0001pt;text-align:justify;">
     [    2.461467] pci 0002:20:00.0: BAR 0: failed to assign [mem size 0x40000000 64bit]
    </p>
    <p style="margin-left:.0001pt;text-align:justify;">
     [    2.461482] pci 0002:20:00.0: BAR 6: assigned [mem 0xf0200000-0xf020ffff pref]
    </p>
    <p style="margin-left:.0001pt;text-align:justify;">
     [    2.461495] pci 0002:20:00.0: PCI bridge to [bus 21]
    </p>
    <p style="margin-left:.0001pt;text-align:justify;">
     [    2.464482] pcieport 0002:20:00.0: Signaling PME with IRQ 130
    </p>
    <p style="margin-left:.0001pt;text-align:justify;">
     [    2.464811] pcieport 0002:20:00.0: AER enabled with IRQ 131
    </p>
    <p style="margin-left:.0001pt;text-align:justify;">
     [    3.314670] rk-pcie 3c0000000.pcie: PCIe Linking... LTSSM is 0x3
    </p>
    <p style="margin-left:.0001pt;text-align:justify;">
     [    4.328002] rk-pcie 3c0000000.pcie: PCIe Linking... LTSSM is 0x3
    </p>
    <p style="margin-left:.0001pt;text-align:justify;">
     [    5.341399] rk-pcie 3c0000000.pcie: PCIe Linking... LTSSM is 0x3
    </p>
    <p style="margin-left:.0001pt;text-align:justify;">
     [    6.354702] rk-pcie 3c0000000.pcie: PCIe Linking... LTSSM is 0x3
    </p>
    <p style="margin-left:.0001pt;text-align:justify;">
     [    7.368119] rk-pcie 3c0000000.pcie: PCIe Linking... LTSSM is 0x3
    </p>
    <p style="margin-left:.0001pt;text-align:justify;">
     [    8.381462] rk-pcie 3c0000000.pcie: PCIe Linking... LTSSM is 0x3
    </p>
    <p style="margin-left:.0001pt;text-align:justify;">
     [    9.397981] rk-pcie 3c0000000.pcie: PCIe Linking... LTSSM is 0x3
    </p>
    <p style="margin-left:.0001pt;text-align:justify;">
     [   10.407970] rk-pcie 3c0000000.pcie: PCIe Linking... LTSSM is 0x3
    </p>
    <p style="margin-left:.0001pt;text-align:justify;">
     [   11.421346] rk-pcie 3c0000000.pcie: PCIe Link Fail
    </p>
    <p style="margin-left:.0001pt;text-align:justify;">
     [   11.421383] rk-pcie 3c0000000.pcie: failed to initialize host
    </p>
    <p style="margin-left:.0001pt;text-align:justify;">
     [   11.421657] rk-pcie 3c0000000.pcie: Dropping the link to regulator.15
    </p>
    <p style="margin-left:.0001pt;text-align:justify;">
    </p>
    <p style="margin-left:.0001pt;text-align:justify;">
     修改复位管脚不生效
    </p>
    <p style="margin-left:.0001pt;text-align:justify;">
     root@RK356x-Tronlong:~# io -4 -r 0xfdc60000
    </p>
    <p style="margin-left:.0001pt;text-align:justify;">
     fdc60000:  00000022  GPIO1A2 为GPIO模式 非PCIEreset
    </p>
    <p style="margin-left:.0001pt;text-align:left;">
     收不到设备
    </p>
    <p style="margin-left:.0001pt;text-align:left;">
    </p>
    <p style="margin-left:.0001pt;text-align:left;">
     解决方法：
    </p>
    <p style="margin-left:.0001pt;text-align:left;">
     修改tl3568-evm.dts 正确配置复位
    </p>
    <p style="margin-left:.0001pt;text-align:left;">
     &amp;pcie30phy {
     <!-- -->
    </p>
    <p style="margin-left:.0001pt;text-align:left;">
     status = "okay";
    </p>
    <p style="margin-left:.0001pt;text-align:left;">
     };
    </p>
    <p style="margin-left:.0001pt;text-align:left;">
     /* gpio1 RK_PA2 is used as i2s1 mclk */
    </p>
    <p style="margin-left:.0001pt;text-align:left;">
     &amp;pcie3x2 {
     <!-- -->
    </p>
    <p style="margin-left:.0001pt;text-align:left;">
     //rockchip,bifurcation;
    </p>
    <p style="margin-left:.0001pt;text-align:left;">
     /*///delete-property/ reset-gpios;*/
    </p>
    <p style="margin-left:.0001pt;text-align:left;">
     reset-gpios = &lt;&amp;gpio1 RK_PA2 GPIO_ACTIVE_HIGH&gt;;
    </p>
    <p style="margin-left:.0001pt;text-align:left;">
     //pinctrl-names = "default";
    </p>
    <p style="margin-left:.0001pt;text-align:left;">
     //pinctrl-0 = &lt;&amp;pcie30x2_buttonrstn&gt;;
    </p>
    <p style="margin-left:.0001pt;text-align:left;">
    </p>
    <p style="margin-left:.0001pt;text-align:left;">
     vpcie3v3-supply = &lt;&amp;vcc3v3_pcie_fake&gt;;
    </p>
    <p style="margin-left:.0001pt;text-align:left;">
     status = "okay";
    </p>
    <p style="margin-left:.0001pt;text-align:left;">
     };
    </p>
    <p style="margin-left:.0001pt;text-align:justify;">
     reset-gpios就是gpio1 RK_PA2配成gpio模式
    </p>
    <p style="margin-left:.0001pt;text-align:justify;">
     不需要修改rk3568-pinctrl.dts
    </p>
    <p style="margin-left:.0001pt;text-align:justify;">
     电压1.8V不稳定，改完后成功link
    </p>
    <p style="margin-left:.0001pt;text-align:justify;">
     root@RK356x-Tronlong:~#  io -4 -r 0xfdc60000
    </p>
    <p style="margin-left:.0001pt;text-align:justify;">
     fdc60000:  00000022
    </p>
    <p style="margin-left:.0001pt;text-align:justify;">
     root@RK356x-Tronlong:~# lspci
    </p>
    <p style="margin-left:.0001pt;text-align:justify;">
     0002:20:00.0 PCI bridge: Rockchip Inc. RK3399 PCI Express Root Port Device 3566 (rev 01)
    </p>
    <p style="margin-left:.0001pt;text-align:justify;">
     0002:21:00.0 Network and computing encryption device: Device 1c00:5834 (rev 10)
    </p>
   </div>
  </div>
 </article>
 <p alt="68747470733a2f:2f626c6f672e6373646e2e6e65742f706b706b706b636f6d2f:61727469636c652f64657461696c732f313337353934303532" class_="artid" style="display:none">
 </p>
</div>


