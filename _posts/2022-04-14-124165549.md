---
layout: post
title: "小程序预览文件-在微信小程序中在线预览文件wx.downloadFile和wx.openDocument包含自定义修改打开文件的文件名"
date: 2022-04-14 10:53:38 +0800
description: "在微信小程序中在线预览文件——wx.downloadFile和wx.openDocument（包含自"
keywords: "wx.downloadfile"
categories: ['微信小程序', 'Vue']
tags: ['微信小程序', '前端', 'Vue', 'Javascript']
artid: "124165549"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=124165549
    alt: "小程序预览文件-在微信小程序中在线预览文件wx.downloadFile和wx.openDocument包含自定义修改打开文件的文件名"
render_with_liquid: false
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     【小程序预览文件】 在微信小程序中在线预览文件wx.downloadFile和wx.openDocument（包含自定义修改打开文件的文件名）
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <h2>
     <a id="__0">
     </a>
     △ 前部分先大致说下需要注意的点(便于理解，时间宽裕可收藏后查看)，后部分直接放代码实现，着急的小伙伴可以直接移步后部分。
    </h2>
    <h3>
     <a id="_api_2">
     </a>
     一. 使用微信小程序提供的api（注意顺序，先下载，再打开）
    </h3>
    <h4>
     <a id="11wxdownloadFile___3">
     </a>
     (1-1).
     <code>
      wx.downloadFile
     </code>
     下载文件资源到本地（临时的文件，退出即销毁）
    </h4>
    <blockquote>
     <p>
      △ 客户端直接发起一个 HTTPS GET 请求，返回文件的本地临时路径 (本地路径)，单次下载允许的最大文件为
      <code>
       200MB
      </code>
      。
      <br/>
      △ 使用前请注意阅读微信小程序官网文档指南-网络：https://developers.weixin.qq.com/miniprogram/dev/framework/ability/network.html
      <br/>
      △ 在用到此 api 时，需要小程序在对应的
      <code>
       微信公众后平台添加合法域名白名单，否则将会在编译器中报错，获取不到网络文件！！！（非常重要！！！）
      </code>
      操作方法路径为：开发 - 开发管理 - 开发设置 - 服务器域名 - downloadFile合法域名。
     </p>
    </blockquote>
    <h4>
     <a id="12_wxopenDocument___8">
     </a>
     (1-2).
     <code>
      wx.openDocument
     </code>
     新开页面打开文档
    </h4>
    <blockquote>
     <p>
      △ 微信客户端
      <code>
       7.0.12
      </code>
      版本前默认显示右上角菜单按钮，之后的版本默认不显示，需主动传入
      <code>
       showMenu
      </code>
      <br/>
      △ 指定文件类型打开文件有：doc、docx、xls、xlsx、ppt、pptx、pdf
     </p>
    </blockquote>
    <h4>
     <a id="13__12">
     </a>
     (1-3). 自定义修改打开文件的文件名称：
    </h4>
    <p>
     官方文档并没有明确给出直接修改打开文件的参数，查阅众多小伙伴智慧的结晶（有说使用rename，有说先用saveFile先将文件保存至本地之后再自定义文件名），之后还是觉得可能会有更好的办法实现。终于在知识的海洋里，总结了一个改动最少且是好用的方法。在官方文档里，请注意wx.downloadFile这个api中的filePath参数：
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/ba6f6a34fbbaffc1d4b82880460355c1.png#pic_center"/>
    </p>
    <h3>
     <a id="__15">
     </a>
     二. 上菜：
    </h3>
    <pre><code class="prism language-javascript"><span class="token comment">// 点击事件</span>
<span class="token function">openFile</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">// item为当前点击的事物对象</span>
    <span class="token keyword">let</span> file <span class="token operator">=</span> <span class="token function">decodeURIComponent</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span>pathUrl<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 解码(注意:涉及到文件名中有中文需要转码)</span>
    file <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getFilePathName</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 将文件路径过滤，格式为【文件名+.后缀名】</span>
    <span class="token comment">// 加载状态</span>
    uni<span class="token punctuation">.</span><span class="token function">showLoading</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
      <span class="token literal-property property">title</span><span class="token operator">:</span> <span class="token string">'文件打开中'</span><span class="token punctuation">,</span>
      <span class="token literal-property property">mask</span><span class="token operator">:</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> _this <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token comment">// 预览网络文档</span>
    wx<span class="token punctuation">.</span><span class="token function">downloadFile</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
      <span class="token literal-property property">url</span><span class="token operator">:</span> item<span class="token punctuation">.</span>pathUrl<span class="token punctuation">,</span> <span class="token comment">// 文件的本身url</span>
      <span class="token literal-property property">filePath</span><span class="token operator">:</span> wx<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">USER_DATA_PATH</span> <span class="token operator">+</span> <span class="token string">'/'</span> <span class="token operator">+</span> file<span class="token punctuation">,</span> <span class="token comment">// 本地自定义的文件名</span>
      <span class="token function-variable function">success</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">let</span> filePath <span class="token operator">=</span> res<span class="token punctuation">.</span>filePath<span class="token punctuation">;</span> <span class="token comment">// 微信临时文件路径(这里要使用自定义的名字文件名,否则打开的文件名是乱码)</span>
        wx<span class="token punctuation">.</span><span class="token function">openDocument</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
          <span class="token literal-property property">filePath</span><span class="token operator">:</span> filePath<span class="token punctuation">,</span>
          <span class="token literal-property property">showMenu</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>  <span class="token comment">// 是否显示右上角菜单按钮 默认为false(看自身需求，可要可不要。后期涉及到右上角分享功能)</span>
          <span class="token function-variable function">success</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
             _this<span class="token punctuation">.</span>$util<span class="token punctuation">.</span><span class="token function">toast</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span> <span class="token literal-property property">title</span><span class="token operator">:</span> <span class="token string">'打开文件成功'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token function-variable function">fail</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            _this<span class="token punctuation">.</span>$util<span class="token punctuation">.</span><span class="token function">toast</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span> <span class="token literal-property property">title</span><span class="token operator">:</span> <span class="token string">'打开文件失败，请稍后重试'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        uni<span class="token punctuation">.</span><span class="token function">hideLoading</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token function-variable function">fail</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        _this<span class="token punctuation">.</span>$util<span class="token punctuation">.</span><span class="token function">toast</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span> <span class="token literal-property property">title</span><span class="token operator">:</span> <span class="token string">'打开文件失败，请稍后重试'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        uni<span class="token punctuation">.</span><span class="token function">hideLoading</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token comment">// 文件路径过滤【文件名+.后缀名】</span>
<span class="token comment">// 例如：哈哈.pdf</span>
<span class="token function">getFilePathName</span><span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token keyword">let</span> pos1 <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">lastIndexOf</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> pos2 <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">lastIndexOf</span><span class="token punctuation">(</span><span class="token string">'\\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> position  <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>pos1<span class="token punctuation">,</span> pos2<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span> position<span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token punctuation">)</span>
  <span class="token keyword">return</span> path<span class="token punctuation">;</span>
<span class="token keyword">else</span>
  <span class="token keyword">return</span> path<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>position<span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     △ 查看下效果：
    </p>
    <p>
     【修改前】文件名是一串随机的名字
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/31c378ddb21387110032558210d2ff6c.jpeg#pic_center">
      【修改后】文件名修改成功
      <br/>
      <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/712c22c5903290d383e429fc4faa3770.jpeg#pic_center"/>
     </img>
    </p>
    <blockquote>
     <p>
      查看最终文件打开的效果还是要在
      <code>
       手机
      </code>
      上预览打开。
      <br/>
      有疑问请直接指出。
      <br/>
      整理不易！ 不要吝惜你的小手，有用就点赞或收藏吧。
     </p>
    </blockquote>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f626c6f672e:6373646e2e6e65742f77656978696e5f34333939343736302f:61727469636c652f64657461696c732f313234313635353439" class_="artid" style="display:none">
 </p>
</div>


