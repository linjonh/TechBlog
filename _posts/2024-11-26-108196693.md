---
layout: post
title: 2024-11-26-学习日记物联网云平台乐鑫云平台
date: 2024-11-26 15:16:47 +0800
categories: [小熊派物联网学习笔记]
tags: ['无标签']
image:
  path: https://api.vvhan.com/api/bing?rand=sj&artid=108196693
  alt: 学习日记物联网云平台乐鑫云平台
artid: 108196693
render_with_liquid: false
---
<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     学习日记——物联网云平台（乐鑫云平台）
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <h3>
     <a id="_0">
     </a>
     物联网云平台了解
    </h3>
    <p>
     1、物联网云平台:接收设备上报的数据、向设备下发数据、对数据进行转发/分析/计算/显示、管理设备等。
     <br/>
     2、常见的物联网云平台一般有:
     <br/>
     ①:私有物联网云平台：假设某瓜农，为瓜棚装上了物联网温湿计,温湿度数据通过网络发送某台主机。这台主机运行特定的程序，作用是记录并分析瓜棚的温湿度。那么，这台主机就是只为一个客户服务的物联网服务器。
     <br/>
     ②:通用物联网云平台：专业机构搭建开发的物联网服务平台，提供免费/收费的物联网云平台服务面向的场合是:大量客户、大量设备、大量数据。
     <br/>
     3、相比于传统开发使用通用物联网平台提供的服务有什么优势
    </p>
    <ul>
     <li>
      <p>
       传统开发：
       <br/>
       1.需要搭建基础设施、寻找并联合嵌入式开发人员与云端开发人员。开发工作量大、效率低。
       <br/>
       2.自行实现扩展性架构,极难做到从设备粒度调度服务器、负载均衡等基础设施。
       <br/>
       3.需要额外开发、部署各种安全措施，保障设备数据安全是个极大挑战。
       <br/>
       4.自行发现宕机并完成迁移,迁移时服务会中断。稳定性无法保障。
      </p>
     </li>
     <li>
      <p>
       通用物联网平台的开发
       <br/>
       1.提供设备端SDK，快速连接设备上云，效率高。同时支持全球设备接入、异构网络设备接入、多环境下设备接入、多协议设备接入。
       <br/>
       2.具有亿级设备的长连接能力、百万级并发的能力，架构支撑水平性扩展。
       <br/>
       3.提供多重防护保障设备云端安全，并且可以确保设备认证保障设备安全与唯一性，传输加密保障数据不被篡改，云盾护航、权限校验保障云端安全。服务可用性高达99.9%。单点故障，自动迁移。
      </p>
     </li>
    </ul>
    <h3>
     <a id="_17">
     </a>
     创建云端设备（乐鑫云）
    </h3>
    <p>
     1、乐鑫云平台（建议大家选择前一个）
    </p>
    <ul>
     <li>
      iot.espressif.cn(时区: 中国北京时间）
     </li>
     <li>
      iot.espressif.com(时区:格林尼治标准时间)
     </li>
    </ul>
    <p>
     2、设备
    </p>
    <ul>
     <li>
      <p>
       云下设备：真实存在的设备或者是模拟器模拟的设备（ESP8266模组、网络调试助手等）
      </p>
     </li>
     <li>
      <p>
       云端设备：在云平台中，与云下设备对应的虚拟设备（在云平台中可以创建设备，但是我创建的都是云端设备，但是每个云端设备都需要对应一个云下设备。
       <br/>
       注意：当我们创建云端设备的时候，正常情况下，需要有云下设备来对应我们创建的云端设备。
       <br/>
       3、操作
      </p>
     </li>
     <li>
      <p>
       首先我们打开乐鑫云物联网平台,我们需要先登录，之后才可以创建云端设备，在设备开发页面点击创建。
       <br/>
       <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/48bdd4474518a30a3445f2a8977cd057.png#pic_center"/>
      </p>
     </li>
     <li>
      <p>
       可以由以下方式快捷登录，也可以注册。
      </p>
     </li>
    </ul>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/d7f58aab70fac848c46bf18bb14371fe.png#pic_center"/>
    </p>
    <ul>
     <li>
      <p>
       之后创建云端设备，在设备开发页面点击创建。
       <br/>
       <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/78490ca4baa22578d6ff32d20d0194a0.png#pic_center"/>
      </p>
     </li>
     <li>
      <p>
       填写好产品的名称，类型即可点击创建。注意：最好选择公开设备。
      </p>
     </li>
    </ul>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/93880e0164e783d2a20d652699b3605e.png#pic_center"/>
    </p>
    <ul>
     <li>
      点击创建之后出现以下界面，说明我们的云端设备创建成功。可以看到设备的ID，设备系列，设备名，产品ID，产品系列，产品名。注意：当我们创建云端设备的时候，这个设备会被分配唯一的设备密钥，只有通过这个设备密钥我们的云下设备才可以和我们的云端设备建立联系，也就是说我们的云下设备才可以连接到我们的物联网云平台。
     </li>
    </ul>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/a1b8d438ae3d6c0664d3be777a65353e.png#pic_center"/>
    </p>
    <ul>
     <li>
      我们可以下载设备密钥。
     </li>
    </ul>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/b37db0c81ea3dc842e8993c5f5cdef10.png#pic_center"/>
    </p>
    <ul>
     <li>
      如图显示，我们的设备未激活，因为我们创建的是云端设备，还没有云下设备和我们的云端设备建立连接，所以我们这里显示的是未激活。
      <br/>
      关于数据模型，触发器，定时器，RPC请求等可以参考API文档的详细说明。
      <br/>
      API文档：https://iot.espressif.cn/#/api-zh-cn/
     </li>
    </ul>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/499e76a487c86fe78989a5b18a328181.png#pic_center"/>
    </p>
    <h3>
     <a id="_57">
     </a>
     与乐鑫云平台进行交互
    </h3>
    <p>
     1、请求
    </p>
    <ul>
     <li>
      目前支持 Http Rest 和 Socket 接口，不是严格的遵循 Rest 规范，比如在 POST
      <br/>
      创建行为之后，会响应新创建的对象，为的是方便开发者获取创建对象；没有 DELETE 方法，使用 POST
      <br/>
      /url?method=DELETE 代替。
     </li>
     <li>
      所有的 Http API 都通过
      <code>
       https://iot.espressif.cn
      </code>
      这里强烈推荐使用 https 协议而不是
      <br/>
      http。
     </li>
     <li>
      Socket 通过
      <code>
       tcp://iot.espressif.cn:8000
      </code>
      。
     </li>
     <li>
      加密 Socket 通过
      <code>
       tcp://iot.espressif.cn:8443
      </code>
      。
     </li>
    </ul>
    <p>
     2、参数
    </p>
    <ul>
     <li>
      目前参数通过三种方式传递：
      <br/>
      Url: 参数包含在 url 里面，比如 /v1/products/:product_id/。 :product_id 代表一个可变的参数
      <br/>
      Header: 比如认证 Token 的传递：
     </li>
    </ul>
    <pre><code class="prism language-c">Authorization<span class="token punctuation">:</span> token <span class="token number">6</span>d9542d12d17e69c2d4260f09ee5a72464565e22
</code></pre>
    <p>
     Get: 一些分页参数，或者 id：
     <code>
      ?offset=0&amp;row_count=100
     </code>
     <br/>
     Post: 大部分信息的传递，json字符串：
    </p>
    <pre><code class="prism language-c"><span class="token punctuation">{<!-- --></span>
  <span class="token string">"nonce"</span><span class="token punctuation">:</span> <span class="token number">10086</span><span class="token punctuation">,</span>
  <span class="token string">"path"</span><span class="token punctuation">:</span> <span class="token string">"/v1/device/"</span><span class="token punctuation">,</span>
  <span class="token string">"method"</span><span class="token punctuation">:</span> <span class="token string">"GET"</span><span class="token punctuation">,</span>
  <span class="token string">"meta"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">"Authorization"</span><span class="token punctuation">:</span> <span class="token string">"token 000..."</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token string">"get"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token string">"post"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token string">"body"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre>
    <ul>
     <li>
      使用标签表示需要的参数，比如：
     </li>
    </ul>
    <pre><code class="prism language-c">require userauth
</code></pre>
    <p>
     （需要 email/password 验证）
     <br/>
     <code>
      require userkey
     </code>
     （需要 userkey）
     <br/>
     <code>
      require devicekey require master devicekey require owner devicekey
     </code>
     （需要 devicekey）
     <br/>
     <code>
      require key
     </code>
     （需要 userkey or devicekey）
    </p>
    <ul>
     <li>
      <p>
       一些常用的参数，比如：
       <br/>
       offset, row_count: 用于分页函数，offset=100&amp;row_count=100 偏移值和行数，对应 mysql 语法的
       <code>
        offset
       </code>
       ,
       <code>
        row_count
       </code>
       <br/>
       start, end: 对于时间序列的数据，start=2014-05-22 16:16:04&amp;end=2014-06-22 16:16:04
      </p>
     </li>
     <li>
      <p>
       请求一段时间范围 [start, end) 的数据
       <br/>
       deliver_to_device: true/false，当设备使用 socket 连接，thirdparty-device-key 的请求可以使用 deliver_to_device=true 参数把请求传递到设备，主要是为了反向控制使用，api 使用见 获取设备单个数据点、创建设备单个数据点
      </p>
     </li>
    </ul>
    <p>
     3、响应
    </p>
    <ul>
     <li>
      常规的响应：
     </li>
    </ul>
    <pre><code class="prism language-c"><span class="token punctuation">{<!-- --></span><span class="token string">"status"</span><span class="token punctuation">:</span> <span class="token number">200</span><span class="token punctuation">,</span> <span class="token string">"result"</span><span class="token punctuation">:</span> <span class="token string">"success if status == 20x or failed"</span><span class="token punctuation">,</span> <span class="token string">"message"</span><span class="token punctuation">:</span> <span class="token string">"here is the message"</span><span class="token punctuation">}</span>
</code></pre>
    <ul>
     <li>
      带有元信息的响应：
     </li>
    </ul>
    <pre><code class="prism language-c"><span class="token punctuation">{<!-- --></span><span class="token string">"status"</span><span class="token punctuation">:</span> <span class="token number">200</span><span class="token punctuation">,</span> <span class="token string">"device"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
</code></pre>
    <ul>
     <li>
      响应状态（“status”: 200），尽可能对应 http status code 的相关含义，一般有以下几种状态：
      <br/>
      200: 正常，可能附带数据
      <br/>
      400: 请求参数或者格式不对
      <br/>
      403: 没有相关的权限
      <br/>
      404: 资源没有找到
      <br/>
      500: 内部数据出现错误
     </li>
    </ul>
    <p>
     4、API（这些在API文档里有详细说明:https://iot.espressif.cn/#/api-zh-cn/
     <br/>
     PLAIN方式激活NC请求:
    </p>
    <pre><code class="prism language-c">echo <span class="token string">'{"path": "/v1/device/activate/", "method": "POST", "meta": {"Authorization": "token HERE_IS_THE_MASTER_DEVICE_KEY"}, "body": {"encrypt_method": "PLAIN", "bssid": ":bssid", "token": ":token"}}'</span><span class="token operator">|</span>nc iot<span class="token punctuation">.</span>espressif<span class="token punctuation">.</span>cn <span class="token number">8000</span>
</code></pre>
    <pre><code class="prism language-c"><span class="token punctuation">{<!-- --></span><span class="token string">"Authorization"</span><span class="token punctuation">:</span> <span class="token string">"token HERE_IS_THE_MASTER_DEVICE_KEY"</span><span class="token punctuation">}</span>
</code></pre>
    <p>
     这里需要我们输入密钥，是云下设备向乐鑫云平台表明身份用的。
    </p>
    <pre><code class="prism language-c"><span class="token string">"bssid"</span>
</code></pre>
    <p>
     这里需要我们填写云下设备的MARK地址
    </p>
    <pre><code class="prism language-c"><span class="token string">"token"</span>
</code></pre>
    <p>
     这个是一个随机值，加密使用。
    </p>
    <p>
     云下设备可以向乐鑫云平台发送以下的JSON字符串，来和服务器保持心跳，也需要填写设备密钥。
     <br/>
     【心跳】：当网络连接(TCP)建立后，如果[云下设备]长时间未和[物联网云平台(服务器)]进行通信，服务器将会断开此网络连接(TCP)。但是，很多情况下，云下设备比较长时间才会发一次数据。为了不让云平台断开与云下设备的网络连接(TCP)，云下设备]每隔一定时间，就要向云平台发送消息。
    </p>
    <pre><code class="prism language-c">echo <span class="token string">'{"path": "/v1/ping/", "method": "GET", "meta": {"Authorization": "token HERE_IS_THE_DEVICE_KEY"}}'</span><span class="token operator">|</span>nc iot<span class="token punctuation">.</span>espressif<span class="token punctuation">.</span>cn <span class="token number">8000</span>
</code></pre>
    <p>
     【注意】：云下设备在与乐鑫云平台建立网络连接后,只要按照[乐鑫云平台]规定好的数据格式，来收发网络数据,云下设备就能与乐鑫云平台进行交互,实现[设备接入物联网云平台。
    </p>
    <h3>
     <a id="_159">
     </a>
     例程
    </h3>
    <p>
     我们用网络调试助手做为TCPclient连接到乐鑫云平台。首先设置乐鑫云平台的域名，端口号是8000，点击连接。可以看到TCP连接已成功建立
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/8d8eece3484c3747881cd650b6b16179.png#pic_center">
      <br/>
      接下来我们需要使用网络调试助手向乐鑫云平台发送云端设备激活的API
      <br/>
      " nonce": 66," path": “/v1/device/activate/” “method”: “POST”, “body”: {" encrypt method":”PL AIN", “token”:“ ”，”bssid"." 66:66:66:66:66:66"," rom_ version":“V1.0”}, “meta”: {" Authorization":”token 4c4192c3095be4a06e30840f5feec945ac106bd4"}
      <br/>
      <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/1120c6ef8e5cf9d7530197f5a84b620a.png#pic_center"/>
      <br/>
      程序会根据我们Flash的大小来决定系统扇区的起始位置。如果是图中所选的大小则是32M_512_512,设备密钥文件烧录到【0X7D】上。
      <br/>
      <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/a87355d0431cc420fe2927aa9a8ee965.png#pic_center"/>
      <br/>
      首先是user_init函数，其中有
      <code>
       user_esp_platform_init();
      </code>
      此函数，读取0X7D扇区的数据，其中有设备密钥等参数。
     </img>
    </p>
    <pre><code class="prism language-c"><span class="token keyword">void</span> ICACHE_FLASH_ATTR <span class="token function">user_esp_platform_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token comment">// 获取版本信息</span>
	<span class="token comment">//--------------------------------------------------------------------------</span>
	<span class="token function">os_sprintf</span><span class="token punctuation">(</span>iot_version<span class="token punctuation">,</span><span class="token string">"%s%d.%d.%dt%d(%s)"</span><span class="token punctuation">,</span>VERSION_TYPE<span class="token punctuation">,</span>IOT_VERSION_MAJOR<span class="token punctuation">,</span>\
	IOT_VERSION_MINOR<span class="token punctuation">,</span>IOT_VERSION_REVISION<span class="token punctuation">,</span>device_type<span class="token punctuation">,</span>UPGRADE_FALG<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">os_printf</span><span class="token punctuation">(</span><span class="token string">"IOT VERSION = %s\n"</span><span class="token punctuation">,</span>iot_version<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">//--------------------------------------------------------------------------------------------------------------------</span>
	<span class="token function">system_param_load</span><span class="token punctuation">(</span>priv_param_start_sec<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>esp_param<span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>esp_param<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">// 读取【0x7D(0x7C+1)扇区】的数据(KEY_BIN)</span>
	<span class="token function">os_printf</span><span class="token punctuation">(</span><span class="token string">"esp_param.devkey = %s\n"</span><span class="token punctuation">,</span>esp_param<span class="token punctuation">.</span>devkey<span class="token punctuation">)</span><span class="token punctuation">;</span>						<span class="token comment">// 串口打印【devkey】</span>
	<span class="token function">os_printf</span><span class="token punctuation">(</span><span class="token string">"esp_param.token = %s\n"</span><span class="token punctuation">,</span>esp_param<span class="token punctuation">.</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span>						<span class="token comment">// 串口打印【token】</span>
	<span class="token function">os_printf</span><span class="token punctuation">(</span><span class="token string">"esp_param.pad = %s\n"</span><span class="token punctuation">,</span>esp_param<span class="token punctuation">.</span>pad<span class="token punctuation">)</span><span class="token punctuation">;</span>							<span class="token comment">// 串口打印【pad】</span>
	<span class="token function">os_printf</span><span class="token punctuation">(</span><span class="token string">"esp_param.activeflag = %d\n"</span><span class="token punctuation">,</span>esp_param<span class="token punctuation">.</span>activeflag<span class="token punctuation">)</span><span class="token punctuation">;</span>				<span class="token comment">// 串口打印【activeflag】</span>

<span class="token comment">//	while(1) system_soft_wdt_feed();	// 【技小新添加】</span>

	<span class="token comment">// ESP8266复位后，执行复位查询</span>
	<span class="token comment">//-------------------------------------------------------------------------</span>
	<span class="token keyword">struct</span> rst_info <span class="token operator">*</span>rtc_info <span class="token operator">=</span> <span class="token function">system_get_rst_info</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">// 获取当前的启动信息</span>
	<span class="token function">os_printf</span><span class="token punctuation">(</span><span class="token string">"reset reason: %x\n"</span><span class="token punctuation">,</span> rtc_info<span class="token operator">-&gt;</span>reason<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">// 打印复位原因</span>

	<span class="token comment">// 判断复位原因</span>
	<span class="token comment">//--------------------------------------------------------------------</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>rtc_info<span class="token operator">-&gt;</span>reason <span class="token operator">==</span> REASON_WDT_RST <span class="token operator">||</span>			<span class="token comment">// 看门狗复位</span>
		rtc_info<span class="token operator">-&gt;</span>reason <span class="token operator">==</span> REASON_EXCEPTION_RST <span class="token operator">||</span>		<span class="token comment">// 异常复位</span>
		rtc_info<span class="token operator">-&gt;</span>reason <span class="token operator">==</span> REASON_SOFT_WDT_RST<span class="token punctuation">)</span>		<span class="token comment">// 软件看门狗复位</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>rtc_info<span class="token operator">-&gt;</span>reason <span class="token operator">==</span> REASON_EXCEPTION_RST<span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			<span class="token function">os_printf</span><span class="token punctuation">(</span><span class="token string">"Fatal exception (%d):\n"</span><span class="token punctuation">,</span> rtc_info<span class="token operator">-&gt;</span>exccause<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token function">os_printf</span><span class="token punctuation">(</span><span class="token string">"epc1=0x%08x, epc2=0x%08x, epc3=0x%08x, excvaddr=0x%08x, depc=0x%08x\n"</span><span class="token punctuation">,</span>
		rtc_info<span class="token operator">-&gt;</span>epc1<span class="token punctuation">,</span> rtc_info<span class="token operator">-&gt;</span>epc2<span class="token punctuation">,</span> rtc_info<span class="token operator">-&gt;</span>epc3<span class="token punctuation">,</span> rtc_info<span class="token operator">-&gt;</span>excvaddr<span class="token punctuation">,</span> rtc_info<span class="token operator">-&gt;</span>depc<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>


	<span class="token comment">// 保存之前的IP地址</span>
	<span class="token comment">//-------------------------------------------------------------------------</span>
	<span class="token comment">/***add by tzx for saving ip_info to avoid dhcp_client start****/</span>
    <span class="token keyword">struct</span> dhcp_client_info dhcp_info<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> ip_info sta_info<span class="token punctuation">;</span>
    <span class="token function">system_rtc_mem_read</span><span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>dhcp_info<span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> dhcp_client_info<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">// 读取RTC memory中的数据</span>

    <span class="token comment">// 判断之前是否保存为1</span>
    <span class="token comment">//-----------------------------------------------------------------</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>dhcp_info<span class="token punctuation">.</span>flag <span class="token operator">==</span> <span class="token number">0x01</span> <span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>true <span class="token operator">==</span> <span class="token function">wifi_station_dhcpc_status</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>	<span class="token comment">// STA_DHCP启动</span>
		<span class="token punctuation">{<!-- --></span>
			<span class="token function">wifi_station_dhcpc_stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>				<span class="token comment">// STA_DHCP停止</span>
		<span class="token punctuation">}</span>

		sta_info<span class="token punctuation">.</span>ip <span class="token operator">=</span> dhcp_info<span class="token punctuation">.</span>ip_addr<span class="token punctuation">;</span>	<span class="token comment">// 重新设为之前的IP地址</span>
		sta_info<span class="token punctuation">.</span>gw <span class="token operator">=</span> dhcp_info<span class="token punctuation">.</span>gw<span class="token punctuation">;</span>
		sta_info<span class="token punctuation">.</span>netmask <span class="token operator">=</span> dhcp_info<span class="token punctuation">.</span>netmask<span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span> true <span class="token operator">!=</span> <span class="token function">wifi_set_ip_info</span><span class="token punctuation">(</span>STATION_IF<span class="token punctuation">,</span><span class="token operator">&amp;</span>sta_info<span class="token punctuation">)</span><span class="token punctuation">)</span>	<span class="token comment">// 设置STA的IP地址</span>
		<span class="token punctuation">{<!-- --></span> <span class="token function">os_printf</span><span class="token punctuation">(</span><span class="token string">"set default ip wrong\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
	<span class="token punctuation">}</span>

    <span class="token function">os_memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dhcp_info<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> dhcp_client_info<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	 <span class="token comment">// dhcp_info清0</span>
    <span class="token function">system_rtc_mem_write</span><span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>dhcp_info<span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> rst_info<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// RTC_mem清0</span>


<span class="token macro property">#<span class="token directive keyword">if</span> AP_CACHE</span>
    <span class="token function">wifi_station_ap_number_set</span><span class="token punctuation">(</span>AP_CACHE_NUMBER<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">// AP信息缓存(5个)</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>


<span class="token macro property">#<span class="token directive keyword">if</span> 0</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">char</span> sofap_mac<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">0x16</span><span class="token punctuation">,</span> <span class="token number">0x34</span><span class="token punctuation">,</span> <span class="token number">0x56</span><span class="token punctuation">,</span> <span class="token number">0x78</span><span class="token punctuation">,</span> <span class="token number">0x90</span><span class="token punctuation">,</span> <span class="token number">0xab</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token keyword">char</span> sta_mac<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">0x12</span><span class="token punctuation">,</span> <span class="token number">0x34</span><span class="token punctuation">,</span> <span class="token number">0x56</span><span class="token punctuation">,</span> <span class="token number">0x78</span><span class="token punctuation">,</span> <span class="token number">0x90</span><span class="token punctuation">,</span> <span class="token number">0xab</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token keyword">struct</span> ip_info info<span class="token punctuation">;</span>

        <span class="token function">wifi_set_macaddr</span><span class="token punctuation">(</span>SOFTAP_IF<span class="token punctuation">,</span> sofap_mac<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">wifi_set_macaddr</span><span class="token punctuation">(</span>STATION_IF<span class="token punctuation">,</span> sta_mac<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">IP4_ADDR</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>info<span class="token punctuation">.</span>ip<span class="token punctuation">,</span> <span class="token number">192</span><span class="token punctuation">,</span> <span class="token number">168</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">IP4_ADDR</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>info<span class="token punctuation">.</span>gw<span class="token punctuation">,</span> <span class="token number">192</span><span class="token punctuation">,</span> <span class="token number">168</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">IP4_ADDR</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>info<span class="token punctuation">.</span>netmask<span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">wifi_set_ip_info</span><span class="token punctuation">(</span>STATION_IF<span class="token punctuation">,</span> <span class="token operator">&amp;</span>info<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">IP4_ADDR</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>info<span class="token punctuation">.</span>ip<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">IP4_ADDR</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>info<span class="token punctuation">.</span>gw<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">IP4_ADDR</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>info<span class="token punctuation">.</span>netmask<span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">wifi_set_ip_info</span><span class="token punctuation">(</span>SOFTAP_IF<span class="token punctuation">,</span> <span class="token operator">&amp;</span>info<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>


    <span class="token comment">// esp_param.activeflag ==【0】：云端设备未激活【初始值==0xFF】</span>
    <span class="token comment">// esp_param.activeflag ==【1】：云端设备已激活</span>
    <span class="token comment">//------------------------------------------------------------------</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>esp_param<span class="token punctuation">.</span>activeflag <span class="token operator">!=</span> <span class="token number">1</span><span class="token punctuation">)</span>		<span class="token comment">// 【云端设备】未激活</span>
    <span class="token punctuation">{<!-- --></span>
<span class="token macro property">#<span class="token directive keyword">ifdef</span> SOFTAP_ENCRYPT</span>
        <span class="token keyword">struct</span> softap_config config<span class="token punctuation">;</span>
        <span class="token keyword">char</span> password<span class="token punctuation">[</span><span class="token number">33</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">char</span> macaddr<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

        <span class="token function">wifi_softap_get_config</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">wifi_get_macaddr</span><span class="token punctuation">(</span>SOFTAP_IF<span class="token punctuation">,</span> macaddr<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">os_memset</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>password<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>password<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">os_sprintf</span><span class="token punctuation">(</span>password<span class="token punctuation">,</span> MACSTR <span class="token string">"_%s"</span><span class="token punctuation">,</span> <span class="token function">MAC2STR</span><span class="token punctuation">(</span>macaddr<span class="token punctuation">)</span><span class="token punctuation">,</span> PASSWORD<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">os_memcpy</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>password<span class="token punctuation">,</span> password<span class="token punctuation">,</span> <span class="token function">os_strlen</span><span class="token punctuation">(</span>password<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        config<span class="token punctuation">.</span>authmode <span class="token operator">=</span> AUTH_WPA_WPA2_PSK<span class="token punctuation">;</span>

        <span class="token function">wifi_softap_set_config</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>

        <span class="token function">wifi_set_opmode</span><span class="token punctuation">(</span>STATIONAP_MODE<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">// 设为AP+STA模式【开启AP模式使为了使用APP来向ESP8266发送路由器WIFI的SSID、PASS】</span>
    <span class="token punctuation">}</span>

<span class="token macro property">#<span class="token directive keyword">if</span> PLUG_DEVICE</span>
    <span class="token function">user_plug_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">// 插座初始化</span>
<span class="token macro property">#<span class="token directive keyword">elif</span> LIGHT_DEVICE</span>
    <span class="token function">user_light_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">// 灯光初始化(PWM)</span>
<span class="token macro property">#<span class="token directive keyword">elif</span> SENSOR_DEVICE</span>
    <span class="token function">user_sensor_init</span><span class="token punctuation">(</span>esp_param<span class="token punctuation">.</span>activeflag<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">// 传感器初始化</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>

    <span class="token comment">// 判断ESP8266是否为SoftAP模式</span>
    <span class="token comment">//-------------------------------------------------------------------------------------------</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">wifi_get_opmode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> SOFTAP_MODE<span class="token punctuation">)</span>	<span class="token comment">// 不是SoftAP模式</span>
    <span class="token punctuation">{<!-- --></span>
    	<span class="token comment">// 设置定时器（定时查询ESP8266的IP情况）</span>
    	<span class="token comment">//----------------------------------------</span>
    	<span class="token function">os_timer_disarm</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>client_timer<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">os_timer_setfn</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>client_timer<span class="token punctuation">,</span> <span class="token punctuation">(</span>os_timer_func_t <span class="token operator">*</span><span class="token punctuation">)</span>user_esp_platform_check_ip<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">// 参数3=1：表示当前是刚复位状态</span>
        <span class="token function">os_timer_arm</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>client_timer<span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">// 使能毫秒定时器(100Ms定时)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     之后连接wifi，如果成功连接到wifi得话。
     <br/>
     ，进行TCP连接设置，并进行DNS域名解析，如果域名解析成功的话，那么就将ESP8266做为TCPclient连接到TCPServer也就是乐鑫云平台。当TCP连接成功之后，我们向乐鑫云平台发送数据包。SP8266会根据云端设备是否激活来选择向云端设备发送设备激活的字符串还是核实身份的JSON字符串。
    </p>
    <pre><code class="prism language-c"><span class="token keyword">void</span> ICACHE_FLASH_ATTR <span class="token function">user_esp_platform_check_ip</span><span class="token punctuation">(</span>uint8 reset_flag<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">struct</span> ip_info ipconfig<span class="token punctuation">;</span>					<span class="token comment">// IP信息结构体</span>

    <span class="token function">os_timer_disarm</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>client_timer<span class="token punctuation">)</span><span class="token punctuation">;</span>				<span class="token comment">// 暂时关闭Client定时器</span>

    <span class="token function">wifi_get_ip_info</span><span class="token punctuation">(</span>STATION_IF<span class="token punctuation">,</span> <span class="token operator">&amp;</span>ipconfig<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">// 获取STA模式下的IP地址</span>

    <span class="token comment">// ESP8266获取到IP地址</span>
    <span class="token comment">//---------------------------------------------------------------------------</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">wifi_station_get_connect_status</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">==</span>STATION_GOT_IP <span class="token operator">&amp;&amp;</span> ipconfig<span class="token punctuation">.</span>ip<span class="token punctuation">.</span>addr<span class="token operator">!=</span><span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
<span class="token macro property">#<span class="token directive keyword">if</span> (PLUG_DEVICE || SENSOR_DEVICE)</span>
        <span class="token function">user_link_led_timer_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>

<span class="token comment">//--------------------------------------</span>
<span class="token macro property">#<span class="token directive keyword">if</span> LIGHT_DEVICE</span>
	<span class="token function">user_mdns_conf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">// mDNS初始化</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>
<span class="token comment">//--------------------------------------</span>

		<span class="token comment">// TCP连接设置</span>
		<span class="token comment">//------------------------------------------------------------------</span>
        user_conn<span class="token punctuation">.</span>proto<span class="token punctuation">.</span>tcp <span class="token operator">=</span> <span class="token operator">&amp;</span>user_tcp<span class="token punctuation">;</span>	<span class="token comment">// 开辟内存</span>
        user_conn<span class="token punctuation">.</span>type <span class="token operator">=</span> ESPCONN_TCP<span class="token punctuation">;</span>		<span class="token comment">// 设为TCP连接</span>
        user_conn<span class="token punctuation">.</span>state <span class="token operator">=</span> ESPCONN_NONE<span class="token punctuation">;</span>

        device_status <span class="token operator">=</span> DEVICE_CONNECTING<span class="token punctuation">;</span>	<span class="token comment">// 设备(8266)状态设为【正在连接】</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>reset_flag<span class="token punctuation">)</span>				<span class="token comment">// 判断是否是刚复位</span>
        <span class="token punctuation">{<!-- --></span> device_recon_count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span>	<span class="token comment">// 系统复位后，ESP8266_TCP重连计数=0（reset_flag==1表示为系统复位）</span>

<span class="token macro property">#<span class="token directive keyword">if</span> (PLUG_DEVICE || LIGHT_DEVICE)</span>
        <span class="token function">os_timer_disarm</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>beacon_timer<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">// 设置心跳定时器定时器</span>
        <span class="token function">os_timer_setfn</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>beacon_timer<span class="token punctuation">,</span> <span class="token punctuation">(</span>os_timer_func_t <span class="token operator">*</span><span class="token punctuation">)</span>user_esp_platform_sent_beacon<span class="token punctuation">,</span> <span class="token operator">&amp;</span>user_conn<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>

<span class="token macro property">#<span class="token directive keyword">ifdef</span> USE_DNS</span>
        <span class="token function">user_esp_platform_start_dns</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user_conn<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">// DNS设置</span>
<span class="token macro property">#<span class="token directive keyword">else</span></span>
        <span class="token keyword">const</span> <span class="token keyword">char</span> esp_server_ip<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">114</span><span class="token punctuation">,</span> <span class="token number">215</span><span class="token punctuation">,</span> <span class="token number">177</span><span class="token punctuation">,</span> <span class="token number">97</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

        <span class="token function">os_memcpy</span><span class="token punctuation">(</span>user_conn<span class="token punctuation">.</span>proto<span class="token punctuation">.</span>tcp<span class="token operator">-&gt;</span>remote_ip<span class="token punctuation">,</span> esp_server_ip<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        user_conn<span class="token punctuation">.</span>proto<span class="token punctuation">.</span>tcp<span class="token operator">-&gt;</span>local_port <span class="token operator">=</span> <span class="token function">espconn_port</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token macro property">#<span class="token directive keyword">ifdef</span> CLIENT_SSL_ENABLE</span>
        user_conn<span class="token punctuation">.</span>proto<span class="token punctuation">.</span>tcp<span class="token operator">-&gt;</span>remote_port <span class="token operator">=</span> <span class="token number">8443</span><span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">else</span></span>
        user_conn<span class="token punctuation">.</span>proto<span class="token punctuation">.</span>tcp<span class="token operator">-&gt;</span>remote_port <span class="token operator">=</span> <span class="token number">8000</span><span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>

        <span class="token function">espconn_regist_connectcb</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user_conn<span class="token punctuation">,</span> user_esp_platform_connect_cb<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">espconn_regist_reconcb</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user_conn<span class="token punctuation">,</span> user_esp_platform_recon_cb<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">user_esp_platform_connect</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user_conn<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 未获取到IP地址</span>
    <span class="token comment">//------------------------------------------------------------------------------------------</span>
    <span class="token keyword">else</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token comment">/* if there are wrong while connecting to some AP, then reset mode */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">wifi_station_get_connect_status</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> STATION_WRONG_PASSWORD <span class="token operator">||</span>		<span class="token comment">// [密码错误]、[未发现AP]、[连接失败]</span>
                <span class="token function">wifi_station_get_connect_status</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> STATION_NO_AP_FOUND <span class="token operator">||</span>
                <span class="token function">wifi_station_get_connect_status</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> STATION_CONNECT_FAIL<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token function">user_esp_platform_reset_mode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">// ESP8266设为AP+STA模式，并且5秒切换WIFI</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token function">os_timer_setfn</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>client_timer<span class="token punctuation">,</span> <span class="token punctuation">(</span>os_timer_func_t <span class="token operator">*</span><span class="token punctuation">)</span>user_esp_platform_check_ip<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">// 继续查询ESP8266的IP获取情况</span>
            <span class="token function">os_timer_arm</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>client_timer<span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     当ESP8266接收到乐鑫云平台发送的请求，当发送的是LED_ON时，ESP8266会将LED点亮，当请求内容是LED_OF时，ESP8266会将LED熄灭。
    </p>
    <pre><code class="prism language-c"><span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">os_strstr</span><span class="token punctuation">(</span>pbuffer<span class="token punctuation">,</span> <span class="token string">"{\"deliver_to_device\": true, \"get\": {\"action\": \"LED_ON\"}"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token constant">NULL</span> <span class="token punctuation">)</span>
            	<span class="token punctuation">{<!-- --></span>
            		<span class="token function">PIN_FUNC_SELECT</span><span class="token punctuation">(</span>PERIPHS_IO_MUX_GPIO4_U<span class="token punctuation">,</span>	FUNC_GPIO4<span class="token punctuation">)</span><span class="token punctuation">;</span>
            		<span class="token function">GPIO_OUTPUT_SET</span><span class="token punctuation">(</span><span class="token function">GPIO_ID_PIN</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">// LED亮</span>
            	<span class="token punctuation">}</span>
            	<span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">os_strstr</span><span class="token punctuation">(</span>pbuffer<span class="token punctuation">,</span> <span class="token string">"{\"deliver_to_device\": true, \"get\": {\"action\": \"LED_OFF\"}"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token constant">NULL</span> <span class="token punctuation">)</span>
            	<span class="token punctuation">{<!-- --></span>
            		<span class="token function">PIN_FUNC_SELECT</span><span class="token punctuation">(</span>PERIPHS_IO_MUX_GPIO4_U<span class="token punctuation">,</span>	FUNC_GPIO4<span class="token punctuation">)</span><span class="token punctuation">;</span>
            		<span class="token function">GPIO_OUTPUT_SET</span><span class="token punctuation">(</span><span class="token function">GPIO_ID_PIN</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">// LED灭</span>
            	<span class="token punctuation">}</span>
</code></pre>
    <h3>
     <a id="_399">
     </a>
     现象
    </h3>
    <p>
     首先我们编译程序，下载程序，我们还需要将我们的密钥烧录到ESP8266的0x7d000中。
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/60aedb7085381d9f91d802058705070e.png#pic_center"/>
     <br/>
     未完待续。。。。。。
    </p>
    <h3>
     <a id="_403">
     </a>
     参考链接
    </h3>
    <p>
     https://iot.espressif.cn/#/api-zh-cn/
    </p>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
</div>


<p class="artid" style="display:none">68747470733a2f:2f626c6f672e6373646e2e6e65742f7175616e717565656e2f:61727469636c652f64657461696c732f313038313936363933</p>
