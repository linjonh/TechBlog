---
layout: post
title: "STM32SPI屏幕刷图总结GPIO模拟,硬件SPI,DMA硬件SPI"
date: 2025-01-20 12:03:07 +0800
description: "分辨率：240*320颜色：RGB565方式一帧耗时帧率GPIO模拟SPI220ms4.5 fps硬"
keywords: "stm32 spi驱动st7789v"
categories: ["未分类"]
tags: ["嵌入式硬件", "单片机", "Stm"]
artid: "131772187"
image:
  path: https://api.vvhan.com/api/bing?rand=sj&artid=131772187
  alt: "STM32SPI屏幕刷图总结GPIO模拟,硬件SPI,DMA硬件SPI"
render_with_liquid: false
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     【STM32】SPI屏幕刷图总结：GPIO模拟，硬件SPI，DMA+硬件SPI
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-dracula" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <p>
    </p>
    <div class="toc">
     <h4>
      文章目录
     </h4>
     <ul>
      <li>
       <a href="#GPIOSPI_161" rel="nofollow">
        GPIO模拟SPI
       </a>
      </li>
      <li>
       <a href="#SPI_409" rel="nofollow">
        硬件SPI外设
       </a>
      </li>
      <li>
       <a href="#DMASPI_687" rel="nofollow">
        DMA+硬件SPI外设
       </a>
      </li>
      <li>
       <a href="#_871" rel="nofollow">
        总结
       </a>
      </li>
     </ul>
    </div>
    <br/>
    代码工程：https://github.com/liefyuan/stm32-spi-st7789-tft.git
    <p>
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/42d6e9aa8fb7761464e0f66249cb03fd.png"/>
    </p>
    <p>
     前言
    </p>
    <p>
     我的屏幕的分辨率是：240*320
     <br/>
     驱动是：ST7789V
     <br/>
     线驱动方式：四线SPI（CS，DC，SDA，SCL）
     <br/>
     以下分别使用了三种方式来实现刷图。
    </p>
    <p>
     头文件：
    </p>
    <pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">__ST7789_DRIVER_H__</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">__ST7789_DRIVER_H__</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"stdint.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"stm32f4xx.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"system_stm32f4xx.h"</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ST7789_LCD_WIDTH</span> <span class="token expression"><span class="token number">240</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ST7789_LCD_HEIGHT</span> <span class="token expression"><span class="token number">320</span></span></span>

<span class="token comment">// System Function Command Table 1</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ST7789_CMD_NOP</span> <span class="token expression"><span class="token number">0x00</span> </span><span class="token comment">// No operation</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ST7789_CMD_SWRESET</span> <span class="token expression"><span class="token number">0x01</span> </span><span class="token comment">// Software reset</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ST7789_CMD_RDDID</span> <span class="token expression"><span class="token number">0x04</span> </span><span class="token comment">// Read display ID</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ST7789_CMD_RDDST</span> <span class="token expression"><span class="token number">0x09</span> </span><span class="token comment">// Read display status</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ST7789_CMD_RDDPM</span> <span class="token expression"><span class="token number">0x0a</span> </span><span class="token comment">// Read display power</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ST7789_CMD_RDDMADCTL</span> <span class="token expression"><span class="token number">0x0b</span> </span><span class="token comment">// Read display</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ST7789_CMD_RDDCOLMOD</span> <span class="token expression"><span class="token number">0x0c</span> </span><span class="token comment">// Read display pixel</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ST7789_CMD_RDDIM</span> <span class="token expression"><span class="token number">0x0d</span> </span><span class="token comment">// Read display image</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ST7789_CMD_RDDSM</span> <span class="token expression"><span class="token number">0x0e</span> </span><span class="token comment">// Read display signal</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ST7789_CMD_RDDSDR</span> <span class="token expression"><span class="token number">0x0f</span> </span><span class="token comment">// Read display self-diagnostic result</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ST7789_CMD_SLPIN</span> <span class="token expression"><span class="token number">0x10</span> </span><span class="token comment">// Sleep in</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ST7789_CMD_SLPOUT</span> <span class="token expression"><span class="token number">0x11</span> </span><span class="token comment">// Sleep out</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ST7789_CMD_PTLON</span> <span class="token expression"><span class="token number">0x12</span> </span><span class="token comment">// Partial mode on</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ST7789_CMD_NORON</span> <span class="token expression"><span class="token number">0x13</span> </span><span class="token comment">// Partial off (Normal)</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ST7789_CMD_INVOFF</span> <span class="token expression"><span class="token number">0x20</span> </span><span class="token comment">// Display inversion off</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ST7789_CMD_INVON</span> <span class="token expression"><span class="token number">0x21</span> </span><span class="token comment">// Display inversion on</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ST7789_CMD_GAMSET</span> <span class="token expression"><span class="token number">0x26</span> </span><span class="token comment">// Gamma set</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ST7789_CMD_DISPOFF</span> <span class="token expression"><span class="token number">0x28</span> </span><span class="token comment">// Display off</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ST7789_CMD_DISPON</span> <span class="token expression"><span class="token number">0x29</span> </span><span class="token comment">// Display on</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ST7789_CMD_CASET</span> <span class="token expression"><span class="token number">0x2a</span> </span><span class="token comment">// Column address set</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ST7789_CMD_RASET</span> <span class="token expression"><span class="token number">0x2b</span> </span><span class="token comment">// Row address set</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ST7789_CMD_RAMWR</span> <span class="token expression"><span class="token number">0x2c</span> </span><span class="token comment">// Memory write</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ST7789_CMD_RAMRD</span> <span class="token expression"><span class="token number">0x2e</span> </span><span class="token comment">// Memory read</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ST7789_CMD_PTLAR</span> <span class="token expression"><span class="token number">0x30</span> </span><span class="token comment">// Partial start/end address set</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ST7789_CMD_VSCRDEF</span> <span class="token expression"><span class="token number">0x33</span> </span><span class="token comment">// Vertical scrolling definition</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ST7789_CMD_TEOFF</span> <span class="token expression"><span class="token number">0x34</span> </span><span class="token comment">// Tearing line effect off</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ST7789_CMD_TEON</span> <span class="token expression"><span class="token number">0x35</span> </span><span class="token comment">// Tearing line effect on</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ST7789_CMD_MADCTL</span> <span class="token expression"><span class="token number">0x36</span> </span><span class="token comment">// Memory data access control</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ST7789_CMD_VSCRSADD</span> <span class="token expression"><span class="token number">0x37</span> </span><span class="token comment">// Vertical address scrolling</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ST7789_CMD_IDMOFF</span> <span class="token expression"><span class="token number">0x38</span> </span><span class="token comment">// Idle mode off</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ST7789_CMD_IDMON</span> <span class="token expression"><span class="token number">0x39</span> </span><span class="token comment">// Idle mode on</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ST7789_CMD_COLMOD</span> <span class="token expression"><span class="token number">0x3a</span> </span><span class="token comment">// Interface pixel format</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ST7789_CMD_RAMWRC</span> <span class="token expression"><span class="token number">0x3c</span> </span><span class="token comment">// Memory write continue</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ST7789_CMD_RAMRDC</span> <span class="token expression"><span class="token number">0x3e</span> </span><span class="token comment">// Memory read continue</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ST7789_CMD_TESCAN</span> <span class="token expression"><span class="token number">0x44</span> </span><span class="token comment">// Set tear scanline</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ST7789_CMD_RDTESCAN</span> <span class="token expression"><span class="token number">0x45</span> </span><span class="token comment">// Get scanline</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ST7789_CMD_WRDISBV</span> <span class="token expression"><span class="token number">0x51</span> </span><span class="token comment">// Write display brightness</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ST7789_CMD_RDDISBV</span> <span class="token expression"><span class="token number">0x52</span> </span><span class="token comment">// Read display brightness value</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ST7789_CMD_WRCTRLD</span> <span class="token expression"><span class="token number">0x53</span> </span><span class="token comment">// Write CTRL display</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ST7789_CMD_RDCTRLD</span> <span class="token expression"><span class="token number">0x54</span> </span><span class="token comment">// Read CTRL value display</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ST7789_CMD_WRCACE</span> <span class="token expression"><span class="token number">0x55</span> </span><span class="token comment">// Write content adaptive brightness control and Color enhancemnet</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ST7789_CMD_RDCABC</span> <span class="token expression"><span class="token number">0x56</span> </span><span class="token comment">// Read content adaptive brightness control</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ST7789_CMD_WRCABCMB</span> <span class="token expression"><span class="token number">0x5e</span> </span><span class="token comment">// Write CABC minimum brightness</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ST7789_CMD_RDCABCMB</span> <span class="token expression"><span class="token number">0x5f</span> </span><span class="token comment">// Read CABC minimum brightness</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ST7789_CMD_RDABCSDR</span> <span class="token expression"><span class="token number">0x68</span> </span><span class="token comment">// Read Automatic Brightness Control Self-Diagnostic Result</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ST7789_CMD_RDID1</span> <span class="token expression"><span class="token number">0xda</span> </span><span class="token comment">// Read ID1</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ST7789_CMD_RDID2</span> <span class="token expression"><span class="token number">0xdb</span> </span><span class="token comment">// Read ID2</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ST7789_CMD_RDID3</span> <span class="token expression"><span class="token number">0xdc</span> </span><span class="token comment">// Read ID3</span></span>

<span class="token comment">// System Function Command Table 2</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ST7789_CMD_RAMCTRL</span> <span class="token expression"><span class="token number">0xb0</span> </span><span class="token comment">// RAM Control</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ST7789_CMD_RGBCTRL</span> <span class="token expression"><span class="token number">0xb1</span> </span><span class="token comment">// RGB Control</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ST7789_CMD_PORCTRL</span> <span class="token expression"><span class="token number">0xb2</span> </span><span class="token comment">// Porch control</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ST7789_CMD_FRCTRL1</span> <span class="token expression"><span class="token number">0xb3</span> </span><span class="token comment">// Frame Rate Control 1</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ST7789_CMD_GCTRL</span> <span class="token expression"><span class="token number">0xb7</span> </span><span class="token comment">// Gate control</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ST7789_CMD_DGMEN</span> <span class="token expression"><span class="token number">0xba</span> </span><span class="token comment">// Digital Gamma Enable</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ST7789_CMD_VCOMS</span> <span class="token expression"><span class="token number">0xbb</span> </span><span class="token comment">// VCOM Setting</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ST7789_CMD_LCMCTRL</span> <span class="token expression"><span class="token number">0xc0</span> </span><span class="token comment">// LCM Control</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ST7789_CMD_IDSET</span> <span class="token expression"><span class="token number">0xc1</span> </span><span class="token comment">// ID Setting</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ST7789_CMD_VDVVRHEN</span> <span class="token expression"><span class="token number">0xc2</span> </span><span class="token comment">// VDV and VRH Command enable</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ST7789_CMD_VRHS</span> <span class="token expression"><span class="token number">0xc3</span> </span><span class="token comment">// VRH Set</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ST7789_CMD_VDVSET</span> <span class="token expression"><span class="token number">0xc4</span> </span><span class="token comment">// VDV Setting</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ST7789_CMD_VCMOFSET</span> <span class="token expression"><span class="token number">0xc5</span> </span><span class="token comment">// VCOM Offset Set</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ST7789_CMD_FRCTR2</span> <span class="token expression"><span class="token number">0xc6</span> </span><span class="token comment">// FR Control 2</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ST7789_CMD_CABCCTRL</span> <span class="token expression"><span class="token number">0xc7</span> </span><span class="token comment">// CABC Control</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ST7789_CMD_REGSEL1</span> <span class="token expression"><span class="token number">0xc8</span> </span><span class="token comment">// Register value selection 1</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ST7789_CMD_REGSEL2</span> <span class="token expression"><span class="token number">0xca</span> </span><span class="token comment">// Register value selection 2</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ST7789_CMD_PWMFRSEL</span> <span class="token expression"><span class="token number">0xcc</span> </span><span class="token comment">// PWM Frequency Selection</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ST7789_CMD_PWCTRL1</span> <span class="token expression"><span class="token number">0xd0</span> </span><span class="token comment">// Power Control 1</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ST7789_CMD_VAPVANEN</span> <span class="token expression"><span class="token number">0xd2</span> </span><span class="token comment">// Enable VAP/VAN signal output</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ST7789_CMD_CMD2EN</span> <span class="token expression"><span class="token number">0xdf</span> </span><span class="token comment">// Command 2 Enable</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ST7789_CMD_PVGAMCTRL</span> <span class="token expression"><span class="token number">0xe0</span> </span><span class="token comment">// Positive Voltage Gamma Control</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ST7789_CMD_NVGAMCTRL</span> <span class="token expression"><span class="token number">0xe1</span> </span><span class="token comment">// Negative voltage Gamma Control</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ST7789_CMD_DGMLUTR</span> <span class="token expression"><span class="token number">0xe2</span> </span><span class="token comment">// Digital Gamma Look-up Table for Red</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ST7789_CMD_DGMLUTB</span> <span class="token expression"><span class="token number">0xe3</span> </span><span class="token comment">// Digital Gamma Look-up Table for Blue</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ST7789_CMD_GATECTRL</span> <span class="token expression"><span class="token number">0xe4</span> </span><span class="token comment">// Gate control</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ST7789_CMD_PWCTRL2</span> <span class="token expression"><span class="token number">0xe8</span> </span><span class="token comment">// Power Control 2</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ST7789_CMD_EQCTRL</span> <span class="token expression"><span class="token number">0xe9</span> </span><span class="token comment">// Equalize Time Control</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ST7789_CMD_PROMCTRL</span> <span class="token expression"><span class="token number">0xec</span> </span><span class="token comment">// Program Control</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ST7789_CMD_PROMEN</span> <span class="token expression"><span class="token number">0xfa</span> </span><span class="token comment">// Program Mode Enable</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ST7789_CMD_NVMSET</span> <span class="token expression"><span class="token number">0xfc</span> </span><span class="token comment">// NVM Setting</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ST7789_CMD_PROMACT</span> <span class="token expression"><span class="token number">0xfe</span> </span><span class="token comment">// Program Action</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ST7789_CMDLIST_END</span> <span class="token expression"><span class="token number">0xff</span> </span><span class="token comment">// End command (used for command list)</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">RED</span> <span class="token expression"><span class="token number">0xf800</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">GREEN</span> <span class="token expression"><span class="token number">0x07e0</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BLUE</span> <span class="token expression"><span class="token number">0x001f</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">WHITE</span> <span class="token expression"><span class="token number">0xffff</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BLACK</span> <span class="token expression"><span class="token number">0x0000</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">YELLOW</span> <span class="token expression"><span class="token number">0xFFE0</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">GRAY0</span> <span class="token expression"><span class="token number">0xEF7D</span> </span><span class="token comment">//灰色 0 3165 00110 001011 00101</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">GRAY1</span> <span class="token expression"><span class="token number">0x8410</span> </span><span class="token comment">//灰色 1 00000 000000 00000</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">GRAY2</span> <span class="token expression"><span class="token number">0x4208</span> </span><span class="token comment">//灰色 2 1111111111011111</span></span>

<span class="token comment">//#define LCD_SDA //PB15 // SPI 数据引脚</span>
<span class="token comment">//#define LCD_SCL //PB13 // SPI 时钟引脚</span>
<span class="token comment">//#define LCD_CS //PB12 // SPI 片选引脚</span>
<span class="token comment">//#define LCD_DC //PB11 // SPI 数据/命令引脚</span>
<span class="token comment">//#define LCD_RST //PB10 // 屏幕复位引脚 </span>
<span class="token comment">//#define LCD_BLK //PB1 // 背光控制引脚</span>

<span class="token comment">//液晶控制口置 1 操作语句宏定义</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">LCD_SDA_SET</span> <span class="token expression"><span class="token function">GPIO_SetBits</span><span class="token punctuation">(</span>GPIOB<span class="token punctuation">,</span> GPIO_Pin_15<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">LCD_SCL_SET</span> <span class="token expression"><span class="token function">GPIO_SetBits</span><span class="token punctuation">(</span>GPIOB<span class="token punctuation">,</span> GPIO_Pin_13<span class="token punctuation">)</span></span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">LCD_CS_SET</span> <span class="token expression"><span class="token function">GPIO_SetBits</span><span class="token punctuation">(</span>GPIOB<span class="token punctuation">,</span> GPIO_Pin_12<span class="token punctuation">)</span> </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">LCD_DC_SET</span> <span class="token expression"><span class="token function">GPIO_SetBits</span><span class="token punctuation">(</span>GPIOB<span class="token punctuation">,</span> GPIO_Pin_11<span class="token punctuation">)</span></span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">LCD_RST_SET</span> <span class="token expression"><span class="token function">GPIO_SetBits</span><span class="token punctuation">(</span>GPIOB<span class="token punctuation">,</span> GPIO_Pin_10<span class="token punctuation">)</span></span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">LCD_BLK_SET</span> <span class="token expression"><span class="token function">GPIO_SetBits</span><span class="token punctuation">(</span>GPIOB<span class="token punctuation">,</span> GPIO_Pin_1<span class="token punctuation">)</span> </span></span>

<span class="token comment">//液晶控制口置 0 操作语句宏定义</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">LCD_SDA_CLR</span> <span class="token expression"><span class="token function">GPIO_ResetBits</span><span class="token punctuation">(</span>GPIOB<span class="token punctuation">,</span> GPIO_Pin_15<span class="token punctuation">)</span> </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">LCD_SCL_CLR</span> <span class="token expression"><span class="token function">GPIO_ResetBits</span><span class="token punctuation">(</span>GPIOB<span class="token punctuation">,</span> GPIO_Pin_13<span class="token punctuation">)</span> </span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">LCD_CS_CLR</span> <span class="token expression"><span class="token function">GPIO_ResetBits</span><span class="token punctuation">(</span>GPIOB<span class="token punctuation">,</span> GPIO_Pin_12<span class="token punctuation">)</span> </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">LCD_DC_CLR</span> <span class="token expression"><span class="token function">GPIO_ResetBits</span><span class="token punctuation">(</span>GPIOB<span class="token punctuation">,</span> GPIO_Pin_11<span class="token punctuation">)</span> </span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">LCD_RST_CLR</span> <span class="token expression"><span class="token function">GPIO_ResetBits</span><span class="token punctuation">(</span>GPIOB<span class="token punctuation">,</span> GPIO_Pin_10<span class="token punctuation">)</span></span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">LCD_BLK_CLR</span> <span class="token expression"><span class="token function">GPIO_ResetBits</span><span class="token punctuation">(</span>GPIOB<span class="token punctuation">,</span> GPIO_Pin_1<span class="token punctuation">)</span></span></span>

<span class="token keyword">void</span> <span class="token function">LCD_GPIO_Init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">Lcd_Init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">Lcd_Test</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">Lcd_Full</span><span class="token punctuation">(</span><span class="token class-name">uint16_t</span> color<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">Lcd_Dma_Full</span><span class="token punctuation">(</span><span class="token class-name">uint16_t</span> color<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">// **ST7789_DRIVER_H**</span></span>

</code></pre>
<h2>
<a id="GPIOSPI_161">
</a>
GPIO 模拟 SPI
</h2>
<pre><code class="prism language-c"><span class="token comment">//液晶控制口置 1 操作语句宏定义</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">LCD_SDA_SET</span> <span class="token expression"><span class="token function">GPIO_SetBits</span><span class="token punctuation">(</span>GPIOB<span class="token punctuation">,</span> GPIO_Pin_15<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">LCD_SCL_SET</span> <span class="token expression"><span class="token function">GPIO_SetBits</span><span class="token punctuation">(</span>GPIOB<span class="token punctuation">,</span> GPIO_Pin_13<span class="token punctuation">)</span></span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">LCD_CS_SET</span> <span class="token expression"><span class="token function">GPIO_SetBits</span><span class="token punctuation">(</span>GPIOB<span class="token punctuation">,</span> GPIO_Pin_12<span class="token punctuation">)</span> </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">LCD_DC_SET</span> <span class="token expression"><span class="token function">GPIO_SetBits</span><span class="token punctuation">(</span>GPIOB<span class="token punctuation">,</span> GPIO_Pin_11<span class="token punctuation">)</span></span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">LCD_RST_SET</span> <span class="token expression"><span class="token function">GPIO_SetBits</span><span class="token punctuation">(</span>GPIOB<span class="token punctuation">,</span> GPIO_Pin_10<span class="token punctuation">)</span></span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">LCD_BLK_SET</span> <span class="token expression"><span class="token function">GPIO_SetBits</span><span class="token punctuation">(</span>GPIOB<span class="token punctuation">,</span> GPIO_Pin_1<span class="token punctuation">)</span> </span></span>

<span class="token comment">//液晶控制口置 0 操作语句宏定义</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">LCD_SDA_CLR</span> <span class="token expression"><span class="token function">GPIO_ResetBits</span><span class="token punctuation">(</span>GPIOB<span class="token punctuation">,</span> GPIO_Pin_15<span class="token punctuation">)</span> </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">LCD_SCL_CLR</span> <span class="token expression"><span class="token function">GPIO_ResetBits</span><span class="token punctuation">(</span>GPIOB<span class="token punctuation">,</span> GPIO_Pin_13<span class="token punctuation">)</span> </span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">LCD_CS_CLR</span> <span class="token expression"><span class="token function">GPIO_ResetBits</span><span class="token punctuation">(</span>GPIOB<span class="token punctuation">,</span> GPIO_Pin_12<span class="token punctuation">)</span> </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">LCD_DC_CLR</span> <span class="token expression"><span class="token function">GPIO_ResetBits</span><span class="token punctuation">(</span>GPIOB<span class="token punctuation">,</span> GPIO_Pin_11<span class="token punctuation">)</span> </span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">LCD_RST_CLR</span> <span class="token expression"><span class="token function">GPIO_ResetBits</span><span class="token punctuation">(</span>GPIOB<span class="token punctuation">,</span> GPIO_Pin_10<span class="token punctuation">)</span></span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">LCD_BLK_CLR</span> <span class="token expression"><span class="token function">GPIO_ResetBits</span><span class="token punctuation">(</span>GPIOB<span class="token punctuation">,</span> GPIO_Pin_1<span class="token punctuation">)</span></span></span>
</code></pre>
<pre><code class="prism language-c"><span class="token comment">//液晶 IO 初始化配置</span>
<span class="token keyword">void</span> <span class="token function">LCD_GPIO_Init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
GPIO_InitTypeDef GPIO_InitStructure<span class="token punctuation">;</span>

    <span class="token function">RCC_AHB1PeriphClockCmd</span><span class="token punctuation">(</span>RCC_AHB1Periph_GPIOB<span class="token punctuation">,</span> ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>

    GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Pin <span class="token operator">=</span>   GPIO_Pin_1 <span class="token operator">|</span> GPIO_Pin_10 <span class="token operator">|</span> GPIO_Pin_11 <span class="token operator">|</span> GPIO_Pin_12 <span class="token operator">|</span> GPIO_Pin_13<span class="token operator">|</span> GPIO_Pin_15<span class="token punctuation">;</span>
    GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Mode <span class="token operator">=</span> GPIO_Mode_OUT<span class="token punctuation">;</span>     <span class="token comment">//普通输出模式</span>
    GPIO_InitStructure<span class="token punctuation">.</span>GPIO_OType <span class="token operator">=</span> GPIO_OType_PP<span class="token punctuation">;</span>    <span class="token comment">//推挽输出</span>
    GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Speed <span class="token operator">=</span> GPIO_Speed_50MHz<span class="token punctuation">;</span><span class="token comment">//100MHz</span>
    GPIO_InitStructure<span class="token punctuation">.</span>GPIO_PuPd <span class="token operator">=</span> GPIO_PuPd_UP<span class="token punctuation">;</span>      <span class="token comment">//上拉</span>
    <span class="token function">GPIO_Init</span><span class="token punctuation">(</span>GPIOB<span class="token punctuation">,</span> <span class="token operator">&amp;</span>GPIO_InitStructure<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
<span class="token comment">//向 SPI 总线传输一个 8 位数据</span>
<span class="token keyword">void</span> <span class="token function">SPI_WriteData</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> Data<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
<span class="token class-name">uint8_t</span> i<span class="token punctuation">;</span>

    <span class="token keyword">for</span><span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">8</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>    <span class="token comment">// 295 ms 1 frame</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>Data<span class="token operator">&amp;</span><span class="token number">0x80</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            LCD_SDA_SET<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span>
            LCD_SDA_CLR<span class="token punctuation">;</span>

        LCD_SCL_CLR<span class="token punctuation">;</span>
        LCD_SCL_SET<span class="token punctuation">;</span>
        Data <span class="token operator">&lt;&lt;=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>

<span class="token comment">//向液晶屏写一个 8 位指令</span>
<span class="token keyword">void</span> <span class="token function">Lcd_WriteIndex</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> Index<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
<span class="token comment">//SPI 写命令时序开始</span>
LCD_CS_CLR<span class="token punctuation">;</span>
LCD_DC_CLR<span class="token punctuation">;</span>

    <span class="token function">SPI_WriteData</span><span class="token punctuation">(</span>Index<span class="token punctuation">)</span><span class="token punctuation">;</span>
    LCD_CS_SET<span class="token punctuation">;</span>

<span class="token punctuation">}</span>

<span class="token comment">//向液晶屏写一个 8 位数据</span>
<span class="token keyword">void</span> <span class="token function">Lcd_WriteData</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> Data<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
LCD_CS_CLR<span class="token punctuation">;</span>
LCD_DC_SET<span class="token punctuation">;</span>

    <span class="token function">SPI_WriteData</span><span class="token punctuation">(</span>Data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    LCD_CS_SET<span class="token punctuation">;</span>

<span class="token punctuation">}</span>
<span class="token comment">//向液晶屏写一个 16 位数据</span>
<span class="token keyword">void</span> <span class="token function">LCD_WriteData_16Bit</span><span class="token punctuation">(</span><span class="token class-name">uint16_t</span> Data<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
<span class="token comment">// LCD_CS_CLR;</span>
<span class="token comment">// LCD_DC_SET;</span>
<span class="token function">SPI_WriteData</span><span class="token punctuation">(</span>Data<span class="token operator">&gt;&gt;</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//写入高 8 位数据</span>
<span class="token function">SPI_WriteData</span><span class="token punctuation">(</span>Data<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//写入低 8 位数据</span>
<span class="token comment">// LCD_CS_SET;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">Lcd_WriteReg</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> Index<span class="token punctuation">,</span><span class="token class-name">uint8_t</span> Data<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
<span class="token function">Lcd_WriteIndex</span><span class="token punctuation">(</span>Index<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">Lcd_WriteData</span><span class="token punctuation">(</span>Data<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">Lcd_Reset</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
LCD_RST_CLR<span class="token punctuation">;</span><span class="token comment">//RST 引脚输出为低</span>
<span class="token function">delay_ms</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
LCD_RST_SET<span class="token punctuation">;</span><span class="token comment">//RST 引脚输出为高</span>
<span class="token function">delay_ms</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/**********************************\*\*\***********************************/</span>

<span class="token keyword">void</span> <span class="token function">Lcd_Init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
<span class="token function">LCD_GPIO_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    LCD_RST_CLR<span class="token punctuation">;</span>
    <span class="token function">delay_ms</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    LCD_RST_SET<span class="token punctuation">;</span>
    <span class="token comment">/********************************************************/</span>
    <span class="token function">delay_ms</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">Lcd_WriteIndex</span><span class="token punctuation">(</span>ST7789_CMD_SLPOUT<span class="token punctuation">)</span><span class="token punctuation">;</span> 	<span class="token comment">//Sleep Out</span>
    <span class="token function">delay_ms</span><span class="token punctuation">(</span><span class="token number">120</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//-----------------------ST7789V Frame rate setting-----------------//</span>
    <span class="token comment">//************************************************</span>
    <span class="token function">Lcd_WriteIndex</span><span class="token punctuation">(</span>ST7789_CMD_COLMOD<span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token comment">//65k mode</span>
    <span class="token function">Lcd_WriteData</span><span class="token punctuation">(</span><span class="token number">0x05</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">Lcd_WriteIndex</span><span class="token punctuation">(</span>ST7789_CMD_VCMOFSET<span class="token punctuation">)</span><span class="token punctuation">;</span> 	<span class="token comment">//VCOM</span>
    <span class="token function">Lcd_WriteData</span><span class="token punctuation">(</span><span class="token number">0x1A</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">Lcd_WriteIndex</span><span class="token punctuation">(</span>ST7789_CMD_MADCTL<span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token comment">// 屏幕显示方向设置</span>
    <span class="token function">Lcd_WriteData</span><span class="token punctuation">(</span><span class="token number">0x00</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//-------------ST7789V Frame rate setting-----------//</span>
    <span class="token function">Lcd_WriteIndex</span><span class="token punctuation">(</span>ST7789_CMD_PORCTRL<span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">//Porch Setting</span>
    <span class="token function">Lcd_WriteData</span><span class="token punctuation">(</span><span class="token number">0x05</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">Lcd_WriteData</span><span class="token punctuation">(</span><span class="token number">0x05</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">Lcd_WriteData</span><span class="token punctuation">(</span><span class="token number">0x00</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">Lcd_WriteData</span><span class="token punctuation">(</span><span class="token number">0x33</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">Lcd_WriteData</span><span class="token punctuation">(</span><span class="token number">0x33</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">Lcd_WriteIndex</span><span class="token punctuation">(</span>ST7789_CMD_GCTRL<span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">//Gate Control</span>
    <span class="token function">Lcd_WriteData</span><span class="token punctuation">(</span><span class="token number">0x05</span><span class="token punctuation">)</span><span class="token punctuation">;</span>			<span class="token comment">//12.2v   -10.43v</span>
    <span class="token comment">//--------------ST7789V Power setting---------------//</span>
    <span class="token function">Lcd_WriteIndex</span><span class="token punctuation">(</span>ST7789_CMD_VCOMS<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//VCOM</span>
    <span class="token function">Lcd_WriteData</span><span class="token punctuation">(</span><span class="token number">0x3F</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">Lcd_WriteIndex</span><span class="token punctuation">(</span>ST7789_CMD_LCMCTRL<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//Power control</span>
    <span class="token function">Lcd_WriteData</span><span class="token punctuation">(</span><span class="token number">0x2c</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">Lcd_WriteIndex</span><span class="token punctuation">(</span>ST7789_CMD_VDVVRHEN<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//VDV and VRH Command Enable</span>
    <span class="token function">Lcd_WriteData</span><span class="token punctuation">(</span><span class="token number">0x01</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">Lcd_WriteIndex</span><span class="token punctuation">(</span>ST7789_CMD_VRHS<span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">//VRH Set</span>
    <span class="token function">Lcd_WriteData</span><span class="token punctuation">(</span><span class="token number">0x0F</span><span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">//4.3+( vcom+vcom offset+vdv)</span>

    <span class="token function">Lcd_WriteIndex</span><span class="token punctuation">(</span>ST7789_CMD_VDVSET<span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">//VDV Set</span>
    <span class="token function">Lcd_WriteData</span><span class="token punctuation">(</span><span class="token number">0x20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>				<span class="token comment">//0v</span>

    <span class="token function">Lcd_WriteIndex</span><span class="token punctuation">(</span>ST7789_CMD_FRCTR2<span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">//Frame Rate Control in Normal Mode</span>
    <span class="token function">Lcd_WriteData</span><span class="token punctuation">(</span><span class="token number">0X01</span><span class="token punctuation">)</span><span class="token punctuation">;</span>			     <span class="token comment">//111Hz</span>

    <span class="token function">Lcd_WriteIndex</span><span class="token punctuation">(</span>ST7789_CMD_PWCTRL1<span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">//Power Control 1</span>
    <span class="token function">Lcd_WriteData</span><span class="token punctuation">(</span><span class="token number">0xa4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">Lcd_WriteData</span><span class="token punctuation">(</span><span class="token number">0xa1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">Lcd_WriteIndex</span><span class="token punctuation">(</span>ST7789_CMD_PWCTRL2<span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">//Power Control 1</span>
    <span class="token function">Lcd_WriteData</span><span class="token punctuation">(</span><span class="token number">0x03</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">Lcd_WriteIndex</span><span class="token punctuation">(</span>ST7789_CMD_EQCTRL<span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">//Equalize time control</span>
    <span class="token function">Lcd_WriteData</span><span class="token punctuation">(</span><span class="token number">0x09</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">Lcd_WriteData</span><span class="token punctuation">(</span><span class="token number">0x09</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">Lcd_WriteData</span><span class="token punctuation">(</span><span class="token number">0x08</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//---------------ST7789V gamma setting-------------//</span>
    <span class="token function">Lcd_WriteIndex</span><span class="token punctuation">(</span>ST7789_CMD_PVGAMCTRL<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//Set Gamma</span>
    <span class="token function">Lcd_WriteData</span><span class="token punctuation">(</span><span class="token number">0xD0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">Lcd_WriteData</span><span class="token punctuation">(</span><span class="token number">0x05</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">Lcd_WriteData</span><span class="token punctuation">(</span><span class="token number">0x09</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">Lcd_WriteData</span><span class="token punctuation">(</span><span class="token number">0x09</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">Lcd_WriteData</span><span class="token punctuation">(</span><span class="token number">0x08</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">Lcd_WriteData</span><span class="token punctuation">(</span><span class="token number">0x14</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">Lcd_WriteData</span><span class="token punctuation">(</span><span class="token number">0x28</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">Lcd_WriteData</span><span class="token punctuation">(</span><span class="token number">0x33</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">Lcd_WriteData</span><span class="token punctuation">(</span><span class="token number">0x3F</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">Lcd_WriteData</span><span class="token punctuation">(</span><span class="token number">0x07</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">Lcd_WriteData</span><span class="token punctuation">(</span><span class="token number">0x13</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">Lcd_WriteData</span><span class="token punctuation">(</span><span class="token number">0x14</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">Lcd_WriteData</span><span class="token punctuation">(</span><span class="token number">0x28</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">Lcd_WriteData</span><span class="token punctuation">(</span><span class="token number">0x30</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">Lcd_WriteIndex</span><span class="token punctuation">(</span>ST7789_CMD_NVGAMCTRL<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//Set Gamma</span>
    <span class="token function">Lcd_WriteData</span><span class="token punctuation">(</span><span class="token number">0xD0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">Lcd_WriteData</span><span class="token punctuation">(</span><span class="token number">0x05</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">Lcd_WriteData</span><span class="token punctuation">(</span><span class="token number">0x09</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">Lcd_WriteData</span><span class="token punctuation">(</span><span class="token number">0x09</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">Lcd_WriteData</span><span class="token punctuation">(</span><span class="token number">0x08</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">Lcd_WriteData</span><span class="token punctuation">(</span><span class="token number">0x03</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">Lcd_WriteData</span><span class="token punctuation">(</span><span class="token number">0x24</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">Lcd_WriteData</span><span class="token punctuation">(</span><span class="token number">0x32</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">Lcd_WriteData</span><span class="token punctuation">(</span><span class="token number">0x32</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">Lcd_WriteData</span><span class="token punctuation">(</span><span class="token number">0x3B</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">Lcd_WriteData</span><span class="token punctuation">(</span><span class="token number">0x14</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">Lcd_WriteData</span><span class="token punctuation">(</span><span class="token number">0x13</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">Lcd_WriteData</span><span class="token punctuation">(</span><span class="token number">0x28</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">Lcd_WriteData</span><span class="token punctuation">(</span><span class="token number">0x2F</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">Lcd_WriteIndex</span><span class="token punctuation">(</span>ST7789_CMD_INVON<span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">//反显</span>

    <span class="token function">Lcd_WriteIndex</span><span class="token punctuation">(</span>ST7789_CMD_DISPON<span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">//开启显示</span>

<span class="token punctuation">}</span>

<span class="token comment">/************************\*************************
函数名：LCD_Set_Region
功能：设置 lcd 显示区域，在此区域写点数据自动换行
入口参数：xy 起点和终点,Y_IncMode 表示先自增 y 再自增 x
返回值：无
************************\*************************/</span>
<span class="token keyword">void</span> <span class="token function">Lcd_SetRegion</span><span class="token punctuation">(</span><span class="token class-name">uint16_t</span> x_start<span class="token punctuation">,</span> <span class="token class-name">uint16_t</span> y_start<span class="token punctuation">,</span> <span class="token class-name">uint16_t</span> x_end<span class="token punctuation">,</span> <span class="token class-name">uint16_t</span> y_end<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
<span class="token function">Lcd_WriteIndex</span><span class="token punctuation">(</span><span class="token number">0x2a</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">Lcd_WriteData</span><span class="token punctuation">(</span><span class="token number">0x00</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">Lcd_WriteData</span><span class="token punctuation">(</span>x_start<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">Lcd_WriteData</span><span class="token punctuation">(</span><span class="token number">0x00</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">Lcd_WriteData</span><span class="token punctuation">(</span>x_end<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">Lcd_WriteIndex</span><span class="token punctuation">(</span><span class="token number">0x2b</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">Lcd_WriteData</span><span class="token punctuation">(</span><span class="token number">0x00</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">Lcd_WriteData</span><span class="token punctuation">(</span>y_start<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">Lcd_WriteData</span><span class="token punctuation">(</span>y_end<span class="token operator">&gt;&gt;</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">Lcd_WriteData</span><span class="token punctuation">(</span>y_end<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">Lcd_WriteIndex</span><span class="token punctuation">(</span><span class="token number">0x2c</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//开始写入GRAM</span>

<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">Lcd_Full</span><span class="token punctuation">(</span><span class="token class-name">uint16_t</span> color<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
<span class="token class-name">uint16_t</span> row<span class="token punctuation">,</span>column<span class="token punctuation">;</span>

    <span class="token function">Lcd_SetRegion</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> ST7789_LCD_WIDTH<span class="token punctuation">,</span> ST7789_LCD_HEIGHT<span class="token punctuation">)</span><span class="token punctuation">;</span>

    LCD_CS_CLR<span class="token punctuation">;</span>
    LCD_DC_SET<span class="token punctuation">;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span>row <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>row <span class="token operator">&lt;</span> ST7789_LCD_WIDTH<span class="token punctuation">;</span> row<span class="token operator">++</span><span class="token punctuation">)</span>             <span class="token comment">//ROW loop</span>
    <span class="token punctuation">{<!-- --></span>
    	<span class="token keyword">for</span><span class="token punctuation">(</span>column <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>column <span class="token operator">&lt;</span> ST7789_LCD_HEIGHT<span class="token punctuation">;</span> column<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token comment">//column loop</span>
    	<span class="token punctuation">{<!-- --></span>
    		<span class="token function">LCD_WriteData_16Bit</span><span class="token punctuation">(</span>color<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 180ms 1 frame</span>
    	<span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    LCD_CS_SET<span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre>
<h2>
<a id="SPI_409">
</a>
硬件 SPI 外设
</h2>
<pre><code class="prism language-c">SPI_InitTypeDef SPI_InitStructure<span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">SPI2_Init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
GPIO_InitTypeDef GPIO_InitStructure<span class="token punctuation">;</span>

    <span class="token comment">//SPI2的时钟来源是APB1 42MHz</span>
    <span class="token function">RCC_AHB1PeriphClockCmd</span><span class="token punctuation">(</span>RCC_AHB1Periph_GPIOB<span class="token punctuation">,</span> ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//使能GPIOB、SPI2时钟</span>
    <span class="token function">RCC_APB1PeriphClockCmd</span><span class="token punctuation">(</span>RCC_APB1Periph_SPI2<span class="token punctuation">,</span> ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//使能GPIOB、SPI2时钟</span>

    <span class="token comment">//PB13--SCL ,PB15--SDI初始化设置,</span>
    GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Pin <span class="token operator">=</span> GPIO_Pin_13 <span class="token operator">|</span> GPIO_Pin_15<span class="token punctuation">;</span><span class="token comment">//PB13,PB15复用功能输出</span>
    GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Mode <span class="token operator">=</span> GPIO_Mode_AF<span class="token punctuation">;</span><span class="token comment">//复用功能</span>
    GPIO_InitStructure<span class="token punctuation">.</span>GPIO_OType <span class="token operator">=</span> GPIO_OType_PP<span class="token punctuation">;</span><span class="token comment">//推挽输出</span>
    GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Speed <span class="token operator">=</span> GPIO_Speed_50MHz<span class="token punctuation">;</span><span class="token comment">//100MHz</span>
    GPIO_InitStructure<span class="token punctuation">.</span>GPIO_PuPd <span class="token operator">=</span> GPIO_PuPd_UP<span class="token punctuation">;</span><span class="token comment">//上拉</span>
    <span class="token function">GPIO_Init</span><span class="token punctuation">(</span>GPIOB<span class="token punctuation">,</span> <span class="token operator">&amp;</span>GPIO_InitStructure<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//初始化</span>

    <span class="token function">GPIO_PinAFConfig</span><span class="token punctuation">(</span>GPIOB<span class="token punctuation">,</span>GPIO_PinSource13<span class="token punctuation">,</span>GPIO_AF_SPI2<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//PB13复用为 SPI2</span>

    <span class="token function">GPIO_PinAFConfig</span><span class="token punctuation">(</span>GPIOB<span class="token punctuation">,</span>GPIO_PinSource15<span class="token punctuation">,</span>GPIO_AF_SPI2<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//PB15复用为 SPI2</span>

    <span class="token comment">//这里只针对SPI口初始化</span>
    <span class="token function">RCC_APB1PeriphResetCmd</span><span class="token punctuation">(</span>RCC_APB1Periph_SPI2<span class="token punctuation">,</span>ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//复位SPI2</span>
    <span class="token function">RCC_APB1PeriphResetCmd</span><span class="token punctuation">(</span>RCC_APB1Periph_SPI2<span class="token punctuation">,</span>DISABLE<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//停止复位SPI2</span>

    SPI_InitStructure<span class="token punctuation">.</span>SPI_Direction <span class="token operator">=</span> SPI_Direction_2Lines_FullDuplex<span class="token punctuation">;</span>  <span class="token comment">//设置SPI单向或者双向的数据模式:SPI设置为双线双向全双工</span>
    SPI_InitStructure<span class="token punctuation">.</span>SPI_Mode <span class="token operator">=</span> SPI_Mode_Master<span class="token punctuation">;</span>		<span class="token comment">//设置SPI工作模式:设置为主SPI</span>
    SPI_InitStructure<span class="token punctuation">.</span>SPI_DataSize <span class="token operator">=</span> SPI_DataSize_8b<span class="token punctuation">;</span>		<span class="token comment">//设置SPI的数据大小:SPI发送接收8位帧结构</span>
    SPI_InitStructure<span class="token punctuation">.</span>SPI_CPOL <span class="token operator">=</span> SPI_CPOL_High<span class="token punctuation">;</span>		<span class="token comment">//串行同步时钟的空闲状态为低电平</span>
    SPI_InitStructure<span class="token punctuation">.</span>SPI_CPHA <span class="token operator">=</span> SPI_CPHA_2Edge<span class="token punctuation">;</span>	<span class="token comment">//串行同步时钟的第一个跳变沿（上升或下降）数据被采样</span>
    SPI_InitStructure<span class="token punctuation">.</span>SPI_NSS <span class="token operator">=</span> SPI_NSS_Soft<span class="token punctuation">;</span>		<span class="token comment">//NSS信号由硬件（NSS管脚）还是软件（使用SSI位）管理:内部NSS信号有SSI位控制</span>
    SPI_InitStructure<span class="token punctuation">.</span>SPI_BaudRatePrescaler <span class="token operator">=</span> SPI_BaudRatePrescaler_2<span class="token punctuation">;</span>		<span class="token comment">//定义波特率预分频的值:波特率预分频值为</span>
    SPI_InitStructure<span class="token punctuation">.</span>SPI_FirstBit <span class="token operator">=</span> SPI_FirstBit_MSB<span class="token punctuation">;</span>	<span class="token comment">//指定数据传输从MSB位还是LSB位开始:数据传输从MSB位开始</span>
    SPI_InitStructure<span class="token punctuation">.</span>SPI_CRCPolynomial <span class="token operator">=</span> <span class="token number">7</span><span class="token punctuation">;</span>	<span class="token comment">//CRC值计算的多项式</span>
    <span class="token function">SPI_Init</span><span class="token punctuation">(</span>SPI2<span class="token punctuation">,</span> <span class="token operator">&amp;</span>SPI_InitStructure<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//根据SPI_InitStruct中指定的参数初始化外设SPIx寄存器</span>

    <span class="token function">SPI_Cmd</span><span class="token punctuation">(</span>SPI2<span class="token punctuation">,</span> ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//使能SPI外设</span>
    <span class="token function">SPI2_ReadWriteByte</span><span class="token punctuation">(</span><span class="token number">0xff</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//启动传输</span>

<span class="token punctuation">}</span>

<span class="token comment">//液晶 IO 初始化配置</span>
<span class="token keyword">void</span> <span class="token function">LCD_Hal_Spi_Init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
GPIO_InitTypeDef GPIO_InitStructure<span class="token punctuation">;</span>

    <span class="token function">RCC_AHB1PeriphClockCmd</span><span class="token punctuation">(</span> RCC_AHB1Periph_GPIOB <span class="token operator">|</span> RCC_AHB1Periph_GPIOC<span class="token punctuation">,</span>ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>

    GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Pin <span class="token operator">=</span>   GPIO_Pin_10  <span class="token operator">|</span> GPIO_Pin_11 <span class="token operator">|</span> GPIO_Pin_12 <span class="token operator">|</span> GPIO_Pin_14<span class="token punctuation">;</span>
    GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Mode <span class="token operator">=</span> GPIO_Mode_OUT<span class="token punctuation">;</span><span class="token comment">//普通输出模式</span>
    GPIO_InitStructure<span class="token punctuation">.</span>GPIO_OType <span class="token operator">=</span> GPIO_OType_PP<span class="token punctuation">;</span><span class="token comment">//推挽输出</span>
    GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Speed <span class="token operator">=</span> GPIO_Speed_100MHz<span class="token punctuation">;</span><span class="token comment">//100MHz</span>
    GPIO_InitStructure<span class="token punctuation">.</span>GPIO_PuPd <span class="token operator">=</span> GPIO_PuPd_UP<span class="token punctuation">;</span><span class="token comment">//上拉</span>
    <span class="token function">GPIO_Init</span><span class="token punctuation">(</span>GPIOB<span class="token punctuation">,</span> <span class="token operator">&amp;</span>GPIO_InitStructure<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">GPIO_SetBits</span><span class="token punctuation">(</span>GPIOB<span class="token punctuation">,</span>GPIO_Pin_14<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//MISO引脚输出为高</span>

    <span class="token function">SPI2_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//初始化硬件SPI2</span>

<span class="token punctuation">}</span>

<span class="token comment">//SPIx 读写一个字节</span>
<span class="token comment">//TxData:要写入的字节</span>
<span class="token comment">//返回值:读取到的字节</span>
<span class="token class-name">uint8_t</span> <span class="token function">SPI2_ReadWriteByte</span><span class="token punctuation">(</span><span class="token class-name">uint16_t</span> TxData<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
<span class="token comment">// uint8_t retry=0;</span>
<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token function">SPI_I2S_GetFlagStatus</span><span class="token punctuation">(</span>SPI2<span class="token punctuation">,</span> SPI_I2S_FLAG_TXE<span class="token punctuation">)</span> <span class="token operator">==</span> RESET<span class="token punctuation">)</span> <span class="token comment">//检查指定的 SPI 标志位设置与否:发送缓存空标志位</span>
<span class="token punctuation">{<!-- --></span>
<span class="token comment">// retry++;</span>
<span class="token comment">// if(retry&gt;200)return 0;</span>
<span class="token punctuation">}</span>
<span class="token function">SPI_I2S_SendData</span><span class="token punctuation">(</span>SPI2<span class="token punctuation">,</span> TxData<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//通过外设 SPIx 发送一个数据</span>
<span class="token comment">// retry=0;</span>

    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token function">SPI_I2S_GetFlagStatus</span><span class="token punctuation">(</span>SPI2<span class="token punctuation">,</span> SPI_I2S_FLAG_RXNE<span class="token punctuation">)</span> <span class="token operator">==</span> RESET<span class="token punctuation">)</span><span class="token comment">//检查指定的SPI标志位设置与否:接受缓存非空标志位</span>
    <span class="token punctuation">{<!-- --></span>

<span class="token comment">// retry++;</span>
<span class="token comment">// if(retry&gt;200)return 0;</span>
<span class="token punctuation">}</span>
<span class="token keyword">return</span> <span class="token function">SPI_I2S_ReceiveData</span><span class="token punctuation">(</span>SPI2<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//返回通过 SPIx 最近接收的数据</span>
<span class="token punctuation">}</span>
</code></pre>
<pre><code class="prism language-c"><span class="token comment">//向 SPI 总线传输一个 8 位数据</span>
<span class="token keyword">void</span> <span class="token function">SPI_WriteData</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> Data<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
<span class="token function">SPI2_ReadWriteByte</span><span class="token punctuation">(</span>Data<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">//向液晶屏写一个 8 位指令</span>
<span class="token keyword">void</span> <span class="token function">Lcd_WriteIndex</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> Index<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
<span class="token comment">//SPI 写命令时序开始</span>
LCD_CS_CLR<span class="token punctuation">;</span>
LCD_DC_CLR<span class="token punctuation">;</span>

    <span class="token function">SPI_WriteData</span><span class="token punctuation">(</span>Index<span class="token punctuation">)</span><span class="token punctuation">;</span>
    LCD_CS_SET<span class="token punctuation">;</span>

<span class="token punctuation">}</span>

<span class="token comment">//向液晶屏写一个 8 位数据</span>
<span class="token keyword">void</span> <span class="token function">Lcd_WriteData</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> Data<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
LCD_CS_CLR<span class="token punctuation">;</span>
LCD_DC_SET<span class="token punctuation">;</span>

    <span class="token function">SPI_WriteData</span><span class="token punctuation">(</span>Data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    LCD_CS_SET<span class="token punctuation">;</span>

<span class="token punctuation">}</span>
<span class="token comment">//向液晶屏写一个 16 位数据</span>
<span class="token keyword">void</span> <span class="token function">LCD_WriteData_16Bit</span><span class="token punctuation">(</span><span class="token class-name">uint16_t</span> Data<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
<span class="token comment">// LCD_CS_CLR;</span>
<span class="token comment">// LCD_DC_SET;</span>
<span class="token function">SPI_WriteData</span><span class="token punctuation">(</span>Data<span class="token operator">&gt;&gt;</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//写入高 8 位数据</span>
<span class="token function">SPI_WriteData</span><span class="token punctuation">(</span>Data<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//写入低 8 位数据</span>
<span class="token comment">// LCD_CS_SET;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">Lcd_WriteReg</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> Index<span class="token punctuation">,</span><span class="token class-name">uint8_t</span> Data<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
<span class="token function">Lcd_WriteIndex</span><span class="token punctuation">(</span>Index<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">Lcd_WriteData</span><span class="token punctuation">(</span>Data<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">Lcd_Reset</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
LCD_RST_CLR<span class="token punctuation">;</span><span class="token comment">//RST 引脚输出为低</span>
<span class="token function">delay_ms</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
LCD_RST_SET<span class="token punctuation">;</span><span class="token comment">//RST 引脚输出为高</span>
<span class="token function">delay_ms</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/**********************************\*\*\***********************************/</span>

<span class="token keyword">void</span> <span class="token function">Lcd_Init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
<span class="token function">LCD_Hal_Spi_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">Lcd_Reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">/********************************************************/</span>
    <span class="token function">delay_ms</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">Lcd_WriteIndex</span><span class="token punctuation">(</span>ST7789_CMD_SLPOUT<span class="token punctuation">)</span><span class="token punctuation">;</span> 	<span class="token comment">//Sleep Out</span>
    <span class="token function">delay_ms</span><span class="token punctuation">(</span><span class="token number">120</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//-----------------------ST7789V Frame rate setting-----------------//</span>
    <span class="token comment">//************************************************</span>
    <span class="token function">Lcd_WriteIndex</span><span class="token punctuation">(</span>ST7789_CMD_COLMOD<span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token comment">//65k mode</span>
    <span class="token function">Lcd_WriteData</span><span class="token punctuation">(</span><span class="token number">0x05</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">Lcd_WriteIndex</span><span class="token punctuation">(</span>ST7789_CMD_VCMOFSET<span class="token punctuation">)</span><span class="token punctuation">;</span> 	<span class="token comment">//VCOM</span>
    <span class="token function">Lcd_WriteData</span><span class="token punctuation">(</span><span class="token number">0x1A</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">Lcd_WriteIndex</span><span class="token punctuation">(</span>ST7789_CMD_MADCTL<span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token comment">// 屏幕显示方向设置</span>
    <span class="token function">Lcd_WriteData</span><span class="token punctuation">(</span><span class="token number">0x00</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//-------------ST7789V Frame rate setting-----------//</span>
    <span class="token function">Lcd_WriteIndex</span><span class="token punctuation">(</span>ST7789_CMD_PORCTRL<span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">//Porch Setting</span>
    <span class="token function">Lcd_WriteData</span><span class="token punctuation">(</span><span class="token number">0x05</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">Lcd_WriteData</span><span class="token punctuation">(</span><span class="token number">0x05</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">Lcd_WriteData</span><span class="token punctuation">(</span><span class="token number">0x00</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">Lcd_WriteData</span><span class="token punctuation">(</span><span class="token number">0x33</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">Lcd_WriteData</span><span class="token punctuation">(</span><span class="token number">0x33</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">Lcd_WriteIndex</span><span class="token punctuation">(</span>ST7789_CMD_GCTRL<span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">//Gate Control</span>
    <span class="token function">Lcd_WriteData</span><span class="token punctuation">(</span><span class="token number">0x05</span><span class="token punctuation">)</span><span class="token punctuation">;</span>			<span class="token comment">//12.2v   -10.43v</span>
    <span class="token comment">//--------------ST7789V Power setting---------------//</span>
    <span class="token function">Lcd_WriteIndex</span><span class="token punctuation">(</span>ST7789_CMD_VCOMS<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//VCOM</span>
    <span class="token function">Lcd_WriteData</span><span class="token punctuation">(</span><span class="token number">0x3F</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">Lcd_WriteIndex</span><span class="token punctuation">(</span>ST7789_CMD_LCMCTRL<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//Power control</span>
    <span class="token function">Lcd_WriteData</span><span class="token punctuation">(</span><span class="token number">0x2c</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">Lcd_WriteIndex</span><span class="token punctuation">(</span>ST7789_CMD_VDVVRHEN<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//VDV and VRH Command Enable</span>
    <span class="token function">Lcd_WriteData</span><span class="token punctuation">(</span><span class="token number">0x01</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">Lcd_WriteIndex</span><span class="token punctuation">(</span>ST7789_CMD_VRHS<span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">//VRH Set</span>
    <span class="token function">Lcd_WriteData</span><span class="token punctuation">(</span><span class="token number">0x0F</span><span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">//4.3+( vcom+vcom offset+vdv)</span>

    <span class="token function">Lcd_WriteIndex</span><span class="token punctuation">(</span>ST7789_CMD_VDVSET<span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">//VDV Set</span>
    <span class="token function">Lcd_WriteData</span><span class="token punctuation">(</span><span class="token number">0x20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>				<span class="token comment">//0v</span>

    <span class="token function">Lcd_WriteIndex</span><span class="token punctuation">(</span>ST7789_CMD_FRCTR2<span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">//Frame Rate Control in Normal Mode</span>
    <span class="token function">Lcd_WriteData</span><span class="token punctuation">(</span><span class="token number">0X01</span><span class="token punctuation">)</span><span class="token punctuation">;</span>			     <span class="token comment">//111Hz</span>

    <span class="token function">Lcd_WriteIndex</span><span class="token punctuation">(</span>ST7789_CMD_PWCTRL1<span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">//Power Control 1</span>
    <span class="token function">Lcd_WriteData</span><span class="token punctuation">(</span><span class="token number">0xa4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">Lcd_WriteData</span><span class="token punctuation">(</span><span class="token number">0xa1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">Lcd_WriteIndex</span><span class="token punctuation">(</span>ST7789_CMD_PWCTRL2<span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">//Power Control 1</span>
    <span class="token function">Lcd_WriteData</span><span class="token punctuation">(</span><span class="token number">0x03</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">Lcd_WriteIndex</span><span class="token punctuation">(</span>ST7789_CMD_EQCTRL<span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">//Equalize time control</span>
    <span class="token function">Lcd_WriteData</span><span class="token punctuation">(</span><span class="token number">0x09</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">Lcd_WriteData</span><span class="token punctuation">(</span><span class="token number">0x09</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">Lcd_WriteData</span><span class="token punctuation">(</span><span class="token number">0x08</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//---------------ST7789V gamma setting-------------//</span>
    <span class="token function">Lcd_WriteIndex</span><span class="token punctuation">(</span>ST7789_CMD_PVGAMCTRL<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//Set Gamma</span>
    <span class="token function">Lcd_WriteData</span><span class="token punctuation">(</span><span class="token number">0xD0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">Lcd_WriteData</span><span class="token punctuation">(</span><span class="token number">0x05</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">Lcd_WriteData</span><span class="token punctuation">(</span><span class="token number">0x09</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">Lcd_WriteData</span><span class="token punctuation">(</span><span class="token number">0x09</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">Lcd_WriteData</span><span class="token punctuation">(</span><span class="token number">0x08</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">Lcd_WriteData</span><span class="token punctuation">(</span><span class="token number">0x14</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">Lcd_WriteData</span><span class="token punctuation">(</span><span class="token number">0x28</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">Lcd_WriteData</span><span class="token punctuation">(</span><span class="token number">0x33</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">Lcd_WriteData</span><span class="token punctuation">(</span><span class="token number">0x3F</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">Lcd_WriteData</span><span class="token punctuation">(</span><span class="token number">0x07</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">Lcd_WriteData</span><span class="token punctuation">(</span><span class="token number">0x13</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">Lcd_WriteData</span><span class="token punctuation">(</span><span class="token number">0x14</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">Lcd_WriteData</span><span class="token punctuation">(</span><span class="token number">0x28</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">Lcd_WriteData</span><span class="token punctuation">(</span><span class="token number">0x30</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">Lcd_WriteIndex</span><span class="token punctuation">(</span>ST7789_CMD_NVGAMCTRL<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//Set Gamma</span>
    <span class="token function">Lcd_WriteData</span><span class="token punctuation">(</span><span class="token number">0xD0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">Lcd_WriteData</span><span class="token punctuation">(</span><span class="token number">0x05</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">Lcd_WriteData</span><span class="token punctuation">(</span><span class="token number">0x09</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">Lcd_WriteData</span><span class="token punctuation">(</span><span class="token number">0x09</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">Lcd_WriteData</span><span class="token punctuation">(</span><span class="token number">0x08</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">Lcd_WriteData</span><span class="token punctuation">(</span><span class="token number">0x03</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">Lcd_WriteData</span><span class="token punctuation">(</span><span class="token number">0x24</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">Lcd_WriteData</span><span class="token punctuation">(</span><span class="token number">0x32</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">Lcd_WriteData</span><span class="token punctuation">(</span><span class="token number">0x32</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">Lcd_WriteData</span><span class="token punctuation">(</span><span class="token number">0x3B</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">Lcd_WriteData</span><span class="token punctuation">(</span><span class="token number">0x14</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">Lcd_WriteData</span><span class="token punctuation">(</span><span class="token number">0x13</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">Lcd_WriteData</span><span class="token punctuation">(</span><span class="token number">0x28</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">Lcd_WriteData</span><span class="token punctuation">(</span><span class="token number">0x2F</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">Lcd_WriteIndex</span><span class="token punctuation">(</span>ST7789_CMD_INVON<span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">//反显</span>

    <span class="token function">Lcd_WriteIndex</span><span class="token punctuation">(</span>ST7789_CMD_DISPON<span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">//开启显示</span>

<span class="token punctuation">}</span>

<span class="token comment">/************************\*************************
函数名：LCD_Set_Region
功能：设置 lcd 显示区域，在此区域写点数据自动换行
入口参数：xy 起点和终点,Y_IncMode 表示先自增 y 再自增 x
返回值：无
************************\*************************/</span>
<span class="token keyword">void</span> <span class="token function">Lcd_SetRegion</span><span class="token punctuation">(</span><span class="token class-name">uint16_t</span> x_start<span class="token punctuation">,</span> <span class="token class-name">uint16_t</span> y_start<span class="token punctuation">,</span> <span class="token class-name">uint16_t</span> x_end<span class="token punctuation">,</span> <span class="token class-name">uint16_t</span> y_end<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
<span class="token function">Lcd_WriteIndex</span><span class="token punctuation">(</span><span class="token number">0x2a</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">Lcd_WriteData</span><span class="token punctuation">(</span><span class="token number">0x00</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">Lcd_WriteData</span><span class="token punctuation">(</span>x_start<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">Lcd_WriteData</span><span class="token punctuation">(</span><span class="token number">0x00</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">Lcd_WriteData</span><span class="token punctuation">(</span>x_end<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">Lcd_WriteIndex</span><span class="token punctuation">(</span><span class="token number">0x2b</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">Lcd_WriteData</span><span class="token punctuation">(</span><span class="token number">0x00</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">Lcd_WriteData</span><span class="token punctuation">(</span>y_start<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">Lcd_WriteData</span><span class="token punctuation">(</span>y_end<span class="token operator">&gt;&gt;</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">Lcd_WriteData</span><span class="token punctuation">(</span>y_end<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">Lcd_WriteIndex</span><span class="token punctuation">(</span><span class="token number">0x2c</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//开始写入GRAM</span>

<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">Lcd_Full</span><span class="token punctuation">(</span><span class="token class-name">uint16_t</span> color<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
<span class="token class-name">uint16_t</span> row<span class="token punctuation">,</span>column<span class="token punctuation">;</span>

    <span class="token function">Lcd_SetRegion</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> ST7789_LCD_WIDTH<span class="token punctuation">,</span> ST7789_LCD_HEIGHT<span class="token punctuation">)</span><span class="token punctuation">;</span>

    LCD_CS_CLR<span class="token punctuation">;</span>
    LCD_DC_SET<span class="token punctuation">;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span>row <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>row <span class="token operator">&lt;</span> ST7789_LCD_WIDTH<span class="token punctuation">;</span> row<span class="token operator">++</span><span class="token punctuation">)</span>             <span class="token comment">//ROW loop</span>
    <span class="token punctuation">{<!-- --></span>
    	<span class="token keyword">for</span><span class="token punctuation">(</span>column <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>column <span class="token operator">&lt;</span> ST7789_LCD_HEIGHT<span class="token punctuation">;</span> column<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token comment">//column loop</span>
    	<span class="token punctuation">{<!-- --></span>
    		<span class="token function">LCD_WriteData_16Bit</span><span class="token punctuation">(</span>color<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 180ms 1 frame</span>
    	<span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    LCD_CS_SET<span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre>
<h2>
<a id="DMASPI_687">
</a>
DMA+硬件 SPI 外设
</h2>
<p>
<img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/b4b23e047193caa36236facba6d18878.png">
<br/>
我使用的是 SPI2，所以对应的 DMA 信息如上表。
</img>
</p>
<pre><code class="prism language-c"><span class="token keyword">void</span> <span class="token function">DMA_Config</span><span class="token punctuation">(</span>u32 TX_Buff<span class="token punctuation">,</span>u32 SENDBUFF_SIZE<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
<span class="token comment">// 中断结构体</span>
NVIC_InitTypeDef NVIC_InitStructure<span class="token punctuation">;</span>
<span class="token comment">// DMA 结构体</span>
DMA_InitTypeDef DMA_InitStructure<span class="token punctuation">;</span>
<span class="token comment">/_ 使能 DMA 时钟 _/</span>
<span class="token function">RCC_AHB1PeriphClockCmd</span><span class="token punctuation">(</span>RCC_AHB1Periph_DMA1<span class="token punctuation">,</span> ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/_ 复位初始化 DMA 数据流 _/</span>  
 <span class="token function">DMA_DeInit</span><span class="token punctuation">(</span>DMA1_Stream4<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/_ 确保 DMA 数据流复位完成 _/</span>  
 <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token function">DMA_GetCmdStatus</span><span class="token punctuation">(</span>DMA1_Stream4<span class="token punctuation">)</span> <span class="token operator">!=</span> DISABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/* 配置 DMA Stream */</span>
    <span class="token comment">/* 通道0，数据流4 */</span>
    DMA_InitStructure<span class="token punctuation">.</span>DMA_Channel <span class="token operator">=</span> DMA_Channel_0<span class="token punctuation">;</span>
    <span class="token comment">/* 外设地址 */</span>
    DMA_InitStructure<span class="token punctuation">.</span>DMA_PeripheralBaseAddr <span class="token operator">=</span> <span class="token punctuation">(</span>u32<span class="token punctuation">)</span><span class="token operator">&amp;</span>SPI2<span class="token operator">-&gt;</span>DR<span class="token punctuation">;</span>
    <span class="token comment">/* 内存地址(要传输的变量的指针) ,DMA存储器0地址*/</span>
    DMA_InitStructure<span class="token punctuation">.</span>DMA_Memory0BaseAddr <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">)</span>TX_Buff<span class="token punctuation">;</span>
    <span class="token comment">/* 方向：存储器到外设 */</span>
    DMA_InitStructure<span class="token punctuation">.</span>DMA_DIR <span class="token operator">=</span> DMA_DIR_MemoryToPeripheral<span class="token punctuation">;</span>
    <span class="token comment">/* 数据传输量 ,可设置为0， 实际发送时会重新设置*/</span>
    DMA_InitStructure<span class="token punctuation">.</span>DMA_BufferSize <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">)</span>SENDBUFF_SIZE<span class="token punctuation">;</span>
    <span class="token comment">/* 外设非增量模式 */</span>
    DMA_InitStructure<span class="token punctuation">.</span>DMA_PeripheralInc <span class="token operator">=</span> DMA_PeripheralInc_Disable<span class="token punctuation">;</span>
    <span class="token comment">/* 存储器增量模式 */</span>
    DMA_InitStructure<span class="token punctuation">.</span>DMA_MemoryInc <span class="token operator">=</span> DMA_MemoryInc_Enable<span class="token punctuation">;</span>
    <span class="token comment">/* 外设数据长度:16位 */</span>
    DMA_InitStructure<span class="token punctuation">.</span>DMA_PeripheralDataSize <span class="token operator">=</span> DMA_PeripheralDataSize_HalfWord<span class="token punctuation">;</span>
    <span class="token comment">/* 内存数据长度:16位 */</span>
    DMA_InitStructure<span class="token punctuation">.</span>DMA_MemoryDataSize <span class="token operator">=</span> DMA_MemoryDataSize_HalfWord<span class="token punctuation">;</span>
    <span class="token comment">/* DMA模式：正常模式 */</span>
    DMA_InitStructure<span class="token punctuation">.</span>DMA_Mode <span class="token operator">=</span> DMA_Mode_Normal<span class="token punctuation">;</span>
    <span class="token comment">/* 优先级：高 */</span>
    DMA_InitStructure<span class="token punctuation">.</span>DMA_Priority <span class="token operator">=</span> DMA_Priority_High<span class="token punctuation">;</span>
    <span class="token comment">/* 禁用FIFO */</span>
    DMA_InitStructure<span class="token punctuation">.</span>DMA_FIFOMode <span class="token operator">=</span> DMA_FIFOMode_Disable<span class="token punctuation">;</span>
    DMA_InitStructure<span class="token punctuation">.</span>DMA_FIFOThreshold <span class="token operator">=</span> DMA_FIFOThreshold_1QuarterFull<span class="token punctuation">;</span>
    <span class="token comment">/* 外设突发单次传输 */</span>
    DMA_InitStructure<span class="token punctuation">.</span>DMA_MemoryBurst <span class="token operator">=</span> DMA_MemoryBurst_Single<span class="token punctuation">;</span>
    <span class="token comment">/* 存储器突发单次传输 */</span>
    DMA_InitStructure<span class="token punctuation">.</span>DMA_PeripheralBurst <span class="token operator">=</span> DMA_PeripheralBurst_Single<span class="token punctuation">;</span>

    <span class="token comment">/* 初始化DMA Stream */</span>
    <span class="token function">DMA_Init</span><span class="token punctuation">(</span>DMA1_Stream4<span class="token punctuation">,</span> <span class="token operator">&amp;</span>DMA_InitStructure<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">/* 开启传输完成中断  */</span>
    <span class="token function">DMA_ITConfig</span><span class="token punctuation">(</span>DMA1_Stream4<span class="token punctuation">,</span>DMA_IT_TC<span class="token punctuation">,</span>ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 中断初始化 </span>
    <span class="token comment">/* DMA发送中断源 */</span>
    NVIC_InitStructure<span class="token punctuation">.</span>NVIC_IRQChannel <span class="token operator">=</span> DMA1_Stream4_IRQn<span class="token punctuation">;</span>
    <span class="token comment">/* 抢断优先级 */</span>
    NVIC_InitStructure<span class="token punctuation">.</span>NVIC_IRQChannelPreemptionPriority <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token comment">/* 响应优先级 */</span>
    NVIC_InitStructure<span class="token punctuation">.</span>NVIC_IRQChannelSubPriority <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token comment">/* 使能外部中断通道 */</span>
    NVIC_InitStructure<span class="token punctuation">.</span>NVIC_IRQChannelCmd <span class="token operator">=</span> ENABLE<span class="token punctuation">;</span>
    <span class="token comment">/* 配置NVIC */</span>
    <span class="token function">NVIC_Init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>NVIC_InitStructure<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
<span class="token keyword">static</span> <span class="token class-name">uint8_t</span> sendFlg <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">DMA1_Stream4_IRQHandler</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
<span class="token comment">// DMA 发送完成</span>
<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">DMA_GetITStatus</span><span class="token punctuation">(</span>DMA1_Stream4<span class="token punctuation">,</span> DMA_IT_TCIF4<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
<span class="token comment">// 清除 DMA 发送完成标志</span>
<span class="token function">DMA_ClearITPendingBit</span><span class="token punctuation">(</span>DMA1_Stream4<span class="token punctuation">,</span> DMA_IT_TCIF4<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 片选拉高，数据发送完毕 </span>
LCD_CS_SET<span class="token punctuation">;</span>
sendFlg <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">DMA_Write_buf</span><span class="token punctuation">(</span><span class="token class-name">uint32_t</span> SizeLen<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>  
 <span class="token comment">// 关闭发送 DMA </span>
<span class="token function">DMA_Cmd</span><span class="token punctuation">(</span>DMA1_Stream4<span class="token punctuation">,</span> DISABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 设置发送的数据量 </span>
<span class="token function">DMA_SetCurrDataCounter</span><span class="token punctuation">(</span>DMA1_Stream4<span class="token punctuation">,</span> SizeLen<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 清空数据</span>
SPI2<span class="token operator">-&gt;</span>DR<span class="token punctuation">;</span>
<span class="token comment">// 擦除 DMA 标志位 </span>
<span class="token function">DMA_ClearFlag</span><span class="token punctuation">(</span>DMA1_Stream4<span class="token punctuation">,</span> DMA_IT_TCIF4<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 片选拉低,接收数据</span>
LCD_CS_CLR<span class="token punctuation">;</span>
LCD_DC_SET<span class="token punctuation">;</span>
<span class="token comment">// 开启发送 DMA</span>
<span class="token function">DMA_Cmd</span><span class="token punctuation">(</span>DMA1_Stream4<span class="token punctuation">,</span> ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token operator">!</span>sendFlg<span class="token punctuation">)</span><span class="token punctuation">;</span>
sendFlg <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SEND_BUF_SIZE</span> <span class="token expression"><span class="token number">480</span><span class="token operator">\*</span><span class="token number">20</span></span></span>

<span class="token class-name">uint16_t</span> SendBuff<span class="token punctuation">[</span>SEND_BUF_SIZE<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">//发送数据缓冲区</span>
</code></pre>
<pre><code class="prism language-c"><span class="token comment">// 单颜色填满屏幕</span>
<span class="token keyword">void</span> <span class="token function">Lcd_Dma_Full</span><span class="token punctuation">(</span><span class="token class-name">uint16_t</span> color<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
<span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">for</span><span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span> <span class="token punctuation">;</span> i <span class="token operator">&lt;</span> SEND_BUF_SIZE<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
SendBuff<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> color<span class="token punctuation">;</span> <span class="token comment">// 缓存区不够，分段来凑</span>
<span class="token punctuation">}</span>
<span class="token keyword">for</span><span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">16</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
<span class="token function">SPI_I2S_DMACmd</span><span class="token punctuation">(</span>SPI2<span class="token punctuation">,</span> SPI_I2S_DMAReq_Tx<span class="token punctuation">,</span> ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 60ms 1 frame</span>
<span class="token function">DMA_Write_buf</span><span class="token punctuation">(</span>SEND_BUF_SIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<pre><code class="prism language-c"><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
<span class="token function">NVIC_PriorityGroupConfig</span><span class="token punctuation">(</span>NVIC_PriorityGroup_2<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//设置系统中断优先级分组 2</span>
<span class="token function">delay_init</span><span class="token punctuation">(</span><span class="token number">168</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//初始化延时函数</span>
<span class="token function">uart_init</span><span class="token punctuation">(</span><span class="token number">115200</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//初始化串口波特率为 115200</span>

    <span class="token function">LED_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>					  <span class="token comment">//初始化LED</span>

    <span class="token function">Lcd_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">Lcd_Full</span><span class="token punctuation">(</span>RED<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">delay_ms</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">uint16_t</span> num <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token number">1</span></span></span>
    	<span class="token comment">//num+=1;</span>
    	<span class="token function">Lcd_Dma_Full</span><span class="token punctuation">(</span>num<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// LED_ON;</span>
<span class="token comment">//delay_ms(10);</span>
<span class="token comment">// </span>
<span class="token comment">// Lcd_Dma_Full(WHITE);</span>
<span class="token comment">// LED_OFF;</span>
<span class="token comment"> delay_ms(50);</span>
<span class="token comment">// </span>
<span class="token comment">// Lcd_Dma_Full(BLUE);</span>
<span class="token comment">// LED_ON;</span>
<span class="token comment"> delay_ms(50);</span>
<span class="token comment">// </span>
<span class="token comment">// Lcd_Dma_Full(WHITE);</span>
<span class="token comment">// LED_OFF;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span>
<span class="token function">Lcd_Full</span><span class="token punctuation">(</span>GREEN<span class="token punctuation">)</span><span class="token punctuation">;</span>
LED_ON<span class="token punctuation">;</span>
<span class="token comment">// delay_ms(50);</span>
<span class="token function">Lcd_Full</span><span class="token punctuation">(</span>WHITE<span class="token punctuation">)</span><span class="token punctuation">;</span>
LED_OFF<span class="token punctuation">;</span>
<span class="token comment">// delay_ms(50);</span>
<span class="token function">Lcd_Full</span><span class="token punctuation">(</span>BLUE<span class="token punctuation">)</span><span class="token punctuation">;</span>
LED_ON<span class="token punctuation">;</span>
<span class="token comment">// delay_ms(50);</span>
<span class="token function">Lcd_Full</span><span class="token punctuation">(</span>WHITE<span class="token punctuation">)</span><span class="token punctuation">;</span>
LED_OFF<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
<span class="token comment">// delay_ms(50);</span>
<span class="token comment">// printf("Test \r\n");;</span>
<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre>
<h2>
<a id="_871">
</a>
总结
</h2>
<p>
分辨率：240\*320
<br/>
颜色：RGB565
</p>
<table>
<thead>
<tr>
<th>
方式
</th>
<th>
一帧耗时
</th>
<th>
帧率
</th>
</tr>
</thead>
<tbody>
<tr>
<td>
GPIO 模拟 SPI
</td>
<td>
220ms
</td>
<td>
4.5 fps
</td>
</tr>
<tr>
<td>
硬件 SPI
</td>
<td>
188ms
</td>
<td>
5.3 fps
</td>
</tr>
<tr>
<td>
DMA+硬件 SPI
</td>
<td>
60ms
</td>
<td>
16.6 fps
</td>
</tr>
</tbody>
</table>

   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f62:6c6f672e6373646e2e6e65742f71715f32383837373132352f:61727469636c652f64657461696c732f313331373732313837" class_="artid" style="display:none">
 </p>
</div>
