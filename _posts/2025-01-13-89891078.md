---
layout: post
title: "微信小程序-云开发云调用API没有权限no-permission问题"
date: 2025-01-13 16:59:19 +0800
description: "今天在学习微信小程序云开发中的在云函数中使用云调用api templateMessage.send "
keywords: "function has no permission to call this api"
categories: ['微信小程序']
tags: ['微信小程序', '云开发', '云函数']
artid: "89891078"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=89891078
    alt: "微信小程序-云开发云调用API没有权限no-permission问题"
render_with_liquid: false
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     微信小程序-云开发云调用API没有权限(no permission)问题
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <p>
     今天在学习微信小程序云开发中的在云函数中使用云调用api
     <code>
      templateMessage.send
     </code>
     时，在开发环境中运行报错：function has no permission to call this API
     <br/>
     如下图：
     <br/>
     <img alt="" src="https://i-blog.csdnimg.cn/blog_migrate/1608a231b170401006e15d940ff5749e.png">
      <br/>
      查找总结原因大概有两点：
     </img>
    </p>
    <ol>
     <li>
      云函数所在目录缺少个权限声明文件
      <br/>
      config.json
     </li>
    </ol>
    <pre><code>{
  "permissions": {
    "openapi": ["templateMessage.send"]
  }
}
</code></pre>
    <ol start="2">
     <li>
      将微信开发工具升级到 v1.02.1904090 版本以上后，重新上传部署云函数
     </li>
    </ol>
    <p>
     解决如上两个问题后，运行正确
     <br/>
     <img alt="" src="https://i-blog.csdnimg.cn/blog_migrate/352c948660c4e1eb76685fc1e4374366.png"/>
    </p>
    <h3>
     <a id="_19">
     </a>
     另外
    </h3>
    <p>
     在这过程中遇到另外一个问题，在云函数中调用
     <code>
      templateMessage.send
     </code>
     时，
     <br/>
     云函数如下：
    </p>
    <pre><code>// 云函数入口文件
const cloud = require('wx-server-sdk')
cloud.init()
exports.main = async (event, context) =&gt; {
  try {
    let formId = event.formId;
    const result = await cloud.openapi.templateMessage.send({
      touser: cloud.getWXContext().OPENID, // 通过 getWXContext 获取 OPENID
      page: 'index',
      data: {
        keyword1: {
          value: '氢能总部'
        },
        keyword2: {
          value: '小明'
        },
        keyword3: {
          value: '18:00'
        },
        keyword4: {
          value: '云浮思劳氢能小镇'
        }
      },
      templateId: 'MYlxdani6r7yU0ldtZqadxxxxxxxxxxxxx',
      formId: formId,
      emphasisKeyword: 'keyword1.DATA'
    })
    // result 结构
    // { errCode: 0, errMsg: 'openapi.templateMessage.send:ok' }
    return result
  } catch (err) {
    // 错误处理
    // err.errCode !== 0
    throw err
  }
}
</code></pre>
    <p>
     在开发工具中报错：openapi.templateMessage.send:fail invalid form id hint
     <br/>
     如下图：
     <br/>
     <img alt="" src="https://i-blog.csdnimg.cn/blog_migrate/1d32f2748ca49b01675923591426cd5b.png"/>
    </p>
    <p>
     经查找原因为：
     <br/>
     在开发工具中支行时，
     <code>
      e.detail.formId
     </code>
     的值为
     <code>
      the formId is a mock one
     </code>
     <br/>
     这个值需要在真机调试中才会正常出现，点击真机调试，并在手机上再次点击这个功能按钮，果然打印了正常的 formId。使用开发工具中的"真机调试"运行成功。
    </p>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f626c6f:672e6373646e2e6e65742f73696e61745f3331343635363039:2f61727469636c652f64657461696c732f3839383931303738" class_="artid" style="display:none">
 </p>
</div>


