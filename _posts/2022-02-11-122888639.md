---
layout: post
title: "Docker网络与容器之间通信原理"
date: 2022-02-11 22:11:30 +0800
description: "1、namespace扩展知识：https://www.jianshu.com/p/b2fdf18a"
keywords: "Docker,命名空间,桥接网络"
categories: ['Docker']
tags: ['网络', '容器', 'Docker']
artid: "122888639"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=122888639
    alt: "Docker网络与容器之间通信原理"
render_with_liquid: false
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     Docker网络与容器之间通信原理
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <h3>
     <a id="1namespace_0">
     </a>
     1、namespace
    </h3>
    <p>
     扩展知识：
     <br/>
     https://www.jianshu.com/p/b2fdf18a88ed
    </p>
    <h4>
     <a id="_4">
     </a>
     实战：打通两个命名空间的网络，模拟两个容器通信原理
    </h4>
    <pre><code class="prism language-php">查看命名空间列表
ip netns <span class="token keyword">list</span>
新增一个网络命名空间<span class="token punctuation">(</span>名称test1<span class="token punctuation">)</span>
ip netns add  test1
删除网络命名空间test1
ip netns delete test1
查看本机<span class="token keyword">namespace</span>默认是down的状态
ip netns exec test1 ip a
变为up状态，显示为unknown
ip netns exec test1 ip link set dev lo up
ip netns exec test1 ip a
</code></pre>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/01c7fa8d6f5c750eb9ec53dffc1e8e35.png">
      <br/>
      1）先创建一对veth虚拟网络设备veth-test1和veth-test2
     </img>
    </p>
    <pre><code class="prism language-php">创建并查看link
ip link add veth<span class="token operator">-</span>test1 type veth peer name veth<span class="token operator">-</span>test2
ip link 或者 ip addr
</code></pre>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/624e79f1f01ac8c69d69cb40a0c82b33.png"/>
    </p>
    <ol start="2">
     <li>
      把veth-test1设置到test1命名空间，把veth-test2设置到test2命名空间：
     </li>
    </ol>
    <pre><code class="prism language-php">添加veth<span class="token operator">-</span>test1到test1的<span class="token keyword">namespace</span>
<span class="token package">ip</span> link set veth<span class="token operator">-</span>test1 netns test1
ip netns exec test1 ip a
添加并查看veth<span class="token operator">-</span>test2
ip link set veth<span class="token operator">-</span>test2 netns test2
ip netns exec test2 ip a
</code></pre>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/333c54159d4f707e350ed369f4fac2b4.png">
      <br/>
      3）给两个主机分别配置ip(进入命名空间启动网卡然后给网卡配置ip)，然后互ping
     </img>
    </p>
    <pre><code class="prism language-php">ip netns exec test1 ip link set veth<span class="token operator">-</span>test1 up

ip netns exec test2 ip link set veth<span class="token operator">-</span>test2 up

ip netns exec test1 ip a add <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.1</span><span class="token operator">/</span><span class="token number">24</span> dev veth<span class="token operator">-</span>test1

ip netns exec test2 ip a add <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.2</span><span class="token operator">/</span><span class="token number">24</span> dev veth<span class="token operator">-</span>test2
<span class="token comment"># 然后互ping</span>
ip netns exec test1 ping <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.2</span>
ip netns exec test2 ping <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.1</span>

</code></pre>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/63840cbb0af921279449c6ccf6776ad1.png">
      <br/>
      <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/8be589bab7f2d652c648949051854974.png"/>
     </img>
    </p>
    <h3>
     <a id="2bridge_56">
     </a>
     2、bridge网络（桥接网络）
    </h3>
    <h4>
     <a id="_57">
     </a>
     实战演练：
    </h4>
    <p>
     test1与test2通过docker0访问宿主机然后访问的百度外网；
     <br/>
     test1、test2与docker在同一网段内是互通的
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/4f3592eaf4092dc377bed5d7c3a6b18c.png"/>
    </p>
    <p>
     1、新建3个容器
     <br/>
     docker run -d --name test1 busybox /bin/sh -c “while true;do sleep 3600;done”
     <br/>
     docker run -d --name test2 busybox /bin/sh -c “while true;do sleep 3600;done”
     <br/>
     docker run -d --name test3 busybox /bin/sh -c “while true;do sleep 3600;done”
    </p>
    <p>
     2、可以看到容器test1和本机的网卡有veth对，test2与test3也是如此，通过虚拟出的网卡与veth一一对应建立通信
     <br/>
     docker exec test1 ip a
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/f01e0a67a25820bbce9100598a7b7aca.png"/>
    </p>
    <p>
     3、查看本机网卡，docker0下这个veth与docker容器中的test1网卡一一对应
     <br/>
     ip addr
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/185ce14121014f8c7a86f6478586487a.png"/>
    </p>
    <p>
     4、安装brctl查看交接网络
     <br/>
     yum -y install bridge-utils
    </p>
    <p>
     5、查看本机的veth，查看本机网卡，docker0下有这3个veth（veth40000c8、veth7c8618c、veth825d419）
     <br/>
     brctl show
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/2946c7d302b756206754568e49f4739c.png"/>
    </p>
    <h3>
     <a id="3_84">
     </a>
     3、容器通信
    </h3>
    <p>
     解决不同ip网段不同之间的通信
     <br/>
     1、首先启动一个容器test5
     <br/>
     docker run -d --name test5 busybox /bin/sh -c “while true;do sleep 3600;done”
    </p>
    <p>
     2、再创建一个有—link的容器，谁link谁就能ping通谁
     <br/>
     docker run -d --name test6 --link test5 busybox /bin/sh -c “while true;do sleep 3600;done”
    </p>
    <p>
     3、此时，可以用test6直接访问test5，类似于访问主机名，但是test5是单独创建的，所以test5容器内是无法平通test6的
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/42f443b7f5f2637f592f0c505a421c30.png"/>
    </p>
    <h3>
     <a id="4_96">
     </a>
     4、端口映射
    </h3>
    <h4>
     <a id="nginx_97">
     </a>
     实战运行一个nginx并对外提供访问
    </h4>
    <p>
     1.运行一个nginx容器
     <br/>
     docker run --name web -d nginx
    </p>
    <p>
     2.查看桥接网络状态
     <br/>
     docker network inspect bridge
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/4118197bde6504fa59ef4507f4d3aedc.png"/>
    </p>
    <p>
     3.容器内可以访问，容器外访问不到
     <br/>
     ping 172.17.0.7
     <br/>
     telnet 172.17.0.7 80
     <br/>
     curl http://172.17.0.7
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/622b8ddd390501865e29d8dad0937214.png"/>
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/8a9eb4b37b354d44d1392df1ea355b82.png"/>
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/5d882b788ab39b1a045441fbd8065886.png"/>
    </p>
    <p>
     4.停止并删除容器
     <br/>
     docker stop web
     <br/>
     docker stop web
    </p>
    <p>
     5.重新创建容器，并指定端口映射
     <br/>
     docker run --name web -d -p 80:80 nginx
    </p>
    <p>
     6.外界可以访问了
     <br/>
     http://192.168.56.10/
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/5f78b8fb7370798c9fc995ba762c482e.png"/>
    </p>
    <h3>
     <a id="5nonehost_127">
     </a>
     5、网络的none和host
    </h3>
    <p>
     查看docker所有网络
     <br/>
     docker network ls
    </p>
    <p>
     <strong>
      none网络：应用场景是安全性极高的情况，应用并不多
     </strong>
     <br/>
     创建新的容器，使用none网络
     <br/>
     docker run -d --name test7 --network none busybox /bin/sh -c “while true;do sleep 3600;done”
    </p>
    <p>
     查看none网络状态
     <br/>
     docker network inspect none
    </p>
    <p>
     外界访问不了也无法查看该容器ip，只有进去，127.0.0.1可以访问
     <br/>
     ip netns exec test7 a
     <br/>
     docker exec -it test7 /bin/sh
     <br/>
     ip a
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/f5fcc0b42ffcabefa48f7ea9d3f78505.png"/>
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/e6e98b156e0dcecfa2398ca521fe15eb.png"/>
    </p>
    <p>
     <strong>
      host网络，也就是复制并使用宿主机网络：
     </strong>
     <br/>
     创建新的容器，使用host网络
     <br/>
     docker run -d --name test8 --network host busybox /bin/sh -c “while true;do sleep 3600;done”
    </p>
    <p>
     查看host网络状态
     <br/>
     docker network inspect host
    </p>
    <p>
     进入容器，查看网络，发现容器外宿主机网络一致
     <br/>
     ip netns exec test8 a
     <br/>
     docker exec -it test8 /bin/sh
     <br/>
     ip a
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/b2b260d4f1ad7ed3ebe85cb57b0c66ee.png"/>
    </p>
    <h3>
     <a id="6_159">
     </a>
     6、多容器部署和应用
    </h3>
    <h4>
     <a id="_160">
     </a>
     实例
    </h4>
    <p>
     运行redis容器
     <br/>
     docker run -d --name redis redis
    </p>
    <p>
     编写app.py，做web服务，
    </p>
    <pre><code class="prism language-php">$ cat app<span class="token operator">.</span>py 
from flask import Flask
from redis import Redis
import os
import socket

app<span class="token operator">=</span><span class="token function">Flask</span><span class="token punctuation">(</span>__name__<span class="token punctuation">)</span>
redis<span class="token operator">=</span><span class="token function">Redis</span><span class="token punctuation">(</span>host<span class="token operator">=</span>os<span class="token operator">.</span>environ<span class="token operator">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'REDIS_HOST'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'127.0.0.1'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>port<span class="token operator">=</span><span class="token number">6379</span><span class="token punctuation">)</span>

@app<span class="token operator">.</span><span class="token function">route</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/'</span><span class="token punctuation">)</span>
def <span class="token function">hello</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token class-name return-type">redis</span><span class="token operator">.</span><span class="token function">incr</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'hits'</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token string single-quoted-string">'hello docker! count %s and hostname is %s. \n'</span><span class="token operator">%</span><span class="token punctuation">(</span>redis<span class="token operator">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'hits'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>socket<span class="token operator">.</span><span class="token function">gethostname</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string double-quoted-string">"__main__"</span><span class="token punctuation">:</span>
        app<span class="token operator">.</span><span class="token function">run</span><span class="token punctuation">(</span>host<span class="token operator">=</span><span class="token string double-quoted-string">"0.0.0.0"</span><span class="token punctuation">,</span>port<span class="token operator">=</span><span class="token number">5000</span><span class="token punctuation">,</span>debug<span class="token operator">=</span><span class="token constant boolean">True</span><span class="token punctuation">)</span>
</code></pre>
    <p>
     编写Dockerfile
    </p>
    <pre><code class="prism language-php">$ vi Dockerfile 

<span class="token constant">FROM</span> <span class="token argument-name">python</span><span class="token punctuation">:</span><span class="token number">2.7</span>
<span class="token constant">LABEL</span> maintaner<span class="token operator">=</span><span class="token string double-quoted-string">"1019213039@qq.com"</span>
<span class="token constant">COPY</span> <span class="token operator">.</span> <span class="token operator">/</span>app
<span class="token constant">WORKDIR</span> <span class="token operator">/</span>app
<span class="token constant">RUN</span> pip install flask redis
<span class="token constant">EXPOSE</span> <span class="token number">5000</span>
<span class="token constant">CMD</span> <span class="token punctuation">[</span><span class="token string double-quoted-string">"python"</span><span class="token punctuation">,</span><span class="token string double-quoted-string">"app.py"</span><span class="token punctuation">]</span>
</code></pre>
    <p>
     构建redis镜像
     <br/>
     docker build -t liuyuanshan/flask-redis .
    </p>
    <p>
     运行容器，并设置环境变量REDIS_HOST，设置flask-redis 去link redis
     <br/>
     docker run -d -p 5000:5000 --link redis --name flask-redis -e REDIS_HOST=redis liuyuanshan/flask-redis
    </p>
    <p>
     进入容器并查看环境变量
     <br/>
     docker exec -it redis /bin/bash
     <br/>
     env
    </p>
    <p>
     访问：
     <br/>
     http://192.168.56.10:5000
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/9a3900829d83186f3761e238102341e5.png"/>
    </p>
    <p>
     7、多机器多容器通信
    </p>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f626c6f672e:6373646e2e6e65742f77656978696e5f33393231383436342f:61727469636c652f64657461696c732f313232383838363339" class_="artid" style="display:none">
 </p>
</div>


