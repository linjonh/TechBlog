---
layout: post
title: "WebRTC实现简单音视频通话能力"
date: 2024-01-04 17:22:18 +0800
description: "文章浏览阅读1.2k次，点赞19次，流：一个流可以包含几个轨道，推流：把采集阶段封包好的音视频数据流"
keywords: "webrtc sdk"
categories: ['技术教程专栏']
tags: ['视频通话', '实时音视频', 'Webrtc', 'Web', 'Rtc']
artid: "135392015"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=135392015
    alt: "WebRTC实现简单音视频通话能力"
render_with_liquid: false
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     WebRTC实现简单音视频通话能力
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <h3>
     <a id="1_WebRTC_0">
     </a>
     1 WebRTC音视频通话功能简介
    </h3>
    <p>
     本文介绍如何基于WebRTC快速实现一个简单的实时音视频通话。
    </p>
    <p>
     在开始之前，您可以先了解一些实时音视频推拉流相关的基础概念：
    </p>
    <ul>
     <li>
      流：一组按指定编码格式封装的音视频数据内容。一个流可以包含几个轨道，比如视频和音频轨道。
     </li>
     <li>
      推流：把采集阶段封包好的音视频数据流推送到 ZEGO 实时音视频云的过程。
     </li>
     <li>
      拉流：从 ZEGO 实时音视频云将已有音视频数据流拉取播放的过程。
     </li>
     <li>
      房间：是 ZEGO 提供的音视频空间服务，用于组织用户群，同一房间内的用户可以互相收发实时音视频及消息。
      <ol>
       <li>
        用户需要先登录某个房间，才能进行音视频推流、拉流操作。
       </li>
       <li>
        用户只能收到自己所在房间内的相关消息（用户进出、音视频流变化等）。
       </li>
      </ol>
     </li>
    </ul>
    <p>
     更多相关概念可参考即构官网关于音视频SDK的介绍
     <a href="https://doc-zh.zego.im/article/5390?source=csdn&amp;article18" rel="nofollow">
      术语说明
     </a>
     。
    </p>
    <h3>
     <a id="2_WebRTC_15">
     </a>
     2 实现WebRTC视频通话的前提条件
    </h3>
    <p>
     在实现基本的WebRTC实时音视频功能之前，请确保：
    </p>
    <ul>
     <li>
      已在项目中集成 ZEGO Express SDK，详情请参考
      <a href="https://doc-zh.zego.im/article/199?source=csdn&amp;article18" rel="nofollow">
       快速开始 - 集成
      </a>
      。
     </li>
     <li>
      已在
      <a href="https://console.zego.im?source=csdn&amp;article18" rel="nofollow">
       ZEGO 控制台
      </a>
      创建项目，申请有效的 AppID 和 ServerSecret，详情请参考
      <a href="https://doc-zh.zego.im/article/12107?source=csdn&amp;article18" rel="nofollow">
       控制台 - 项目管理
      </a>
      中的“项目信息”。
     </li>
    </ul>
    <h3>
     <a id="3_WebRTC_22">
     </a>
     3 WebRTC音视频通话示例代码
    </h3>
    <p>
     我们提供了一个实现了WebRTC音视频通话基本流程的完整示例 HTML 文件，可作为WebRTC开发过程中的参考。
    </p>
    <pre><code class="prism language-html"><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>UTF-8<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>Zego Express Video Call<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!-- 此处需要改成正确的 SDK 版本号 --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>ZegoExpressWebRTC-x.x.x.js<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>text/css<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token style"><span class="token language-css">
        <span class="token selector">h1,
        h4</span> <span class="token punctuation">{<!-- --></span>
            <span class="token property">text-align</span><span class="token punctuation">:</span> center<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token selector">.video-wrapper</span> <span class="token punctuation">{<!-- --></span>
            <span class="token property">width</span><span class="token punctuation">:</span> 610px<span class="token punctuation">;</span>
            <span class="token property">margin</span><span class="token punctuation">:</span> 0 auto<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token selector">.video-wrapper h4</span> <span class="token punctuation">{<!-- --></span>
            <span class="token property">width</span><span class="token punctuation">:</span> 300px<span class="token punctuation">;</span>
            <span class="token property">display</span><span class="token punctuation">:</span> inline-block<span class="token punctuation">;</span>
            <span class="token property">position</span><span class="token punctuation">:</span> relative<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token selector">#remote-video, #local-video</span> <span class="token punctuation">{<!-- --></span>
            <span class="token property">width</span><span class="token punctuation">:</span> 300px<span class="token punctuation">;</span>
            <span class="token property">height</span><span class="token punctuation">:</span> 270px<span class="token punctuation">;</span>
            <span class="token property">display</span><span class="token punctuation">:</span> inline-block<span class="token punctuation">;</span>
            <span class="token property">position</span><span class="token punctuation">:</span> relative<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token selector">.video-wrapper video</span> <span class="token punctuation">{<!-- --></span>
            <span class="token property">height</span><span class="token punctuation">:</span> auto<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">&gt;</span></span>
        Zego RTC Video Call
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>video-wrapper<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h4</span><span class="token punctuation">&gt;</span></span>Local video<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h4</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h4</span><span class="token punctuation">&gt;</span></span>Remote video<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h4</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>local-video<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>remote-video<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
        <span class="token comment">// 文档中的 js 示例代码可粘贴至此处</span>
        <span class="token comment">// 项目唯一标识 AppID，Number 类型，请从 ZEGO 控制台获取</span>
        <span class="token keyword">let</span> appID <span class="token operator">=</span> <span class="token number">0</span>
        <span class="token comment">// 接入服务器地址 Server，String 类型，请从 ZEGO 控制台获取（获取方式请参考上文“前提条件”）</span>
        <span class="token keyword">let</span> server <span class="token operator">=</span> <span class="token string">""</span>

        <span class="token comment">// 初始化实例</span>
        <span class="token keyword">const</span> zg <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ZegoExpressEngine</span><span class="token punctuation">(</span>appID<span class="token punctuation">,</span> server<span class="token punctuation">)</span><span class="token punctuation">;</span>
        zg<span class="token punctuation">.</span><span class="token function">setDebugVerbose</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span>
        <span class="token comment">// 房间状态更新回调</span>
        <span class="token comment">// 此处在登录房间成功后，立即进行推流。在实现具体业务时，您可选择其他时机进行推流，只要保证当前房间连接状态是连接成功的即可。</span>
        <span class="token comment">// 房间状态更新回调</span>
        zg<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'roomStateChanged'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">roomID<span class="token punctuation">,</span> reason<span class="token punctuation">,</span> errorCode<span class="token punctuation">,</span> extendedData</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>reason <span class="token operator">==</span> <span class="token string">'LOGINED'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"与房间连接成功，只有当房间状态是连接成功时，才能进行推流、拉流等操作。"</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>

        zg<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'roomUserUpdate'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">roomID<span class="token punctuation">,</span> updateType<span class="token punctuation">,</span> userList</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 其他用户进出房间的通知</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        zg<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'roomStreamUpdate'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">roomID<span class="token punctuation">,</span> updateType<span class="token punctuation">,</span> streamList<span class="token punctuation">,</span> extendedData</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 房间内其他用户音视频流变化的通知</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>updateType <span class="token operator">==</span> <span class="token string">'ADD'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// 流新增，开始拉流</span>
                <span class="token comment">// 此处演示拉取流新增的列表中第一条流的音视频</span>
                <span class="token keyword">const</span> streamID <span class="token operator">=</span> streamList<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>streamID<span class="token punctuation">;</span>
                <span class="token comment">// streamList 中有对应流的 streamID</span>
                <span class="token keyword">const</span> remoteStream <span class="token operator">=</span> <span class="token keyword">await</span> zg<span class="token punctuation">.</span><span class="token function">startPlayingStream</span><span class="token punctuation">(</span>streamID<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 创建媒体流播放组件</span>
                <span class="token keyword">const</span> remoteView <span class="token operator">=</span> zg<span class="token punctuation">.</span><span class="token function">createRemoteStreamView</span><span class="token punctuation">(</span>remoteStream<span class="token punctuation">)</span><span class="token punctuation">;</span>
                remoteView<span class="token punctuation">.</span><span class="token function">play</span><span class="token punctuation">(</span><span class="token string">"remote-video"</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span><span class="token literal-property property">enableAutoplayDialog</span><span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>updateType <span class="token operator">==</span> <span class="token string">'DELETE'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// 流删除，通过流删除列表 streamList 中每个流的 streamID 进行停止拉流。</span>
                <span class="token keyword">const</span> streamID <span class="token operator">=</span> streamList<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>streamID<span class="token punctuation">;</span>
                zg<span class="token punctuation">.</span><span class="token function">stopPlayingStream</span><span class="token punctuation">(</span>streamID<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 登录房间，成功则返回 true</span>
        <span class="token comment">// userUpdate 设置为 true 才能收到 roomUserUpdate 回调。</span>
        <span class="token keyword">let</span> userID <span class="token operator">=</span> <span class="token string">"user1"</span><span class="token punctuation">;</span> <span class="token comment">// userID 用户自己设置，必须保证全局唯一</span>
        <span class="token keyword">let</span> userName <span class="token operator">=</span> <span class="token string">"user1"</span><span class="token punctuation">;</span><span class="token comment">// userName 用户自己设置，没有唯一性要求</span>
        <span class="token keyword">let</span> roomID <span class="token operator">=</span> <span class="token string">"123"</span><span class="token punctuation">;</span> <span class="token comment">// roomID 用户自己设置，必须保证全局唯一</span>
        <span class="token comment">// token 由用户自己的服务端生成，为了更快跑通流程，可以通过即构控制台 https://console.zego.im/ 获取临时的音视频 token，token 为字符串</span>
        <span class="token keyword">let</span> token <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>

        zg<span class="token punctuation">.</span><span class="token function">loginRoom</span><span class="token punctuation">(</span>roomID<span class="token punctuation">,</span> token<span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span> userID<span class="token punctuation">,</span> <span class="token literal-property property">userName</span><span class="token operator">:</span> userID <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">userUpdate</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token parameter">result</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">==</span> <span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"login success"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 与房间连接成功，只有当房间状态是连接成功时，才能进行推流、拉流等操作。</span>
                <span class="token comment">// 创建流、预览</span>
                <span class="token comment">// 调用 createStream 接口后，需要等待 ZEGO 服务器返回流媒体对象才能执行后续操作</span>
                <span class="token keyword">const</span> localStream <span class="token operator">=</span> <span class="token keyword">await</span> zg<span class="token punctuation">.</span><span class="token function">createStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 创建媒体流播放组件</span>
                <span class="token keyword">const</span> localView <span class="token operator">=</span> zg<span class="token punctuation">.</span><span class="token function">createLocalStreamView</span><span class="token punctuation">(</span>localStream<span class="token punctuation">)</span><span class="token punctuation">;</span>
                localView<span class="token punctuation">.</span><span class="token function">play</span><span class="token punctuation">(</span><span class="token string">"local-video"</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span><span class="token literal-property property">enableAutoplayDialog</span><span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 开始推流，将自己的音视频流推送到 ZEGO 音视频云，此处 streamID 由用户定义，需全局唯一</span>
                <span class="token keyword">let</span> streamID <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                zg<span class="token punctuation">.</span><span class="token function">startPublishingStream</span><span class="token punctuation">(</span>streamID<span class="token punctuation">,</span> localStream<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// // 登录房间的第二种写法</span>
        <span class="token comment">// (async function main(){<!-- --></span>
        <span class="token comment">//     await zg.loginRoom(roomID, token, { userID, userName: userID }, { userUpdate: true })</span>
        <span class="token comment">// })()</span>
    </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>
</code></pre>
    <h3>
     <a id="4_WebRTC_152">
     </a>
     4 WebRTC音视频通话实现流程
    </h3>
    <p>
     以用户 A 拉取用户 B 的流为例，一次简单的WebRTC实时音视频通话主要流程如下：
    </p>
    <ol>
     <li>
      用户 A 创建实例，登录房间。（登录成功后，可预览自己的画面并推流。）
     </li>
     <li>
      用户 B 创建实例，登录同一个房间。登录成功后，用户 B 开始推流，此时 SDK 会触发
      <code>
       roomStreamUpdate
      </code>
      回调，表示房间内有流的变化。
     </li>
     <li>
      用户 A 可通过监听
      <code>
       roomStreamUpdate
      </code>
      回调，当回调通知有流新增时，获取用户 B 的流 ID，来拉取播放用户 B 刚刚推送的流。
     </li>
    </ol>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/38f6825dffff2b41199ee39e8c70aec1.png"/>
    </p>
    <h4>
     <a id="41_WebRTC_163">
     </a>
     4.1 创建WebRTC实时音视频通话界面
    </h4>
    <p>
     为方便实现基本的WebRTC实时音视频功能，您可参考WebRTC实时音视频的示例代码和下图实现一个简单实时音视频功能的页面。
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/3981dd506a294172da054a8d0e4ec4e7.png"/>
    </p>
    <p>
     打开或新建 “index.html” 页面文件，并拷贝以下代码到文件中。
    </p>
    <pre><code class="prism language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>UTF-8<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>Zego Express Video Call<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>text/css<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token style"><span class="token language-css">
        <span class="token selector">*</span> <span class="token punctuation">{<!-- --></span>
            <span class="token property">font-family</span><span class="token punctuation">:</span> sans-serif<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token selector">h1,
        h4</span> <span class="token punctuation">{<!-- --></span>
            <span class="token property">text-align</span><span class="token punctuation">:</span> center<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token selector">#local-video, #remote-video</span> <span class="token punctuation">{<!-- --></span>
            <span class="token property">width</span><span class="token punctuation">:</span> 400px<span class="token punctuation">;</span>
            <span class="token property">height</span><span class="token punctuation">:</span> 300px<span class="token punctuation">;</span>
            <span class="token property">border</span><span class="token punctuation">:</span> 1px solid #dfdfdf<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token selector">#local-video</span> <span class="token punctuation">{<!-- --></span>
            <span class="token property">position</span><span class="token punctuation">:</span> relative<span class="token punctuation">;</span>
            <span class="token property">margin</span><span class="token punctuation">:</span> 0 auto<span class="token punctuation">;</span>
            <span class="token property">display</span><span class="token punctuation">:</span> block<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token selector">#remote-video</span> <span class="token punctuation">{<!-- --></span>
            <span class="token property">display</span><span class="token punctuation">:</span> flex<span class="token punctuation">;</span>
            <span class="token property">margin</span><span class="token punctuation">:</span> auto<span class="token punctuation">;</span>
            <span class="token property">position</span><span class="token punctuation">:</span> relative <span class="token important">!important</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">&gt;</span></span>
        Zego RTC Video Call
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h4</span><span class="token punctuation">&gt;</span></span>Local video<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h4</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>local-video<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h4</span><span class="token punctuation">&gt;</span></span>Remote video<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h4</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>remote-video<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
    <span class="token comment">// 文档中的 js 示例代码可粘贴至此处</span>
    <span class="token comment">// const zg = new ZegoExpressEngine(appID, server);</span>
    </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>
</code></pre>
    <h4>
     <a id="42__226">
     </a>
     4.2 创建引擎并监听回调
    </h4>
    <ol>
     <li>
      <p>
       创建并初始化一个
       <code>
        ZegoExpressEngine
       </code>
       的实例，将您项目的 AppID 传入参数 “appID”，Server 传入参数 “server”。
      </p>
     </li>
     <li>
      <p>
       即构实时音视频SDK 提供如房间连接状态、音视频流变化、用户进出等通知回调。为避免错过任何通知，您需要在创建 ZegoExpressEngine 后立即监听回调。
      </p>
     </li>
    </ol>
    <pre><code class="prism language-javascript"><span class="token comment">// 项目唯一标识 AppID，Number 类型，请从 ZEGO 控制台获取</span>
<span class="token keyword">let</span> appID <span class="token operator">=</span> <span class="token punctuation">;</span> 
<span class="token comment">// 接入服务器地址 Server，String 类型，请从 ZEGO 控制台获取（获取方式请参考上文“前提条件”）</span>
<span class="token keyword">let</span> server <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>

<span class="token comment">// 初始化实例</span>
<span class="token keyword">const</span> zg <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ZegoExpressEngine</span><span class="token punctuation">(</span>appID<span class="token punctuation">,</span> server<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 房间状态更新回调</span>
zg<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'roomStateChanged'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">roomID<span class="token punctuation">,</span> reason<span class="token punctuation">,</span> errorCode<span class="token punctuation">,</span> extendData</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>reason <span class="token operator">==</span> <span class="token string">'LOGINING'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 登录中</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>reason <span class="token operator">==</span> <span class="token string">'LOGINED'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 登录成功</span>
            <span class="token comment">//只有当房间状态是登录成功或重连成功时，推流（startPublishingStream）、拉流（startPlayingStream）才能正常收发音视频</span>
            <span class="token comment">//将自己的音视频流推送到 ZEGO 音视频云</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>reason <span class="token operator">==</span> <span class="token string">'LOGIN_FAILED'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 登录失败</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>reason <span class="token operator">==</span> <span class="token string">'RECONNECTING'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 重连中</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>reason <span class="token operator">==</span> <span class="token string">'RECONNECTED'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 重连成功</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>reason <span class="token operator">==</span> <span class="token string">'RECONNECT_FAILED'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 重连失败</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>reason <span class="token operator">==</span> <span class="token string">'KICKOUT'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 被踢出房间</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>reason <span class="token operator">==</span> <span class="token string">'LOGOUT'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 登出成功</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>reason <span class="token operator">==</span> <span class="token string">'LOGOUT_FAILED'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 登出失败</span>
        <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//房间内其他用户进出房间的通知</span>
<span class="token comment">//只有调用 loginRoom 登录房间时传入 ZegoRoomConfig，且 ZegoRoomConfig 的 userUpdate 参数为 “true” 时，用户才能收到 roomUserUpdate回调。</span>
zg<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'roomUserUpdate'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">roomID<span class="token punctuation">,</span> updateType<span class="token punctuation">,</span> userList</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>updateType <span class="token operator">==</span> <span class="token string">'ADD'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> userList<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>userList<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'userID'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">'加入了房间：'</span><span class="token punctuation">,</span> roomID<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>updateType <span class="token operator">==</span> <span class="token string">'DELETE'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> userList<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>userList<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'userID'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">'退出了房间：'</span><span class="token punctuation">,</span> roomID<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

zg<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'roomStreamUpdate'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">roomID<span class="token punctuation">,</span> updateType<span class="token punctuation">,</span> streamList<span class="token punctuation">,</span> extendedData</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 房间内其他用户音视频流变化的通知</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre>
    <h4>
     <a id="43_WebRTC_287">
     </a>
     4.3 检测浏览器WebRTC兼容性
    </h4>
    <p>
     考虑到不同的浏览器对 WebRTC 的兼容性不同，在实现实时音视频推拉流功能之前，您需要检测浏览器能否正常运行 WebRTC。
    </p>
    <p>
     您可以调用
     <code>
      checkSystemRequirements
     </code>
     接口检测浏览器的兼容性，检测结果的含义，请参考
     <code>
      ZegoCapabilityDetection
     </code>
     接口下的参数描述。
    </p>
    <pre><code class="prism language-js"><span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> zg<span class="token punctuation">.</span><span class="token function">checkSystemRequirements</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 返回的 result 为兼容性检测结果。 webRTC 为 true 时表示支持 webRTC，其他属性含义可以参考接口 API 文档。</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// {<!-- --></span>
<span class="token comment">//   webRTC: true,</span>
<span class="token comment">//   customCapture: true,</span>
<span class="token comment">//   camera: true,</span>
<span class="token comment">//   microphone: true,</span>
<span class="token comment">//   videoCodec: { H264: true, H265: false, VP8: true, VP9: true },</span>
<span class="token comment">//   screenSharing: true,</span>
<span class="token comment">//   errInfo: {}</span>
<span class="token comment">// }</span>
</code></pre>
    <p>
     您还可以通过 ZEGO 提供的实时音视频推拉流在线检测工具
     <a href="https://zegodev.gitee.io/zego-express-webrtc-sample/webrtcCheck/index.html?source=csdn&amp;article18" rel="nofollow">
      在线检测工具
     </a>
     ，在需要检测的浏览器中打开，直接检测浏览器的兼容性。请参考
     <a href="https://doc-zh.zego.im/article/12047?source=csdn&amp;article18" rel="nofollow">
      浏览器兼容性说明
     </a>
     获取 音视频SDK 支持的浏览器兼容版本。
    </p>
    <h4>
     <a id="44__311">
     </a>
     4.4 登录房间
    </h4>
    <p>
     <strong>
      1. 生成 Token
     </strong>
    </p>
    <p>
     登录房间需要用于验证身份的 Token，开发者可直接在
     <a href="https://console.zego.im/dashboard?source=csdn&amp;article18" rel="nofollow">
      ZEGO 控制台
     </a>
     获取临时 Token（有效期为 24 小时）来使用，详情请参考
     <a href="https://doc-zh.zego.im/article/12107?source=csdn&amp;article18" rel="nofollow">
      控制台 - 项目管理
     </a>
     中的 “项目信息”。
    </p>
    <div class="mk-hint">
    </div>
    <p>
     临时 Token 仅供调试，正式上线前，请从开发者的业务服务器生成 Token，详情可参考
     <a href="https://doc-zh.zego.im/article/7646?source=csdn&amp;article18" rel="nofollow">
      使用 Token 鉴权
     </a>
     。
    </p>
    <p>
     <strong>
      2. 登录房间
     </strong>
    </p>
    <p>
     调用
     <code>
      loginRoom
     </code>
     接口，传入房间 ID 参数 “roomID”、“token” 和用户参数 “user”，根据实际情况传入参数 “config”，登录房间。
    </p>
    <div class="mk-warning">
    </div>
    <ul>
     <li>
      “roomID”、“userID” 和 “userName” 参数的取值都为自定义。
     </li>
     <li>
      “roomID” 和 “userID” 都必须唯一，建议开发者将 “userID” 设置为一个有意义的值，可将其与自己的业务账号系统进行关联。
     </li>
     <li>
      只有调用
      <code>
       loginRoom
      </code>
      接口登录房间时传入
      <code>
       ZegoRoomConfig
      </code>
      配置，且 “userUpdate” 参数取值为 “true” 时，用户才能收到
      <code>
       roomUserUpdate
      </code>
      回调。
     </li>
    </ul>
    <pre><code class="prism language-javascript"><span class="token comment">// 登录房间，成功则返回 true</span>
<span class="token comment">// userUpdate 设置为 true 才能收到 roomUserUpdate 回调。</span>

<span class="token keyword">let</span> userID <span class="token operator">=</span> Util<span class="token punctuation">.</span><span class="token function">getBrow</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'_'</span> <span class="token operator">+</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> userName <span class="token operator">=</span> <span class="token string">"user0001"</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> roomID <span class="token operator">=</span> <span class="token string">"0001"</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> token <span class="token operator">=</span> <span class="token punctuation">;</span>
<span class="token comment">// 为避免错过任何通知，您需要在登录房间前先监听用户加入/退出房间、房间连接状态变更、推流状态变更等回调。</span>
zg<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'roomStateChanged'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">roomID<span class="token punctuation">,</span> reason<span class="token punctuation">,</span> errorCode<span class="token punctuation">,</span> extendedData</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>

<span class="token punctuation">}</span><span class="token punctuation">)</span>
zg<span class="token punctuation">.</span><span class="token function">loginRoom</span><span class="token punctuation">(</span>roomID<span class="token punctuation">,</span> token<span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span> userID<span class="token punctuation">,</span> <span class="token literal-property property">userName</span><span class="token operator">:</span> userID <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">userUpdate</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">result</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
     <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">==</span> <span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"login success"</span><span class="token punctuation">)</span>
     <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <p>
     您可以监听
     <code>
      roomStateChanged
     </code>
     回调实时监控自己与房间的连接状态。只有当房间状态是连接成功时，才能进行推流、拉流等操作。
    </p>
    <h4>
     <a id="45__ZEGO__358">
     </a>
     4.5 预览自己的画面，并推送到 ZEGO 音视频云
    </h4>
    <ol>
     <li>
      创建流并预览自己的画面
     </li>
    </ol>
    <p>
     开始推流前需要创建本端的音视频流，调用
     <code>
      createStream
     </code>
     接口获取媒体流对象，默认会采集摄像头画面和麦克风声音。媒体流对象可以使用
     <code>
      createLocalStreamView
     </code>
     创建本地媒体流播放组件进行播放，也可以通过 video 元素 srcObject 属性赋值进行播放。
    </p>
    <ol start="2">
     <li>
      需等待
      <code>
       createStream
      </code>
      接口返回流媒体对象后，再将自己的音视频流推送到 ZEGO 音视频云。
     </li>
    </ol>
    <p>
     调用
     <code>
      startPublishingStream
     </code>
     接口，传入 “streamID” 和创建流得到的流对象 “localStream”，向远端用户发送本端的音视频流。
    </p>
    <div class="mk-hint">
    </div>
    <p>
     “streamID” 由您本地生成，但是需要保证同一个 AppID 下，“streamID” 全局唯一。如果同一个 AppID 下，不同用户各推了一条 “streamID” 相同的流，会导致后推流的用户推流失败。
    </p>
    <pre><code class="prism language-javascript"><span class="token comment">// 此处在登录房间成功后，立即进行推流。在实现具体业务时，您可选择其他时机进行推流，只要保证当前房间连接状态是连接成功的即可。</span>

zg<span class="token punctuation">.</span><span class="token function">loginRoom</span><span class="token punctuation">(</span>roomID<span class="token punctuation">,</span> token<span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span> userID<span class="token punctuation">,</span> <span class="token literal-property property">userName</span><span class="token operator">:</span> userID <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">userUpdate</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token parameter">result</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
     <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">==</span> <span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"login success"</span><span class="token punctuation">)</span>
        <span class="token comment">// 创建流、预览</span>
           <span class="token comment">// 调用 createStream 接口后，需要等待 ZEGO 服务器返回流媒体对象才能执行后续操作</span>
           <span class="token keyword">const</span> localStream <span class="token operator">=</span> <span class="token keyword">await</span> zg<span class="token punctuation">.</span><span class="token function">createStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
           
           <span class="token comment">// 创建媒体流播放组件对象，用于预览本地流</span>
           <span class="token keyword">const</span> localView <span class="token operator">=</span> zg<span class="token punctuation">.</span><span class="token function">createLocalStreamView</span><span class="token punctuation">(</span>localStream<span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token comment">// 将播放组件挂载到页面，"local-video" 为组件容器 DOM 元素的 id 。</span>
           localView<span class="token punctuation">.</span><span class="token function">play</span><span class="token punctuation">(</span><span class="token string">"local-video"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

           <span class="token comment">// 开始推流，将自己的音视频流推送到 ZEGO 音视频云</span>
           <span class="token keyword">let</span> streamID <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
           zg<span class="token punctuation">.</span><span class="token function">startPublishingStream</span><span class="token punctuation">(</span>streamID<span class="token punctuation">,</span> localStream<span class="token punctuation">)</span>
     <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre>
    <p>
     （可选）设置音视频采集参数
    </p>
    通过属性设置相关采集参数
    <p>
     可根据需要通过
     <code>
      createStream
     </code>
     接口中的如下属性设置音视频相关采集参数，详情可参考
     <a href="https://doc-zh.zego.im/article/3679?source=csdn&amp;article18" rel="nofollow">
      自定义视频采集
     </a>
     ：
    </p>
    <ul>
     <li>
      <p>
       <code>
        camera
       </code>
       ：摄像头麦克风采集流相关配置
      </p>
     </li>
     <li>
      <p>
       <code>
        screen
       </code>
       ：屏幕捕捉采集流相关配置
      </p>
     </li>
     <li>
      <p>
       <code>
        custom
       </code>
       ：第三方流采集相关配置
      </p>
     </li>
    </ul>
    <h4>
     <a id="46__415">
     </a>
     4.6 拉取其他用户的音视频
    </h4>
    <p>
     进行视频通话时，我们需要拉取到其他用户的音视频。
    </p>
    <p>
     房间内有其他用户加入时，SDK 会触发
     <code>
      roomStreamUpdate
     </code>
     回调，通知房间内有流新增，基于此可获取其他用户的 “streamID”。此时，调用
     <code>
      startPlayingStream
     </code>
     接口根据传入的其他用户的 “streamID”，拉取远端已推送到 ZEGO 服务器的音视频画面。若需要从 CDN 拉流，可参考
     <a href="https://doc-zh.zego.im/article/1218?source=csdn&amp;article18" rel="nofollow">
      使用 CDN 直播
     </a>
     。
    </p>
    <pre><code class="prism language-javascript"><span class="token comment">// 流状态更新回调</span>
zg<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'roomStreamUpdate'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">roomID<span class="token punctuation">,</span> updateType<span class="token punctuation">,</span> streamList<span class="token punctuation">,</span> extendedData</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 当 updateType 为 ADD 时，代表有音视频流新增，此时可以调用 startPlayingStream 接口拉取播放该音视频流</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>updateType <span class="token operator">==</span> <span class="token string">'ADD'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 流新增，开始拉流</span>
        <span class="token comment">// 这里为了使示例代码更加简洁，我们只拉取新增的音视频流列表中第的第一条流，在实际的业务中，建议开发者循环遍历 streamList ，拉取每一条音视频流 </span>
        <span class="token keyword">const</span> streamID <span class="token operator">=</span> streamList<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>streamID<span class="token punctuation">;</span>
        <span class="token comment">// streamList 中有对应流的 streamID</span>
        <span class="token keyword">const</span> remoteStream <span class="token operator">=</span> <span class="token keyword">await</span> zg<span class="token punctuation">.</span><span class="token function">startPlayingStream</span><span class="token punctuation">(</span>streamID<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 创建媒体流播放组件对象，用于播放远端媒体流 。</span>
        <span class="token keyword">const</span> remoteView <span class="token operator">=</span> zg<span class="token punctuation">.</span><span class="token function">createRemoteStreamView</span><span class="token punctuation">(</span>remoteStream<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 将播放组件挂载到页面，"remote-video" 为组件容器 DOM 元素的 id 。</span>
        remoteView<span class="token punctuation">.</span><span class="token function">play</span><span class="token punctuation">(</span><span class="token string">"remote-video"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>updateType <span class="token operator">==</span> <span class="token string">'DELETE'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 流删除，停止拉流</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <div class="mk-warning">
    </div>
    <ul>
     <li>
      部分浏览器因自动播放限制策略问题，使用
      <code>
       ZegoStreamView
      </code>
      媒体流播放组件进行播放媒体流可能受阻，SDK 默认会在界面上弹窗提示恢复播放。
     </li>
     <li>
      您可以将 ZegoStreamView.play() 方法的第二个参数 options.enableAutoplayDialog 设置为 false 关闭自动弹窗，通过在
      <code>
       autoplayFailed
      </code>
      事件回调中，在页面上显示一个按钮，引导用户点击恢复播放。
     </li>
    </ul>
    <p>
     至此，您已经成功实现了简单的实时音视频通话，可在浏览器中打开 “index.html”，体验实时音视频功能。
    </p>
    <h3>
     <a id="5_SDK_454">
     </a>
     5 实时音视频SDK常用功能
    </h3>
    <h4>
     <a id="51__456">
     </a>
     5.1 常用通知回调
    </h4>
    <pre><code class="prism language-javascript"><span class="token comment">// 房间连接状态更新回调</span>
<span class="token comment">// 本地调用 loginRoom 加入房间时，您可通过监听 roomStateChanged 回调实时监控自己在本房间内的连接状态。</span>
zg<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'roomStateChanged'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">roomID<span class="token punctuation">,</span> reason<span class="token punctuation">,</span> errorCode<span class="token punctuation">,</span> extendData</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>reason <span class="token operator">==</span> <span class="token string">'LOGINING'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 登录中</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>reason <span class="token operator">==</span> <span class="token string">'LOGINED'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 登录成功</span>
        <span class="token comment">//只有当房间状态是登录成功或重连成功时，推流（startPublishingStream）、拉流（startPlayingStream）才能正常收发音视频</span>
        <span class="token comment">//将自己的音视频流推送到 ZEGO 音视频云</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>reason <span class="token operator">==</span> <span class="token string">'LOGIN_FAILED'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 登录失败</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>reason <span class="token operator">==</span> <span class="token string">'RECONNECTING'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 重连中</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>reason <span class="token operator">==</span> <span class="token string">'RECONNECTED'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 重连成功</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>reason <span class="token operator">==</span> <span class="token string">'RECONNECT_FAILED'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 重连失败</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>reason <span class="token operator">==</span> <span class="token string">'KICKOUT'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 被踢出房间</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>reason <span class="token operator">==</span> <span class="token string">'LOGOUT'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 登出成功</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>reason <span class="token operator">==</span> <span class="token string">'LOGOUT_FAILED'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 登出失败</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//房间内其他用户推送的音视频流新增/减少的通知</span>
<span class="token comment">//自己推送的流不能在这里接收到通知</span>
zg<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'roomStreamUpdate'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">roomID<span class="token punctuation">,</span> updateType<span class="token punctuation">,</span> streamList<span class="token punctuation">,</span> extendedData</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>updateType <span class="token operator">==</span> <span class="token string">'ADD'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 流新增</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> streamList<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'房间'</span><span class="token punctuation">,</span>roomID<span class="token punctuation">,</span><span class="token string">'内新增了流：'</span><span class="token punctuation">,</span> streamList<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'streamID'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">const</span> message <span class="token operator">=</span> <span class="token string">"其他用户的视频流streamID: "</span> <span class="token operator">+</span> streamID<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>updateType <span class="token operator">==</span> <span class="token string">'DELETE'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 流删除</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> streamList<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'房间'</span><span class="token punctuation">,</span>roomID<span class="token punctuation">,</span><span class="token string">'内减少了流：'</span><span class="token punctuation">,</span> streamList<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'streamID'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//房间内其他用户进出房间的通知</span>
<span class="token comment">//只有调用 loginRoom 登录房间时传入 ZegoRoomConfig，且 ZegoRoomConfig 的 userUpdate 参数为 “true” 时，用户才能收到 roomUserUpdate回调。</span>
zg<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'roomUserUpdate'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">roomID<span class="token punctuation">,</span> updateType<span class="token punctuation">,</span> userList</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>updateType <span class="token operator">==</span> <span class="token string">'ADD'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> userList<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>userList<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'userID'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">'加入了房间：'</span><span class="token punctuation">,</span> roomID<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>updateType <span class="token operator">==</span> <span class="token string">'DELETE'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> userList<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>userList<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'userID'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">'退出了房间：'</span><span class="token punctuation">,</span> roomID<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//用户推送音视频流的状态通知</span>
<span class="token comment">//用户推送音视频流的状态发生变更时，会收到该回调。如果网络中断导致推流异常，SDK 在重试推流的同时也会通知状态变化。</span>
zg<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'publisherStateUpdate'</span><span class="token punctuation">,</span> <span class="token parameter">result</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 推流状态更新回调</span>
    <span class="token keyword">var</span> state <span class="token operator">=</span> result<span class="token punctuation">[</span><span class="token string">'state'</span><span class="token punctuation">]</span>
    <span class="token keyword">var</span> streamID <span class="token operator">=</span> result<span class="token punctuation">[</span><span class="token string">'streamID'</span><span class="token punctuation">]</span>
    <span class="token keyword">var</span> errorCode <span class="token operator">=</span> result<span class="token punctuation">[</span><span class="token string">'errorCode'</span><span class="token punctuation">]</span>
    <span class="token keyword">var</span> extendedData <span class="token operator">=</span> result<span class="token punctuation">[</span><span class="token string">'extendedData'</span><span class="token punctuation">]</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>state <span class="token operator">==</span> <span class="token string">'PUBLISHING'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'成功推送音视频流：'</span><span class="token punctuation">,</span> streamID<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>state <span class="token operator">==</span> <span class="token string">'NO_PUBLISH'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'未推送音视频流'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>state <span class="token operator">==</span> <span class="token string">'PUBLISH_REQUESTING'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'请求推送音视频流：'</span><span class="token punctuation">,</span> streamID<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'错误码:'</span><span class="token punctuation">,</span> errorCode<span class="token punctuation">,</span><span class="token string">' 额外信息:'</span><span class="token punctuation">,</span> extendedData<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">//推流质量回调。</span>
<span class="token comment">//成功推流后，您会定时收到回调音视频流质量数据（如分辨率、帧率、码率等）。</span>
zg<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'publishQualityUpdate'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">streamID<span class="token punctuation">,</span> stats</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 推流质量回调</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'流质量回调'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">//用户拉取音视频流的状态通知</span>
<span class="token comment">//用户拉取音视频流的状态发生变更时，会收到该回调。如果网络中断导致拉流异常，SDK 会自动进行重试。</span>
zg<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'playerStateUpdate'</span><span class="token punctuation">,</span> <span class="token parameter">result</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 拉流状态更新回调</span>
    <span class="token keyword">var</span> state <span class="token operator">=</span> result<span class="token punctuation">[</span><span class="token string">'state'</span><span class="token punctuation">]</span>
    <span class="token keyword">var</span> streamID <span class="token operator">=</span> result<span class="token punctuation">[</span><span class="token string">'streamID'</span><span class="token punctuation">]</span>
    <span class="token keyword">var</span> errorCode <span class="token operator">=</span> result<span class="token punctuation">[</span><span class="token string">'errorCode'</span><span class="token punctuation">]</span>
    <span class="token keyword">var</span> extendedData <span class="token operator">=</span> result<span class="token punctuation">[</span><span class="token string">'extendedData'</span><span class="token punctuation">]</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>state <span class="token operator">==</span> <span class="token string">'PLAYING'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'成功拉取音视频流：'</span><span class="token punctuation">,</span> streamID<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>state <span class="token operator">==</span> <span class="token string">'NO_PLAY'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'未拉取音视频流'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>state <span class="token operator">==</span> <span class="token string">'PLAY_REQUESTING'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'请求拉取音视频流：'</span><span class="token punctuation">,</span> streamID<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'错误码:'</span><span class="token punctuation">,</span> errorCode<span class="token punctuation">,</span><span class="token string">' 额外信息:'</span><span class="token punctuation">,</span> extendedData<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">//拉取音视频流时的质量回调。</span>
<span class="token comment">//成功拉流后，您会定时收到拉取音视频流时的质量数据通知（如分辨率、帧率、码率等）。</span>
zg<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'playQualityUpdate'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">streamID<span class="token punctuation">,</span>stats</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 拉流质量回调</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">//收到广播消息的通知</span>
zg<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'IMRecvBroadcastMessage'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">roomID<span class="token punctuation">,</span> chatData</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'广播消息IMRecvBroadcastMessage'</span><span class="token punctuation">,</span> roomID<span class="token punctuation">,</span> chatData<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">alert</span><span class="token punctuation">(</span>chatData<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>message<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//收到弹幕消息的通知</span>
zg<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'IMRecvBarrageMessage'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">roomID<span class="token punctuation">,</span> chatData</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'弹幕消息IMRecvBroadcastMessage'</span><span class="token punctuation">,</span> roomID<span class="token punctuation">,</span> chatData<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">alert</span><span class="token punctuation">(</span>chatData<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>message<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//收到自定义信令消息的通知</span>
zg<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'IMRecvCustomCommand'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">roomID<span class="token punctuation">,</span> fromUser<span class="token punctuation">,</span> command</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'自定义消息IMRecvCustomCommand'</span><span class="token punctuation">,</span> roomID<span class="token punctuation">,</span> fromUser<span class="token punctuation">,</span> command<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">alert</span><span class="token punctuation">(</span>command<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <h4>
     <a id="52__584">
     </a>
     5.2 停止音视频通话
    </h4>
    <p>
     <strong>
      1. 停止推流、销毁流
     </strong>
    </p>
    <p>
     调用
     <code>
      stopPublishingStream
     </code>
     接口停止向远端用户发送本端的音视频流。调用
     <code>
      destroyStream
     </code>
     接口销毁创建的流数据，销毁流后开发需自行销毁 video（停止采集）。
    </p>
    <pre><code class="prism language-javascript"><span class="token comment">// 根据本端 streamID 停止推流</span>
zg<span class="token punctuation">.</span><span class="token function">stopPublishingStream</span><span class="token punctuation">(</span>streamID<span class="token punctuation">)</span>
<span class="token comment">// localStream 是调用 createStream 接口获取的 MediaStream 对象</span>
zg<span class="token punctuation">.</span><span class="token function">destroyStream</span><span class="token punctuation">(</span>localStream<span class="token punctuation">)</span>
</code></pre>
    <p>
     <strong>
      2. 停止拉流
     </strong>
    </p>
    <p>
     调用
     <code>
      stopPlayingStream
     </code>
     接口停止拉取远端推送的音视频流。
    </p>
    <pre><code class="prism language-javascript"><span class="token comment">// 流状态更新回调</span>
zg<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'roomStreamUpdate'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">roomID<span class="token punctuation">,</span> updateType<span class="token punctuation">,</span> streamList<span class="token punctuation">,</span> extendedData</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>updateType <span class="token operator">==</span> <span class="token string">'ADD'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 流新增，开始拉流</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>updateType <span class="token operator">==</span> <span class="token string">'DELETE'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 流删除，通过流删除列表 streamList 中每个流的 streamID 进行停止拉流。</span>
        <span class="token keyword">const</span> streamID <span class="token operator">=</span> streamList<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>streamID<span class="token punctuation">;</span>
        zg<span class="token punctuation">.</span><span class="token function">stopPlayingStream</span><span class="token punctuation">(</span>streamID<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <p>
     <strong>
      3. 退出房间
     </strong>
    </p>
    <p>
     调用
     <code>
      logoutRoom
     </code>
     接口退出房间。
    </p>
    <pre><code class="prism language-javascript">zg<span class="token punctuation">.</span><span class="token function">logoutRoom</span><span class="token punctuation">(</span>roomID<span class="token punctuation">)</span>
</code></pre>
    <p>
     以上整个推拉流过程的 API 调用时序可参考下图：
     <br/>
     <img alt="[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-O5VWynpI-1658881626857)(media/16582990898546/16582999010618.png)]" src="https://i-blog.csdnimg.cn/blog_migrate/774ee2651298892af1df6fb74650fd5e.png"/>
    </p>
    <h3>
     <a id="6__630">
     </a>
     6 调试视频通话功能
    </h3>
    <p>
     在真机中运行项目，运行成功后，可以看到本端视频画面。
    </p>
    <p>
     为方便体验，ZEGO 提供了一个
     <a href="https://zegodev.gitee.io/zego-express-webrtc-sample/assistDev/index.html?source=csdn&amp;article18" rel="nofollow">
      Web 端调试示例
     </a>
     ，在该页面下，输入相同的 AppID、RoomID，输入一个不同的 UserID，即可加入同一房间与真机设备互通。当成功开始音视频通话时，可以听到远端的音频，看到远端的视频画面。
    </p>
    <h3>
     <a id="7_SDK_638">
     </a>
     7 获取音视频SDK更多支持
    </h3>
    <p>
     获取本文的Demo、开发文档、技术支持，访问
     <a href="https://doc-zh.zego.im/article/7638?source=csdn&amp;article18" rel="nofollow">
      即构文档中心
     </a>
    </p>
    <p>
     近期有开发规划的开发者可上即构官网查看，恰逢即构七周年全线音视频产品1折的优惠，
     <a href="https://www.zego.im/cluesCollect?source=csdn&amp;article18" rel="nofollow">
      联系商务
     </a>
     获取RTC产品优惠；
    </p>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
  <div class="blog-extension-box" id="blogExtensionBox" style="width:400px;margin:auto;margin-top:12px">
  </div>
 </article>
 <p alt="68747470733a2f:2f626c6f672e6373646e2e6e65742f7a65676f5f303631362f:61727469636c652f64657461696c732f313335333932303135" class_="artid" style="display:none">
 </p>
</div>


