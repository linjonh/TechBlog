---
layout: post
title: 嵌入式操作系统组成结构软硬件之间的联系-硬件如何执行第一行代码
date: 2022-08-09 16:51:46 +0800
description: 文章浏览阅读2.6k次，点赞7次，收藏13次。本文详细探讨了嵌入式开发中从C/C++程序到硬件执行的
keywords: 嵌入式开发中软硬件开发之间的协作痛点场景和需求
categories: ['Threadf']
tags: ['操作系统', '嵌入式', 'Rtos']
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=115243024
    alt: 嵌入式操作系统组成结构软硬件之间的联系-硬件如何执行第一行代码
artid: 115243024
render_with_liquid: false
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     嵌入式操作系统组成结构（软硬件之间的联系）--硬件如何执行第一行代码？
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="htmledit_views" id="content_views">
    <h2 id="%E5%BC%95%E8%A8%80%EF%BC%9A">
     引言：
    </h2>
    <p>
     最近纠结了两周决定自己以后还是走爱好的嵌入式方向，细分就是操作系统相关，下一步的目标是从0到1编写  RT-Thread的内核，然后转战嵌入式linux软件驱动开发，
    </p>
    <p>
     正好之前有做FreeRTOS，但都是偏上层的API函数的调用，这种仅会应用的层面给人带来一种不踏实的虚假感，因此为加强自己对整个系统的理解，一周内恶补了七、八本经典的书籍，针对各本书前几章对整个嵌入式操作系统的架构讲解，自己进行了汇总整理。
    </p>
    <p>
     本文涉及到的知识有  汇编语言 计算机系统结构 操作系统等。
    </p>
    <hr/>
    <h2 id="%E5%86%99%E8%80%85%E5%8F%99%EF%BC%9A">
     写者叙：
    </h2>
    <p>
     如果在学习讨论的过程中发现本文中提到自己暂时不了解的知识，可以阅后在文中附有的相关资料参考，也欢迎大家评论附上对相关内容解释较好的链接或者自己的理解进行交流~
    </p>
    <hr/>
    <h2 id="%E6%8F%90%E5%87%BA%E4%B8%A4%E4%B8%AA%E9%97%AE%E9%A2%98%EF%BC%9A">
     提出两个问题：
    </h2>
    <p>
     1.C/C++ 程序代码如何被编译成目标文件程序在目标文件中如何存储？
    </p>
    <p>
     针对嵌入式操作系统即 C代码如何与硬件进行交流？ 利用串口打印printf（“hello world\r\n”） 从开发环境编译加载到板子再到打印 这个过程中，到底发生了什么？（main函数之前发生了什么？）
    </p>
    <p>
     2.为什么每次仿真开始的时候 PC指向一堆汇编代码？这是什么东西？
    </p>
    <p>
    </p>
    <p>
     综上主要是分为两个问题：
    </p>
    <p>
     第一个是程序编译相关问题，不是本文重点，详见
     <span style="color:#3399ea;">
      （具体的编译、链接、装载的知识可以参考 《程序员的自我修养》俞甲子著）
     </span>
     ，里面有清晰明确的答案
    </p>
    <p>
     问题二是本文重点，针对C程序如何转化为板子能够运行的语言，并且对板子的启动过程——（main函数之前发生了什么？）进行理解总结
    </p>
    <hr/>
    <p id="main-toc">
     <strong>
      目录
     </strong>
    </p>
    <p id="%E5%BC%95%E8%A8%80%EF%BC%9A-toc" style="margin-left:0px;">
     <a href="#%E5%BC%95%E8%A8%80%EF%BC%9A" rel="nofollow">
      引言：
     </a>
    </p>
    <p id="%E5%86%99%E8%80%85%E5%8F%99%EF%BC%9A-toc" style="margin-left:0px;">
     <a href="#%E5%86%99%E8%80%85%E5%8F%99%EF%BC%9A" rel="nofollow">
      写者叙：
     </a>
    </p>
    <p id="%E6%8F%90%E5%87%BA%E4%B8%A4%E4%B8%AA%E9%97%AE%E9%A2%98%EF%BC%9A-toc" style="margin-left:0px;">
     <a href="#%E6%8F%90%E5%87%BA%E4%B8%A4%E4%B8%AA%E9%97%AE%E9%A2%98%EF%BC%9A" rel="nofollow">
      提出两个问题：
     </a>
    </p>
    <p id="%E4%B8%80%E3%80%81%E7%A1%AC%E4%BB%B6%E8%83%BD%E5%A4%9F%E6%89%A7%E8%A1%8C%E7%9A%84%E6%8C%87%E4%BB%A4%E2%80%94%E2%80%94%E6%9C%BA%E5%99%A8%E8%AF%AD%E8%A8%80-toc" style="margin-left:0px;">
     <a href="#%E4%B8%80%E3%80%81%E7%A1%AC%E4%BB%B6%E8%83%BD%E5%A4%9F%E6%89%A7%E8%A1%8C%E7%9A%84%E6%8C%87%E4%BB%A4%E2%80%94%E2%80%94%E6%9C%BA%E5%99%A8%E8%AF%AD%E8%A8%80" rel="nofollow">
      一、硬件能够执行的指令——机器语言
     </a>
    </p>
    <p id="%E4%BA%8C%E3%80%81%E5%90%AF%E5%8A%A8%E6%96%87%E4%BB%B6%EF%BC%88%E5%BC%80%E5%8F%91%E6%9D%BF%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B%EF%BC%89%EF%BC%88%E9%87%8D%E8%A6%81%EF%BC%89-toc" style="margin-left:0px;">
     <a href="#%E4%BA%8C%E3%80%81%E5%90%AF%E5%8A%A8%E6%96%87%E4%BB%B6%EF%BC%88%E5%BC%80%E5%8F%91%E6%9D%BF%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B%EF%BC%89%EF%BC%88%E9%87%8D%E8%A6%81%EF%BC%89" rel="nofollow">
      二、启动文件（开发板启动流程）（重要）
     </a>
    </p>
    <p id="2.1%E5%90%AF%E5%8A%A8%E6%96%87%E4%BB%B6-toc" style="margin-left:40px;">
     <a href="#2.1%E5%90%AF%E5%8A%A8%E6%96%87%E4%BB%B6" rel="nofollow">
      2.1启动文件
     </a>
    </p>
    <p id="2.2%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B-toc" style="margin-left:40px;">
     <a href="#2.2%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B" rel="nofollow">
      2.2启动流程
     </a>
    </p>
    <p id="1%EF%BC%89%E5%88%9B%E5%BB%BA%E5%BC%82%E5%B8%B8%E5%90%91%E9%87%8F%E8%A1%A8-toc" style="margin-left:80px;">
     <a href="#1%EF%BC%89%E5%88%9B%E5%BB%BA%E5%BC%82%E5%B8%B8%E5%90%91%E9%87%8F%E8%A1%A8" rel="nofollow">
      1）创建异常向量表
     </a>
    </p>
    <p id="2%EF%BC%89%E5%88%9D%E5%A7%8B%E5%8C%96%E5%9F%BA%E6%9C%AC%E7%A1%AC%E4%BB%B6%EF%BC%88CPU%E3%80%81%E4%B8%BB%E5%AD%98%E7%AD%89%EF%BC%89-toc" style="margin-left:80px;">
     <a href="#2%EF%BC%89%E5%88%9D%E5%A7%8B%E5%8C%96%E5%9F%BA%E6%9C%AC%E7%A1%AC%E4%BB%B6%EF%BC%88CPU%E3%80%81%E4%B8%BB%E5%AD%98%E7%AD%89%EF%BC%89" rel="nofollow">
      2）初始化基本硬件（CPU、主存等）
     </a>
    </p>
    <p id="3%EF%BC%89%E5%88%9D%E5%A7%8B%E5%8C%96%E5%A0%86%E6%A0%88-toc" style="margin-left:80px;">
     <a href="#3%EF%BC%89%E5%88%9D%E5%A7%8B%E5%8C%96%E5%A0%86%E6%A0%88" rel="nofollow">
      3）初始化堆栈
     </a>
    </p>
    <p id="4%EF%BC%89%E5%8A%A0%E8%BD%BD%E5%BA%94%E7%94%A8%E7%A8%8B%E5%BA%8F%E8%BF%90%E8%A1%8C%E7%8E%AF%E5%A2%83-toc" style="margin-left:80px;">
     <a href="#4%EF%BC%89%E5%8A%A0%E8%BD%BD%E5%BA%94%E7%94%A8%E7%A8%8B%E5%BA%8F%E8%BF%90%E8%A1%8C%E7%8E%AF%E5%A2%83" rel="nofollow">
      4）加载应用程序运行环境
     </a>
    </p>
    <p id="5%EF%BC%89%E8%B7%B3%E8%BD%AC%E5%88%B0%E4%B8%BB%E7%A8%8B%E5%BA%8F-toc" style="margin-left:80px;">
     <a href="#5%EF%BC%89%E8%B7%B3%E8%BD%AC%E5%88%B0%E4%B8%BB%E7%A8%8B%E5%BA%8F" rel="nofollow">
      5）跳转到主程序
     </a>
    </p>
    <p id="%E4%B8%89%E3%80%81%E6%80%BB%E7%BB%93-toc" style="margin-left:0px;">
     <a href="#%E4%B8%89%E3%80%81%E6%80%BB%E7%BB%93" rel="nofollow">
      三、总结
     </a>
    </p>
    <hr id="hr-toc"/>
    <hr/>
    <h2 id="%E4%B8%80%E3%80%81%E7%A1%AC%E4%BB%B6%E8%83%BD%E5%A4%9F%E6%89%A7%E8%A1%8C%E7%9A%84%E6%8C%87%E4%BB%A4%E2%80%94%E2%80%94%E6%9C%BA%E5%99%A8%E8%AF%AD%E8%A8%80">
     一、硬件能够执行的指令——机器语言
    </h2>
    <p>
     机器语言是机器指令的集合。它是一列二进制数字，计算机将之转化为一列高低电平，使电子器件电路收到驱动，进行运算。
    </p>
    <p style="text-indent:33px;">
     <img alt="" height="283" src="https://i-blog.csdnimg.cn/blog_migrate/5b2f55ad51d1ffc361ebeb81cbf189f2.png" width="531"/>
    </p>
    <p style="text-indent:0;">
     需要注意的是每一种微处理器，由于硬件设计和内部结构的不同，就需要用不同的机器指令（电平脉冲序列）来控制。
     <span style="color:#f33b45;">
      所以每一种微处理器都有自己的机器指令集。
     </span>
    </p>
    <p style="text-indent:0;">
     至于机器码如何执行以及它的含义我们暂时不需要理解，只需要知道编译环境会将我们写的C程序转化为我们选择的CPU所对应的指令集即可。
     <span style="color:#3399ea;">
      （C程序如何转换为对应的汇编指令，以及CPU的结构及如何执行汇编指令，请参考清华王爽《汇编语言（第三版）》）
     </span>
    </p>
    <p>
     因此你在使用keil新建工程的时候，必定在某个地方选择了特定的CPU型号，（新建工程后的弹框F103选择Cotex-M3，F4选择Cotex-M4）
    </p>
    <p>
     <img alt="" height="248" src="https://i-blog.csdnimg.cn/blog_migrate/818796f75482bfdfbae3ab1a600689b3.png" width="275"/>
    </p>
    <p>
     <span style="color:#f33b45;">
      这个操作使编译器可以把你的C程序编译为对应CPU指令集的汇编语言→机器语言，因此你的硬件便能执行了。
     </span>
     <span style="color:#3399ea;">
      （具体的编译、链接、装载的知识可以参考 《程序员的自我修养》俞甲子著）
     </span>
    </p>
    <p>
     但是现在有一个问题是，CPU已经认识你的程序了，但是从哪里开始执行呢？是从main开始吗？（当然不是）
    </p>
    <h2 id="%E4%BA%8C%E3%80%81%E5%90%AF%E5%8A%A8%E6%96%87%E4%BB%B6%EF%BC%88%E5%BC%80%E5%8F%91%E6%9D%BF%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B%EF%BC%89%EF%BC%88%E9%87%8D%E8%A6%81%EF%BC%89">
     二、启动文件（开发板启动流程）（重要）
    </h2>
    <h3 id="2.1%E5%90%AF%E5%8A%A8%E6%96%87%E4%BB%B6">
     2.1启动文件
    </h3>
    <p>
     新建工程后，紧接着出现的弹框，就是选择启动文件。
    </p>
    <p style="text-indent:33px;">
     <img alt="" height="484" src="https://i-blog.csdnimg.cn/blog_migrate/32ef70a2a5fa630e1787ba7e548843b2.png" width="959"/>
    </p>
    <p style="text-indent:0;">
     启动文件的作用是是什么呢？
    </p>
    <p style="text-indent:33px;">
     根据计算机组成原理的知识，一切指令与程序都只能够在主存上运行。而主存价格较为昂贵，并且开发人员的程序通常比较大，因此，开发人员的程序通常存储在外存中，而外存通常无法运行指令，因此系统上电后，怎样通过一些机制将应用程序从其他存储设备复制到主存上是相当重要的。
    </p>
    <p style="text-indent:33px;">
     如果你CPU连你main函数存放的地址都不知道在哪里？还谈何执行呢？这是启动文件必先在main函数之前执行的一个原因，
    </p>
    <p style="text-indent:33px;">
     此外，不同的系统硬件设备不同，开机后所需要的硬件设备的配置也不同。所以，系统上电后，对各硬件控制器的配置也不同（例如显存、扩展插槽上存储设备的地址等），这些都是需要在启动文件中进行设置的，也就是告诉CPU通过地址总线去哪些地址找东西、写东西。
    </p>
    <p style="text-indent:33px;">
     <img alt="" height="841" src="https://i-blog.csdnimg.cn/blog_migrate/dd5309a43472b0d80c1f24e9acf3bebb.png" width="668"/>
    </p>
    <p style="text-indent:0;">
     启动文件的作用可以根据需求的增加而进行扩充，上述只是告诉CPU 启动系统运行的基本硬件的设置，实际上启动代码还可以包括实际开发板上各板级硬件和接口的驱动程序，这时的启动代码其实就具有了能够使应用程序使用开发板各资源的接口功能了，（例如RT-Thread的任务调度、切换就利用汇编代码利用了CPU异常处理的资源）
    </p>
    <p style="text-indent:0;">
     <span style="color:#f33b45;">
      抽象的理解第一条指令的执行过程：
     </span>
     CPU复位上电后会由硬件电路使程序指针指向一个特定的地址，因此将要需要执行的第一条指令code_1（其实并不是main）放入这个地址，CPU便会转入code_1继续顺序执行指令。
    </p>
    <h3 id="2.2%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B">
     2.2启动流程
    </h3>
    <p>
     本节参考《嵌入式实时操作系统的设计与开发》 廖勇，本节只概述启动文件中的初始化流程，对每个操作不进行细节解释，想距离了解的读者见参考书。
    </p>
    <p style="text-indent:33px;">
     以S3C2440A为例芯片为例，此芯片通过硬件机制将NAND Flash（无法作为程序运行载体的一种外部存储器）中内容复制到S3C2440A芯片内部的4KB大小的SRAM,并且将它映射为自身内存的BANK0
     <span style="color:#f33b45;">
      （不是很理解）
     </span>
     ，将这4KB大小的内容映射到从0x00000000开始的地址（BANK0）上，为什么映射到0x00000000？见下文
    </p>
    <p style="text-indent:33px;">
     （arm处理器bank与存储器的bank详解：
    </p>
    <p style="text-indent:33px;">
     <a href="https://blog.csdn.net/dahailantian1/article/details/78584820?ops_request_misc=&amp;request_id=&amp;biz_id=102&amp;utm_term=BANK%E5%9C%B0%E5%9D%80%E6%98%A0%E5%B0%84&amp;utm_medium=distribute.pc_search_result.none-task-blog-2~all~sobaiduweb~default-4-78584820.first_rank_v2_pc_rank_v29_10">
      https://blog.csdn.net/dahailantian1/article/details/78584820?ops_request_misc=&amp;request_id=&amp;biz_id=102&amp;utm_term=BANK%E5%9C%B0%E5%9D%80%E6%98%A0%E5%B0%84&amp;utm_medium=distribute.pc_search_result.none-task-blog-2~all~sobaiduweb~default-4-78584820.first_rank_v2_pc_rank_v29_10
     </a>
     ）
    </p>
    <p style="text-indent:33px;">
     <img alt="" height="451" src="https://i-blog.csdnimg.cn/blog_migrate/6103dda580e360797eb61fb64b4e7b71.png" width="180"/>
    </p>
    <h4 id="1%EF%BC%89%E5%88%9B%E5%BB%BA%E5%BC%82%E5%B8%B8%E5%90%91%E9%87%8F%E8%A1%A8">
     1）创建异常向量表
    </h4>
    <p style="text-indent:0;">
     当程序在芯片上运行发生复位异常时，程序指针PC会自动跳转到主存最开始的地址（0x00000000），这里就是异常向量表的起始地址，然后硬件机制会把异常向量表地址中存储的数据（异常服务函数地址）的值赋给指针。（√）
    </p>
    <p style="text-indent:0;">
     ARM处理器内核一共定义了7种异常：复位异常、未定义指令异常、软中断异常、预取址终止异常、数据终止异常、IRQ中断异常、IRQ快速中断异常。
    </p>
    <p style="text-indent:0;">
     所有跳转地址都是在CPU芯片生产时就确定且无法更改的（一般），产生异常时硬件跳转到规定的地址，再通过地址内存储的跳转指令跳转到异常处理程序的起始地址。
    </p>
    <h4 id="2%EF%BC%89%E5%88%9D%E5%A7%8B%E5%8C%96%E5%9F%BA%E6%9C%AC%E7%A1%AC%E4%BB%B6%EF%BC%88CPU%E3%80%81%E4%B8%BB%E5%AD%98%E7%AD%89%EF%BC%89">
     2）初始化基本硬件（CPU、主存等）
    </h4>
    <p style="text-indent:0;">
     从NAND Flash启动，这里面的启动代码包含对CPU、主存的初始化：
    </p>
    <p style="text-indent:0;">
     ①：关闭看门狗、屏蔽中断、
    </p>
    <p style="text-indent:0;">
     ②：设置时钟与PLL、初始化BANK（由于BANL6,7挂载了内存，
     <span style="color:#f33b45;">
      揣测：main函数的地址位于BANK6 ，其物理地址为0x30000000
     </span>
     ）
    </p>
    <h4 id="3%EF%BC%89%E5%88%9D%E5%A7%8B%E5%8C%96%E5%A0%86%E6%A0%88">
     3）初始化堆栈
    </h4>
    <p style="text-indent:0;">
     ARM具有7种不同的模式，由于CPU寄存器是公用的，因此要保存每个模式下面的上下文信息，因此每个模式有其自己的堆栈指针需要初始化
    </p>
    <h4 id="4%EF%BC%89%E5%8A%A0%E8%BD%BD%E5%BA%94%E7%94%A8%E7%A8%8B%E5%BA%8F%E8%BF%90%E8%A1%8C%E7%8E%AF%E5%A2%83">
     4）加载应用程序运行环境
    </h4>
    <p style="text-indent:0;">
     编译过程中会产生arm文件，这里面有应用程序中用户定义的RO ZI RW等类型的数据，需要加载入内存
    </p>
    <h4 id="5%EF%BC%89%E8%B7%B3%E8%BD%AC%E5%88%B0%E4%B8%BB%E7%A8%8B%E5%BA%8F">
     5）跳转到主程序
    </h4>
    <blockquote>
     <p style="text-indent:0;">
      loop main   //  main.c 中 int main (void)
     </p>
    </blockquote>
    <hr/>
    <h2 id="%E4%B8%89%E3%80%81%E6%80%BB%E7%BB%93">
     三、总结
    </h2>
    <p style="text-indent:0;">
     到此问题二的答案很清晰了， 板子执行main函数之前，上电后会触发复位异常，进行启动文件的环境初始化，进行一系列初始化之后，在最后跳入 main（）；
    </p>
    <p style="text-indent:0;">
     因水平有限，还在不断学习的过程中，文中有什么错误，或者解释不好的概念，恳请各位读者附上更好的链接或者批评指正，最后这也是写这么多日志以来第一次系统的总结，如果给你带来一点点启示或者理解，作为激励求一波赞啦~
    </p>
    <p>
    </p>
   </div>
  </div>
 </article>
 <p alt="68747470:733a2f2f626c6f672e6373646e2e6e65742f7a686f75765f2f:61727469636c652f64657461696c732f313135323433303234" class_="artid" style="display:none">
 </p>
</div>


