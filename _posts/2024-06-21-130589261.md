---
layout: post
title: "音视频八股文11-ffmpeg-avio-内存输入和内存输出内存输出有完整代码,网上很少有的"
date: 2024-06-21 17:51:59 +0800
description: "avio是FFmpeg中的一个模块，用于实现多种输入输出方式的封装。avio提供了一系列API，可以"
keywords: "FFmpeg,avio,内存输入"
categories: ['音视频Golang相关']
tags: ['音视频', 'Ffmpeg', 'C']
artid: "130589261"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=130589261
    alt: "音视频八股文11-ffmpeg-avio-内存输入和内存输出内存输出有完整代码,网上很少有的"
render_with_liquid: false
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     音视频八股文（11）-- ffmpeg avio 内存输入和内存输出。内存输出有完整代码，网上很少有的。
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-light" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <h2>
     <a id="1avio_0">
     </a>
     1.avio介绍
    </h2>
    <p>
     avio是FFmpeg中的一个模块，用于实现多种输入输出方式的封装。
    </p>
    <p>
     avio提供了一系列API，可以将数据从内存读取到缓冲区中，也可以将缓冲区中的数据写入到内存中。其实现依赖于IOContext结构体，该结构体定义了当前输入/输出事件的状态、数据、回调函数等信息，并支持通过自定义回调函数实现不同的输入/输出方式。
    </p>
    <p>
     内存输入（Memory Input）是指将数据从内存中读取到缓冲区中，常见的应用场景包括：从内存中读取音视频数据进行解码或处理。在使用avio实现内存输入时，需要首先创建一个AVIOContext结构体，并将内存数据缓冲区作为参数传递给avio_open函数进行初始化。之后，可以使用avio_read函数从缓冲区中读取数据，直至读取完成。
    </p>
    <p>
     内存输出（Memory Output）是指将数据从缓冲区中写入到内存中，常见的应用场景包括：将音视频数据编码并保存到内存中。在使用avio实现内存输出时，需要首先创建一个AVIOContext结构体，并将内存数据缓冲区和缓冲区大小作为参数传递给avio_open函数进行初始化。之后，可以使用avio_write函数将数据写入缓冲区中，并在完成输出后调用avio_close函数关闭AVIOContext结构体。
    </p>
    <p>
     总的来说，内存输入和输出是指在使用FFmpeg进行音视频处理时，将数据从内存中读取或写入到内存中的一种方式。使用avio模块可以方便地实现这种输入输出方式，并支持自定义回调函数以满足不同的应用需求。
    </p>
    <h2>
     <a id="2avio_12">
     </a>
     2.为什么要用avio？
    </h2>
    <p>
     使用FFmpeg的avio模块实现内存输入和输出有以下几个优点：
    </p>
    <h3>
     <a id="21_16">
     </a>
     2.1.灵活性高
    </h3>
    <p>
     传统的音视频处理方式往往需要将音视频数据保存到文件中，然后再进行读取和处理。而使用avio模块可以将数据直接读取或写入到内存中，从而提高了音视频处理的灵活性。这种方式可以避免繁琐的文件IO操作，节省磁盘空间。
    </p>
    <h3>
     <a id="22_20">
     </a>
     2.2.扩展性强
    </h3>
    <p>
     内存输入和输出功能可以方便地扩展为其他更高级的应用程序，例如：流媒体服务器、实时音视频采集与处理等。这是因为内存输出能够较为轻松地将音视频数据编码并存储到内存缓冲区中，进而交由网络传输；内存输入则可直接从内存缓冲区获取音视频数据，快速响应用户请求。
    </p>
    <h3>
     <a id="23_24">
     </a>
     2.3.可定制性好
    </h3>
    <p>
     FFmpeg的avio模块提供了一系列API，可以通过设置回调函数实现各种自定义功能。例如：自定义网络协议传输方式、增加错误重试机制、实现多路复用等。这使得处理器可以根据自己的需求对avio模块进行灵活配置，以最大限度地满足不同场景下的业务需求。
    </p>
    <p>
     因此，使用FFmpeg的avio模块实现内存输入和输出可以提高音视频处理的效率，增加程序的灵活性和扩展性，同时还具有良好的可定制性。
    </p>
    <h2>
     <a id="3_30">
     </a>
     3.内存区作为输入
    </h2>
    <h3>
     <a id="31_32">
     </a>
     3.1.回调函数何时被回调呢？
    </h3>
    <p>
     所有需要从输入源中读取数据的时刻，都将调用回调函数。和输入源是普通文件相比，只不过输入源变成了内存区，其他各种外在表现并无不同。
    </p>
    <p>
     如下各函数在不同的阶段从输入源读数据，都会调用回调函数：
    </p>
    <p>
     avformat_open_input() 从输入源读取封装格式文件头
    </p>
    <p>
     avformat_find_stream_info() 从输入源读取一段数据，尝试解码，以获取流信息
    </p>
    <p>
     av_read_frame() 从输入源读取数据包
    </p>
    <h3>
     <a id="32mp4_44">
     </a>
     3.2.该示例作用是统计mp4文件的视频帧数，代码如下：
    </h3>
    <pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;libavcodec/avcodec.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;libavformat/avformat.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;libavformat/avio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;libavutil/file.h&gt;</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">INPUT_FILE</span> <span class="token string">"1.mp4"</span></span>

<span class="token keyword">struct</span> <span class="token class-name">buffer_data</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">uint8_t</span><span class="token operator">*</span> ptr<span class="token punctuation">;</span>
    <span class="token class-name">size_t</span> size<span class="token punctuation">;</span> <span class="token comment">///&lt; size left in the buffer</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">read_packet</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span> opaque<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span><span class="token operator">*</span> buf<span class="token punctuation">,</span> <span class="token keyword">int</span> buf_size<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">struct</span> <span class="token class-name">buffer_data</span><span class="token operator">*</span> bd <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">buffer_data</span><span class="token operator">*</span><span class="token punctuation">)</span>opaque<span class="token punctuation">;</span>
    buf_size <span class="token operator">=</span> <span class="token function">FFMIN</span><span class="token punctuation">(</span>buf_size<span class="token punctuation">,</span> bd<span class="token operator">-&gt;</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>buf_size<span class="token punctuation">)</span>
        <span class="token keyword">return</span> AVERROR_EOF<span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"ptr:%p size:%zu\n"</span><span class="token punctuation">,</span> bd<span class="token operator">-&gt;</span>ptr<span class="token punctuation">,</span> bd<span class="token operator">-&gt;</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/* copy internal buffer data to buf */</span>
    <span class="token function">memcpy</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> bd<span class="token operator">-&gt;</span>ptr<span class="token punctuation">,</span> buf_size<span class="token punctuation">)</span><span class="token punctuation">;</span>
    bd<span class="token operator">-&gt;</span>ptr <span class="token operator">+=</span> buf_size<span class="token punctuation">;</span>
    bd<span class="token operator">-&gt;</span>size <span class="token operator">-=</span> buf_size<span class="token punctuation">;</span>

    <span class="token keyword">return</span> buf_size<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    AVFormatContext<span class="token operator">*</span> fmt_ctx <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    AVIOContext<span class="token operator">*</span> avio_ctx <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token class-name">uint8_t</span><span class="token operator">*</span> buffer <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token operator">*</span> avio_ctx_buffer <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token class-name">size_t</span> buffer_size<span class="token punctuation">,</span> avio_ctx_buffer_size <span class="token operator">=</span> <span class="token number">4096</span><span class="token punctuation">;</span>
    <span class="token keyword">char</span><span class="token operator">*</span> input_filename <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">buffer_data</span> bd <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span>  videoStreamIndex <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    AVCodecParameters<span class="token operator">*</span> avCodecPara <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> AVCodec<span class="token operator">*</span> codec <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    AVCodecContext<span class="token operator">*</span> codecCtx <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    AVPacket<span class="token operator">*</span> pkt <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>

    input_filename <span class="token operator">=</span> INPUT_FILE<span class="token punctuation">;</span>

    <span class="token comment">/* slurp file content into buffer */</span>
    ret <span class="token operator">=</span> <span class="token function">av_file_map</span><span class="token punctuation">(</span>input_filename<span class="token punctuation">,</span> <span class="token operator">&amp;</span>buffer<span class="token punctuation">,</span> <span class="token operator">&amp;</span>buffer_size<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token keyword">goto</span> end<span class="token punctuation">;</span>

    <span class="token comment">/* fill opaque structure used by the AVIOContext read callback */</span>
    bd<span class="token punctuation">.</span>ptr <span class="token operator">=</span> buffer<span class="token punctuation">;</span>
    bd<span class="token punctuation">.</span>size <span class="token operator">=</span> buffer_size<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>fmt_ctx <span class="token operator">=</span> <span class="token function">avformat_alloc_context</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        ret <span class="token operator">=</span> <span class="token function">AVERROR</span><span class="token punctuation">(</span>ENOMEM<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">goto</span> end<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    avio_ctx_buffer <span class="token operator">=</span> <span class="token function">av_malloc</span><span class="token punctuation">(</span>avio_ctx_buffer_size<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>avio_ctx_buffer<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        ret <span class="token operator">=</span> <span class="token function">AVERROR</span><span class="token punctuation">(</span>ENOMEM<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">goto</span> end<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    avio_ctx <span class="token operator">=</span> <span class="token function">avio_alloc_context</span><span class="token punctuation">(</span>avio_ctx_buffer<span class="token punctuation">,</span> avio_ctx_buffer_size<span class="token punctuation">,</span>
        <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>bd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>read_packet<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>avio_ctx<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        ret <span class="token operator">=</span> <span class="token function">AVERROR</span><span class="token punctuation">(</span>ENOMEM<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">goto</span> end<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    fmt_ctx<span class="token operator">-&gt;</span>pb <span class="token operator">=</span> avio_ctx<span class="token punctuation">;</span>

    ret <span class="token operator">=</span> <span class="token function">avformat_open_input</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>fmt_ctx<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"Could not open input\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">goto</span> end<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    ret <span class="token operator">=</span> <span class="token function">avformat_find_stream_info</span><span class="token punctuation">(</span>fmt_ctx<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"Could not find stream information\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">goto</span> end<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//av_dump_format(fmt_ctx, 0, input_filename, 0);</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"完成\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//循环查找视频中包含的流信息，直到找到视频类型的流</span>
    <span class="token comment">//便将其记录下来 保存到videoStreamIndex变量中</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> fmt_ctx<span class="token operator">-&gt;</span>nb_streams<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>fmt_ctx<span class="token operator">-&gt;</span>streams<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">-&gt;</span>codecpar<span class="token operator">-&gt;</span>codec_type <span class="token operator">==</span> AVMEDIA_TYPE_VIDEO<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            videoStreamIndex <span class="token operator">=</span> i<span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span><span class="token comment">//找到视频流就退出</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//如果videoStream为-1 说明没有找到视频流</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>videoStreamIndex <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"cannot find video stream\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">goto</span> end<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//=================================  查找解码器 ===================================//</span>
    avCodecPara <span class="token operator">=</span> fmt_ctx<span class="token operator">-&gt;</span>streams<span class="token punctuation">[</span>videoStreamIndex<span class="token punctuation">]</span><span class="token operator">-&gt;</span>codecpar<span class="token punctuation">;</span>
    codec <span class="token operator">=</span> <span class="token function">avcodec_find_decoder</span><span class="token punctuation">(</span>avCodecPara<span class="token operator">-&gt;</span>codec_id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>codec <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"cannot find decoder\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">goto</span> end<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//根据解码器参数来创建解码器内容</span>
    codecCtx <span class="token operator">=</span> <span class="token function">avcodec_alloc_context3</span><span class="token punctuation">(</span>codec<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">avcodec_parameters_to_context</span><span class="token punctuation">(</span>codecCtx<span class="token punctuation">,</span> avCodecPara<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>codecCtx <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Cannot alloc context."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">goto</span> end<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//================================  打开解码器 ===================================//</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>ret <span class="token operator">=</span> <span class="token function">avcodec_open2</span><span class="token punctuation">(</span>codecCtx<span class="token punctuation">,</span> codec<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">// 具体采用什么解码器ffmpeg经过封装 我们无须知道</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"cannot open decoder\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">goto</span> end<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//=========================== 分配AVPacket结构体 ===============================//</span>
    <span class="token keyword">int</span>       i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//用于帧计数</span>
    pkt <span class="token operator">=</span> <span class="token function">av_packet_alloc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                      <span class="token comment">//分配一个packet</span>
    <span class="token function">av_new_packet</span><span class="token punctuation">(</span>pkt<span class="token punctuation">,</span> codecCtx<span class="token operator">-&gt;</span>width <span class="token operator">*</span> codecCtx<span class="token operator">-&gt;</span>height<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//调整packet的数据</span>

    <span class="token comment">//===========================  读取视频信息 ===============================//</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token function">av_read_frame</span><span class="token punctuation">(</span>fmt_ctx<span class="token punctuation">,</span> pkt<span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">//读取的是一帧视频  数据存入一个AVPacket的结构中</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>pkt<span class="token operator">-&gt;</span>stream_index <span class="token operator">==</span> videoStreamIndex<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            i<span class="token operator">++</span><span class="token punctuation">;</span><span class="token comment">//只计算视频帧</span>
        <span class="token punctuation">}</span>
        <span class="token function">av_packet_unref</span><span class="token punctuation">(</span>pkt<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//重置pkt的内容</span>
    <span class="token punctuation">}</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"There are %d frames int total.\n"</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>

end<span class="token operator">:</span>
    <span class="token function">avformat_close_input</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>fmt_ctx<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/* note: the internal buffer could have changed, and be != avio_ctx_buffer */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>avio_ctx<span class="token punctuation">)</span>
        <span class="token function">av_freep</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>avio_ctx<span class="token operator">-&gt;</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">avio_context_free</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>avio_ctx<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">av_packet_free</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pkt<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">avcodec_close</span><span class="token punctuation">(</span>codecCtx<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">av_file_unmap</span><span class="token punctuation">(</span>buffer<span class="token punctuation">,</span> buffer_size<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">avformat_free_context</span><span class="token punctuation">(</span>fmt_ctx<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"Error occurred: %s\n"</span><span class="token punctuation">,</span> <span class="token function">av_err2str</span><span class="token punctuation">(</span>ret<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/859f7799be36ea34fe9ea8add5f5fd7f.png"/>
    </p>
    <h2>
     <a id="4_209">
     </a>
     4.内存区作为输出
    </h2>
    <h3>
     <a id="41_211">
     </a>
     4.1.回调函数何时被回调呢？
    </h3>
    <p>
     所有输出数据的时刻，都将调用回调函数。和输出是普通文件相比，只不过输出变成了内存区，其他各种外在表现并无不同。
    </p>
    <p>
     如下各函数在不同的阶段会输出数据，都会调用回调函数：
    </p>
    <p>
     avformat_write_header() 将流头部信息写入输出区
    </p>
    <p>
     av_interleaved_write_frame() 将数据包写入输出区
    </p>
    <p>
     av_write_trailer() 将流尾部信息写入输出区
    </p>
    <h3>
     <a id="42mp4h264write_packet_223">
     </a>
     4.2.该示例作用是提取mp4文件的视频帧为h264文件，输出采用write_packet回调，代码如下：
    </h3>
    <pre><code class="prism language-c"><span class="token comment">//https://www.cnblogs.com/leisure_chn/p/10318145.html</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;libavformat/avformat.h&gt;</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">INPUT_FILE</span> <span class="token string">"1.mp4"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">OUTPUT_FILE</span> <span class="token string">"output.h264"</span></span>

<span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token punctuation">{<!-- --></span>
    FILE<span class="token operator">*</span> fp<span class="token punctuation">;</span>
<span class="token punctuation">}</span> OutputContext<span class="token punctuation">;</span>

<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">write_packet</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span> opaque<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span><span class="token operator">*</span> buf<span class="token punctuation">,</span> <span class="token keyword">int</span> buf_size<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    OutputContext<span class="token operator">*</span> output_ctx <span class="token operator">=</span> <span class="token punctuation">(</span>OutputContext<span class="token operator">*</span><span class="token punctuation">)</span>opaque<span class="token punctuation">;</span>
    FILE<span class="token operator">*</span> fp <span class="token operator">=</span> output_ctx<span class="token operator">-&gt;</span>fp<span class="token punctuation">;</span>

    <span class="token function">fwrite</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> buf_size<span class="token punctuation">,</span> fp<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> buf_size<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    AVFormatContext<span class="token operator">*</span> input_ctx <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    AVOutputFormat<span class="token operator">*</span> output_fmt <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    AVFormatContext<span class="token operator">*</span> output_ctx <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    OutputContext<span class="token operator">*</span> output_opaque <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>

    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">avformat_open_input</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>input_ctx<span class="token punctuation">,</span> INPUT_FILE<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"Error: Could not open input file: %s.\n"</span><span class="token punctuation">,</span> <span class="token function">av_err2str</span><span class="token punctuation">(</span>ret<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">goto</span> end<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    ret <span class="token operator">=</span> <span class="token function">avformat_find_stream_info</span><span class="token punctuation">(</span>input_ctx<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"Error: Could not find stream information: %s.\n"</span><span class="token punctuation">,</span> <span class="token function">av_err2str</span><span class="token punctuation">(</span>ret<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">goto</span> end<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    output_fmt <span class="token operator">=</span> <span class="token function">av_guess_format</span><span class="token punctuation">(</span><span class="token string">"h264"</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>output_fmt<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"Error: Could not guess output format.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ret <span class="token operator">=</span> AVERROR_MUXER_NOT_FOUND<span class="token punctuation">;</span>
        <span class="token keyword">goto</span> end<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    ret <span class="token operator">=</span> <span class="token function">avformat_alloc_output_context2</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>output_ctx<span class="token punctuation">,</span> output_fmt<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> OUTPUT_FILE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"Error: Could not allocate output context: %s.\n"</span><span class="token punctuation">,</span> <span class="token function">av_err2str</span><span class="token punctuation">(</span>ret<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">goto</span> end<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    AVStream<span class="token operator">*</span> in_video_stream <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    AVCodecParameters<span class="token operator">*</span> in_codec_params <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> input_ctx<span class="token operator">-&gt;</span>nb_streams<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        AVStream<span class="token operator">*</span> stream <span class="token operator">=</span> input_ctx<span class="token operator">-&gt;</span>streams<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>stream<span class="token operator">-&gt;</span>codecpar<span class="token operator">-&gt;</span>codec_type <span class="token operator">==</span> AVMEDIA_TYPE_VIDEO<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            in_video_stream <span class="token operator">=</span> stream<span class="token punctuation">;</span>
            in_codec_params <span class="token operator">=</span> stream<span class="token operator">-&gt;</span>codecpar<span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>in_video_stream<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"Error: Could not find video stream.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ret <span class="token operator">=</span> <span class="token function">AVERROR</span><span class="token punctuation">(</span>ENOSYS<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">goto</span> end<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    AVStream<span class="token operator">*</span> out_video_stream <span class="token operator">=</span> <span class="token function">avformat_new_stream</span><span class="token punctuation">(</span>output_ctx<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>out_video_stream<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"Error: Could not create new stream.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ret <span class="token operator">=</span> <span class="token function">AVERROR</span><span class="token punctuation">(</span>ENOMEM<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">goto</span> end<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    ret <span class="token operator">=</span> <span class="token function">avcodec_parameters_copy</span><span class="token punctuation">(</span>out_video_stream<span class="token operator">-&gt;</span>codecpar<span class="token punctuation">,</span> in_codec_params<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"Error: Could not copy codec parameters: %s.\n"</span><span class="token punctuation">,</span> <span class="token function">av_err2str</span><span class="token punctuation">(</span>ret<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">goto</span> end<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    out_video_stream<span class="token operator">-&gt;</span>codecpar<span class="token operator">-&gt;</span>codec_tag <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    output_opaque <span class="token operator">=</span> <span class="token function">av_malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>OutputContext<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>output_opaque<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"Error: Could not allocate output context.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ret <span class="token operator">=</span> <span class="token function">AVERROR</span><span class="token punctuation">(</span>ENOMEM<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">goto</span> end<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">fopen_s</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>output_opaque<span class="token operator">-&gt;</span>fp<span class="token punctuation">,</span> OUTPUT_FILE<span class="token punctuation">,</span> <span class="token string">"wb"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>output_opaque<span class="token operator">-&gt;</span>fp<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"Error: Could not open output file.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ret <span class="token operator">=</span> <span class="token function">AVERROR</span><span class="token punctuation">(</span>ENOENT<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">goto</span> end<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    AVIOContext<span class="token operator">*</span> pb <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    pb <span class="token operator">=</span> <span class="token function">avio_alloc_context</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">av_malloc</span><span class="token punctuation">(</span><span class="token number">32768</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">32768</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> output_opaque<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>write_packet<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>pb<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"Error: Could not allocate output IO context.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ret <span class="token operator">=</span> <span class="token function">AVERROR</span><span class="token punctuation">(</span>ENOMEM<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">goto</span> end<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    output_ctx<span class="token operator">-&gt;</span>pb <span class="token operator">=</span> pb<span class="token punctuation">;</span>

    ret <span class="token operator">=</span> <span class="token function">avformat_write_header</span><span class="token punctuation">(</span>output_ctx<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"Error: Could not write header: %s.\n"</span><span class="token punctuation">,</span> <span class="token function">av_err2str</span><span class="token punctuation">(</span>ret<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">goto</span> end<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    AVPacket packet <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token function">av_read_frame</span><span class="token punctuation">(</span>input_ctx<span class="token punctuation">,</span> <span class="token operator">&amp;</span>packet<span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>packet<span class="token punctuation">.</span>stream_index <span class="token operator">==</span> in_video_stream<span class="token operator">-&gt;</span>index<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">av_packet_rescale_ts</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>packet<span class="token punctuation">,</span> in_video_stream<span class="token operator">-&gt;</span>time_base<span class="token punctuation">,</span> out_video_stream<span class="token operator">-&gt;</span>time_base<span class="token punctuation">)</span><span class="token punctuation">;</span>
            packet<span class="token punctuation">.</span>stream_index <span class="token operator">=</span> out_video_stream<span class="token operator">-&gt;</span>index<span class="token punctuation">;</span>

            ret <span class="token operator">=</span> <span class="token function">av_interleaved_write_frame</span><span class="token punctuation">(</span>output_ctx<span class="token punctuation">,</span> <span class="token operator">&amp;</span>packet<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"Error: Could not write frame: %s.\n"</span><span class="token punctuation">,</span> <span class="token function">av_err2str</span><span class="token punctuation">(</span>ret<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">goto</span> end<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token function">av_packet_unref</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>packet<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    ret <span class="token operator">=</span> <span class="token function">av_write_trailer</span><span class="token punctuation">(</span>output_ctx<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"Error: Could not write trailer: %s.\n"</span><span class="token punctuation">,</span> <span class="token function">av_err2str</span><span class="token punctuation">(</span>ret<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">goto</span> end<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Conversion complete!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
end<span class="token operator">:</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>input_ctx<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">avformat_close_input</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>input_ctx<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>output_ctx<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>output_ctx<span class="token operator">-&gt;</span>pb<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">av_freep</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>output_ctx<span class="token operator">-&gt;</span>pb<span class="token operator">-&gt;</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">avio_context_free</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>output_ctx<span class="token operator">-&gt;</span>pb<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>output_opaque<span class="token operator">-&gt;</span>fp<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">fclose</span><span class="token punctuation">(</span>output_opaque<span class="token operator">-&gt;</span>fp<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">avformat_free_context</span><span class="token punctuation">(</span>output_ctx<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">av_free</span><span class="token punctuation">(</span>output_opaque<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/b90e3496bb0365898953747bee48d77e.png"/>
    </p>
    <h2>
     <a id="5IOavio_alloc_context_385">
     </a>
     5.内存IO模式非常重要的一个函数：avio_alloc_context()
    </h2>
    <pre><code class="prism language-c"><span class="token comment">/**
 * Allocate and initialize an AVIOContext for buffered I/O. It must be later
 * freed with avio_context_free().
 *
 * @param buffer Memory block for input/output operations via AVIOContext.
 *        The buffer must be allocated with av_malloc() and friends.
 *        It may be freed and replaced with a new buffer by libavformat.
 *        AVIOContext.buffer holds the buffer currently in use,
 *        which must be later freed with av_free().
 * @param buffer_size The buffer size is very important for performance.
 *        For protocols with fixed blocksize it should be set to this blocksize.
 *        For others a typical size is a cache page, e.g. 4kb.
 * @param write_flag Set to 1 if the buffer should be writable, 0 otherwise.
 * @param opaque An opaque pointer to user-specific data.
 * @param read_packet  A function for refilling the buffer, may be NULL.
 *                     For stream protocols, must never return 0 but rather
 *                     a proper AVERROR code.
 * @param write_packet A function for writing the buffer contents, may be NULL.
 *        The function may not change the input buffers content.
 * @param seek A function for seeking to specified byte position, may be NULL.
 *
 * @return Allocated AVIOContext or NULL on failure.
 */</span>
AVIOContext <span class="token operator">*</span><span class="token function">avio_alloc_context</span><span class="token punctuation">(</span>
                  <span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>buffer<span class="token punctuation">,</span>
                  <span class="token keyword">int</span> buffer_size<span class="token punctuation">,</span>
                  <span class="token keyword">int</span> write_flag<span class="token punctuation">,</span>
                  <span class="token keyword">void</span> <span class="token operator">*</span>opaque<span class="token punctuation">,</span>
                  <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>read_packet<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>opaque<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> <span class="token operator">*</span>buf<span class="token punctuation">,</span> <span class="token keyword">int</span> buf_size<span class="token punctuation">)</span><span class="token punctuation">,</span>
                  <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>write_packet<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>opaque<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> <span class="token operator">*</span>buf<span class="token punctuation">,</span> <span class="token keyword">int</span> buf_size<span class="token punctuation">)</span><span class="token punctuation">,</span>
                  <span class="token class-name">int64_t</span> <span class="token punctuation">(</span><span class="token operator">*</span>seek<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>opaque<span class="token punctuation">,</span> <span class="token class-name">int64_t</span> offset<span class="token punctuation">,</span> <span class="token keyword">int</span> whence<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <p>
     这是FFmpeg中用于创建AVIOContext结构体的函数 avio_alloc_context 的代码注释。
    </p>
    <p>
     该函数具有以下参数：
    </p>
    <ul>
     <li>
      <p>
       buffer：存储音视频数据的内存缓冲区指针，必须通过 av_malloc() 等函数分配。该内存块会被 AVIOContext 结构体引用，不能在生命周期内被释放。
      </p>
     </li>
     <li>
      <p>
       buffer_size：缓冲区大小，对于固定块大小的协议需要设置为固定块大小，对于其他协议可以设置为典型缓存页大小，例如 4KB。
      </p>
     </li>
     <li>
      <p>
       write_flag：标记是否可写，1 表示可写，0 表示只读。
      </p>
     </li>
     <li>
      <p>
       opaque：用户指定的不透明指针，用于在回调函数中携带自定义数据。
      </p>
     </li>
     <li>
      <p>
       read_packet：read_packet 回调函数，用于本地文件或网络流传输时从输入源中读取数据。当 buffer 中的数据被消耗完后，调用此函数填充缓冲区。
      </p>
     </li>
     <li>
      <p>
       write_packet：write_packet 回调函数，在可写模式下用于将缓冲区中的数据写入输出源，例如本地文件或网络流。
      </p>
     </li>
     <li>
      <p>
       seek：seek 回调函数，用于跳转到指定字节位置。
      </p>
     </li>
    </ul>
    <p>
     该函数主要用于在 FFmpeg 内部创建一个 AVIOContext 结构体，该结构体用于管理读取或写入内存缓冲区的音视频数据，并提供了一些 API 函数用于处理缓冲区数据。一旦创建了 AVIOContext 结构体，就可以通过调用 avio_open2() 函数来打开对应的输入或输出资源，然后即可开始读写数据。
    </p>
    <p>
     在使用完毕后，需要通过调用 avio_context_free() 函数来释放 AVIOContext 结构体占用的内存空间。
    </p>
    <h2>
     <a id="6_443">
     </a>
     6.两个示例的环境
    </h2>
    <p>
     操作系统：win10 64位
    </p>
    <p>
     开发环境：VS2022
    </p>
    <p>
     vcpkg命令：
    </p>
    <pre><code class="prism language-bash"><span class="token function">vcpkg</span> <span class="token function">install</span> ffmpeg:x64-windows
</code></pre>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/f78049572d9bcf22a90a40f39cc431ca.png"/>
    </p>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
  <div class="blog-extension-box" id="blogExtensionBox" style="width:400px;margin:auto;margin-top:12px">
  </div>
 </article>
 <p alt="68747470733a2f2f626c6f672e:6373646e2e6e65742f77656978696e5f34383530323036322f:61727469636c652f64657461696c732f313330353839323631" class_="artid" style="display:none">
 </p>
</div>


