---
layout: post
title: "前端如何控制并发请求"
date: 2025-01-09 12:02:59 +0800
description: "文章浏览阅读2.6k次，点赞56次，比如接口一次返回，数据很多，让浏览器渲染卡顿甚至崩溃，这时候我们"
keywords: "前端控制并发请求"
categories: ['Js']
tags: ['前端']
artid: "140258195"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=140258195
    alt: "前端如何控制并发请求"
render_with_liquid: false
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     前端如何控制并发请求
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-github-gist" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <p>
    </p>
    <div class="toc">
     <h4>
      前端如何控制并发请求
     </h4>
     <ul>
      <li>
       <ul>
        <li>
         <a href="#_6" rel="nofollow">
          前端控制并发请求的关键思路
         </a>
        </li>
        <li>
         <ul>
          <li>
           <a href="#api__12" rel="nofollow">
            api 设计
           </a>
          </li>
          <li>
           <a href="#_18" rel="nofollow">
            代码实现
           </a>
          </li>
          <li>
           <a href="#_67" rel="nofollow">
            关键代码解读
           </a>
          </li>
          <li>
           <a href="#_Promise__131" rel="nofollow">
            循环和 Promise 结合是怎样使用的呢？
           </a>
          </li>
         </ul>
        </li>
        <li>
         <a href="#_api_141" rel="nofollow">
          完善 api，让其更加易用
         </a>
        </li>
        <li>
         <a href="#_pcontrol_npm__169" rel="nofollow">
          把上述功能封装成 `p-control` npm 包发布
         </a>
        </li>
        <li>
         <a href="#_175" rel="nofollow">
          小结
         </a>
        </li>
       </ul>
      </li>
     </ul>
    </div>
    <p>
    </p>
    <p>
     什么情况需要前端控制并发请求，在需要多次才能请求完所需数据的时候。比如接口一次返回，数据很多，让浏览器渲染卡顿甚至崩溃，这时候我们可以分批同时发出6个请求，这样就可以避免卡顿或者崩溃。
    </p>
    <p>
     那么前端如何控制并发请求呢？
    </p>
    <h3>
     <a id="_6">
     </a>
     前端控制并发请求的关键思路
    </h3>
    <p>
     比如有 20 个请求，需要按照
     <code>
      3
     </code>
     个一组，第一组请求完毕后再请求第二组，以此类推。
    </p>
    <p>
     关键思路，把请求方法和请求参数使用一个数组存起来，然后每次请求3个，请求完毕后再请求下一个3个。每组请求返回后，把结果保存起来，等所有请求都返回后，再把所有结果返回。
    </p>
    <h4>
     <a id="api__12">
     </a>
     api 设计
    </h4>
    <p>
     <code>
      pControl
     </code>
     : 并发请求控制器, 传递最大并发数;
     <br/>
     <code>
      add
     </code>
     : 添加请求和参数;
     <br/>
     <code>
      start
     </code>
     : 开始请求，返回promise, 请求完毕后通过
     <code>
      .then
     </code>
     获取所有结果;
    </p>
    <h4>
     <a id="_18">
     </a>
     代码实现
    </h4>
    <pre><code class="prism language-js"><span class="token keyword">function</span> <span class="token function">pControl</span><span class="token punctuation">(</span><span class="token parameter">limit</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">const</span> taskQueue <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token comment">// {task: Function, params: any[]}[]</span>
  <span class="token keyword">return</span> <span class="token punctuation">{<!-- --></span>
    add<span class="token punctuation">,</span>
    start
  <span class="token punctuation">}</span>

  <span class="token keyword">function</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token parameter">task<span class="token punctuation">,</span> params</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    taskQueue<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
      task<span class="token punctuation">,</span>
      params
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">function</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token function">runAllTasks</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">function</span> <span class="token function">runAllTasks</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">const</span> allResults <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>

      <span class="token function">runTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

      <span class="token keyword">function</span> <span class="token function">runTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>taskQueue<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token comment">// 递归结束</span>
          <span class="token keyword">return</span> <span class="token function">resolve</span><span class="token punctuation">(</span>allResults<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">const</span> needRunSize <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>taskQueue<span class="token punctuation">.</span>length<span class="token punctuation">,</span> limit<span class="token punctuation">)</span>
        <span class="token keyword">const</span> tasks <span class="token operator">=</span> taskQueue<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> needRunSize<span class="token punctuation">)</span>
        <span class="token keyword">const</span> promises <span class="token operator">=</span> tasks<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{<!-- --></span>
          task<span class="token punctuation">,</span>
          params
        <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">task</span><span class="token punctuation">(</span>params<span class="token punctuation">)</span><span class="token punctuation">)</span>
        Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span>promises<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resList</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
          allResults<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token operator">...</span>resList<span class="token punctuation">)</span>
          <span class="token comment">// NOTE 递归调用的位置很关键</span>
          <span class="token function">runTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <h4>
     <a id="_67">
     </a>
     关键代码解读
    </h4>
    <ul>
     <li>
      <p>
       <code>
        pControl
       </code>
       : 这个函数返回一个对象，包含
       <code>
        add
       </code>
       和
       <code>
        start
       </code>
       两个方法，
       <code>
        add
       </code>
       用来添加任务和参数，
       <code>
        start
       </code>
       用来开始请求，是一个闭包。
      </p>
     </li>
     <li>
      <p>
       <code>
        runAllTasks
       </code>
       : 返回一个
       <code>
        promise
       </code>
       ，然后在
       <code>
        new Promise
       </code>
       内部递归地执行
       <code>
        runTask
       </code>
       , runTask 通过
       <code>
        Promise.all
       </code>
       执行并发请求，在
       <code>
        Promise.all().then()
       </code>
       再次调用
       <code>
        runTask
       </code>
       ，实现一组请求返回，再执行第二组请求。
      </p>
     </li>
    </ul>
    <blockquote>
     <p>
      实现分组等待的关键是在
      <code>
       .then
      </code>
      中递归调用。
     </p>
    </blockquote>
    <blockquote>
     <p>
      思考： runAllTasks 可以使用循环实现吗？
     </p>
    </blockquote>
    <p>
     能，需要使用
     <code>
      async 和 for 循环 + await
     </code>
     ：
    </p>
    <pre><code class="prism language-js"><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">runAllTasks2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">const</span> allResults <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token keyword">const</span> groupArr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token keyword">let</span> startIndex <span class="token operator">=</span> <span class="token number">0</span>
  <span class="token comment">// 划分分组</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>startIndex <span class="token operator">&lt;</span> taskQueue<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">const</span> arr <span class="token operator">=</span> taskQueue<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>startIndex<span class="token punctuation">,</span> startIndex <span class="token operator">+</span> limit<span class="token punctuation">)</span>
    groupArr<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>arr<span class="token punctuation">)</span>
    startIndex <span class="token operator">+=</span> limit
  <span class="token punctuation">}</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> index <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> index <span class="token operator">&lt;</span> groupArr<span class="token punctuation">.</span>length<span class="token punctuation">;</span> index<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">const</span> pList <span class="token operator">=</span> groupArr<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{<!-- --></span>
      task<span class="token punctuation">,</span>
      params
    <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">task</span><span class="token punctuation">(</span>params<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token keyword">await</span> Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span>pList<span class="token punctuation">)</span>
    allResults<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token operator">...</span>res<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> allResults
<span class="token punctuation">}</span>
</code></pre>
    <blockquote>
     <p>
      在 for 中循环中不能使用
      <code>
       .then
      </code>
      ，否则下一次循环不会等待上一次循环。
     </p>
    </blockquote>
    <p>
     使用
     <code>
      for of
     </code>
     迭代实现：
    </p>
    <pre><code class="prism language-js"><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">runAllTasks2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">const</span> allResults <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token keyword">const</span> groupArr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token keyword">let</span> startIndex <span class="token operator">=</span> <span class="token number">0</span>
  <span class="token comment">// 划分分组</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>startIndex <span class="token operator">&lt;</span> taskQueue<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">const</span> arr <span class="token operator">=</span> taskQueue<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>startIndex<span class="token punctuation">,</span> startIndex <span class="token operator">+</span> limit<span class="token punctuation">)</span>
    groupArr<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>arr<span class="token punctuation">)</span>
    startIndex <span class="token operator">+=</span> limit
  <span class="token punctuation">}</span>
  <span class="token comment">// 迭代分组</span>
  <span class="token keyword">const</span> it <span class="token operator">=</span> groupArr<span class="token punctuation">.</span><span class="token function">entries</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token punctuation">[</span>key<span class="token punctuation">,</span> value<span class="token punctuation">]</span> <span class="token keyword">of</span> it<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">const</span> pList <span class="token operator">=</span> value<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{<!-- --></span>
      task<span class="token punctuation">,</span>
      params
    <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">task</span><span class="token punctuation">(</span>params<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token keyword">await</span> Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span>pList<span class="token punctuation">)</span>
    allResults<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token operator">...</span>res<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> allResults
<span class="token punctuation">}</span>
</code></pre>
    <h4>
     <a id="_Promise__131">
     </a>
     循环和 Promise 结合是怎样使用的呢？
    </h4>
    <p>
     <code>
      for
     </code>
     、
     <code>
      while
     </code>
     、
     <code>
      for...of
     </code>
     等命令式循环结构，想要在循环中实现等待效果，必须使用
     <code>
      async
     </code>
     函数包裹循环中的
     <code>
      await
     </code>
     ，不能使用
     <code>
      .then
     </code>
     。
    </p>
    <p>
     <code>
      forEach
     </code>
     、
     <code>
      map
     </code>
     、
     <code>
      filter
     </code>
     等函数式循环结构，不支持等待效果，因为这些函数式循环结构是同步的，不支持等待。
    </p>
    <blockquote>
     <p>
      <code>
       async
      </code>
      和
      <code>
       循环
      </code>
      +
      <code>
       await
      </code>
      结合，实现循环之间等待效果。
     </p>
    </blockquote>
    <blockquote>
     <p>
      <code>
       promise.then
      </code>
      和
      <code>
       递归
      </code>
      结合，实现循环之间等待效果。
     </p>
    </blockquote>
    <h3>
     <a id="_api_141">
     </a>
     完善 api，让其更加易用
    </h3>
    <ol>
     <li>
      设置默认参数：给
      <code>
       pControl
      </code>
      设置一个合适的默认值，设置为
      <code>
       6
      </code>
      ，因为同一个域名在，浏览器的并发请求是 6 个。
     </li>
     <li>
      start给回调：通过回调能拿到每个分组的请求结果和知道当前完成的请求数量。
     </li>
    </ol>
    <p>
     这两个改进很简单。先看用法：
    </p>
    <pre><code class="prism language-js"><span class="token keyword">const</span> asyncTaskControl <span class="token operator">=</span> <span class="token function">pControl</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 默认 6 </span>
asyncTaskControl<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>task<span class="token punctuation">,</span> params1<span class="token punctuation">)</span>
asyncTaskControl<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>task<span class="token punctuation">,</span> params2<span class="token punctuation">)</span>
<span class="token comment">// ...</span>
asyncTaskControl<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>task<span class="token punctuation">,</span> params10<span class="token punctuation">)</span>

asyncTaskControl<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">res<span class="token punctuation">,</span> doneSize</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
  <span class="token comment">// 获取每组请求的结果 和当前完成了多少请求</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span> <span class="token comment">// [{index:number,result:data}] </span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>doneSize<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">allResults</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
  <span class="token comment">// 所有请求结果</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>allResults<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre>
    <blockquote>
     <p>
      start 回调有什么作用呢？
     </p>
    </blockquote>
    <p>
     方便使用者拿当前并发请求的结果，方便计算完成进度。
    </p>
    <h3>
     <a id="_pcontrol_npm__169">
     </a>
     把上述功能封装成
     <code>
      p-control
     </code>
     npm 包发布
    </h3>
    <p>
     <a href="https://www.npmjs.com/package/p-control" rel="nofollow">
      npm: p-control
     </a>
    </p>
    <p>
     可通过
     <code>
      npm i p-control
     </code>
     下载使用。
    </p>
    <h3>
     <a id="_175">
     </a>
     小结
    </h3>
    <ul>
     <li>
      <code>
       .then
      </code>
      和递归结合，实现异步任务之间等待；
     </li>
     <li>
      <code>
       for
      </code>
      、
      <code>
       while
      </code>
      等循环和
      <code>
       async
      </code>
      +
      <code>
       await
      </code>
      结合使用，实现异步任务之间等待；
     </li>
     <li>
      使用
      <code>
       Promise.all
      </code>
      实现多个异步任务并发执行。
     </li>
    </ul>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f626c:6f672e6373646e2e6e65742f4a61636b5a686f754d696e652f:61727469636c652f64657461696c732f313430323538313935" class_="artid" style="display:none">
 </p>
</div>


