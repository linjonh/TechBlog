---
layout: post
title: "QT-C实践超详细数据库的连接和增删改查操作附源码"
date: 2024-02-28 17:16:55 +0800
description: "文章浏览阅读4.1k次，点赞30次，🪧什么情况需要数据库?如果不是上面的原因化，🪧二者区别在于，前者"
keywords: "c++连接mysql数据库增删改查"
categories: ['Qt']
tags: ['数据库', 'Qt', 'C']
artid: "136326235"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=136326235
    alt: "QT-C实践超详细数据库的连接和增删改查操作附源码"
render_with_liquid: false
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     QT C++实践|超详细数据库的连接和增删改查操作|附源码
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-dracula" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <h2>
     <a id="0_0">
     </a>
     0：前言
    </h2>
    <p>
     🪧
     <b>
      <font color="#6ab04c">
       什么情况需要数据库?
      </font>
     </b>
    </p>
    <ul>
     <li>
      1 大规模的数据需要处理（比如上千上万的数据量）
     </li>
     <li>
      2 需要把数据信息存储起来，无论是本地还是服务上，而不是断电后数据信息就消失了。
     </li>
    </ul>
    <p>
     如果不是上面的原因化，一般可以使用数组来处理。
    </p>
    <p>
     🪧一般常使用的数据库驱动是
     <strong>
      MYSQL
     </strong>
     和
     <strong>
      QSQLITE
     </strong>
     。二者区别在于，前者用于服务器存储信息，后者用于本地存储信息。并且QSQLITE主要用于嵌入式，占用资源非常低，占用内存小，通常几百k就搞定。’
    </p>
    <blockquote>
     <p>
      这里博主因为对
      <code>
       MySQL
      </code>
      熟悉一些，就使用
      <code>
       MySQL
      </code>
      来进行数据库的连接
     </p>
    </blockquote>
    <h2>
     <a id="Mysql_9">
     </a>
     一、Mysql的安装
    </h2>
    <p>
     因为我们项目的方案是程序的运行以及相关数据的存储都在一台主机上，所以不论打不打包。首先要在主机上安装
     <code>
      Mysql
     </code>
     的。
     <code>
      Mysql
     </code>
     的安装教程我参考的是这个：
     <a href="https://zhuanlan.zhihu.com/p/654087404" rel="nofollow">
      MySQL安装和配置教程（超详细版本）
     </a>
    </p>
    <p>
     安装好后，利用命令行或其他工具在MySQL中创建一个存储项目数据的数据库，方便之后使用QT用代码对数据库进行连接、建表和增删改查的操作：
    </p>
    <ul>
     <li>
      <code>
       Win+r
      </code>
      打开cmd：输入命令“mysql -u root -p”，按下回车键
     </li>
     <li>
      输入MySQL密码，按下回车键
     </li>
     <li>
      创建数据库
     </li>
    </ul>
    <pre><code class="prism language-sql"><span class="token keyword">create</span> <span class="token keyword">database</span> <span class="token punctuation">[</span><span class="token keyword">if</span> <span class="token operator">not</span> <span class="token keyword">exists</span><span class="token punctuation">]</span> 数据库名 <span class="token punctuation">[</span><span class="token keyword">default</span> <span class="token keyword">charset</span> 字符集<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token keyword">collate</span> 排序规则<span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre>
    <blockquote>
     <p>
      注意：不要忘记末尾的分号
     </p>
    </blockquote>
    <h2>
     <a id="ODBCMySQL_22">
     </a>
     二、通过ODBC连接MySQL数据库
    </h2>
    <p>
     官方解释:
     <br/>
     ODBC（Open Database Connectivity，开放数据库互连）提供了一种标准的API（应用程序编程接口）方法来访问数据库管理系统（DBMS）。这些API利用SQL来完成其大部分任务。ODBC本身也提供了对SQL语言的支持，用户可以直接将SQL语句送给ODBC。ODBC的设计者们努力使它具有最大的独立性和开放性：与具体的编程语言无关，与具体的数据库系统无关，与具体的操作系统无关。
     <br/>
     简单的说就是我的qt中含有ODBC的驱动：
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/6183365bcea5b3d21ff316c18632b9df.png">
      <br/>
      所以利用ODBC去使用MySQL的数据库
     </img>
    </p>
    <h3>
     <a id="21ODBC_29">
     </a>
     2.1：下载ODBC
    </h3>
    <p>
     <a href="https://dev.mysql.com/downloads/connector/odbc/" rel="nofollow">
      官网
     </a>
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/4edd13a0af9c444d48c36ba0b976bbe7.png"/>
    </p>
    <blockquote>
     <p>
      选择和qt编译器相同的字节比如我的qt使用的是64字节的
     </p>
    </blockquote>
    <p>
     下载完成后，点卡下载下来的
     <code>
      .msi
     </code>
     文件并运行：
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/bc5b29092d5d8f0f809c4500431e4c29.png">
      <br/>
      下载一直点击
      <code>
       next
      </code>
      ：
      <br/>
      <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/680afba31875409819f234978a55aea4.png"/>
     </img>
    </p>
    <p>
     选择
     <code>
      custom
     </code>
     ,表示自定义安装（以便修改安装位置）
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/c0efc6a051cff19e8706dd97eb72182d.png">
      <br/>
      <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/3af118316d47692ec28ce531c27e21ca.png"/>
     </img>
    </p>
    <p>
     最后一直点击
     <code>
      next
     </code>
     然后再
     <code>
      install
     </code>
     即可，等待安装好后即可。
    </p>
    <p>
     安装好之后，关闭窗口，搜索
     <code>
      ODBC
     </code>
     ,并运行程序：
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/796a98b8518b1094bc6f511ad8155bdb.png"/>
    </p>
    <h3>
     <a id="22ODBCMySQL_50">
     </a>
     2.2：使用ODBC连接MySQL数据库
    </h3>
    <p>
     添加MySQL的DSN
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/4bde30100e848277db26e14206876fd3.png"/>
    </p>
    <p>
     红色的可以随便填,是自己对于ODBC驱动的描述,粉色的是MySQL的用户名和密码,数据库选择你在MySQL中创建的数据库名字即可：
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/64bd94efb5544bb4c827047a74bd494a.png"/>
    </p>
    <p>
     点击
     <code>
      Test
     </code>
     ，测试是否能够成功连接；如果出现下图说明连接成功
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/a0b9191bbb5cf0a2973442a939535f34.png"/>
    </p>
    <p>
     然后点击
     <code>
      应用
     </code>
     和
     <code>
      确定
     </code>
     进行添加：
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/5f6904874b87d80068425855122cd9cc.png"/>
    </p>
    <h3>
     <a id="23qtODBCMySQL_65">
     </a>
     2.3：qt通过ODBC连接MySQL
    </h3>
    <p>
     现在
     <code>
      main.cpp
     </code>
     中加入下面代码测试一下能不能在qt中连接成功：
    </p>
    <pre><code class="prism language-cpp">QSqlDatabase db <span class="token operator">=</span> <span class="token class-name">QSqlDatabase</span><span class="token double-colon punctuation">::</span><span class="token function">addDatabase</span><span class="token punctuation">(</span><span class="token string">"QODBC"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    db<span class="token punctuation">.</span><span class="token function">setHostName</span><span class="token punctuation">(</span><span class="token string">"127.0.0.1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    db<span class="token punctuation">.</span><span class="token function">setPort</span><span class="token punctuation">(</span><span class="token number">3306</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    db<span class="token punctuation">.</span><span class="token function">setDatabaseName</span><span class="token punctuation">(</span><span class="token string">"是你在ODBC中创建的Data　source　ｎａｍｅ"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    db<span class="token punctuation">.</span><span class="token function">setUserName</span><span class="token punctuation">(</span><span class="token string">"用户名"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    db<span class="token punctuation">.</span><span class="token function">setPassword</span><span class="token punctuation">(</span><span class="token string">"密码"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">bool</span> ok <span class="token operator">=</span> db<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ok<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token class-name">QMessageBox</span><span class="token double-colon punctuation">::</span><span class="token function">information</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token string">"infor"</span><span class="token punctuation">,</span> <span class="token string">"success"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">QMessageBox</span><span class="token double-colon punctuation">::</span><span class="token function">information</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token string">"infor"</span><span class="token punctuation">,</span> <span class="token string">"open failed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">qDebug</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&lt;&lt;</span><span class="token string">"error open database because"</span><span class="token operator">&lt;&lt;</span>db<span class="token punctuation">.</span><span class="token function">lastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

</code></pre>
    <p>
     Tips:这里可能会报错：VS2019 C1083 无法打开包括文件: “QSqlDatabase”
    </p>
    <p>
     是vs里面项目配置的问题。
     <br/>
     看到这个错误应该是没有dll，然后sql很容易想到数据库，所以在qt模块里添加，比较方便。
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/64646509d6dff35c680e7b5aae339ccf.png"/>
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/a834a6dbadb2f1e66f8ddcfe19006e54.png"/>
    </p>
    <p>
     不出意外运行程序可以成功连接：
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/40c136332a61f703a239bf9eadd94f8c.png"/>
    </p>
    <blockquote>
     <p>
      之后在主机进行安装时，除了打包程序，应该还需要安装对应的Mysql和ODBC
     </p>
    </blockquote>
    <h3>
     <a id="24qtODBC_97">
     </a>
     2.4：qt通过ODBC操作数据库
    </h3>
    <p>
     连接上数据库一般就是使用数据库，进行对数据库的增删改查。
     <br/>
     这里有三种方法。
    </p>
    <h4>
     <a id="240_101">
     </a>
     2.4.0：前言
    </h4>
    <p>
     🪧
     <b>
      首先单独建立一个头文件来处理数据库连接，如建立头文件
      <code>
       connection.h
      </code>
      :
     </b>
    </p>
    <pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">CONNECTION_H</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">CONNECTION_H</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;QMessageBox&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;QSqlDatabase&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;QSqlQuery&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;QDebug&gt;</span></span>

<span class="token keyword">static</span> <span class="token keyword">bool</span> <span class="token function">createConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    <span class="token comment">//连接第一个数据库</span>
    <span class="token comment">//QMYSQL</span>
    QSqlDatabase db <span class="token operator">=</span> <span class="token class-name">QSqlDatabase</span><span class="token double-colon punctuation">::</span><span class="token function">addDatabase</span><span class="token punctuation">(</span><span class="token string">"QMYSQL"</span><span class="token punctuation">,</span> <span class="token string">"connection1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//需要使用的数据库驱动和联检建立的名称（方便建立多个数据库连接【使用不同的数据库时】区分）</span>
    db<span class="token punctuation">.</span><span class="token function">setHostName</span><span class="token punctuation">(</span><span class="token string">"127.0.0.1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//连接地址</span>
    db<span class="token punctuation">.</span><span class="token function">setUserName</span><span class="token punctuation">(</span><span class="token string">"root"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//数据库账户</span>
    db<span class="token punctuation">.</span><span class="token function">setPassword</span><span class="token punctuation">(</span><span class="token string">"root"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//密码</span>
    db<span class="token punctuation">.</span><span class="token function">setPort</span><span class="token punctuation">(</span><span class="token number">8889</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//端口</span>
    <span class="token comment">//test_majiang.db</span>
    db<span class="token punctuation">.</span><span class="token function">setDatabaseName</span><span class="token punctuation">(</span><span class="token string">"test_majiang"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//需要用到的数据库</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>db<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token comment">//如果数据库连接失败，则弹出</span>
        <span class="token comment">//critical(QWidget *parent, const QString &amp;title,</span>
        <span class="token comment">//const QString &amp;text,</span>
        <span class="token comment">//QMessageBox::StandardButtons buttons = Ok,</span>
        <span class="token comment">//QMessageBox::StandardButton defaultButton = NoButton)</span>
           <span class="token class-name">QMessageBox</span><span class="token double-colon punctuation">::</span><span class="token function">critical</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">"Cannot open database"</span><span class="token punctuation">,</span>
                                 <span class="token string">"Unable to establish a database connection"</span><span class="token punctuation">,</span> QMessageBox<span class="token double-colon punctuation">::</span>Cancel<span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">// CONNECTION_H</span></span>
</code></pre>
    <p>
     如果需要移除一个数据库连接，可以使用:
    </p>
    <pre><code class="prism language-cpp"> <span class="token class-name">QSqlDatabase</span><span class="token double-colon punctuation">::</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//关闭数据库</span>
 <span class="token class-name">QSqlDatabase</span><span class="token double-colon punctuation">::</span><span class="token function">removeDatabase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//移除该连接</span>
</code></pre>
    <p>
     在 Qt 中，QSqlDatabase::close() 和 QSqlDatabase::removeDatabase() 是用来关闭和移除数据库连接的。这两个函数通常一起使用，首先关闭数据库连接，然后移除该连接。这是为了确保资源被正确地释放。
     <br/>
     以下是一个示例，展示了如何使用这两个函数：
    </p>
    <pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;QSqlDatabase&gt;</span></span>

<span class="token comment">// 假设你已经创建了一个名为 "MyDbConnection" 的数据库连接</span>

<span class="token comment">// 首先，关闭数据库连接</span>
QSqlDatabase db <span class="token operator">=</span> <span class="token class-name">QSqlDatabase</span><span class="token double-colon punctuation">::</span><span class="token function">database</span><span class="token punctuation">(</span><span class="token string">"MyDbConnection"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>db<span class="token punctuation">.</span><span class="token function">isOpen</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    db<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 然后，从连接池中移除该连接</span>
<span class="token class-name">QSqlDatabase</span><span class="token double-colon punctuation">::</span><span class="token function">removeDatabase</span><span class="token punctuation">(</span><span class="token string">"MyDbConnection"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <p>
     重要的是要注意，你应该只在确保
     <strong>
      没有其他 QSqlDatabase 对象使用同一个连接名时才移除该数据库连接
     </strong>
     。这是因为 QSqlDatabase 使用的是
     <strong>
      共享连接
     </strong>
     ，即如果你有多个 QSqlDatabase 对象使用相同的连接名，它们实际上是在使用同一个连接。
     <strong>
      当最后一个使用该连接的 QSqlDatabase 对象被销毁或关闭时，连接才会被真正关闭
     </strong>
     。所以在调用 removeDatabase() 前要确保所有的 QSqlDatabase 对象都已经不再需要这个连接了
    </p>
    <h4>
     <a id="241QSqlQuery_165">
     </a>
     2.4.1：使用QSqlQuery
    </h4>
    <p>
     头文件
    </p>
    <pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"connection.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;QVariant&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;QSqlDriver&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;QSqlRecord&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;QSqlField&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;QSqlError&gt;</span></span>
</code></pre>
    <ul>
     <li>
      <b>
       <i>
        <font color="#ff4757">
         使用数据库前的准备：
        </font>
       </i>
      </b>
     </li>
    </ul>
    <pre><code class="prism language-cpp">    <span class="token comment">//创建数据库连接</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">createConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token comment">//返回情况可以替换，视不同情况而定</span>
	<span class="token comment">//指定某个数据库连接</span>
    QSqlDatabase db2 <span class="token operator">=</span> <span class="token class-name">QSqlDatabase</span><span class="token double-colon punctuation">::</span><span class="token function">database</span><span class="token punctuation">(</span><span class="token string">"connection1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <ul>
     <li>
      <b>
       <i>
        <font color="#ff4757">
         开始对数据进行操作：
         <br/>
         首先创建QSqlQuery 对象，然后进行操作。
        </font>
       </i>
      </b>
     </li>
    </ul>
    <pre><code class="prism language-cpp">    QSqlQuery <span class="token function">query2</span><span class="token punctuation">(</span>db2<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <ul>
     <li>
      <b>
       <i>
        <font color="#ff4757">
         进行创表和插入值：
        </font>
       </i>
      </b>
     </li>
    </ul>
    <pre><code class="prism language-cpp">   <span class="token comment">// qDebug() &lt;&lt; "connection2:";</span>
   <span class="token comment">//创建表，并插入值</span>
       query2<span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span><span class="token string">"create table student (id int primary key,"</span>
               <span class="token string">"name varchar(20))"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    query2<span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span><span class="token string">"insert into student values(0, 'Mike')"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    query2<span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span><span class="token string">"insert into student values(1, 'Lili')"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    query2<span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span><span class="token string">"insert into student values(2, 'Jame')"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <ul>
     <li>
      <b>
       <i>
        <font color="#ff4757">
         where条件更新
        </font>
       </i>
      </b>
     </li>
    </ul>
    <pre><code class="prism language-cpp"> <span class="token comment">//创建数据库连接(将结果写入数据库）</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">createConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
   <span class="token comment">//指定某个数据库连接</span>
   QSqlDatabase db <span class="token operator">=</span> <span class="token class-name">QSqlDatabase</span><span class="token double-colon punctuation">::</span><span class="token function">database</span><span class="token punctuation">(</span><span class="token string">"connection1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   QSqlQuery <span class="token function">query</span><span class="token punctuation">(</span>db<span class="token punctuation">)</span><span class="token punctuation">;</span>
   query<span class="token punctuation">.</span><span class="token function">prepare</span><span class="token punctuation">(</span><span class="token string">"UPDATE floor SET ActNutCnt = :ActNutCnt WHERE floorID = :floorID AND wtID = :wtID"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

   query<span class="token punctuation">.</span><span class="token function">bindValue</span><span class="token punctuation">(</span><span class="token string">":ActNutCnt"</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   query<span class="token punctuation">.</span><span class="token function">bindValue</span><span class="token punctuation">(</span><span class="token string">":floorID"</span><span class="token punctuation">,</span> <span class="token string">"F001"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   query<span class="token punctuation">.</span><span class="token function">bindValue</span><span class="token punctuation">(</span><span class="token string">":wtID"</span><span class="token punctuation">,</span> <span class="token string">"W001"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token keyword">if</span> <span class="token punctuation">(</span>query<span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
       <span class="token function">qDebug</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Update successful"</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
       <span class="token comment">// 查询执行失败</span>
       QSqlError error <span class="token operator">=</span> query<span class="token punctuation">.</span><span class="token function">lastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       QString errorMessage <span class="token operator">=</span> error<span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token class-name">QMessageBox</span><span class="token double-colon punctuation">::</span><span class="token function">about</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token string">"数据库错误"</span><span class="token punctuation">,</span> <span class="token string">"检测结果写入失败："</span> <span class="token operator">+</span> errorMessage<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token comment">// 关闭数据库连接</span>
   db<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre>
    <ul>
     <li>
      <b>
       <i>
        <font color="#ff4757">
         批量处理
         <br/>
         上面的单条插入语句明显比较麻烦，可以使用批量插入数据：
        </font>
       </i>
      </b>
     </li>
    </ul>
    <pre><code class="prism language-cpp">    query2<span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span><span class="token string">"insert into student(id,name) values(3,'Qinsong')"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//单挑操作</span>

    <span class="token comment">//名称绑定</span>
    query2<span class="token punctuation">.</span><span class="token function">prepare</span><span class="token punctuation">(</span><span class="token string">"insert into student(id, name) values(:id, :name)"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> idValue <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span>
    QString nameValue <span class="token operator">=</span> <span class="token string">"Songjiang"</span><span class="token punctuation">;</span>
    query2<span class="token punctuation">.</span><span class="token function">bindValue</span><span class="token punctuation">(</span><span class="token string">":id"</span><span class="token punctuation">,</span> idValue<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//绑定数据</span>
    query2<span class="token punctuation">.</span><span class="token function">bindValue</span><span class="token punctuation">(</span><span class="token string">":name"</span><span class="token punctuation">,</span> nameValue<span class="token punctuation">)</span><span class="token punctuation">;</span>
    query2<span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//执行</span>

    <span class="token comment">//位置绑定</span>
    query2<span class="token punctuation">.</span><span class="token function">prepare</span><span class="token punctuation">(</span><span class="token string">"insert into student(id, name) values(?, ?)"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> idValue2 <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>
    QString nameValue2 <span class="token operator">=</span> <span class="token string">"LingChong"</span><span class="token punctuation">;</span>
    query2<span class="token punctuation">.</span><span class="token function">addBindValue</span><span class="token punctuation">(</span>idValue2<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//绑定数据</span>
    query2<span class="token punctuation">.</span><span class="token function">addBindValue</span><span class="token punctuation">(</span>nameValue2<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>query2<span class="token punctuation">.</span><span class="token function">execBatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token function">qDebug</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span><span class="token string">"位置绑定："</span> <span class="token operator">&lt;&lt;</span>query2<span class="token punctuation">.</span><span class="token function">lastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span>endl<span class="token punctuation">;</span><span class="token comment">//如果执行不成功执行</span>

    <span class="token comment">//批量处理</span>
    query2<span class="token punctuation">.</span><span class="token function">prepare</span><span class="token punctuation">(</span><span class="token string">"insert into student(id, name) values(?,?)"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    QVariantList ids<span class="token punctuation">;</span>
    ids <span class="token operator">&lt;&lt;</span> <span class="token number">6</span> <span class="token operator">&lt;&lt;</span> <span class="token number">7</span> <span class="token operator">&lt;&lt;</span> <span class="token number">8</span><span class="token punctuation">;</span>
    query2<span class="token punctuation">.</span><span class="token function">addBindValue</span><span class="token punctuation">(</span>ids<span class="token punctuation">)</span><span class="token punctuation">;</span>
    QVariantList names<span class="token punctuation">;</span>
    names <span class="token operator">&lt;&lt;</span> <span class="token string">"Qinghua"</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Nanda"</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Zhongkeda"</span><span class="token punctuation">;</span>
    query2<span class="token punctuation">.</span><span class="token function">addBindValue</span><span class="token punctuation">(</span>names<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>query2<span class="token punctuation">.</span><span class="token function">execBatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token function">qDebug</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> query2<span class="token punctuation">.</span><span class="token function">lastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>

</code></pre>
    <ul>
     <li>
      <b>
       <i>
        <font color="#ff4757">
         进行查询并输出查询结果：
        </font>
       </i>
      </b>
     </li>
    </ul>
    <pre><code class="prism language-cpp">    query2<span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span><span class="token string">"select * from student"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//执行sql语句</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span>query2<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token function">qDebug</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&lt;&lt;</span> query2<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> query2<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre>
    <pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;QSqlQuery&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;QSqlError&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;QVariant&gt;</span></span>

<span class="token comment">// ...</span>

QSqlQuery query<span class="token punctuation">;</span>
<span class="token comment">// 以SELECT语句为例，查询你感兴趣的表和字段</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>query<span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span><span class="token string">"SELECT column1, column2 FROM your_table"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>query<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 使用value()方法获取字段值</span>
        QVariant column1 <span class="token operator">=</span> query<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 0 是 column1 的索引</span>
        QVariant column2 <span class="token operator">=</span> query<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 1 是 column2 的索引</span>

        <span class="token comment">// 你可以使用QVariant的转换函数，例如toInt(), toString()等来获取具体的类型</span>
        <span class="token keyword">int</span> intValue <span class="token operator">=</span> column1<span class="token punctuation">.</span><span class="token function">toInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        QString stringValue <span class="token operator">=</span> column2<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 根据你的需要处理这些数据</span>
        <span class="token comment">// ...</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 查询失败，你可以获取并处理错误信息</span>
    QSqlError error <span class="token operator">=</span> query<span class="token punctuation">.</span><span class="token function">lastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 处理错误，例如打印错误消息</span>
    <span class="token function">qDebug</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Query failed:"</span> <span class="token operator">&lt;&lt;</span> error<span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <ul>
     <li>
      <b>
       <i>
        <font color="#ff4757">
         查看数据驱动支持特性
         <br/>
         查看当前数据库是否是支持某特性，比如当前记录的索引数（即结果条数）：
        </font>
       </i>
      </b>
     </li>
    </ul>
    <pre><code class="prism language-cpp">    <span class="token keyword">int</span> numRows<span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>db2<span class="token punctuation">.</span><span class="token function">driver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">hasFeature</span><span class="token punctuation">(</span>QSqlDriver<span class="token double-colon punctuation">::</span>QuerySize<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span><span class="token comment">//是否该特性</span>
        <span class="token function">qDebug</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&lt;&lt;</span> <span class="token string">"has feature:query size"</span><span class="token punctuation">;</span>
        numRows <span class="token operator">=</span> query2<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
        <span class="token function">qDebug</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"no feature:query size"</span><span class="token punctuation">;</span>
        query2<span class="token punctuation">.</span><span class="token function">last</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        numRows <span class="token operator">=</span> query2<span class="token punctuation">.</span><span class="token function">at</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token comment">//使用at，需要之前使用quey2.next()遍历所有select搜索后的结果,而使用query2.size()则不需要</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">//此处执行上面的查询操作，下面的操作才有意义</span>
    <span class="token function">qDebug</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"row number: "</span> <span class="token operator">&lt;&lt;</span> numRows<span class="token punctuation">;</span>
    <span class="token comment">//指向索引为1的记录，即第二条记录</span>
    query2<span class="token punctuation">.</span><span class="token function">seek</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//返回当前索引值</span>
    <span class="token function">qDebug</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"current index:"</span> <span class="token operator">&lt;&lt;</span> query2<span class="token punctuation">.</span><span class="token function">at</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//获得当前行的记录</span>
    QSqlRecord record <span class="token operator">=</span> query2<span class="token punctuation">.</span><span class="token function">record</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//获得记录中"id"和"name"两个字段的值</span>
    <span class="token keyword">int</span> id <span class="token operator">=</span> record<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    QString name <span class="token operator">=</span> record<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">qDebug</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span><span class="token string">"id"</span> <span class="token operator">&lt;&lt;</span> id <span class="token operator">&lt;&lt;</span> <span class="token string">"name:"</span> <span class="token operator">&lt;&lt;</span>name<span class="token punctuation">;</span>

    <span class="token comment">//获得索引为1的字段，即第二个字段</span>
    QSqlField field <span class="token operator">=</span> record<span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//输出字段名和字段值，结果为"name"和"MaLiang"</span>
    <span class="token function">qDebug</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"second field:"</span> <span class="token operator">&lt;&lt;</span> field<span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
             <span class="token operator">&lt;&lt;</span> <span class="token string">"field value:"</span> <span class="token operator">&lt;&lt;</span> field<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre>
    <ul>
     <li>
      <b>
       <i>
        <font color="#ff4757">
         事务（使数据操作变为原子性）
         <br/>
         如果中间有一步sql操作执行出错，则全部sql操作都不执行。
        </font>
       </i>
      </b>
     </li>
    </ul>
    <pre><code class="prism language-cpp">    QSqlDatabase db2 <span class="token operator">=</span> <span class="token class-name">QSqlDatabase</span><span class="token double-colon punctuation">::</span><span class="token function">database</span><span class="token punctuation">(</span><span class="token string">"connection2"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">QSqlDatabase</span><span class="token double-colon punctuation">::</span><span class="token function">database</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">transaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//开始（类似于mutex线程锁）</span>
    QSqlQuery <span class="token function">query</span><span class="token punctuation">(</span>db2<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//此语句必须在上面一条语句的后面</span>
    <span class="token comment">//执行sql操作</span>
    <span class="token class-name">QSqlDatabase</span><span class="token double-colon punctuation">::</span><span class="token function">database</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">commit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//结束</span>
</code></pre>
    <h4>
     <a id="242QSqlQueryModel_349">
     </a>
     2.4.2：使用QSqlQueryModel查询模型
    </h4>
    <p>
     优势：
    </p>
    <ul>
     <li>
      这是基于sql查询的只读模型，编写sql语句变得容易。
     </li>
    </ul>
    <p>
     文件头：
    </p>
    <pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;QSqlQueryModel&gt;</span></span>
</code></pre>
    <p>
     核心代码：
    </p>
    <pre><code class="prism language-cpp">  QSqlDatabase db <span class="token operator">=</span> <span class="token class-name">QSqlDatabase</span><span class="token double-colon punctuation">::</span><span class="token function">database</span><span class="token punctuation">(</span><span class="token string">"connection1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    QSqlQueryModel <span class="token operator">*</span>model <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">QSqlQueryModel</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


    model<span class="token operator">-&gt;</span><span class="token function">setQuery</span><span class="token punctuation">(</span><span class="token string">"select * from student"</span><span class="token punctuation">,</span> db<span class="token punctuation">)</span><span class="token punctuation">;</span>
    model<span class="token operator">-&gt;</span><span class="token function">setHeaderData</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> Qt<span class="token double-colon punctuation">::</span>Horizontal<span class="token punctuation">,</span> <span class="token function">tr</span><span class="token punctuation">(</span><span class="token string">"学号"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    model<span class="token operator">-&gt;</span><span class="token function">setHeaderData</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> Qt<span class="token double-colon punctuation">::</span>Horizontal<span class="token punctuation">,</span> <span class="token function">tr</span><span class="token punctuation">(</span><span class="token string">"姓名"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    model<span class="token operator">-&gt;</span><span class="token function">setHeaderData</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> Qt<span class="token double-colon punctuation">::</span>Horizontal<span class="token punctuation">,</span> <span class="token function">tr</span><span class="token punctuation">(</span><span class="token string">"课程"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    QTableView <span class="token operator">*</span>view <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">QTableView</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    view<span class="token operator">-&gt;</span><span class="token function">setModel</span><span class="token punctuation">(</span>model<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">setCentralWidget</span><span class="token punctuation">(</span>view<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <h4>
     <a id="243QSqlTableModel_377">
     </a>
     2.4.3：使用QSqlTableModel表格模型⭐
    </h4>
    <p>
     先上结果
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/7769c31db24143f7feffb6ac0881166b.png"/>
    </p>
    <p>
     <strong>
      优势：
     </strong>
    </p>
    <ul>
     <li>
      <p>
       编译的代码很容易适应其他的数据源，例如后面如果要使用xml文件来存储数据，只需要更换数据模型。
      </p>
     </li>
     <li>
      <p>
       提供了一次只能操作一个sql表的读/写模型，可以浏览和修改独立的sql表，并且只需编写很少的代码，无需了解sql语句。
      </p>
     </li>
     <li>
      <p>
       <b>
        <i>
         <font color="#ff4757">
          1 准备
          <br/>
          头文件：
         </font>
        </i>
       </b>
      </p>
     </li>
    </ul>
    <pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;QSqlTableModel&gt;</span></span>
</code></pre>
    <pre><code class="prism language-cpp">    QSqlTableModel<span class="token operator">*</span> model<span class="token punctuation">;</span><span class="token comment">//创建对象指针</span>
</code></pre>
    <ul>
     <li>
      <b>
       <i>
        <font color="#ff4757">
         2 进行操作：
        </font>
       </i>
      </b>
     </li>
    </ul>
    <pre><code class="prism language-cpp">    QSqlDatabase db <span class="token operator">=</span> <span class="token class-name">QSqlDatabase</span><span class="token double-colon punctuation">::</span><span class="token function">database</span><span class="token punctuation">(</span><span class="token string">"connection1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    model <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">QSqlTableModel</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> db<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//由于在窗口的类中创建对象，因此实例化对象时，使用this指针（指向操作函数的指针）作为父对象</span>

    model<span class="token operator">-&gt;</span><span class="token function">setTable</span><span class="token punctuation">(</span><span class="token string">"student"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    model<span class="token operator">-&gt;</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//执行</span>
    <span class="token comment">//设置编辑策略</span>
    model<span class="token operator">-&gt;</span><span class="token function">setEditStrategy</span><span class="token punctuation">(</span>QSqlTableModel<span class="token double-colon punctuation">::</span>OnManualSubmit<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//对所有模型改变立即用到数据库</span>
    ui<span class="token operator">-&gt;</span>tableView<span class="token operator">-&gt;</span><span class="token function">setModel</span><span class="token punctuation">(</span>model<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <ul>
     <li>
      <p>
       <b>
        <i>
         <font color="#ff4757">
          UI设计：
          <br/>
          <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/5f601beabc25dcb500a41930c144f9ae.png"/>
         </font>
        </i>
       </b>
      </p>
     </li>
     <li>
      <p>
       <b>
        <i>
         <font color="#ff4757">
          对应槽函数：
         </font>
        </i>
       </b>
      </p>
     </li>
    </ul>
    <pre><code class="prism language-cpp"><span class="token comment">// 提交修改按钮</span>
<span class="token keyword">void</span> <span class="token class-name">MainWindow</span><span class="token double-colon punctuation">::</span><span class="token function">on_pushButton_clicked</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 开始事务操作</span>
    model<span class="token operator">-&gt;</span><span class="token function">database</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">transaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>model<span class="token operator">-&gt;</span><span class="token function">submitAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>model<span class="token operator">-&gt;</span><span class="token function">database</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">commit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 提交</span>
            <span class="token class-name">QMessageBox</span><span class="token double-colon punctuation">::</span><span class="token function">information</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token function">tr</span><span class="token punctuation">(</span><span class="token string">"tableModel"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                     <span class="token function">tr</span><span class="token punctuation">(</span><span class="token string">"数据修改成功！"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        model<span class="token operator">-&gt;</span><span class="token function">database</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">rollback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 回滚</span>
        <span class="token class-name">QMessageBox</span><span class="token double-colon punctuation">::</span><span class="token function">warning</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token function">tr</span><span class="token punctuation">(</span><span class="token string">"tableModel"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                             <span class="token function">tr</span><span class="token punctuation">(</span><span class="token string">"数据库错误: %1"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">arg</span><span class="token punctuation">(</span>model<span class="token operator">-&gt;</span><span class="token function">lastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                             QMessageBox<span class="token double-colon punctuation">::</span>Ok<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 撤销修改按钮</span>
<span class="token keyword">void</span> <span class="token class-name">MainWindow</span><span class="token double-colon punctuation">::</span><span class="token function">on_pushButton_2_clicked</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    model<span class="token operator">-&gt;</span><span class="token function">revertAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 查询按钮，进行筛选</span>
<span class="token keyword">void</span> <span class="token class-name">MainWindow</span><span class="token double-colon punctuation">::</span><span class="token function">on_pushButton_5_clicked</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    QString name <span class="token operator">=</span> ui<span class="token operator">-&gt;</span>lineEdit<span class="token operator">-&gt;</span><span class="token function">text</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 根据姓名进行筛选，一定要使用单引号</span>
    model<span class="token operator">-&gt;</span><span class="token function">setFilter</span><span class="token punctuation">(</span><span class="token function">QString</span><span class="token punctuation">(</span><span class="token string">"name = '%1'"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">arg</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    model<span class="token operator">-&gt;</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 显示全表按钮</span>
<span class="token keyword">void</span> <span class="token class-name">MainWindow</span><span class="token double-colon punctuation">::</span><span class="token function">on_pushButton_6_clicked</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    model<span class="token operator">-&gt;</span><span class="token function">setTable</span><span class="token punctuation">(</span><span class="token string">"student"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    model<span class="token operator">-&gt;</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 按id升序排列按钮</span>
<span class="token keyword">void</span> <span class="token class-name">MainWindow</span><span class="token double-colon punctuation">::</span><span class="token function">on_pushButton_7_clicked</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">//id字段，即第0列，升序排列</span>
    model<span class="token operator">-&gt;</span><span class="token function">setSort</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> Qt<span class="token double-colon punctuation">::</span>AscendingOrder<span class="token punctuation">)</span><span class="token punctuation">;</span>
    model<span class="token operator">-&gt;</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>

<span class="token comment">// 按id降序排列按钮</span>
<span class="token keyword">void</span> <span class="token class-name">MainWindow</span><span class="token double-colon punctuation">::</span><span class="token function">on_pushButton_8_clicked</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    model<span class="token operator">-&gt;</span><span class="token function">setSort</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> Qt<span class="token double-colon punctuation">::</span>DescendingOrder<span class="token punctuation">)</span><span class="token punctuation">;</span>
    model<span class="token operator">-&gt;</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
<span class="token comment">// 删除选中行按钮</span>
<span class="token keyword">void</span> <span class="token class-name">MainWindow</span><span class="token double-colon punctuation">::</span><span class="token function">on_pushButton_4_clicked</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 获取选中的行</span>
    <span class="token keyword">int</span> curRow <span class="token operator">=</span> ui<span class="token operator">-&gt;</span>tableView<span class="token operator">-&gt;</span><span class="token function">currentIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">row</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 删除该行</span>
    model<span class="token operator">-&gt;</span><span class="token function">removeRow</span><span class="token punctuation">(</span>curRow<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> ok <span class="token operator">=</span> <span class="token class-name">QMessageBox</span><span class="token double-colon punctuation">::</span><span class="token function">warning</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span><span class="token function">tr</span><span class="token punctuation">(</span><span class="token string">"删除当前行!"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                  <span class="token function">tr</span><span class="token punctuation">(</span><span class="token string">"你确定删除当前行吗？"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> QMessageBox<span class="token double-colon punctuation">::</span>Yes<span class="token punctuation">,</span> QMessageBox<span class="token double-colon punctuation">::</span>No<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>ok <span class="token operator">==</span> QMessageBox<span class="token double-colon punctuation">::</span>No<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span> <span class="token comment">// 如果不删除，则撤销</span>
        model<span class="token operator">-&gt;</span><span class="token function">revertAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">// 否则提交，在数据库中删除该行</span>
        model<span class="token operator">-&gt;</span><span class="token function">submitAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
<span class="token comment">// 添加记录按钮</span>
<span class="token keyword">void</span> <span class="token class-name">MainWindow</span><span class="token double-colon punctuation">::</span><span class="token function">on_pushButton_3_clicked</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 获得表的行数</span>
    <span class="token keyword">int</span> rowNum <span class="token operator">=</span> model<span class="token operator">-&gt;</span><span class="token function">rowCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> id <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>

    <span class="token comment">// 添加一行</span>
    model<span class="token operator">-&gt;</span><span class="token function">insertRow</span><span class="token punctuation">(</span>rowNum<span class="token punctuation">)</span><span class="token punctuation">;</span>
    model<span class="token operator">-&gt;</span><span class="token function">setData</span><span class="token punctuation">(</span>model<span class="token operator">-&gt;</span><span class="token function">index</span><span class="token punctuation">(</span>rowNum<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 可以直接提交</span>
    <span class="token comment">//model-&gt;submitAll();</span>
<span class="token punctuation">}</span>


</code></pre>
    <h2>
     <a id="_504">
     </a>
     三、项目实战
    </h2>
    <p>
     <code>
      connection.h
     </code>
     是负责连接数据库和创建表的头文件：
    </p>
    <pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">CONNECTION_H</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">CONNECTION_H</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;QMessageBox&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;QSqlDatabase&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;QSqlQuery&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;QDebug&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression"><span class="token function">execution_character_set</span><span class="token punctuation">(</span></span><span class="token string">"utf-8"</span><span class="token expression"><span class="token punctuation">)</span><span class="token punctuation">;</span> </span></span>

<span class="token keyword">static</span> <span class="token keyword">bool</span> <span class="token function">createConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">//连接第一个数据库</span>
    <span class="token comment">//QMYSQL</span>
    QSqlDatabase db <span class="token operator">=</span> <span class="token class-name">QSqlDatabase</span><span class="token double-colon punctuation">::</span><span class="token function">addDatabase</span><span class="token punctuation">(</span><span class="token string">"QODBC"</span><span class="token punctuation">,</span> <span class="token string">"connection1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//需要使用的数据库驱动和联检建立的名称（方便建立多个数据库连接【使用不同的数据库时】区分）</span>
    db<span class="token punctuation">.</span><span class="token function">setHostName</span><span class="token punctuation">(</span><span class="token string">"127.0.0.1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//连接地址</span>
    db<span class="token punctuation">.</span><span class="token function">setUserName</span><span class="token punctuation">(</span><span class="token string">"root"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//数据库账户</span>
    db<span class="token punctuation">.</span><span class="token function">setPassword</span><span class="token punctuation">(</span><span class="token string">"55667788"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//密码</span>
    db<span class="token punctuation">.</span><span class="token function">setPort</span><span class="token punctuation">(</span><span class="token number">3306</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//端口</span>
    <span class="token comment">//test.db</span>
    db<span class="token punctuation">.</span><span class="token function">setDatabaseName</span><span class="token punctuation">(</span><span class="token string">"test"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//需要用到的数据库</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>db<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token comment">//如果数据库连接失败，则弹出</span>
        <span class="token comment">//critical(QWidget *parent, const QString &amp;title,</span>
        <span class="token comment">//const QString &amp;text,</span>
        <span class="token comment">//QMessageBox::StandardButtons buttons = Ok,</span>
        <span class="token comment">//QMessageBox::StandardButton defaultButton = NoButton)</span>
        <span class="token class-name">QMessageBox</span><span class="token double-colon punctuation">::</span><span class="token function">critical</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">"Cannot open database"</span><span class="token punctuation">,</span>
            <span class="token string">"Unable to establish a database connection"</span><span class="token punctuation">,</span> QMessageBox<span class="token double-colon punctuation">::</span>Cancel<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">QMessageBox</span><span class="token double-colon punctuation">::</span><span class="token function">information</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token string">"infor"</span><span class="token punctuation">,</span> <span class="token string">"link success"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//下面来创建表</span>
    <span class="token comment">//如果MySQL数据库中已经存在同名的表，则下面代码不会执行</span>
    QSqlQuery <span class="token function">query2</span><span class="token punctuation">(</span>db<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
   
    <span class="token comment">// qDebug() &lt;&lt; "connection2:";</span>
<span class="token comment">//创建表，并插入值</span>
    query2<span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span><span class="token string">"create table student (id int primary key,"</span>
        <span class="token string">"name varchar(20))"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    query2<span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span><span class="token string">"insert into student values(0, 'Mike')"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    query2<span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span><span class="token string">"insert into student values(1, 'Lili')"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    query2<span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span><span class="token string">"insert into student values(2, 'Jame')"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">// CONNECTION_H</span></span>
</code></pre>
    <p>
     <code>
      Admin
     </code>
     是操作数据库的管理界面：
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/24a4e8efcefa6c27bac8a04139210151.png"/>
     <br/>
     <code>
      Admin.h
     </code>
     :
    </p>
    <pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression">once</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;QMainWindow&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"ui_Admin.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;QSqlTableModel&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression"><span class="token function">execution_character_set</span><span class="token punctuation">(</span></span><span class="token string">"utf-8"</span><span class="token expression"><span class="token punctuation">)</span><span class="token punctuation">;</span> </span></span>

<span class="token keyword">class</span> <span class="token class-name">Admin</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> <span class="token class-name">QMainWindow</span></span>
<span class="token punctuation">{<!-- --></span>
	Q_OBJECT

<span class="token keyword">public</span><span class="token operator">:</span>
	<span class="token function">Admin</span><span class="token punctuation">(</span>QWidget <span class="token operator">*</span>parent <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token operator">~</span><span class="token function">Admin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	QSqlTableModel<span class="token operator">*</span> model<span class="token punctuation">;</span><span class="token comment">//创建对象指针</span>


<span class="token keyword">private</span><span class="token operator">:</span>
	Ui<span class="token double-colon punctuation">::</span>AdminClass ui<span class="token punctuation">;</span>

<span class="token keyword">private</span> slots<span class="token operator">:</span>
	<span class="token keyword">void</span> <span class="token function">on_add_clicked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">void</span> <span class="token function">on_modify_clicked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">void</span> <span class="token function">on_del_clicked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">void</span> <span class="token function">on_rollback_clicked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">void</span> <span class="token function">on_show_all_clicked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

</code></pre>
    <p>
     <code>
      Admin.cpp
     </code>
     :
    </p>
    <pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"Admin.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;qmessagebox.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;QSqlDatabase&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;QMessageBox&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;qsqlerror.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"connection.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;QSqlTableModel&gt;</span></span>

<span class="token class-name">Admin</span><span class="token double-colon punctuation">::</span><span class="token function">Admin</span><span class="token punctuation">(</span>QWidget <span class="token operator">*</span>parent<span class="token punctuation">)</span>
	<span class="token operator">:</span> <span class="token function">QMainWindow</span><span class="token punctuation">(</span>parent<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	ui<span class="token punctuation">.</span><span class="token function">setupUi</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">createConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">return</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
    QSqlDatabase db <span class="token operator">=</span> <span class="token class-name">QSqlDatabase</span><span class="token double-colon punctuation">::</span><span class="token function">database</span><span class="token punctuation">(</span><span class="token string">"connection1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    model <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">QSqlTableModel</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> db<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//由于在窗口的类中创建对象，因此实例化对象时，使用this指针（指向操作函数的指针）作为父对象</span>

    model<span class="token operator">-&gt;</span><span class="token function">setTable</span><span class="token punctuation">(</span><span class="token string">"student"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    model<span class="token operator">-&gt;</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//执行</span>
    QTableView<span class="token operator">*</span> view <span class="token operator">=</span> <span class="token keyword">new</span> QTableView<span class="token punctuation">;</span>
    view<span class="token operator">-&gt;</span><span class="token function">setModel</span><span class="token punctuation">(</span>model<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 你可以根据你数据库表的实际列名进行设置</span>
    QHeaderView<span class="token operator">*</span> header <span class="token operator">=</span> view<span class="token operator">-&gt;</span><span class="token function">horizontalHeader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    header<span class="token operator">-&gt;</span><span class="token function">setModel</span><span class="token punctuation">(</span>model<span class="token punctuation">)</span><span class="token punctuation">;</span>
    header<span class="token operator">-&gt;</span><span class="token function">setSectionResizeMode</span><span class="token punctuation">(</span>QHeaderView<span class="token double-colon punctuation">::</span>Stretch<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 设置显示名称，从0开始计数</span>
    model<span class="token operator">-&gt;</span><span class="token function">setHeaderData</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> Qt<span class="token double-colon punctuation">::</span>Horizontal<span class="token punctuation">,</span> <span class="token function">tr</span><span class="token punctuation">(</span><span class="token string">"列名1"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    model<span class="token operator">-&gt;</span><span class="token function">setHeaderData</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> Qt<span class="token double-colon punctuation">::</span>Horizontal<span class="token punctuation">,</span> <span class="token function">tr</span><span class="token punctuation">(</span><span class="token string">"列名2"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    model<span class="token operator">-&gt;</span><span class="token function">setHeaderData</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> Qt<span class="token double-colon punctuation">::</span>Horizontal<span class="token punctuation">,</span> <span class="token function">tr</span><span class="token punctuation">(</span><span class="token string">"列名3"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//设置编辑策略</span>
    model<span class="token operator">-&gt;</span><span class="token function">setEditStrategy</span><span class="token punctuation">(</span>QSqlTableModel<span class="token double-colon punctuation">::</span>OnManualSubmit<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//对所有模型改变立即用到数据库</span>
    ui<span class="token punctuation">.</span>tableView<span class="token operator">-&gt;</span><span class="token function">setModel</span><span class="token punctuation">(</span>model<span class="token punctuation">)</span><span class="token punctuation">;</span>


<span class="token punctuation">}</span>

<span class="token class-name">Admin</span><span class="token double-colon punctuation">::</span><span class="token operator">~</span><span class="token function">Admin</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>

<span class="token comment">// 添加记录按钮</span>
<span class="token keyword">void</span> <span class="token class-name">Admin</span><span class="token double-colon punctuation">::</span><span class="token function">on_add_clicked</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 获得表的行数</span>
    <span class="token keyword">int</span> rowNum <span class="token operator">=</span> model<span class="token operator">-&gt;</span><span class="token function">rowCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> id <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>

    <span class="token comment">// 添加一行</span>
    model<span class="token operator">-&gt;</span><span class="token function">insertRow</span><span class="token punctuation">(</span>rowNum<span class="token punctuation">)</span><span class="token punctuation">;</span>
    model<span class="token operator">-&gt;</span><span class="token function">setData</span><span class="token punctuation">(</span>model<span class="token operator">-&gt;</span><span class="token function">index</span><span class="token punctuation">(</span>rowNum<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 可以直接提交</span>
    <span class="token comment">//model-&gt;submitAll();</span>
<span class="token punctuation">}</span>

<span class="token comment">// 删除选中行按钮</span>
<span class="token keyword">void</span> <span class="token class-name">Admin</span><span class="token double-colon punctuation">::</span><span class="token function">on_del_clicked</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 获取选中的行</span>
    <span class="token keyword">int</span> curRow <span class="token operator">=</span> ui<span class="token punctuation">.</span>tableView<span class="token operator">-&gt;</span><span class="token function">currentIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">row</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 删除该行</span>
    model<span class="token operator">-&gt;</span><span class="token function">removeRow</span><span class="token punctuation">(</span>curRow<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> ok <span class="token operator">=</span> <span class="token class-name">QMessageBox</span><span class="token double-colon punctuation">::</span><span class="token function">warning</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token function">tr</span><span class="token punctuation">(</span><span class="token string">"删除当前行!"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">tr</span><span class="token punctuation">(</span><span class="token string">"你确定删除当前行吗？"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> QMessageBox<span class="token double-colon punctuation">::</span>Yes<span class="token punctuation">,</span> QMessageBox<span class="token double-colon punctuation">::</span>No<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ok <span class="token operator">==</span> QMessageBox<span class="token double-colon punctuation">::</span>No<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span> <span class="token comment">// 如果不删除，则撤销</span>
        model<span class="token operator">-&gt;</span><span class="token function">revertAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">// 否则提交，在数据库中删除该行</span>
        model<span class="token operator">-&gt;</span><span class="token function">submitAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
<span class="token comment">// 撤销修改按钮</span>
<span class="token keyword">void</span> <span class="token class-name">Admin</span><span class="token double-colon punctuation">::</span><span class="token function">on_rollback_clicked</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    model<span class="token operator">-&gt;</span><span class="token function">revertAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 提交修改按钮</span>
<span class="token keyword">void</span> <span class="token class-name">Admin</span><span class="token double-colon punctuation">::</span><span class="token function">on_modify_clicked</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 开始事务操作</span>
    model<span class="token operator">-&gt;</span><span class="token function">database</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">transaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>model<span class="token operator">-&gt;</span><span class="token function">submitAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>model<span class="token operator">-&gt;</span><span class="token function">database</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">commit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 提交</span>
            <span class="token class-name">QMessageBox</span><span class="token double-colon punctuation">::</span><span class="token function">information</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token function">tr</span><span class="token punctuation">(</span><span class="token string">"tableModel"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token function">tr</span><span class="token punctuation">(</span><span class="token string">"数据修改成功！"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        model<span class="token operator">-&gt;</span><span class="token function">database</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">rollback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 回滚</span>
        <span class="token class-name">QMessageBox</span><span class="token double-colon punctuation">::</span><span class="token function">warning</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token function">tr</span><span class="token punctuation">(</span><span class="token string">"tableModel"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token function">tr</span><span class="token punctuation">(</span><span class="token string">"数据库错误: %1"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">arg</span><span class="token punctuation">(</span>model<span class="token operator">-&gt;</span><span class="token function">lastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            QMessageBox<span class="token double-colon punctuation">::</span>Ok<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// 显示全表按钮</span>
<span class="token keyword">void</span> <span class="token class-name">Admin</span><span class="token double-colon punctuation">::</span><span class="token function">on_show_all_clicked</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    model<span class="token operator">-&gt;</span><span class="token function">setTable</span><span class="token punctuation">(</span><span class="token string">"student"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    model<span class="token operator">-&gt;</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre>
    <p>
     功能正常：
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/c563894fd0bef5cb30f2a5a31d59cfa4.png"/>
    </p>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f:626c6f672e6373646e2e6e65742f59616f79616f323032342f:61727469636c652f64657461696c732f313336333236323335" class_="artid" style="display:none">
 </p>
</div>


