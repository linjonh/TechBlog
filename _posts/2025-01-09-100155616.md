---
layout: post
title: "H5-向-小程序的-实时通讯方法"
date: 2025-01-09 11:39:20 +0800
description: ""
keywords: "H5通讯,小程序,postMessage"
categories: ['微信小程序']
tags: ['小程序', '实时', '即时', 'Postmessage']
artid: "100155616"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=100155616
    alt: "H5-向-小程序的-实时通讯方法"
render_with_liquid: false
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     H5 向 小程序的 实时通讯方法
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-light" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <h6>
     <a id="_0">
     </a>
     背景信息
    </h6>
    <p>
     对于WebView 中的 H5 向 小程序 的单方向通讯方式，腾讯官方给出了 如下方案：
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/8d51ab578740981c14bd9ccbf05e7e7b.png">
      <br/>
      大家可以点击
      <a href="https://developers.weixin.qq.com/miniprogram/dev/component/web-view.html" rel="nofollow">
       这里
      </a>
      查看官方文档 。
     </img>
    </p>
    <p>
     看到官方提供了解决办法，焦虑感顿时降低了不少。但仔细一看，不免又发愁起来：
    </p>
    <blockquote>
     <p>
      网页向小程序 postMessage 时，会在特定时机（小程序后退、组件销毁、分享）触发并收到消息。e.detail = { data }，data是多次 postMessage 的参数组成的数组
     </p>
    </blockquote>
    <p>
     这句话限定了小程序只能在应用后退、组件销毁、分享的时候才能捕捉到 H5 的消息，这个时候想要在执行什么操作，只怕用户已经不在之前的页面上了。更不用提如何将处理结果反馈给 H5 了。
    </p>
    <p>
     对于应用的主体内容，或者全部内容都由H5提供的开发者而言，这样很不友好。因为这个时候，作为 “壳” 的小程序，需要像工具箱一样能够及时为 H5 提供 H5 无法取得，但小程序能够相对容易获取的数据。
    </p>
    <p>
     那有没有什么办法让小程序能够及时捕捉到 H5 发出的消息，同时向 H5 反馈处理结果呢？简单来说，有。
    </p>
    <h6>
     <a id="_14">
     </a>
     及时捕捉消息
    </h6>
    <p>
     为了能够及时捕捉H5发出的消息，微信小程序需要能够以某种形态监听到 “消息发出” 这一动作。虽然 H5 可以调用
     <code>
      postMessage
     </code>
     方法，但微信小程序并不能主动感知，因而不符合我们的要求。
    </p>
    <p>
     通观腾讯的官方文档，发现 H5 中可以直接调用微信小程序的页面切换方法：
     <code>
      navigateTo
     </code>
     ，而微信小程序的页面能够通过
     <a href="https://developers.weixin.qq.com/miniprogram/dev/reference/api/Page.html" rel="nofollow">
      onLoad
     </a>
     句柄捕获此次跳转。两者之间甚至还可以像地址栏一样发收参数：
    </p>
    <br/>
    H5端调用
    <pre><code class="prism language-js">wx<span class="token punctuation">.</span>miniProgram<span class="token punctuation">.</span><span class="token function">navigateTo</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
	url<span class="token punctuation">:</span> <span class="token string">"/pages/index/index?a=1&amp;b=2"</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <br/>
    微信小程序端调用
    <pre><code class="prism language-js"><span class="token function">Page</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
	onLoad<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>options<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// -&gt; {a: "1", b: "2"}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <p>
     这两者组合起来，恰好就满足了 “H5 向 小程序 发送消息，小程序 能够及时捕获消息” 这一诉求了。更为系统性的示例如下所示：
    </p>
    <br/>
    H5端调用
    <pre><code class="prism language-js"><span class="token comment">/**
 * 对象序列化
 * @param {Object} data 要序列化的对象
 * @returns {String}
 */</span>
<span class="token keyword">var</span> <span class="token function-variable function">serialize</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">var</span> s <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> p <span class="token keyword">in</span> data<span class="token punctuation">)</span>
		s <span class="token operator">+=</span> <span class="token string">"&amp;"</span> <span class="token operator">+</span> p <span class="token operator">+</span> <span class="token string">"="</span> <span class="token operator">+</span> <span class="token function">encodeURIComponent</span><span class="token punctuation">(</span>data<span class="token punctuation">[</span>p<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/\+/gm</span><span class="token punctuation">,</span> <span class="token string">"%2B"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	s <span class="token operator">=</span> s<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">?</span> s<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> s<span class="token punctuation">;</span>
	
	<span class="token keyword">return</span> s<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">/* 通过跳转页面实现发送消息的目的 */</span>
wx<span class="token punctuation">.</span>miniProgram<span class="token punctuation">.</span><span class="token function">navigateTo</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
	url<span class="token punctuation">:</span> <span class="token string">"/pages/index/index?"</span> <span class="token operator">+</span> <span class="token function">serialize</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
		cmd<span class="token punctuation">:</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
			req<span class="token punctuation">:</span> <span class="token string">"H5Req_"</span> <span class="token operator">+</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">/* 本次消息的唯一编码，用于微信小程序将处理结果反馈给H5 */</span>
			api<span class="token punctuation">:</span> <span class="token string">"do-sth"</span><span class="token punctuation">,</span> <span class="token comment">/* 业务指令 */</span>
			params<span class="token punctuation">:</span> params <span class="token comment">/* 业务指令的执行参数 */</span>
		<span class="token punctuation">}</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <br/>
    微信小程序端调用
    <pre><code class="prism language-js"><span class="token function">Page</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
	onLoad<span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
		cmd <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token function">decodeURIComponent</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>cmd<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">var</span> req <span class="token operator">=</span> cmd<span class="token punctuation">.</span>req<span class="token punctuation">,</span>
			api <span class="token operator">=</span> cmd<span class="token punctuation">.</span>api<span class="token punctuation">,</span>
			params <span class="token operator">=</span> cmd<span class="token punctuation">.</span>params<span class="token punctuation">;</span>
		
		<span class="token keyword">switch</span><span class="token punctuation">(</span>api<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
			<span class="token keyword">case</span> <span class="token string">"do-sth"</span><span class="token punctuation">:</span>
			
			<span class="token comment">/* do something with params */</span>
			<span class="token function">doSomething</span><span class="token punctuation">(</span>params<span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
				<span class="token comment">/* 反馈处理结果 */</span>
				<span class="token comment">//....</span>
				
				<span class="token comment">/* 返回 webview 所在的页面 */</span>
				wx<span class="token punctuation">.</span><span class="token function">navigateBack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">break</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <blockquote>
     <p>
      你可能注意到了，这个方案牺牲了用户体验，借助了页面切换完成的消息传达。
      <br/>
      我当然知道这种体验有多糟糕，但毕竟没有其它选择。我企图用样式重载页面的切换效果，希望能够透明实现页面切换，但发现并不可行 - 微信并没有提供技术通道，使得我可以这样做。但愿随着小程序版本的迭代，腾讯能够给我们提供更为正统的解决方案吧。
     </p>
    </blockquote>
    <h6>
     <a id="_101">
     </a>
     反馈处理结果
    </h6>
    <p>
     实现了消息的及时捕获，开发者就可以在微信小程序中根据 H5 发出的业务指令执行动作了。但动作结果如何向H5反馈呢？
    </p>
    <p>
     看来看去，发现腾讯官方并没有提供从 微信小程序 到 H5 方向的消息反馈。那 webview 有没有其它能够为小程序所触发，同时H5能够感知的渠道呢？
    </p>
    <p>
     想了想，还真有！
    </p>
    <p>
     具体来说，就是微信小程序改写 webview 的 url 中的 hash 部分，将 hash 部分的取值替换为业务指令的处理结果。因为 hash 部分的改动既不会让 webview 离开或重新装载页面，也同时会让 webview 自动触发
     <code>
      hashchange
     </code>
     事件，而 H5 只要添加了该事件的监听句柄，就能够得到信息反馈。例如：
    </p>
    <br/>
    微信小程序端调用
    <pre><code class="prism language-js"><span class="token comment">/**
 * 给指定的url设置hash
 * @param {String} url 要设置hash的url
 * @param {String} hash 要设置的hash
 */</span>
<span class="token keyword">var</span> <span class="token function-variable function">setUrlHash</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>url<span class="token punctuation">,</span> hash<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">==</span> url <span class="token operator">||</span> <span class="token string">""</span> <span class="token operator">===</span> <span class="token punctuation">(</span>url <span class="token operator">=</span> <span class="token function">String</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> url<span class="token punctuation">;</span>

	<span class="token keyword">var</span> hashIndex <span class="token operator">=</span> url<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">"#"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">var</span> urlWithoutQueryAndHash<span class="token punctuation">;</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span> <span class="token operator">==</span> hashIndex<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		urlWithoutQueryAndHash <span class="token operator">=</span> url<span class="token punctuation">;</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
		urlWithoutQueryAndHash <span class="token operator">=</span> url<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> hashIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">return</span> urlWithoutQueryAndHash <span class="token operator">+</span> <span class="token string">"#"</span> <span class="token operator">+</span> hash<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token function">Page</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
	onLoad<span class="token punctuation">:</span> fu
	<span class="token function">nction</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
		cmd <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token function">decodeURIComponent</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>cmd<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">var</span> req <span class="token operator">=</span> cmd<span class="token punctuation">.</span>req<span class="token punctuation">,</span>
			api <span class="token operator">=</span> cmd<span class="token punctuation">.</span>api<span class="token punctuation">,</span>
			params <span class="token operator">=</span> cmd<span class="token punctuation">.</span>params<span class="token punctuation">;</span>
		
		<span class="token keyword">switch</span><span class="token punctuation">(</span>api<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
			<span class="token keyword">case</span> <span class="token string">"do-sth"</span><span class="token punctuation">:</span>
			
			<span class="token comment">/* do something with params */</span>
			<span class="token function">doSomething</span><span class="token punctuation">(</span>params<span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
				<span class="token comment">/* 反馈处理结果 */</span>
				<span class="token keyword">var</span> pages <span class="token operator">=</span> <span class="token function">getCurrentPages</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">var</span> page <span class="token operator">=</span> pages<span class="token punctuation">[</span>pages<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">/* 当前页面是接收 H5 消息的页面，上一个页面是 webview 所在页面 */</span>
				
				<span class="token comment">/**
				 * v=Date.now() 是为了加入干扰，保证每次的hash都会发生变化，
				 * 规避连续请求的 req 和 处理结果都相同导致hashchange 没有被触发的风险
				 */</span>
				<span class="token keyword">var</span> newWebViewUrl <span class="token operator">=</span> <span class="token function">setUrlHash</span><span class="token punctuation">(</span>
					page<span class="token punctuation">.</span>data<span class="token punctuation">.</span>webviewSrc<span class="token punctuation">,</span>
					req <span class="token operator">+</span> <span class="token string">"="</span> <span class="token operator">+</span> <span class="token function">encodeURIComponent</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"&amp;v="</span> <span class="token operator">+</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
				<span class="token punctuation">)</span><span class="token punctuation">;</span>
				
				page<span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
					webviewSrc<span class="token punctuation">:</span> newWebViewUrl
				<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				
				<span class="token comment">/* 返回 webview 所在的页面 */</span>
				wx<span class="token punctuation">.</span><span class="token function">navigateBack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">break</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <br/>
    H5端调用
    <pre><code class="prism language-js"><span class="token comment">/**
 * H5 当前发出的的业务指令的唯一ID
 */</span>
<span class="token keyword">var</span> currentReq <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * H5 发出业务指令时，指定的用于接收反馈消息的回调方法
 */</span>
<span class="token keyword">var</span> currentCallback <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
	
<span class="token comment">/**
 * 调用微信小程序
 * @param {String} api 业务指令
 * @param {Object} params 业务参数
 * @param {Function} [callback] 处理回调
 */</span>
<span class="token keyword">var</span> <span class="token function-variable function">callMiniProgram</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>api<span class="token punctuation">,</span> params<span class="token punctuation">,</span> callback<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
	currentReq <span class="token operator">=</span> <span class="token function">randomString</span><span class="token punctuation">(</span><span class="token string">"H5Req_"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	currentCallback <span class="token operator">=</span> <span class="token keyword">typeof</span> callback <span class="token operator">===</span> <span class="token string">"function"</span><span class="token operator">?</span> callback<span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
	
	wx<span class="token punctuation">.</span>miniProgram<span class="token punctuation">.</span><span class="token function">navigateTo</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
		url<span class="token punctuation">:</span> <span class="token string">"/pages/hybrid-page/hybrid?"</span> <span class="token operator">+</span> <span class="token function">serialize</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
			cmd<span class="token punctuation">:</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
				req<span class="token punctuation">:</span> currentReq<span class="token punctuation">,</span>
				api<span class="token punctuation">:</span> api<span class="token punctuation">,</span>
				params<span class="token punctuation">:</span> params
			<span class="token punctuation">}</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">/* 监听 hashchange 事件，用于接收微信小程序给出的处理反馈 */</span>
window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">"hashchange"</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
	<span class="token comment">/* 如果尚未发出指令，或 hash 不是微信小程序给出的操作反馈，那么 hashchange 可能是网页内部触发的，忽略即可 */</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">==</span> currentReq <span class="token operator">||</span> <span class="token operator">!</span>location<span class="token punctuation">.</span>hash<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">"#"</span> <span class="token operator">+</span> currentReq <span class="token operator">+</span> <span class="token string">"="</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span><span class="token punctuation">;</span>
	
	<span class="token comment">/* 解析hash中包含的操作反馈（除操作反馈外，还有随机数等） */</span>
	<span class="token keyword">var</span> params <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">;</span>
	location<span class="token punctuation">.</span>hash<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">"&amp;"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>pair<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
		<span class="token keyword">var</span> tmp <span class="token operator">=</span> pair<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">"="</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>tmp<span class="token punctuation">.</span>length <span class="token operator">&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span>
			<span class="token keyword">return</span><span class="token punctuation">;</span>
		
		params<span class="token punctuation">[</span><span class="token function">decodeURIComponent</span><span class="token punctuation">(</span>tmp<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">decodeURIComponent</span><span class="token punctuation">(</span>tmp<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token comment">/* 取出操作反馈正文，并触发可能存在的回调方法 */</span>
	<span class="token keyword">var</span> result <span class="token operator">=</span> params<span class="token punctuation">[</span>currentReq<span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> currentCallback <span class="token operator">!==</span> <span class="token string">"function"</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
		console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>currentReq <span class="token operator">+</span> <span class="token string">" -&gt; "</span> <span class="token operator">+</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span><span class="token keyword">else</span>
		<span class="token function">currentCallback</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/* 向微信小程序发出消息 */</span>
<span class="token function">callMiniProgram</span><span class="token punctuation">(</span><span class="token string">"do-sth"</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span>
	param1<span class="token punctuation">:</span> <span class="token string">"value1"</span><span class="token punctuation">,</span>
	param2<span class="token punctuation">:</span> <span class="token boolean">true</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <p>
     效果怎么样呢？我们一起看一看：
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/a64e7847561425596e145d03b7ef2593.gif"/>
    </p>
    <p>
     对于上述逻辑，我已经抽取并定义好了方法，托管在
     <a href="https://github.com/RedTeapot/WxMiniProgramHybrid">
      Github
     </a>
     ，开发者按照给定操作步骤操作即可：
    </p>
    <blockquote>
     <p>
      【H5 - 配置步骤】
     </p>
     <ol>
      <li>
       网页引入 miniProgramHybrid.js
      </li>
      <li>
       在需要通讯的地方调用API：miniProgramHybrid.call(“业务指令”, {参数集合}, 可选的回调方法)\
      </li>
     </ol>
    </blockquote>
    <blockquote>
     <p>
      【微信小程序 - 配置步骤】
     </p>
     <ol>
      <li>
       将 index，hybrid-lib 与 hybrid-page 并行存放至小程序工程的 pages 目录下
      </li>
      <li>
       在微信小程序的 app.json 文件中添加页面：“pages/hybrid-page/hybrid” 和 “pages/index/index”
      </li>
      <li>
       调整微信小程序 index 页面中 data 的 webviewSrc 字段取值为 webview 要打开的 H5 链接地址
      </li>
     </ol>
    </blockquote>
    <blockquote>
     <p>
      【微信小程序 - 业务指令开发步骤】
     </p>
     <ol>
      <li>
       在 hybrid-lib/handler.js 中根据样例定义业务指令
      </li>
     </ol>
    </blockquote>
    <h6>
     <a id="_257">
     </a>
     注意事项
    </h6>
    <p>
     通讯模型借助了 H5 的 hashchange 事件（hash 将被更改为形如：#H5Req_xxxx&amp;v=1567077985338的形态），如果H5页面的既有逻辑也有使用 hashchange，请注意区分、识别。
    </p>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f62:6c6f672e6373646e2e6e65742f62616f7a68616e673030372f:61727469636c652f64657461696c732f313030313535363136" class_="artid" style="display:none">
 </p>
</div>


