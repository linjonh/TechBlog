---
layout: post
title: "网络内部搭建NTP服务器"
date: 2024-12-06 15:59:26 +0800
description: "医院内部很多服务器及科室客户端电脑经常出现时间不一致的状况，导致收费、挂号及检查等项目出现问题。因为"
keywords: "内网ntp"
categories: ["未分类"]
tags: ["Windows", "Ntp", "Linux"]
artid: "120471047"
image:
  path: https://api.vvhan.com/api/bing?rand=sj&artid=120471047
  alt: "网络内部搭建NTP服务器"
render_with_liquid: false
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     网络内部搭建NTP服务器
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="htmledit_views" id="content_views">
    <p style="margin-left:.0001pt;text-align:justify;">
     医院内部很多服务器及科室客户端电脑经常出现时间不一致的状况，导致收费、挂号及检查等项目出现问题。因为现在医院都部署了银医，通过微信、支付宝等互联网应用实现挂号、收费、报告查询等。所以可以在医院内外网互联的前置机上部署一个NTP服务，自动从互联网同步时间，然后内网服务器和科室PC从前置机同步时间，这样就能达到全院所有电脑的时间一致。
    </p>
    <p>
    </p>
    <p style="margin-left:.0001pt;text-align:justify;">
     NTP服务可以有windows和linux来部署实现。
    </p>
    <p style="margin-left:.0001pt;text-align:justify;">
     <strong>
      <strong>
       1、windows2012部署NTP服务
      </strong>
     </strong>
    </p>
    <ul>
     <li style="text-align:justify;">
      在开始菜单栏中，点击“运行”输入regedit，打开Windows注册表；
     </li>
     <li style="text-align:justify;">
      打开以下路径：HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\W32Time\Parameters，鼠标双击 Type 文件；弹出对话框，在 数据数值（V）项输入 NTP,单击确定。
      <img alt="" src="https://i-blog.csdnimg.cn/blog_migrate/63fbcdb1eb7a3fe37359d279815c05ea.png"/>
     </li>
    </ul>
    <p>
    </p>
    <p>
    </p>
    <ul>
     <li style="text-align:justify;">
      打开以下路径:HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\W32Time\Config\，双击AnnounceFlags文件；在编辑DWORD 值 的 数值数据 框中键入 5 ，然后单击 确定按钮。
     </li>
    </ul>
    <p style="margin-left:.0001pt;text-align:center;">
     <img alt="" src="https://i-blog.csdnimg.cn/blog_migrate/504e9982448726a145b28bbb428e0ed5.png"/>
    </p>
    <ul>
     <li style="text-align:justify;">
      启用 NTPServer,请按照下列步骤操作：
     </li>
    </ul>
    <p style="margin-left:.0001pt;text-align:justify;">
     打开以下路径:HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\W32Time\TimeProviders\NtpServer\，双击 Enabled文件。在 编辑DWORD 值 的 数值数据 框中键入 1，然后单击 确定 按钮。
    </p>
    <p style="margin-left:.0001pt;text-align:center;">
     <img alt="" src="https://i-blog.csdnimg.cn/blog_migrate/124aa024e1a6527b4290512e591446fb.png"/>
    </p>
    <ul>
     <li style="text-align:justify;">
      重起WindowsTime服务
     </li>
    </ul>
    <p style="margin-left:.0001pt;text-align:justify;">
     打开开始菜单输入“CMD”在命令行模式下输入：net stop w32time，net start w32time  重启一下win32time服务。按开始-&gt;运行，输入"services.msc"进入服务，将windows time服务start方式设置为Auto。
    </p>
    <ul>
     <li style="text-align:justify;">
      设置 Windows 时间服务
     </li>
    </ul>
    <p style="margin-left:.0001pt;text-align:justify;">
     输入：gpedit.msc；执行上述命令后，计算机策略对话框打开，按照如下路径：计算机配置\管理模板\系统\windows 时间服务\时间提供程序 找到服务器设置文件，双击“启用 Windows NTP 服务器”，显示状态已启用即可；
    </p>
    <p style="margin-left:.0001pt;text-align:center;">
     <img alt="" src="https://i-blog.csdnimg.cn/blog_migrate/75c67d233ec7fd74e754d2bfa2c3d07d.png"/>
    </p>
    <ul>
     <li style="text-align:justify;">
      防火墙开启UDP123服务
     </li>
    </ul>
    <p style="margin-left:.0001pt;text-align:justify;">
     控制面板双击打开Windows 防火墙，左侧选择“高级设置”，新建入站规则；
    </p>
    <p style="margin-left:.0001pt;text-align:center;">
     <img alt="" src="https://i-blog.csdnimg.cn/blog_migrate/4f9f8f65603b844a1d0dcabd925c1aaf.png"/>
    </p>
    <p>
     <strong>
      <strong>
       2、Centos部署NTP服务
      </strong>
     </strong>
    </p>
    <ul>
     <li style="text-align:justify;">
      NTP软件安装
     </li>
    </ul>
    <p style="margin-left:.0001pt;text-align:left;">
     <span style="background-color:#fafafa;">
      <span style="background-color:#fafafa;">
       <span style="color:#383a42;">
        安装ntp yum
       </span>
      </span>
      <span style="background-color:#fafafa;">
       <span style="color:#a626a4;">
        install
       </span>
      </span>
      <span style="background-color:#fafafa;">
       <span style="color:#383a42;">
        -y ntp
       </span>
      </span>
     </span>
    </p>
    <ul>
     <li style="text-align:justify;">
      外网使用阿里云ntp服务器作为基准
     </li>
    </ul>
    <p style="margin-left:.0001pt;text-align:justify;">
     阿里云ntp服务器列表：
    </p>
    <p style="margin-left:.0001pt;text-align:left;">
     <span style="background-color:#fafafa;">
      <span style="background-color:#fafafa;">
       <span style="color:#383a42;">
        time1.aliyun.com
       </span>
      </span>
     </span>
    </p>
    <p style="margin-left:.0001pt;text-align:left;">
     <span style="background-color:#fafafa;">
      <span style="background-color:#fafafa;">
       <span style="color:#383a42;">
        time2.aliyun.com
       </span>
      </span>
     </span>
    </p>
    <p style="margin-left:.0001pt;text-align:left;">
     <span style="background-color:#fafafa;">
      <span style="background-color:#fafafa;">
       <span style="color:#383a42;">
        time3.aliyun.com
       </span>
      </span>
     </span>
    </p>
    <p style="margin-left:.0001pt;text-align:left;">
     <span style="background-color:#fafafa;">
      <span style="background-color:#fafafa;">
       <span style="color:#383a42;">
        time4.aliyun.com
       </span>
      </span>
     </span>
    </p>
    <p style="margin-left:.0001pt;text-align:justify;">
     先ntpdate检查能否和以上ntp服务器通信：
    </p>
    <p style="margin-left:.0001pt;text-align:left;">
     <span style="background-color:#fafafa;">
      <span style="background-color:#fafafa;">
       <span style="color:#383a42;">
        ntpdate -q time1.aliyun.com
       </span>
      </span>
     </span>
    </p>
    <p style="margin-left:.0001pt;text-align:justify;">
     命令输出以下表示正常：
    </p>
    <p style="margin-left:.0001pt;text-align:left;">
     <span style="background-color:#fafafa;">
      <span style="background-color:#fafafa;">
       <span style="color:#383a42;">
        server 115.28.122.198, stratum 2, offset 53.490757, delay 0.06709
       </span>
      </span>
     </span>
    </p>
    <p style="margin-left:.0001pt;text-align:left;">
     <span style="background-color:#fafafa;">
      <span style="background-color:#fafafa;">
       <span style="color:#383a42;">
        13 Sep 15:27:48 ntpdate[16092]: step time server 115.28.122.198 offset 53.490757 sec
       </span>
      </span>
     </span>
    </p>
    <ul>
     <li style="text-align:justify;">
      修改配置文件
     </li>
    </ul>
    <p style="margin-left:.0001pt;text-align:justify;">
     打开vim /etc/ntp.conf 做出以下修改：
    </p>
    <p style="margin-left:.0001pt;text-align:justify;">
     看到第一部分,将四条默认server注释掉,并加入4条新的配置：
    </p>
    <p style="margin-left:.0001pt;">
     <img alt="" src="https://i-blog.csdnimg.cn/blog_migrate/4ab7318c0b9db727f4fa92cc76501b7e.png"/>
    </p>
    <p style="text-align:center;">
     <img alt="" src="https://i-blog.csdnimg.cn/blog_migrate/d1e7552bca777307ec96b0abdd213066.png"/>
    </p>
    <ul>
     <li style="text-align:justify;">
      使硬件时间和系统时间一致
     </li>
    </ul>
    <p style="margin-left:.0001pt;text-align:justify;">
     修改配置文件 vim /etc/sysconfig/ntpd 添加：
    </p>
    <p style="margin-left:.0001pt;text-align:left;">
     <span style="background-color:#fafafa;">
      <span style="background-color:#fafafa;">
       <span style="color:#383a42;">
        SYNC_HWCLOCK=yes
       </span>
      </span>
     </span>
    </p>
    <ul>
     <li style="text-align:justify;">
      启动ntpd服务并设置自动启动
     </li>
    </ul>
    <p style="margin-left:.0001pt;text-align:left;">
     <span style="background-color:#fafafa;">
      <span style="background-color:#fafafa;">
       <span style="color:#383a42;">
        systemctl start ntpd
       </span>
      </span>
     </span>
    </p>
    <p style="margin-left:.0001pt;text-align:left;">
     <span style="background-color:#fafafa;">
      <span style="background-color:#fafafa;">
       <span style="color:#383a42;">
        chkconfig ntpd on
       </span>
      </span>
     </span>
    </p>
    <ul>
     <li style="text-align:justify;">
      等待10-15分钟后执行 ntpstat 查看同步状态
     </li>
    </ul>
    <p style="margin-left:.0001pt;text-align:left;">
     <span style="background-color:#fafafa;">
      <span style="background-color:#fafafa;">
       <span style="color:#383a42;">
        synchronised to NTP server (182.92.12.11) at stratum 3
       </span>
      </span>
     </span>
    </p>
    <p style="margin-left:.0001pt;text-align:left;">
     <span style="background-color:#fafafa;">
      <span style="background-color:#fafafa;">
       <span style="color:#383a42;">
        time correct to within 470 ms
       </span>
      </span>
     </span>
    </p>
    <p style="margin-left:.0001pt;text-align:left;">
     <span style="background-color:#fafafa;">
      <span style="background-color:#fafafa;">
       <span style="color:#383a42;">
        polling server every 64 s
       </span>
      </span>
     </span>
    </p>
    <p style="margin-left:.0001pt;text-align:left;">
     <span style="background-color:#fafafa;">
      <span style="background-color:#fafafa;">
       <span style="color:#383a42;">
        发现已经同步。
       </span>
      </span>
     </span>
    </p>
    <ul>
     <li style="text-align:justify;">
      执行ntpq -p 查看与阿里云ntp服务器连接状态
     </li>
    </ul>
    <p style="margin-left:.0001pt;">
     <img alt="" src="https://i-blog.csdnimg.cn/blog_migrate/e8e5182d5721ef2677ebad25f33280a8.png"/>
    </p>
    <ul>
     <li style="text-align:justify;">
      打开防火墙
     </li>
    </ul>
    <p style="margin-left:.0001pt;text-align:justify;">
     由于ntp服务使用 123端口udp协议 所以需要打开防火墙。
    </p>
    <p style="margin-left:.0001pt;text-align:justify;">
     执行firewall-cmd --zone=public --add-port=123/udp --permanent之后，再执行firewall-cmd --reload。
    </p>
    <p style="margin-left:.0001pt;text-align:center;">
    </p>
    <p style="text-align:justify;">
     <strong>
      <strong>
       3.Windows NTP客户端配置
      </strong>
     </strong>
    </p>
    <p style="margin-left:.0001pt;text-align:justify;">
     在桌面点击时钟进入更改日期和时间是设置页面：
    </p>
    <p style="margin-left:.0001pt;">
     <img alt="" src="https://i-blog.csdnimg.cn/blog_migrate/6630cfb4530b24800bf635fb6bea130d.png"/>
    </p>
    <p>
     选择Internet时间 点击更改设置：
    </p>
    <p style="margin-left:.0001pt;">
     <img alt="" src="https://i-blog.csdnimg.cn/blog_migrate/dede7159d899607f7f511287d944fbef.png"/>
    </p>
    <p>
     勾选与Internet时间服务器同步 在下面输入ntp服务器的IP 点击立即更新。查看时间是否同步，然后点击确定即完成。
    </p>
    <p style="text-align:justify;">
     <strong>
      <strong>
       4.Linux NTP客户端配置
      </strong>
     </strong>
    </p>
    <ul>
     <li style="text-align:justify;">
      NTP软件安装
     </li>
    </ul>
    <p style="margin-left:.0001pt;text-align:left;">
     <span style="background-color:#fafafa;">
      <span style="background-color:#fafafa;">
       <span style="color:#383a42;">
        安装ntp yum
       </span>
      </span>
      <span style="background-color:#fafafa;">
       <span style="color:#a626a4;">
        install
       </span>
      </span>
      <span style="background-color:#fafafa;">
       <span style="color:#383a42;">
        -y ntp
       </span>
      </span>
     </span>
    </p>
    <ul>
     <li style="text-align:justify;">
      修改配置文件
     </li>
    </ul>
    <p style="margin-left:.0001pt;text-align:justify;">
     打开vim /etc/ntp.conf 做出以下修改：
    </p>
    <p style="margin-left:.0001pt;text-align:left;">
     <span style="background-color:#fafafa;">
      <span style="background-color:#fafafa;">
       <span style="color:#383a42;">
        server
       </span>
      </span>
      <span style="background-color:#fafafa;">
       <span style="color:#383a42;">
        NTP服务器IP
       </span>
      </span>
     </span>
    </p>
    <ul>
     <li style="text-align:justify;">
      重起ntpd服务
     </li>
    </ul>
    <p style="margin-left:.0001pt;text-align:left;">
     <span style="background-color:#fafafa;">
      <span style="background-color:#fafafa;">
       <span style="color:#383a42;">
        # systemctl restart ntpd
       </span>
      </span>
     </span>
    </p>
    <ul>
     <li style="text-align:justify;">
      以crontab任务计划同步时间（需安装ntpdate，每天24点更新同步时间）：
     </li>
    </ul>
    <p style="margin-left:.0001pt;text-align:left;">
     <span style="background-color:#fafafa;">
      <span style="background-color:#fafafa;">
       <span style="color:#383a42;">
        # crontab -e
       </span>
      </span>
     </span>
    </p>
    <p style="margin-left:.0001pt;text-align:left;">
     <span style="background-color:#fafafa;">
      <span style="background-color:#fafafa;">
       <span style="color:#383a42;">
        0 0 * * * /usr/sbin/sntp -P no -r
       </span>
      </span>
      <span style="background-color:#fafafa;">
       <span style="color:#383a42;">
        NTP服务器IP
       </span>
      </span>
      <span style="background-color:#fafafa;">
       <span style="color:#383a42;">
        ;hwclock -w
       </span>
      </span>
     </span>
    </p>
    <p style="margin-left:.0001pt;text-align:justify;">
    </p>
    <p style="margin-left:.0001pt;text-align:justify;">
     如此NTP就部署完毕。这样NTP客户端会自动定期进行时间同步，医院网内的电脑时间就保持一致了。
    </p>
    <p style="margin-left:.0001pt;text-align:justify;">
    </p>
    <p style="margin-left:.0001pt;text-align:justify;">
    </p>
    <p style="margin-left:.0001pt;text-align:justify;">
    </p>
   </div>
  </div>
 </article>
 <p alt="68747470733a2f2f626c:6f672e6373646e2e6e65742f7a686f753030317368656e672f:61727469636c652f64657461696c732f313230343731303437" class_="artid" style="display:none">
 </p>
</div>
