---
layout: post
title: "SqlServer批量备份多个数据库且删除3天前的备份"
date: 2025-01-05 00:32:16 +0800
description: "/******************************************* * 批量备"
keywords: "sqlserver备份多个数据库"
categories: ['Mysql']
tags: ['无标签']
artid: "80333221"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=80333221
    alt: "SqlServer批量备份多个数据库且删除3天前的备份"
render_with_liquid: false
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     SqlServer批量备份多个数据库且删除3天前的备份
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="htmledit_views" id="content_views">
    <pre><span style="color:#008080;">/*</span><span style="color:#008080;">******************************************
 * 批量备份数据库且删除3天前的备份
 ******************************************</span><span style="color:#008080;">*/</span>
<span style="color:#0000ff;">DECLARE</span> <span style="color:#008000;">@backupfile</span> <span style="color:#0000ff;">VARCHAR</span>(<span style="color:#800000;"><strong>1024</strong></span><span style="color:#000000;">)  
</span><span style="color:#0000ff;">DECLARE</span> <span style="color:#008000;">@backdesc</span> <span style="color:#0000ff;">VARCHAR</span>(<span style="color:#800000;"><strong>1024</strong></span><span style="color:#000000;">)  
</span><span style="color:#0000ff;">DECLARE</span> <span style="color:#008000;">@filename</span> <span style="color:#0000ff;">VARCHAR</span>(<span style="color:#800000;"><strong>1024</strong></span><span style="color:#000000;">)  
</span><span style="color:#0000ff;">DECLARE</span> <span style="color:#008000;">@path</span> <span style="color:#0000ff;">VARCHAR</span>(<span style="color:#800000;"><strong>1024</strong></span><span style="color:#000000;">)  
</span><span style="color:#0000ff;">DECLARE</span> <span style="color:#008000;">@dbname</span> <span style="color:#0000ff;">VARCHAR</span>(<span style="color:#800000;"><strong>1024</strong></span><span style="color:#000000;">)  
</span><span style="color:#0000ff;">DECLARE</span> <span style="color:#008000;">@extension_name</span> <span style="color:#0000ff;">VARCHAR</span>(<span style="color:#800000;"><strong>16</strong></span><span style="color:#000000;">)  
  
</span><span style="color:#008080;">--</span><span style="color:#008080;">备份参数  </span>
<span style="color:#0000ff;">DECLARE</span> tmp_Cur <span style="color:#0000ff;">CURSOR</span>  
<span style="color:#0000ff;">FOR</span>  
    <span style="color:#0000ff;">SELECT</span><span style="color:#000000;">  NAME  
    </span><span style="color:#0000ff;">FROM</span>    <span style="color:#ff0000;">[</span><span style="color:#ff0000;">sys</span><span style="color:#ff0000;">]</span>.<span style="color:#ff0000;">[</span><span style="color:#ff0000;">databases</span><span style="color:#ff0000;">]</span>  
    <span style="color:#0000ff;">WHERE</span>   NAME <span style="color:#808080;">NOT</span> <span style="color:#808080;">IN</span> ( <span style="color:#ff0000;">'</span><span style="color:#ff0000;">master</span><span style="color:#ff0000;">'</span>, <span style="color:#ff0000;">'</span><span style="color:#ff0000;">model</span><span style="color:#ff0000;">'</span>,<span style="color:#ff0000;">'</span><span style="color:#ff0000;">msdb</span><span style="color:#ff0000;">'</span>,<span style="color:#ff0000;">'</span><span style="color:#ff0000;">tempdb</span><span style="color:#ff0000;">'</span><span style="color:#000000;"> )  
  
</span><span style="color:#0000ff;">SET</span> <span style="color:#008000;">@path</span> <span style="color:#808080;">=</span> N<span style="color:#ff0000;">'</span><span style="color:#ff0000;">D:\Backup\Autoback\</span><span style="color:#ff0000;">'</span><span style="color:#000000;">;  
</span><span style="color:#0000ff;">SET</span> <span style="color:#008000;">@extension_name</span> <span style="color:#808080;">=</span> N<span style="color:#ff0000;">'</span><span style="color:#ff0000;">bak</span><span style="color:#ff0000;">'</span><span style="color:#000000;">;  
  
</span><span style="color:#008080;">--</span><span style="color:#008080;">生成文件名  </span>
<span style="color:#0000ff;">SET</span> <span style="color:#008000;">@filename</span> <span style="color:#808080;">=</span> <span style="color:#ff00ff;">CONVERT</span>(<span style="color:#0000ff;">VARCHAR</span>(<span style="color:#800000;"><strong>1024</strong></span>), <span style="color:#ff00ff;">GETDATE</span>(), <span style="color:#800000;"><strong>120</strong></span><span style="color:#000000;">)  
</span><span style="color:#0000ff;">SET</span> <span style="color:#008000;">@filename</span> <span style="color:#808080;">=</span> <span style="color:#ff00ff;">REPLACE</span>(<span style="color:#008000;">@filename</span>, <span style="color:#ff0000;">'</span><span style="color:#ff0000;">:</span><span style="color:#ff0000;">'</span>, <span style="color:#ff0000;">''</span><span style="color:#000000;">)  
</span><span style="color:#0000ff;">SET</span> <span style="color:#008000;">@filename</span> <span style="color:#808080;">=</span> <span style="color:#ff00ff;">REPLACE</span>(<span style="color:#008000;">@filename</span>, <span style="color:#ff0000;">'</span><span style="color:#ff0000;">-</span><span style="color:#ff0000;">'</span>, <span style="color:#ff0000;">''</span><span style="color:#000000;">)  
</span><span style="color:#0000ff;">SET</span> <span style="color:#008000;">@filename</span> <span style="color:#808080;">=</span> <span style="color:#ff00ff;">REPLACE</span>(<span style="color:#008000;">@filename</span>, <span style="color:#ff0000;">'</span> <span style="color:#ff0000;">'</span>, <span style="color:#ff0000;">''</span><span style="color:#000000;">)  
</span><span style="color:#0000ff;">SET</span> <span style="color:#008000;">@filename</span> <span style="color:#808080;">=</span> <span style="color:#008000;">@filename</span> <span style="color:#808080;">+</span> <span style="color:#ff0000;">'</span><span style="color:#ff0000;">_</span><span style="color:#ff0000;">'</span> <span style="color:#808080;">+</span> <span style="color:#ff00ff;">CONVERT</span> (<span style="color:#0000ff;">VARCHAR</span>(<span style="color:#800000;"><strong>3</strong></span>), <span style="color:#ff00ff;">DATEPART</span>(ms, <span style="color:#ff00ff;">GETDATE</span><span style="color:#000000;">()))  
    </span><span style="color:#808080;">+</span> N<span style="color:#ff0000;">'</span><span style="color:#ff0000;">.</span><span style="color:#ff0000;">'</span> <span style="color:#808080;">+</span> <span style="color:#008000;">@extension_name</span>  
  
<span style="color:#0000ff;">OPEN</span><span style="color:#000000;"> tmp_Cur;  
</span><span style="color:#0000ff;">FETCH</span> <span style="color:#0000ff;">NEXT</span> <span style="color:#0000ff;">FROM</span> tmp_Cur <span style="color:#0000ff;">INTO</span> <span style="color:#008000;">@dbname</span><span style="color:#000000;">;  
</span><span style="color:#0000ff;">WHILE</span> <span style="color:#008000;"><strong>@@FETCH_STATUS</strong></span> <span style="color:#808080;">=</span> <span style="color:#800000;"><strong>0</strong></span>   
    <span style="color:#0000ff;">BEGIN</span>  
        <span style="color:#008080;">--</span><span style="color:#008080;"> 得到完整目标文件，数据库将备份到这个文件中  </span>
        <span style="color:#0000ff;">SET</span> <span style="color:#008000;">@backupfile</span> <span style="color:#808080;">=</span> <span style="color:#008000;">@path</span> <span style="color:#808080;">+</span> <span style="color:#008000;">@dbname</span> <span style="color:#808080;">+</span> <span style="color:#008000;">@filename</span>  
        <span style="color:#008080;">--</span><span style="color:#008080;">SELECT  @backupfile  </span>
        <span style="color:#0000ff;">SET</span> <span style="color:#008000;">@backdesc</span> <span style="color:#808080;">=</span><span style="color:#008000;">@dbname</span> <span style="color:#808080;">+</span> N<span style="color:#ff0000;">'</span><span style="color:#ff0000;">-完整 数据库 备份</span><span style="color:#ff0000;">'</span>  
  
        <span style="color:#008080;">--</span><span style="color:#008080;"> 开始备份, COMPRESSION 参数表示压缩，可节省磁盘空间  </span>
        <span style="color:#0000ff;">BACKUP</span> <span style="color:#0000ff;">DATABASE</span> <span style="color:#008000;">@dbname</span> <span style="color:#0000ff;">TO</span> <span style="color:#0000ff;">DISK</span> <span style="color:#808080;">=</span> <span style="color:#008000;">@backupfile</span> <span style="color:#0000ff;">WITH</span> NOFORMAT, NOINIT,  NAME <span style="color:#808080;">=</span> <span style="color:#008000;">@backdesc</span>, SKIP, NOREWIND, NOUNLOAD,  STATS <span style="color:#808080;">=</span> <span style="color:#800000;"><strong>10</strong></span><span style="color:#000000;">, COMPRESSION  
  
        </span><span style="color:#0000ff;">FETCH</span> <span style="color:#0000ff;">NEXT</span> <span style="color:#0000ff;">FROM</span> tmp_Cur <span style="color:#0000ff;">INTO</span> <span style="color:#008000;">@dbname</span>  
    <span style="color:#0000ff;">END</span>  
<span style="color:#0000ff;">CLOSE</span><span style="color:#000000;"> tmp_Cur;  
</span><span style="color:#0000ff;">DEALLOCATE</span><span style="color:#000000;"> tmp_Cur;  
  
</span><span style="color:#008080;">--</span><span style="color:#008080;"> 删除3天前的备份文件  </span>
<span style="color:#0000ff;">DECLARE</span> <span style="color:#008000;">@olddate</span> <span style="color:#0000ff;">DATETIME</span>  
<span style="color:#0000ff;">SELECT</span>  <span style="color:#008000;">@olddate</span> <span style="color:#808080;">=</span> <span style="color:#ff00ff;">DATEADD</span>(d, <span style="color:#808080;">-</span><span style="color:#800000;"><strong>3</strong></span>, <span style="color:#ff00ff;">GETDATE</span><span style="color:#000000;">())  
</span><span style="color:#008080;">--</span><span style="color:#008080;"> 执行删除 (SQL 2008 具备)  </span>
<span style="color:#0000ff;">EXECUTE</span> master.dbo.xp_delete_file <span style="color:#800000;"><strong>0</strong></span>, <span style="color:#008000;">@path</span>, <span style="color:#008000;">@extension_name</span>, <span style="color:#008000;">@olddate</span>, <span style="color:#800000;"><strong>1</strong></span>  </pre>
    <div class="cnblogs_code_toolbar">
     <span class="cnblogs_code_copy">
      <a title="复制代码">
       <img alt="复制代码" src="https://i-blog.csdnimg.cn/blog_migrate/48304ba5e6f9fe08f3fa1abda7d326ab.gif"/>
      </a>
     </span>
    </div>
    <p>
    </p>
    <div class="cnblogs_code">
     <div class="cnblogs_code_toolbar">
      <span class="cnblogs_code_copy">
       <a title="复制代码">
        <img alt="复制代码" src="https://i-blog.csdnimg.cn/blog_migrate/48304ba5e6f9fe08f3fa1abda7d326ab.gif"/>
       </a>
      </span>
     </div>
     <pre></pre>
     <div>
      <span style="color:#008080;">
       --
      </span>
      <span style="color:#008080;">
       作业定时压缩脚本支持多库
      </span>
      <span style="color:#0000ff;">
       DECLARE
      </span>
      <span style="color:#008000;">
       @DatabaseName
      </span>
      <span style="color:#0000ff;">
       NVARCHAR
      </span>
      (
      <span style="color:#800000;">
       <strong>
        50
       </strong>
      </span>
      <span style="color:#000000;">
       )
      </span>
      <span style="color:#0000ff;">
       DECLARE
      </span>
      <span style="color:#008000;">
       @ExecuteSql
      </span>
      <span style="color:#0000ff;">
       NVARCHAR
      </span>
      (
      <span style="color:#ff00ff;">
       MAX
      </span>
      <span style="color:#000000;">
       )
      </span>
      <span style="color:#0000ff;">
       SET
      </span>
      <span style="color:#008000;">
       @ExecuteSql
      </span>
      <span style="color:#808080;">
       =
      </span>
      <span style="color:#ff0000;">
       ''
      </span>
      <span style="color:#0000ff;">
       DECLARE
      </span>
      name_cursor
      <span style="color:#0000ff;">
       CURSOR
      </span>
      <span style="color:#0000ff;">
       FOR
      </span>
      <span style="color:#0000ff;">
       SELECT
      </span>
      name
      <span style="color:#0000ff;">
       FROM
      </span>
      master..sysdatabases
      <span style="color:#0000ff;">
       WHERE
      </span>
      name
      <span style="color:#808080;">
       NOT
      </span>
      <span style="color:#808080;">
       IN
      </span>
      (
      <span style="color:#ff0000;">
       '
      </span>
      <span style="color:#ff0000;">
       master
      </span>
      <span style="color:#ff0000;">
       '
      </span>
      ,
      <span style="color:#ff0000;">
       '
      </span>
      <span style="color:#ff0000;">
       model
      </span>
      <span style="color:#ff0000;">
       '
      </span>
      ,
      <span style="color:#ff0000;">
       '
      </span>
      <span style="color:#ff0000;">
       msdb
      </span>
      <span style="color:#ff0000;">
       '
      </span>
      ,
      <span style="color:#ff0000;">
       '
      </span>
      <span style="color:#ff0000;">
       tempdb
      </span>
      <span style="color:#ff0000;">
       '
      </span>
      <span style="color:#000000;">
       ,
      </span>
      <span style="color:#ff0000;">
       '
      </span>
      <span style="color:#ff0000;">
       northwind
      </span>
      <span style="color:#ff0000;">
       '
      </span>
      ,
      <span style="color:#ff0000;">
       '
      </span>
      <span style="color:#ff0000;">
       pubs
      </span>
      <span style="color:#ff0000;">
       '
      </span>
      ,
      <span style="color:#ff0000;">
       '
      </span>
      <span style="color:#ff0000;">
       AgentSys
      </span>
      <span style="color:#ff0000;">
       '
      </span>
      ,
      <span style="color:#ff0000;">
       '
      </span>
      <span style="color:#ff0000;">
       ydttimedtask
      </span>
      <span style="color:#ff0000;">
       '
      </span>
      ,
      <span style="color:#ff0000;">
       '
      </span>
      <span style="color:#ff0000;">
       YiDianTongV2
      </span>
      <span style="color:#ff0000;">
       '
      </span>
      <span style="color:#000000;">
       )
      </span>
      <span style="color:#0000ff;">
       OPEN
      </span>
      <span style="color:#000000;">
       name_cursor;
      </span>
      <span style="color:#0000ff;">
       FETCH
      </span>
      <span style="color:#0000ff;">
       NEXT
      </span>
      <span style="color:#0000ff;">
       FROM
      </span>
      name_cursor
      <span style="color:#0000ff;">
       INTO
      </span>
      <span style="color:#008000;">
       @DatabaseName
      </span>
      <span style="color:#000000;">
       ;
      </span>
      <span style="color:#0000ff;">
       WHILE
      </span>
      <span style="color:#008000;">
       <strong>
        @@FETCH_STATUS
       </strong>
      </span>
      <span style="color:#808080;">
       =
      </span>
      <span style="color:#800000;">
       <strong>
        0
       </strong>
      </span>
      <span style="color:#0000ff;">
       BEGIN
      </span>
      <span style="color:#0000ff;">
       SET
      </span>
      <span style="color:#008000;">
       @ExecuteSql
      </span>
      <span style="color:#808080;">
       =
      </span>
      <span style="color:#ff0000;">
       ''
      </span>
      <span style="color:#0000ff;">
       SET
      </span>
      <span style="color:#008000;">
       @ExecuteSql
      </span>
      <span style="color:#808080;">
       +=
      </span>
      <span style="color:#ff0000;">
       '
      </span>
      <span style="color:#ff0000;">
       USE [
      </span>
      <span style="color:#ff0000;">
       '
      </span>
      <span style="color:#808080;">
       +
      </span>
      <span style="color:#008000;">
       @DatabaseName
      </span>
      <span style="color:#808080;">
       +
      </span>
      <span style="color:#ff0000;">
       '
      </span>
      <span style="color:#ff0000;">
       ]; DECLARE @Error INT SET @Error=(SELECT TOP 1 size/128.0 - CAST(FILEPROPERTY([NAME],
      </span>
      <span style="color:#ff0000;">
       ''
      </span>
      <span style="color:#ff0000;">
       SpaceUsed
      </span>
      <span style="color:#ff0000;">
       ''
      </span>
      <span style="color:#ff0000;">
       ) AS int)/128.0 AS AvailableSpaceInMB FROM sys.database_files ORDER BY [NAME] DESC) --PRINT @Error IF(@Error&gt;1) BEGIN ALTER DATABASE [
      </span>
      <span style="color:#ff0000;">
       '
      </span>
      <span style="color:#808080;">
       +
      </span>
      <span style="color:#008000;">
       @DatabaseName
      </span>
      <span style="color:#808080;">
       +
      </span>
      <span style="color:#ff0000;">
       '
      </span>
      <span style="color:#ff0000;">
       ]　　--数据库名字 SET RECOVERY SIMPLE;　　--设置简单恢复模式 DBCC SHRINKFILE ([YiDianTongV2], 1);　　--(M)不能小于1M, DBCC SHRINKFILE ([YiDianTongV2_log], 1);　　--(M)不能小于1M ALTER DATABASE [
      </span>
      <span style="color:#ff0000;">
       '
      </span>
      <span style="color:#808080;">
       +
      </span>
      <span style="color:#008000;">
       @DatabaseName
      </span>
      <span style="color:#808080;">
       +
      </span>
      <span style="color:#ff0000;">
       '
      </span>
      <span style="color:#ff0000;">
       ] SET RECOVERY FULL;　　--恢复为原来完整模式 END
      </span>
      <span style="color:#ff0000;">
       '
      </span>
      <span style="color:#0000ff;">
       PRINT
      </span>
      <span style="color:#008000;">
       @ExecuteSql
      </span>
      ;
      <span style="color:#008080;">
       --
      </span>
      <span style="color:#008080;">
       打印
      </span>
      <span style="color:#0000ff;">
       EXEC
      </span>
      (
      <span style="color:#008000;">
       @ExecuteSql
      </span>
      )
      <span style="color:#008080;">
       --
      </span>
      <span style="color:#008080;">
       执行
      </span>
      <span style="color:#0000ff;">
       FETCH
      </span>
      <span style="color:#0000ff;">
       NEXT
      </span>
      <span style="color:#0000ff;">
       FROM
      </span>
      name_cursor
      <span style="color:#0000ff;">
       INTO
      </span>
      <span style="color:#008000;">
       @DatabaseName
      </span>
      <span style="color:#000000;">
       ;
      </span>
      <span style="color:#0000ff;">
       END
      </span>
      <span style="color:#000000;">
       ;
      </span>
      <span style="color:#0000ff;">
       CLOSE
      </span>
      <span style="color:#000000;">
       name_cursor;
      </span>
      <span style="color:#0000ff;">
       DEALLOCATE
      </span>
      name_cursor;
     </div>
     <div>
     </div>
    </div>
    <p>
    </p>
    <a class="postTitle2" href="http://www.cnblogs.com/ljhdo/p/5658476.html" rel="nofollow">
     <u>
      <span style="color:#0066cc;">
       backup1：开始数据库备份
      </span>
     </u>
    </a>
    <div class="clear">
    </div>
    <div class="postBody">
     <div class="blogpost-body">
      <p>
       <span style="font-size:14px;">
        数据库备份分为数据文件备份和日志文件备份，数据文件的备份分为：完整备份和差异备份。在SQL Server 2012中，能够将数据分布式备份到不同的存储设备上，一般情况，只将数据备份到一个备份文件(.bak)中，只有在备份超大的数据库时，才需要分布式备份，对于备份集（backup set），备份介质（backup Media），备份族（backup family），镜像备份，等等看似复杂的术语，不用深入了解，简单了解一下基本知识：
       </span>
      </p>
      <ul>
       <li>
        <span style="font-size:12px;">
         backup set：是数据或日志的一次备份；
        </span>
       </li>
       <li>
        <span style="font-size:12px;">
         backup media：是备份存储的文件，分为两部分：media header和content，content是由一个或多个backup sets构成的；
        </span>
       </li>
       <li>
        <span style="font-size:12px;">
         镜像备份：一次备份操作创建一个相同的备份，最多三个镜像备份；
        </span>
       </li>
       <li>
        <span style="font-size:12px;">
         backup  family：多个备份设备和镜像备份构成backup family；
        </span>
       </li>
      </ul>
      <p>
       数据库备份的策略一般是：一周一次完整备份，一天一次差异备份，一小时一次事务日志备份，根据数据容灾的要求，适当增减备份的时间间隔。
      </p>
      <p>
       为了便于管理数据备份文件，推荐的做法是：
      </p>
      <ul>
       <li>
        数据/日志的每次备份都使用一个单独的备份文件，数据备份的扩展名是 .bak，日志备份的扩展名是.trn；
       </li>
       <li>
        合理命名每个备份文件，建议使用：database_name+date+time+(.bak/.trn)，该命名方式，很容易识别备份的数据库和开始备份的时间；
       </li>
       <li>
        创建schedule，定时清理备份文件，避免备份文件耗尽磁盘空间；
       </li>
      </ul>
      <p>
       <span style="font-size:14px;">
        <strong>
         一，创建数据库的完整备份和差异备份
        </strong>
       </span>
      </p>
      <p>
       <span style="font-size:14px;">
        使用backup database命令创建数据库的数据文件的备份，
       </span>
       backup database 命令语法（简化）：
      </p>
      <div class="cnblogs_code">
       <div class="cnblogs_code_toolbar">
        <span class="cnblogs_code_copy">
         <a title="复制代码">
          <img alt="复制代码" src="https://i-blog.csdnimg.cn/blog_migrate/48304ba5e6f9fe08f3fa1abda7d326ab.gif"/>
         </a>
        </span>
       </div>
       <pre><span style="color:#0000ff;">BACKUP</span> <span style="color:#0000ff;">DATABASE</span><span style="color:#000000;"> database_name 
</span><span style="color:#0000ff;">TO</span> <span style="color:#0000ff;">DISK</span>  <span style="color:#808080;">=</span>  <span style="color:#ff0000;">'</span><span style="color:#ff0000;">physical_device_name</span><span style="color:#ff0000;">'</span>
<span style="color:#ff0000;">[</span><span style="color:#ff0000;"> WITH { DIFFERENTIAL
|  COPY_ONLY 
| { COMPRESSION | NO_COMPRESSION } 
| { NOINIT | INIT } 
| { NOSKIP | SKIP } 
| { NOFORMAT | FORMAT } 
| STATS [ = percentage </span><span style="color:#ff0000;">]</span> }]</pre>
       <div class="cnblogs_code_toolbar">
        <span class="cnblogs_code_copy">
         <a title="复制代码">
          <img alt="复制代码" src="https://i-blog.csdnimg.cn/blog_migrate/48304ba5e6f9fe08f3fa1abda7d326ab.gif"/>
         </a>
        </span>
       </div>
      </div>
      <p>
       <strong>
        1，完整备份和差异备份
       </strong>
      </p>
      <p>
       差异备份由DIFFERENTIAL 关键字指定，
       <span style="color:#800000;">
        只备份从上一次完整备份之后发生更新的数据
       </span>
       ，而不是备份整个数据库，通常情况下，差异备份比完整备份占用的空间更少。差异备份的参考基准是上一次完整备份，而，事务日志，只备份是从上一次差异备份之后产生的事务日志。因此，
       <strong>
        <span style="color:#800000;">
         备份是有顺序的，
        </span>
       </strong>
       如果存在以下备份序列：
      </p>
      <ol>
       <li>
        <span style="font-size:12px;">
         FullBackup1.bak
        </span>
       </li>
       <li>
        <span style="font-size:12px;">
         DifferentialBackup2.bak
        </span>
       </li>
       <li>
        <span style="font-size:12px;">
         LogBackup3.trn
        </span>
       </li>
       <li>
        <span style="font-size:12px;">
         DifferentialBackup4.bak
        </span>
       </li>
       <li>
        <span style="font-size:12px;">
         LogBackup5.trn
        </span>
       </li>
       <li>
        <span style="font-size:12px;">
         出现错误
        </span>
       </li>
      </ol>
      <p>
       还原的策略是：备份尾日志，使数据库处于Restoring状态，依次还原FullBackup1.bak，DifferentialBackup4.bak，LogBackup5.trn，尾日志，就能将数据库还原到一个合适的有效时间点。
      </p>
      <p>
       在执行完整备份和差异备份时，SQL Server会备份足够的事务日志，用于将数据库还原到一致性的状态。对于master数据库，只能执行完整备份。
      </p>
      <ul>
       <li>
        <span style="font-size:12px;">
         During a full or differential database backup, SQL Server backs up enough of the transaction log to produce a consistent database when the backup is restored.
        </span>
       </li>
       <li>
        <span style="font-size:12px;">
         Only a full database backup can be performed on the
         <strong>
          master
         </strong>
         database.
        </span>
       </li>
      </ul>
      <p>
       <strong>
        2，只复制（COPY_ONLY ）备份
       </strong>
      </p>
      <p>
       备份是有顺序的，使用COPY_ONLY选项不会影响备份的正常顺序，仅仅创建一个数据库的副本。
      </p>
      <p>
       差异备份的基准是上一次完整备份，即差异是指从上一次full backup之后，对数据文件执行的更新操作。如果执行一次Copy-Only的完整数据库备份，不会影响差异备份的base（基准），该base是上一次full backup，而非本次 Copy-only full backup。
      </p>
      <p>
       <strong>
        3，压缩数据{ COMPRESSION | NO_COMPRESSION }
       </strong>
      </p>
      <p>
       在备份时，将数据压缩，由于压缩的备份较小，能够减少Disk Sapce和Disk IO消耗，提高数据备份的速度，但是，备份文件的压缩和解压缩十分消耗CPU资源。
      </p>
      <p>
       <strong>
        4，建议：每一次
        <strong>
         数据
        </strong>
        备份，都存储在单个备份文件上
       </strong>
      </p>
      <p>
       由于硬盘空间有限，不可能保留过多的备份文件，将数据的每一次备份都存储在单个文件上，便于对备份文件进行管理（删除或归档）。
      </p>
      <p>
       每次备份都存储在新的备份上，搭配选项 Init、Skip、Format，将数据备份存储在
       <span style="color:#800000;">
        新的备份文件
       </span>
       上，这三个选项的含义是：
      </p>
      <ul>
       <li>
        <span style="font-size:12px;">
         <strong>
          Format 选项：
         </strong>
         将备份文件格式化，默认选项是 NoFormat;
        </span>
       </li>
       <li>
        <span class="label" style="font-size:12px;">
         <strong>
          Init 选项：
         </strong>
         初始化备份文件，Init选项不会初始化Media Header，只将backup set初始化，默认选项是NoInit，将备份存储到备份文件的末尾；
         <br/>
        </span>
       </li>
       <li>
        <span class="label" style="font-size:12px;">
         <strong>
          SKIP
         </strong>
         选项：不做任何检查，不会检查Media Header是否有效，也不会检查backup set的有效期，默认选项是NoSkip；
        </span>
       </li>
      </ul>
      <p>
       <strong>
        5，备份进度（stats)
       </strong>
      </p>
      <p>
       使用stats选项，每当备份进行到一定的百分比时，SQL Server显式进度消息，默认值是10，即，每完成10%，SQL Server显式完成的进度消息，例如，设置stats=10，当备份进程完成30%时，SQL Server会打印消息：
       <span style="color:#800000;font-size:12px;">
        30 percent processed.
       </span>
      </p>
      <p>
       <span style="font-size:12px;">
        The STATS option reports the percentage complete as of the threshold for reporting the next interval. This is at approximately the specified percentage; for example, with STATS=10, if the amount completed is 40 percent, the option might display 43 percent. For large backup sets, this is not a problem, because the percentage complete moves very slowly between completed I/O calls.
       </span>
      </p>
      <p>
       <strong>
        二，数据备份操作
       </strong>
      </p>
      <p>
       <span style="color:#800000;">
        建议：每一次数据备份，都存储在单个备份文件上
       </span>
      </p>
      <p>
       <strong>
        1，数据库完整备份，没有指定Differential选项
       </strong>
      </p>
      <div class="cnblogs_code">
       <div class="cnblogs_code_toolbar">
        <span class="cnblogs_code_copy">
         <a title="复制代码">
          <img alt="复制代码" src="https://i-blog.csdnimg.cn/blog_migrate/48304ba5e6f9fe08f3fa1abda7d326ab.gif"/>
         </a>
        </span>
       </div>
       <pre><span style="color:#0000ff;">backup</span> <span style="color:#0000ff;">database</span> <span style="color:#ff0000;">[</span><span style="color:#ff0000;">TestSite</span><span style="color:#ff0000;">]</span>
<span style="color:#0000ff;">to</span> <span style="color:#0000ff;">disk</span> <span style="color:#808080;">=</span> <span style="color:#ff0000;">'</span><span style="color:#ff0000;">D:\TestDBBackupFolder\Sitedb_bak1.bak</span><span style="color:#ff0000;">'</span> <span style="color:#008080;">--specify </span><span style="color:#008080;">new backup file</span>
<span style="color:#0000ff;">with</span><span style="color:#000000;">
compression,
format,
init,
skip,
stats</span><span style="color:#808080;">=</span><span style="color:#800000;"><strong>5</strong></span></pre>
       <div class="cnblogs_code_toolbar">
        <span class="cnblogs_code_copy">
         <a title="复制代码">
          <img alt="复制代码" src="https://i-blog.csdnimg.cn/blog_migrate/48304ba5e6f9fe08f3fa1abda7d326ab.gif"/>
         </a>
        </span>
       </div>
      </div>
      <p>
       <strong>
        2，数据库差异备份，
        <strong>
         指定Differential选项
        </strong>
       </strong>
      </p>
      <div class="cnblogs_code">
       <div class="cnblogs_code_toolbar">
        <span class="cnblogs_code_copy">
         <a title="复制代码">
          <img alt="复制代码" src="https://i-blog.csdnimg.cn/blog_migrate/48304ba5e6f9fe08f3fa1abda7d326ab.gif"/>
         </a>
        </span>
       </div>
       <pre><span style="color:#0000ff;">backup</span> <span style="color:#0000ff;">database</span> <span style="color:#ff0000;">[</span><span style="color:#ff0000;">TestSite</span><span style="color:#ff0000;">]</span>
<span style="color:#0000ff;">to</span> <span style="color:#0000ff;">disk</span> <span style="color:#808080;">=</span> <span style="color:#ff0000;">'</span><span style="color:#ff0000;">D:\TestDBBackupFolder\Sitedb_bak2.bak</span><span style="color:#ff0000;">'</span> <span style="color:#008080;">--</span><span style="color:#008080;">specify new backup file</span>
<span style="color:#0000ff;">with</span><span style="color:#000000;"><strong><span style="color:#800000;"> 
differential</span></strong>,
compression, 
format, 
init, 
skip, 
stats</span><span style="color:#808080;">=</span><span style="color:#800000;"><strong>5</strong></span></pre>
       <div class="cnblogs_code_toolbar">
        <span class="cnblogs_code_copy">
         <a title="复制代码">
          <img alt="复制代码" src="https://i-blog.csdnimg.cn/blog_migrate/48304ba5e6f9fe08f3fa1abda7d326ab.gif"/>
         </a>
        </span>
       </div>
      </div>
      <p>
       <strong>
        三，事务日志备份
       </strong>
      </p>
      <p>
       要执行事务日志的备份，数据库的恢复模式（Recovery Mode）必须是FULL，并且数据库必须执行过一次数据库的完整备份操作，否则，事务日志将处于自动截断（Auto-Truncate）状态，无法进行事务日志备份。
      </p>
      <p>
       使用backup log命令对事务日志进行备份，跟backup database命令的差异是，不能使用differential选项，多了NoRecovery 和 NO_Truncate选项；
      </p>
      <div class="cnblogs_code">
       <div class="cnblogs_code_toolbar">
        <span class="cnblogs_code_copy">
         <a title="复制代码">
          <img alt="复制代码" src="https://i-blog.csdnimg.cn/blog_migrate/48304ba5e6f9fe08f3fa1abda7d326ab.gif"/>
         </a>
        </span>
       </div>
       <pre><span style="color:#0000ff;">BACKUP</span> <span style="color:#ff00ff;">LOG</span><span style="color:#000000;"> database_name 
</span><span style="color:#0000ff;">TO</span> <span style="color:#0000ff;">DISK</span>  <span style="color:#808080;">=</span>  <span style="color:#ff0000;">'</span><span style="color:#ff0000;">physical_device_name</span><span style="color:#ff0000;">'</span>
<span style="color:#ff0000;">[</span><span style="color:#ff0000;"> WITH { 
  COPY_ONLY
| { COMPRESSION | NO_COMPRESSION } 
| { NOINIT | INIT } 
| { NOSKIP | SKIP } 
| { NOFORMAT | FORMAT } 
| STATS [ = percentage </span><span style="color:#ff0000;">]</span> 
<span style="color:#808080;">|</span> { NORECOVERY <span style="color:#808080;">|</span> STANDBY <span style="color:#808080;">=</span><span style="color:#000000;"> undo_file_name }
</span><span style="color:#808080;">|</span> NO_TRUNCATE }]</pre>
       <div class="cnblogs_code_toolbar">
        <span class="cnblogs_code_copy">
         <a title="复制代码">
          <img alt="复制代码" src="https://i-blog.csdnimg.cn/blog_migrate/48304ba5e6f9fe08f3fa1abda7d326ab.gif"/>
         </a>
        </span>
       </div>
      </div>
      <p>
       <strong>
        1，尾日志备份
       </strong>
      </p>
      <p>
       NORECOVERY 选项，指定备份事务日志的尾部，并使数据库处于RESTORING状态
      </p>
      <p>
       <span style="font-size:12px;">
        Backs up the tail of the log and leaves the database in the RESTORING state. NORECOVERY is useful when failing over to a secondary database or when saving the tail of the log before a RESTORE operation.
       </span>
       <span style="font-size:12px;">
        To perform a best-effort log backup that skips log truncation and then take the database into the RESTORING state atomically, use the NO_TRUNCATE and NORECOVERY options together.
       </span>
      </p>
      <p>
       <strong>
        2，日志截断
       </strong>
      </p>
      <p>
       正常情况下，数据库处于Online状态，在进行事务日志备份时，如果不指定 NO_TRUNCATE 选项，那么数据库将已备份的事务日志文件截断，避免事务日志过大，耗尽disk空间；如果指定 NO_TRUNCATE 选项，表示日志备份不会将事务日志文件截断，该选项一般在数据库处于异常状态时使用。
      </p>
      <p>
       <span style="font-size:12px;">
        Specifies that the log not be truncated and causes the Database Engine to attempt the backup regardless of the state of the database. Consequently, a backup taken with NO_TRUNCATE might have incomplete metadata. This option allows backing up the log in situations where the database is damaged.
       </span>
       <br/>
       <span style="font-size:12px;">
        The NO_TRUNCATE option of BACKUP LOG is equivalent to specifying both COPY_ONLY and CONTINUE_AFTER_ERROR.
       </span>
       <br/>
       <span style="font-size:12px;">
        <span style="color:#800000;">
         Without the NO_TRUNCATE option, the database must be in the ONLINE state.
        </span>
        If the database is in the SUSPENDED state, you might be able to create a backup by specifying NO_TRUNCATE. But if the database is in the OFFLINE or EMERGENCY state, BACKUP is not allowed even with NO_TRUNCATE.
       </span>
      </p>
      <p>
       <strong>
        3，自动截断模式
       </strong>
      </p>
      <p>
       如果数据库符合以下两种条件之一，那么Database就处于自动截断模式：
      </p>
      <ul>
       <li>
        数据库的恢复模式是simple；
       </li>
       <li>
        数据库的恢复模式是full 或 bulk_Logged，并且没有做过数据库完整备份；
       </li>
      </ul>
      <p>
       自动截断模式是指数据库引擎把处于可还原状态（recoverable）状态的事务日志自动截断，使日志文件能够重复使用，避免日志文件无限增长。如果事务日志不是自动截断模式，那么事务日志会保存到日志文件中，导致日志文件持续增长。只有做日志备份时，日志文件才会被截断；如果没有定期的日志备份，那么日志文件会持续地增长，直到耗尽磁盘的所有空间，因此，必须制定一个日志备份计划，把事务日志截断，才能使数据库的事务日志文件的大小保持在一个可以管理的水平上。
      </p>
      <div class="cnblogs_code">
       <pre><span style="color:#0000ff;">select</span> <span style="color:#ff00ff;">db_name</span>(database_id) <span style="color:#0000ff;">as</span><span style="color:#000000;"> DBName,
    </span><span style="color:#ff00ff;">case</span> <span style="color:#0000ff;">when</span> last_log_backup_lsn <span style="color:#0000ff;">is</span> <span style="color:#0000ff;">null</span> <span style="color:#0000ff;">then</span> <span style="color:#ff0000;">'</span><span style="color:#ff0000;">Auto</span><span style="color:#ff0000;">'</span> <span style="color:#0000ff;">else</span> <span style="color:#ff0000;">'</span><span style="color:#ff0000;">Manul</span><span style="color:#ff0000;">'</span> <span style="color:#0000ff;">end</span> <span style="color:#0000ff;">as</span><span style="color:#000000;"> TruncateMode
</span><span style="color:#0000ff;">from</span> sys.database_recovery_status</pre>
      </div>
      <p>
       <strong>
        四，事务日志备份
       </strong>
      </p>
      <p>
       <strong>
        1，正常情况下的事务日志备份
       </strong>
      </p>
      <div class="cnblogs_code">
       <div class="cnblogs_code_toolbar">
        <span class="cnblogs_code_copy">
         <a title="复制代码">
          <img alt="复制代码" src="https://i-blog.csdnimg.cn/blog_migrate/48304ba5e6f9fe08f3fa1abda7d326ab.gif"/>
         </a>
        </span>
       </div>
       <pre><span style="color:#0000ff;">backup</span> <span style="color:#ff00ff;">log</span> <span style="color:#ff0000;">[</span><span style="color:#ff0000;">TestSite</span><span style="color:#ff0000;">]</span>
<span style="color:#0000ff;">to</span> <span style="color:#0000ff;">disk</span> <span style="color:#808080;">=</span> <span style="color:#ff0000;">'</span><span style="color:#ff0000;">D:\TestDBBackupFolder\Sitedb_bak3.trn</span><span style="color:#ff0000;">'</span>
<span style="color:#0000ff;">with</span><span style="color:#000000;">
compression,
format,
init,
skip,
stats</span><span style="color:#808080;">=</span><span style="color:#800000;"><strong>5</strong></span></pre>
       <div class="cnblogs_code_toolbar">
        <span class="cnblogs_code_copy">
         <a title="复制代码">
          <img alt="复制代码" src="https://i-blog.csdnimg.cn/blog_migrate/48304ba5e6f9fe08f3fa1abda7d326ab.gif"/>
         </a>
        </span>
       </div>
      </div>
      <p>
       <strong>
        2，备份尾日志，进而还原数据库
       </strong>
      </p>
      <div class="cnblogs_code">
       <div class="cnblogs_code_toolbar">
        <span class="cnblogs_code_copy">
         <a title="复制代码">
          <img alt="复制代码" src="https://i-blog.csdnimg.cn/blog_migrate/48304ba5e6f9fe08f3fa1abda7d326ab.gif"/>
         </a>
        </span>
       </div>
       <pre><span style="color:#0000ff;">backup</span> <span style="color:#ff00ff;">log</span> <span style="color:#ff0000;">[</span><span style="color:#ff0000;">TestSite</span><span style="color:#ff0000;">]</span>
<span style="color:#0000ff;">to</span> <span style="color:#0000ff;">disk</span> <span style="color:#808080;">=</span> <span style="color:#ff0000;">'</span><span style="color:#ff0000;">D:\TestDBBackupFolder\Sitedb_bak4.trn</span><span style="color:#ff0000;">'</span>
<span style="color:#0000ff;">with</span><span style="color:#000000;">
compression,
format,
init,
skip,
stats</span><span style="color:#808080;">=</span><span style="color:#800000;"><strong>5</strong></span><span style="color:#000000;">，
<strong><span style="color:#800000;">norecovery</span></strong></span></pre>
      </div>
     </div>
    </div>
   </div>
  </div>
 </article>
 <p alt="68747470733a:2f2f626c6f672e6373646e2e6e65742f416e647265776e6975:2f61727469636c652f64657461696c732f3830333333323231" class_="artid" style="display:none">
 </p>
</div>


