---
layout: post
title: "Unity-AR小游戏玩具小车踩坑记"
date: 2023-01-01 09:00:00 +0800
description: "基于Unity AR Foundation开发AR小游戏，按照Google教程文档，一步一步做下来，"
keywords: "ar手机游戏unity"
categories: ['Android']
tags: ['游戏引擎', 'Unity', 'Arcore', 'Ar']
artid: "128500133"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=128500133
    alt: "Unity-AR小游戏玩具小车踩坑记"
render_with_liquid: false
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     Unity AR小游戏（玩具小车）踩坑记
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="htmledit_views" id="content_views">
    <p style="margin-left:.0001pt;text-align:justify;">
     最近对AR产生了兴趣。先科普一下什么是AR吧。AR是Augmented Reality（增强现实）的简称，是基于摄像头对现实世界的实时图像采集、分析和理解，然后在此基础上融入虚拟物体（信息），以达到增强体验的目的——世界从此变得更加丰富多彩！典型的AR设备有Google Glass、微软的HoloLens等。因为智能手机都自带摄像头，所以手机上也比较方便做AR应用。
    </p>
    <p style="margin-left:.0001pt;text-align:justify;">
     从应用开发的角度去看，平台支持SDK是少不了的：Google有ARCore，苹果有ARKit。我勉强算是一名Android程序员吧，顺手就看了一遍
     <a href="https://developers.google.cn/ar/develop" rel="nofollow" title="ARCore官方文档">
      ARCore官方文档
     </a>
     ，对AR的技术概念有了大致的理解。要在Android设备上跑AR应用，除了系统要求7.0及以上之外，还需要一个叫“Google Play Services for AR”的关键组件——可以到Google Play应用商店在线安装，也可以从
     <a href="https://github.com/google-ar/arcore-android-sdk/releases" title="GitHub">
      GitHub
     </a>
     下载.apk后再离线安装。AR的核心功能都由这个Services来提供，而AR应用通过建立session来与它协作，它们之间的关系如下：
    </p>
    <p style="margin-left:.0001pt;text-align:center;">
     <img alt="" height="362" src="https://i-blog.csdnimg.cn/blog_migrate/1b5a5ad88096699223b1510cb8e58882.png" width="454"/>
    </p>
    <p style="margin-left:.0001pt;text-align:justify;">
     咱们程序员还是比较务实；有了一定的理论知识之后，就要动手写代码了。Google提供了很多示例，有效降低了学习门槛，但稍微有趣一点的就用到了Unity3D。为了做出上佳的AR体验，似乎还不得不学习Unity啊（编程语言是C#），尽管我们不必去开发游戏……使用Unity开发还有一个好处，就是可以一次开发、Android+iOS双端通用，提升开发效率！
    </p>
    <p style="margin-left:.0001pt;text-align:justify;">
     从工具链的角度看，大致可以分为两类：
    </p>
    <p style="margin-left:.0001pt;text-align:center;">
     <img alt="" height="704" src="https://i-blog.csdnimg.cn/blog_migrate/ca2d4ae6afc456aaf96955f0e752b025.png" width="1200"/>
    </p>
    <p style="margin-left:.0001pt;text-align:left;">
     Google似乎偏爱Unity一些，介绍Unity的篇幅明显比Unreal多很多；这里有
     <a href="https://codelabs.developers.google.com/arcore-unity-ar-foundation" rel="nofollow" title="一篇极好的文档">
      一篇极好的文档
     </a>
     （需要翻墙⊙︿⊙），手把手教我们用Unity来开发一个AR小游戏：通过手机摄像头识别平面，然后在平面上驾驶一辆玩具汽车。实操之前，最好对Unity编辑器有个基本了解，强烈推荐B站上有位叫“阿发你好”的UP主，他做了
     <a href="https://www.bilibili.com/medialist/play/ml1440570702/BV1TZ4y1o76s" rel="nofollow" title="免费的视频教程">
      免费的视频教程
     </a>
     ，讲解很细致，每集视频只有几分钟，看完前面111集即可，非常适合零基础的初学者。
    </p>
    <p style="margin-left:.0001pt;text-align:center;">
     <img alt="" height="245" src="https://i-blog.csdnimg.cn/blog_migrate/f7eb7f959fe76502f3867c727909af0f.png" width="457"/>
    </p>
    <p style="margin-left:.0001pt;text-align:left;">
     然后，跟着
     <a href="https://codelabs.developers.google.com/arcore-unity-ar-foundation" rel="nofollow" title="Google的文档">
      Google的文档
     </a>
     做就是了。我记录一下这个过程中我踩过的几个小坑，确保大家能顺利完成这个AR小游戏。
    </p>
    <p style="text-align:left;">
     1. 文档的第2章：文中提到的Unity编辑器版本是2020.3 LTS，而我使用了最新的2021.3.16f1。在新建项目时，已经没有Universal Render Pipeline这个模板，那就换成2D（URP）吧。项目面板的Assets &gt; Settings目录下也没有ForwardRenderer了，对应修改Renderer2D即可。
    </p>
    <p style="text-align:left;">
     2. 文档的第4章：正常的话，这一章的所有步骤完成之后，瞄准器就会跟着手机镜头移动；可惜事与愿违。需要修改ReticleBehaviour.cs文件，将hits.Length改成hits.Count。运行程序时，发现Unity的控制台输出这样的出错信息：
    </p>
    <p style="margin-left:.0001pt;text-align:left;">
     <strong>
      <span style="color:#c00000;">
       NullReferenceException
      </span>
     </strong>
     <span style="color:#c00000;">
      : Object reference not set to an instance of an object
     </span>
    </p>
    <p style="margin-left:.0001pt;text-align:left;">
     <span style="color:#c00000;">
      ReticleBehaviour.Update () (at Assets/Starter Package/
      <strong>
       ReticleBehaviour.cs:44
      </strong>
      )
     </span>
    </p>
    <p style="margin-left:.0001pt;text-align:left;">
     原因是DrivingSurfaceManager.
     <strong>
      <span style="color:#c00000;">
       RaycastManager
      </span>
     </strong>
     引用了一个空对象。需要去修改DrivingSurfaceManager.cs文件，在Start函数中增加下面这行代码：
    </p>
    <p style="margin-left:.0001pt;text-align:left;">
     RaycastManager = GetComponent&lt;ARRaycastManager&gt;();
    </p>
    <p style="margin-left:.0001pt;text-align:left;">
     改完这几处后，运行起来就符合预期了！同时也引出了一个问题，怎样调试Unity项目呢，比如在Visual Studio里单步调试C#代码？我参考了
     <a href="https://blog.csdn.net/GLDbalala/article/details/126125059" title="这篇文章">
      这篇文章
     </a>
     ，各种场景都谈到了。需要注意的一点是，确保Unity &gt; Edit &gt; Preferences… &gt; External Tools设置中，将External Script Editor改成Microsoft Visual Studio 2019，而不是默认的Open by file extension。
    </p>
    <p style="text-align:left;">
     3. 文档的第5章：做完之后其实环境光的渲染并没有生效，在Visual Studio里调试时，LightEstimation.cs文件的FrameReceived函数中设置断点后并不会进来。原因是，没有在Unity编辑器中给Directional Light的Light Estimation脚本组件的AR Camera Manager赋值。把它指向Scene的AR Camera即可。
    </p>
    <p style="text-align:left;">
     4. 课后作业：可以在CarBehaviour.cs文件的OnTriggerEnter函数增加实现，当玩具汽车碰撞到礼盒时，播放一个音效，并产生一个粒子效果:)
    </p>
    <p style="margin-left:.0001pt;text-align:left;">
     总之，按照文档给出的步骤一步一步做下来，最终可以把这个AR应用跑起来，代码量也不是很大，比较容易消化。只是实际效果不甚理想，比如平面识别得不是很准确，得再深入研究一下怎么去优化。
    </p>
   </div>
  </div>
 </article>
 <p alt="68747470733a2f:2f626c6f672e6373646e2e6e65742f6861707079646565722f:61727469636c652f64657461696c732f313238353030313333" class_="artid" style="display:none">
 </p>
</div>


