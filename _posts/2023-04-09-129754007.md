---
layout: post
title: "Unity-之-转微信小游戏本地数据存储方法分享"
date: 2023-04-09 07:45:00 +0800
description: "在将Unity项目转换为微信小游戏时，遇到了WebGL平台读写本地文件的限制。本文分享了如何利用微信"
keywords: "微信小游戏 playerprefs"
categories: ['引擎进阶', 'ジ﹋★☆『', '《独立开发者游戏上线指南》']
tags: ['微信', 'Unity', 'Unity']
artid: "129754007"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=129754007
    alt: "Unity-之-转微信小游戏本地数据存储方法分享"
render_with_liquid: false
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     Unity 之 转微信小游戏本地数据存储方法分享
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-dracula" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <p>
    </p>
    <div class="toc">
     <h4>
      Unity 之 转微信小游戏本地数据存储
     </h4>
     <ul>
      <li>
       <a href="#_2" rel="nofollow">
        问题背景
       </a>
      </li>
      <li>
       <a href="#_19" rel="nofollow">
        微信小游戏读写本地文件
       </a>
      </li>
      <li>
       <a href="#WebGL_119" rel="nofollow">
        WebGL平台的一些限制
       </a>
      </li>
      <li>
       <a href="#bug_133" rel="nofollow">
        一个创建目录的bug
       </a>
      </li>
      <li>
       <a href="#_310" rel="nofollow">
        报错查看方法分享
       </a>
      </li>
     </ul>
    </div>
    <p>
    </p>
    <h2>
     <a id="_2">
     </a>
     问题背景
    </h2>
    <p>
     近期在将Unity转换为小游戏的时候发现在读写本地文件的时候，使用
     <code>
      Application.persistentDataPath
     </code>
     缓存路径来保存文件失败，原因是WebGL的平台限制。所以导致了原有读写本地文件的代码需要根据平台进行修改。
    </p>
    <p>
     一种最简单的方式就是将原来存储到文件中的内容，在WebGL平台使用
     <code>
      PlayerPrefs
     </code>
     来存储。比如这样的写法：
     <br/>
     <img alt="" src="https://i-blog.csdnimg.cn/blog_migrate/6e9e5fbe5f49cf9f4f6b1032ff51eddb.png#pic_center"/>
    </p>
    <p>
     使用
     <code>
      PlayerPrefs
     </code>
     的存在第一次读取慢的问题，可以使用微信小游戏的插件进行添加用到的Key。使用方式：微信小游戏 -&gt; PlayerPrefs优化:
     <br/>
     <img alt="" src="https://i-blog.csdnimg.cn/blog_migrate/fbf31792fbf242c60957aa891e672bed.png#pic_center">
      <br/>
      微信插件中覆盖Unity中的API
      <br/>
      <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/1790e21f6994c412cdf37a6553c9a24c.png"/>
     </img>
    </p>
    <p>
     所以当需要存储文件很多或者数据很多的时候，我们还是希望在尽量不修改原有的读写逻辑的情况下进行完成文件的读写。所以微信给我们提供了
     <code>
      WX.env.USER_DATA_PATH
     </code>
     。
    </p>
    <hr/>
    <h2>
     <a id="_19">
     </a>
     微信小游戏读写本地文件
    </h2>
    <p>
     Unity转成微信小游戏以后
     <code>
      File.WriteAllText
     </code>
     和
     <code>
      File.ReadAllText
     </code>
     由于路径问题不生效。
    </p>
    <p>
     改为使用微信小游戏插件提供的路径即可，插件中的代码：
     <br/>
     <img alt="" src="https://i-blog.csdnimg.cn/blog_migrate/bf2c3ff7fbd252125e13af0617315afd.png#pic_center"/>
    </p>
    <p>
     示例代码如下：
    </p>
    <pre><code class="prism language-csharp"><span class="token keyword">using</span> <span class="token namespace">System</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Collections</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Collections<span class="token punctuation">.</span>Generic</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>IO</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">UnityEngine</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">WeChatWASM</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SaveFile</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">MonoBehaviour</span></span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 文件类型</span>
    <span class="token keyword">private</span> <span class="token class-name">PlayerData</span> m_PlayerData<span class="token punctuation">;</span>

    <span class="token comment">// 文件名称</span>
    <span class="token keyword">private</span> <span class="token class-name"><span class="token keyword">string</span></span> fileName <span class="token operator">=</span> <span class="token string">"/PlayerData.txt"</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">OnGUI</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>GUI<span class="token punctuation">.</span><span class="token function">Button</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">Rect</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"读取文件"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token function">LoadPlayerData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>GUI<span class="token punctuation">.</span><span class="token function">Button</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">Rect</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">400</span><span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"写入文件"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token function">WritePlayerData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/// &lt;summary&gt;</span>
    <span class="token comment">/// 读取文件</span>
    <span class="token comment">/// &lt;/summary&gt;</span>
    <span class="token keyword">private</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">LoadPlayerData</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
<span class="token preprocessor property">#<span class="token directive keyword">if</span> UNITY_WEBGL</span>
        <span class="token class-name">WXFileSystemManager</span> fs <span class="token operator">=</span> WX<span class="token punctuation">.</span><span class="token function">GetFileSystemManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">// 判断是否存在目录</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>fs<span class="token punctuation">.</span><span class="token function">AccessSync</span><span class="token punctuation">(</span>WX<span class="token punctuation">.</span>env<span class="token punctuation">.</span>USER_DATA_PATH <span class="token operator">+</span> fileName<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Equals</span><span class="token punctuation">(</span><span class="token string">"access:ok"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 读取内容</span>
            <span class="token class-name"><span class="token keyword">string</span></span> playerDataString <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">ReadFileSync</span><span class="token punctuation">(</span>WX<span class="token punctuation">.</span>env<span class="token punctuation">.</span>USER_DATA_PATH <span class="token operator">+</span> fileName<span class="token punctuation">,</span> <span class="token string">"utf-8"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>playerDataString <span class="token operator">!=</span> <span class="token string">""</span><span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                m_PlayerData <span class="token operator">=</span> LitJson<span class="token punctuation">.</span>JsonMapper<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">ToObject</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>PlayerData<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span>playerDataString<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        Debug<span class="token punctuation">.</span><span class="token function">Log</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$" 读取文件 姓名：</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token expression language-csharp">m_PlayerData<span class="token punctuation">.</span>name</span><span class="token punctuation">}</span></span><span class="token string"> 年龄：</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token expression language-csharp">m_PlayerData<span class="token punctuation">.</span>age</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token preprocessor property">#<span class="token directive keyword">endif</span></span>
    <span class="token punctuation">}</span>

    <span class="token comment">/// &lt;summary&gt;</span>
    <span class="token comment">/// 写入文件</span>
    <span class="token comment">/// &lt;/summary&gt;</span>
    <span class="token keyword">private</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">WritePlayerData</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        m_PlayerData <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">PlayerData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        m_PlayerData<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">"Czhenya"</span><span class="token punctuation">;</span>
        m_PlayerData<span class="token punctuation">.</span>age <span class="token operator">=</span> <span class="token number">18</span><span class="token punctuation">;</span>
        Debug<span class="token punctuation">.</span><span class="token function">Log</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$" 写入文件 姓名：</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token expression language-csharp">m_PlayerData<span class="token punctuation">.</span>name</span><span class="token punctuation">}</span></span><span class="token string"> 年龄：</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token expression language-csharp">m_PlayerData<span class="token punctuation">.</span>age</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name"><span class="token keyword">string</span></span> playerData <span class="token operator">=</span> LitJson<span class="token punctuation">.</span>JsonMapper<span class="token punctuation">.</span><span class="token function">ToJson</span><span class="token punctuation">(</span>m_PlayerData<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token preprocessor property">#<span class="token directive keyword">if</span> UNITY_WEBGL</span>
        <span class="token class-name">WXFileSystemManager</span> fs <span class="token operator">=</span> WX<span class="token punctuation">.</span><span class="token function">GetFileSystemManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        fs<span class="token punctuation">.</span><span class="token function">WriteFileSync</span><span class="token punctuation">(</span>WX<span class="token punctuation">.</span>env<span class="token punctuation">.</span>USER_DATA_PATH <span class="token operator">+</span> fileName<span class="token punctuation">,</span> playerData<span class="token punctuation">,</span> <span class="token string">"utf-8"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token preprocessor property">#<span class="token directive keyword">endif</span></span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PlayerData</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token class-name"><span class="token keyword">string</span></span> name<span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token class-name"><span class="token keyword">int</span></span> age<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     <strong>
      测试结果：
     </strong>
     <br/>
     不校验是否存在本地目录就进行文件读取的报错：
     <br/>
     可以看到后面的读取和保存成功了：
     <br/>
     <img alt="" src="https://i-blog.csdnimg.cn/blog_migrate/6b0c206daf80841eee8ae61da2d1b954.png#pic_center"/>
    </p>
    <hr/>
    <p>
     <strong>
      PS：若只需要进行读取文件，在StreamingAssets文件夹下面的文件，在WebGL平台是可以通过
      <code>
       UnityWebRequest
      </code>
      来进行读取的。
     </strong>
    </p>
    <hr/>
    <h2>
     <a id="WebGL_119">
     </a>
     WebGL平台的一些限制
    </h2>
    <p>
     由于平台限制，有些功能在 WebGL 上是不支持的:
    </p>
    <ul>
     <li>
      不支持多线程，因为 JavaScript 不支持多线程，所以 System.Threading 命名空间下的类不要使用；
     </li>
     <li>
      不能直接使用 Socket，包括 System.Net下的任何类型，以及 System.Net.Sockets 下的部分类型，以及 UnityEngine.Network，如果需要在 WebGL 平台使用网络功能，可以使用 WWW或者 UnityWebRequest这些都是基于 Http协议的实现，如要需要高实时性，可以选择 WebSockets或者 WebRTC;
     </li>
     <li>
      WebGL 1.0是基于 OpenGL ES 2.0，WebGL 2.0基于 OpenGL ES 3.0，所以存在相应的限制；
     </li>
     <li>
      WebGL 是 AOT(ahead of time，即静态编译平台，因此不能使用 System.Reflection.Emit 下的类型进行代码生成，IL2CPP和 iOS 也是如此。
     </li>
    </ul>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/c867de050151925014158ca9da30169e.png"/>
    </p>
    <hr/>
    <h2>
     <a id="bug_133">
     </a>
     一个创建目录的bug
    </h2>
    <p>
     <mark>
      经过测试发现，目前版本的SDK，不能递归创建目录的上级目录后再创建该目录。官方提供的
      <br/>
      <code>
       wxFileSystem.MkdirSync( WX.env.USER_DATA_PATH + @"/Test/Test1", true);
      </code>
      接口参数为：true时不好用，一层目录都创建不出来。只能将参数调整为false，一级一级创建目录。
     </mark>
    </p>
    <p>
     创建多层目录返回结果，和使用时不存在目录的报错日志：
    </p>
    <blockquote>
     <p>
      GetFileSystemManager 33333 res:mkdirSync:fail permission denied, open http:/usr/Storage/P
     </p>
    </blockquote>
    <blockquote>
     <p>
      fs.js:130 Error: writeFileSync:fail permission denied, open http:/usr/Storage/P/tmp_Data1
      <br/>
      at o (VM19 WAGame.js:1)
     </p>
    </blockquote>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/8c16aaf012ac42ba5d46db0ccb2b6f65.png">
      <br/>
      在微信开发工具中可以看到工程使用的本地路径：
      <br/>
      <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/8497160297b5846da14041b7256851ac.png"/>
     </img>
    </p>
    <p>
     Demo测试代码分享，里面实现了：实现了
     <strong>
      校验目录、创建目录、删除目录、校验文件、新建文件、读取文件和复制文件
     </strong>
     等功能。
    </p>
    <pre><code class="prism language-csharp"><span class="token keyword">using</span> <span class="token namespace">System</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Collections</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Collections<span class="token punctuation">.</span>Generic</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>IO</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Text</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">UnityEngine</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">WeChatWASM</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WXFileSave</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">MonoBehaviour</span></span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">private</span> <span class="token class-name">WXFileSystemManager</span> wxFileSystem<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name"><span class="token keyword">string</span></span> rootPath<span class="token punctuation">;</span>
    
    <span class="token keyword">private</span> <span class="token class-name"><span class="token keyword">string</span></span> filePath<span class="token punctuation">;</span>
    
    <span class="token keyword">private</span> <span class="token class-name"><span class="token keyword">string</span></span> fileName<span class="token punctuation">;</span>
    
    <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        wxFileSystem <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">WXFileSystemManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        rootPath <span class="token operator">=</span> WX<span class="token punctuation">.</span>env<span class="token punctuation">.</span>USER_DATA_PATH<span class="token punctuation">;</span>
        filePath <span class="token operator">=</span> <span class="token string">"/Test/Data"</span><span class="token punctuation">;</span>
        fileName <span class="token operator">=</span> <span class="token string">"/text"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">OnGUI</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>GUI<span class="token punctuation">.</span><span class="token function">Button</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">Rect</span><span class="token punctuation">(</span><span class="token number">10</span> <span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">60</span><span class="token punctuation">,</span> <span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"同步创建目录"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token function">CreateDirectoryMkdir</span><span class="token punctuation">(</span>Path<span class="token punctuation">.</span><span class="token function">Combine</span><span class="token punctuation">(</span>rootPath<span class="token punctuation">,</span> filePath<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>GUI<span class="token punctuation">.</span><span class="token function">Button</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">Rect</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">60</span><span class="token punctuation">,</span> <span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"创建目录"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token function">CreateDirectory</span><span class="token punctuation">(</span>Path<span class="token punctuation">.</span><span class="token function">Combine</span><span class="token punctuation">(</span>rootPath<span class="token punctuation">,</span> filePath<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        
        <span class="token keyword">if</span> <span class="token punctuation">(</span>GUI<span class="token punctuation">.</span><span class="token function">Button</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">Rect</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">,</span> <span class="token number">60</span><span class="token punctuation">,</span> <span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"校验目录"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token function">CheckDirectoryExists</span><span class="token punctuation">(</span>Path<span class="token punctuation">.</span><span class="token function">Combine</span><span class="token punctuation">(</span>rootPath<span class="token punctuation">,</span> filePath<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>GUI<span class="token punctuation">.</span><span class="token function">Button</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">Rect</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">300</span><span class="token punctuation">,</span> <span class="token number">60</span><span class="token punctuation">,</span> <span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"删除目录"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token function">DeleteDirectory</span><span class="token punctuation">(</span>Path<span class="token punctuation">.</span><span class="token function">Combine</span><span class="token punctuation">(</span>rootPath<span class="token punctuation">,</span> filePath<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>       
       
        <span class="token keyword">if</span> <span class="token punctuation">(</span>GUI<span class="token punctuation">.</span><span class="token function">Button</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">Rect</span><span class="token punctuation">(</span><span class="token number">100</span> <span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">60</span><span class="token punctuation">,</span> <span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"写入文件"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token function">CreateFile</span><span class="token punctuation">(</span>rootPath<span class="token operator">+</span> filePath <span class="token operator">+</span> fileName<span class="token punctuation">,</span> <span class="token string">"测试写入内容"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        
        <span class="token keyword">if</span> <span class="token punctuation">(</span>GUI<span class="token punctuation">.</span><span class="token function">Button</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">Rect</span><span class="token punctuation">(</span><span class="token number">200</span> <span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">60</span><span class="token punctuation">,</span> <span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"文件带后缀"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token function">CreateFile</span><span class="token punctuation">(</span>rootPath<span class="token operator">+</span> filePath <span class="token operator">+</span> fileName <span class="token operator">+</span> <span class="token string">".txt"</span><span class="token punctuation">,</span> <span class="token string">"测试写入内容"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>GUI<span class="token punctuation">.</span><span class="token function">Button</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">Rect</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">60</span><span class="token punctuation">,</span> <span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"读取文件"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token function">ReadFile</span><span class="token punctuation">(</span>Path<span class="token punctuation">.</span><span class="token function">Combine</span><span class="token punctuation">(</span>rootPath<span class="token punctuation">,</span> filePath <span class="token operator">+</span> fileName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        
        <span class="token keyword">if</span> <span class="token punctuation">(</span>GUI<span class="token punctuation">.</span><span class="token function">Button</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">Rect</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">,</span> <span class="token number">60</span><span class="token punctuation">,</span> <span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"校验文件"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token function">CheckFileExists</span><span class="token punctuation">(</span>Path<span class="token punctuation">.</span><span class="token function">Combine</span><span class="token punctuation">(</span>rootPath<span class="token punctuation">,</span> filePath<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>GUI<span class="token punctuation">.</span><span class="token function">Button</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">Rect</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">300</span><span class="token punctuation">,</span> <span class="token number">60</span><span class="token punctuation">,</span> <span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"复制文件"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
           <span class="token comment">// CopyFile();</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 校验目录是否存在</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">bool</span></span> <span class="token function">CheckDirectoryExists</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> path<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        Debug<span class="token punctuation">.</span><span class="token function">Log</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$"校验路径：</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token expression language-csharp">path</span><span class="token punctuation">}</span></span><span class="token string">,是否存在</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token expression language-csharp">wxFileSystem<span class="token punctuation">.</span><span class="token function">AccessSync</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Equals</span><span class="token punctuation">(</span><span class="token string">"access:ok"</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> path <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> wxFileSystem<span class="token punctuation">.</span><span class="token function">AccessSync</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Equals</span><span class="token punctuation">(</span><span class="token string">"access:ok"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// 同步创建目录</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">CreateDirectoryMkdir</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> path<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// *** 参数为：true 不好用，不能递归创建目录的上级目录后再创建该目录。*** </span>
        <span class="token comment">// *** 只能一级一级创建目录 *** </span>
        <span class="token class-name"><span class="token keyword">string</span></span> res <span class="token operator">=</span> wxFileSystem<span class="token punctuation">.</span><span class="token function">MkdirSync</span><span class="token punctuation">(</span> WX<span class="token punctuation">.</span>env<span class="token punctuation">.</span>USER_DATA_PATH <span class="token operator">+</span> <span class="token string">@"/Test"</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        Debug<span class="token punctuation">.</span><span class="token function">Log</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$"同步创建目录</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token expression language-csharp">path</span><span class="token punctuation">}</span></span><span class="token string">：创建结果：</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token expression language-csharp">res</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/// &lt;summary&gt;</span>
    <span class="token comment">/// 创建目录</span>
    <span class="token comment">/// &lt;/summary&gt;</span>
    <span class="token comment">/// &lt;param name="path"&gt;&lt;/param&gt;</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">CreateDirectory</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> path<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        Debug<span class="token punctuation">.</span><span class="token function">Log</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$"同步创建目录：</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token expression language-csharp">path</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">MkdirParam</span> mkdirParam <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">MkdirParam</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//  *** 只能一级一级创建目录 *** </span>
        mkdirParam<span class="token punctuation">.</span>dirPath <span class="token operator">=</span> WX<span class="token punctuation">.</span>env<span class="token punctuation">.</span>USER_DATA_PATH <span class="token operator">+</span> <span class="token string">@"/Test1"</span><span class="token punctuation">;</span> <span class="token comment">// path</span>
        mkdirParam<span class="token punctuation">.</span>recursive <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        wxFileSystem<span class="token punctuation">.</span><span class="token function">Mkdir</span><span class="token punctuation">(</span>mkdirParam<span class="token punctuation">)</span><span class="token punctuation">;</span>
        Debug<span class="token punctuation">.</span><span class="token function">Log</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$"CreateDirectory 创建目录</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token expression language-csharp">path</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 删除目录</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">DeleteDirectory</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> path<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token class-name"><span class="token keyword">string</span></span> res <span class="token operator">=</span> wxFileSystem<span class="token punctuation">.</span><span class="token function">UnlinkSync</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>
        Debug<span class="token punctuation">.</span><span class="token function">Log</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$"DeleteDirectory 删除目录结果：</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token expression language-csharp">res</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 校验文件是否存在</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">bool</span></span> <span class="token function">CheckFileExists</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> path<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        Debug<span class="token punctuation">.</span><span class="token function">Log</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$"校验文件是否存在：</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token expression language-csharp">path</span><span class="token punctuation">}</span></span><span class="token string">,是否存在</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token expression language-csharp">wxFileSystem<span class="token punctuation">.</span><span class="token function">AccessSync</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Equals</span><span class="token punctuation">(</span><span class="token string">"ok"</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> path <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> wxFileSystem<span class="token punctuation">.</span><span class="token function">AccessSync</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Equals</span><span class="token punctuation">(</span><span class="token string">"ok"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 新建文件并写入内容</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">CreateFile</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> path<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">string</span></span> content<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        Debug<span class="token punctuation">.</span><span class="token function">Log</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$"新建文件 路径：</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token expression language-csharp">path</span><span class="token punctuation">}</span></span><span class="token string">,写入内容：</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token expression language-csharp">content</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        wxFileSystem<span class="token punctuation">.</span><span class="token function">WriteFileSync</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> content<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 读取文件内容</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">ReadFile</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> path<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 读取文件内容</span>
        wxFileSystem<span class="token punctuation">.</span><span class="token function">ReadFile</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">ReadFileParam</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            filePath <span class="token operator">=</span> path<span class="token punctuation">,</span>
            encoding <span class="token operator">=</span> <span class="token string">"utf-8"</span><span class="token punctuation">,</span>
            success <span class="token operator">=</span> <span class="token punctuation">(</span>res<span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
            <span class="token punctuation">{<!-- --></span>
                Debug<span class="token punctuation">.</span><span class="token function">Log</span><span class="token punctuation">(</span><span class="token string">"读取数据成功5555 **** ："</span> <span class="token operator">+</span> res<span class="token punctuation">.</span>stringData<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            fail <span class="token operator">=</span> <span class="token punctuation">(</span>res<span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
            <span class="token punctuation">{<!-- --></span>
                Debug<span class="token punctuation">.</span><span class="token function">LogError</span><span class="token punctuation">(</span><span class="token string">"读取数据 报错5555 ---- ："</span> <span class="token operator">+</span> res<span class="token punctuation">.</span>errMsg<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 复制文件</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">CopyFile</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> sourcePath<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">string</span></span> destPath<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        UnityEngine<span class="token punctuation">.</span>Debug<span class="token punctuation">.</span><span class="token function">Log</span><span class="token punctuation">(</span><span class="token string">"复制文件：***** "</span> <span class="token operator">+</span> sourcePath<span class="token punctuation">)</span><span class="token punctuation">;</span>
        wxFileSystem<span class="token punctuation">.</span><span class="token function">CopyFileSync</span><span class="token punctuation">(</span>sourcePath<span class="token punctuation">,</span> destPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
        UnityEngine<span class="token punctuation">.</span>Debug<span class="token punctuation">.</span><span class="token function">Log</span><span class="token punctuation">(</span><span class="token string">"复制文件：/ "</span> <span class="token operator">+</span> sourcePath<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <hr/>
    <h2>
     <a id="_310">
     </a>
     报错查看方法分享
    </h2>
    <p>
     转小游戏后可以通过打开调试模式在手机上看到报错日志，报错日志如下：
    </p>
    <p>
     exception thrown : Runtiseerror : null function orfunction signature ismatch . Rurtimcerror : nullfunction or function signature mismatch
    </p>
    <p>
     <img alt="" src="https://i-blog.csdnimg.cn/blog_migrate/6a73fc7627513c5811942616ce9e94ed.png#pic_center"/>
    </p>
    <p>
     Mini Progran Error null function or function signature mismatchRuntimeerror: null function or function signaturemismatc
    </p>
    <p>
     <img alt="" src="https://i-blog.csdnimg.cn/blog_migrate/bbbdac6965e9a03044ba917a482eacf1.png#pic_center"/>
    </p>
    <p>
     这两段报错是同一个问题触发的。第一次看到这种报错一脸茫然不知从何下手，再往下看两行就发现了我自己写的函数：
     <code>
      ScreenRatiosFilter
     </code>
     类中的
     <code>
      Fit
     </code>
     方法。都定位到报错方法了，之后的问题就不用我再说了吧。
    </p>
    <p>
     既然你都看到这里了，还是告诉你一下
     <strong>
      秘诀
     </strong>
     吧：实在判断不出来是哪里报的错，而在编辑器又复现不出来，补日志，然后复现一下错误，这样就可以定位到具体报错行数了。
    </p>
    <p>
     还遇到过一个奇怪的问题，一并记录一下。希望对你有所启发：一段游戏逻辑只在小游戏中报错，编辑器和其他端都没问题。后来加了一个
     <code>
      try...catch
     </code>
     捕获了一次，没做其他任何处理，然后竟然好用了…
    </p>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
  <div class="blog-extension-box" id="blogExtensionBox" style="width:400px;margin:auto;margin-top:12px">
  </div>
 </article>
 <p alt="6874747073:3a2f2f626c6f672e6373646e2e6e65742f437a68656e79612f:61727469636c652f64657461696c732f313239373534303037" class_="artid" style="display:none">
 </p>
</div>


