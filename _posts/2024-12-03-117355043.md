---
layout: post
title: "harmonyos能否移植到MCU,HarmonyOSLiteOs_m-官方例程移植到STM32初体验"
date: 2024-12-03 22:23:22 +0800
description: "HarmonyOS(LiteOs_m) 官方例程移植到STM32初体验硬件平台基于正点原子战舰V3开"
keywords: "liteos-m keil"
categories: ['']
tags: ['Harmonyos']
artid: "117355043"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=117355043
    alt: "harmonyos能否移植到MCU,HarmonyOSLiteOs_m-官方例程移植到STM32初体验"
render_with_liquid: false
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     harmonyos能否移植到MCU,HarmonyOS(LiteOs_m) 官方例程移植到STM32初体验
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="htmledit_views" id="content_views">
    <div style="font-size:16px;">
     <p>
      HarmonyOS(LiteOs_m) 官方例程移植到STM32初体验
     </p>
     <p>
      硬件平台
     </p>
     <p>
      基于正点原子战舰V3开发板
     </p>
     <p>
      MCU:STM32F103ZET6
     </p>
     <p>
      片上SRAM大小:64KBytes
     </p>
     <p>
      片上FLASH大小:512KBytes
     </p>
     <p>
      移植准备
     </p>
     <p>
      IDE软件：Keil MDK5
     </p>
     <p>
      串口调试助手
     </p>
     <p>
      源码下载
     </p>
     <p>
      HarmonyOS源码开源在gitee上
     </p>
     <p>
      LiteOS_m的源码仓库
     </p>
     <p>
      源码结构
     </p>
     <p>
      根文件夹下的arch_spec.md文件内容即源码结构树，但该结构树不是最新，可以看到当前targers文件夹下已经添加了对STM32F1单片机的例程，但该结构树中并未列出
     </p>
     <p>
      .
     </p>
     <p>
      ├── components --- 可选组件，可裁剪，依赖kernel
     </p>
     <p>
      │   ├── cppsupport --- C++支持
     </p>
     <p>
      │   └── cpup --- CPUP功能
     </p>
     <p>
      ├── kal --- 内核抽象层
     </p>
     <p>
      │   ├── cmsis --- cmsis标准支持
     </p>
     <p>
      │   └── posix --- posix标准支持
     </p>
     <p>
      ├── kernel --- 内核最小功能集支持
     </p>
     <p>
      │   ├── arch --- 硬件架构相关
     </p>
     <p>
      │   │   ├── arm --- arm32架构
     </p>
     <p>
      │   │   │   └── cortex-m4 --- cortex-m4架构
     </p>
     <p>
      │   │   │   └── iar ---
     </p>
     <p>
      │   │   │   ├── los_atomic.h
     </p>
     <p>
      │   │   │   ├── los_context.h
     </p>
     <p>
      │   │   │   ├── los_interrupt.h
     </p>
     <p>
      │   │   │   └── los_mpu.h
     </p>
     <p>
      │   │   └── include
     </p>
     <p>
      │   │   ├── los_arch_atomic.h --- 定义通用arch的原子操作
     </p>
     <p>
      │   │   ├── los_arch_context.h --- 定义通用arch的上下文切换
     </p>
     <p>
      │   │   ├── los_arch.h --- 定义通用arch初始化
     </p>
     <p>
      │   │   └── los_arch_interrupt.h --- 定义通用arch中断
     </p>
     <p>
      │   ├── include
     </p>
     <p>
      │   │   ├── los_config.h --- 功能开关和配置参数
     </p>
     <p>
      │   │   ├── los_event.h --- 事件
     </p>
     <p>
      │   │   ├── los_liteos.h --- liteos最小功能集对外提供的头文件
     </p>
     <p>
      │   │   ├── los_memory.h --- 堆内存管理
     </p>
     <p>
      │   │   ├── los_mutex.h --- 互斥锁
     </p>
     <p>
      │   │   ├── los_queue.h --- 队列
     </p>
     <p>
      │   │   ├── los_scheduler.h --- 调度算法
     </p>
     <p>
      │   │   ├── los_sem.h --- 信号量
     </p>
     <p>
      │   │   ├── los_task.h --- 任务
     </p>
     <p>
      │   │   └── los_timer.h --- 定时器
     </p>
     <p>
      │   └── src
     </p>
     <p>
      ├── targets
     </p>
     <p>
      │   └── targets
     </p>
     <p>
      │   └── cortex-m4_stm32f429ig_fire-challenger_iar
     </p>
     <p>
      │   ├── board
     </p>
     <p>
      │   ├── dprintf.c
     </p>
     <p>
      │   ├── Libraries
     </p>
     <p>
      │   ├── main.c
     </p>
     <p>
      │   ├── project
     </p>
     <p>
      │   ├── target_config.h --- 板级配置功能开关和配置参数
     </p>
     <p>
      │   └── Utilities
     </p>
     <p>
      └── utils
     </p>
     <p>
      ├── include
     </p>
     <p>
      │   ├── los_compiler.h --- 编译工具配置，类型定义
     </p>
     <p>
      │   ├── los_debug.h --- debug，printf相关
     </p>
     <p>
      │   ├── los_error.h --- 错误定义
     </p>
     <p>
      │   └── los_list.h
     </p>
     <p>
      └── src
     </p>
     <p>
      启动流程
     </p>
     <p>
      在\targets\cortex-m3_stm32f103_simulator_keil\project文件夹下打开工程文件(los_demo.uvproj)
     </p>
     <p>
      工程下有三个文件夹：liteos-m、main、component
     </p>
     <p>
      程序加载时，首先进入liteos-m下的los_startup.s文件，内容如下
     </p>
     <p>
      PRESERVE8
     </p>
     <p>
      AREA RESET, CODE, READONLY
     </p>
     <p>
      THUMB
     </p>
     <p>
      IMPORT ||Image$$ARM_LIB_STACKHEAP$$ZI$$Limit||
     </p>
     <p>
      IMPORT HalHwiDefaultHandler
     </p>
     <p>
      EXPORT _BootVectors
     </p>
     <p>
      EXPORT Reset_Handler
     </p>
     <p>
      _BootVectors
     </p>
     <p>
      DCD ||Image$$ARM_LIB_STACKHEAP$$ZI$$Limit||
     </p>
     <p>
      DCD Reset_Handler
     </p>
     <p>
      DCD HalHwiDefaultHandler
     </p>
     <p>
      DCD HalHwiDefaultHandler
     </p>
     <p>
      Reset_Handler
     </p>
     <p>
      CPSID I
     </p>
     <p>
      IMPORT LOS_HardBootInit
     </p>
     <p>
      BL LOS_HardBootInit
     </p>
     <p>
      IMPORT __main
     </p>
     <p>
      LDR R0, =__main
     </p>
     <p>
      BX R0
     </p>
     <p>
      ALIGN
     </p>
     <p>
      END
     </p>
     <p>
      可以看出，启动文件只定义了启动向量和reset向量，其他的向量在los_interrupt.c中动态加载
     </p>
     <p>
      通过LOS_HardBootInit跳转到系统硬件初始化代码,对Uart进行初始化(该例程只用到了串口)
     </p>
     <p>
      void LOS_HardBootInit()
     </p>
     <p>
      {
      <!-- -->
     </p>
     <p>
      UINT32 uwRet = LOS_OK;
     </p>
     <p>
      uwRet = LOS_UartBaseInit();
     </p>
     <p>
      if (uwRet != LOS_OK)
     </p>
     <p>
      {
      <!-- -->
     </p>
     <p>
      return ;
     </p>
     <p>
      }
     </p>
     <p>
      return ;
     </p>
     <p>
      }
     </p>
     <p>
      初始化后回到启动文件并跳转到main函数：
     </p>
     <p>
      LITE_OS_SEC_TEXT_INIT int main(void)
     </p>
     <p>
      {
      <!-- -->
     </p>
     <p>
      unsigned int ret;
     </p>
     <p>
      //USART_Config();
     </p>
     <p>
      printf("\n\rhello world!!\n\r");
     </p>
     <p>
      ret = LOS_KernelInit();
     </p>
     <p>
      taskSample();
     </p>
     <p>
      if (ret == LOS_OK) {
      <!-- -->
     </p>
     <p>
      LOS_Start();
     </p>
     <p>
      }
     </p>
     <p>
      while (1) {
      <!-- -->
     </p>
     <p>
      __asm volatile("wfi");
     </p>
     <p>
      }
     </p>
     <p>
      }
     </p>
     <p>
      main函数开始进行了hello world打印，并进行了内核的初始化，最后进行进程测试，创建并运行两个进程
     </p>
     <p>
      移植需要的修改
     </p>
     <p>
      工程中使用自定义.sct文件对各个区进行分散加载，详细加载文件见\targets\cortex-m3_stm32f103_simulator_keil\project\los_demo.sct(注意路径，不是output文件夹下的.sct文件，keil在编译过程中也会产生一个.sct文件)，详细内容如下:
     </p>
     <p>
      LR_IROM1 0x08000000 0x00200000 { ; load region size_region
     </p>
     <p>
      ER_IROM1 0x08000000 0x00200000 { ; load address = execution address
     </p>
     <p>
      los_startup.o (RESET, +First)
     </p>
     <p>
      *(InRoot$$Sections)
     </p>
     <p>
      * (+RO)
     </p>
     <p>
      }
     </p>
     <p>
      RW_IRAM1 0x20000000 0x00200000 { ; RW data
     </p>
     <p>
      * (.data, .bss, .data.init)
     </p>
     <p>
      }
     </p>
     <p>
      VECTOR 0x20200000 0x400 ; Vector
     </p>
     <p>
      {
      <!-- -->
     </p>
     <p>
      * (.vector)
     </p>
     <p>
      }
     </p>
     <p>
      ARM_LIB_STACKHEAP 0x08100000 EMPTY 0x1000
     </p>
     <p>
      {
      <!-- -->
     </p>
     <p>
      }
     </p>
     <p>
      }
     </p>
     <p>
      由于片内SRAM和FLASH大小等因素，各段映射地址需要进行相应调整，我修改的映射地址如下(个人习惯):
     </p>
     <p>
      LR_IROM1 0x08000000 0x00080000 { ; 加载域FLASH起始地址0x08000000 大小0x00080000(512KBytes)
     </p>
     <p>
      ER_IROM1 0x08000000 0x00080000 { ; 从FLASH中加载程序，所以将程序启动文件定向到FLASH首地址，其它只读字段也定位到这里
     </p>
     <p>
      los_startup.o (RESET, +First)
     </p>
     <p>
      *(InRoot$$Sections)
     </p>
     <p>
      * (+RO)
     </p>
     <p>
      }
     </p>
     <p>
      RW_IRAM1 0x20000000 0x00010000 { ; SRAM起始地址0x20000000 大小0x00010000(64KBytes)，其它读写段和未初始化变量均定位到SRAM中
     </p>
     <p>
      * (.data, .bss, .data.init)
     </p>
     <p>
      }
     </p>
     <p>
      VECTOR 0x2000E000 0x1000 ; 向量表地址
     </p>
     <p>
      {
      <!-- -->
     </p>
     <p>
      * (.vector)
     </p>
     <p>
      }
     </p>
     <p>
      ARM_LIB_STACKHEAP 0x20010000 EMPTY -0x1000 ;堆栈空间，存放在内存的高地址向下的一段空间，大小0x1000(4KBytes)
     </p>
     <p>
      {
      <!-- -->
     </p>
     <p>
      }
     </p>
     <p>
      }
     </p>
     <p>
      由于SRAM内存限制，需要修改OS内存池大小
     </p>
     <p>
      修改位置为\targets\cortex-m3_stm32f103_simulator_keil\target_config.h文件中的OS_SYS_MEM_SIZE宏定义，将内存池大小减小，我将其修改为了0x00000D000(52KBytes)
     </p>
     <p>
      编译运行
     </p>
     <p>
      将输出文件下载进MCU，连接串口波特率设置115200即可输出helloworld信息和进程运行信息
     </p>
     <p>
      原创内容，转载请注明来源
     </p>
    </div>
   </div>
  </div>
  <div id="recommendDown">
  </div>
 </article>
 <p alt="68747470733a2f2f626c6f672e:6373646e2e6e65742f77656978696e5f33343138393235392f:61727469636c652f64657461696c732f313137333535303433" class_="artid" style="display:none">
 </p>
</div>


