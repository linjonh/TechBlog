---
layout: post
title: "FFmpeg转码音视频不同步情况总结"
date: 2024-11-25 17:32:06 +0800
description: "文章浏览阅读3.3k次。FFmpeg转码音视频不同步情况总结_ffmpeg转码后音视频不同步"
keywords: "ffmpeg转码后音视频不同步"
categories: ['音视频开发进阶']
tags: ['音视频', '视频编解码', '实时音视频', '实时互动', 'webrtc']
artid: "126707225"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=126707225
    alt: "FFmpeg转码音视频不同步情况总结"
render_with_liquid: false
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     FFmpeg转码音视频不同步情况总结
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="htmledit_views" id="content_views">
    <p>
     使用FFmpeg转码，会遇到了各种情况的音视频不同步，下面我们就来根据问题出现的原因，对所遇到的音视频不同步做一个分类。
    </p>
    <h3>
    </h3>
    <h2>
     1. 源本身音视频不同步且无法播放
    </h2>
    <p>
     这种情况极为罕见，在A客户东方卫视频道转码时遇到过。
    </p>
    <p>
     表现为输出的音视频严重不匹配，录制下来的视频源无法播放，要么只有声音没有图像，要么只有图像没有声音，且图像播放卡顿。
    </p>
    <p>
     解决方案：转码器无法修复这种异常源，需要反馈给源提供方修复。
    </p>
    <h3>
    </h3>
    <h2>
     2. 源本身的时间戳问题，但源可正常播放
    </h2>
    <p>
     这种情况较少见，在M客户湖南卫视直播源时出现过。
    </p>
    <p>
     表现为转码出来的视频图像播放正常，但是没有声音。录制下来的视频源能正常播放。
    </p>
    <p>
     分析方法：打印出输入AVPacket包的时间戳，发现音频包的PTS正常，而DTS长时间不变。
    </p>
    <p>
     解决方法：读出音频数据包后，如果判断DTS != PTS，则强制将DTS设为PTS的值。
    </p>
    <blockquote>
     <p style="margin-left:0;text-align:justify;">
      <span style="background-color:#eef0f4;">
       <strong>
        <span style="color:#FF0000;">
         本文福利，
        </span>
        <span style="background-color:#eef0f4;">
         <span style="color:#FF0000;">
          免费领取C++音视频学习资料包、技术视频
         </span>
        </span>
       </strong>
       <strong>
        <span style="color:#FF0000;">
         ，内容包括（音视频开发，面试题，
        </span>
       </strong>
       <strong>
        <span style="color:#FF0000;">
         FFmpeg
        </span>
       </strong>
       <strong>
        <span style="color:#FF0000;">
         ，
        </span>
       </strong>
       <strong>
        <span style="color:#FF0000;">
         webRTC
        </span>
       </strong>
       <strong>
        <span style="color:#FF0000;">
         ，
        </span>
       </strong>
       <strong>
        <span style="color:#FF0000;">
         rtmp
        </span>
       </strong>
       <strong>
        <span style="color:#FF0000;">
         ，
        </span>
       </strong>
       <strong>
        <span style="color:#FF0000;">
         hls
        </span>
       </strong>
       <strong>
        <span style="color:#FF0000;">
         ，
        </span>
       </strong>
       <strong>
        <span style="color:#FF0000;">
         rtsp
        </span>
       </strong>
       <strong>
        <span style="color:#FF0000;">
         ，
        </span>
       </strong>
       <strong>
        <span style="color:#FF0000;">
         ffplay
        </span>
       </strong>
       <strong>
        <span style="color:#FF0000;">
         ，
        </span>
       </strong>
       <strong>
        <span style="color:#FF0000;">
         srs
        </span>
       </strong>
       <strong>
        <span style="color:#FF0000;">
         ）
        </span>
        <span style="background-color:#eef0f4;">
         <span style="color:#FF0000;">
          ↓↓↓↓↓↓
         </span>
        </span>
        <span style="background-color:#eef0f4;">
         <span style="color:#FF0000;">
          见下面↓↓文章底部点击免费领取↓↓
         </span>
        </span>
       </strong>
      </span>
     </p>
    </blockquote>
    <h3>
    </h3>
    <h2>
     3. 一段时间内，只丢失一个流的数据
    </h2>
    <p>
     在M客户的中国气象频道转码过程中遇到。
    </p>
    <p>
     表现：输入源有数据持续输入的情况下，转码有一段时间没有输出，且恢复输出后播放没有声音。
    </p>
    <p>
     分析方法：录制出问题时间段的视频源，分析其中的音视频数据包及时间戳。分析发现在一段时间之内，大概几秒到十几秒，输入的音频流丢失而视频流正常，导致在输出交织时一直等不到音频流而不断地buffer数据，直到音频流恢复后，或者等待超时后才有数据输出，而输入音频流恢复后，由于FFMPEG中执行了如下代码调整了原本正常的音频时间戳，使得音频时间戳错乱，导致播放时只有画面而没有声音。
    </p>
    <p style="text-align:center;">
     <img alt="" src="https://i-blog.csdnimg.cn/blog_migrate/e9ba69c629abf9c6148ab57570492564.png"/>
    </p>
    <h3>
    </h3>
    <h2>
     4. 源的部分视频帧未设置时间戳
    </h2>
    <p>
     在一些客户的直播转码过程中，输入输出帧率相同的情况下，会遇到log中大量打印“Past duration XXX too large”且伴有frame drop相关信息的打印。
    </p>
    <p>
     分析方法：将输入视频包的时间戳信息打印出来，发现一些视频帧未设置DTS/PTS，这些视频帧携带的时间戳都是默认值为AV_NOPTS_VALUE，代码中对该值的定义如下：
    </p>
    <p>
     #define AV_NOPTS_VALUE ((int64_t)UINT64_C(0x8000000000000000))
    </p>
    <p>
     而这些帧在编码输出之前会被Drop掉，为了满足设定的帧率，后面的有效时间戳的帧会提前输出，导致视频提前而音频滞后。
    </p>
    <p>
     解决方法：由于我们为这些未设置时间戳的输入帧填充有效时间戳不是一件很容易的事(需要结合输入视频是否采用B帧等)，因此在输入输出帧率相同时，我们可以将这些携带无效时间戳的帧正常送至编码器编码并输出，而不是丢弃。
    </p>
    <h3>
    </h3>
    <h2>
     5. "dts &lt; pcr"
    </h2>
    <p>
     在线CBR转码时常遇到"dts &lt; pcr, TS is invalid"的打印，时间久了也可能引起输出码流的音视频失步。
    </p>
    <p>
     首先我们先看看代码中PCR的计算，
     <img alt="" height="118" src="https://i-blog.csdnimg.cn/blog_migrate/695f7ba06230f9e50d2498b47bb18d9c.png" width="726"/>
    </p>
    <p>
     可见PCR的值与muxrate和写入到AVIOContext中的数据量有关系。
    </p>
    <p>
     在保证封装码率稳定的前提下，我们需要关注写入到AVIOContext中的音视频数据的速度。一般音频编码的速率较为稳定，而视频编码速度受B帧策略的影响较大，当视频编码使用较多的B帧时，由于是双向预测，导致编码速度慢于时间戳相近的音频帧，而当视频帧编码完成并输出时，AVIOContext中已经填充了较多的音频帧，使得PCR值超过了当前输出的视频帧的DTS，即出现了“dts &lt; pcr”的打印。
    </p>
    <p>
     解决方法: 在线转码时，在对视频质量没有特别要求的前提下，优先保证编码速度，就x264编码器来说，可以使用zerolatency策略，禁掉B帧的使用并尽量降低编码延迟。
    </p>
    <h3>
    </h3>
    <h2>
     6. 循环源与非单调时间戳
    </h2>
    <p>
     在M客户电竞直播与H客户云转码项目中都遇到了这种循环源与非单调时间戳问题。
    </p>
    <p>
     FFMPEG默认只支持单调时间戳，一旦遇到非单调时间戳，FFMPEG会强制修改输出时间戳，代码如下，
    </p>
    <p>
     <img alt="" height="259" src="https://i-blog.csdnimg.cn/blog_migrate/6802199e519847675985204807cccdfa.png" width="792"/>
    </p>
    <p>
     但修改后的时间戳是不正常的，导致输出视频播放异常。具体表现为，若为音视频透传，则输出的音视频均异常；若转码，输出的视频正常，而音频异常，这是因为视频编码器会根据帧率和输出的帧数重新计算时间戳，而音频时间戳则是继承了输入时间戳，从而输出的视频时间戳为单调递增的正常值，而音频时间戳为FFMPEG强制修改后的值，导致播放没有声音。
    </p>
    <p>
     解决方法：
    </p>
    <p>
     包括三个方面，
    </p>
    <p>
     1. 将以上截图部分对时间戳的修改注销；
    </p>
    <p>
     2. 取消由于非单调时间戳导致的转码退出：
    </p>
    <p>
     <img alt="" height="201" src="https://i-blog.csdnimg.cn/blog_migrate/d2989d25e195c805a7e7f7f2bc224ec7.png" width="718"/>
    </p>
    <p>
     3. 需要转码时，由于视频转码输出时间戳为单调递增，为了使音频时间戳与视频时间戳同步，需要将音频时间戳按照单调递增的顺序来说出，算法设计时需要考虑时间戳跳变、丢帧等各种情况的处理。
    </p>
    <h3>
    </h3>
    <h2>
     7.长时间转码后出现轻微音视频不同步
    </h2>
    <p>
     这种音视频不同步暂时没有找到根本原因，多见于网络不稳定时，对音视频丢帧数量统计不精确导致网络恢复后时间戳出现轻微不对齐，且随着转码时间的延长或者网络波动情况的增多，不同步程度会加重。由于暂时无法确定具体原因，且一般在转码几天之后才出现，因此针对该情况的处理方案是，设计一套音视频不同步检测算法来评估音视频不同步的程度，当达到一定的阈值后，通知前端重启转码器以达到重新同步。
    </p>
    <blockquote>
     <p style="margin-left:0;text-align:justify;">
      <span style="background-color:#eef0f4;">
       <strong>
        <span style="color:#FF0000;">
         本文福利，
        </span>
        <span style="background-color:#eef0f4;">
         <span style="color:#FF0000;">
          免费领取C++音视频学习资料包、技术视频
         </span>
        </span>
       </strong>
       <strong>
        <span style="color:#FF0000;">
         ，内容包括（音视频开发，面试题，
        </span>
       </strong>
       <strong>
        <span style="color:#FF0000;">
         FFmpeg
        </span>
       </strong>
       <strong>
        <span style="color:#FF0000;">
         ，
        </span>
       </strong>
       <strong>
        <span style="color:#FF0000;">
         webRTC
        </span>
       </strong>
       <strong>
        <span style="color:#FF0000;">
         ，
        </span>
       </strong>
       <strong>
        <span style="color:#FF0000;">
         rtmp
        </span>
       </strong>
       <strong>
        <span style="color:#FF0000;">
         ，
        </span>
       </strong>
       <strong>
        <span style="color:#FF0000;">
         hls
        </span>
       </strong>
       <strong>
        <span style="color:#FF0000;">
         ，
        </span>
       </strong>
       <strong>
        <span style="color:#FF0000;">
         rtsp
        </span>
       </strong>
       <strong>
        <span style="color:#FF0000;">
         ，
        </span>
       </strong>
       <strong>
        <span style="color:#FF0000;">
         ffplay
        </span>
       </strong>
       <strong>
        <span style="color:#FF0000;">
         ，
        </span>
       </strong>
       <strong>
        <span style="color:#FF0000;">
         srs
        </span>
       </strong>
       <strong>
        <span style="color:#FF0000;">
         ）
        </span>
        <span style="background-color:#eef0f4;">
         <span style="color:#FF0000;">
          ↓↓↓↓↓↓
         </span>
        </span>
        <span style="background-color:#eef0f4;">
         <span style="color:#FF0000;">
          见下面↓↓文章底部点击免费领取↓↓
         </span>
        </span>
       </strong>
      </span>
     </p>
    </blockquote>
   </div>
  </div>
  <div class="blog-extension-box" id="blogExtensionBox" style="width:400px;margin:auto;margin-top:12px">
  </div>
 </article>
 <p alt="68747470733a2f2f62:6c6f672e6373646e2e6e65742f6d305f36303235393131362f:61727469636c652f64657461696c732f313236373037323235" class_="artid" style="display:none">
 </p>
</div>


