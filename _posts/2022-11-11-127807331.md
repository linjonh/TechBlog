---
layout: post
title: "微信小程序-基于小程序JavaWebSocket实现实时聊天功能"
date: 2022-11-11 17:40:59 +0800
description: "此文主要实现在小程序内聊天对话功能，使用Java作为后端语言进行支持，使用Websocket进行即时"
keywords: "websocket java 聊天"
categories: ['小程序', 'Java']
tags: ['微信小程序', '小程序', 'Java']
artid: "127807331"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=127807331
    alt: "微信小程序-基于小程序JavaWebSocket实现实时聊天功能"
render_with_liquid: false
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     微信小程序 | 基于小程序+Java+WebSocket实现实时聊天功能
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <h3>
     <a id="_0">
     </a>
     一、文章前言
    </h3>
    <blockquote>
     <p>
      此文主要实现在小程序内聊天对话功能，使用Java作为后端语言进行支持，界面友好，开发简单。
     </p>
    </blockquote>
    <center>
     <img src="https://i-blog.csdnimg.cn/blog_migrate/7412888c7e70f97f2fc4842f0dc66e32.gif" width="570/">
     </img>
    </center>
    <h3>
     <a id="_11">
     </a>
     二、开发流程及工具准备
    </h3>
    <p>
     <font color="red">
      2.1、注册微信公众平台账号。
     </font>
     <br/>
     <font color="red">
      2.2、下载安装IntelliJ IDEA(后端语言开发工具)，Mysql数据库，微信Web开发者工具。
     </font>
    </p>
    <h3>
     <a id="_16">
     </a>
     三、开发步骤
    </h3>
    <blockquote>
     <p>
      <strong>
       1.创建maven project
      </strong>
     </p>
    </blockquote>
    <p>
     先创建一个名为SpringBootDemo的项目，选择【New Project】
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/48a823e829c2ad070faf9f82ca23c442.png"/>
    </p>
    <p>
     然后在弹出的下图窗口中，选择左侧菜单的【New Project】（注：和2022之前的idea版本不同，这里左侧没有【Maven】选项，不要选【Maven Archetype】！！！），输入Name(项目名)：SpringBootDemo,language选择【java】，build system选择【maven】，然后选择jdk，我这里选的是jdk18.
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/0e6b2a44bf5aff30b12caa256876f92b.png">
      然后点击【Create】
      <br/>
      <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/92d21705faed0a4549a14de304e1aec2.png"/>
     </img>
    </p>
    <blockquote>
     <p>
      <strong>
       2.在project下创建module
      </strong>
     </p>
    </blockquote>
    <p>
     点击右键选择【new】—【Module…】
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/473f2de6ce8c3c50ab6e9f8e83fe0145.png">
      <br/>
      左侧选择【Spring initializr】，通过idea中集成的Spring initializr工具进行spring boot项目的快速创建。窗口右侧：name可根据自己喜好设置，group和artifact和上面一样的规则，其他选项保持默认值即可，【next】
      <br/>
      <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/f4f02dddbbb8fe73f9debb907482bd95.png"/>
     </img>
    </p>
    <p>
     Developer Tools模块勾选【Spring Boot DevTools】，web模块勾选【Spring Web】
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/0986461c3b44e1aaa7eb70284a4ad25f.png"/>
    </p>
    <p>
     <em>
      <strong>
       此时，一个Springboot项目已经搭建完成，可开发后续功能
      </strong>
     </em>
    </p>
    <blockquote>
     <p>
      <strong>
       3.编写一个消息实体类、Mapper、service（三层架构）
      </strong>
     </p>
    </blockquote>
    <pre><code class="prism language-java"><span class="token annotation punctuation">@Data</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Chat</span> <span class="token punctuation">{<!-- --></span>

    <span class="token annotation punctuation">@TableId</span><span class="token punctuation">(</span>type <span class="token operator">=</span> <span class="token class-name">IdType</span><span class="token punctuation">.</span><span class="token constant">AUTO</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> id<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">Long</span> userId<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">Long</span> targetUserId<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">LocalDateTime</span> createTime<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">String</span> userName<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">String</span> targetUserName<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">String</span> content<span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre>
    <p>
     <strong>
      由于我们使用mybatis-plus，所以简单的增删改查不用自己写，框架自带了，只需要实现或者继承他的Mapper、Service
     </strong>
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/46ff32e8cc1cec9b06cea9b819e4a436.png">
      <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/a8fde1cd720dd647ae8ad426f359e18c.png"/>
     </img>
    </p>
    <blockquote>
     <p>
      <strong>
       4.编写WebSocket服务类
      </strong>
     </p>
    </blockquote>
    <pre><code class="prism language-java"><span class="token annotation punctuation">@ServerEndpoint</span><span class="token punctuation">(</span><span class="token string">"/imserver/{userId}"</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WebSocketService</span> <span class="token punctuation">{<!-- --></span>



    <span class="token comment">/**
     * 连接建立成功调用的方法
     * &lt;p&gt;
     * 1.用map存 每个客户端对应的MyWebSocket对象
     */</span>
    <span class="token annotation punctuation">@OnOpen</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onOpen</span><span class="token punctuation">(</span><span class="token class-name">Session</span> session<span class="token punctuation">,</span> <span class="token annotation punctuation">@PathParam</span><span class="token punctuation">(</span><span class="token string">"userId"</span><span class="token punctuation">)</span> <span class="token class-name">String</span> userId<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>session <span class="token operator">=</span> session<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>userId <span class="token operator">=</span> userId<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>webSocketMap<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            webSocketMap<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            webSocketMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>userId<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//加入set中</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            webSocketMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>userId<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//加入set中</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>


 

    <span class="token comment">/**
     * 自定义关闭
     *
     * @param userId
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">close</span><span class="token punctuation">(</span><span class="token class-name">String</span> userId<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>webSocketMap<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            webSocketMap<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 获取在线用户信息
     *
     * @return
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Map</span> <span class="token function">getOnlineUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> webSocketMap<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre>
    <blockquote>
     <p>
      <strong>
       5.创建控制器Controller
      </strong>
     </p>
    </blockquote>
    <p>
     先创建Controller Package
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/607d28d1f1a97a6cafecb5ccf2c36c68.png"/>
    </p>
    <p>
     创建一个Controller
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/2a590dc27e72a969b1e117ca029fe9fc.png"/>
     <br/>
     输入类名，选在【Class】
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/88a56f5da5f0ac08bc6e1ba908e365c2.png"/>
    </p>
    <p>
     因为要编写
     <font color="red">
      Rest风格
     </font>
     的Api，要在Controller上标注
     <font color="red">
      @RestController
     </font>
     注解
    </p>
    <blockquote>
     <p>
      6.创建具体的Api接口
     </p>
    </blockquote>
    <pre><code class="prism language-java">

<span class="token annotation punctuation">@RestController</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DemoController</span> <span class="token punctuation">{<!-- --></span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">ChatService</span> chatService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">"/push"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">ResponseEntity</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token function">pushToWeb</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">Chat</span> chat<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{<!-- --></span>
        chat<span class="token punctuation">.</span><span class="token function">setCreateTime</span><span class="token punctuation">(</span><span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        chatService<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>chat<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">WebSocketService</span><span class="token punctuation">.</span><span class="token function">sendInfo</span><span class="token punctuation">(</span>chat<span class="token punctuation">)</span><span class="token punctuation">;</span>


        <span class="token keyword">return</span> <span class="token class-name">ResponseEntity</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token string">"MSG SEND SUCCESS"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/close"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">close</span><span class="token punctuation">(</span><span class="token class-name">String</span> userId<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">WebSocketService</span><span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token string">"ok"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/getOnlineUser"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">Map</span> <span class="token function">getOnlineUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token class-name">WebSocketService</span><span class="token punctuation">.</span><span class="token function">getOnlineUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    
<span class="token punctuation">}</span>
</code></pre>
    <p>
     7.小程序代码
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/da37825306ea6393ea95b0dbc7646e8f.png"/>
     <br/>
     <font color="red">
      3.20、在pages文件夹下面创建一个文件夹并新建对应的page文件，并实现聊天对话框样式。
     </font>
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/c1e4e3c4e355ecf5fa6d2cdd5740b364.png"/>
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/49928e4c34fb70451f9c4afb2d9ac151.png"/>
    </p>
    <pre><code class="prism language-c"><span class="token operator">&lt;</span>view class<span class="token operator">=</span><span class="token string">"cu-chat"</span> id<span class="token operator">=</span><span class="token string">"j_page"</span><span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>view class<span class="token operator">=</span><span class="token string">"cu-item 'self'"</span> wx<span class="token operator">:</span><span class="token keyword">for</span><span class="token operator">=</span><span class="token string">"{<!-- -->{chatData}}"</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>view class<span class="token operator">=</span><span class="token string">"main"</span><span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span>view class<span class="token operator">=</span><span class="token string">"content shadow bg-green"</span><span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>text<span class="token operator">&gt;</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span>item<span class="token punctuation">.</span>content<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>text<span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span><span class="token operator">/</span>view<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>view<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>view class<span class="token operator">=</span><span class="token string">"cu-avatar radius"</span> style<span class="token operator">=</span><span class="token string">"background-image:url(../../../images/cat.jpg)"</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>view<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>view class<span class="token operator">=</span><span class="token string">"date"</span><span class="token operator">&gt;</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span>item<span class="token punctuation">.</span>createTime<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>view<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span><span class="token operator">/</span>view<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>view<span class="token operator">&gt;</span>

<span class="token operator">&lt;</span>view class<span class="token operator">=</span><span class="token string">"cu-bar foot input {<!-- -->{InputBottom!=0?'cur':''}}"</span> style<span class="token operator">=</span><span class="token string">"bottom:{<!-- -->{InputBottom}}px"</span><span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>view class<span class="token operator">=</span><span class="token string">"action"</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>text class<span class="token operator">=</span><span class="token string">"cuIcon-sound text-grey"</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>text<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span><span class="token operator">/</span>view<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>input class<span class="token operator">=</span><span class="token string">"solid-bottom"</span> value<span class="token operator">=</span><span class="token string">"{<!-- -->{content}}"</span> bindinput<span class="token operator">=</span><span class="token string">"formMsg"</span>  bindfocus<span class="token operator">=</span><span class="token string">"InputFocus"</span> bindblur<span class="token operator">=</span><span class="token string">"InputBlur"</span> adjust<span class="token operator">-</span>position<span class="token operator">=</span><span class="token string">"{<!-- -->{false}}"</span> focus<span class="token operator">=</span><span class="token string">"{<!-- -->{false}}"</span> maxlength<span class="token operator">=</span><span class="token string">"300"</span> cursor<span class="token operator">-</span>spacing<span class="token operator">=</span><span class="token string">"10"</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>input<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>view class<span class="token operator">=</span><span class="token string">"action"</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>text class<span class="token operator">=</span><span class="token string">"cuIcon-emojifill text-grey"</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>text<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span><span class="token operator">/</span>view<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>button class<span class="token operator">=</span><span class="token string">"cu-btn bg-green shadow"</span> bindtap<span class="token operator">=</span><span class="token string">"sendMsg"</span><span class="token operator">&gt;</span>发送<span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>view<span class="token operator">&gt;</span>
</code></pre>
    <pre><code class="prism language-c"><span class="token punctuation">.</span>cu<span class="token operator">-</span>chat <span class="token punctuation">{<!-- --></span>
	display<span class="token operator">:</span> flex<span class="token punctuation">;</span>
	flex<span class="token operator">-</span>direction<span class="token operator">:</span> column<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token punctuation">.</span>cu<span class="token operator">-</span>chat <span class="token punctuation">.</span>cu<span class="token operator">-</span>item <span class="token punctuation">{<!-- --></span>
	display<span class="token operator">:</span> flex<span class="token punctuation">;</span>
	padding<span class="token operator">:</span> <span class="token number">30</span>rpx <span class="token number">30</span>rpx <span class="token number">70</span>rpx<span class="token punctuation">;</span>
	position<span class="token operator">:</span> relative<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token punctuation">.</span>cu<span class="token operator">-</span>chat <span class="token punctuation">.</span>cu<span class="token operator">-</span>item<span class="token operator">&gt;</span><span class="token punctuation">.</span>cu<span class="token operator">-</span>avatar <span class="token punctuation">{<!-- --></span>
	width<span class="token operator">:</span> <span class="token number">80</span>rpx<span class="token punctuation">;</span>
	height<span class="token operator">:</span> <span class="token number">80</span>rpx<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token punctuation">.</span>cu<span class="token operator">-</span>chat <span class="token punctuation">.</span>cu<span class="token operator">-</span>item<span class="token operator">&gt;</span><span class="token punctuation">.</span>main <span class="token punctuation">{<!-- --></span>
	max<span class="token operator">-</span>width<span class="token operator">:</span> <span class="token function">calc</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token operator">%</span> <span class="token operator">-</span> <span class="token number">260</span>rpx<span class="token punctuation">)</span><span class="token punctuation">;</span>
	margin<span class="token operator">:</span> <span class="token number">0</span> <span class="token number">40</span>rpx<span class="token punctuation">;</span>
	display<span class="token operator">:</span> flex<span class="token punctuation">;</span>
	align<span class="token operator">-</span>items<span class="token operator">:</span> center<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token punctuation">.</span>cu<span class="token operator">-</span>chat <span class="token punctuation">.</span>cu<span class="token operator">-</span>item<span class="token operator">&gt;</span>image <span class="token punctuation">{<!-- --></span>
	height<span class="token operator">:</span> <span class="token number">320</span>rpx<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token punctuation">.</span>cu<span class="token operator">-</span>chat <span class="token punctuation">.</span>cu<span class="token operator">-</span>item<span class="token operator">&gt;</span><span class="token punctuation">.</span>main <span class="token punctuation">.</span>content <span class="token punctuation">{<!-- --></span>
	padding<span class="token operator">:</span> <span class="token number">20</span>rpx<span class="token punctuation">;</span>
	border<span class="token operator">-</span>radius<span class="token operator">:</span> <span class="token number">6</span>rpx<span class="token punctuation">;</span>
	display<span class="token operator">:</span> <span class="token keyword">inline</span><span class="token operator">-</span>flex<span class="token punctuation">;</span>
	max<span class="token operator">-</span>width<span class="token operator">:</span> <span class="token number">100</span><span class="token operator">%</span><span class="token punctuation">;</span>
	align<span class="token operator">-</span>items<span class="token operator">:</span> center<span class="token punctuation">;</span>
	font<span class="token operator">-</span>size<span class="token operator">:</span> <span class="token number">30</span>rpx<span class="token punctuation">;</span>
	position<span class="token operator">:</span> relative<span class="token punctuation">;</span>
	min<span class="token operator">-</span>height<span class="token operator">:</span> <span class="token number">80</span>rpx<span class="token punctuation">;</span>
	line<span class="token operator">-</span>height<span class="token operator">:</span> <span class="token number">40</span>rpx<span class="token punctuation">;</span>
	text<span class="token operator">-</span>align<span class="token operator">:</span> left<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token punctuation">.</span>cu<span class="token operator">-</span>chat <span class="token punctuation">.</span>cu<span class="token operator">-</span>item<span class="token operator">&gt;</span><span class="token punctuation">.</span>main <span class="token punctuation">.</span>content<span class="token operator">:</span><span class="token function">not</span><span class="token punctuation">(</span><span class="token punctuation">[</span>class<span class="token operator">*=</span><span class="token string">"bg-"</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	background<span class="token operator">-</span>color<span class="token operator">:</span> <span class="token function">var</span><span class="token punctuation">(</span><span class="token operator">--</span>white<span class="token punctuation">)</span><span class="token punctuation">;</span>
	color<span class="token operator">:</span> <span class="token function">var</span><span class="token punctuation">(</span><span class="token operator">--</span>black<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token punctuation">.</span>cu<span class="token operator">-</span>chat <span class="token punctuation">.</span>cu<span class="token operator">-</span>item <span class="token punctuation">.</span>date <span class="token punctuation">{<!-- --></span>
	position<span class="token operator">:</span> absolute<span class="token punctuation">;</span>
	font<span class="token operator">-</span>size<span class="token operator">:</span> <span class="token number">24</span>rpx<span class="token punctuation">;</span>
	color<span class="token operator">:</span> <span class="token function">var</span><span class="token punctuation">(</span><span class="token operator">--</span>grey<span class="token punctuation">)</span><span class="token punctuation">;</span>
	width<span class="token operator">:</span> <span class="token function">calc</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token operator">%</span> <span class="token operator">-</span> <span class="token number">320</span>rpx<span class="token punctuation">)</span><span class="token punctuation">;</span>
	bottom<span class="token operator">:</span> <span class="token number">20</span>rpx<span class="token punctuation">;</span>
	left<span class="token operator">:</span> <span class="token number">160</span>rpx<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token punctuation">.</span>cu<span class="token operator">-</span>chat <span class="token punctuation">.</span>cu<span class="token operator">-</span>item <span class="token punctuation">.</span>action <span class="token punctuation">{<!-- --></span>
	padding<span class="token operator">:</span> <span class="token number">0</span> <span class="token number">30</span>rpx<span class="token punctuation">;</span>
	display<span class="token operator">:</span> flex<span class="token punctuation">;</span>
	align<span class="token operator">-</span>items<span class="token operator">:</span> center<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token punctuation">.</span>cu<span class="token operator">-</span>chat <span class="token punctuation">.</span>cu<span class="token operator">-</span>item<span class="token operator">&gt;</span><span class="token punctuation">.</span>main <span class="token punctuation">.</span>content<span class="token operator">::</span>after <span class="token punctuation">{<!-- --></span>
	content<span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">;</span>
	top<span class="token operator">:</span> <span class="token number">27</span>rpx<span class="token punctuation">;</span>
	transform<span class="token operator">:</span> <span class="token function">rotate</span><span class="token punctuation">(</span><span class="token number">45</span>deg<span class="token punctuation">)</span><span class="token punctuation">;</span>
	position<span class="token operator">:</span> absolute<span class="token punctuation">;</span>
	z<span class="token operator">-</span>index<span class="token operator">:</span> <span class="token number">100</span><span class="token punctuation">;</span>
	display<span class="token operator">:</span> <span class="token keyword">inline</span><span class="token operator">-</span>block<span class="token punctuation">;</span>
	overflow<span class="token operator">:</span> hidden<span class="token punctuation">;</span>
	width<span class="token operator">:</span> <span class="token number">24</span>rpx<span class="token punctuation">;</span>
	height<span class="token operator">:</span> <span class="token number">24</span>rpx<span class="token punctuation">;</span>
	left<span class="token operator">:</span> <span class="token operator">-</span><span class="token number">12</span>rpx<span class="token punctuation">;</span>
	right<span class="token operator">:</span> initial<span class="token punctuation">;</span>
	background<span class="token operator">-</span>color<span class="token operator">:</span> inherit<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token punctuation">.</span>cu<span class="token operator">-</span>chat <span class="token punctuation">.</span>cu<span class="token operator">-</span>item<span class="token punctuation">.</span>self<span class="token operator">&gt;</span><span class="token punctuation">.</span>main <span class="token punctuation">.</span>content<span class="token operator">::</span>after <span class="token punctuation">{<!-- --></span>
	left<span class="token operator">:</span> <span class="token keyword">auto</span><span class="token punctuation">;</span>
	right<span class="token operator">:</span> <span class="token operator">-</span><span class="token number">12</span>rpx<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     <font color="red">
      3.21、在JS中实现请求聊天列表及新增聊天信息的接口，使用websocket进行实时刷新聊天功能，提供onOpen、onClose、onError、onMessage方法。
     </font>
    </p>
    <pre><code class="prism language-c">var socket <span class="token operator">=</span> null<span class="token punctuation">;</span>
<span class="token function">Page</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
  data<span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    InputBottom<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
    chatData<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    content<span class="token operator">:</span> <span class="token char">''</span><span class="token punctuation">,</span> <span class="token comment">//需要发送的内容</span>
    userId<span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function">onLoad</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    let that <span class="token operator">=</span> this<span class="token punctuation">;</span>

    socket <span class="token operator">=</span> wx<span class="token punctuation">.</span><span class="token function">connectSocket</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
      url<span class="token operator">:</span> <span class="token char">'ws://localhost:8080/imserver/2'</span><span class="token punctuation">,</span>
      success<span class="token operator">:</span> res <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">{<!-- --></span>
          console<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token char">'创建连接成功'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token comment">//socketTaskId: 22</span>
          <span class="token comment">// console.info(res);</span>
      <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// console.info(socket);</span>
  <span class="token comment">//事件监听</span>
  socket<span class="token punctuation">.</span><span class="token function">onOpen</span><span class="token punctuation">(</span><span class="token function">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      console<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token char">'连接打开成功'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  socket<span class="token punctuation">.</span><span class="token function">onClose</span><span class="token punctuation">(</span><span class="token function">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      console<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token char">'连接关闭成功'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  socket<span class="token punctuation">.</span><span class="token function">onError</span><span class="token punctuation">(</span><span class="token function">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      console<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token char">'连接报错'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//服务器发送监听</span>
  socket<span class="token punctuation">.</span><span class="token function">onMessage</span><span class="token punctuation">(</span><span class="token function">function</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    console<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    var list<span class="token operator">=</span>JSON<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    that<span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>chatData<span class="token operator">:</span>list<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      wx<span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
        url<span class="token operator">:</span> 'http<span class="token operator">:</span><span class="token comment">//localhost:8080/getMessage?userId=2',</span>
        method<span class="token operator">:</span> <span class="token char">'get'</span><span class="token punctuation">,</span>
        dataType<span class="token operator">:</span> <span class="token string">"json"</span><span class="token punctuation">,</span>
        success<span class="token operator">:</span> <span class="token function">function</span> <span class="token punctuation">(</span>res<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          that<span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
            chatData<span class="token operator">:</span> res<span class="token punctuation">.</span>data
          <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      wx<span class="token punctuation">.</span><span class="token function">pageScrollTo</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
        scrollTop<span class="token operator">:</span> <span class="token number">9999</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function">InputFocus</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    this<span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
      InputBottom<span class="token operator">:</span> e<span class="token punctuation">.</span>detail<span class="token punctuation">.</span>height
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function">formMsg</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    this<span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
      content<span class="token operator">:</span> e<span class="token punctuation">.</span>detail<span class="token punctuation">.</span>value<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token comment">//发送消息</span>
  <span class="token function">sendMsg</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    let that <span class="token operator">=</span> this<span class="token punctuation">;</span>
    let info <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
      userName<span class="token operator">:</span> <span class="token char">'李四'</span><span class="token punctuation">,</span>
      content<span class="token operator">:</span> that<span class="token punctuation">.</span>data<span class="token punctuation">.</span>content<span class="token punctuation">,</span>
      userId<span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
      targetUserId<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
      targetUserName<span class="token operator">:</span> <span class="token string">"张三"</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    wx<span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
      url<span class="token operator">:</span> <span class="token char">'http://localhost:8080/push'</span><span class="token punctuation">,</span>
      data<span class="token operator">:</span> JSON<span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>info<span class="token punctuation">)</span><span class="token punctuation">,</span>
      method<span class="token operator">:</span> <span class="token char">'post'</span><span class="token punctuation">,</span>
      contentType<span class="token operator">:</span><span class="token string">"application/json"</span><span class="token punctuation">,</span>
      dataType<span class="token operator">:</span> <span class="token string">"json"</span><span class="token punctuation">,</span>
      success<span class="token operator">:</span> <span class="token function">function</span> <span class="token punctuation">(</span>identify<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        that<span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
          content<span class="token operator">:</span> <span class="token char">''</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//发送消息后</span>
     
        wx<span class="token punctuation">.</span><span class="token function">pageScrollTo</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
          scrollTop<span class="token operator">:</span> <span class="token number">9999</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>

      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>

  <span class="token function">InputBlur</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    this<span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
      InputBottom<span class="token operator">:</span> <span class="token number">0</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">//查询消息列表</span>
function <span class="token function">selectMsg</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  let that <span class="token operator">=</span> this<span class="token punctuation">;</span>

<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
    <p>
     <font color="red">
      3.22、准备两张头像，在WXML中根据对应的用户名判断聊天记录是否是自己发出，并赋对应的class样式，后续这个步骤可以直接在接口返回的数据中进行判断，请求查询列表的接口将用户token作为参数传输过去即可。
     </font>
    </p>
    <center>
     <img height="180/" src="https://i-blog.csdnimg.cn/blog_migrate/634442219bc30b871d44275841a6e666.png" width="180"/>
     <img height="180/" src="https://i-blog.csdnimg.cn/blog_migrate/be6c47d69fb6c692a793a558b2194d31.png" width="180"/>
    </center>
    <pre><code class="prism language-c">
<span class="token operator">&lt;</span>view class<span class="token operator">=</span><span class="token string">"cu-chat"</span> id<span class="token operator">=</span><span class="token string">"j_page"</span><span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>view class<span class="token operator">=</span><span class="token string">"cu-item {<!-- -->{item.userId=='2'?'self':''}}"</span> wx<span class="token operator">:</span><span class="token keyword">for</span><span class="token operator">=</span><span class="token string">"{<!-- -->{chatData}}"</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>view class<span class="token operator">=</span><span class="token string">"cu-avatar radius"</span> style<span class="token operator">=</span><span class="token string">"background-image:url(../../../images/cat.jpg)"</span> wx<span class="token operator">:</span><span class="token keyword">if</span><span class="token operator">=</span><span class="token string">"{<!-- -->{item.userId=='1'}}"</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>view<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>view class<span class="token operator">=</span><span class="token string">"main"</span><span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span>view class<span class="token operator">=</span><span class="token string">"content shadow {<!-- -->{item.userId=='1'?'bg-green':''}}"</span><span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>text<span class="token operator">&gt;</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span>item<span class="token punctuation">.</span>content<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>text<span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span><span class="token operator">/</span>view<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>view<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>view class<span class="token operator">=</span><span class="token string">"cu-avatar radius"</span> style<span class="token operator">=</span><span class="token string">"background-image:url(../../../images/dog.jpg)"</span> wx<span class="token operator">:</span><span class="token keyword">if</span><span class="token operator">=</span><span class="token string">"{<!-- -->{item.userId=='2'}}"</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>view<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>view class<span class="token operator">=</span><span class="token string">"date"</span><span class="token operator">&gt;</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span>item<span class="token punctuation">.</span>createTime<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>view<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span><span class="token operator">/</span>view<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>view<span class="token operator">&gt;</span> 
</code></pre>
    <p>
     <font color="red">
      3.23、请求聊天记录的接口和新增聊天信息的接口都跑通后，我们将现有小程序复制一份，在复制出的这份小程序中的JS将用户名改为张三、李四，然后发送消息。这里需要注意的是，我们需要在每次发送消息后将页面内容定位在底部，一直保持一个阅读最新消息的状态。
     </font>
    </p>
    <pre><code class="prism language-c">wx<span class="token punctuation">.</span><span class="token function">pageScrollTo</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
  scrollTop<span class="token operator">:</span> <span class="token number">9999</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre>
    <blockquote>
     <p>
      这里采用的一个比较简单的方式实现的聊天功能，用到了ws长连接的方式来实现这个功能，完成后源码会以资源的形式上传提供给大家。
     </p>
    </blockquote>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f626c:6f672e6373646e2e6e65742f776d6c5f4a6176614b696c6c2f:61727469636c652f64657461696c732f313237383037333331" class_="artid" style="display:none">
 </p>
</div>


