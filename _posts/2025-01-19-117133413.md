---
layout: post
title: "C实现TCP服务器端非阻塞方式同时和多个客户端通信"
date: 2025-01-19 14:39:37 +0800
description: "本文介绍了C++实现的非阻塞方式网络通信，通过服务器端不断循环调用accept()函数接收客户端请求"
keywords: "c++ 套接字服务端 可以连接多客户端"
categories: ['网络编程']
tags: ['网络通信', '网络', 'Tcpip', 'Socket', 'C']
artid: "117133413"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=117133413
    alt: "C实现TCP服务器端非阻塞方式同时和多个客户端通信"
render_with_liquid: false
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     C++实现TCP服务器端非阻塞方式同时和多个客户端通信
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <p>
    </p>
    <div class="toc">
     <h4>
      非阻塞方式网络通讯
     </h4>
     <ul>
      <li>
       <ul>
        <li>
         <a href="#_14" rel="nofollow">
          服务器端
         </a>
        </li>
        <li>
         <a href="#_159" rel="nofollow">
          客户端
         </a>
        </li>
        <li>
         <a href="#_243" rel="nofollow">
          运行实例
         </a>
        </li>
       </ul>
      </li>
     </ul>
    </div>
    <p>
    </p>
    <p>
     在之前的文章中，无论是点对点的还是一对多的服务器客户端通信均采用了阻塞模式：
     <br/>
     <a href="https://blog.csdn.net/qq_45929428/article/details/115606507">
      C++实现服务器端和客户端交互发送消息
     </a>
     <br/>
     <a href="https://blog.csdn.net/qq_45929428/article/details/116709789">
      C++实现TCP服务器端同时和多个客户端通信(多线程)
     </a>
    </p>
    <blockquote>
     <p>
      socket编程中，阻塞与非阻塞的区别有哪些？
      <br/>
      阻塞：一般的I/O操作可以在新建的流中运用.在服务器回应前它等待客户端发送一个空白的行.当会话结束时,服务器关闭流和客户端socket.如果在队列中没有请示,那么这个方法将会等待一个请求的到来.这个行为叫阻塞.accept()方法将会阻塞服务器线程直到一个呼叫到来.当5个连接处理完闭之后,服务器退出.任何的在队列中的呼叫将会被取消.
      <br/>
      非阻塞：非阻塞套接字是指执行此套接字的网络调用时，不管是否执行成功，都立即返回。例如调用recv()函数读取网络缓冲区中数据，不管是否读到数据都立即返回，而不会一直挂在此函数调用上。在实际Windows网络通信软件开发中，异步非阻塞套接字是用的最多的。平常所说的C/S（客户端/服务器）结构的软件就是异步非阻塞模式的。
     </p>
    </blockquote>
    <p>
     在编写服务器端程序时，非阻塞方式数据立即返回，所以我们需要不断循环调用
     <code>
      accpet()
     </code>
     函数接收客户端的请求。
     <br/>
     因为需要对连接的socket表进行大量的增删操作，所以使用c++容器list进行存储。
    </p>
    <h3>
     <a id="_14">
     </a>
     服务器端
    </h3>
    <pre><code class="prism language-cpp"><span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;iostream&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;WinSock2.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;WS2tcpip.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;vector&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;List&gt;</span></span>
<span class="token keyword">using</span> <span class="token keyword">namespace</span> std<span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">pragma</span> comment(lib,"ws2_32.lib")</span>
<span class="token macro property">#<span class="token directive keyword">define</span> PORT  65432</span>
<span class="token macro property">#<span class="token directive keyword">define</span> buff_len 500</span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token comment">//初始化winsock2.DLL</span>
	WSADATA wsaData<span class="token punctuation">;</span>
	WORD wVersionRequested <span class="token operator">=</span> <span class="token function">MAKEWORD</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">WSAStartup</span><span class="token punctuation">(</span>wVersionRequested<span class="token punctuation">,</span> <span class="token operator">&amp;</span>wsaData<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		cout <span class="token operator">&lt;&lt;</span> <span class="token string">"加载winsock.dll失败！"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token comment">//创建套接字</span>
	SOCKET  sock_server<span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>sock_server <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span> SOCK_STREAM<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> SOCKET_ERROR<span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		cout <span class="token operator">&lt;&lt;</span> <span class="token string">"创建套接字失败！错误代码："</span> <span class="token operator">&lt;&lt;</span> <span class="token function">WSAGetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
		<span class="token function">WSACleanup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token comment">//设置为非阻塞方式</span>
	u_long ul <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">ioctlsocket</span><span class="token punctuation">(</span>sock_server<span class="token punctuation">,</span> FIONBIO<span class="token punctuation">,</span> <span class="token operator">&amp;</span>ul<span class="token punctuation">)</span> <span class="token operator">==</span> SOCKET_ERROR<span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		cout <span class="token operator">&lt;&lt;</span> <span class="token string">"ioctlsocket failure, error:"</span> <span class="token operator">&lt;&lt;</span> <span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
		<span class="token function">WSACleanup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token comment">//绑定端口和Ip</span>
	sockaddr_in addr<span class="token punctuation">;</span>
	<span class="token keyword">int</span> addr_len <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> sockaddr_in<span class="token punctuation">)</span><span class="token punctuation">;</span>
	addr<span class="token punctuation">.</span>sin_family <span class="token operator">=</span> AF_INET<span class="token punctuation">;</span>
	addr<span class="token punctuation">.</span>sin_port <span class="token operator">=</span> <span class="token function">htons</span><span class="token punctuation">(</span>PORT<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">inet_pton</span><span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span> <span class="token string">"127.0.0.1"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>addr<span class="token punctuation">.</span>sin_addr<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//绑定本机的环回地址</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>SOCKET_ERROR <span class="token operator">==</span> <span class="token function">bind</span><span class="token punctuation">(</span>sock_server<span class="token punctuation">,</span> <span class="token punctuation">(</span>SOCKADDR<span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>addr<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>sockaddr_in<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		cout <span class="token operator">&lt;&lt;</span> <span class="token string">"地址绑定失败！错误代码："</span> <span class="token operator">&lt;&lt;</span> <span class="token function">WSAGetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
		<span class="token function">closesocket</span><span class="token punctuation">(</span>sock_server<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">WSACleanup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token comment">//将套接字设为监听状态</span>
	<span class="token keyword">int</span> size<span class="token operator">=</span><span class="token function">listen</span><span class="token punctuation">(</span>sock_server<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>size <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		cout <span class="token operator">&lt;&lt;</span> <span class="token string">"listen函数调用失败！\n"</span><span class="token punctuation">;</span>
		<span class="token function">closesocket</span><span class="token punctuation">(</span>sock_server<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">WSACleanup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	list<span class="token operator">&lt;</span>SOCKET<span class="token operator">&gt;</span> liSock<span class="token punctuation">;</span><span class="token comment">//将连接的套接字存储在list中</span>
	<span class="token keyword">char</span> msg<span class="token punctuation">[</span>buff_len<span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">//发送数据缓冲区</span>
	<span class="token keyword">char</span> msgbuffer<span class="token punctuation">[</span>buff_len<span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">//接收数据缓冲区</span>
	<span class="token keyword">int</span> n <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">//标记已经连接的套接字数量</span>
	<span class="token comment">//实现交互</span>
	<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		sockaddr_in  client_addr<span class="token punctuation">;</span>
		<span class="token keyword">auto</span> sc <span class="token operator">=</span> <span class="token function">accept</span><span class="token punctuation">(</span>sock_server<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> sockaddr<span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>client_addr<span class="token punctuation">,</span> <span class="token operator">&amp;</span>addr_len<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>sc <span class="token operator">==</span> INVALID_SOCKET<span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> WSAEWOULDBLOCK<span class="token punctuation">)</span>
			<span class="token punctuation">{<!-- --></span>
				cout <span class="token operator">&lt;&lt;</span> <span class="token string">"本次 accept函数没有客户端建立连接！"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
				<span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//设置令其间隔一段时间</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">else</span>
			<span class="token punctuation">{<!-- --></span>
				cout <span class="token operator">&lt;&lt;</span> <span class="token string">"accept函数调用失败！网络异常程序退出"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
				<span class="token function">closesocket</span><span class="token punctuation">(</span>sock_server<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token function">WSACleanup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">else</span>
		<span class="token punctuation">{<!-- --></span>
			cout <span class="token operator">&lt;&lt;</span> <span class="token string">"服务器成功和:"</span> <span class="token operator">&lt;&lt;</span> sc <span class="token operator">&lt;&lt;</span> <span class="token string">"建立连接！"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
			liSock<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>sc<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//将建立连接的套接字压入list</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">auto</span> it <span class="token operator">=</span> liSock<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">while</span> <span class="token punctuation">(</span>it <span class="token operator">!=</span> liSock<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			<span class="token keyword">auto</span> itTemp <span class="token operator">=</span> it<span class="token operator">++</span><span class="token punctuation">;</span>
			cout <span class="token operator">&lt;&lt;</span> <span class="token string">"请输入服务器端向"</span> <span class="token operator">&lt;&lt;</span> <span class="token operator">*</span>itTemp <span class="token operator">&lt;&lt;</span> <span class="token string">"发送数据"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
			cin<span class="token punctuation">.</span><span class="token function">getline</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">int</span> size <span class="token operator">=</span> <span class="token function">send</span><span class="token punctuation">(</span><span class="token operator">*</span>itTemp<span class="token punctuation">,</span> msg<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> <span class="token string">"end\0"</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
			<span class="token punctuation">{<!-- --></span>
				cout <span class="token operator">&lt;&lt;</span> <span class="token string">"关闭和"</span> <span class="token operator">&lt;&lt;</span> <span class="token operator">*</span>itTemp <span class="token operator">&lt;&lt;</span> <span class="token string">"的连接！"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
				liSock<span class="token punctuation">.</span><span class="token function">erase</span><span class="token punctuation">(</span>itTemp<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//移除已关闭连接的套接字</span>
				<span class="token function">system</span><span class="token punctuation">(</span><span class="token string">"pause"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>size <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span>
			<span class="token punctuation">{<!-- --></span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> WSAEWOULDBLOCK<span class="token punctuation">)</span>
				<span class="token punctuation">{<!-- --></span>
					cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Send data failure！\n"</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
				<span class="token keyword">else</span>
				<span class="token punctuation">{<!-- --></span>
					cout <span class="token operator">&lt;&lt;</span> <span class="token operator">*</span>itTemp <span class="token operator">&lt;&lt;</span> <span class="token string">" is closed"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
					liSock<span class="token punctuation">.</span><span class="token function">erase</span><span class="token punctuation">(</span>itTemp<span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token function">system</span><span class="token punctuation">(</span><span class="token string">"pause"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
		it <span class="token operator">=</span> liSock<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">while</span> <span class="token punctuation">(</span>it <span class="token operator">!=</span> liSock<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			<span class="token keyword">auto</span> itTemp <span class="token operator">=</span> it<span class="token operator">++</span><span class="token punctuation">;</span>
			size <span class="token operator">=</span> <span class="token function">recv</span><span class="token punctuation">(</span><span class="token operator">*</span>itTemp<span class="token punctuation">,</span> msgbuffer<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>msgbuffer<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>size <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span>
			<span class="token punctuation">{<!-- --></span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> WSAEWOULDBLOCK<span class="token punctuation">)</span>
				<span class="token punctuation">{<!-- --></span>
					cout <span class="token operator">&lt;&lt;</span> <span class="token string">"recv data failure！\n"</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
				<span class="token keyword">else</span>
				<span class="token punctuation">{<!-- --></span>
					cout <span class="token operator">&lt;&lt;</span> <span class="token operator">*</span>itTemp <span class="token operator">&lt;&lt;</span> <span class="token string">" is closed"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
					liSock<span class="token punctuation">.</span><span class="token function">erase</span><span class="token punctuation">(</span>itTemp<span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token function">system</span><span class="token punctuation">(</span><span class="token string">"pause"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">else</span>
			<span class="token punctuation">{<!-- --></span>
				cout <span class="token operator">&lt;&lt;</span> <span class="token operator">*</span>itTemp <span class="token operator">&lt;&lt;</span> <span class="token string">"	说：	"</span> <span class="token operator">&lt;&lt;</span> msgbuffer <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
				<span class="token function">system</span><span class="token punctuation">(</span><span class="token string">"pause"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <h3>
     <a id="_159">
     </a>
     客户端
    </h3>
    <pre><code class="prism language-cpp"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;winsock2.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;WS2tcpip.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>
<span class="token keyword">using</span>  <span class="token keyword">namespace</span> std<span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">pragma</span> comment(lib, "ws2_32.lib")</span>
<span class="token macro property">#<span class="token directive keyword">define</span> PORT 65432</span>
<span class="token keyword">int</span>  <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
<span class="token punctuation">{<!-- --></span>
	<span class="token comment">//初始化winsock2.DLL</span>
	WSADATA wsaData<span class="token punctuation">;</span>
	WORD wVersionRequested <span class="token operator">=</span> <span class="token function">MAKEWORD</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">WSAStartup</span><span class="token punctuation">(</span>wVersionRequested<span class="token punctuation">,</span> <span class="token operator">&amp;</span>wsaData<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		cout <span class="token operator">&lt;&lt;</span> <span class="token string">"加载winsock.dll失败！"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token comment">//创建套接字</span>
	SOCKET  sock_client<span class="token punctuation">;</span> 
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>sock_client <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span> SOCK_STREAM<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> SOCKET_ERROR<span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		cout <span class="token operator">&lt;&lt;</span> <span class="token string">"创建套接字失败！错误代码："</span> <span class="token operator">&lt;&lt;</span> <span class="token function">WSAGetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
		<span class="token function">WSACleanup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token comment">//连接服务器</span>
	sockaddr_in   addr<span class="token punctuation">;</span>
	addr<span class="token punctuation">.</span>sin_family <span class="token operator">=</span> AF_INET<span class="token punctuation">;</span>
	addr<span class="token punctuation">.</span>sin_port <span class="token operator">=</span> <span class="token function">htons</span><span class="token punctuation">(</span>PORT<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">inet_pton</span><span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span> <span class="token string">"127.0.0.1"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>addr<span class="token punctuation">.</span>sin_addr<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//绑定本机的环回地址</span>
	<span class="token keyword">int</span> len <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>sockaddr_in<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">connect</span><span class="token punctuation">(</span>sock_client<span class="token punctuation">,</span> <span class="token punctuation">(</span>SOCKADDR<span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>addr<span class="token punctuation">,</span> len<span class="token punctuation">)</span> <span class="token operator">==</span> SOCKET_ERROR<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		cout <span class="token operator">&lt;&lt;</span> <span class="token string">"连接失败！错误代码："</span> <span class="token operator">&lt;&lt;</span> <span class="token function">WSAGetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token comment">//实现交互部分，客户端先接收后发送数据</span>
	<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token comment">//接收服务端的消息</span>
		<span class="token keyword">char</span> msgbuffer<span class="token punctuation">[</span><span class="token number">1000</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
		<span class="token keyword">int</span> size <span class="token operator">=</span> <span class="token function">recv</span><span class="token punctuation">(</span>sock_client<span class="token punctuation">,</span> msgbuffer<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>msgbuffer<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span>msgbuffer<span class="token punctuation">,</span> <span class="token string">"end\0"</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			cout <span class="token operator">&lt;&lt;</span> <span class="token string">"服务器端已经关闭连接！"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
			<span class="token keyword">break</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>size <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			cout <span class="token operator">&lt;&lt;</span> <span class="token string">"接收信息失败！错误代码："</span> <span class="token operator">&lt;&lt;</span> <span class="token function">WSAGetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
			<span class="token keyword">break</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>size <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			cout <span class="token operator">&lt;&lt;</span> <span class="token string">"对方已经关闭连接"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
			<span class="token keyword">break</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">else</span> cout <span class="token operator">&lt;&lt;</span> <span class="token string">"The message from Server:"</span> <span class="token operator">&lt;&lt;</span> msgbuffer <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>

		<span class="token comment">//从键盘输入一行文字发送给服务器</span>
		msgbuffer<span class="token punctuation">[</span><span class="token number">999</span><span class="token punctuation">]</span> <span class="token operator">=</span>  <span class="token number">0</span> <span class="token punctuation">;</span>
		cout <span class="token operator">&lt;&lt;</span> <span class="token string">"从键盘输入发给服务器的信息："</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
		cin<span class="token punctuation">.</span><span class="token function">getline</span><span class="token punctuation">(</span>msgbuffer<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>msgbuffer<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span>msgbuffer<span class="token punctuation">,</span> <span class="token string">"end\0"</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			cout <span class="token operator">&lt;&lt;</span> <span class="token string">"关闭连接！"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
			<span class="token keyword">break</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">send</span><span class="token punctuation">(</span>sock_client<span class="token punctuation">,</span> msgbuffer<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>msgbuffer<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">==</span> SOCKET_ERROR <span class="token operator">||</span> ret <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			cout <span class="token operator">&lt;&lt;</span> <span class="token string">"发送信息失败！错误代码："</span> <span class="token operator">&lt;&lt;</span> <span class="token function">WSAGetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
			<span class="token keyword">break</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">else</span> cout <span class="token operator">&lt;&lt;</span> <span class="token string">"信息发送成功！"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token function">closesocket</span><span class="token punctuation">(</span>sock_client<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">WSACleanup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <blockquote>
     <p>
      我们用建立连接时服务器端接收的客户端套接字来唯一标识该客户端。
      <br/>
      服务器端可以
      <mark>
       随时接收
      </mark>
      客户端的连接并与其进行交互。
     </p>
    </blockquote>
    <h3>
     <a id="_243">
     </a>
     运行实例
    </h3>
    <p>
     通讯建立后首先由服务器端发送消息，客户端接收消息；接着客户端发送消息，服务器端接收消息，实现交互发送消息。
     <br/>
     服务器同时可以和
     <mark>
      多个客户端
     </mark>
     建立连接，进行交互；
     <br/>
     在某次交互中，服务器端或某客户端有一方发送"end"即终止服务器与其的通信；服务器还可以继续接收其他客户端的请求，与其他客户端通信。
    </p>
    <p>
     实例展示了非阻塞模式下服务器与客户端通信的运行情况：
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/efa4103ee035adea2b7845ff556647a6.png">
      <br/>
      <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/0f2d01cbe40edf3091d86af5625923b9.png">
       <br/>
       为了便于展示，在程序中调用了
       <code>
        Sleep(100)
       </code>
       以及
       <code>
        system("pause")
       </code>
       等函数，可以看到在服务器与客户端连接后还不断调用accpet函数接收连接请求，在服务器发送数据后，暂时未收到客户端发送的数据，服务器recv函数立即返回，输出
       <code>
        recv data failure
       </code>
       。
      </img>
     </img>
    </p>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f62:6c6f672e6373646e2e6e65742f71715f34353932393432382f:61727469636c652f64657461696c732f313137313333343133" class_="artid" style="display:none">
 </p>
</div>


