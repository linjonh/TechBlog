---
layout: post
title: "微信原生组件基于小程序实现音视频通话"
date: 2022-09-21 15:31:41 +0800
description: "本文将介绍如何使用微信小程序原生推拉流组件  和  进行推拉流，由"
keywords: "uniapp zego开发微信小程序音视频"
categories: ['音视频开发']
tags: ['音视频通话', '微信小程序', '小程序音视频']
artid: "126973114"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=126973114
    alt: "微信原生组件基于小程序实现音视频通话"
render_with_liquid: false
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     微信原生组件｜基于小程序实现音视频通话
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-light" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <h3>
     <a id="1__0">
     </a>
     1 微信小程序原生推拉流组件功能简介
    </h3>
    <p>
     本文将介绍如何使用微信小程序原生推拉流组件 &lt;live-pusher&gt; 和 &lt;live-player&gt; 进行推拉流，快速实现一个简单的实时音视频通话。
    </p>
    <p>
     由于微信小程序原生推拉流组件使用起来比较复杂，推荐开发者使用即构封装的音视频SDK &lt;zego-push&gt; 和 &lt;zego-player&gt; 组件实现视频通话，可参考
     <a href="https://doc-zh.zego.im/article/8939?source=csdn&amp;article47" rel="nofollow">
      实现视频通话
     </a>
     。
    </p>
    <h3>
     <a id="2__9">
     </a>
     2 实现微信小程序音视频通话的前提条件
    </h3>
    <p>
     在实现基本的实时音视频功能之前，请确保：
    </p>
    <ul>
     <li>
      已在项目中集成 ZEGO Express SDK 即构音视频SDK，详情请参考
      <a href="https://doc-zh.zego.im/article/198?source=csdn&amp;article47" rel="nofollow">
       快速开始 - 集成
      </a>
      。
     </li>
     <li>
      已在
      <a href="https://console.zego.im/?source=csdn&amp;article47" rel="nofollow">
       ZEGO 控制台
      </a>
      创建项目，申请有效的 AppID 和 ServerSecret，详情请参考
      <a href="https://doc-zh.zego.im/article/12107?source=csdn&amp;article47" rel="nofollow">
       控制台 - 项目管理
      </a>
      中的“项目信息”。
     </li>
    </ul>
    <h3>
     <a id="3_SDK_16">
     </a>
     3 即构音视频SDK实现流程
    </h3>
    <p>
     用户通过 ZEGO Express SDK 即构音视频SDK进行视频通话的基本流程为：
    </p>
    <p>
     用户 A、B 加入房间，用户 B 预览并将音视频流推送到 ZEGO 云服务（推流），用户 A 收到用户 B 推送音视频流的通知之后，在通知中播放用户 B 的音视频流（拉流）。
    </p>
    <p>
     <img alt="下载.png" src="https://i-blog.csdnimg.cn/blog_migrate/212729b882368f620625c248f4529664.png"/>
    </p>
    <h4>
     <a id="31__25">
     </a>
     3.1 配置微信小程序后台
    </h4>
    <p>
     在初始化 音视频SDK 前，需要在
     <a href="https://mp.weixin.qq.com/?token=&amp;lang=zh_CN?source=csdn&amp;article47" rel="nofollow">
      微信公众平台
     </a>
     中进行如下配置：
    </p>
    <ul>
     <li>
      <p>
       <a href="https://developers.weixin.qq.com/miniprogram/dev/framework/ability/network.html?source=csdn&amp;article47" rel="nofollow">
        服务器域名配置
       </a>
       ：在“小程序后台 &gt; 开发管理 &gt; 开发设置 &gt; 服务器域名”中，按照协议分类，将即构 Server 地址、LogUrl、以及用户业务需要用到的地址填到指定的“request合法域名”或“socket合法域名”中。
       <br/>
       <img alt="下载1.png" src="https://i-blog.csdnimg.cn/blog_migrate/cc5ab1b7a339d5654ec088c147c0227a.png"/>
      </p>
     </li>
     <li>
      <p>
       相关功能开启：在“小程序后台 &gt; 开发管理 &gt; 接口设置 &gt; 接口权限”中，打开
       <strong>
        实时播放音视频流
       </strong>
       和
       <strong>
        实时录制音视频流
       </strong>
       功能开关。
       <br/>
       <img alt="下载2.png" src="https://i-blog.csdnimg.cn/blog_migrate/e1d4bfbc29ff551d8cb098a8bd58efcb.png"/>
      </p>
     </li>
    </ul>
    <h4>
     <a id="32_SDK_40">
     </a>
     3.2 即构音视频SDK初始化
    </h4>
    <p>
     <em>
      <strong>
       1. 创建音视频通话界面
      </strong>
     </em>
    </p>
    <p>
     根据音视频场景需要，为您的项目创建音视频通话的用户界面。我们推荐您在项目中添加如下元素：
    </p>
    <ul>
     <li>
      本地预览窗口
     </li>
     <li>
      远端视频窗口
     </li>
     <li>
      结束按钮
      <br/>
      <img alt="下载3.png" src="https://i-blog.csdnimg.cn/blog_migrate/1da94def273e47df814645ab9e29fffb.png"/>
     </li>
    </ul>
    <p>
     小程序推流组件 &lt;live-pusher&gt; 中的 “video-width” 和 “video-height” 存在兼容性问题，可能会出现设置不生效的情况。
    </p>
    <p>
     <strong>
      参考界面代码：
     </strong>
    </p>
    <pre><code class="prism language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>view</span> <span class="token attr-name"><span class="token namespace">wx:</span>if</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>{<!-- -->{canShow== 1}}<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>view</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>containerBase<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>live-pusher</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>testpusher<span class="token punctuation">"</span></span> 
    <span class="token attr-name"><span class="token namespace">wx:</span>if</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>{<!-- -->{pusher.url}}<span class="token punctuation">"</span></span> 
    <span class="token attr-name">url</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>{<!-- -->{pusher.url}}<span class="token punctuation">"</span></span>  
    <span class="token attr-name">mode</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>{<!-- -->{pusher.mode}}<span class="token punctuation">"</span></span>
    <span class="token attr-name">autopush</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>{<!-- -->{pusher.autopush}}<span class="token punctuation">"</span></span>
    <span class="token attr-name">enable-camera</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>{<!-- -->{pusher.enableCamera}}<span class="token punctuation">"</span></span>
    <span class="token attr-name">enable-mic</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>{<!-- -->{pusher.enableMic}}<span class="token punctuation">"</span></span>
    <span class="token attr-name">muted</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>{<!-- -->{!pusher.enableMic}}<span class="token punctuation">"</span></span>
    <span class="token attr-name">enable-agc</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>{<!-- -->{pusher.enableAgc}}<span class="token punctuation">"</span></span>
    <span class="token attr-name">enable-ans</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>{<!-- -->{pusher.enableAns}}<span class="token punctuation">"</span></span>
    <span class="token attr-name">zoom</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>{<!-- -->{pusher.enableZoom}}<span class="token punctuation">"</span></span>
    <span class="token attr-name">min-bitrate</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>{<!-- -->{pusher.minBitrate}}<span class="token punctuation">"</span></span>
    <span class="token attr-name">max-bitrate</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>{<!-- -->{pusher.maxBitrate}}<span class="token punctuation">"</span></span>
    <span class="token attr-name">video-width</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>{<!-- -->{pusher.videoWidth}}<span class="token punctuation">"</span></span>
    <span class="token attr-name">video-height</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>{<!-- -->{pusher.videoHeight}}<span class="token punctuation">"</span></span>
    <span class="token attr-name">beauty</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>{<!-- -->{pusher.beautyLevel}}<span class="token punctuation">"</span></span>
    <span class="token attr-name">whiteness</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>{<!-- -->{pusher.whitenessLevel}}<span class="token punctuation">"</span></span>
    <span class="token attr-name">orientation</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>{<!-- -->{pusher.videoOrientation}}<span class="token punctuation">"</span></span>
    <span class="token attr-name">device-position</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>{<!-- -->{pusher.frontCamera}}<span class="token punctuation">"</span></span>
    <span class="token attr-name">remote-mirror</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>{<!-- -->{pusher.enableRemoteMirror}}<span class="token punctuation">"</span></span>
    <span class="token attr-name">local-mirror</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>{<!-- -->{pusher.localMirror}}<span class="token punctuation">"</span></span>
    <span class="token attr-name">background-mute</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>{<!-- -->{pusher.enableBackgroundMute}}<span class="token punctuation">"</span></span>
    <span class="token attr-name">audio-quality</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>{<!-- -->{pusher.audioQuality}}<span class="token punctuation">"</span></span>
    <span class="token attr-name">audio-volume-type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>{<!-- -->{pusher.audioVolumeType}}<span class="token punctuation">"</span></span>
    <span class="token attr-name">audio-reverb-type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>{<!-- -->{pusher.audioReverbType}}<span class="token punctuation">"</span></span>
    <span class="token attr-name">waiting-image</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>{<!-- -->{pusher.waitingImage}}<span class="token punctuation">"</span></span>
    <span class="token attr-name">beauty-style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>{<!-- -->{pusher.beautyStyle}}<span class="token punctuation">"</span></span>
    <span class="token attr-name">filter</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>{<!-- -->{pusher.filter}}<span class="token punctuation">"</span></span>
    <span class="token attr-name">bindstatechange</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>onPushStateChange<span class="token punctuation">"</span></span> 
    <span class="token attr-name">bindaudiovolumenotify</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>bindaudiovolumenotify<span class="token punctuation">"</span></span>  
    <span class="token attr-name">bindnetstatus</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>onPushNetStateChange<span class="token punctuation">"</span></span>
    <span class="token attr-name">waiting-image</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>https://storage.zego.im/downloads/pause_publish.png<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>live-pusher</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>live-player</span>  <span class="token attr-name"><span class="token namespace">wx:</span>for</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>{<!-- -->{playerList}}<span class="token punctuation">"</span></span> <span class="token attr-name"><span class="token namespace">wx:</span>key</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>streamID<span class="token punctuation">"</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>{<!-- -->{item.id}}<span class="token punctuation">"</span></span> 
      <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span> <span class="token punctuation">"</span>{<!-- -->{item.url}}<span class="token punctuation">"</span></span>
      <span class="token attr-name">mode</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span> <span class="token punctuation">"</span>RTC<span class="token punctuation">"</span></span>
      <span class="token attr-name">autoplay</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span> <span class="token punctuation">"</span>{<!-- -->{item.autoplay}}<span class="token punctuation">"</span></span>
      <span class="token attr-name">mute-audio</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span> <span class="token punctuation">"</span>{<!-- -->{item.muteAudio}}<span class="token punctuation">"</span></span>
      <span class="token attr-name">mute-video</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span> <span class="token punctuation">"</span>{<!-- -->{item.muteVideo}}<span class="token punctuation">"</span></span>
      <span class="token attr-name">orientation</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span> <span class="token punctuation">"</span>{<!-- -->{item.orientation}}<span class="token punctuation">"</span></span>
      <span class="token attr-name">object-fit</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span> <span class="token punctuation">"</span>{<!-- -->{item.objectFit}}<span class="token punctuation">"</span></span>
      <span class="token attr-name">min-cache</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span> <span class="token punctuation">"</span>{<!-- -->{item.minCache}}<span class="token punctuation">"</span></span>
      <span class="token attr-name">max-cache</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span> <span class="token punctuation">"</span>{<!-- -->{item.maxCache}}<span class="token punctuation">"</span></span>
      <span class="token attr-name">sound-mode</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span> <span class="token punctuation">"</span>{<!-- -->{item.soundMode}}<span class="token punctuation">"</span></span>
      <span class="token attr-name">enable-recv-message</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span> <span class="token punctuation">"</span>{<!-- -->{item.enableRecvMessage}}<span class="token punctuation">"</span></span>
      <span class="token attr-name">auto-pause-if-navigate</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span> <span class="token punctuation">"</span>{<!-- -->{item.autoPauseIfNavigate}}<span class="token punctuation">"</span></span>
      <span class="token attr-name">auto-pause-if-open-native</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span> <span class="token punctuation">"</span>{<!-- -->{item.autoPauseIfOpenNative}}<span class="token punctuation">"</span></span> <span class="token attr-name">enable-metadata</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span> <span class="token attr-name">bindmetadatachange</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>binddatachange<span class="token punctuation">"</span></span>  <span class="token attr-name">bindstatechange</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>onPlayStateChange<span class="token punctuation">"</span></span> <span class="token attr-name">bindnetstatus</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>onPlayNetStateChange<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>live-player</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>view</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>view</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>index-container<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>view</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>input-container<span class="token punctuation">'</span></span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>{<!-- -->{roomID}}<span class="token punctuation">"</span></span> <span class="token attr-name">bindinput</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>bindKeyInput<span class="token punctuation">"</span></span> <span class="token attr-name">placeholder</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>请输入房间 ID<span class="token punctuation">"</span></span> <span class="token attr-name">placeholder-style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>color: #b3b3b3; font-size: 14px;<span class="token punctuation">'</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>room-input<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>text</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>tip<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>text</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>view</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>view</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>button-container<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">bindtap</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>openRoom<span class="token punctuation">"</span></span> <span class="token attr-name">data-role</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>1<span class="token punctuation">"</span></span> <span class="token attr-name">data-option</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>videoAndAudio<span class="token punctuation">"</span></span> <span class="token attr-name">hover-class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>none<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>openRoom<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
        加入房间(推流)
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
     
      
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">bindtap</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>logout<span class="token punctuation">"</span></span> <span class="token attr-name">hover-class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>none<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>退出房间<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>view</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>view</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>view</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>view</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>settings<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name"><span class="token namespace">wx:</span>if</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>{<!-- -->{canShow==0}}<span class="token punctuation">"</span></span> <span class="token attr-name">open-type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>openSetting<span class="token punctuation">"</span></span> <span class="token attr-name">bindopensetting</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>settingCallback<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    授权使用摄像头和麦克风
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>view</span><span class="token punctuation">&gt;</span></span>
</code></pre>
    <p>
     <em>
      <strong>
       2. 创建音视频SDK引擎
      </strong>
     </em>
    </p>
    <p>
     创建
     <code>
      ZegoExpressEngine
     </code>
     引擎实例，将申请到的 AppID 传入参数 “appID”，将获取到的 Server 地址传入参数 “server”。
    </p>
    <pre><code class="prism language-javascript"><span class="token comment">// 初始化实例</span>
zg <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ZegoExpressEngine</span><span class="token punctuation">(</span>appID<span class="token punctuation">,</span> server<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <p>
     如果需要注册回调，开发者可根据实际需要，实现 ZegoEvent 中的某些方法，创建引擎后可通过调用
     <code>
      on
     </code>
     接口设置回调。
    </p>
    <pre><code class="prism language-javascript">zg<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'roomStateUpdate'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">roomID<span class="token punctuation">,</span> state<span class="token punctuation">,</span> errorCode<span class="token punctuation">,</span> extendedData</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>state <span class="token operator">==</span> <span class="token string">'DISCONNECTED'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 与房间断开了连接</span>
	<span class="token comment">// ...</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>state <span class="token operator">==</span> <span class="token string">'CONNECTING'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 与房间尝试连接中</span>
	<span class="token comment">// ...</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>state <span class="token operator">==</span> <span class="token string">'CONNECTED'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 与房间连接成功</span>
	<span class="token comment">// ...</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre>
    <h4>
     <a id="33__164">
     </a>
     3.3 登录音视频房间
    </h4>
    <p>
     <strong>
      1. 获取房间登录 Token
     </strong>
    </p>
    <p>
     登录房间需要用于验证身份的 Token，获取方式请参考
     <a href="https://doc-zh.zego.im/article/8940?source=csdn&amp;article47" rel="nofollow">
      用户权限控制
     </a>
     。如需快速调试，建议使用控制台生成的临时 Token，生成临时 Token 的具体操作请参考
     <a href="https://doc-zh.zego.im/article/12107?source=csdn&amp;article47" rel="nofollow">
      控制台 - 项目管理
     </a>
     。
    </p>
    <p>
     <strong>
      2. 登录音视频房间
     </strong>
    </p>
    <p>
     您可以调用 SDK 的
     <code>
      loginRoom
     </code>
     接口，传入房间 ID 参数 “roomID”、“token” 和用户参数 “user”，登录房间。您可通过监听
     <code>
      roomStateUpdate
     </code>
     回调实时监控自己在本房间内的连接状态，具体请参考
     <a href="https://doc-zh.zego.im/article/8939#4_1?source=csdn&amp;article47" rel="nofollow">
      4.1 常见通知回调
     </a>
     中的“4.1.1 我在房间内的连接状态变化通知”。
    </p>
    <p>
     roomID 和 user 的参数由您本地生成，但是需要满足以下条件：
    </p>
    <ul>
     <li>
      同一个 AppID 内，需保证 “roomID” 全局唯一。
     </li>
     <li>
      同一个 AppID 内，需保证 “userID” 全局唯一，建议开发者将 “userID” 与自己业务的账号系统进行关联。
     </li>
    </ul>
    <p>
     为避免错过任何通知，您需要在登录房间前先设置所有的监听回调（如房间状态、用户状态、流状态、推拉流状态等），具体请参考
     <a href="https://doc-zh.zego.im/article/8939#4_1?source=csdn&amp;article47" rel="nofollow">
      4.1 常见通知回调
     </a>
     。
    </p>
    <pre><code class="prism language-javascript"><span class="token comment">// 登录房间，成功则返回 true</span>
<span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> zg<span class="token punctuation">.</span><span class="token function">loginRoom</span><span class="token punctuation">(</span>roomID<span class="token punctuation">,</span> token<span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span>userID<span class="token punctuation">,</span> userName<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <h4>
     <a id="34__ZEGO__192">
     </a>
     3.4 将自己的音视频流推送到 ZEGO 即构音视频云
    </h4>
    <h5>
     <a id="341__194">
     </a>
     3.4.1 初始化小程序组件实例
    </h5>
    <p>
     调用
     <code>
      initContext
     </code>
     接口初始化小程序组件。
    </p>
    <p>
     小程序组件中用于存储推流属性 pusher 和拉流属性列表 playerList 两个字段需要传给 SDK，SDK 后续将通过传入的两个字段对相应的推拉流作状态及视图更新处理。
    </p>
    <ul>
     <li>
      pusher 字段中的属性值请参考
      <a href="/article/api?doc=Express_Video_SDK_API~javascript_wxxcx~interface~ZegoWxPusherAttributes?source=csdn&amp;article47" rel="nofollow">
       ZegoWxPusherAttributes
      </a>
      。
     </li>
     <li>
      playerlist 字段中的属性值请参考
      <a href="/article/api?doc=Express_Video_SDK_API~javascript_wxxcx~interface~ZegoWxPlayerAttributes?source=csdn&amp;article47" rel="nofollow">
       ZegoWxPlayerAttributes
      </a>
      。
     </li>
    </ul>
    <pre><code class="prism language-javascript">zg<span class="token punctuation">.</span><span class="token function">initContext</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
     <span class="token literal-property property">wxContext</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">,</span>
     <span class="token literal-property property">pushAtr</span><span class="token operator">:</span> <span class="token string">"pusher"</span><span class="token punctuation">,</span> <span class="token comment">// 对象名，对象属性与 live-pusher 中的属性为映射关系</span>
     <span class="token literal-property property">playAtr</span><span class="token operator">:</span> <span class="token string">"playerList"</span> <span class="token comment">// 对象名，对象属性与 live-player 中的属性为映射关系</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre>
    <p>
     即构音视频SDK 在内部会对推拉流实例进行操作以及视图更新，开发者无需保存推拉流实例和调用小程序 setData 接口更新视图，避免与 SDK 发生冲突。后续可通过
     <code>
      getPusherInstance
     </code>
     和
     <code>
      getPlayerInstance
     </code>
     接口获取推拉流实例。
    </p>
    <h5>
     <a id="342__WXML_217">
     </a>
     3.4.2 创建对应业务场景的 WXML
    </h5>
    <p>
     根据您的业务场景需求，编写 WXML 文件，创建推拉流组件 &lt;live-pusher&gt; 和 &lt;live-player&gt;。
    </p>
    <ul>
     <li>
      <a href="https://developers.weixin.qq.com/miniprogram/dev/component/live-pusher.html?source=csdn&amp;article47" rel="nofollow">
       &lt;live-pusher&gt;
      </a>
      组件用于小程序的实时推送音视频流功能。
     </li>
     <li>
      <a href="https://developers.weixin.qq.com/miniprogram/dev/component/live-player.html?source=csdn&amp;article47" rel="nofollow">
       &lt;live-player&gt;
      </a>
      组件用户小程序的实时播放音视频流功能。
     </li>
    </ul>
    <p>
     WXML 的具体含义与用法请参考微信官网文档中的介绍
     <a href="https://developers.weixin.qq.com/miniprogram/dev/framework/view/wxml/?source=csdn&amp;article47" rel="nofollow">
      WXML
     </a>
     。
    </p>
    <p>
     WXML 中的 pusher 与 playerList，必须与初始化小程序组件
     <code>
      initContext
     </code>
     中定义的这两个字段属性名保持一致，后续 SDK 调用推拉流接口之后才能正确地进行状态及视图更新。
    </p>
    <p>
     bindstatechange 表示播放状态变化事件；bindaudiovolumenotify 表示播放音量大小通知；bindnetstatus 表示网络状态通知。
    </p>
    <pre><code class="prism language-javascript"><span class="token operator">&lt;</span>live<span class="token operator">-</span>pusher <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"testpusher"</span> 
    <span class="token literal-property property">wx</span><span class="token operator">:</span><span class="token keyword">if</span><span class="token operator">=</span><span class="token string">"{<!-- -->{pusher.url}}"</span> 
    url<span class="token operator">=</span><span class="token string">"{<!-- -->{pusher.url}}"</span>  
    mode<span class="token operator">=</span><span class="token string">"{<!-- -->{pusher.mode}}"</span>
    autopush<span class="token operator">=</span><span class="token string">"{<!-- -->{pusher.autopush}}"</span>
    enable<span class="token operator">-</span>camera<span class="token operator">=</span><span class="token string">"{<!-- -->{pusher.enableCamera}}"</span>
    enable<span class="token operator">-</span>mic<span class="token operator">=</span><span class="token string">"{<!-- -->{pusher.enableMic}}"</span>
    muted<span class="token operator">=</span><span class="token string">"{<!-- -->{!pusher.enableMic}}"</span>
    enable<span class="token operator">-</span>agc<span class="token operator">=</span><span class="token string">"{<!-- -->{pusher.enableAgc}}"</span>
    enable<span class="token operator">-</span>ans<span class="token operator">=</span><span class="token string">"{<!-- -->{pusher.enableAns}}"</span>
    enable<span class="token operator">-</span>ear<span class="token operator">-</span>monitor<span class="token operator">=</span><span class="token string">"{<!-- -->{pusher.enableEarMonitor}}"</span>
    auto<span class="token operator">-</span>focus<span class="token operator">=</span><span class="token string">"{<!-- -->{pusher.enableAutoFocus}}"</span>
    zoom<span class="token operator">=</span><span class="token string">"{<!-- -->{pusher.enableZoom}}"</span>
    min<span class="token operator">-</span>bitrate<span class="token operator">=</span><span class="token string">"{<!-- -->{pusher.minBitrate}}"</span>
    max<span class="token operator">-</span>bitrate<span class="token operator">=</span><span class="token string">"{<!-- -->{pusher.maxBitrate}}"</span>
    video<span class="token operator">-</span>width<span class="token operator">=</span><span class="token string">"{<!-- -->{pusher.videoWidth}}"</span>
    video<span class="token operator">-</span>height<span class="token operator">=</span><span class="token string">"{<!-- -->{pusher.videoHeight}}"</span>
    beauty<span class="token operator">=</span><span class="token string">"{<!-- -->{pusher.beautyLevel}}"</span>
    whiteness<span class="token operator">=</span><span class="token string">"{<!-- -->{pusher.whitenessLevel}}"</span>
    orientation<span class="token operator">=</span><span class="token string">"{<!-- -->{pusher.videoOrientation}}"</span>
    aspect<span class="token operator">=</span><span class="token string">"{<!-- -->{pusher.videoAspect}}"</span>
    device<span class="token operator">-</span>position<span class="token operator">=</span><span class="token string">"{<!-- -->{pusher.frontCamera}}"</span>
    remote<span class="token operator">-</span>mirror<span class="token operator">=</span><span class="token string">"{<!-- -->{pusher.enableRemoteMirror}}"</span>
    local<span class="token operator">-</span>mirror<span class="token operator">=</span><span class="token string">"{<!-- -->{pusher.localMirror}}"</span>
    background<span class="token operator">-</span>mute<span class="token operator">=</span><span class="token string">"{<!-- -->{pusher.enableBackgroundMute}}"</span>
    audio<span class="token operator">-</span>quality<span class="token operator">=</span><span class="token string">"{<!-- -->{pusher.audioQuality}}"</span>
    audio<span class="token operator">-</span>volume<span class="token operator">-</span>type<span class="token operator">=</span><span class="token string">"{<!-- -->{pusher.audioVolumeType}}"</span>
    audio<span class="token operator">-</span>reverb<span class="token operator">-</span>type<span class="token operator">=</span><span class="token string">"{<!-- -->{pusher.audioReverbType}}"</span>
    waiting<span class="token operator">-</span>image<span class="token operator">=</span><span class="token string">"{<!-- -->{pusher.waitingImage}}"</span>
    beauty<span class="token operator">-</span>style<span class="token operator">=</span><span class="token string">"{<!-- -->{pusher.beautyStyle}}"</span>
    filter<span class="token operator">=</span><span class="token string">"{<!-- -->{pusher.filter}}"</span>
    bindstatechange<span class="token operator">=</span><span class="token string">"onPushStateChange"</span> 
    bindaudiovolumenotify<span class="token operator">=</span><span class="token string">"bindaudiovolumenotify"</span>  
    bindnetstatus<span class="token operator">=</span><span class="token string">"onPushNetStateChange"</span>
    waiting<span class="token operator">-</span>image<span class="token operator">=</span><span class="token string">"https://storage.zego.im/downloads/pause_publish.png"</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>live<span class="token operator">-</span>pusher<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>live<span class="token operator">-</span>player  wx<span class="token operator">:</span><span class="token keyword">for</span><span class="token operator">=</span><span class="token string">"{<!-- -->{playerList}}"</span> <span class="token literal-property property">wx</span><span class="token operator">:</span>key<span class="token operator">=</span><span class="token string">"streamID"</span> id<span class="token operator">=</span><span class="token string">"{<!-- -->{item.id}}"</span> 
      src<span class="token operator">=</span> <span class="token string">"{<!-- -->{item.url}}"</span>
      mode<span class="token operator">=</span> <span class="token string">"RTC"</span>
      autoplay<span class="token operator">=</span> <span class="token string">"{<!-- -->{item.autoplay}}"</span>
      mute<span class="token operator">-</span>audio<span class="token operator">=</span> <span class="token string">"{<!-- -->{item.muteAudio}}"</span>
      mute<span class="token operator">-</span>video<span class="token operator">=</span> <span class="token string">"{<!-- -->{item.muteVideo}}"</span>
      orientation<span class="token operator">=</span> <span class="token string">"{<!-- -->{item.orientation}}"</span>
      object<span class="token operator">-</span>fit<span class="token operator">=</span> <span class="token string">"{<!-- -->{item.objectFit}}"</span>
      min<span class="token operator">-</span>cache<span class="token operator">=</span> <span class="token string">"{<!-- -->{item.minCache}}"</span>
      max<span class="token operator">-</span>cache<span class="token operator">=</span> <span class="token string">"{<!-- -->{item.maxCache}}"</span>
      sound<span class="token operator">-</span>mode<span class="token operator">=</span> <span class="token string">"{<!-- -->{item.soundMode}}"</span>
      enable<span class="token operator">-</span>recv<span class="token operator">-</span>message<span class="token operator">=</span> <span class="token string">"{<!-- -->{item.enableRecvMessage}}"</span>
      auto<span class="token operator">-</span>pause<span class="token operator">-</span><span class="token keyword">if</span><span class="token operator">-</span>navigate<span class="token operator">=</span> <span class="token string">"{<!-- -->{item.autoPauseIfNavigate}}"</span>
      auto<span class="token operator">-</span>pause<span class="token operator">-</span><span class="token keyword">if</span><span class="token operator">-</span>open<span class="token operator">-</span>native<span class="token operator">=</span> <span class="token string">"{<!-- -->{item.autoPauseIfOpenNative}}"</span> enable<span class="token operator">-</span>metadata<span class="token operator">=</span><span class="token string">"true"</span> bindmetadatachange<span class="token operator">=</span><span class="token string">"binddatachange"</span>  bindstatechange<span class="token operator">=</span><span class="token string">"onPlayStateChange"</span> bindnetstatus<span class="token operator">=</span><span class="token string">"onPlayNetStateChange"</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>live<span class="token operator">-</span>player<span class="token operator">&gt;</span>
</code></pre>
    <h5>
     <a id="343__ZEGO__289">
     </a>
     3.4.3 推送音视频流到 ZEGO 即构音视频云
    </h5>
    <p>
     必须完成初始化小程序组件实例和创建业务场景的 WXML 之后，才能调用 SDK 接口创建推流和拉流实例。
    </p>
    <p>
     用户调用 SDK 的
     <code>
      createPusher
     </code>
     接口创建推流实例，并通过调用实例对象上的
     <code>
      start
     </code>
     接口，传入流 ID 参数 “streamID”。您可通过监听
     <code>
      publisherStateUpdate
     </code>
     回调知晓推流是否成功，具体请参考
     <a href="https://doc-zh.zego.im/article/8939#4_1?source=csdn&amp;article47" rel="nofollow">
      4.1 常见通知回调
     </a>
     中的“4.1.4 用户推送音视频流的状态通知”。
    </p>
    <p>
     “streamID” 由您本地生成，但是需要保证：
    </p>
    <ul>
     <li>
      同一个 AppID 下，“streamID” 全局唯一。如果同一个 AppID 下，不同用户各推了一条 “streamID” 相同的流，后推流的用户推流失败。
     </li>
     <li>
      “streamID” 长度不超过 256 字节的字符串。仅支持数字，英文字符和 “~”，“!”，“@”，“$”，“%”，“^”，“&amp;”，“*”，“(”，“)”，“_”，“+”，“=”，“-”，“`”，“;”，“’”，“,”，“.”，“&lt;”，“&gt;”，“/”，“\”。
     </li>
    </ul>
    <pre><code class="prism language-javascript"><span class="token comment">// 推流方登录房间成功后触发推流</span>
 <span class="token keyword">const</span> pusher <span class="token operator">=</span> zg<span class="token punctuation">.</span><span class="token function">createPusher</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 pusher<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token string">"streamID_xxx"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <h4>
     <a id="35__306">
     </a>
     3.5 拉取其他用户的音视频
    </h4>
    <p>
     进行视频通话时，我们需要拉取到其他用户的音视频。
    </p>
    <p>
     用户先调用
     <code>
      getPlayerInstance
     </code>
     接口，根据传入的流 ID 参数 “streamID”，获取 streamID 对应的拉流实例，然后通过调用拉流实例对象的
     <code>
      play
     </code>
     接口开始拉流。您可通过监听
     <code>
      playerStateUpdate
     </code>
     回调知晓是否成功拉取音视频，具体请参考
     <a href="https://doc-zh.zego.im/article/8939#4_1?source=csdn&amp;article47" rel="nofollow">
      4.1 常见通知回调
     </a>
     中的“4.1.5 用户拉取音视频流的状态通知”。
    </p>
    <p>
     远端用户推送的 “streamID” 可以从
     <a href="@roomStreamUpdate" rel="nofollow">
      roomStreamUpdate
     </a>
     回调中获得，具体回调设置请参考
     <a href="https://doc-zh.zego.im/article/8939#4_1?source=csdn&amp;article47" rel="nofollow">
      4.1 常见通知回调
     </a>
     中的“4.1.3 房间内流状态变更的通知”。
    </p>
    <pre><code class="prism language-javascript"><span class="token comment">// 在 SDK 的回调 roomStreamUpdate 中获取拉流 streamID</span>
<span class="token comment">// 当用户加入或离开房间时，该事件被触发</span>
zg<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">"roomStreamUpdate"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">roomID<span class="token punctuation">,</span> updateType<span class="token punctuation">,</span> streamList</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"roomStreamUpdate"</span><span class="token punctuation">,</span> roomID<span class="token punctuation">,</span> updateType<span class="token punctuation">,</span> streamList<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>updateType <span class="token operator">===</span> <span class="token string">"ADD"</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        streamList<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">i</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
              zg<span class="token punctuation">.</span><span class="token function">getPlayerInstance</span><span class="token punctuation">(</span>i<span class="token punctuation">.</span>streamID<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">play</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
       streamList<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">i</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
              zg<span class="token punctuation">.</span><span class="token function">getPlayerInstance</span><span class="token punctuation">(</span>i<span class="token punctuation">.</span>streamID<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <h3>
     <a id="4__333">
     </a>
     4 小程序音视频通话的常用功能
    </h3>
    <h4>
     <a id="41__335">
     </a>
     4.1 常见音视频房间通知回调
    </h4>
    <h5>
     <a id="411__337">
     </a>
     4.1.1 我在房间内的连接状态变化通知
    </h5>
    <p>
     <code>
      roomStateUpdate
     </code>
     ：本地调用
     <code>
      loginRoom
     </code>
     加入房间时，您可通过监听该回调实时监控自己在本房间内的连接状态。
    </p>
    <p>
     用户可以在回调中根据不同状态处理业务逻辑。
    </p>
    <pre><code class="prism language-javascript">zg<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'roomStateUpdate'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">roomID<span class="token punctuation">,</span> state<span class="token punctuation">,</span> errorCode<span class="token punctuation">,</span> extendedData</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>state <span class="token operator">==</span> <span class="token string">'DISCONNECTED'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 与房间断开了连接</span>
	<span class="token comment">// ...</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>state <span class="token operator">==</span> <span class="token string">'CONNECTING'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 与房间尝试连接中</span>
	<span class="token comment">// ...</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>state <span class="token operator">==</span> <span class="token string">'CONNECTED'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 与房间连接成功</span>
	<span class="token comment">// ...</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre>
    <p>
     <img alt="4.png" src="https://i-blog.csdnimg.cn/blog_migrate/11aa9d2ce1268a535154a99ae1e5fbe3.png"/>
    </p>
    <h5>
     <a id="412__365">
     </a>
     4.1.2 其他用户进出房间的通知
    </h5>
    <p>
     <code>
      roomUserUpdate
     </code>
     ：同一房间内的其他用户进出房间时，您可通过此回调收到通知。登录房间后，当房间内有用户新增或删除时，SDK 会通过该回调通知。
    </p>
    <p>
     只有调用
     <code>
      loginRoom
     </code>
     接口登录房间时传入
     <code>
      ZegoRoomConfig
     </code>
     配置，且 “userUpdate” 参数取值为 “true” 时，用户才能收到
     <code>
      roomUserUpdate
     </code>
     回调。
    </p>
    <pre><code class="prism language-javascript"><span class="token comment">// 用户状态更新回调</span>
zg<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'roomUserUpdate'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">roomID<span class="token punctuation">,</span> updateType<span class="token punctuation">,</span> userList</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
    console<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span>
        <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">roomUserUpdate: room </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span>roomID<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">, user </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span>updateType <span class="token operator">===</span> <span class="token string">'ADD'</span> <span class="token operator">?</span> <span class="token string">'added'</span> <span class="token operator">:</span> <span class="token string">'left'</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
        <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>userList<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <h5>
     <a id="413__385">
     </a>
     4.1.3 房间内流状态变更的通知
    </h5>
    <p>
     <code>
      roomStreamUpdate
     </code>
     ：流状态更新回调。登录房间后，当房间内有用户新推送或删除音视频流时，SDK 会通过该回调通知。
    </p>
    <pre><code class="prism language-javascript"><span class="token comment">// 流状态更新回调</span>
zg<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'roomStreamUpdate'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">roomID<span class="token punctuation">,</span> updateType<span class="token punctuation">,</span> streamList<span class="token punctuation">,</span> extendedData</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>updateType <span class="token operator">==</span> <span class="token string">'ADD'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 流新增，开始拉流</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>updateType <span class="token operator">==</span> <span class="token string">'DELETE'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 流删除，停止拉流</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <h5>
     <a id="414__400">
     </a>
     4.1.4 用户推送音视频流的状态通知
    </h5>
    <ul>
     <li>
      推流状态事件
     </li>
    </ul>
    <p>
     微信小程序会在 &lt;live-pusher&gt; 的
     <a href="https://developers.weixin.qq.com/miniprogram/dev/component/live-pusher.html?source=csdn&amp;article47" rel="nofollow">
      bindstatechange
     </a>
     绑定的方法中通知出推流状态事件，开发者需要：
    </p>
    <p>
     a. 在
     <a href="https://developers.weixin.qq.com/miniprogram/dev/component/live-pusher.html?source=csdn&amp;article47" rel="nofollow">
      bindstatechange
     </a>
     绑定的回调函数中，调用 SDK 的
     <code>
      updatePlayerState
     </code>
     接口将推流状态事件透传给 SDK。
    </p>
    <p>
     b. 在 SDK 的
     <code>
      publisherStateUpdate
     </code>
     回调中处理推流的开始、失败状态。
    </p>
    <pre><code class="prism language-javascript"><span class="token comment">// live-pusher 绑定推流事件</span>
<span class="token function">onPushStateChange</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 透传推流事件给 SDK</span>
    zg<span class="token punctuation">.</span><span class="token function">updatePlayerState</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>publishStreamID<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>

<span class="token comment">// 推流后，服务器主动推过来的，流状态更新</span>
<span class="token comment">// NO_PUBLISH：未推流状态，PUBLISH_REQUESTING：正在请求推流状态，PUBLISHING：正在推流状态</span>
<span class="token comment">// state: "PUBLISHING" | "NO_PUBLISH" | "PUBLISH_REQUESTING";</span>
zg<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">"publisherStateUpdate"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">result</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"publishStateUpdate"</span><span class="token punctuation">,</span> result<span class="token punctuation">.</span>state<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <ul>
     <li>
      推流网络事件
     </li>
    </ul>
    <p>
     微信小程序会在 &lt;live-pusher&gt; 的
     <code>
      bindnetstatus
     </code>
     绑定的方法中通知出推流网络事件，开发者需要在对应的小程序回调中，调用 SDK 的
     <code>
      updatePlayerNetStatus
     </code>
     接口将推流网络事件透传给 SDK。
    </p>
    <pre><code class="prism language-javascript"><span class="token comment">// live-pusher 绑定网络状态事件</span>
<span class="token function">onPushNetStateChange</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">//透传网络状态事件给 SDK</span>
    zg<span class="token punctuation">.</span><span class="token function">updatePlayerNetStatus</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>publishStreamID<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>


<span class="token comment">// SDK 推流网络质量回调</span>
zg<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">"publishQualityUpdate"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">streamID<span class="token punctuation">,</span> publishStats</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"publishQualityUpdate"</span><span class="token punctuation">,</span> streamID<span class="token punctuation">,</span> publishStats<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <h5>
     <a id="415__444">
     </a>
     4.1.5 用户拉取音视频流的状态通知
    </h5>
    <ul>
     <li>
      拉流状态事件
     </li>
    </ul>
    <p>
     微信小程序会在 &lt;live-player&gt; 的
     <code>
      bindstatechange
     </code>
     绑定的方法中通知出拉流状态事件，开发者需要：
    </p>
    <p>
     a. 在
     <code>
      bindstatechange
     </code>
     绑定的回调函数中，调用 SDK 的
     <code>
      updatePlayerState
     </code>
     接口将拉流状态事件透传给 SDK。
    </p>
    <p>
     b. 在 SDK 提供的
     <code>
      playerStateUpdate
     </code>
     回调中处理拉流的开始或失败状态。
    </p>
    <pre><code class="prism language-javascript"><span class="token comment">// live-player 绑定的拉流事件</span>
<span class="token function">onPlayStateChange</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 透传拉流事件给 SDK</span>
    zg<span class="token punctuation">.</span><span class="token function">updatePlayerState</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>currentTarget<span class="token punctuation">.</span>id<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>

<span class="token comment">// 服务器主动推过来的流的播放状态</span>
<span class="token comment">// 视频播放状态通知；state: "NO_PLAY" | "PLAY_REQUESTING" | "PLAYING";</span>
zg<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">"playerStateUpdate"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">result</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"playStateUpdate"</span><span class="token punctuation">,</span> result<span class="token punctuation">.</span>state<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <ul>
     <li>
      拉流网络事件
     </li>
    </ul>
    <p>
     微信小程序会在 &lt;live-player&gt; 的
     <code>
      bindnetstatus
     </code>
     绑定的方法中通知出拉流网络事件，开发者需要在对应的小程序回调中，调用 SDK 的
     <code>
      updatePlayerNetStatus
     </code>
     接口将推流网络事件透传给 SDK。
    </p>
    <pre><code class="prism language-javascript"><span class="token comment">// live-player 绑定网络状态事件</span>
<span class="token function">onPlayNetStateChange</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 透传网络状态事件给 SDK</span>
    zg<span class="token punctuation">.</span><span class="token function">updatePlayerNetStatus</span><span class="token punctuation">(</span>playStreamID<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>

<span class="token comment">// SDK 拉流网络质量回调</span>
zg<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">"playQualityUpdate"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">playStreamID<span class="token punctuation">,</span> playStats</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"playQualityUpdate"</span><span class="token punctuation">,</span> playStreamID<span class="token punctuation">,</span> playStats<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <h4>
     <a id="42_fang_jian_486">
     </a>
     4.2 停止fang jian音视频通话
    </h4>
    <h5>
     <a id="421__488">
     </a>
     4.2.1 停止推送/拉取音视频流
    </h5>
    <p>
     <em>
      <strong>
       1. 停止推流
      </strong>
     </em>
    </p>
    <p>
     调用 SDK 的
     <code>
      getPusherInstance
     </code>
     接口获取推流实例，并调用推流实例的
     <code>
      stop
     </code>
     方法停止推流。
    </p>
    <pre><code class="prism language-javascript"><span class="token comment">// 停止推流</span>
zg<span class="token punctuation">.</span><span class="token function">getPusherInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <p>
     <em>
      <strong>
       2. 停止拉流
      </strong>
     </em>
    </p>
    <p>
     调用 SDK 的
     <code>
      getPlayerInstance
     </code>
     接口获取拉流实例，并调用推流实例的
     <code>
      stop
     </code>
     方法停止拉流。
    </p>
    <pre><code class="prism language-javascript"><span class="token comment">// 停止拉流</span>
zg<span class="token punctuation">.</span><span class="token function">getPlayerInstance</span><span class="token punctuation">(</span>streamID<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <h5>
     <a id="422__510">
     </a>
     4.2.2 退出房间
    </h5>
    <p>
     调用 SDK 的
     <code>
      logoutRoom
     </code>
     接口退出房间。
    </p>
    <pre><code class="prism language-javascript">zg<span class="token punctuation">.</span><span class="token function">logoutRoom</span><span class="token punctuation">(</span>roomID<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <h3>
     <a id="5__519">
     </a>
     5 调试视频通话功能
    </h3>
    <p>
     在真机中运行项目，运行成功后，可以看到本端视频画面。
    </p>
    <p>
     为方便体验，ZEGO 提供了一个
     <a href="https://zegodev.gitee.io/zego-express-webrtc-sample/assistDev/index.html?source=csdn&amp;article47" rel="nofollow">
      Web 端调试示例
     </a>
     ，在该页面下，输入相同的 AppID、RoomID，输入一个不同的 UserID，即可加入同一房间与真机设备互通。当成功开始音视频通话时，可以听到远端的音频，看到远端的视频画面。
    </p>
    <h3>
     <a id="6__API__526">
     </a>
     6 视频通话 API 调用时序
    </h3>
    <p>
     整个推拉流过程的 API 调用时序可参考下图：
     <br/>
     <img alt="下载5.png" src="https://i-blog.csdnimg.cn/blog_migrate/a8022038473a7a61e674457da3c5b00a.png"/>
    </p>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
  <div class="blog-extension-box" id="blogExtensionBox" style="width:400px;margin:auto;margin-top:12px">
  </div>
 </article>
 <p alt="6874747073:3a2f2f626c6f672e6373646e2e6e65742f5a45474f3132332f:61727469636c652f64657461696c732f313236393733313134" class_="artid" style="display:none">
 </p>
</div>


