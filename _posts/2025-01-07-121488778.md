---
layout: post
title: "ESP32开发之旅基于ESP32的室内空气质量检测系统"
date: 2025-01-07 19:12:51 +0800
description: "ESP32开发之旅——基于ESP32的室内空气质量检测系统前言前言成果展示核心代码MQTT部分获取传"
keywords: "基于esp32的室内环境监测系统"
categories: ['Micropython']
tags: ['经验分享', 'Python']
artid: "121488778"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=121488778
    alt: "ESP32开发之旅基于ESP32的室内空气质量检测系统"
render_with_liquid: false
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     ESP32开发之旅——基于ESP32的室内空气质量检测系统
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <p>
    </p>
    <div class="toc">
     <h4>
      ESP32开发之旅——基于ESP32的室内空气质量检测系统
     </h4>
     <ul>
      <li>
       <a href="#_2" rel="nofollow">
        前言
       </a>
      </li>
      <li>
       <ul>
        <li>
         <a href="#_7" rel="nofollow">
          成果展示
         </a>
        </li>
       </ul>
      </li>
      <li>
       <a href="#_15" rel="nofollow">
        核心代码
       </a>
      </li>
      <li>
       <ul>
        <li>
         <a href="#MQTT_16" rel="nofollow">
          MQTT部分
         </a>
        </li>
        <li>
         <a href="#_59" rel="nofollow">
          获取传感器数据部分
         </a>
        </li>
        <li>
         <a href="#WiFi_74" rel="nofollow">
          连接WiFi部分
         </a>
        </li>
       </ul>
      </li>
      <li>
       <a href="#_91" rel="nofollow">
        结尾
       </a>
      </li>
     </ul>
    </div>
    <p>
    </p>
    <h2>
     <a id="_2">
     </a>
     前言
    </h2>
    <ul>
     <li>
      <font color="red">
       本文主要是我课设项目的一个备忘，部分资料来源于网上收集。
      </font>
     </li>
     <li>
      本设计以ESP32作为控制核心，用DHT11温湿度传感器对空气中的温度和湿度进行采集，MQ135模块对空气中的污染物进行监测，然后将采集到的数据传送给ESP32控制器进行处理，由ESP32将采集到数据整合后通过MQTT协议上传到阿里云IOT平台，由阿里云平台根据数据进行相应的处理，并将数据进行可视化显示。
     </li>
    </ul>
    <h3>
     <a id="_7">
     </a>
     成果展示
    </h3>
    <p>
     <strong>
      1. web端界面
     </strong>
     <br/>
     <img alt="web端界面" src="https://i-blog.csdnimg.cn/blog_migrate/0b394a92666095b335ed9e98ef86cb22.png">
      <br/>
      <strong>
       2.硬件端
      </strong>
      <br/>
      <img alt="硬件端" src="https://i-blog.csdnimg.cn/blog_migrate/e2faa390b4168e6212bbe4c7666e25ce.png"/>
     </img>
    </p>
    <h2>
     <a id="_15">
     </a>
     核心代码
    </h2>
    <h3>
     <a id="MQTT_16">
     </a>
     MQTT部分
    </h3>
    <pre><code class="prism language-python"><span class="token comment">####阿里云配置</span>
SERVER <span class="token operator">=</span> <span class="token string">'106.15.83.29'</span>  <span class="token comment"># 域名</span>
<span class="token comment">####三元组</span>
ProductKey <span class="token operator">=</span> <span class="token string">""</span>
DeviceName <span class="token operator">=</span> <span class="token string">""</span>
password <span class="token operator">=</span> <span class="token string">''</span>  <span class="token comment">###根据DeviceSecret在第三方平台上计算</span>

CLIENT_ID <span class="token operator">=</span> DeviceName <span class="token operator">+</span> <span class="token string">"|securemode=3,signmethod=hmacsha1|"</span>  <span class="token comment"># 设备ID</span>
username <span class="token operator">=</span> DeviceName <span class="token operator">+</span><span class="token string">'&amp;'</span> <span class="token operator">+</span> ProductKey

publish_TOPIC <span class="token operator">=</span> <span class="token string">'/sys/'</span><span class="token operator">+</span>ProductKey<span class="token operator">+</span><span class="token string">'/'</span><span class="token operator">+</span>DeviceName<span class="token operator">+</span><span class="token string">'/thing/event/property/post'</span>
subscribe_TOPIC <span class="token operator">=</span> <span class="token string">'/sys/'</span><span class="token operator">+</span>ProductKey<span class="token operator">+</span><span class="token string">'/'</span><span class="token operator">+</span>DeviceName<span class="token operator">+</span><span class="token string">'/thing/event/property/post_reply'</span>
client <span class="token operator">=</span> <span class="token boolean">None</span>


<span class="token keyword">def</span> <span class="token function">sub_cb</span><span class="token punctuation">(</span>topic<span class="token punctuation">,</span> msg<span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment">###接收aliyun发送过来的消息</span>
    msg <span class="token operator">=</span> <span class="token builtin">bytes</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span>msg<span class="token punctuation">)</span>  <span class="token comment">###将接收到的bytes类型数据转换成字符串</span>
    msg <span class="token operator">=</span> <span class="token builtin">eval</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span>
    temp <span class="token operator">=</span> msg<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"params"</span><span class="token punctuation">)</span>   <span class="token comment">###提取返回的信息</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>temp<span class="token punctuation">)</span>

    <span class="token keyword">if</span> temp <span class="token operator">!=</span> <span class="token boolean">None</span><span class="token punctuation">:</span>   <span class="token comment">###对硬件进行操作</span>
        AIR<span class="token punctuation">.</span>value<span class="token punctuation">(</span>temp<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"air"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        Gl<span class="token punctuation">.</span>value<span class="token punctuation">(</span>temp<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"LED"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">apptimerevent</span><span class="token punctuation">(</span>mytimer<span class="token punctuation">)</span><span class="token punctuation">:</span>   <span class="token comment">###将获取到的数据上传到aliyun上</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        sensordata <span class="token operator">=</span> ReadTemHum<span class="token punctuation">(</span><span class="token punctuation">)</span>
        mymessage <span class="token operator">=</span> <span class="token string">'{"params": {"CurrentTemperature": %d ,"CurrentHumidity": %d ,"AQI":%d}, "method": "thing.event.property.post"}'</span> <span class="token operator">%</span> <span class="token punctuation">(</span>
        sensordata<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> sensordata<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> sensordata<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span>   <span class="token comment">##和阿里云上设置的属性相同</span>
        client<span class="token punctuation">.</span>publish<span class="token punctuation">(</span>topic<span class="token operator">=</span>publish_TOPIC<span class="token punctuation">,</span> msg<span class="token operator">=</span>mymessage<span class="token punctuation">,</span> retain<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> qos<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token keyword">except</span> Exception <span class="token keyword">as</span> ex_results2<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'exception'</span><span class="token punctuation">,</span> ex_results2<span class="token punctuation">)</span>
        mytimer<span class="token punctuation">.</span>deinit<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">on_message</span><span class="token punctuation">(</span>client<span class="token punctuation">,</span> userdata<span class="token punctuation">,</span> msg<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">'''处理message回调'''</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'topic: {}'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>topic<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'message: {}'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>payload<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre>
    <h3>
     <a id="_59">
     </a>
     获取传感器数据部分
    </h3>
    <pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">ReadTemHum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>   <span class="token comment">###获取传感器的数据</span>
    mydht<span class="token punctuation">.</span>measure<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">###读取温湿度传感器数据</span>
    qt_data <span class="token operator">=</span> mymq<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>   <span class="token comment">###读取MQ135空气质量传感器数据</span>
    tem <span class="token operator">=</span> mydht<span class="token punctuation">.</span>temperature<span class="token punctuation">(</span><span class="token punctuation">)</span>   <span class="token comment">###提取温度数据</span>
    hum <span class="token operator">=</span> mydht<span class="token punctuation">.</span>humidity<span class="token punctuation">(</span><span class="token punctuation">)</span>     <span class="token comment">###提取湿度数据</span>
    <span class="token keyword">if</span> qt_data <span class="token operator">&gt;=</span> <span class="token number">2000</span><span class="token punctuation">:</span>     <span class="token comment">###防止将MQ135产生的异常数据上传</span>
        qt_data <span class="token operator">=</span> <span class="token number">0</span>

    data <span class="token operator">=</span> <span class="token punctuation">[</span>tem<span class="token punctuation">,</span> hum<span class="token punctuation">,</span> qt_data<span class="token punctuation">]</span>  <span class="token comment">###将数据整合到列表里面，方便上面函数调用</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
    <span class="token keyword">return</span> data
</code></pre>
    <h3>
     <a id="WiFi_74">
     </a>
     连接WiFi部分
    </h3>
    <pre><code class="prism language-python"><span class="token comment">#######WIFI配置</span>
SSID <span class="token operator">=</span> <span class="token string">" "</span>
PASSWORD <span class="token operator">=</span> <span class="token string">" "</span>
<span class="token keyword">def</span> <span class="token function">ConnectWifi</span><span class="token punctuation">(</span>ssid<span class="token punctuation">,</span> passwd<span class="token punctuation">)</span><span class="token punctuation">:</span>   <span class="token comment">###用来建立wifi连接</span>
    <span class="token keyword">global</span> wlan
    wlan <span class="token operator">=</span> network<span class="token punctuation">.</span>WLAN<span class="token punctuation">(</span>network<span class="token punctuation">.</span>STA_IF<span class="token punctuation">)</span>  <span class="token comment"># create a wlan object</span>
    wlan<span class="token punctuation">.</span>active<span class="token punctuation">(</span><span class="token boolean">True</span><span class="token punctuation">)</span>  <span class="token comment"># Activate the network interface</span>
    wlan<span class="token punctuation">.</span>disconnect<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># Disconnect the last connected WiFi</span>
    wlan<span class="token punctuation">.</span>connect<span class="token punctuation">(</span>ssid<span class="token punctuation">,</span> passwd<span class="token punctuation">)</span>  <span class="token comment"># 进行连接</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>wlan<span class="token punctuation">.</span>ifconfig<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">'0.0.0.0'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>wlan<span class="token punctuation">.</span>ifconfig<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre>
    <h2>
     <a id="_91">
     </a>
     结尾
    </h2>
    <p>
     懒人包下载链接：
     <a href="https://download.csdn.net/download/weixin_44186593/47501979">
      https://download.csdn.net/download/weixin_44186593/47501979
     </a>
    </p>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f626c6f672e:6373646e2e6e65742f77656978696e5f34343138363539332f:61727469636c652f64657461696c732f313231343838373738" class_="artid" style="display:none">
 </p>
</div>


