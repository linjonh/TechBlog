---
layout: post
title: "微信小程序-shiro-实现登录安全管理-保姆级教学"
date: 2024-12-10 09:47:47 +0800
description: "最近，我开发了一个微信小程序，后台使用 Spring 搭建，安全管理交给了 shiro。初次将二者结"
keywords: "小程序+shiro"
categories: ['微信小程序', 'Web', 'Java']
tags: ['无标签']
artid: "115411092"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=115411092
    alt: "微信小程序-shiro-实现登录安全管理-保姆级教学"
render_with_liquid: false
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     微信小程序 + shiro 实现登录（安全管理） —— 保姆级教学
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atelier-sulphurpool-light" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <p>
    </p>
    <div class="toc">
     <h4>
      文章目录
     </h4>
     <ul>
      <li>
       <a href="#_3" rel="nofollow">
        一、开发流程
       </a>
      </li>
      <li>
       <ul>
        <li>
         <a href="#11__6" rel="nofollow">
          1.1 难点及其解决办法
         </a>
        </li>
        <li>
         <ul>
          <li>
           <a href="#111__12" rel="nofollow">
            1.1.1 解决办法
           </a>
          </li>
          <li>
           <ul>
            <li>
             <a href="#1111__13" rel="nofollow">
              1.1.1.1 针对第一点：
             </a>
            </li>
            <li>
             <a href="#1112__27" rel="nofollow">
              1.1.1.2 针对第二点：
             </a>
            </li>
           </ul>
          </li>
         </ul>
        </li>
       </ul>
      </li>
      <li>
       <a href="#_102" rel="nofollow">
        二、代码
       </a>
      </li>
      <li>
       <ul>
        <li>
         <a href="#21__103" rel="nofollow">
          2.1 小程序
         </a>
        </li>
        <li>
         <ul>
          <li>
           <a href="#211_appjs_104" rel="nofollow">
            2.1.1 app.js
           </a>
          </li>
         </ul>
        </li>
        <li>
         <a href="#22_spring__160" rel="nofollow">
          2.2 spring 后端代码
         </a>
        </li>
        <li>
         <ul>
          <li>
           <a href="#221_pomxml_161" rel="nofollow">
            2.2.1 pom.xml
           </a>
          </li>
          <li>
           <a href="#222_reaml__176" rel="nofollow">
            2.2.2 reaml 的代码
           </a>
          </li>
          <li>
           <a href="#223_sessionManager__219" rel="nofollow">
            2.2.3 sessionManager 代码
           </a>
          </li>
          <li>
           <a href="#224_ShiroConfigjava_262" rel="nofollow">
            2.2.4 ShiroConfig.java
           </a>
          </li>
          <li>
           <a href="#225_LoginControllerjava_341" rel="nofollow">
            2.2.5 LoginController.java
           </a>
          </li>
          <li>
           <a href="#226_WeChatUtiljava_388" rel="nofollow">
            2.2.6 WeChatUtil.java
           </a>
          </li>
         </ul>
        </li>
       </ul>
      </li>
      <li>
       <a href="#_436" rel="nofollow">
        三、最后的说明
       </a>
      </li>
      <li>
       <ul>
        <li>
         <a href="#31__437" rel="nofollow">
          3.1 用户信息的管理
         </a>
        </li>
        <li>
         <a href="#32__shiro__1112__web__440" rel="nofollow">
          3.2 用户登录成功后，通过 shiro 交互的页面例子我就不举例了。主要是注意 1.1.1.2 第一点内容就行。只要注意到这一点，其它便于浏览器上的 web 开发无异了
         </a>
        </li>
       </ul>
      </li>
     </ul>
    </div>
    <br/>
    最近，我开发了一个微信小程序，后台使用 Spring 搭建，安全管理交给了 shiro。初次将二者结合开发，经验不足，不知如何把二者结合起来。在网上搜寻了一阵，查到的资料有限——给的不全，要么是代码臃肿不规范。因此，本博主决定此时抽出半日的空闲为后来者写上一篇完整的
    <strong>
     微信小程序 + shiro 如何开发
    </strong>
    的文章。
    <p>
    </p>
    <h2>
     <a id="_3">
     </a>
     一、开发流程
    </h2>
    <p>
     首先，我们先看一下，微信官方推荐的登录流程，后序的开发就是按这个来的。
     <br/>
     <img alt="微信小程序登录流程" src="https://i-blog.csdnimg.cn/blog_migrate/559b7f1ffed5337b1d76f706d8595ac3.png"/>
    </p>
    <h3>
     <a id="11__6">
     </a>
     1.1 难点及其解决办法
    </h3>
    <p>
     仔细看这张图会发现，我们的难处有两点：
    </p>
    <ol>
     <li>
      微信小程序不是 web 浏览器。它不会为我们自主的储存 shiro 的 JSessionId。需要我们自己储存
     </li>
     <li>
      就算每次请求我们都能在 header 中带上 JSessionId ，我们服务器上的 shiro 也不能识别。需要我们对 request 做些修改
     </li>
    </ol>
    <h4>
     <a id="111__12">
     </a>
     1.1.1 解决办法
    </h4>
    <h5>
     <a id="1111__13">
     </a>
     1.1.1.1 针对第一点：
    </h5>
    <p>
     先简述下原理：
    </p>
    <blockquote>
     <p>
      http 协议是无状态协议。我们并不能通过每次的请求知晓操作者是谁。为了解决这个问题，提出了 cookie 的概念，解决这个问题。
      <br/>
      客户与服务器之间通过 sessionId 进行交流。
     </p>
    </blockquote>
    <p>
     当然这也是 shiro 的原理。shiro 就是通过 request header 中的 JSessionId 识别用户的。
    </p>
    <p>
     在调用我们的服务器根据用户的 openid 确认到给用户后，shiro 此时也完成了用户的登录，并把用户信息保存起来了，最后，controller 返回处理结果。（具体代码见下方）
     <br/>
     <strong>
      我们在微信小程序端要获取到 JSeesionId ，并保存：
     </strong>
     <br/>
     （下方代码在 app.js 的 onLounch() 方法里）
    </p>
    <pre><code class="prism language-javascript"><span class="token keyword">let</span> JSessionId <span class="token operator">=</span> response<span class="token punctuation">.</span>header<span class="token punctuation">[</span><span class="token string">"Set-Cookie"</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">';'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 wx<span class="token punctuation">.</span><span class="token function">setStorageSync</span><span class="token punctuation">(</span><span class="token string">"JSessionId"</span><span class="token punctuation">,</span> JSessionId<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <h5>
     <a id="1112__27">
     </a>
     1.1.1.2 针对第二点：
    </h5>
    <p>
     在需要用户登录的地方，我们只要注意两点：
    </p>
    <ol>
     <li>
      <code>
       wx.request()
      </code>
      向有登录要求的 URL 发送请求时，在 header 中带上该字段，代码如下：
     </li>
    </ol>
    <pre><code class="prism language-javascript">wx<span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
	url<span class="token punctuation">:</span> <span class="token constant">URL</span><span class="token punctuation">,</span>
	 header<span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
	   <span class="token string">"Content-Type"</span><span class="token punctuation">:</span> <span class="token string">"application/x-www-form-urlencoded"</span><span class="token punctuation">,</span>
	   <span class="token string">"JSessionId"</span><span class="token punctuation">:</span> wx<span class="token punctuation">.</span><span class="token function">getStorageSync</span><span class="token punctuation">(</span><span class="token string">'JSessionId'</span><span class="token punctuation">)</span>
	 <span class="token punctuation">}</span><span class="token punctuation">,</span>
	 data<span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">,</span>
	 <span class="token function">success</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
    <ol start="2">
     <li>
      自定义
      <code>
       sessionManager
      </code>
      ，并将其注入到
      <code>
       shiro 的 securityManager
      </code>
     </li>
    </ol>
    <ul>
     <li>
      自定义
      <code>
       sessionManager
      </code>
     </li>
    </ul>
    <pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WeChatSessionManager</span> <span class="token keyword">extends</span> <span class="token class-name">DefaultWebSessionManager</span> <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">static</span> String HEADER_TOKEN_NAME <span class="token operator">=</span> <span class="token string">"JSessionId"</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> String REFERENCED_SESSION_ID_SOURCE <span class="token operator">=</span> <span class="token string">"Stateless request"</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * 逻辑:
     *     如果请求头中有 JSessionId，就分析它；
     *     没有就调用父类的方法
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> Serializable <span class="token function">getSessionId</span><span class="token punctuation">(</span>ServletRequest request<span class="token punctuation">,</span> ServletResponse response<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        String JSessionId <span class="token operator">=</span> WebUtils<span class="token punctuation">.</span><span class="token function">toHttp</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getHeader</span><span class="token punctuation">(</span>HEADER_TOKEN_NAME<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span><span class="token punctuation">(</span>JSessionId <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">getSessionId</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            request<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span>ShiroHttpServletRequest<span class="token punctuation">.</span>REFERENCED_SESSION_ID_SOURCE<span class="token punctuation">,</span>REFERENCED_SESSION_ID_SOURCE<span class="token punctuation">)</span><span class="token punctuation">;</span>
            request<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span>ShiroHttpServletRequest<span class="token punctuation">.</span>REFERENCED_SESSION_ID<span class="token punctuation">,</span> JSessionId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"JSessionId: {}"</span><span class="token punctuation">,</span> JSessionId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            request<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span>ShiroHttpServletRequest<span class="token punctuation">.</span>REFERENCED_SESSION_ID_IS_VALID<span class="token punctuation">,</span> Boolean<span class="token punctuation">.</span>TRUE<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> JSessionId<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <ul>
     <li>
      将
      <code>
       sessionManager
      </code>
      注入到
      <code>
       shiro 的 securityManager
      </code>
      <br/>
      当然，你也可以根据自己的需求，对
      <code>
       sessionManager
      </code>
      做些自己的定义
     </li>
    </ul>
    <pre><code class="prism language-java"><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ShiroConfig</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">/**
     * 其它代码
     * /

    @Bean
    public WeChatSessionManager sessionManager() {
        WeChatSessionManager weChatSessionManager = new WeChatSessionManager();
        return weChatSessionManager;
    }

    @Bean
    public SecurityManager securityManager(@Qualifier("realm") Realm realm,
                           @Qualifier("sessionManager") SessionManager sessionManager) {
        DefaultWebSecurityManager securityManager = new DefaultWebSecurityManager();
        securityManager.setRealm(realm);
        securityManager.setSessionManager(sessionManager);
        return securityManager;
    }
    
    /**
     * 其它代码
     * /
}

</span></code></pre>
    <h2>
     <a id="_102">
     </a>
     二、代码
    </h2>
    <h3>
     <a id="21__103">
     </a>
     2.1 小程序
    </h3>
    <h4>
     <a id="211_appjs_104">
     </a>
     2.1.1 app.js
    </h4>
    <pre><code class="prism language-javascript"><span class="token comment">//app.js</span>
<span class="token function">App</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
  globalData<span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
    timeout<span class="token punctuation">:</span> <span class="token number">30000</span><span class="token punctuation">,</span>
    localhost<span class="token punctuation">:</span> <span class="token string">"http://localhost:8080/miniprogram"</span><span class="token punctuation">,</span>
    login<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>


  <span class="token comment">/**
   * 小程序初始化
   */</span>
  onLaunch<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">let</span> p <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    wx<span class="token punctuation">.</span><span class="token function">login</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
      <span class="token function">success</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>res<span class="token punctuation">.</span>code<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          p<span class="token punctuation">.</span><span class="token function">login</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>code<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      fail<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> wx<span class="token punctuation">.</span><span class="token function">showModal</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
        content<span class="token punctuation">:</span> <span class="token string">"获取 code 失败"</span><span class="token punctuation">,</span>
        showCancel<span class="token punctuation">:</span> <span class="token boolean">false</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>

  <span class="token function">login</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">let</span> p <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>

    wx<span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
      url<span class="token punctuation">:</span> p<span class="token punctuation">.</span>globalData<span class="token punctuation">.</span>localhost <span class="token operator">+</span> <span class="token string">"/noLogin/login"</span><span class="token punctuation">,</span>
      method<span class="token punctuation">:</span> <span class="token string">"POST"</span><span class="token punctuation">,</span>
      header<span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span><span class="token string">"Content-Type"</span><span class="token punctuation">:</span> <span class="token string">"application/x-www-form-urlencoded"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
      data<span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>code<span class="token punctuation">:</span> code<span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token function">success</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">switch</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span>data<span class="token punctuation">[</span><span class="token string">"data"</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>                  
          <span class="token keyword">case</span> <span class="token string">"unregistered"</span><span class="token punctuation">:</span>
            wx<span class="token punctuation">.</span><span class="token function">showModal</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
              content<span class="token punctuation">:</span> <span class="token string">"您未注册，是否前往注册"</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
          <span class="token keyword">case</span> <span class="token string">"registered"</span><span class="token punctuation">:</span> 
            p<span class="token punctuation">.</span>globalData<span class="token punctuation">.</span>login <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token keyword">let</span> JSessionId <span class="token operator">=</span> response<span class="token punctuation">.</span>header<span class="token punctuation">[</span><span class="token string">"Set-Cookie"</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">';'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            wx<span class="token punctuation">.</span><span class="token function">setStorageSync</span><span class="token punctuation">(</span><span class="token string">"JSessionId"</span><span class="token punctuation">,</span> JSessionId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre>
    <h3>
     <a id="22_spring__160">
     </a>
     2.2 spring 后端代码
    </h3>
    <h4>
     <a id="221_pomxml_161">
     </a>
     2.2.1 pom.xml
    </h4>
    <p>
     主要是
     <code>
      shiro 的 dependency
     </code>
     ，其它请根据自己的业务需求自行添加
    </p>
    <pre><code class="prism language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.projectlombok<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>lombok<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>optional</span><span class="token punctuation">&gt;</span></span>true<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>optional</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.shiro<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>shiro-spring<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.7.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre>
    <h4>
     <a id="222_reaml__176">
     </a>
     2.2.2 reaml 的代码
    </h4>
    <pre><code class="prism language-java"><span class="token keyword">import</span> lombok<span class="token punctuation">.</span>extern<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span>Slf4j<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>shiro<span class="token punctuation">.</span>authc<span class="token punctuation">.</span>*<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>shiro<span class="token punctuation">.</span>authz<span class="token punctuation">.</span>AuthorizationInfo<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>shiro<span class="token punctuation">.</span>realm<span class="token punctuation">.</span>AuthorizingRealm<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>shiro<span class="token punctuation">.</span>subject<span class="token punctuation">.</span>PrincipalCollection<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>shiro<span class="token punctuation">.</span>util<span class="token punctuation">.</span>ByteSource<span class="token punctuation">;</span>
<span class="token keyword">import</span> top<span class="token punctuation">.</span>leeti<span class="token punctuation">.</span>entity<span class="token punctuation">.</span>User<span class="token punctuation">;</span>
<span class="token keyword">import</span> top<span class="token punctuation">.</span>leeti<span class="token punctuation">.</span>service<span class="token punctuation">.</span>UserService<span class="token punctuation">;</span>
<span class="token keyword">import</span> top<span class="token punctuation">.</span>leeti<span class="token punctuation">.</span>util<span class="token punctuation">.</span>PasswordUtil<span class="token punctuation">;</span>

<span class="token keyword">import</span> javax<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>Resource<span class="token punctuation">;</span>

<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyRealm</span> <span class="token keyword">extends</span> <span class="token class-name">AuthorizingRealm</span> <span class="token punctuation">{<!-- --></span>

    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> UserService userService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> AuthorizationInfo <span class="token function">doGetAuthorizationInfo</span><span class="token punctuation">(</span>PrincipalCollection principalCollection<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> null<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> AuthenticationInfo <span class="token function">doGetAuthenticationInfo</span><span class="token punctuation">(</span>AuthenticationToken authenticationToken<span class="token punctuation">)</span>
            <span class="token keyword">throws</span> AuthenticationException <span class="token punctuation">{<!-- --></span>
        UsernamePasswordToken usernamePasswordToken <span class="token operator">=</span> <span class="token punctuation">(</span>UsernamePasswordToken<span class="token punctuation">)</span> authenticationToken<span class="token punctuation">;</span>

        User user <span class="token operator">=</span> userService<span class="token punctuation">.</span><span class="token function">getUserByOpenId</span><span class="token punctuation">(</span>usernamePasswordToken<span class="token punctuation">.</span><span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>user <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">AccountException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        ByteSource saltOfCredential <span class="token operator">=</span> ByteSource<span class="token punctuation">.</span>Util<span class="token punctuation">.</span><span class="token function">bytes</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getStuId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">SimpleAuthenticationInfo</span><span class="token punctuation">(</span>user<span class="token punctuation">,</span> String<span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>usernamePasswordToken<span class="token punctuation">.</span><span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                saltOfCredential<span class="token punctuation">,</span> <span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre>
    <h4>
     <a id="223_sessionManager__219">
     </a>
     2.2.3 sessionManager 代码
    </h4>
    <pre><code class="prism language-java"><span class="token keyword">import</span> lombok<span class="token punctuation">.</span>extern<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span>Slf4j<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>shiro<span class="token punctuation">.</span>web<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>ShiroHttpServletRequest<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>shiro<span class="token punctuation">.</span>web<span class="token punctuation">.</span>session<span class="token punctuation">.</span>mgt<span class="token punctuation">.</span>DefaultWebSessionManager<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>shiro<span class="token punctuation">.</span>web<span class="token punctuation">.</span>util<span class="token punctuation">.</span>WebUtils<span class="token punctuation">;</span>

<span class="token keyword">import</span> javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>ServletRequest<span class="token punctuation">;</span>
<span class="token keyword">import</span> javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>ServletResponse<span class="token punctuation">;</span>
<span class="token keyword">import</span> java<span class="token punctuation">.</span>io<span class="token punctuation">.</span>Serializable<span class="token punctuation">;</span>

<span class="token comment">/**
 * 自定义session管理器
 * 继承DefaultWebSessionManager,重写getSessionId方法
 */</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WeChatSessionManager</span> <span class="token keyword">extends</span> <span class="token class-name">DefaultWebSessionManager</span> <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">static</span> String HEADER_TOKEN_NAME <span class="token operator">=</span> <span class="token string">"JSessionId"</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> String REFERENCED_SESSION_ID_SOURCE <span class="token operator">=</span> <span class="token string">"Stateless request"</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * 逻辑:
     *     如果请求头中有 JSessionId，就分析它；
     *     没有就调用父类的方法
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> Serializable <span class="token function">getSessionId</span><span class="token punctuation">(</span>ServletRequest request<span class="token punctuation">,</span> ServletResponse response<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        String JSessionId <span class="token operator">=</span> WebUtils<span class="token punctuation">.</span><span class="token function">toHttp</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getHeader</span><span class="token punctuation">(</span>HEADER_TOKEN_NAME<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span><span class="token punctuation">(</span>JSessionId <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">getSessionId</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            request<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span>ShiroHttpServletRequest<span class="token punctuation">.</span>REFERENCED_SESSION_ID_SOURCE<span class="token punctuation">,</span>REFERENCED_SESSION_ID_SOURCE<span class="token punctuation">)</span><span class="token punctuation">;</span>
            request<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span>ShiroHttpServletRequest<span class="token punctuation">.</span>REFERENCED_SESSION_ID<span class="token punctuation">,</span> JSessionId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"JSessionId: {}"</span><span class="token punctuation">,</span> JSessionId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            request<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span>ShiroHttpServletRequest<span class="token punctuation">.</span>REFERENCED_SESSION_ID_IS_VALID<span class="token punctuation">,</span> Boolean<span class="token punctuation">.</span>TRUE<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> JSessionId<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre>
    <h4>
     <a id="224_ShiroConfigjava_262">
     </a>
     2.2.4 ShiroConfig.java
    </h4>
    <pre><code class="prism language-java"><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>shiro<span class="token punctuation">.</span>authc<span class="token punctuation">.</span>credential<span class="token punctuation">.</span>CredentialsMatcher<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>shiro<span class="token punctuation">.</span>authc<span class="token punctuation">.</span>credential<span class="token punctuation">.</span>HashedCredentialsMatcher<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>shiro<span class="token punctuation">.</span>mgt<span class="token punctuation">.</span>SecurityManager<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>shiro<span class="token punctuation">.</span>realm<span class="token punctuation">.</span>Realm<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>shiro<span class="token punctuation">.</span>session<span class="token punctuation">.</span>mgt<span class="token punctuation">.</span>SessionManager<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>shiro<span class="token punctuation">.</span>spring<span class="token punctuation">.</span>web<span class="token punctuation">.</span>ShiroFilterFactoryBean<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>shiro<span class="token punctuation">.</span>web<span class="token punctuation">.</span>mgt<span class="token punctuation">.</span>DefaultWebSecurityManager<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>Qualifier<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>Bean<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>Configuration<span class="token punctuation">;</span>
<span class="token keyword">import</span> top<span class="token punctuation">.</span>leeti<span class="token punctuation">.</span>config<span class="token punctuation">.</span>manager<span class="token punctuation">.</span>WeChatSessionManager<span class="token punctuation">;</span>
<span class="token keyword">import</span> top<span class="token punctuation">.</span>leeti<span class="token punctuation">.</span>realm<span class="token punctuation">.</span>MyRealm<span class="token punctuation">;</span>

<span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>HashMap<span class="token punctuation">;</span>
<span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>Map<span class="token punctuation">;</span>

<span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ShiroConfig</span> <span class="token punctuation">{<!-- --></span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> CredentialsMatcher <span class="token function">credentialsMatcher</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        HashedCredentialsMatcher matcher <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashedCredentialsMatcher</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        matcher<span class="token punctuation">.</span><span class="token function">setHashAlgorithmName</span><span class="token punctuation">(</span><span class="token string">"MD5"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        matcher<span class="token punctuation">.</span><span class="token function">setHashIterations</span><span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> matcher<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> Realm <span class="token function">realm</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Qualifier</span><span class="token punctuation">(</span><span class="token string">"credentialsMatcher"</span><span class="token punctuation">)</span> CredentialsMatcher credentialsMatcher<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        MyRealm realm <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyRealm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        realm<span class="token punctuation">.</span><span class="token function">setCredentialsMatcher</span><span class="token punctuation">(</span>credentialsMatcher<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">MyRealm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> WeChatSessionManager <span class="token function">sessionManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        WeChatSessionManager weChatSessionManager <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WeChatSessionManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> weChatSessionManager<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> SecurityManager <span class="token function">securityManager</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Qualifier</span><span class="token punctuation">(</span><span class="token string">"realm"</span><span class="token punctuation">)</span> Realm realm<span class="token punctuation">,</span>
                           <span class="token annotation punctuation">@Qualifier</span><span class="token punctuation">(</span><span class="token string">"sessionManager"</span><span class="token punctuation">)</span> SessionManager sessionManager<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        DefaultWebSecurityManager securityManager <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultWebSecurityManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        securityManager<span class="token punctuation">.</span><span class="token function">setRealm</span><span class="token punctuation">(</span>realm<span class="token punctuation">)</span><span class="token punctuation">;</span>
        securityManager<span class="token punctuation">.</span><span class="token function">setSessionManager</span><span class="token punctuation">(</span>sessionManager<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> securityManager<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> ShiroFilterFactoryBean <span class="token function">shiroFilter</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Qualifier</span><span class="token punctuation">(</span><span class="token string">"securityManager"</span><span class="token punctuation">)</span> SecurityManager securityManager<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        ShiroFilterFactoryBean shiroFilterFactoryBean <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ShiroFilterFactoryBean</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        shiroFilterFactoryBean<span class="token punctuation">.</span><span class="token function">setSecurityManager</span><span class="token punctuation">(</span>securityManager<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 设置默认登录的 url（若登录失败，则转到此）</span>
        shiroFilterFactoryBean<span class="token punctuation">.</span><span class="token function">setLoginUrl</span><span class="token punctuation">(</span><span class="token string">"/app/noLogin/error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 设置登录认证成功后默认转到的 url</span>
<span class="token comment">//        shiroFilterFactoryBean.setSuccessUrl("/admin/index");</span>
        <span class="token comment">// 设置权限认证失败时转到的 url</span>
        shiroFilterFactoryBean<span class="token punctuation">.</span><span class="token function">setUnauthorizedUrl</span><span class="token punctuation">(</span><span class="token string">"/app/noLogin/noAccess"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">/*
         * anon：匿名用户可访问
         * authc：认证用户可访问
         * user：使用rememberMe可访问
         * perms：对应权限可访问
         * roles[角色名]：对应角色权限可访问
         */</span>
        <span class="token comment">//设置访问各 url 的权限</span>
        Map<span class="token generics function"><span class="token punctuation">&lt;</span>String<span class="token punctuation">,</span> String<span class="token punctuation">&gt;</span></span> filterChain <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token operator">&lt;</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        shiroFilterFactoryBean<span class="token punctuation">.</span><span class="token function">setFilterChainDefinitionMap</span><span class="token punctuation">(</span>filterChain<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> shiroFilterFactoryBean<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <h4>
     <a id="225_LoginControllerjava_341">
     </a>
     2.2.5 LoginController.java
    </h4>
    <pre><code class="prism language-java"><span class="token keyword">package</span> top<span class="token punctuation">.</span>leeti<span class="token punctuation">.</span>controller<span class="token punctuation">.</span>nologin<span class="token punctuation">;</span>

<span class="token keyword">import</span> com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>fastjson<span class="token punctuation">.</span>JSON<span class="token punctuation">;</span>
<span class="token keyword">import</span> lombok<span class="token punctuation">.</span>extern<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span>Slf4j<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>shiro<span class="token punctuation">.</span>SecurityUtils<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>shiro<span class="token punctuation">.</span>authc<span class="token punctuation">.</span>AccountException<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>shiro<span class="token punctuation">.</span>authc<span class="token punctuation">.</span>UsernamePasswordToken<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>shiro<span class="token punctuation">.</span>subject<span class="token punctuation">.</span>Subject<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>*<span class="token punctuation">;</span>
<span class="token keyword">import</span> top<span class="token punctuation">.</span>leeti<span class="token punctuation">.</span>entity<span class="token punctuation">.</span>result<span class="token punctuation">.</span>Result<span class="token punctuation">;</span>
<span class="token keyword">import</span> top<span class="token punctuation">.</span>leeti<span class="token punctuation">.</span>myenum<span class="token punctuation">.</span>ResultCodeEnum<span class="token punctuation">;</span>
<span class="token keyword">import</span> top<span class="token punctuation">.</span>leeti<span class="token punctuation">.</span>util<span class="token punctuation">.</span>WechatUtil<span class="token punctuation">;</span>

<span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>Map<span class="token punctuation">;</span>

<span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@RestController</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/miniprogram/noLogin/"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LoginController</span> <span class="token punctuation">{<!-- --></span>
    
    <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">"login"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> String <span class="token function">login</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span> String code<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        Map<span class="token generics function"><span class="token punctuation">&lt;</span>String<span class="token punctuation">,</span> String<span class="token punctuation">&gt;</span></span> map <span class="token operator">=</span> WechatUtil<span class="token punctuation">.</span><span class="token function">acquireSessionKeyAndOpenId</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">;</span>
        String openId <span class="token operator">=</span> map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"openId"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        Result<span class="token generics function"><span class="token punctuation">&lt;</span>String<span class="token punctuation">&gt;</span></span> result <span class="token operator">=</span> null<span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>openId <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>null<span class="token punctuation">,</span> <span class="token string">"获取openId失败"</span><span class="token punctuation">,</span> null<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            UsernamePasswordToken usernamePasswordToken <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UsernamePasswordToken</span><span class="token punctuation">(</span>openId<span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            Subject currentUser <span class="token operator">=</span> SecurityUtils<span class="token punctuation">.</span><span class="token function">getSubject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span><span class="token punctuation">{<!-- --></span>
                currentUser<span class="token punctuation">.</span><span class="token function">login</span><span class="token punctuation">(</span>usernamePasswordToken<span class="token punctuation">)</span><span class="token punctuation">;</span>
                result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>null<span class="token punctuation">,</span> null<span class="token punctuation">,</span> <span class="token string">"registered"</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>AccountException accountException<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>null<span class="token punctuation">,</span> null<span class="token punctuation">,</span> <span class="token string">"unregistered"</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> JSON<span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> JSON<span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <h4>
     <a id="226_WeChatUtiljava_388">
     </a>
     2.2.6 WeChatUtil.java
    </h4>
    <pre><code class="prism language-java"><span class="token keyword">package</span> top<span class="token punctuation">.</span>leeti<span class="token punctuation">.</span>util<span class="token punctuation">;</span>

<span class="token keyword">import</span> lombok<span class="token punctuation">.</span>extern<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span>Slf4j<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>http<span class="token punctuation">.</span>HttpHeaders<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>http<span class="token punctuation">.</span>MediaType<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>http<span class="token punctuation">.</span>ResponseEntity<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>client<span class="token punctuation">.</span>RestTemplate<span class="token punctuation">;</span>

<span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>Hashtable<span class="token punctuation">;</span>
<span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>Map<span class="token punctuation">;</span>

<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WechatUtil</span> <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> String APP_ID <span class="token operator">=</span> <span class="token string">"wxf4eeba633c89a51f"</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> String APP_SECRET <span class="token operator">=</span> <span class="token string">"8a7de97a3189c29e3faf87275e3449ee"</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> String GRANT_TYPE <span class="token operator">=</span> <span class="token string">"authorization_code"</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * 像微信服务器发送请求，获取 sessionKey、openId
     * @param code
     *        本次登录请求的小程序传来的标识（保证传来的 code 绝不为空或是空字符串）
     * @return
     *        Map key:sessionKey、openId。如果不能正确地获取到 sessionKey、openId，
     *        返回的 map 中，值为 null。
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> Map<span class="token generics function"><span class="token punctuation">&lt;</span>String<span class="token punctuation">,</span> String<span class="token punctuation">&gt;</span></span> <span class="token function">acquireSessionKeyAndOpenId</span><span class="token punctuation">(</span>String code<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        RestTemplate restTemplate <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RestTemplate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        Map<span class="token generics function"><span class="token punctuation">&lt;</span>String<span class="token punctuation">,</span> String<span class="token punctuation">&gt;</span></span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Hashtable</span><span class="token operator">&lt;</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span><span class="token punctuation">{<!-- --></span>
            String url <span class="token operator">=</span> String<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"https://api.weixin.qq.com/sns/jscode2session"</span> <span class="token operator">+</span>
                    <span class="token string">"?appid=%s&amp;secret=%s&amp;js_code=%s&amp;grant_type=%s"</span><span class="token punctuation">,</span> APP_ID<span class="token punctuation">,</span> APP_SECRET<span class="token punctuation">,</span> code<span class="token punctuation">,</span> GRANT_TYPE<span class="token punctuation">)</span><span class="token punctuation">;</span>
            HttpHeaders headers <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HttpHeaders</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            headers<span class="token punctuation">.</span><span class="token function">setContentType</span><span class="token punctuation">(</span>MediaType<span class="token punctuation">.</span>APPLICATION_FORM_URLENCODED<span class="token punctuation">)</span><span class="token punctuation">;</span>
            ResponseEntity<span class="token generics function"><span class="token punctuation">&lt;</span>String<span class="token punctuation">&gt;</span></span> response <span class="token operator">=</span> restTemplate<span class="token punctuation">.</span><span class="token function">getForEntity</span><span class="token punctuation">(</span> url<span class="token punctuation">,</span> String<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            String<span class="token punctuation">[</span><span class="token punctuation">]</span> results <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">"\""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"sessionKey"</span><span class="token punctuation">,</span> results<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"openId"</span><span class="token punctuation">,</span> results<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"sessionKey"</span><span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>
            map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"openId"</span><span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> map<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <h2>
     <a id="_436">
     </a>
     三、最后的说明
    </h2>
    <h3>
     <a id="31__437">
     </a>
     3.1 用户信息的管理
    </h3>
    <p>
     我这里是把 openid 保存到了数据库。
     <br/>
     因为每个小程序的中每个用户的 openid 具有唯一性，我就把它作为判断用户是否注册的凭证
    </p>
    <h3>
     <a id="32__shiro__1112__web__440">
     </a>
     3.2 用户登录成功后，通过 shiro 交互的页面例子我就不举例了。主要是注意 1.1.1.2 第一点内容就行。只要注意到这一点，其它便于浏览器上的 web 开发无异了
    </h3>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="6874747073:3a2f2f626c6f672e6373646e2e6e65742f536e616b65686a2f:61727469636c652f64657461696c732f313135343131303932" class_="artid" style="display:none">
 </p>
</div>


