---
layout: post
title: "Linux网络编程简单基于TCP协议的服务器客户端示例"
date: 2024-12-04 22:39:16 +0800
description: "说明：  本文章旨在总结备份、方便以后查询，由于是个人总结，如有不"
keywords: "linux tcp socket客户端例子"
categories: ['嵌入式', '书籍学习笔记']
tags: ['服务器', 'Tcp', 'Linux']
artid: "121269958"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=121269958
    alt: "Linux网络编程简单基于TCP协议的服务器客户端示例"
render_with_liquid: false
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     Linux网络编程——简单基于TCP协议的服务器/客户端示例
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <p>
     <strong>
      说明
     </strong>
     ：
     <br/>
     本文章旨在总结备份、方便以后查询，由于是个人总结，如有不对，欢迎指正；另外，内容大部分来自网络、书籍、和各类手册，如若侵权请告知，马上删帖致歉。
     <br/>
     QQ 群 号：513683159 【相互学习】
     <br/>
     <strong>
      内容来源
     </strong>
     ：
     <br/>
     《Linux网络编程》
    </p>
    <h4>
     <a id="_7">
     </a>
     功能描述：
    </h4>
    <p>
     客户端连接服务器后从标准输入读取字符串发送给服务器。
     <br/>
     服务器接收到字符串后，发送接收到的总字符串个数给客户端、
     <br/>
     客户端将接受到的服务器信息打印到标准输出。
     <br/>
     整个过程流程如下：
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/04b11dc3a2c2af9433984167c8406e00.png"/>
    </p>
    <h4>
     <a id="_13">
     </a>
     源文件
    </h4>
    <h5>
     <a id="tcp_serverc_14">
     </a>
     服务器端源文件：tcp_server.c
    </h5>
    <pre><code class="prism language-c"><span class="token comment">/**
 *   Step 1 : 初始化工作
 *      1.头文件
 *      2.宏定义：侦听端口地址与侦听队列长度
 *      3.函数声明：服务器对客户端的处理函数，位于：tcp_process.c
 *      4.变量：定义并初始化
*/</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span>          </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;netinet/in.h&gt;</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PORT</span> <span class="token expression"><span class="token number">8888</span>                                    </span><span class="token comment">//侦听端口地址:8888</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BACKLOG</span> <span class="token expression"><span class="token number">2</span>                                    </span><span class="token comment">//侦听队列长度:2</span></span>

<span class="token keyword">extern</span> <span class="token keyword">void</span> <span class="token function">process_conn_server</span><span class="token punctuation">(</span><span class="token keyword">int</span> s<span class="token punctuation">)</span><span class="token punctuation">;</span>              <span class="token comment">//服务器对客户端的处理：读取数据并发送响应字符  </span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span><span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">int</span> ss <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>                                      <span class="token comment">//ss = server socket = 服务器socket描述符</span>
    <span class="token keyword">int</span> cs <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>                                      <span class="token comment">//cs = client socket = 客户端socket描述符</span>
    <span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> server_addr<span class="token punctuation">;</span>                  <span class="token comment">//服务器地址结构</span>
    <span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> client_addr<span class="token punctuation">;</span>                  <span class="token comment">//客户端地址结构</span>
    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>                                     <span class="token comment">//返回值</span>
    <span class="token class-name">pid_t</span> pid<span class="token punctuation">;</span>                                       <span class="token comment">//进程ID</span>

    <span class="token comment">/**
     *  Step 2 : 建立套接字
    */</span>
    ss <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span>SOCK_STREAM<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>              <span class="token comment">//创建一个AF_INET族的流类型socket</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>ss <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>                                       <span class="token comment">//检查是否正常创建socket</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"socket error\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">/**
     *  Step 3 : 设置服务器地址
     *  Note: 
     *      htonl()：将主机数转换成无符号长整型的网络字节顺序
     *      htons()：将整型变量从主机字节顺序转变成网络字节顺序
    */</span>
    <span class="token function">bzero</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>server_addr<span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>server_addr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token comment">//清零</span>
    server_addr<span class="token punctuation">.</span>sin_family <span class="token operator">=</span> AF_INET<span class="token punctuation">;</span>                 <span class="token comment">//设置地址族为AF_INET</span>
    server_addr<span class="token punctuation">.</span>sin_addr<span class="token punctuation">.</span>s_addr <span class="token operator">=</span> <span class="token function">htonl</span><span class="token punctuation">(</span>INADDR_ANY<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//本地地址</span>
	server_addr<span class="token punctuation">.</span>sin_port <span class="token operator">=</span> <span class="token function">htons</span><span class="token punctuation">(</span>PORT<span class="token punctuation">)</span><span class="token punctuation">;</span>               <span class="token comment">//设置端口号 </span>
	   
    <span class="token comment">/**
     *  Step 4 : 绑定地址结构到套接字描述符
    */</span>
    ret <span class="token operator">=</span> <span class="token function">bind</span><span class="token punctuation">(</span>ss<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>server_addr<span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>server_addr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>                                      <span class="token comment">//出错</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"bind error\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     *  Step 5 : 设置侦听,侦听队列长度为2,可同时处理两个客户端连接请求
    */</span>
    ret <span class="token operator">=</span> <span class="token function">listen</span><span class="token punctuation">(</span>ss<span class="token punctuation">,</span>BACKLOG<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>                                      <span class="token comment">//出错</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"bind error\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     *  Step 6 : 主循环过程
    */</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token comment">/* 接收客户端连接 */</span>
        <span class="token keyword">int</span> addrlen <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        cs <span class="token operator">=</span> <span class="token function">accept</span><span class="token punctuation">(</span>ss<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>client_addr<span class="token punctuation">,</span><span class="token operator">&amp;</span>addrlen<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>cs <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>                                    <span class="token comment">//出错</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>                                 <span class="token comment">//结束本次循环</span>
        <span class="token punctuation">}</span>

        <span class="token comment">/* 建立一个新的进程处理到来的连接 */</span>
        pid <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                                 <span class="token comment">//创建新进程</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>         <span class="token comment">/* pid &lt; 0，fork失败 */</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"fork error\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>   <span class="token comment">/* pid = 0，子进程 */</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token function">close</span><span class="token punctuation">(</span>ss<span class="token punctuation">)</span><span class="token punctuation">;</span>                                <span class="token comment">//子进程中关闭服务器的侦听</span>
            <span class="token function">process_conn_server</span><span class="token punctuation">(</span>cs<span class="token punctuation">)</span><span class="token punctuation">;</span>                  <span class="token comment">//处理连接                             </span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span>                <span class="token comment">/* pid &gt; 0，父进程 */</span>            
        <span class="token punctuation">{<!-- --></span>
            <span class="token function">close</span><span class="token punctuation">(</span>cs<span class="token punctuation">)</span><span class="token punctuation">;</span>                                <span class="token comment">//父进程中关闭客户端的连接</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <h5>
     <a id="tcp_clientc_119">
     </a>
     客户端源文件：tcp_client.c
    </h5>
    <pre><code class="prism language-c"><span class="token comment">/**
 *   Step 1 : 初始化工作
 *      1.头文件
 *      2.宏定义：侦听端口地址
 *      3.函数声明：服务器对客户端的处理函数，位于：tcp_process.c
 *      4.变量：定义并初始化
 */</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span>          </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;netinet/in.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;arpa/inet.h&gt;</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PORT</span> <span class="token expression"><span class="token number">8888</span>                                     </span><span class="token comment">//端口地址:8888</span></span>
 
<span class="token keyword">extern</span> <span class="token keyword">void</span> <span class="token function">process_conn_client</span><span class="token punctuation">(</span><span class="token keyword">int</span> s<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span><span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> s <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>                                        <span class="token comment">//socket描述符        </span>
    <span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> server_addr<span class="token punctuation">;</span>                   <span class="token comment">//服务器地址结构  </span>
    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>                                      <span class="token comment">//返回值</span>

    <span class="token comment">/**
     *  Step 2 : 建立套接字
     */</span>
    s <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span>SOCK_STREAM<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment">//创建一个AF_INET族的流类型socket</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>s <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>                                         <span class="token comment">//检查是否正常创建socket</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"socket error\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     *  Step 3 : 设置服务器地址
     */</span>
    <span class="token function">bzero</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>server_addr<span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>server_addr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token comment">//清零</span>
    server_addr<span class="token punctuation">.</span>sin_family <span class="token operator">=</span> AF_INET<span class="token punctuation">;</span>                 <span class="token comment">//设置地址族为AF_INET</span>
    server_addr<span class="token punctuation">.</span>sin_addr<span class="token punctuation">.</span>s_addr <span class="token operator">=</span> <span class="token function">htonl</span><span class="token punctuation">(</span>INADDR_ANY<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//本地地址</span>
	server_addr<span class="token punctuation">.</span>sin_port <span class="token operator">=</span> <span class="token function">htons</span><span class="token punctuation">(</span>PORT<span class="token punctuation">)</span><span class="token punctuation">;</span>               <span class="token comment">//设置端口号 </span>

    <span class="token comment">/**
     *  Step 4 : 将用户输入的字符串类型的IP地址转为整型
     */</span>
    <span class="token function">inet_pton</span><span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>server_addr<span class="token punctuation">.</span>sin_addr<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     *  Step 5 : 连接服务器
     */</span>
    <span class="token function">connect</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>server_addr<span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">process_conn_client</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>                           <span class="token comment">//客户端处理过程</span>
    <span class="token function">close</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>                                         <span class="token comment">//关闭连接</span>
<span class="token punctuation">}</span>
</code></pre>
    <h5>
     <a id="tcp_processc_180">
     </a>
     处理源文件：tcp_process.c
    </h5>
    <pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>


<span class="token comment">/*  服务器对客户端处理函数*/</span>
<span class="token keyword">void</span> <span class="token function">process_conn_server</span><span class="token punctuation">(</span><span class="token keyword">int</span> s<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token class-name">ssize_t</span> size <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">char</span> buffer<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span>                              <span class="token comment">//数据的缓冲区</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span>                                        <span class="token comment">//循环处理过程</span>
    <span class="token punctuation">{<!-- --></span>
        size <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span>buffer<span class="token punctuation">,</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                 <span class="token comment">//从套接字中读取数据放到缓冲区buffer中</span>

        <span class="token keyword">if</span><span class="token punctuation">(</span>size <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>                               <span class="token comment">//没有数据</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">/* 构建响应字符，为接收到客户端字节的数量 */</span>
        <span class="token function">sprintf</span><span class="token punctuation">(</span>buffer<span class="token punctuation">,</span><span class="token string">"%ld bytes altogether\n"</span><span class="token punctuation">,</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">write</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span>buffer<span class="token punctuation">,</span><span class="token function">strlen</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>           <span class="token comment">//发给客户端</span>
    <span class="token punctuation">}</span>
    
<span class="token punctuation">}</span>


<span class="token comment">/* 客户端的处理过程 */</span>
<span class="token keyword">void</span> <span class="token function">process_conn_client</span><span class="token punctuation">(</span><span class="token keyword">int</span> s<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token class-name">ssize_t</span> size <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">char</span> buffer<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span>                                <span class="token comment">//数据的缓冲区</span>

    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token comment">/* 从标准输入中读取数据放到缓冲区buffer中 */</span>
        size <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>buffer<span class="token punctuation">,</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>size <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>                                  <span class="token comment">//读到数据</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token function">write</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span>buffer<span class="token punctuation">,</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>                     <span class="token comment">//发送给服务器</span>
            size <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span>buffer<span class="token punctuation">,</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">;</span>               <span class="token comment">//从服务器读取数据</span>
            <span class="token function">write</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span>buffer<span class="token punctuation">,</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>                     <span class="token comment">//写到标准输出，0表示标准输入，1表示标准输出</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <h5>
     <a id="Makefile_231">
     </a>
     Makefile文件
    </h5>
    <pre><code class="prism language-bash">all:client server												<span class="token comment">#all规则，依赖于client和server规则</span>

client:tcp_process.o tcp_client.o								<span class="token comment">#client规则，生成客户端可执行程序</span>
        gcc -o client tcp_process.o tcp_client.o
server:tcp_process.o tcp_server.o								<span class="token comment">#server规则，生成服务器端可执行程序</span>
        gcc -o server tcp_process.o tcp_server.o
clean:															<span class="token comment">#清理规则，删除client、server和中间文件</span>
        <span class="token function">rm</span> -f client server *.o
</code></pre>
    <h4>
     <a id="_242">
     </a>
     编译并运行
    </h4>
    <p>
     将上面文件全部置于同一目录下。
     <br/>
     1️⃣
     <strong>
      编译
     </strong>
     ：
     <br/>
     执行命令：
     <code>
      make
     </code>
     ，结果如下：
    </p>
    <pre><code class="prism language-bash">cc    -c -o tcp_process.o tcp_process.c					<span class="token comment">#生成tcp_process.o中间文件</span>
cc    -c -o tcp_client.o tcp_client.c					<span class="token comment">#生成tcp_client.o中间文件</span>
gcc -o client tcp_process.o tcp_client.o				<span class="token comment">#由tcp_process.o与tcp_client.o生成可执行文件：client </span>
cc    -c -o tcp_server.o tcp_server.c					<span class="token comment">#生成tcp_server.o中间文件</span>
gcc -o server tcp_process.o tcp_server.o				<span class="token comment">#由tcp_process.o与tcp_server.o生成可执行文件：server </span>
</code></pre>
    <p>
     2️⃣
     <strong>
      运行
     </strong>
     ：
     <br/>
     ①打开终端，执行命令：
     <code>
      ./server
     </code>
     <br/>
     会执行服务端可执行程序server,该程序会在端口8888上侦听，等待客户端的连接请求。
     <br/>
     ②另起终端，执行命令：
     <code>
      ./client 127.0.0.1
     </code>
     <br/>
     会执行服务端可执行程序client ,该程序会连接上服务器
     <br/>
     紧接着输入字符串就会有相应，效果如下：
    </p>
    <pre><code class="prism language-bash">hhb@xsndz:/home/hhb/桌面/tcp$ ./client <span class="token number">127.0</span>.0.1
nihao
<span class="token number">6</span> bytes altogether
shiyishi
<span class="token number">9</span> bytes altogether
</code></pre>
    <h4>
     <a id="_267">
     </a>
     查询网络连接情况
    </h4>
    <p>
     在程序正常运行的状态，再另起终端，使用
     <code>
      netstat
     </code>
     命令查询网络连接情况。
     <br/>
     执行指令：
     <code>
      netstat
     </code>
     ,效果如下：
    </p>
    <pre><code class="prism language-bash">激活Internet连接 <span class="token punctuation">(</span>w/o 服务器<span class="token punctuation">)</span>
Proto Recv-Q Send-Q Local Address           Foreign Address         State      
tcp        <span class="token number">0</span>      <span class="token number">0</span> localhost:39460         localhost:8888          ESTABLISHED
tcp        <span class="token number">0</span>      <span class="token number">0</span> localhost:8888          localhost:39460         ESTABLISHED
</code></pre>
    <p>
     其中8888为服务器端的端口，39460为客户端的端口
     <br/>
     服务器和客户端段通过这两个端口建立了连接。
    </p>
    <h4>
     <a id="_280">
     </a>
     服务器端与客户端程序设计模式
    </h4>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/14687080543a74724c3fd2e73929b91d.png"/>
    </p>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f626c6f672e:6373646e2e6e65742f77656978696e5f34323634353635332f:61727469636c652f64657461696c732f313231323639393538" class_="artid" style="display:none">
 </p>
</div>


