---
layout: post
title: "TensorFlow模型保存-测试篇"
date: 2021-11-18 18:25:17 +0800
description: "TF模型保存 测试篇可参考TensorFlow之CNN图像分类及模型保存与调用和『TensorFlo"
keywords: "在测试阶段保存模型文件"
categories: ['Tensorflow']
tags: ['测试', '模型保存', '个人笔记', 'Tensorflow']
artid: "89392108"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=89392108
    alt: "TensorFlow模型保存-测试篇"
render_with_liquid: false
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     TensorFlow模型保存 测试篇
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-dracula" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <h3>
     <a id="TF__0">
     </a>
     TF模型保存 测试篇
    </h3>
    <p>
     可参考
     <a href="https://huizhou-xmu.github.io/2017/07/02/cnn_flower_classification/" rel="nofollow">
      TensorFlow之CNN图像分类及模型保存与调用
     </a>
     <br/>
     和
     <a href="https://www.cnblogs.com/hellcat/p/6925757.html#_label0_0" rel="nofollow">
      『TensorFlow』模型保存和载入方法汇总
     </a>
     和
     <a href="https://www.cnblogs.com/denny402/p/6940134.html" rel="nofollow">
      模型的保存与恢复(Saver)
     </a>
    </p>
    <h4>
     <a id="saver_4">
     </a>
     模型保存——saver
    </h4>
    <pre><code class="prism language-python">  model_path<span class="token operator">=</span><span class="token string">'E:/model/kdd/model.ckpt'</span> <span class="token comment">##绝对路径</span>
  model_path<span class="token operator">=</span><span class="token string">'scnn_model/model.ckpt'</span><span class="token comment">##相对路径</span>
  tf<span class="token punctuation">.</span>train<span class="token punctuation">.</span>Saver<span class="token punctuation">.</span>save<span class="token punctuation">(</span>sess<span class="token punctuation">,</span>model_path<span class="token punctuation">)</span>
  saver<span class="token operator">=</span>tf<span class="token punctuation">.</span>train<span class="token punctuation">.</span>Saver<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
    <h4>
     <a id="_11">
     </a>
     调用模型进行预测
    </h4>
    <p>
     可以先看模型保存了哪些文件
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/f4752e84fbae7454c508d4e55f45f299.png"/>
    </p>
    <blockquote>
     <p>
      .meta文件保存了当前图结构
     </p>
     <p>
      .data文件保存了当前参数名和值
     </p>
     <p>
      .index文件保存了辅助索引信息
     </p>
     <p>
      .data文件可以查询到参数名和参数值，使用下面的命令可以查询保存在文件中的全部变量{名：值}对，
     </p>
    </blockquote>
    <p>
     <code>
      tf.train.get_checkpoint_state( )
     </code>
     函数可以通过检查点文件锁定最新的模型
     <br/>
     <code>
      tf.train.import_meta_graph( )
     </code>
     函数给出
     <code>
      model.ckpt-n.meta
     </code>
     的路径后会加载图结构，并返回
     <code>
      saver
     </code>
     对象
     <br/>
     <code>
      saver.restore(sess, model.model_checkpoint_path)
     </code>
     用于模型的恢复
    </p>
    <pre><code class="prism language-python">ckpt <span class="token operator">=</span> tf<span class="token punctuation">.</span>train<span class="token punctuation">.</span>get_checkpoint_state<span class="token punctuation">(</span><span class="token string">'ckpt-5/'</span><span class="token punctuation">)</span> <span class="token comment"># 通过检查点文件锁定最新的模型</span>
saver <span class="token operator">=</span> tf<span class="token punctuation">.</span>train<span class="token punctuation">.</span>import_meta_graph<span class="token punctuation">(</span>ckpt<span class="token punctuation">.</span>model_checkpoint_path <span class="token operator">+</span> <span class="token string">'.meta'</span><span class="token punctuation">)</span>  <span class="token comment"># 载入图结构，保存在.meta文件中</span>
saver<span class="token punctuation">.</span>restore<span class="token punctuation">(</span>sess<span class="token punctuation">,</span> ckpt<span class="token punctuation">.</span>model_checkpoint_path<span class="token punctuation">)</span>
</code></pre>
    <p>
     <code>
      tf.train.Saver
     </code>
     函数会返回加载默认图的
     <code>
      saver
     </code>
     对象，
     <code>
      saver
     </code>
     对象初始化时可以指定变量映射方式，根据名字映射变量
     <br/>
     下面是最近一个完整的加载过程
    </p>
    <pre><code class="prism language-python"><span class="token comment"># 加载模型</span>
saver <span class="token operator">=</span> tf<span class="token punctuation">.</span>train<span class="token punctuation">.</span>Saver<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">with</span> tf<span class="token punctuation">.</span>Session<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> sess<span class="token punctuation">:</span>
        ckpt <span class="token operator">=</span> tf<span class="token punctuation">.</span>train<span class="token punctuation">.</span>get_checkpoint_state<span class="token punctuation">(</span><span class="token string">'ckpt-5/'</span><span class="token punctuation">)</span>  <span class="token comment"># 通过检查点文件锁定最新的模型</span>
        saver <span class="token operator">=</span> tf<span class="token punctuation">.</span>train<span class="token punctuation">.</span>import_meta_graph<span class="token punctuation">(</span>ckpt<span class="token punctuation">.</span>model_checkpoint_path <span class="token operator">+</span> <span class="token string">'.meta'</span><span class="token punctuation">)</span>  <span class="token comment"># 载入图结构，保存在.meta文件中</span>
        <span class="token keyword">if</span> ckpt <span class="token operator">and</span> ckpt<span class="token punctuation">.</span>model_checkpoint_path<span class="token punctuation">:</span>
            global_step <span class="token operator">=</span> ckpt<span class="token punctuation">.</span>model_checkpoint_path<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">'-'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>
            saver<span class="token punctuation">.</span>restore<span class="token punctuation">(</span>sess<span class="token punctuation">,</span> ckpt<span class="token punctuation">.</span>model_checkpoint_path<span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'CNN Model Loading Success'</span><span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'No Checkpoint'</span><span class="token punctuation">)</span>
            <span class="token comment">#ii=0</span>
        graph <span class="token operator">=</span> tf<span class="token punctuation">.</span>get_default_graph<span class="token punctuation">(</span><span class="token punctuation">)</span>
        xs <span class="token operator">=</span> graph<span class="token punctuation">.</span>get_tensor_by_name<span class="token punctuation">(</span><span class="token string">"inputs/pic_data:0"</span><span class="token punctuation">)</span>
        keep_prob <span class="token operator">=</span> graph<span class="token punctuation">.</span>get_tensor_by_name<span class="token punctuation">(</span><span class="token string">"inputs/keep_prob:0"</span><span class="token punctuation">)</span>
        logits <span class="token operator">=</span> graph<span class="token punctuation">.</span>get_tensor_by_name<span class="token punctuation">(</span><span class="token string">"prediction_eval:0"</span><span class="token punctuation">)</span>
        prediction <span class="token operator">=</span> sess<span class="token punctuation">.</span>run<span class="token punctuation">(</span>logits<span class="token punctuation">,</span> feed_dict<span class="token operator">=</span><span class="token punctuation">{<!-- --></span>xs<span class="token punctuation">:</span> feature<span class="token punctuation">,</span>keep_prob<span class="token punctuation">:</span> <span class="token number">1.0</span><span class="token punctuation">}</span><span class="token punctuation">)</span>  <span class="token comment">##?</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Prediction Matrix of Test Data Set:'</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>prediction<span class="token punctuation">)</span>
        max_index <span class="token operator">=</span> np<span class="token punctuation">.</span>argmax<span class="token punctuation">(</span>prediction<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Prediction Vector of Test Data Set:'</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>max_index<span class="token punctuation">)</span>
        m0 <span class="token operator">=</span> max_index
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Size of Test Data Set:   '</span><span class="token punctuation">,</span>m0<span class="token punctuation">.</span>shape<span class="token punctuation">)</span>

</code></pre>
    <p>
     上述过程，调用了模型中
     <code>
      graph
     </code>
     中的
     <code>
      tensor
     </code>
     ，注意大小要保持一致
    </p>
    <pre><code class="prism language-python">xs <span class="token operator">=</span> graph<span class="token punctuation">.</span>get_tensor_by_name<span class="token punctuation">(</span><span class="token string">"inputs/pic_data:0"</span><span class="token punctuation">)</span><span class="token comment">#我的命名空间input中有一个名为pic_data的tensor</span>
</code></pre>
    <p>
     如果不知道原图中有哪些
     <code>
      tensor
     </code>
     ，可以加载模型后按照下面语句去查看
    </p>
    <pre><code class="prism language-python"><span class="token comment">#获得几乎所有的operations相关的tensor</span>
ops <span class="token operator">=</span> <span class="token punctuation">[</span>o <span class="token keyword">for</span> o <span class="token keyword">in</span> sess<span class="token punctuation">.</span>graph<span class="token punctuation">.</span>get_operations<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> o <span class="token keyword">in</span> ops<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>o<span class="token punctuation">.</span>name<span class="token punctuation">)</span>
</code></pre>
    <p>
     最后奉上
    </p>
    <h5>
     <a id="_71">
     </a>
     <strong>
      模型的干货加载
     </strong>
    </h5>
    <pre><code class="prism language-python"><span class="token comment"># 连同图结构一同加载</span>
ckpt <span class="token operator">=</span> tf<span class="token punctuation">.</span>train<span class="token punctuation">.</span>get_checkpoint_state<span class="token punctuation">(</span><span class="token string">'./model/'</span><span class="token punctuation">)</span>
saver <span class="token operator">=</span> tf<span class="token punctuation">.</span>train<span class="token punctuation">.</span>import_meta_graph<span class="token punctuation">(</span>ckpt<span class="token punctuation">.</span>model_checkpoint_path <span class="token operator">+</span><span class="token string">'.meta'</span><span class="token punctuation">)</span>
<span class="token keyword">with</span> tf<span class="token punctuation">.</span>Session<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> sess<span class="token punctuation">:</span>
    saver<span class="token punctuation">.</span>restore<span class="token punctuation">(</span>sess<span class="token punctuation">,</span>ckpt<span class="token punctuation">.</span>model_checkpoint_path<span class="token punctuation">)</span>
             
<span class="token comment"># 只加载数据，不加载图结构，可以在新图中改变batch_size等的值</span>
<span class="token comment"># 不过需要注意，Saver对象实例化之前需要定义好新的图结构，否则会报错</span>
saver <span class="token operator">=</span> tf<span class="token punctuation">.</span>train<span class="token punctuation">.</span>Saver<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">with</span> tf<span class="token punctuation">.</span>Session<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> sess<span class="token punctuation">:</span>
    ckpt <span class="token operator">=</span> tf<span class="token punctuation">.</span>train<span class="token punctuation">.</span>get_checkpoint_state<span class="token punctuation">(</span><span class="token string">'./model/'</span><span class="token punctuation">)</span>
    saver<span class="token punctuation">.</span>restore<span class="token punctuation">(</span>sess<span class="token punctuation">,</span>ckpt<span class="token punctuation">.</span>model_checkpoint_path<span class="token punctuation">)</span>

</code></pre>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a:2f2f626c6f672e6373646e2e6e65742f6464706963636f6c6f:2f61727469636c652f64657461696c732f3839333932313038" class_="artid" style="display:none">
 </p>
</div>


