---
layout: post
title: "一次理清前端文件上传操作单个,多个,大文件切片"
date: 2023-04-06 20:57:18 +0800
description: "文章介绍了前端文件上传的基本流程，包括通过Blob对象处理文件，使用FormData进行二进制传输，"
keywords: "前端多文件上传"
categories: ['未分类']
tags: ['前端', 'Vue', 'Javascript']
artid: "129843945"
image:
  path: https://api.vvhan.com/api/bing?rand=sj&artid=129843945
  alt: "一次理清前端文件上传操作单个,多个,大文件切片"
render_with_liquid: false
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     一次理清前端文件上传操作（单个，多个，大文件切片）
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <p>
     相信大家在工作中也会遇到前端文件上传的需求，虽然已经在项目中使用FormData和elementUI中upload组件都实现过类似上传效果，但自己对这块一直一知半解，因此做一个笔记梳理一下前端方面的文件上传操作，以供日常参考。
    </p>
    <p>
     <strong>
      总体来说常用的两种方式：二进制传输和base64格式直接传输
     </strong>
    </p>
    <p>
     正文开始之前先简单认识一下文件上传的四个相关对象，以便后续阅读代码更直观：
    </p>
    <h3>
     <a id="1_5">
     </a>
     1、认识文件上传的四个相关对象
    </h3>
    <p>
     <img alt="文件上传的四个相关对象" src="https://i-blog.csdnimg.cn/blog_migrate/7f81b7f0d1e8fc5c97067c5419406e2e.png#pic_center"/>
    </p>
    <h4>
     <a id="1files_7">
     </a>
     1.files对象：
    </h4>
    <p>
     可以通过指定
     <code>
      input
     </code>
     标签
     <code>
      type
     </code>
     属性为
     <code>
      file
     </code>
     来读取files对象，是一个由一个或多个文件对象组成的数组。同时也是
     <code>
      blob
     </code>
     对象的子类，继承了一些
     <code>
      blob
     </code>
     对象的方法
    </p>
    <h4>
     <a id="2blob_9">
     </a>
     2.blob对象：
    </h4>
    <p>
     表示二进制类型的大对象。在数据库管理系统中，将二进制数据存储为一个单一个体的集合。Blob 通常是影像、声音或多媒体文件。在 JavaScript 中 Blob 类型的对象表示不可变的类似文件对象的原始数据， 使用构造函数创建。
    </p>
    <h4>
     <a id="3formData_12">
     </a>
     3.formData对象：
    </h4>
    <p>
     FormData就是 XMLHttpRequest Level 2 新增的一个对象，利用它来提交表单、模拟表单提交，最大的优势就是可以上传二进制文件。
    </p>
    <pre><code>作用1：模拟HTML表单，相当于将HTML表单映射成表单对象，自动将表单对象中的数据拼接成请求参数的格式。
作用2：异步上传二进制文件。
</code></pre>
    <h4>
     <a id="4fileReader_18">
     </a>
     4.fileReader对象
    </h4>
    <p>
     构造函数方式实例化一个fileReader对象，readAs()方法将文件对象读取成base64格式或者文本格式
    </p>
    <h3>
     <a id="2blob_21">
     </a>
     2、二进制blob对象传输
    </h3>
    <p>
     <strong>
      上传时将文件转为blob对象，通过FormData对象搭载传递
     </strong>
    </p>
    <p>
     使用vue-cli搭建了一个基础框架，代码如下
    </p>
    <h4>
     <a id="21_26">
     </a>
     2.1文件上传前的判断操作
    </h4>
    <pre><code class="prism language-js&lt;template&gt;">  &lt;div&gt;
    &lt;p&gt;file组件&lt;/p&gt;
    &lt;input type="file" @change="fileChange" multiple&gt;
    &lt;button @click="submit"&gt;提交&lt;/button&gt;
  &lt;/div&gt;
 
&lt;/template&gt;

&lt;script&gt;
export default {
data(){
return{
fileList:[],
imgsrc:'',
precent:0
}
},
methods:{
//files 对象的第一个应用：文件上传之前的大小和类型判断
fileChange(e){
console.log(e.target.files);//一个由不同文件对象组成的对象
let files = e.target.files;

      //文件大小判断和文件类型判断 //假设不能大于10M
      if(files[0].size &gt; 10*1024*1024){
        alert('文件不能大于10M')
      }else if(files[0].type != "application/pdf"){
        alert("文件类型必须是pdf格式")
      }

    },
    async submit(){

    }

}
};
&lt;/script&gt;

&lt;!-- Add "scoped" attribute to limit CSS to this component only --&gt;
&lt;style scoped&gt;
&lt;/style&gt;

</code></pre>
<p>
console.log(e.target.files)打印结构如下：
<br/>
<img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/631a5a21a92ca15316050948703a2eba.png#pic_center">
<br/>
由此可见其是一个由多个文件对象组成的对象，每个文件对象内部又有多个属性，比较常用 size 和 type 属性做文件上传之前的大小和类型判断。
</img>
</p>
<h4>
<a id="22filesblob__78">
</a>
2.2files 与 blob 转换 缩略图和文本预览
</h4>
<p>
<code>
files
</code>
对象与
<code>
blob
</code>
对象的相互转换和
<code>
blob
</code>
对象的切割方法 :项目中实现缩略图和文本预览
</p>
<pre><code class="prism language-jsvascirpt">
methods:{
fileChange(e){
let files = e.target.files[0];

      let _newBlob = new Blob([files]);//将files对象转为blob对象,第一个参数必须是数组
      console.log(_newBlob);

      //slice()方法 ： 切割blob对象,从XX位到XX位
      let _sliceBlob = _newBlob.slice(0,5000);
      console.log(_sliceBlob);

      //将切割后的blob对象转为files对象
      let _sliceFile = new File([_sliceBlob],'test.jpg')
      console.log(_sliceFile);

      //fileReader对象 将文件异步方式转为base64格式或文本格式
      // fr.readAsDataURL()  转换为base64格式
      // fr.readAsText()     转换为文本格式

      let fr = new FileReader();//实例化FileReader对象

      fr.readAsDataURL(_sliceFile)
      // fr.readAsDataURL(files)

      //FileReader对象的readAs方法是异步的，只能通过onload事件监听获取转换的结果
      fr.onload = ()=&gt;{
        console.log(fr.result);
        //实现文件上传前的缩略图预览
        this.imgbase64 = fr.result;
      }

    },

};
&lt;/script&gt;

    },

</code></pre>
<p>
控制台输出如下:
<br/>
四次输出顺序分别为切割前的
<code>
blob
</code>
对象、切割后的
<code>
blob
</code>
对象、转换的 files 文件对象、读取成 base64 格式的文件对象
<br/>
可以看到切割前的
<code>
blob
</code>
对象与切割后的
<code>
blob
</code>
对象的大小区别，以及文件读取成 base64 格式后明显不完整
<br/>
<img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/1f89660beba8d30fbcb0237b8b81e7ec.png#pic_center"/>
</p>
<h4>
<a id="23_125">
</a>
2.3 单文件上传
</h4>
<pre><code class="prism language-jsvascript">&lt;template&gt;
&lt;div&gt;
&lt;p&gt;file 组件&lt;/p&gt;
&lt;input type="file" @change="fileChange" multiple&gt;
&lt;button @click="submit"&gt;提交&lt;/button&gt;
&lt;img style="width: 50px;" :src=imgbase64 &gt;
&lt;/div&gt;

&lt;/template&gt;

&lt;script&gt;

let \_fileObj;//定义操作 formdata 对象实现单文件上传的空变量
export default {
data(){
return{
imgbase64:'',
}
},
methods:{
fileChange(e){
let files = e.target.files[0];
\_fileObj = files;

      let _newBlob = new Blob([files]);//将files对象转为blob对象,第一个参数必须是数组

      //fileReader对象 将文件异步方式转为base64格式或文本格式
      let fr = new FileReader();
      fr.readAsDataURL(_newBlob);

      //通过onload事件监听获取转换的结果,箭头函数赋值给onload，不改变this指向,直接操作data函数中定义的数据
      //文件缩略图操作
      fr.onload = ()=&gt;{
        this.imgbase64 = fr.result
      }

    },
    async submit(){
      let _formdata = new FormData();

      //append() 将上传者信息或者文件添加到_formdata
      _formdata.append('user','syb');
      _formdata.append('file',_fileObj);

    //模拟axios上传请求
      let data = await axios.post('//url',_formdata);
    }

}
};
&lt;/script&gt;

&lt;style scoped&gt;
&lt;/style&gt;

</code></pre>
<h4>
<a id="24_183">
</a>
2.4 多文件上传
</h4>
<p>
将多个文件放到一个数组内，然后循环上传这个数组内的文件对象
</p>
<pre><code>如果使用 input 元素的 multiple 属性规定可以选择多个文件上传,从用户层面来说并不合适。(因为选择文件的时候要按 Ctrl 键) 建议使用 js 拼接 input 元素获取到的文件对象
</code></pre>
<pre><code class="prism language-javascript"><span class="token operator">&lt;</span>template<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>div<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>p<span class="token operator">&gt;</span>manyFile 组件<span class="token operator">&lt;</span><span class="token operator">/</span>p<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>input type<span class="token operator">=</span><span class="token string">"file"</span> @change<span class="token operator">=</span><span class="token string">"fileChange"</span> multiple <span class="token operator">/</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>button @click<span class="token operator">=</span><span class="token string">"submit"</span><span class="token operator">&gt;</span>多选提交<span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>img style<span class="token operator">=</span><span class="token string">"width: 50px"</span> <span class="token operator">:</span>src<span class="token operator">=</span><span class="token string">"imgbase64"</span> <span class="token operator">/</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>span v<span class="token operator">-</span><span class="token keyword">for</span><span class="token operator">=</span><span class="token string">"item in fileList"</span> <span class="token operator">:</span>key<span class="token operator">=</span><span class="token string">"item.name"</span><span class="token operator">&gt;</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> item<span class="token punctuation">.</span>name <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>span<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> 使用一个 span 标签预览要上传的文件名 <span class="token operator">--</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>template<span class="token operator">&gt;</span>

<span class="token operator">&lt;</span>script<span class="token operator">&gt;</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{<!-- --></span>
<span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token keyword">return</span> <span class="token punctuation">{<!-- --></span>
<span class="token literal-property property">fileList</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token comment">//定义空数组存储多个文件</span>
<span class="token literal-property property">imgbase64</span><span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token literal-property property">methods</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
<span class="token function">fileChange</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token comment">//e.target.files;//一个由不同文件对象组成的对象</span>

      <span class="token comment">//检测e.target.files是否有多个文件</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>target<span class="token punctuation">.</span>files<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>target<span class="token punctuation">.</span>files<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>fileList <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token operator">...</span>e<span class="token punctuation">.</span>target<span class="token punctuation">.</span>files<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token comment">//this.fileList = this.fileList.concat(e.target.files);</span>
      <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>fileList<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>target<span class="token punctuation">.</span>files<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>

    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token keyword">async</span> <span class="token function">submit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    	<span class="token comment">//循环fileList,每次都创建一个formdata对象上传 </span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>fileList<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span> <span class="token keyword">async</span> <span class="token parameter">item</span><span class="token operator">=&gt;</span><span class="token punctuation">{<!-- --></span>
            <span class="token keyword">let</span> _formdata <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FormData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            _formdata<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span>name<span class="token punctuation">,</span> item<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//模拟axios上传请求</span>
      		<span class="token keyword">let</span> data <span class="token operator">=</span> <span class="token keyword">await</span> axios<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'//url'</span><span class="token punctuation">,</span>_formdata<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>


    <span class="token punctuation">}</span><span class="token punctuation">,</span>

<span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>

<span class="token operator">&lt;</span>style scoped<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>style<span class="token operator">&gt;</span>
</code></pre>
<h4>
<a id="25_242">
</a>
2.5 切片上传
</h4>
<pre><code class="prism language-javascript"><span class="token operator">&lt;</span>template<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>div<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>p<span class="token operator">&gt;</span>sliceFile 组件<span class="token operator">&lt;</span><span class="token operator">/</span>p<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>input type<span class="token operator">=</span><span class="token string">"file"</span> @change<span class="token operator">=</span><span class="token string">"fileChange"</span><span class="token operator">/</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>button @click<span class="token operator">=</span><span class="token string">"submit"</span><span class="token operator">&gt;</span>切片提交<span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>div<span class="token operator">&gt;</span>
上传进度：<span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> precent <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">%</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>template<span class="token operator">&gt;</span>

<span class="token operator">&lt;</span>script<span class="token operator">&gt;</span>
<span class="token keyword">import</span> <span class="token punctuation">{<!-- --></span> test <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"../request/api"</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> \_fileObj<span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{<!-- --></span>
<span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token keyword">return</span> <span class="token punctuation">{<!-- --></span>
<span class="token literal-property property">precent</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span><span class="token comment">//上传进度百分比</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token literal-property property">methods</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
<span class="token function">fileChange</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
\_fileObj <span class="token operator">=</span> e<span class="token punctuation">.</span>target<span class="token punctuation">.</span>files<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>

      <span class="token keyword">async</span> <span class="token function">submit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

        <span class="token keyword">let</span> size <span class="token operator">=</span> <span class="token number">2</span><span class="token operator">*</span><span class="token number">1024</span><span class="token operator">*</span><span class="token number">1024</span><span class="token punctuation">;</span> <span class="token comment">//定义一次切片为2M</span>
        <span class="token keyword">let</span> fileSize <span class="token operator">=</span> _fileObj<span class="token punctuation">.</span>size<span class="token punctuation">;</span>
        <span class="token keyword">let</span> current <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//定义当前已经上传的文件部分大小</span>

        <span class="token comment">//判断如果已经上传的部分小于文件总大小</span>
        <span class="token keyword">while</span><span class="token punctuation">(</span>current <span class="token operator">&lt;</span> fileSize<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
          <span class="token keyword">let</span> _formData  <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FormData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    	  <span class="token comment">//一次添加2M大小的切片  注意添加时的说明一般为文件名，后端接收后按照文件名标识拼接</span>
          _formData<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>_fileObj<span class="token punctuation">.</span>name<span class="token punctuation">,</span>_fileObj<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span>current<span class="token operator">+</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span>
          <span class="token keyword">let</span> data <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">test</span><span class="token punctuation">(</span>_formData<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token comment">//计算当前上传进度，展示到页面</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>precent <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">ceil</span><span class="token punctuation">(</span><span class="token punctuation">(</span>current<span class="token operator">/</span>fileSize<span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">100</span><span class="token punctuation">)</span>
          current <span class="token operator">+=</span> size<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>

<span class="token operator">&lt;</span>style scoped<span class="token operator">&gt;</span>

<span class="token operator">&lt;</span><span class="token operator">/</span>style<span class="token operator">&gt;</span>
</code></pre>
<h3>
<a id="3base64_296">
</a>
3、base64 格式传输
</h3>
<p>
<strong>
base64 格式可以直接传给后端，后端接收后解码进行相应操作后返回
</strong>
</p>

   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f626c:6f672e6373646e2e6e65742f4d6f6f6e6c69676874626f692f:61727469636c652f64657461696c732f313239383433393435" class_="artid" style="display:none">
 </p>
</div>
