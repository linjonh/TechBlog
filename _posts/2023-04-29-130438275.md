---
layout: post
title: "51单片机-自写操作系统"
date: 2023-04-29 09:37:39 +0800
description: "文章展示了在51单片机上实现操作系统最简模型的过程，从任务建立与切"
keywords: "51单片机操作系统"
categories: ['51单片机外设驱动']
tags: ['单片机']
artid: "130438275"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=130438275
    alt: "51单片机-自写操作系统"
render_with_liquid: false
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     51单片机 - 自写操作系统
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-tomorrow-night" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <p>
    </p>
    <div class="toc">
     <h4>
      最简OS
     </h4>
     <ul>
      <li>
       <a href="#1_1_12" rel="nofollow">
        1&gt; 版本1：任务建立与切换
       </a>
      </li>
      <li>
       <a href="#2_2_141" rel="nofollow">
        2&gt; 版本2：定时器切换
       </a>
      </li>
      <li>
       <ul>
        <li>
         <a href="#21_mainc_146" rel="nofollow">
          2.1&gt; main.c
         </a>
        </li>
        <li>
         <a href="#22_taskc_187" rel="nofollow">
          2.2&gt; task.c
         </a>
        </li>
        <li>
         <a href="#23_sleepc_309" rel="nofollow">
          2.3&gt; sleep.c
         </a>
        </li>
       </ul>
      </li>
      <li>
       <a href="#3_3_403" rel="nofollow">
        3&gt; 版本3：加时间片轮转
       </a>
      </li>
     </ul>
    </div>
    <p>
    </p>
    <blockquote>
     <p>
      在51单片机上，实现操作系统最简模型， 学习理解操作系统的基本概念；
     </p>
    </blockquote>
    <p>
     <a href="https://www.bilibili.com/video/BV1ym4y1y7Jm/?spm_id_from=333.999.list.card_archive.click&amp;vd_source=c3471ffcf292e2d0642995f2056a2b8c" rel="nofollow">
      🔗 //----------- 参考视频链接 （15集） -----------//
     </a>
    </p>
    <h2>
     <a id="1_1_12">
     </a>
     1&gt; 版本1：任务建立与切换
    </h2>
    <pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;STC89C5xRC.H&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;intrins.h&gt;</span></span>


sbit LED_0	 <span class="token operator">=</span> P0<span class="token operator">^</span><span class="token number">0</span><span class="token punctuation">;</span>
sbit LED_1	 <span class="token operator">=</span> P0<span class="token operator">^</span><span class="token number">1</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MAX_TASKS</span>		<span class="token expression"><span class="token number">2</span>		</span><span class="token comment">// 任务个数：task0，task1；		</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MAX_TASK_DEP</span>	<span class="token expression"><span class="token number">32</span>		</span><span class="token comment">// 任务最大栈深度：任务切换时保存现场；</span></span>

<span class="token keyword">unsigned</span> <span class="token keyword">char</span> idata task_sp<span class="token punctuation">[</span>MAX_TASKS<span class="token punctuation">]</span><span class="token punctuation">;</span>		<span class="token comment">// 任务堆栈指针数组；</span>
<span class="token keyword">unsigned</span> <span class="token keyword">char</span> idata task_stack<span class="token punctuation">[</span>MAX_TASKS<span class="token punctuation">]</span><span class="token punctuation">[</span>MAX_TASK_DEP<span class="token punctuation">]</span><span class="token punctuation">;</span>	<span class="token comment">// 任务堆栈， 2个任务，每个任务分配32Byte空间；</span>

<span class="token keyword">unsigned</span> <span class="token keyword">char</span> task_id<span class="token punctuation">;</span>


<span class="token comment">/*-- CPU Delay --*/</span>
<span class="token keyword">void</span> <span class="token function">Delay1000ms</span><span class="token punctuation">(</span><span class="token punctuation">)</span>		<span class="token comment">//@22.1184MHz</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">unsigned</span> <span class="token keyword">char</span> i<span class="token punctuation">,</span> j<span class="token punctuation">,</span> k<span class="token punctuation">;</span>

	<span class="token function">_nop_</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	i <span class="token operator">=</span> <span class="token number">15</span><span class="token punctuation">;</span>
	j <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
	k <span class="token operator">=</span> <span class="token number">235</span><span class="token punctuation">;</span>
	<span class="token keyword">do</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token keyword">do</span>
		<span class="token punctuation">{<!-- --></span>
			<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">--</span>k<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">--</span>j<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">--</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>




<span class="token comment">/**
  * @brief  任何切换函数（任务调度）
  * @param  None
  * @retval None
  */</span>
<span class="token keyword">void</span> <span class="token function">task_switch</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	task_sp<span class="token punctuation">[</span>task_id<span class="token punctuation">]</span> <span class="token operator">=</span> SP<span class="token punctuation">;</span>	<span class="token comment">// 保存当前的SP；</span>

	task_id <span class="token operator">=</span> task_id <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>task_id <span class="token operator">==</span> MAX_TASKS<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		task_id <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	SP <span class="token operator">=</span> task_sp<span class="token punctuation">[</span>task_id<span class="token punctuation">]</span><span class="token punctuation">;</span>	<span class="token comment">// 把下一个task的sp放入到当前的SP</span>
<span class="token punctuation">}</span>


<span class="token comment">/**
  * @brief  任务0；
  * @param  None
  * @retval None
  */</span>
<span class="token keyword">void</span> <span class="token function">task0</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	
	LED_0 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		LED_0 <span class="token operator">=</span> <span class="token operator">~</span>LED_0<span class="token punctuation">;</span>

		<span class="token function">Delay1000ms</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token function">task_switch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">// 任务切换 </span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
  * @brief  任务1；
  * @param  None
  * @retval None
  */</span>
<span class="token keyword">void</span> <span class="token function">task1</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	
	LED_1 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		LED_1 <span class="token operator">=</span> <span class="token operator">~</span>LED_1<span class="token punctuation">;</span>
		<span class="token function">Delay1000ms</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">task_switch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">// 任务切换 </span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>


<span class="token comment">// 函数的地址（指针）占16bit；</span>
<span class="token comment">// fn:存放函数的地址；</span>
<span class="token comment">// tid：task id，0或1；</span>

<span class="token keyword">void</span> <span class="token function">task_load</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> fn<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> tid<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token comment">// 51单片机中，堆栈向上增长；</span>
	task_sp<span class="token punctuation">[</span>tid<span class="token punctuation">]</span> <span class="token operator">=</span> task_stack<span class="token punctuation">[</span>tid<span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>	 <span class="token comment">// 将任务堆栈指针设置为下一个空闲位置，预留2个Byte用来存放task的函数地址；</span>

	<span class="token comment">// 存放task0或task1函数的首地址</span>
	task_stack<span class="token punctuation">[</span>tid<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> fn <span class="token operator">&amp;</span> <span class="token number">0xff</span><span class="token punctuation">;</span>
	task_stack<span class="token punctuation">[</span>tid<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> fn <span class="token operator">&gt;&gt;</span> <span class="token number">8</span><span class="token punctuation">;</span>  
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token function">task_load</span><span class="token punctuation">(</span>task0<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">task_load</span><span class="token punctuation">(</span>task1<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	task_id <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>		<span class="token comment">// 把当前任务设置为task0；</span>
	SP <span class="token operator">=</span> task_sp<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>	<span class="token comment">// 执行task0； </span>
<span class="token punctuation">}</span>
<span class="token comment">//----------------------------------- End ---------------------------//</span>
</code></pre>
    <p>
     内存分配：
     <br/>
     <img alt="1" src="https://i-blog.csdnimg.cn/blog_migrate/a816acb3a31af38a07a7e5665baced10.png"/>
    </p>
    <p>
     实验结果：LED0波形
     <br/>
     <img alt="1" src="https://i-blog.csdnimg.cn/blog_migrate/835dce044afcd1ba7478d2d723358fdd.png#pic_center"/>
    </p>
    <blockquote>
     <p>
      问题：为什么LED0和LED1会亮2s，灭2s呢，如何改为想要亮1s，灭1s
     </p>
    </blockquote>
    <blockquote>
     <p>
      void Delay1000ms()： 是CPU在，不干其他活，傻延时，所以LED0在等的同时LED1也在等；
     </p>
    </blockquote>
    <hr/>
    <h2>
     <a id="2_2_141">
     </a>
     2&gt; 版本2：定时器切换
    </h2>
    <blockquote>
     <p>
      使用51内部，定时器0硬件资源来定时，让CPU释放；
     </p>
    </blockquote>
    <hr/>
    <h3>
     <a id="21_mainc_146">
     </a>
     2.1&gt; main.c
    </h3>
    <pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"main.h"</span></span>

<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token function">Timer0_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">task_load</span><span class="token punctuation">(</span>task0<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">task_load</span><span class="token punctuation">(</span>task1<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	task_id <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>		<span class="token comment">// 把当前任务设置为task0；</span>
	SP <span class="token operator">=</span> task_sp<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>	<span class="token comment">// 执行task0； </span>
<span class="token punctuation">}</span>
</code></pre>
    <hr/>
    <p>
     main.h
    </p>
    <pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">__MAIN_H__</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">__MAIN_H__</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;STC89C5xRC.H&gt;</span></span>

sbit LED_0	<span class="token operator">=</span> P0<span class="token operator">^</span><span class="token number">0</span><span class="token punctuation">;</span>
sbit LED_1	<span class="token operator">=</span> P0<span class="token operator">^</span><span class="token number">1</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MAX_TASKS</span>		<span class="token expression"><span class="token number">2</span>		</span><span class="token comment">// 任务个数：task0，task1；		</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MAX_TASK_DEP</span>	<span class="token expression"><span class="token number">32</span>		</span><span class="token comment">// 任务最大栈深度：任务切换时保存现场；</span></span>


<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"sleep.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"task.h"</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>


</code></pre>
    <hr/>
    <h3>
     <a id="22_taskc_187">
     </a>
     2.2&gt; task.c
    </h3>
    <pre><code class="prism language-c">
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"task.h"</span></span>

<span class="token keyword">unsigned</span> <span class="token keyword">char</span> idata task_sp<span class="token punctuation">[</span>MAX_TASKS<span class="token punctuation">]</span><span class="token punctuation">;</span>		<span class="token comment">// 任务堆栈指针数组；</span>
<span class="token keyword">unsigned</span> <span class="token keyword">char</span> idata task_stack<span class="token punctuation">[</span>MAX_TASKS<span class="token punctuation">]</span><span class="token punctuation">[</span>MAX_TASK_DEP<span class="token punctuation">]</span><span class="token punctuation">;</span>	<span class="token comment">// 任务堆栈， 2个任务，每个任务分配32Byte空间；</span>

<span class="token keyword">unsigned</span> <span class="token keyword">char</span> task_id<span class="token punctuation">;</span>


<span class="token comment">/**
  * @brief  任何切换函数（任务调度）
  * @param  None
  * @retval None
  */</span>
<span class="token keyword">void</span> <span class="token function">task_switch</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	task_sp<span class="token punctuation">[</span>task_id<span class="token punctuation">]</span> <span class="token operator">=</span> SP<span class="token punctuation">;</span>	<span class="token comment">// 保存当前的SP；</span>

	task_id <span class="token operator">=</span> task_id <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>task_id <span class="token operator">==</span> MAX_TASKS<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		task_id <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	SP <span class="token operator">=</span> task_sp<span class="token punctuation">[</span>task_id<span class="token punctuation">]</span><span class="token punctuation">;</span>	<span class="token comment">// 把下一个task的sp放入到当前的SP</span>
<span class="token punctuation">}</span>


<span class="token comment">/**
  * @brief  任务0；
  * @param  None
  * @retval None
  */</span>
<span class="token keyword">void</span> <span class="token function">task0</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	
	LED_0 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		
		<span class="token keyword">if</span> <span class="token punctuation">(</span>tasks<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>status <span class="token operator">==</span> TASK_SUSPENDED<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token function">task_switch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">continue</span><span class="token punctuation">;</span>	<span class="token comment">// 如果任务处于sleep挂起状态，直接跳出		</span>
		<span class="token punctuation">}</span>


		LED_0 <span class="token operator">=</span> <span class="token operator">~</span>LED_0<span class="token punctuation">;</span>

		<span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 任务0，睡眠1s；没有任何阻塞；</span>

		<span class="token function">task_switch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">// 任务切换 </span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
  * @brief  任务1；
  * @param  None
  * @retval None
  */</span>
<span class="token keyword">void</span> <span class="token function">task1</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	
	LED_1 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

		<span class="token keyword">if</span> <span class="token punctuation">(</span>tasks<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>status <span class="token operator">==</span> TASK_SUSPENDED<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token function">task_switch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">continue</span><span class="token punctuation">;</span>	<span class="token comment">// 如果任务处于sleep挂起状态，直接跳出		</span>
		<span class="token punctuation">}</span>

		LED_1 <span class="token operator">=</span> <span class="token operator">~</span>LED_1<span class="token punctuation">;</span>
		<span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">task_switch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">// 任务切换 </span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>


<span class="token comment">// 函数的地址（指针）占16bit；</span>
<span class="token comment">// fn:存放函数的地址；</span>
<span class="token comment">// tid：task id，0或1；</span>

<span class="token keyword">void</span> <span class="token function">task_load</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> fn<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> tid<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token comment">// 51单片机中，堆栈向上增长；</span>
	task_sp<span class="token punctuation">[</span>tid<span class="token punctuation">]</span> <span class="token operator">=</span> task_stack<span class="token punctuation">[</span>tid<span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>	 <span class="token comment">// 将任务堆栈指针设置为下一个空闲位置，预留2个Byte用来存放task的函数地址；</span>

	<span class="token comment">// 存放task0或task1函数的首地址</span>
	task_stack<span class="token punctuation">[</span>tid<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> fn <span class="token operator">&amp;</span> <span class="token number">0xff</span><span class="token punctuation">;</span>
	task_stack<span class="token punctuation">[</span>tid<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> fn <span class="token operator">&gt;&gt;</span> <span class="token number">8</span><span class="token punctuation">;</span>  
<span class="token punctuation">}</span>

</code></pre>
    <p>
     task.h
    </p>
    <pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">__TASK_H__</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">__TASK_H__</span></span>


<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"main.h"</span></span>



<span class="token keyword">extern</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> idata task_sp<span class="token punctuation">[</span>MAX_TASKS<span class="token punctuation">]</span><span class="token punctuation">;</span>		<span class="token comment">// 任务堆栈指针数组；</span>
<span class="token keyword">extern</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> idata task_stack<span class="token punctuation">[</span>MAX_TASKS<span class="token punctuation">]</span><span class="token punctuation">[</span>MAX_TASK_DEP<span class="token punctuation">]</span><span class="token punctuation">;</span>	<span class="token comment">// 任务堆栈， 2个任务，每个任务分配32Byte空间；</span>

<span class="token keyword">extern</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> task_id<span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">task0</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">task1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">task_load</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> fn<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> tid<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">task_switch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
</code></pre>
    <hr/>
    <h3>
     <a id="23_sleepc_309">
     </a>
     2.3&gt; sleep.c
    </h3>
    <pre><code class="prism language-c">
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"sleep.h"</span> </span>

Task idata tasks<span class="token punctuation">[</span>MAX_TASKS<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
	<span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">,</span> TASK_RUNNING<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">,</span>	<span class="token comment">// 任务0，默认运行状态，不延时，当前延时时间0；</span>
	<span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">,</span> TASK_RUNNING<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">,</span>	<span class="token comment">// 任务1，默认运行状态，不延时，当前延时时间0；</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> task_id<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> delay_ms<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>	
	tasks<span class="token punctuation">[</span>task_id<span class="token punctuation">]</span><span class="token punctuation">.</span>status <span class="token operator">=</span> TASK_SUSPENDED<span class="token punctuation">;</span>
	tasks<span class="token punctuation">[</span>task_id<span class="token punctuation">]</span><span class="token punctuation">.</span>delay_count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	tasks<span class="token punctuation">[</span>task_id<span class="token punctuation">]</span><span class="token punctuation">.</span>delay_duration <span class="token operator">=</span> delay_ms<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">//1毫秒@22.1184MHz</span>
<span class="token keyword">void</span> <span class="token function">Timer0_Init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>	
<span class="token punctuation">{<!-- --></span>
	TMOD <span class="token operator">&amp;=</span> <span class="token number">0xF0</span><span class="token punctuation">;</span>	<span class="token comment">//设置定时器模式</span>
	TMOD <span class="token operator">|=</span> <span class="token number">0x01</span><span class="token punctuation">;</span>	<span class="token comment">//设置定时器模式</span>
	TL0 <span class="token operator">=</span> <span class="token number">0xCD</span><span class="token punctuation">;</span>		<span class="token comment">//设置定时初始值</span>
	TH0 <span class="token operator">=</span> <span class="token number">0xF8</span><span class="token punctuation">;</span>		<span class="token comment">//设置定时初始值</span>
	TF0 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>		<span class="token comment">//清除TF0标志</span>

	ET0 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
	EA <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
	TR0 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>		<span class="token comment">//定时器0开始计时</span>
<span class="token punctuation">}</span>


<span class="token comment">/*--- 定位器0中断服务函数, 1ms中断1次 ---*/</span>
<span class="token keyword">void</span> <span class="token function">Timer0_ISR</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> interrupt <span class="token number">1</span>  
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">unsigned</span> <span class="token keyword">char</span> i<span class="token punctuation">;</span>

	TL0 <span class="token operator">=</span> <span class="token number">0xCD</span><span class="token punctuation">;</span>		<span class="token comment">//设置定时初始值</span>
	TH0 <span class="token operator">=</span> <span class="token number">0xF8</span><span class="token punctuation">;</span>		<span class="token comment">//设置定时初始值</span>

	<span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> MAX_TASKS<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>tasks<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>status <span class="token operator">==</span> TASK_SUSPENDED<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			tasks<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>delay_count<span class="token operator">++</span><span class="token punctuation">;</span>

			<span class="token keyword">if</span> <span class="token punctuation">(</span>tasks<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>delay_count <span class="token operator">&gt;=</span> tasks<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>delay_duration<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				tasks<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>status <span class="token operator">=</span> TASK_RUNNING<span class="token punctuation">;</span>
				tasks<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>delay_count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>

<span class="token punctuation">}</span>

</code></pre>
    <hr/>
    <p>
     sleep.h
    </p>
    <pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">__SLEEP_H__</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">__SLEEP_H__</span></span>


<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"main.h"</span></span>



<span class="token keyword">typedef</span> <span class="token keyword">enum</span> <span class="token punctuation">{<!-- --></span>
	TASK_RUNNING<span class="token punctuation">,</span>
	TASK_SUSPENDED
<span class="token punctuation">}</span> TaskStatus<span class="token punctuation">;</span>


<span class="token comment">/*--- 定义任务结构体 ---*/</span>
<span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">unsigned</span> <span class="token keyword">char</span> id<span class="token punctuation">;</span> 				<span class="token comment">// 任务id</span>
	TaskStatus status<span class="token punctuation">;</span>				<span class="token comment">// 任务状态</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">int</span> delay_count<span class="token punctuation">;</span>		<span class="token comment">// 延时计数器</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">int</span> delay_duration<span class="token punctuation">;</span>	<span class="token comment">// 延时时间</span>
<span class="token punctuation">}</span> Task<span class="token punctuation">;</span>

<span class="token keyword">extern</span> Task idata tasks<span class="token punctuation">[</span>MAX_TASKS<span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">Timer0_Init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> task_id<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> delay_ms<span class="token punctuation">)</span><span class="token punctuation">;</span>


<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
</code></pre>
    <hr/>
    <h2>
     <a id="3_3_403">
     </a>
     3&gt; 版本3：加时间片轮转
    </h2>
    <blockquote>
     <p>
      版本2中如果其中一个任务，不主动task_switch()切换任务，怎么办？
      <br/>
      再用一个硬件资源Timer1，200us中断一次，并强制切换；
     </p>
    </blockquote>
    <p>
     sleep.c 增加：
    </p>
    <pre><code class="prism language-c">
<span class="token keyword">void</span> <span class="token function">Timer1_Init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>		<span class="token comment">//200微秒@22.1184MHz</span>
<span class="token punctuation">{<!-- --></span>
	TMOD <span class="token operator">&amp;=</span> <span class="token number">0x0F</span><span class="token punctuation">;</span>			<span class="token comment">//设置定时器模式</span>
	TMOD <span class="token operator">|=</span> <span class="token number">0x10</span><span class="token punctuation">;</span>			<span class="token comment">//设置定时器模式</span>
	TL1 <span class="token operator">=</span> <span class="token number">0xB8</span><span class="token punctuation">;</span>				<span class="token comment">//设置定时初始值</span>
	TH1 <span class="token operator">=</span> <span class="token number">0xEE</span><span class="token punctuation">;</span>				<span class="token comment">//设置定时初始值</span>
	TF1 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>				<span class="token comment">//清除TF1标志</span>
	
	ET1 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
	EA <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
	TR1 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>				<span class="token comment">//定时器1开始计时</span>
<span class="token punctuation">}</span>




<span class="token keyword">void</span> <span class="token function">Timer1_ISR</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> interrupt <span class="token number">3</span>  
<span class="token punctuation">{<!-- --></span>
	TL1 <span class="token operator">=</span> <span class="token number">0xB8</span><span class="token punctuation">;</span>				<span class="token comment">//设置定时初始值</span>
	TH1 <span class="token operator">=</span> <span class="token number">0xEE</span><span class="token punctuation">;</span>				<span class="token comment">//设置定时初始值</span>
	
	<span class="token function">task_switch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     代码没实现：
    </p>
    <blockquote>
     <p>
      任务的优先级；
      <br/>
      任务之间没有信号量，消息机制；
      <br/>
      文件管理；
      <br/>
      内存管理；
     </p>
    </blockquote>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f62:6c6f672e6373646e2e6e65742f58305f496d50655269616c2f:61727469636c652f64657461696c732f313330343338323735" class_="artid" style="display:none">
 </p>
</div>


