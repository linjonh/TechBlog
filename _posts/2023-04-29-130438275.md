---
layout: post
title: "51å•ç‰‡æœº-è‡ªå†™æ“ä½œç³»ç»Ÿ"
date: 2023-04-29 09:37:39 +0800
description: "æ–‡ç« å±•ç¤ºäº†åœ¨51å•ç‰‡æœºä¸Šå®ç°æ“ä½œç³»ç»Ÿæœ€ç®€æ¨¡å‹çš„è¿‡ç¨‹ï¼Œä»ä»»åŠ¡å»ºç«‹ä¸åˆ‡"
keywords: "51å•ç‰‡æœºæ“ä½œç³»ç»Ÿ"
categories: ['51å•ç‰‡æœºå¤–è®¾é©±åŠ¨']
tags: ['å•ç‰‡æœº']
artid: "130438275"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=130438275
    alt: "51å•ç‰‡æœº-è‡ªå†™æ“ä½œç³»ç»Ÿ"
render_with_liquid: false
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     51å•ç‰‡æœº - è‡ªå†™æ“ä½œç³»ç»Ÿ
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-tomorrow-night" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <p>
    </p>
    <div class="toc">
     <h4>
      æœ€ç®€OS
     </h4>
     <ul>
      <li>
       <a href="#1_1_12" rel="nofollow">
        1&gt; ç‰ˆæœ¬1ï¼šä»»åŠ¡å»ºç«‹ä¸åˆ‡æ¢
       </a>
      </li>
      <li>
       <a href="#2_2_141" rel="nofollow">
        2&gt; ç‰ˆæœ¬2ï¼šå®šæ—¶å™¨åˆ‡æ¢
       </a>
      </li>
      <li>
       <ul>
        <li>
         <a href="#21_mainc_146" rel="nofollow">
          2.1&gt; main.c
         </a>
        </li>
        <li>
         <a href="#22_taskc_187" rel="nofollow">
          2.2&gt; task.c
         </a>
        </li>
        <li>
         <a href="#23_sleepc_309" rel="nofollow">
          2.3&gt; sleep.c
         </a>
        </li>
       </ul>
      </li>
      <li>
       <a href="#3_3_403" rel="nofollow">
        3&gt; ç‰ˆæœ¬3ï¼šåŠ æ—¶é—´ç‰‡è½®è½¬
       </a>
      </li>
     </ul>
    </div>
    <p>
    </p>
    <blockquote>
     <p>
      åœ¨51å•ç‰‡æœºä¸Šï¼Œå®ç°æ“ä½œç³»ç»Ÿæœ€ç®€æ¨¡å‹ï¼Œ å­¦ä¹ ç†è§£æ“ä½œç³»ç»Ÿçš„åŸºæœ¬æ¦‚å¿µï¼›
     </p>
    </blockquote>
    <p>
     <a href="https://www.bilibili.com/video/BV1ym4y1y7Jm/?spm_id_from=333.999.list.card_archive.click&amp;vd_source=c3471ffcf292e2d0642995f2056a2b8c" rel="nofollow">
      ğŸ”— //----------- å‚è€ƒè§†é¢‘é“¾æ¥ ï¼ˆ15é›†ï¼‰ -----------//
     </a>
    </p>
    <h2>
     <a id="1_1_12">
     </a>
     1&gt; ç‰ˆæœ¬1ï¼šä»»åŠ¡å»ºç«‹ä¸åˆ‡æ¢
    </h2>
    <pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;STC89C5xRC.H&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;intrins.h&gt;</span></span>


sbit LED_0	 <span class="token operator">=</span> P0<span class="token operator">^</span><span class="token number">0</span><span class="token punctuation">;</span>
sbit LED_1	 <span class="token operator">=</span> P0<span class="token operator">^</span><span class="token number">1</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MAX_TASKS</span>		<span class="token expression"><span class="token number">2</span>		</span><span class="token comment">// ä»»åŠ¡ä¸ªæ•°ï¼štask0ï¼Œtask1ï¼›		</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MAX_TASK_DEP</span>	<span class="token expression"><span class="token number">32</span>		</span><span class="token comment">// ä»»åŠ¡æœ€å¤§æ ˆæ·±åº¦ï¼šä»»åŠ¡åˆ‡æ¢æ—¶ä¿å­˜ç°åœºï¼›</span></span>

<span class="token keyword">unsigned</span> <span class="token keyword">char</span> idata task_sp<span class="token punctuation">[</span>MAX_TASKS<span class="token punctuation">]</span><span class="token punctuation">;</span>		<span class="token comment">// ä»»åŠ¡å †æ ˆæŒ‡é’ˆæ•°ç»„ï¼›</span>
<span class="token keyword">unsigned</span> <span class="token keyword">char</span> idata task_stack<span class="token punctuation">[</span>MAX_TASKS<span class="token punctuation">]</span><span class="token punctuation">[</span>MAX_TASK_DEP<span class="token punctuation">]</span><span class="token punctuation">;</span>	<span class="token comment">// ä»»åŠ¡å †æ ˆï¼Œ 2ä¸ªä»»åŠ¡ï¼Œæ¯ä¸ªä»»åŠ¡åˆ†é…32Byteç©ºé—´ï¼›</span>

<span class="token keyword">unsigned</span> <span class="token keyword">char</span> task_id<span class="token punctuation">;</span>


<span class="token comment">/*-- CPU Delay --*/</span>
<span class="token keyword">void</span> <span class="token function">Delay1000ms</span><span class="token punctuation">(</span><span class="token punctuation">)</span>		<span class="token comment">//@22.1184MHz</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">unsigned</span> <span class="token keyword">char</span> i<span class="token punctuation">,</span> j<span class="token punctuation">,</span> k<span class="token punctuation">;</span>

	<span class="token function">_nop_</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	i <span class="token operator">=</span> <span class="token number">15</span><span class="token punctuation">;</span>
	j <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
	k <span class="token operator">=</span> <span class="token number">235</span><span class="token punctuation">;</span>
	<span class="token keyword">do</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token keyword">do</span>
		<span class="token punctuation">{<!-- --></span>
			<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">--</span>k<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">--</span>j<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">--</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>




<span class="token comment">/**
  * @brief  ä»»ä½•åˆ‡æ¢å‡½æ•°ï¼ˆä»»åŠ¡è°ƒåº¦ï¼‰
  * @param  None
  * @retval None
  */</span>
<span class="token keyword">void</span> <span class="token function">task_switch</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	task_sp<span class="token punctuation">[</span>task_id<span class="token punctuation">]</span> <span class="token operator">=</span> SP<span class="token punctuation">;</span>	<span class="token comment">// ä¿å­˜å½“å‰çš„SPï¼›</span>

	task_id <span class="token operator">=</span> task_id <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>task_id <span class="token operator">==</span> MAX_TASKS<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		task_id <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	SP <span class="token operator">=</span> task_sp<span class="token punctuation">[</span>task_id<span class="token punctuation">]</span><span class="token punctuation">;</span>	<span class="token comment">// æŠŠä¸‹ä¸€ä¸ªtaskçš„spæ”¾å…¥åˆ°å½“å‰çš„SP</span>
<span class="token punctuation">}</span>


<span class="token comment">/**
  * @brief  ä»»åŠ¡0ï¼›
  * @param  None
  * @retval None
  */</span>
<span class="token keyword">void</span> <span class="token function">task0</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	
	LED_0 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		LED_0 <span class="token operator">=</span> <span class="token operator">~</span>LED_0<span class="token punctuation">;</span>

		<span class="token function">Delay1000ms</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token function">task_switch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">// ä»»åŠ¡åˆ‡æ¢ </span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
  * @brief  ä»»åŠ¡1ï¼›
  * @param  None
  * @retval None
  */</span>
<span class="token keyword">void</span> <span class="token function">task1</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	
	LED_1 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		LED_1 <span class="token operator">=</span> <span class="token operator">~</span>LED_1<span class="token punctuation">;</span>
		<span class="token function">Delay1000ms</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">task_switch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">// ä»»åŠ¡åˆ‡æ¢ </span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>


<span class="token comment">// å‡½æ•°çš„åœ°å€ï¼ˆæŒ‡é’ˆï¼‰å 16bitï¼›</span>
<span class="token comment">// fn:å­˜æ”¾å‡½æ•°çš„åœ°å€ï¼›</span>
<span class="token comment">// tidï¼štask idï¼Œ0æˆ–1ï¼›</span>

<span class="token keyword">void</span> <span class="token function">task_load</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> fn<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> tid<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token comment">// 51å•ç‰‡æœºä¸­ï¼Œå †æ ˆå‘ä¸Šå¢é•¿ï¼›</span>
	task_sp<span class="token punctuation">[</span>tid<span class="token punctuation">]</span> <span class="token operator">=</span> task_stack<span class="token punctuation">[</span>tid<span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>	 <span class="token comment">// å°†ä»»åŠ¡å †æ ˆæŒ‡é’ˆè®¾ç½®ä¸ºä¸‹ä¸€ä¸ªç©ºé—²ä½ç½®ï¼Œé¢„ç•™2ä¸ªByteç”¨æ¥å­˜æ”¾taskçš„å‡½æ•°åœ°å€ï¼›</span>

	<span class="token comment">// å­˜æ”¾task0æˆ–task1å‡½æ•°çš„é¦–åœ°å€</span>
	task_stack<span class="token punctuation">[</span>tid<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> fn <span class="token operator">&amp;</span> <span class="token number">0xff</span><span class="token punctuation">;</span>
	task_stack<span class="token punctuation">[</span>tid<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> fn <span class="token operator">&gt;&gt;</span> <span class="token number">8</span><span class="token punctuation">;</span>  
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token function">task_load</span><span class="token punctuation">(</span>task0<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">task_load</span><span class="token punctuation">(</span>task1<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	task_id <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>		<span class="token comment">// æŠŠå½“å‰ä»»åŠ¡è®¾ç½®ä¸ºtask0ï¼›</span>
	SP <span class="token operator">=</span> task_sp<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>	<span class="token comment">// æ‰§è¡Œtask0ï¼› </span>
<span class="token punctuation">}</span>
<span class="token comment">//----------------------------------- End ---------------------------//</span>
</code></pre>
    <p>
     å†…å­˜åˆ†é…ï¼š
     <br/>
     <img alt="1" src="https://i-blog.csdnimg.cn/blog_migrate/a816acb3a31af38a07a7e5665baced10.png"/>
    </p>
    <p>
     å®éªŒç»“æœï¼šLED0æ³¢å½¢
     <br/>
     <img alt="1" src="https://i-blog.csdnimg.cn/blog_migrate/835dce044afcd1ba7478d2d723358fdd.png#pic_center"/>
    </p>
    <blockquote>
     <p>
      é—®é¢˜ï¼šä¸ºä»€ä¹ˆLED0å’ŒLED1ä¼šäº®2sï¼Œç­2så‘¢ï¼Œå¦‚ä½•æ”¹ä¸ºæƒ³è¦äº®1sï¼Œç­1s
     </p>
    </blockquote>
    <blockquote>
     <p>
      void Delay1000ms()ï¼š æ˜¯CPUåœ¨ï¼Œä¸å¹²å…¶ä»–æ´»ï¼Œå‚»å»¶æ—¶ï¼Œæ‰€ä»¥LED0åœ¨ç­‰çš„åŒæ—¶LED1ä¹Ÿåœ¨ç­‰ï¼›
     </p>
    </blockquote>
    <hr/>
    <h2>
     <a id="2_2_141">
     </a>
     2&gt; ç‰ˆæœ¬2ï¼šå®šæ—¶å™¨åˆ‡æ¢
    </h2>
    <blockquote>
     <p>
      ä½¿ç”¨51å†…éƒ¨ï¼Œå®šæ—¶å™¨0ç¡¬ä»¶èµ„æºæ¥å®šæ—¶ï¼Œè®©CPUé‡Šæ”¾ï¼›
     </p>
    </blockquote>
    <hr/>
    <h3>
     <a id="21_mainc_146">
     </a>
     2.1&gt; main.c
    </h3>
    <pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"main.h"</span></span>

<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token function">Timer0_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">task_load</span><span class="token punctuation">(</span>task0<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">task_load</span><span class="token punctuation">(</span>task1<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	task_id <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>		<span class="token comment">// æŠŠå½“å‰ä»»åŠ¡è®¾ç½®ä¸ºtask0ï¼›</span>
	SP <span class="token operator">=</span> task_sp<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>	<span class="token comment">// æ‰§è¡Œtask0ï¼› </span>
<span class="token punctuation">}</span>
</code></pre>
    <hr/>
    <p>
     main.h
    </p>
    <pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">__MAIN_H__</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">__MAIN_H__</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;STC89C5xRC.H&gt;</span></span>

sbit LED_0	<span class="token operator">=</span> P0<span class="token operator">^</span><span class="token number">0</span><span class="token punctuation">;</span>
sbit LED_1	<span class="token operator">=</span> P0<span class="token operator">^</span><span class="token number">1</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MAX_TASKS</span>		<span class="token expression"><span class="token number">2</span>		</span><span class="token comment">// ä»»åŠ¡ä¸ªæ•°ï¼štask0ï¼Œtask1ï¼›		</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MAX_TASK_DEP</span>	<span class="token expression"><span class="token number">32</span>		</span><span class="token comment">// ä»»åŠ¡æœ€å¤§æ ˆæ·±åº¦ï¼šä»»åŠ¡åˆ‡æ¢æ—¶ä¿å­˜ç°åœºï¼›</span></span>


<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"sleep.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"task.h"</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>


</code></pre>
    <hr/>
    <h3>
     <a id="22_taskc_187">
     </a>
     2.2&gt; task.c
    </h3>
    <pre><code class="prism language-c">
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"task.h"</span></span>

<span class="token keyword">unsigned</span> <span class="token keyword">char</span> idata task_sp<span class="token punctuation">[</span>MAX_TASKS<span class="token punctuation">]</span><span class="token punctuation">;</span>		<span class="token comment">// ä»»åŠ¡å †æ ˆæŒ‡é’ˆæ•°ç»„ï¼›</span>
<span class="token keyword">unsigned</span> <span class="token keyword">char</span> idata task_stack<span class="token punctuation">[</span>MAX_TASKS<span class="token punctuation">]</span><span class="token punctuation">[</span>MAX_TASK_DEP<span class="token punctuation">]</span><span class="token punctuation">;</span>	<span class="token comment">// ä»»åŠ¡å †æ ˆï¼Œ 2ä¸ªä»»åŠ¡ï¼Œæ¯ä¸ªä»»åŠ¡åˆ†é…32Byteç©ºé—´ï¼›</span>

<span class="token keyword">unsigned</span> <span class="token keyword">char</span> task_id<span class="token punctuation">;</span>


<span class="token comment">/**
  * @brief  ä»»ä½•åˆ‡æ¢å‡½æ•°ï¼ˆä»»åŠ¡è°ƒåº¦ï¼‰
  * @param  None
  * @retval None
  */</span>
<span class="token keyword">void</span> <span class="token function">task_switch</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	task_sp<span class="token punctuation">[</span>task_id<span class="token punctuation">]</span> <span class="token operator">=</span> SP<span class="token punctuation">;</span>	<span class="token comment">// ä¿å­˜å½“å‰çš„SPï¼›</span>

	task_id <span class="token operator">=</span> task_id <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>task_id <span class="token operator">==</span> MAX_TASKS<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		task_id <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	SP <span class="token operator">=</span> task_sp<span class="token punctuation">[</span>task_id<span class="token punctuation">]</span><span class="token punctuation">;</span>	<span class="token comment">// æŠŠä¸‹ä¸€ä¸ªtaskçš„spæ”¾å…¥åˆ°å½“å‰çš„SP</span>
<span class="token punctuation">}</span>


<span class="token comment">/**
  * @brief  ä»»åŠ¡0ï¼›
  * @param  None
  * @retval None
  */</span>
<span class="token keyword">void</span> <span class="token function">task0</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	
	LED_0 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		
		<span class="token keyword">if</span> <span class="token punctuation">(</span>tasks<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>status <span class="token operator">==</span> TASK_SUSPENDED<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token function">task_switch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">continue</span><span class="token punctuation">;</span>	<span class="token comment">// å¦‚æœä»»åŠ¡å¤„äºsleepæŒ‚èµ·çŠ¶æ€ï¼Œç›´æ¥è·³å‡º		</span>
		<span class="token punctuation">}</span>


		LED_0 <span class="token operator">=</span> <span class="token operator">~</span>LED_0<span class="token punctuation">;</span>

		<span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ä»»åŠ¡0ï¼Œç¡çœ 1sï¼›æ²¡æœ‰ä»»ä½•é˜»å¡ï¼›</span>

		<span class="token function">task_switch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">// ä»»åŠ¡åˆ‡æ¢ </span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
  * @brief  ä»»åŠ¡1ï¼›
  * @param  None
  * @retval None
  */</span>
<span class="token keyword">void</span> <span class="token function">task1</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	
	LED_1 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

		<span class="token keyword">if</span> <span class="token punctuation">(</span>tasks<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>status <span class="token operator">==</span> TASK_SUSPENDED<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token function">task_switch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">continue</span><span class="token punctuation">;</span>	<span class="token comment">// å¦‚æœä»»åŠ¡å¤„äºsleepæŒ‚èµ·çŠ¶æ€ï¼Œç›´æ¥è·³å‡º		</span>
		<span class="token punctuation">}</span>

		LED_1 <span class="token operator">=</span> <span class="token operator">~</span>LED_1<span class="token punctuation">;</span>
		<span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">task_switch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">// ä»»åŠ¡åˆ‡æ¢ </span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>


<span class="token comment">// å‡½æ•°çš„åœ°å€ï¼ˆæŒ‡é’ˆï¼‰å 16bitï¼›</span>
<span class="token comment">// fn:å­˜æ”¾å‡½æ•°çš„åœ°å€ï¼›</span>
<span class="token comment">// tidï¼štask idï¼Œ0æˆ–1ï¼›</span>

<span class="token keyword">void</span> <span class="token function">task_load</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> fn<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> tid<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token comment">// 51å•ç‰‡æœºä¸­ï¼Œå †æ ˆå‘ä¸Šå¢é•¿ï¼›</span>
	task_sp<span class="token punctuation">[</span>tid<span class="token punctuation">]</span> <span class="token operator">=</span> task_stack<span class="token punctuation">[</span>tid<span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>	 <span class="token comment">// å°†ä»»åŠ¡å †æ ˆæŒ‡é’ˆè®¾ç½®ä¸ºä¸‹ä¸€ä¸ªç©ºé—²ä½ç½®ï¼Œé¢„ç•™2ä¸ªByteç”¨æ¥å­˜æ”¾taskçš„å‡½æ•°åœ°å€ï¼›</span>

	<span class="token comment">// å­˜æ”¾task0æˆ–task1å‡½æ•°çš„é¦–åœ°å€</span>
	task_stack<span class="token punctuation">[</span>tid<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> fn <span class="token operator">&amp;</span> <span class="token number">0xff</span><span class="token punctuation">;</span>
	task_stack<span class="token punctuation">[</span>tid<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> fn <span class="token operator">&gt;&gt;</span> <span class="token number">8</span><span class="token punctuation">;</span>  
<span class="token punctuation">}</span>

</code></pre>
    <p>
     task.h
    </p>
    <pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">__TASK_H__</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">__TASK_H__</span></span>


<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"main.h"</span></span>



<span class="token keyword">extern</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> idata task_sp<span class="token punctuation">[</span>MAX_TASKS<span class="token punctuation">]</span><span class="token punctuation">;</span>		<span class="token comment">// ä»»åŠ¡å †æ ˆæŒ‡é’ˆæ•°ç»„ï¼›</span>
<span class="token keyword">extern</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> idata task_stack<span class="token punctuation">[</span>MAX_TASKS<span class="token punctuation">]</span><span class="token punctuation">[</span>MAX_TASK_DEP<span class="token punctuation">]</span><span class="token punctuation">;</span>	<span class="token comment">// ä»»åŠ¡å †æ ˆï¼Œ 2ä¸ªä»»åŠ¡ï¼Œæ¯ä¸ªä»»åŠ¡åˆ†é…32Byteç©ºé—´ï¼›</span>

<span class="token keyword">extern</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> task_id<span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">task0</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">task1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">task_load</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> fn<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> tid<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">task_switch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
</code></pre>
    <hr/>
    <h3>
     <a id="23_sleepc_309">
     </a>
     2.3&gt; sleep.c
    </h3>
    <pre><code class="prism language-c">
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"sleep.h"</span> </span>

Task idata tasks<span class="token punctuation">[</span>MAX_TASKS<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
	<span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">,</span> TASK_RUNNING<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">,</span>	<span class="token comment">// ä»»åŠ¡0ï¼Œé»˜è®¤è¿è¡ŒçŠ¶æ€ï¼Œä¸å»¶æ—¶ï¼Œå½“å‰å»¶æ—¶æ—¶é—´0ï¼›</span>
	<span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">,</span> TASK_RUNNING<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">,</span>	<span class="token comment">// ä»»åŠ¡1ï¼Œé»˜è®¤è¿è¡ŒçŠ¶æ€ï¼Œä¸å»¶æ—¶ï¼Œå½“å‰å»¶æ—¶æ—¶é—´0ï¼›</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> task_id<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> delay_ms<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>	
	tasks<span class="token punctuation">[</span>task_id<span class="token punctuation">]</span><span class="token punctuation">.</span>status <span class="token operator">=</span> TASK_SUSPENDED<span class="token punctuation">;</span>
	tasks<span class="token punctuation">[</span>task_id<span class="token punctuation">]</span><span class="token punctuation">.</span>delay_count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	tasks<span class="token punctuation">[</span>task_id<span class="token punctuation">]</span><span class="token punctuation">.</span>delay_duration <span class="token operator">=</span> delay_ms<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">//1æ¯«ç§’@22.1184MHz</span>
<span class="token keyword">void</span> <span class="token function">Timer0_Init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>	
<span class="token punctuation">{<!-- --></span>
	TMOD <span class="token operator">&amp;=</span> <span class="token number">0xF0</span><span class="token punctuation">;</span>	<span class="token comment">//è®¾ç½®å®šæ—¶å™¨æ¨¡å¼</span>
	TMOD <span class="token operator">|=</span> <span class="token number">0x01</span><span class="token punctuation">;</span>	<span class="token comment">//è®¾ç½®å®šæ—¶å™¨æ¨¡å¼</span>
	TL0 <span class="token operator">=</span> <span class="token number">0xCD</span><span class="token punctuation">;</span>		<span class="token comment">//è®¾ç½®å®šæ—¶åˆå§‹å€¼</span>
	TH0 <span class="token operator">=</span> <span class="token number">0xF8</span><span class="token punctuation">;</span>		<span class="token comment">//è®¾ç½®å®šæ—¶åˆå§‹å€¼</span>
	TF0 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>		<span class="token comment">//æ¸…é™¤TF0æ ‡å¿—</span>

	ET0 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
	EA <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
	TR0 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>		<span class="token comment">//å®šæ—¶å™¨0å¼€å§‹è®¡æ—¶</span>
<span class="token punctuation">}</span>


<span class="token comment">/*--- å®šä½å™¨0ä¸­æ–­æœåŠ¡å‡½æ•°, 1msä¸­æ–­1æ¬¡ ---*/</span>
<span class="token keyword">void</span> <span class="token function">Timer0_ISR</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> interrupt <span class="token number">1</span>  
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">unsigned</span> <span class="token keyword">char</span> i<span class="token punctuation">;</span>

	TL0 <span class="token operator">=</span> <span class="token number">0xCD</span><span class="token punctuation">;</span>		<span class="token comment">//è®¾ç½®å®šæ—¶åˆå§‹å€¼</span>
	TH0 <span class="token operator">=</span> <span class="token number">0xF8</span><span class="token punctuation">;</span>		<span class="token comment">//è®¾ç½®å®šæ—¶åˆå§‹å€¼</span>

	<span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> MAX_TASKS<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>tasks<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>status <span class="token operator">==</span> TASK_SUSPENDED<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			tasks<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>delay_count<span class="token operator">++</span><span class="token punctuation">;</span>

			<span class="token keyword">if</span> <span class="token punctuation">(</span>tasks<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>delay_count <span class="token operator">&gt;=</span> tasks<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>delay_duration<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				tasks<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>status <span class="token operator">=</span> TASK_RUNNING<span class="token punctuation">;</span>
				tasks<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>delay_count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>

<span class="token punctuation">}</span>

</code></pre>
    <hr/>
    <p>
     sleep.h
    </p>
    <pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">__SLEEP_H__</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">__SLEEP_H__</span></span>


<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"main.h"</span></span>



<span class="token keyword">typedef</span> <span class="token keyword">enum</span> <span class="token punctuation">{<!-- --></span>
	TASK_RUNNING<span class="token punctuation">,</span>
	TASK_SUSPENDED
<span class="token punctuation">}</span> TaskStatus<span class="token punctuation">;</span>


<span class="token comment">/*--- å®šä¹‰ä»»åŠ¡ç»“æ„ä½“ ---*/</span>
<span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">unsigned</span> <span class="token keyword">char</span> id<span class="token punctuation">;</span> 				<span class="token comment">// ä»»åŠ¡id</span>
	TaskStatus status<span class="token punctuation">;</span>				<span class="token comment">// ä»»åŠ¡çŠ¶æ€</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">int</span> delay_count<span class="token punctuation">;</span>		<span class="token comment">// å»¶æ—¶è®¡æ•°å™¨</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">int</span> delay_duration<span class="token punctuation">;</span>	<span class="token comment">// å»¶æ—¶æ—¶é—´</span>
<span class="token punctuation">}</span> Task<span class="token punctuation">;</span>

<span class="token keyword">extern</span> Task idata tasks<span class="token punctuation">[</span>MAX_TASKS<span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">Timer0_Init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> task_id<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> delay_ms<span class="token punctuation">)</span><span class="token punctuation">;</span>


<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
</code></pre>
    <hr/>
    <h2>
     <a id="3_3_403">
     </a>
     3&gt; ç‰ˆæœ¬3ï¼šåŠ æ—¶é—´ç‰‡è½®è½¬
    </h2>
    <blockquote>
     <p>
      ç‰ˆæœ¬2ä¸­å¦‚æœå…¶ä¸­ä¸€ä¸ªä»»åŠ¡ï¼Œä¸ä¸»åŠ¨task_switch()åˆ‡æ¢ä»»åŠ¡ï¼Œæ€ä¹ˆåŠï¼Ÿ
      <br/>
      å†ç”¨ä¸€ä¸ªç¡¬ä»¶èµ„æºTimer1ï¼Œ200usä¸­æ–­ä¸€æ¬¡ï¼Œå¹¶å¼ºåˆ¶åˆ‡æ¢ï¼›
     </p>
    </blockquote>
    <p>
     sleep.c å¢åŠ ï¼š
    </p>
    <pre><code class="prism language-c">
<span class="token keyword">void</span> <span class="token function">Timer1_Init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>		<span class="token comment">//200å¾®ç§’@22.1184MHz</span>
<span class="token punctuation">{<!-- --></span>
	TMOD <span class="token operator">&amp;=</span> <span class="token number">0x0F</span><span class="token punctuation">;</span>			<span class="token comment">//è®¾ç½®å®šæ—¶å™¨æ¨¡å¼</span>
	TMOD <span class="token operator">|=</span> <span class="token number">0x10</span><span class="token punctuation">;</span>			<span class="token comment">//è®¾ç½®å®šæ—¶å™¨æ¨¡å¼</span>
	TL1 <span class="token operator">=</span> <span class="token number">0xB8</span><span class="token punctuation">;</span>				<span class="token comment">//è®¾ç½®å®šæ—¶åˆå§‹å€¼</span>
	TH1 <span class="token operator">=</span> <span class="token number">0xEE</span><span class="token punctuation">;</span>				<span class="token comment">//è®¾ç½®å®šæ—¶åˆå§‹å€¼</span>
	TF1 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>				<span class="token comment">//æ¸…é™¤TF1æ ‡å¿—</span>
	
	ET1 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
	EA <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
	TR1 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>				<span class="token comment">//å®šæ—¶å™¨1å¼€å§‹è®¡æ—¶</span>
<span class="token punctuation">}</span>




<span class="token keyword">void</span> <span class="token function">Timer1_ISR</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> interrupt <span class="token number">3</span>  
<span class="token punctuation">{<!-- --></span>
	TL1 <span class="token operator">=</span> <span class="token number">0xB8</span><span class="token punctuation">;</span>				<span class="token comment">//è®¾ç½®å®šæ—¶åˆå§‹å€¼</span>
	TH1 <span class="token operator">=</span> <span class="token number">0xEE</span><span class="token punctuation">;</span>				<span class="token comment">//è®¾ç½®å®šæ—¶åˆå§‹å€¼</span>
	
	<span class="token function">task_switch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     ä»£ç æ²¡å®ç°ï¼š
    </p>
    <blockquote>
     <p>
      ä»»åŠ¡çš„ä¼˜å…ˆçº§ï¼›
      <br/>
      ä»»åŠ¡ä¹‹é—´æ²¡æœ‰ä¿¡å·é‡ï¼Œæ¶ˆæ¯æœºåˆ¶ï¼›
      <br/>
      æ–‡ä»¶ç®¡ç†ï¼›
      <br/>
      å†…å­˜ç®¡ç†ï¼›
     </p>
    </blockquote>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f62:6c6f672e6373646e2e6e65742f58305f496d50655269616c2f:61727469636c652f64657461696c732f313330343338323735" class_="artid" style="display:none">
 </p>
</div>


