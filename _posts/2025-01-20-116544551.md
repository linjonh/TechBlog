---
layout: post
title: "STM32ESP8266连接腾讯云物联网开发平台-2STM32ESP8266-01S连接腾讯云"
date: 2025-01-20 10:50:58 +0800
description: "文章目录前言一、硬件准备1.ESP8266-01S2. STM32F103C8T6核心板或者小开发板"
keywords: "stm32使用esp8266采用mqtt上腾讯云"
categories: ['腾讯云物联网开发平台', '安信可模组', 'Esp']
tags: ['物联网', 'Thinker', 'Stm']
artid: "116544551"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=116544551
    alt: "STM32ESP8266连接腾讯云物联网开发平台-2STM32ESP8266-01S连接腾讯云"
render_with_liquid: false
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     【STM32+ESP8266连接腾讯云物联网开发平台 2】STM32+ESP8266-01S连接腾讯云
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <p>
    </p>
    <div class="toc">
     <h4>
      文章目录
     </h4>
     <ul>
      <li>
       <a href="#_6" rel="nofollow">
        前言
       </a>
      </li>
      <li>
       <a href="#_14" rel="nofollow">
        一、硬件准备
       </a>
      </li>
      <li>
       <ul>
        <li>
         <a href="#1ESP826601S_15" rel="nofollow">
          1.ESP8266-01S
         </a>
        </li>
        <li>
         <a href="#2_STM32F103C8T6_21" rel="nofollow">
          2. STM32F103C8T6核心板或者小开发板及其程序下载器
         </a>
        </li>
       </ul>
      </li>
      <li>
       <a href="#_26" rel="nofollow">
        二、软件准备
       </a>
      </li>
      <li>
       <ul>
        <li>
         <a href="#1STM32CubeMX_27" rel="nofollow">
          1.STM32CubeMX
         </a>
        </li>
        <li>
         <a href="#2_MDK_Keil_v5_29" rel="nofollow">
          2. MDK （Keil v5）
         </a>
        </li>
        <li>
         <a href="#3_31" rel="nofollow">
          3.程序实现流程
         </a>
        </li>
       </ul>
      </li>
      <li>
       <a href="#STM32CubeMX__33" rel="nofollow">
        三、STM32CubeMX 配置工程
       </a>
      </li>
      <li>
       <ul>
        <li>
         <a href="#1_35" rel="nofollow">
          1.根据芯片信号创建工程
         </a>
        </li>
        <li>
         <a href="#2LED_40" rel="nofollow">
          2.配置LED驱动引脚
         </a>
        </li>
        <li>
         <a href="#3_43" rel="nofollow">
          3.配置串口驱动
         </a>
        </li>
        <li>
         <a href="#4FreeRTOS_45" rel="nofollow">
          4.FreeRTOS配置
         </a>
        </li>
        <li>
         <a href="#5FreeRTOS_47" rel="nofollow">
          5.FreeRTOS的定时器配置
         </a>
        </li>
        <li>
         <a href="#6_50" rel="nofollow">
          6.工程配置
         </a>
        </li>
       </ul>
      </li>
      <li>
       <a href="#_56" rel="nofollow">
        四、串口中断驱动编写
       </a>
      </li>
      <li>
       <a href="#ESP8266_104" rel="nofollow">
        五、ESP8266的数据显示
       </a>
      </li>
      <li>
       <a href="#ATESP8266WiFi_141" rel="nofollow">
        六、AT指令配置ESP8266连接WiFi和腾讯云
       </a>
      </li>
      <li>
       <ul>
        <li>
         <a href="#1WiFi_143" rel="nofollow">
          1.连接WiFi
         </a>
        </li>
        <li>
         <a href="#2_181" rel="nofollow">
          2.连接腾讯云并订阅主题
         </a>
        </li>
       </ul>
      </li>
      <li>
       <a href="#JSONLED_226" rel="nofollow">
        七、处理JSON数据并控制LED
       </a>
      </li>
      <li>
       <ul>
        <li>
         <a href="#1Topic_JSON_232" rel="nofollow">
          1.分割出Topic 和JSON数据
         </a>
        </li>
        <li>
         <a href="#2JSON_276" rel="nofollow">
          2.JSON数据处理
         </a>
        </li>
       </ul>
      </li>
      <li>
       <a href="#AppLED_306" rel="nofollow">
        八、腾讯连连App控制LED灯演示
       </a>
      </li>
      <li>
       <ul>
        <li>
         <a href="#_308" rel="nofollow">
          源码请到转跳：
         </a>
        </li>
       </ul>
      </li>
     </ul>
    </div>
    <p>
    </p>
    <hr color="#000000" size='1"'/>
    <h2>
     <a id="_6">
     </a>
     前言
    </h2>
    <p>
     昨天已经用ESP-12S成功连接上腾讯云物联网开发平台，并且还能用手机控制了，但是毕竟是在电脑上位机做的连接，还没有在STM32连接。博主经过一天的努力。成功给STM32接上了腾讯云物联网开发平台，先说明几点：
     <br/>
     <strong>
      1.
     </strong>
     博主用的是RTOS实时操作系统，为的是更快捷的读取云的数据；
     <br/>
     <strong>
      2.
     </strong>
     博主也是第一次使用RTOS实时操作系统，对一些API还不是特别熟悉；
     <br/>
     <strong>
      3.
     </strong>
     本文虽然大部分介绍怎么实现功能，小部分需要同学们要有点动手能力，比如换SOP芯片啥的。
     <br/>
     <strong>
      4.
     </strong>
     如果没有看过
     <strong>
      第一篇
     </strong>
     的同学，请移步
     <a href="https://blog.csdn.net/qq1140920745/article/details/116457452">
      【STM32+ESP-12S连接腾讯云物联网开发平台 1】云平台的创建和AT固件烧录
     </a>
     ，能做到成功连接腾讯云物联网平台再看本文，不然这篇博文对大家
     <mark>
      连接云平台
     </mark>
     的帮助不会很大。
     <br/>
     <strong>
      <mark>
       <font color="#f70a20">
        声明一下：博主是第一次使用HAL库给STAM32编程，所以有不足之处还请见谅！！
       </font>
      </mark>
     </strong>
    </p>
    <h2>
     <a id="_14">
     </a>
     一、硬件准备
    </h2>
    <h3>
     <a id="1ESP826601S_15">
     </a>
     1.ESP8266-01S
    </h3>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/03ecb3ce87c4f9a27a398ad34af38c0d.png#pic_center">
      <br/>
      如果大家看过
      <strong>
       <a href="https://blog.csdn.net/qq1140920745/article/details/116457452">
        STM32+ESP-12S连接腾讯云物联网开发平台 1
       </a>
      </strong>
      都应该还记得：ESP8266-01S因为
      <mark>
       Flash太小的原因，无法烧录至少需要2M Flash(ESP8266-01S一般只有1MFlash)的AT固件
      </mark>
      ，这时候就需要各位同学的动手能力了。
      <br/>
      不就是Flash 太小吗？换一个大的就是了，所以大家可以把那个8脚的芯片拆了，换成2M以上的Flash芯片。然后烧录：
      <mark>
       QCloud_IoT_AT_ESP8266_v2.0.0_20200617_UART_1_3.bin
      </mark>
      这个版本的固件，记住不要烧录错误，怎么烧录请移步：
      <strong>
       <a href="https://blog.csdn.net/qq1140920745/article/details/116457452">
        STM32+ESP-12S连接腾讯云物联网开发平台 1
       </a>
      </strong>
      。
      <br/>
      <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/73685c18367c37d4b4a3ee85381c837a.png#pic_center"/>
     </img>
    </p>
    <h3>
     <a id="2_STM32F103C8T6_21">
     </a>
     2. STM32F103C8T6核心板或者小开发板及其程序下载器
    </h3>
    <p>
     在STM32芯片价格暴涨的年代，用STM32真是为难大家了，但是STM32F103C8T6的最小开发板的价格还是可以接受滴，博主推荐能够直插ESP8266-01S的,省得大家接线麻烦。
     <br/>
     程序下载器大家可以根据烧录方式来选择：
     <br/>
     <strong>
      1.
     </strong>
     串口烧录的可以用USB转TTL模块就行；
     <br/>
     <strong>
      2
     </strong>
     仿真调试方式下载，大家可以用STLink，或者Jlink都行。
    </p>
    <h2>
     <a id="_26">
     </a>
     二、软件准备
    </h2>
    <h3>
     <a id="1STM32CubeMX_27">
     </a>
     1.STM32CubeMX
    </h3>
    <p>
     `       博主玩这么多年的STM32，也是第一次用这个软件，不得不说，比起自己搭开发环境来说，这个真是太省时间了。
    </p>
    <h3>
     <a id="2_MDK_Keil_v5_29">
     </a>
     2. MDK （Keil v5）
    </h3>
    <p>
     这个软件，博主只用来学习，不做任何商业用途。推荐使用正版MDK。
    </p>
    <h3>
     <a id="3_31">
     </a>
     3.程序实现流程
    </h3>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/deeb5d96bb778cdc4d52108e4db6b370.png#pic_center"/>
    </p>
    <h2>
     <a id="STM32CubeMX__33">
     </a>
     三、STM32CubeMX 配置工程
    </h2>
    <p>
     博主也是第一次使用这个软件来配置工程，有什么不足之处非常欢迎指正，
    </p>
    <h3>
     <a id="1_35">
     </a>
     1.根据芯片信号创建工程
    </h3>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/a66b33e718d600cb04b91779b3dd9079.png#pic_center">
      <br/>
      <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/fa1761d70331001c2661e7d895928e6c.png">
       <br/>
       到这里就需要开始配置功能引脚了。
      </img>
     </img>
    </p>
    <h3>
     <a id="2LED_40">
     </a>
     2.配置LED驱动引脚
    </h3>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/166f0f7a986629df1c2a490bab00dce6.png"/>
    </p>
    <h3>
     <a id="3_43">
     </a>
     3.配置串口驱动
    </h3>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/3e166996649b6a058edfa23ecd6df8ab.png"/>
    </p>
    <h3>
     <a id="4FreeRTOS_45">
     </a>
     4.FreeRTOS配置
    </h3>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/7f23a0741af9b2f522773b6bd79ee0ff.png"/>
    </p>
    <h3>
     <a id="5FreeRTOS_47">
     </a>
     5.FreeRTOS的定时器配置
    </h3>
    <p>
     FreeRTOS是要使用定时器来管理任务的并行关系，所以要对定时器进行更改：
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/14ca3ecbb8106ac3c94823a59585fad7.png"/>
    </p>
    <h3>
     <a id="6_50">
     </a>
     6.工程配置
    </h3>
    <p>
     配置完引脚之后，还要对工程输出进行配置：
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/867d08c0a0a98a3c4ef96f2e93e6b722.png">
      <br/>
      <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/cd70568761e0f56394cfc9fb80ec1a33.png">
       <br/>
       <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/54d0f2912cc1b315e65c23a1b573cc24.png"/>
       <br/>
       这样，我们的工程就配置好了，下面就能编写功能代码了。
      </img>
     </img>
    </p>
    <h2>
     <a id="_56">
     </a>
     四、串口中断驱动编写
    </h2>
    <p>
     STM32CubeMx生成的代码使用HAL库写的，而且对串口中断做了一下改变，现在并不是说直接就可以在串口中断函数中处理数据。目前，串口中断函数中只有一个函数：
    </p>
    <pre><code class="prism language-c"><span class="token keyword">void</span> <span class="token function">USART1_IRQHandler</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
  <span class="token comment">/* USER CODE BEGIN USART1_IRQn 0 */</span>

  <span class="token comment">/* USER CODE END USART1_IRQn 0 */</span>
  <span class="token function">HAL_UART_IRQHandler</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>huart1<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">/* USER CODE BEGIN USART1_IRQn 1 */</span>
  
  <span class="token comment">/* USER CODE END USART1_IRQn 1 */</span>
<span class="token punctuation">}</span>

</code></pre>
    <p>
     这个
     <mark>
      HAL_UART_IRQHandler(&amp;huart1)
     </mark>
     函数只是判断中断类型而已，并没有处理数据的相关代码在里面。有兴趣的同学可以到函数里面看看。
     <br/>
     那既然这个函数并没有做数据处理，那肯定是有个函数专门负责接收串口数据的：
     <br/>
     <strong>
      串口中断接收函数：
     </strong>
     <font color="#f70a20">
      HAL_UART_Receive_IT(UART_HandleTypeDef *huart, uint8_t *pData, uint16_t Size);
      <font color="#">
       <br/>
       这个函数的功能：
       <mark>
        这个函数是把husart 串口接收到的 Size数据量的字节存到pData中，
        <font color="#f70a20">
         并且关掉中断
        </font>
       </mark>
       。
       <br/>
       也就说，当我们接受完数据之后，要重新使用这个函数来开启中断。另外还要介绍另一个和这个函数息息相关的函数：
       <br/>
       <strong>
        串口接收回调函数：
       </strong>
       <font color="#f70a20">
        void HAL_UART_RxCpltCallback(UART_HandleTypeDef *huart)；
        <br/>
        这个函数默认不会自动生成，需要我们自己写。
        <font color="#">
         <br/>
         函数功能：
         <mark>
          当HAL_UART_Receive_IT函数结束后，会进来这个函数当中，用户可以在这个函数中对数据进行处理。
         </mark>
         <br/>
         方便大家，给各位同学贴出我自己写的函数HAL_UART_RxCpltCallback
        </font>
       </font>
      </font>
     </font>
    </p>
    <pre><code class="prism language-c"> <span class="token keyword">if</span><span class="token punctuation">(</span>huart<span class="token operator">-&gt;</span>Instance<span class="token operator">==</span>USART2<span class="token punctuation">)</span>
  <span class="token punctuation">{<!-- --></span>
   UART2_DATA<span class="token punctuation">.</span>UART_Data<span class="token punctuation">[</span>UART2_DATA<span class="token punctuation">.</span>UART_Cnt<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">*</span>UART2_DATA<span class="token punctuation">.</span>UART_DataBuf<span class="token punctuation">;</span>
   UART2_DATA<span class="token punctuation">.</span>UART_Cnt<span class="token operator">++</span><span class="token punctuation">;</span>
  
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">*</span>UART2_DATA<span class="token punctuation">.</span>UART_DataBuf<span class="token operator">==</span><span class="token number">0X0A</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
      UART2_DATA<span class="token punctuation">.</span>UART_Flag <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token function">HAL_UART_Receive_IT</span><span class="token punctuation">(</span>huart<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> <span class="token operator">*</span><span class="token punctuation">)</span>UART2_DATA<span class="token punctuation">.</span>UART_DataBuf<span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>UART2_DATA<span class="token punctuation">.</span>UART_DataBuf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <p>
     相关宏结构体：
    </p>
    <pre><code class="prism language-c"><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">usart</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">unsigned</span> <span class="token keyword">char</span> UART_Data<span class="token punctuation">[</span><span class="token number">512</span><span class="token punctuation">]</span><span class="token punctuation">;</span> 
    <span class="token keyword">unsigned</span> <span class="token keyword">char</span> UART_Flag<span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> UART_Cnt<span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">char</span> UART_DataBuf<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>USART_DataBuf<span class="token punctuation">;</span>
</code></pre>
    <p>
     我把接收到的数据存在结构体当中进行同意处理，而且这个结构体是全局的，方便使用。
    </p>
    <h2>
     <a id="ESP8266_104">
     </a>
     五、ESP8266的数据显示
    </h2>
    <p>
     这个函数可以把ESP8266接收到的数据通过USART1打印出来，方便我们查看调试和了解AT指令的进度。这个函数我把它放在了一个独立线程当中，这样就可以不断地读取并显示出来。
    </p>
    <pre><code class="prism language-c">ESP8266DATATypedef esp8266data<span class="token punctuation">;</span>
<span class="token comment">//获取串口数据</span>
<span class="token class-name">uint8_t</span> <span class="token operator">*</span><span class="token function">Esp8266GetData</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>UART2_DATA<span class="token punctuation">.</span>UART_Flag <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span>
  <span class="token punctuation">{<!-- --></span>
    <span class="token function">strcpy</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>esp8266data<span class="token punctuation">.</span>data<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>UART2_DATA<span class="token punctuation">.</span>UART_Data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    esp8266data<span class="token punctuation">.</span>data_size <span class="token operator">=</span> UART2_DATA<span class="token punctuation">.</span>UART_Cnt<span class="token punctuation">;</span>
    
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s"</span><span class="token punctuation">,</span> UART2_DATA<span class="token punctuation">.</span>UART_Data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> UART2_DATA<span class="token punctuation">.</span>UART_Cnt <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">;</span> UART2_DATA<span class="token punctuation">.</span>UART_Cnt<span class="token operator">--</span><span class="token punctuation">)</span>
      UART2_DATA<span class="token punctuation">.</span>UART_Data<span class="token punctuation">[</span>UART2_DATA<span class="token punctuation">.</span>UART_Cnt<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    esp8266data<span class="token punctuation">.</span>flag <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>  
    <span class="token keyword">if</span><span class="token punctuation">(</span>esp8266data<span class="token punctuation">.</span>flag<span class="token operator">&gt;</span><span class="token number">16</span><span class="token punctuation">)</span> esp8266data<span class="token punctuation">.</span>flag<span class="token operator">=</span><span class="token number">16</span><span class="token punctuation">;</span>
    UART2_DATA<span class="token punctuation">.</span>UART_Flag <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> esp8266data<span class="token punctuation">.</span>data<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> esp8266data<span class="token punctuation">.</span>data<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <pre><code class="prism language-c"><span class="token keyword">void</span> <span class="token function">StartTask02</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>argument<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
  <span class="token comment">/* USER CODE BEGIN StartTask02 */</span>
  <span class="token comment">/* Infinite loop */</span>
  <span class="token class-name">uint8_t</span> <span class="token operator">*</span>sub_buf<span class="token punctuation">;</span>
  <span class="token function">HAL_UART_RxCpltCallback</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>huart2<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span>
  <span class="token punctuation">{<!-- --></span>
    sub_buf <span class="token operator">=</span> <span class="token function">Esp8266GetData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre>
    <h2>
     <a id="ATESP8266WiFi_141">
     </a>
     六、AT指令配置ESP8266连接WiFi和腾讯云
    </h2>
    <p>
     有了串口中断及之前地AT指令流程，就可以连接腾讯云了：
    </p>
    <h3>
     <a id="1WiFi_143">
     </a>
     1.连接WiFi
    </h3>
    <pre><code class="prism language-c"><span class="token comment">//连接WiFi</span>
<span class="token keyword">void</span> <span class="token function">Esp8266LinkAp</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> <span class="token operator">*</span>ssid<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> <span class="token operator">*</span>passwd<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
  <span class="token class-name">uint8_t</span> <span class="token operator">*</span>linkap<span class="token punctuation">;</span>

  linkap <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">uint8_t</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">HAL_UART_Transmit</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>huart2<span class="token punctuation">,</span> <span class="token string">" \r\n"</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">do</span>
  <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>esp8266data<span class="token punctuation">.</span>flag<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">case</span> <span class="token number">0</span><span class="token operator">:</span> <span class="token comment">//复位ESP8266</span>
      <span class="token function">HAL_UART_Transmit</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>huart2<span class="token punctuation">,</span> <span class="token string">"AT+RST\r\n"</span><span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span><span class="token string">"AT+RST\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">5000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">osDelay</span><span class="token punctuation">(</span><span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> <span class="token number">2</span><span class="token operator">:</span> <span class="token comment">//设置连接模式</span>
    <span class="token keyword">case</span> <span class="token number">3</span><span class="token operator">:</span>
      <span class="token function">HAL_UART_Transmit</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>huart2<span class="token punctuation">,</span> <span class="token string">"AT+CWMODE=1\r\n"</span><span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span><span class="token string">"AT+CWMODE=1\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">5000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">osDelay</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token comment">//开始连接WiFi</span>
    <span class="token keyword">case</span> <span class="token number">4</span><span class="token operator">:</span>
    <span class="token keyword">case</span> <span class="token number">5</span><span class="token operator">:</span>
      <span class="token function">sprintf</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>linkap<span class="token punctuation">,</span> <span class="token string">"AT+CWJAP=\"%s\",\"%s\"\r\n"</span><span class="token punctuation">,</span> ssid<span class="token punctuation">,</span> passwd<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">HAL_UART_Transmit</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>huart2<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">uint8_t</span> <span class="token operator">*</span><span class="token punctuation">)</span>linkap<span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>linkap<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">5000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">osDelay</span><span class="token punctuation">(</span><span class="token number">5000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>

    <span class="token keyword">default</span><span class="token operator">:</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>esp8266data<span class="token punctuation">.</span>flag <span class="token operator">&lt;</span> <span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">free</span><span class="token punctuation">(</span>linkap<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <h3>
     <a id="2_181">
     </a>
     2.连接腾讯云并订阅主题
    </h3>
    <pre><code class="prism language-c"><span class="token keyword">void</span> <span class="token function">Esp8266LinkloTExplorer</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
  <span class="token class-name">uint8_t</span> <span class="token operator">*</span>device_massage<span class="token punctuation">;</span>

  device_massage <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">uint8_t</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">do</span>
  <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>esp8266data<span class="token punctuation">.</span>flag<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
      <span class="token comment">// case 7: //设置连接信息</span>
    <span class="token keyword">case</span> <span class="token number">7</span><span class="token operator">:</span>
    <span class="token keyword">case</span> <span class="token number">8</span><span class="token operator">:</span>
      <span class="token function">sprintf</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>device_massage<span class="token punctuation">,</span> <span class="token string">"AT+TCDEVINFOSET=1,\"%s\",\"%s\",\"%s\"\r\n"</span><span class="token punctuation">,</span> PRODUCT_ID<span class="token punctuation">,</span> DEVUICE_NAME<span class="token punctuation">,</span> DEVICE_SECRET<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">HAL_UART_Transmit</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>huart2<span class="token punctuation">,</span> device_massage<span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>device_massage<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">5000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">osDelay</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> <span class="token number">9</span><span class="token operator">:</span>
    <span class="token keyword">case</span> <span class="token number">10</span><span class="token operator">:</span>
      <span class="token function">HAL_UART_Transmit</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>huart2<span class="token punctuation">,</span> <span class="token string">"AT+TCMQTTDISCONN\r\n"</span><span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span><span class="token string">"AT+TCMQTTDISCONN\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">5000</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//先断开现有链接</span>
      <span class="token function">osDelay</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> <span class="token number">11</span><span class="token operator">:</span>
      <span class="token function">HAL_UART_Transmit</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>huart2<span class="token punctuation">,</span> <span class="token string">"AT+TCMQTTCONN=1,5000,240,0,1\r\n"</span><span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span><span class="token string">"AT+TCMQTTCONN=1,5000,240,0,1\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">5000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">osDelay</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> <span class="token number">12</span><span class="token operator">:</span> <span class="token comment">//检查是否已经连接</span>
      <span class="token function">HAL_UART_Transmit</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>huart2<span class="token punctuation">,</span> <span class="token string">"AT+TCMQTTSTATE?\r\n"</span><span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span><span class="token string">"AT+TCMQTTSTATE?\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">5000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">osDelay</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> <span class="token number">13</span><span class="token operator">:</span> <span class="token comment">//订阅主题</span>
      <span class="token function">sprintf</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>device_massage<span class="token punctuation">,</span> <span class="token string">"AT+TCMQTTSUB=\"$thing/down/property/%s/%s\",0\r\n"</span><span class="token punctuation">,</span> PRODUCT_ID<span class="token punctuation">,</span> DEVUICE_NAME<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">HAL_UART_Transmit</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>huart2<span class="token punctuation">,</span> device_massage<span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>device_massage<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">5000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">osDelay</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">default</span><span class="token operator">:</span>
      esp8266data<span class="token punctuation">.</span>flag <span class="token operator">=</span> <span class="token number">16</span><span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>esp8266data<span class="token punctuation">.</span>flag <span class="token operator">&lt;</span> <span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">free</span><span class="token punctuation">(</span>device_massage<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <h2>
     <a id="JSONLED_226">
     </a>
     七、处理JSON数据并控制LED
    </h2>
    <p>
     博主的腾讯云下发的数据在ESP8266中的打印是这样的：
    </p>
    <pre><code>+TCMQTTRCVPUB:"$thing/down/property/C9N29PAEXK/LED",105,
"{"method":"control","clientToken":"clientToken-d4c2c848-b930-44e7-bc4f-55c0226b0907","params":{"led1":1}}"
</code></pre>
    <h3>
     <a id="1Topic_JSON_232">
     </a>
     1.分割出Topic 和JSON数据
    </h3>
    <p>
     根据打印出来的信息可以看出，只要使用字符串操作就能轻松分割出Topic和JSON:
    </p>
    <pre><code class="prism language-c"><span class="token keyword">void</span> <span class="token function">loTMessageHandler</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">char</span> <span class="token operator">*</span>pub_buf<span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>TCMQTTRCVPUB <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//分离出Topic</span>
        pub_buf <span class="token operator">=</span> <span class="token function">strstr</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>TCMQTTRCVPUB<span class="token punctuation">,</span> <span class="token string">"$thing/down/property"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>pub_buf <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">*</span>pub_buf <span class="token operator">!=</span> <span class="token string">'\"'</span><span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                Sub_Topic<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">*</span>pub_buf<span class="token operator">++</span><span class="token punctuation">;</span>
                i<span class="token operator">++</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">LOT_Debug</span></span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Topic=%s\r\n"</span><span class="token punctuation">,</span> Sub_Topic<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
        <span class="token punctuation">}</span>
        <span class="token comment">//分离出数据</span>
        pub_buf <span class="token operator">=</span> <span class="token function">strstr</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>TCMQTTRCVPUB<span class="token punctuation">,</span> <span class="token string">"{\"method\":\"control\""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>pub_buf <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">*</span>pub_buf <span class="token operator">!=</span> <span class="token string">'\n'</span><span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                Sub_Data<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">*</span>pub_buf<span class="token operator">++</span><span class="token punctuation">;</span>
                i<span class="token operator">++</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">//去掉结尾的双引号</span>
            Sub_Data<span class="token punctuation">[</span>i <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'\0'</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">LOT_Debug</span></span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Data=%s\r\n"</span><span class="token punctuation">,</span> Sub_Data<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

            i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

</code></pre>
    <h3>
     <a id="2JSON_276">
     </a>
     2.JSON数据处理
    </h3>
    <p>
     处理JSON数据，大家可以去下载cJSON的库，就两个文件，cJSON.c和cJSON.h:
     <a href="https://sourceforge.net/projects/cjson/" rel="nofollow">
      cJson官网下载
     </a>
     ；把这两个文件加入到自己的工程中，引用一下头文件即可，下面是我代码：
    </p>
    <pre><code class="prism language-c">oid <span class="token function">cJsonMessageHandler</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> <span class="token operator">*</span>cJsonDATA<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>cJsonDATA <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        cJSON <span class="token operator">*</span>_JsonRoot <span class="token operator">=</span> <span class="token function">cJSON_Parse</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>cJsonDATA<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>_JsonRoot <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
            <span class="token keyword">goto</span> __cJSON_Delete<span class="token punctuation">;</span>

        cJSON <span class="token operator">*</span>cJSON_params <span class="token operator">=</span> <span class="token function">cJSON_GetObjectItem</span><span class="token punctuation">(</span>_JsonRoot<span class="token punctuation">,</span> <span class="token string">"params"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>cJSON_params <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
            <span class="token keyword">goto</span> __cJSON_Delete<span class="token punctuation">;</span>

        cJSON <span class="token operator">*</span>cJSON_led1 <span class="token operator">=</span> <span class="token function">cJSON_GetObjectItem</span><span class="token punctuation">(</span>cJSON_params<span class="token punctuation">,</span> <span class="token string">"led1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">LOT_Debug</span></span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"led1=%d\r\n"</span><span class="token punctuation">,</span> cJSON_led1<span class="token operator">-&gt;</span>valueint<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>cJSON_led1<span class="token operator">-&gt;</span>valueint <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span>
            <span class="token function">HAL_GPIO_WritePin</span><span class="token punctuation">(</span>LED_GPIO_Port<span class="token punctuation">,</span> LED_Pin<span class="token punctuation">,</span> GPIO_PIN_RESET<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//亮灯</span>
        <span class="token keyword">else</span>
            <span class="token function">HAL_GPIO_WritePin</span><span class="token punctuation">(</span>LED_GPIO_Port<span class="token punctuation">,</span> LED_Pin<span class="token punctuation">,</span> GPIO_PIN_SET<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//关灯</span>
    __cJSON_Delete<span class="token operator">:</span>
        <span class="token function">cJSON_Delete</span><span class="token punctuation">(</span>_JsonRoot<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">memset</span><span class="token punctuation">(</span>Sub_Data<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>Sub_Data<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <h2>
     <a id="AppLED_306">
     </a>
     八、腾讯连连App控制LED灯演示
    </h2>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/9b25d23ebe71ca75da869838287ea62f.gif#pic_center"/>
    </p>
    <h3>
     <a id="_308">
     </a>
     源码请到转跳：
    </h3>
    <p>
     <a href="https://blog.csdn.net/qq1140920745/article/details/116591996">
      【STM32+ESP8266连接腾讯云物联网开发平台 3】STM32+ESP8266-01S在腾讯云上动态注册设备(AT指令方式)–附带源码
     </a>
    </p>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f626c:6f672e6373646e2e6e65742f7171313134303932303734352f:61727469636c652f64657461696c732f313136353434353531" class_="artid" style="display:none">
 </p>
</div>


