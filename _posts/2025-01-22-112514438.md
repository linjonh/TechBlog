---
layout: post
title: "STM32使用硬件SPI驱动RC522门禁模块"
date: 2025-01-22 19:32:27 +0800
description: "0、前言RC522射频门禁识别模块非常常用，某宝卖家提供的程序基本都是使用软件模拟SPI的方式进行驱"
keywords: "id.once"
categories: ['Stm']
tags: ['物联网', '嵌入式', '单片机', 'Stm']
artid: "112514438"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=112514438
    alt: "STM32使用硬件SPI驱动RC522门禁模块"
render_with_liquid: false
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     STM32使用硬件SPI驱动RC522门禁模块
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <h2>
     <a id="0_0">
     </a>
     0、前言
    </h2>
    <p>
     RC522射频门禁识别模块非常常用，某宝卖家提供的程序基本都是使用软件模拟SPI的方式进行驱动的，但是实测使用软件模拟SPI识别速率、准确性没有硬件SPI驱动时高，因此本篇博客用于记录使用STM32硬件SPI驱动RC522门禁模块。
    </p>
    <h2>
     <a id="1_2">
     </a>
     1、硬件连接
    </h2>
    <ul>
     <li>
      单片机：STM32F103RCT6
     </li>
     <li>
      硬件接口：SPI2
     </li>
    </ul>
    <blockquote>
     <p>
      MISO -&gt; PB14 (主机输入，从机输出)
      <br/>
      MOSI -&gt; PB15 (主机输出，从机输入)
      <br/>
      SCK -&gt; PB13 (时钟信号SCLK)
      <br/>
      SDA -&gt; PC7 (片选NSS)
      <br/>
      RST -&gt; PC8 (复位)
     </p>
    </blockquote>
    <blockquote>
     <p>
      IRQ中断引脚悬空，不连接
     </p>
    </blockquote>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/69a65463484df2e6ee79788d9ce7c98c.png#pic_center">
      <br/>
      <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/f2575f5cb2aa7e9c6db9807efcb6d2e8.png#pic_center">
       <br/>
       <strong>
        说明
       </strong>
       <br/>
       手册上说明RC522芯片是支持SPI、IIC、串口的。
       <br/>
       当使用SPI接口时，
       <strong>
        SDA相当于NSS
       </strong>
       ，也就是SPI的片选。
       <br/>
       <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/eb476faceed4e2f210eb598f714c6cea.png#pic_center"/>
      </img>
     </img>
    </p>
    <h2>
     <a id="2_19">
     </a>
     2、驱动代码
    </h2>
    <p>
     使用标准库，由野火模拟SPI驱动代码修改测试得来，讲解一些需要注意的地方。
    </p>
    <h3>
     <a id="21__22">
     </a>
     2.1 引脚初始化
    </h3>
    <ul>
     <li>
      片选和复位信号引脚：推挽输出
     </li>
     <li>
      SPI2的引脚是用作SPI通讯功能，所以设置为
      <strong>
       复用推挽输出
      </strong>
     </li>
    </ul>
    <pre><code class="prism language-c"><span class="token comment">/**
  * @Name    RC522_GPIO_Init
  * @brief   初始化RC522 GPIO引脚
  * @param   None
  * @retval
  * @author  NameisBoy
  * @Data    2020-09-04
 **/</span>
<span class="token keyword">void</span> <span class="token function">RC522_GPIO_Init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	GPIO_InitTypeDef GPIO_InitStructure<span class="token punctuation">;</span>
 	<span class="token function">RCC_APB2PeriphClockCmd</span><span class="token punctuation">(</span>	RCC_APB2Periph_GPIOB <span class="token operator">|</span> RCC_APB2Periph_GPIOC<span class="token punctuation">,</span> ENABLE <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//PORTB时钟使能 </span>
	
	<span class="token comment">// NSS PC7  设置推挽输出</span>
	<span class="token comment">// RST PC8</span>
    GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Pin <span class="token operator">=</span> GPIO_Pin_7 <span class="token operator">|</span> GPIO_Pin_8<span class="token punctuation">;</span>	 
    GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Mode <span class="token operator">=</span> GPIO_Mode_Out_PP<span class="token punctuation">;</span> 		 <span class="token comment">//推挽输出</span>
    GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Speed <span class="token operator">=</span> GPIO_Speed_50MHz<span class="token punctuation">;</span>		 <span class="token comment">//IO口速度为50MHz</span>
    <span class="token function">GPIO_Init</span><span class="token punctuation">(</span>GPIOC<span class="token punctuation">,</span> <span class="token operator">&amp;</span>GPIO_InitStructure<span class="token punctuation">)</span><span class="token punctuation">;</span>					 <span class="token comment">//根据设定参数初始化</span>
    
    <span class="token comment">// SCK  PB13 设置复用推完输出</span>
	<span class="token comment">// MISO PB14</span>
	<span class="token comment">// MOSI	PB15</span>
    GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Pin <span class="token operator">=</span> GPIO_Pin_13<span class="token operator">|</span>GPIO_Pin_14<span class="token operator">|</span>GPIO_Pin_15<span class="token punctuation">;</span>	 
    GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Mode <span class="token operator">=</span> GPIO_Mode_AF_PP<span class="token punctuation">;</span> 		 <span class="token comment">//复用推挽输出</span>
    GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Speed <span class="token operator">=</span> GPIO_Speed_50MHz<span class="token punctuation">;</span>		 <span class="token comment">//IO口速度为50MHz</span>
	<span class="token function">GPIO_Init</span><span class="token punctuation">(</span>GPIOB<span class="token punctuation">,</span> <span class="token operator">&amp;</span>GPIO_InitStructure<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <h3>
     <a id="22_SPI2__55">
     </a>
     2.2 SPI2 初始化
    </h3>
    <p>
     这部分非常重要，特别是SPI时钟极性和相位的部分，需要对照手册的说明配置。
    </p>
    <ul>
     <li>
      双向通信，使用双线全双工；
     </li>
     <li>
      STM32作为主机，设置主机模式；
     </li>
     <li>
      数据位8bit；
     </li>
     <li>
      第一位数据，先传高位，也就是MSB；
      <br/>
      <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/d04b336d93044db6a034dd3e6a7cc53d.png#pic_center">
       <br/>
       <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/01fa3ef13371691f85536d5d833d60ac.png#pic_center"/>
      </img>
     </li>
     <li>
      时钟极性（CPOL）：手册没有说明空闲电平是0还是1，测试后为0，即低电平；
     </li>
     <li>
      时钟相位（CPHA）：CPHA=1，奇数边沿采样；
     </li>
    </ul>
    <p>
     手册没有给出spi通信的
     <strong>
      时序图
     </strong>
     ，只有这样一段话：
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/5ca46589b0b367836ae1f8151b409004.png#pic_center">
      <br/>
      根据这句话：
      <br/>
      假设CPOL=0，即空闲电平为低电平，此时上升沿为奇数边沿。手册表明时钟上升沿采样数据保持不变，即在奇数边沿进行采样，推出CPHA=0。因此
      <code>
       SPI_CPHA
      </code>
      设置为
      <strong>
       1Edge
      </strong>
      。
      <br/>
      SPI时钟极性相位时序参考下图：
      <br/>
      <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/64026ac91739de4dba807eaec648038d.png#pic_center">
       <br/>
       <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/5ebb67d1c51f45ae9c5d16f1c3f72c01.png#pic_center"/>
      </img>
     </img>
    </p>
    <ul>
     <li>
      NSS片选：软件控制；
     </li>
     <li>
      时钟速率：由PCLK1=36MHz分频而来，手册没有说明时钟速率，测试发现设置分频为2、4、8、16…256都是可以的。
     </li>
     <li>
      CRC 校验多项式：提高通信可靠性， 大于 1 即可，实测不设置也是可以的。
     </li>
    </ul>
    <p>
     <strong>
      最终代码
     </strong>
     ：
    </p>
    <pre><code class="prism language-c"><span class="token comment">/* 函数名：SPI2_Init
 * 描述  ：初始化SPI1的配置
 * 输入  ：无
 * 返回  : 无
 * 调用  ：外部调用              */</span>
<span class="token keyword">void</span> SPI2_Init <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>	
<span class="token punctuation">{<!-- --></span>
	SPI_InitTypeDef  SPI_InitStructure<span class="token punctuation">;</span>
	<span class="token comment">//置高CS片选，失能 </span>
	<span class="token function">RC522_CS_Disable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//失能SPI2</span>
	<span class="token function">SPI_Cmd</span><span class="token punctuation">(</span>SPI2 <span class="token punctuation">,</span> DISABLE<span class="token punctuation">)</span><span class="token punctuation">;</span> 
	<span class="token comment">//使能时钟线</span>
	<span class="token function">RCC_APB1PeriphClockCmd</span><span class="token punctuation">(</span>RCC_APB1Periph_SPI2<span class="token punctuation">,</span> ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//spi2配置</span>
	SPI_InitStructure<span class="token punctuation">.</span>SPI_Direction <span class="token operator">=</span> SPI_Direction_2Lines_FullDuplex<span class="token punctuation">;</span>  <span class="token comment">//全双工；</span>
    SPI_InitStructure<span class="token punctuation">.</span>SPI_Mode <span class="token operator">=</span> SPI_Mode_Master<span class="token punctuation">;</span>  <span class="token comment">//主机模式；</span>
    SPI_InitStructure<span class="token punctuation">.</span>SPI_DataSize <span class="token operator">=</span> SPI_DataSize_8b<span class="token punctuation">;</span>  <span class="token comment">//传输数据为8位；</span>
    SPI_InitStructure<span class="token punctuation">.</span>SPI_CPOL <span class="token operator">=</span> SPI_CPOL_Low<span class="token punctuation">;</span>  <span class="token comment">//时钟极性CPOL为空闲时低电平；</span>
    SPI_InitStructure<span class="token punctuation">.</span>SPI_CPHA <span class="token operator">=</span> SPI_CPHA_1Edge<span class="token punctuation">;</span>   <span class="token comment">//时钟采样点为时钟奇数沿（上升沿）；</span>
    SPI_InitStructure<span class="token punctuation">.</span>SPI_NSS <span class="token operator">=</span> SPI_NSS_Soft<span class="token punctuation">;</span>  <span class="token comment">//NSS引脚由软件改变；</span>
    SPI_InitStructure<span class="token punctuation">.</span>SPI_BaudRatePrescaler <span class="token operator">=</span> SPI_BaudRatePrescaler_256<span class="token punctuation">;</span><span class="token comment">//预分频系数64；</span>
    SPI_InitStructure<span class="token punctuation">.</span>SPI_FirstBit <span class="token operator">=</span> SPI_FirstBit_MSB<span class="token punctuation">;</span><span class="token comment">//MSB先行模式；</span>
    SPI_InitStructure<span class="token punctuation">.</span>SPI_CRCPolynomial <span class="token operator">=</span> <span class="token number">7</span><span class="token punctuation">;</span><span class="token comment">//CRC校验；</span>
	<span class="token comment">//初始化SPI2</span>
    <span class="token function">SPI_Init</span><span class="token punctuation">(</span>SPI2 <span class="token punctuation">,</span> <span class="token operator">&amp;</span>SPI_InitStructure<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//使能SPI2</span>
	<span class="token function">SPI_Cmd</span><span class="token punctuation">(</span>SPI2 <span class="token punctuation">,</span> ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span> 
 <span class="token punctuation">}</span>
</code></pre>
    <h3>
     <a id="23__110">
     </a>
     2.3 读写卡
    </h3>
    <p>
     主要有5个步骤：
    </p>
    <ul>
     <li>
      寻卡
     </li>
     <li>
      防冲突
     </li>
     <li>
      选卡
     </li>
     <li>
      认证
     </li>
     <li>
      读/写卡
     </li>
    </ul>
    <p>
     <strong>
      流程图
     </strong>
     ：
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/175c5906f2b4109b794da7ae38313f86.png#pic_center"/>
     <br/>
     参考博客：
     <a href="https://blog.csdn.net/chisichan7657/article/details/100859319?utm_medium=distribute.pc_relevant.none-task-blog-BlogCommendFromMachineLearnPai2-1.channel_param&amp;depth_1-utm_source=distribute.pc_relevant.none-task-blog-BlogCommendFromMachineLearnPai2-1.channel_param">
      https://blog.csdn.net/chisichan7657/article/details/100859319?utm_medium=distribute.pc_relevant.none-task-blog-BlogCommendFromMachineLearnPai2-1.channel_param&amp;depth_1-utm_source=distribute.pc_relevant.none-task-blog-BlogCommendFromMachineLearnPai2-1.channel_param
     </a>
    </p>
    <h3>
     <a id="24_ID_121">
     </a>
     2.4 读卡ID
    </h3>
    <ul>
     <li>
      读取UID实例：
      <br/>
      <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/f01f90a87ab3c450b1564b8d614bf18c.png#pic_center"/>
      <br/>
      <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/2b57de39b8e5575a553d9ecea057e43c.png#pic_center"/>
     </li>
    </ul>
    <p>
     <code>
      RC522_Read_ID_Once
     </code>
     函数：
     <br/>
     只读卡ID不需要进行验证，防冲撞时即可读取卡片的ID号。
    </p>
    <pre><code class="prism language-c"><span class="token keyword">void</span> <span class="token function">RC522_Read_ID_Once</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>cardID<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">char</span> Str1<span class="token punctuation">[</span><span class="token number">20</span><span class="token punctuation">]</span><span class="token punctuation">,</span>Str2<span class="token punctuation">[</span><span class="token number">20</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	u8 card_type<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">//卡片类型，2字节</span>
	u8 card_ID<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">//卡序列号</span>
	u8 statusRt<span class="token punctuation">;</span>
	<span class="token comment">//PcdAntennaOn();</span>
	statusRt <span class="token operator">=</span> <span class="token function">PcdRequest</span><span class="token punctuation">(</span>PICC_REQIDL<span class="token punctuation">,</span> card_type<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//寻未进入休眠的卡</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>statusRt <span class="token operator">==</span> MI_OK<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span><span class="token comment">//寻卡成功</span>
		<span class="token comment">//printf("寻卡成功~！\r\n");</span>
		sprintf <span class="token punctuation">(</span> Str1<span class="token punctuation">,</span> <span class="token string">"card_type: %02X%02X"</span><span class="token punctuation">,</span>
					card_type <span class="token punctuation">[</span> <span class="token number">0</span> <span class="token punctuation">]</span><span class="token punctuation">,</span>
					card_type <span class="token punctuation">[</span> <span class="token number">1</span> <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">//printf ( "%s\r\n",Str1); </span>
		<span class="token keyword">if</span><span class="token punctuation">(</span> PcdAnticoll <span class="token punctuation">(</span>card_ID<span class="token punctuation">)</span> <span class="token operator">==</span> MI_OK<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span><span class="token comment">//防冲撞成功</span>
			sprintf <span class="token punctuation">(</span> Str2<span class="token punctuation">,</span> <span class="token string">"The Card ID is: %02X%02X%02X%02X"</span><span class="token punctuation">,</span>
					card_ID <span class="token punctuation">[</span> <span class="token number">0</span> <span class="token punctuation">]</span><span class="token punctuation">,</span>
					card_ID <span class="token punctuation">[</span> <span class="token number">1</span> <span class="token punctuation">]</span><span class="token punctuation">,</span>
					card_ID <span class="token punctuation">[</span> <span class="token number">2</span> <span class="token punctuation">]</span><span class="token punctuation">,</span>
					card_ID <span class="token punctuation">[</span> <span class="token number">3</span> <span class="token punctuation">]</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token comment">//printf ( "%s\r\n",Str2); </span>
			<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">PcdSelect</span><span class="token punctuation">(</span>card_ID<span class="token punctuation">)</span> <span class="token operator">==</span> MI_OK<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
				<span class="token comment">//printf("选卡成功！\r\n");</span>
				<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">PcdHalt</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> MI_OK<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
					<span class="token comment">//printf("休眠成功！\r\n");</span>
					sprintf <span class="token punctuation">(</span> cardID<span class="token punctuation">,</span> <span class="token string">"%02X%02X%02X%02X"</span><span class="token punctuation">,</span> card_ID <span class="token punctuation">[</span> <span class="token number">0</span> <span class="token punctuation">]</span><span class="token punctuation">,</span> card_ID <span class="token punctuation">[</span> <span class="token number">1</span> <span class="token punctuation">]</span><span class="token punctuation">,</span> card_ID <span class="token punctuation">[</span> <span class="token number">2</span> <span class="token punctuation">]</span><span class="token punctuation">,</span> card_ID <span class="token punctuation">[</span> <span class="token number">3</span> <span class="token punctuation">]</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token comment">//printf("read suc!\r\n");</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <h3>
     <a id="25__162">
     </a>
     2.5 完整驱动代码
    </h3>
    <h4>
     <a id="rc522h_163">
     </a>
     <code>
      rc522.h
     </code>
     :
    </h4>
    <pre><code class="prism language-c"><span class="token macro property">#<span class="token directive keyword">ifndef</span> __RC522_H</span>
<span class="token macro property">#<span class="token directive keyword">define</span> __RC522_H	</span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"stm32f10x.h"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"stm32f10x_spi.h"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>

<span class="token comment">/*******************************
*连线说明：
*1--SDA  &lt;-----&gt;PA4
*2--SCK  &lt;-----&gt;PA5
*3--MOSI &lt;-----&gt;PA7
*4--MISO &lt;-----&gt;PA6
*5--悬空
*6--GND &lt;-----&gt;GND
*7--RST &lt;-----&gt;PB0
*8--VCC &lt;-----&gt;VCC
************************************/</span>

<span class="token comment">//MF522命令代码</span>
<span class="token macro property">#<span class="token directive keyword">define</span> PCD_IDLE              0x00               </span><span class="token comment">//取消当前命令</span>
<span class="token macro property">#<span class="token directive keyword">define</span> PCD_AUTHENT           0x0E               </span><span class="token comment">//验证密钥</span>
<span class="token macro property">#<span class="token directive keyword">define</span> PCD_RECEIVE           0x08               </span><span class="token comment">//接收数据</span>
<span class="token macro property">#<span class="token directive keyword">define</span> PCD_TRANSMIT          0x04               </span><span class="token comment">//发送数据</span>
<span class="token macro property">#<span class="token directive keyword">define</span> PCD_TRANSCEIVE        0x0C               </span><span class="token comment">//发送并接收数据</span>
<span class="token macro property">#<span class="token directive keyword">define</span> PCD_RESETPHASE        0x0F               </span><span class="token comment">//复位</span>
<span class="token macro property">#<span class="token directive keyword">define</span> PCD_CALCCRC           0x03               </span><span class="token comment">//CRC计算</span>

<span class="token comment">//Mifare_One卡片命令代码</span>
<span class="token macro property">#<span class="token directive keyword">define</span> PICC_REQIDL           0x26               </span><span class="token comment">//寻天线区内未进入休眠状态</span>
<span class="token macro property">#<span class="token directive keyword">define</span> PICC_REQALL           0x52               </span><span class="token comment">//寻天线区内全部卡</span>
<span class="token macro property">#<span class="token directive keyword">define</span> PICC_ANTICOLL1        0x93               </span><span class="token comment">//防冲撞</span>
<span class="token macro property">#<span class="token directive keyword">define</span> PICC_ANTICOLL2        0x95               </span><span class="token comment">//防冲撞</span>
<span class="token macro property">#<span class="token directive keyword">define</span> PICC_AUTHENT1A        0x60               </span><span class="token comment">//验证A密钥</span>
<span class="token macro property">#<span class="token directive keyword">define</span> PICC_AUTHENT1B        0x61               </span><span class="token comment">//验证B密钥</span>
<span class="token macro property">#<span class="token directive keyword">define</span> PICC_READ             0x30               </span><span class="token comment">//读块</span>
<span class="token macro property">#<span class="token directive keyword">define</span> PICC_WRITE            0xA0               </span><span class="token comment">//写块</span>
<span class="token macro property">#<span class="token directive keyword">define</span> PICC_DECREMENT        0xC0               </span><span class="token comment">//扣款</span>
<span class="token macro property">#<span class="token directive keyword">define</span> PICC_INCREMENT        0xC1               </span><span class="token comment">//充值</span>
<span class="token macro property">#<span class="token directive keyword">define</span> PICC_RESTORE          0xC2               </span><span class="token comment">//调块数据到缓冲区</span>
<span class="token macro property">#<span class="token directive keyword">define</span> PICC_TRANSFER         0xB0               </span><span class="token comment">//保存缓冲区中数据</span>
<span class="token macro property">#<span class="token directive keyword">define</span> PICC_HALT             0x50               </span><span class="token comment">//休眠</span>

<span class="token macro property">#<span class="token directive keyword">define</span> DEF_FIFO_LENGTH       64                 </span><span class="token comment">//FIFO size=64byte</span>
<span class="token macro property">#<span class="token directive keyword">define</span> MAXRLEN  18</span>

<span class="token comment">//MF522寄存器定义</span>

<span class="token comment">// PAGE 0</span>
<span class="token macro property">#<span class="token directive keyword">define</span>     RFU00                 0x00    </span>
<span class="token macro property">#<span class="token directive keyword">define</span>     CommandReg            0x01    </span>
<span class="token macro property">#<span class="token directive keyword">define</span>     ComIEnReg             0x02    </span>
<span class="token macro property">#<span class="token directive keyword">define</span>     DivlEnReg             0x03    </span>
<span class="token macro property">#<span class="token directive keyword">define</span>     ComIrqReg             0x04    </span>
<span class="token macro property">#<span class="token directive keyword">define</span>     DivIrqReg             0x05</span>
<span class="token macro property">#<span class="token directive keyword">define</span>     ErrorReg              0x06    </span>
<span class="token macro property">#<span class="token directive keyword">define</span>     Status1Reg            0x07    </span>
<span class="token macro property">#<span class="token directive keyword">define</span>     Status2Reg            0x08    </span>
<span class="token macro property">#<span class="token directive keyword">define</span>     FIFODataReg           0x09</span>
<span class="token macro property">#<span class="token directive keyword">define</span>     FIFOLevelReg          0x0A</span>
<span class="token macro property">#<span class="token directive keyword">define</span>     WaterLevelReg         0x0B</span>
<span class="token macro property">#<span class="token directive keyword">define</span>     ControlReg            0x0C</span>
<span class="token macro property">#<span class="token directive keyword">define</span>     BitFramingReg         0x0D</span>
<span class="token macro property">#<span class="token directive keyword">define</span>     CollReg               0x0E</span>
<span class="token macro property">#<span class="token directive keyword">define</span>     RFU0F                 0x0F</span>
<span class="token comment">// PAGE 1     </span>
<span class="token macro property">#<span class="token directive keyword">define</span>     RFU10                 0x10</span>
<span class="token macro property">#<span class="token directive keyword">define</span>     ModeReg               0x11</span>
<span class="token macro property">#<span class="token directive keyword">define</span>     TxModeReg             0x12</span>
<span class="token macro property">#<span class="token directive keyword">define</span>     RxModeReg             0x13</span>
<span class="token macro property">#<span class="token directive keyword">define</span>     TxControlReg          0x14</span>
<span class="token macro property">#<span class="token directive keyword">define</span>     TxAutoReg             0x15</span>
<span class="token macro property">#<span class="token directive keyword">define</span>     TxSelReg              0x16</span>
<span class="token macro property">#<span class="token directive keyword">define</span>     RxSelReg              0x17</span>
<span class="token macro property">#<span class="token directive keyword">define</span>     RxThresholdReg        0x18</span>
<span class="token macro property">#<span class="token directive keyword">define</span>     DemodReg              0x19</span>
<span class="token macro property">#<span class="token directive keyword">define</span>     RFU1A                 0x1A</span>
<span class="token macro property">#<span class="token directive keyword">define</span>     RFU1B                 0x1B</span>
<span class="token macro property">#<span class="token directive keyword">define</span>     MifareReg             0x1C</span>
<span class="token macro property">#<span class="token directive keyword">define</span>     RFU1D                 0x1D</span>
<span class="token macro property">#<span class="token directive keyword">define</span>     RFU1E                 0x1E</span>
<span class="token macro property">#<span class="token directive keyword">define</span>     SerialSpeedReg        0x1F</span>
<span class="token comment">// PAGE 2    </span>
<span class="token macro property">#<span class="token directive keyword">define</span>     RFU20                 0x20  </span>
<span class="token macro property">#<span class="token directive keyword">define</span>     CRCResultRegM         0x21</span>
<span class="token macro property">#<span class="token directive keyword">define</span>     CRCResultRegL         0x22</span>
<span class="token macro property">#<span class="token directive keyword">define</span>     RFU23                 0x23</span>
<span class="token macro property">#<span class="token directive keyword">define</span>     ModWidthReg           0x24</span>
<span class="token macro property">#<span class="token directive keyword">define</span>     RFU25                 0x25</span>
<span class="token macro property">#<span class="token directive keyword">define</span>     RFCfgReg              0x26</span>
<span class="token macro property">#<span class="token directive keyword">define</span>     GsNReg                0x27</span>
<span class="token macro property">#<span class="token directive keyword">define</span>     CWGsCfgReg            0x28</span>
<span class="token macro property">#<span class="token directive keyword">define</span>     ModGsCfgReg           0x29</span>
<span class="token macro property">#<span class="token directive keyword">define</span>     TModeReg              0x2A</span>
<span class="token macro property">#<span class="token directive keyword">define</span>     TPrescalerReg         0x2B</span>
<span class="token macro property">#<span class="token directive keyword">define</span>     TReloadRegH           0x2C</span>
<span class="token macro property">#<span class="token directive keyword">define</span>     TReloadRegL           0x2D</span>
<span class="token macro property">#<span class="token directive keyword">define</span>     TCounterValueRegH     0x2E</span>
<span class="token macro property">#<span class="token directive keyword">define</span>     TCounterValueRegL     0x2F</span>
<span class="token comment">// PAGE 3      </span>
<span class="token macro property">#<span class="token directive keyword">define</span>     RFU30                 0x30</span>
<span class="token macro property">#<span class="token directive keyword">define</span>     TestSel1Reg           0x31</span>
<span class="token macro property">#<span class="token directive keyword">define</span>     TestSel2Reg           0x32</span>
<span class="token macro property">#<span class="token directive keyword">define</span>     TestPinEnReg          0x33</span>
<span class="token macro property">#<span class="token directive keyword">define</span>     TestPinValueReg       0x34</span>
<span class="token macro property">#<span class="token directive keyword">define</span>     TestBusReg            0x35</span>
<span class="token macro property">#<span class="token directive keyword">define</span>     AutoTestReg           0x36</span>
<span class="token macro property">#<span class="token directive keyword">define</span>     VersionReg            0x37</span>
<span class="token macro property">#<span class="token directive keyword">define</span>     AnalogTestReg         0x38</span>
<span class="token macro property">#<span class="token directive keyword">define</span>     TestDAC1Reg           0x39  </span>
<span class="token macro property">#<span class="token directive keyword">define</span>     TestDAC2Reg           0x3A   </span>
<span class="token macro property">#<span class="token directive keyword">define</span>     TestADCReg            0x3B   </span>
<span class="token macro property">#<span class="token directive keyword">define</span>     RFU3C                 0x3C   </span>
<span class="token macro property">#<span class="token directive keyword">define</span>     RFU3D                 0x3D   </span>
<span class="token macro property">#<span class="token directive keyword">define</span>     RFU3E                 0x3E   </span>
<span class="token macro property">#<span class="token directive keyword">define</span>     RFU3F		  		  0x3F</span>

<span class="token comment">//和RC522通讯时返回的M1卡状态</span>
<span class="token macro property">#<span class="token directive keyword">define</span> 	MI_OK                 0x26</span>
<span class="token macro property">#<span class="token directive keyword">define</span> 	MI_NOTAGERR           0xcc</span>
<span class="token macro property">#<span class="token directive keyword">define</span> 	MI_ERR                0xbb</span>

<span class="token comment">//和MF522通讯时返回的错误代码</span>
<span class="token macro property">#<span class="token directive keyword">define</span>	    SHAQU1                0X01</span>
<span class="token macro property">#<span class="token directive keyword">define</span>  	KUAI4	              0X04</span>
<span class="token macro property">#<span class="token directive keyword">define</span> 	KUAI7	              0X07</span>
<span class="token macro property">#<span class="token directive keyword">define</span>	    REGCARD	              0xa1</span>
<span class="token macro property">#<span class="token directive keyword">define</span> 	CONSUME	              0xa2</span>
<span class="token macro property">#<span class="token directive keyword">define</span>     READCARD	          0xa3</span>
<span class="token macro property">#<span class="token directive keyword">define</span>     ADDMONEY	          0xa4</span>

<span class="token comment">//发送0x00读取数据</span>
<span class="token macro property">#<span class="token directive keyword">define</span> SPI_RC522_ReadByte()	      SPI_RC522_SendByte(0xFF) </span>

<span class="token comment">//#define SET_SPI_CS  (GPIOF-&gt;BSRR=0X01)</span>
<span class="token comment">//#define CLR_SPI_CS  (GPIOF-&gt;BRR=0X01)</span>

<span class="token comment">//#define SET_RC522RST  GPIOF-&gt;BSRR=0X02</span>
<span class="token comment">//#define CLR_RC522RST  GPIOF-&gt;BRR=0X02</span>


<span class="token comment">/***********************RC522 函数宏定义**********************/</span>
<span class="token macro property">#<span class="token directive keyword">define</span>          RC522_CS_Enable()         GPIO_ResetBits ( GPIOC, GPIO_Pin_7 )</span><span class="token comment">//片选</span>
<span class="token macro property">#<span class="token directive keyword">define</span>          RC522_CS_Disable()        GPIO_SetBits   ( GPIOC, GPIO_Pin_7 )</span>

<span class="token macro property">#<span class="token directive keyword">define</span>          RC522_Reset_Enable()      GPIO_ResetBits( GPIOC, GPIO_Pin_8 )</span><span class="token comment">//复位RST</span>
<span class="token macro property">#<span class="token directive keyword">define</span>          RC522_Reset_Disable()     GPIO_SetBits  ( GPIOC, GPIO_Pin_8 )</span>

<span class="token macro property">#<span class="token directive keyword">define</span>          RC522_SCK_0()             GPIO_ResetBits( GPIOB, GPIO_Pin_13 )</span>
<span class="token macro property">#<span class="token directive keyword">define</span>          RC522_SCK_1()             GPIO_SetBits  ( GPIOB, GPIO_Pin_13 )</span>

<span class="token macro property">#<span class="token directive keyword">define</span>          RC522_MOSI_0()            GPIO_ResetBits( GPIOB, GPIO_Pin_15 )</span>
<span class="token macro property">#<span class="token directive keyword">define</span>          RC522_MOSI_1()            GPIO_SetBits  ( GPIOB, GPIO_Pin_15 )</span>

<span class="token macro property">#<span class="token directive keyword">define</span>          RC522_MISO_GET()          GPIO_ReadInputDataBit ( GPIOB, GPIO_Pin_14 )</span>

<span class="token keyword">void</span> <span class="token function">RC522_Test</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">RC522_Read_ID_Once</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>cardID<span class="token punctuation">)</span><span class="token punctuation">;</span>
u8       SPI_RC522_SendByte         <span class="token punctuation">(</span> u8 byte<span class="token punctuation">)</span><span class="token punctuation">;</span>
u8       ReadRawRC                  <span class="token punctuation">(</span> u8 ucAddress <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span>     WriteRawRC                 <span class="token punctuation">(</span> u8 ucAddress<span class="token punctuation">,</span> u8 ucValue <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> 		 SPI2_Init									<span class="token punctuation">(</span> <span class="token keyword">void</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> 		 <span class="token function">RC522_GPIO_Init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span>     RC522_Handel               <span class="token punctuation">(</span> <span class="token keyword">void</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span>     RC522_Init                 <span class="token punctuation">(</span> <span class="token keyword">void</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>                       <span class="token comment">//初始化</span>
<span class="token keyword">void</span>     PcdReset                   <span class="token punctuation">(</span> <span class="token keyword">void</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>                       <span class="token comment">//复位</span>
<span class="token keyword">void</span>     M500PcdConfigISOType       <span class="token punctuation">(</span> u8 type <span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token comment">//工作方式</span>
<span class="token keyword">char</span>     PcdRequest                 <span class="token punctuation">(</span> u8 req_code<span class="token punctuation">,</span> u8 <span class="token operator">*</span> pTagType <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//寻卡</span>
<span class="token keyword">char</span>     PcdAnticoll                <span class="token punctuation">(</span> u8 <span class="token operator">*</span> pSnr<span class="token punctuation">)</span><span class="token punctuation">;</span>                   <span class="token comment">//防冲撞</span>

<span class="token keyword">void</span>     PcdAntennaOn               <span class="token punctuation">(</span> <span class="token keyword">void</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>                 <span class="token comment">//开启天线</span>
<span class="token keyword">void</span>     PcdAntennaOff              <span class="token punctuation">(</span> <span class="token keyword">void</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>                 <span class="token comment">//关闭天线</span>
<span class="token keyword">void</span>     SetBitMask                 <span class="token punctuation">(</span> u8 ucReg<span class="token punctuation">,</span> u8 ucMask <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span>     ClearBitMask               <span class="token punctuation">(</span> u8 ucReg<span class="token punctuation">,</span> u8 ucMask <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">char</span>     PcdSelect                  <span class="token punctuation">(</span> u8 <span class="token operator">*</span> pSnr <span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">//选择卡片</span>
<span class="token keyword">char</span>     PcdAuthState               <span class="token punctuation">(</span> u8 ucAuth_mode<span class="token punctuation">,</span> u8 ucAddr<span class="token punctuation">,</span> u8 <span class="token operator">*</span> pKey<span class="token punctuation">,</span> u8 <span class="token operator">*</span> pSnr <span class="token punctuation">)</span><span class="token punctuation">;</span>                                              <span class="token comment">//验证密码</span>
<span class="token keyword">char</span>     PcdWrite                   <span class="token punctuation">(</span> u8 ucAddr<span class="token punctuation">,</span> u8 <span class="token operator">*</span> pData <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">char</span>     PcdRead                    <span class="token punctuation">(</span> u8 ucAddr<span class="token punctuation">,</span> u8 <span class="token operator">*</span> pData <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span>     ShowID                     <span class="token punctuation">(</span> u16 x<span class="token punctuation">,</span>u16 y<span class="token punctuation">,</span> u8 <span class="token operator">*</span>p<span class="token punctuation">,</span> u16 charColor<span class="token punctuation">,</span> u16 bkColor<span class="token punctuation">)</span><span class="token punctuation">;</span>	 <span class="token comment">//显示卡的卡号，以十六进制显示</span>
<span class="token keyword">char</span>             PcdHalt            <span class="token punctuation">(</span> <span class="token keyword">void</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>           <span class="token comment">//命令卡片进入休眠状态</span>
<span class="token keyword">void</span>             CalulateCRC                <span class="token punctuation">(</span> u8 <span class="token operator">*</span> pIndata<span class="token punctuation">,</span> u8 ucLen<span class="token punctuation">,</span> u8 <span class="token operator">*</span> pOutData <span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token macro property">#<span class="token directive keyword">endif</span></span>

</code></pre>
    <h4>
     <a id="rc522c_351">
     </a>
     <code>
      rc522.c
     </code>
     :
    </h4>
    <pre><code class="prism language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"rc522.h"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"usart.h"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"delay.h"</span></span>

<span class="token comment">// M1卡分为16个扇区，每个扇区由四个块（块0、块1、块2、块3）组成</span>
<span class="token comment">// 将16个扇区的64个块按绝对地址编号为：0~63</span>
<span class="token comment">// 第0个扇区的块0（即绝对地址0块），用于存放厂商代码，已经固化不可更改 </span>
<span class="token comment">// 每个扇区的块0、块1、块2为数据块，可用于存放数据</span>
<span class="token comment">// 每个扇区的块3为控制块（绝对地址为:块3、块7、块11.....）包括密码A，存取控制、密码B等</span>

<span class="token comment">/*******************************
*连线说明：
*1--SDA（CS）  &lt;-----&gt;PC7
*2--SCK  &lt;-----&gt;PB13
*3--MOSI &lt;-----&gt;PB14
*4--MISO &lt;-----&gt;PB15
*5--悬空
*6--GND &lt;-----&gt;GND
*7--RST &lt;-----&gt;PC8
*8--VCC &lt;-----&gt;VCC
************************************/</span>

<span class="token macro property">#<span class="token directive keyword">define</span>   RC522_DELAY()  delay_us( 2 ) </span>

<span class="token comment">/*全局变量*/</span>
<span class="token keyword">unsigned</span> <span class="token keyword">char</span> CT<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>            <span class="token comment">//卡类型</span>
<span class="token keyword">unsigned</span> <span class="token keyword">char</span> SN<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span>            <span class="token comment">//卡号</span>
<span class="token keyword">unsigned</span> <span class="token keyword">char</span> RFID<span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">]</span><span class="token punctuation">;</span>			    <span class="token comment">//存放RFID </span>
<span class="token keyword">unsigned</span> <span class="token keyword">char</span> lxl_bit<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">unsigned</span> <span class="token keyword">char</span> card1_bit<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">unsigned</span> <span class="token keyword">char</span> card2_bit<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">unsigned</span> <span class="token keyword">char</span> card3_bit<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">unsigned</span> <span class="token keyword">char</span> card4_bit<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">unsigned</span> <span class="token keyword">char</span> total<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">unsigned</span> <span class="token keyword">char</span> lxl<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token punctuation">{<!-- --></span><span class="token number">196</span><span class="token punctuation">,</span><span class="token number">58</span><span class="token punctuation">,</span><span class="token number">104</span><span class="token punctuation">,</span><span class="token number">217</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">unsigned</span> <span class="token keyword">char</span> card_1<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token punctuation">{<!-- --></span><span class="token number">83</span><span class="token punctuation">,</span><span class="token number">106</span><span class="token punctuation">,</span><span class="token number">11</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">unsigned</span> <span class="token keyword">char</span> card_2<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token punctuation">{<!-- --></span><span class="token number">208</span><span class="token punctuation">,</span><span class="token number">121</span><span class="token punctuation">,</span><span class="token number">31</span><span class="token punctuation">,</span><span class="token number">57</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">unsigned</span> <span class="token keyword">char</span> card_3<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token punctuation">{<!-- --></span><span class="token number">176</span><span class="token punctuation">,</span><span class="token number">177</span><span class="token punctuation">,</span><span class="token number">143</span><span class="token punctuation">,</span><span class="token number">165</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">unsigned</span> <span class="token keyword">char</span> card_4<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token punctuation">{<!-- --></span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">158</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">136</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
u8 KEY<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token punctuation">{<!-- --></span><span class="token number">0xff</span><span class="token punctuation">,</span><span class="token number">0xff</span><span class="token punctuation">,</span><span class="token number">0xff</span><span class="token punctuation">,</span><span class="token number">0xff</span><span class="token punctuation">,</span><span class="token number">0xff</span><span class="token punctuation">,</span><span class="token number">0xff</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
u8 AUDIO_OPEN<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">0xAA</span><span class="token punctuation">,</span> <span class="token number">0x07</span><span class="token punctuation">,</span> <span class="token number">0x02</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x09</span><span class="token punctuation">,</span> <span class="token number">0xBC</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">unsigned</span> <span class="token keyword">char</span> RFID1<span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token punctuation">{<!-- --></span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0xff</span><span class="token punctuation">,</span><span class="token number">0x07</span><span class="token punctuation">,</span><span class="token number">0x80</span><span class="token punctuation">,</span><span class="token number">0x29</span><span class="token punctuation">,</span><span class="token number">0xff</span><span class="token punctuation">,</span><span class="token number">0xff</span><span class="token punctuation">,</span><span class="token number">0xff</span><span class="token punctuation">,</span><span class="token number">0xff</span><span class="token punctuation">,</span><span class="token number">0xff</span><span class="token punctuation">,</span><span class="token number">0xff</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">/*函数声明*/</span>
<span class="token keyword">unsigned</span> <span class="token keyword">char</span> status<span class="token punctuation">;</span>
<span class="token keyword">unsigned</span> <span class="token keyword">char</span> s<span class="token operator">=</span><span class="token number">0x08</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">RC522_Read_ID_Once</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>cardID<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">char</span> Str1<span class="token punctuation">[</span><span class="token number">20</span><span class="token punctuation">]</span><span class="token punctuation">,</span>Str2<span class="token punctuation">[</span><span class="token number">20</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	u8 card_type<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">//卡片类型，2字节</span>
	u8 card_ID<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">//卡序列号</span>
	u8 statusRt<span class="token punctuation">;</span>
	<span class="token comment">//PcdAntennaOn();</span>
	statusRt <span class="token operator">=</span> <span class="token function">PcdRequest</span><span class="token punctuation">(</span>PICC_REQIDL<span class="token punctuation">,</span> card_type<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//寻未进入休眠的卡</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>statusRt <span class="token operator">==</span> MI_OK<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span><span class="token comment">//寻卡成功</span>
		<span class="token comment">//printf("寻卡成功~！\r\n");</span>
		sprintf <span class="token punctuation">(</span> Str1<span class="token punctuation">,</span> <span class="token string">"card_type: %02X%02X"</span><span class="token punctuation">,</span>
					card_type <span class="token punctuation">[</span> <span class="token number">0</span> <span class="token punctuation">]</span><span class="token punctuation">,</span>
					card_type <span class="token punctuation">[</span> <span class="token number">1</span> <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">//printf ( "%s\r\n",Str1); </span>
		<span class="token keyword">if</span><span class="token punctuation">(</span> PcdAnticoll <span class="token punctuation">(</span>card_ID<span class="token punctuation">)</span> <span class="token operator">==</span> MI_OK<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span><span class="token comment">//防冲撞成功</span>
			sprintf <span class="token punctuation">(</span> Str2<span class="token punctuation">,</span> <span class="token string">"The Card ID is: %02X%02X%02X%02X"</span><span class="token punctuation">,</span>
					card_ID <span class="token punctuation">[</span> <span class="token number">0</span> <span class="token punctuation">]</span><span class="token punctuation">,</span>
					card_ID <span class="token punctuation">[</span> <span class="token number">1</span> <span class="token punctuation">]</span><span class="token punctuation">,</span>
					card_ID <span class="token punctuation">[</span> <span class="token number">2</span> <span class="token punctuation">]</span><span class="token punctuation">,</span>
					card_ID <span class="token punctuation">[</span> <span class="token number">3</span> <span class="token punctuation">]</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token comment">//printf ( "%s\r\n",Str2); </span>
			<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">PcdSelect</span><span class="token punctuation">(</span>card_ID<span class="token punctuation">)</span> <span class="token operator">==</span> MI_OK<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
				<span class="token comment">//printf("选卡成功！\r\n");</span>
				<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">PcdHalt</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> MI_OK<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
					<span class="token comment">//printf("休眠成功！\r\n");</span>
					sprintf <span class="token punctuation">(</span> cardID<span class="token punctuation">,</span> <span class="token string">"%02X%02X%02X%02X"</span><span class="token punctuation">,</span> card_ID <span class="token punctuation">[</span> <span class="token number">0</span> <span class="token punctuation">]</span><span class="token punctuation">,</span> card_ID <span class="token punctuation">[</span> <span class="token number">1</span> <span class="token punctuation">]</span><span class="token punctuation">,</span> card_ID <span class="token punctuation">[</span> <span class="token number">2</span> <span class="token punctuation">]</span><span class="token punctuation">,</span> card_ID <span class="token punctuation">[</span> <span class="token number">3</span> <span class="token punctuation">]</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
						<span class="token comment">//printf("read suc!\r\n");</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">/**
  * @Name    RC522_Test
  * @brief   读卡测试
  * @param   None
  * @retval
  * @author  NameisBoy
  * @Data    2020-09-04
 **/</span>
<span class="token keyword">void</span> <span class="token function">RC522_Test</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">char</span> cStr <span class="token punctuation">[</span> <span class="token number">30</span> <span class="token punctuation">]</span><span class="token punctuation">,</span> tStr<span class="token punctuation">[</span><span class="token number">30</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  uint8_t ucArray_ID <span class="token punctuation">[</span> <span class="token number">4</span> <span class="token punctuation">]</span><span class="token punctuation">;</span>   <span class="token comment">/*先后存放IC卡的类型和UID(IC卡序列号)*/</span>                                                                                          
	uint8_t ucStatusReturn<span class="token punctuation">;</span>     <span class="token comment">/*返回状态 */</span>  
  <span class="token keyword">while</span> <span class="token punctuation">(</span> <span class="token number">1</span> <span class="token punctuation">)</span>
  <span class="token punctuation">{<!-- --></span> 
    <span class="token comment">/*寻卡*/</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span> ucStatusReturn <span class="token operator">=</span> PcdRequest <span class="token punctuation">(</span> PICC_REQALL<span class="token punctuation">,</span> ucArray_ID <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token operator">!=</span> MI_OK <span class="token punctuation">)</span>  
       <span class="token comment">/*若失败再次寻卡*/</span>
			ucStatusReturn <span class="token operator">=</span> PcdRequest <span class="token punctuation">(</span> PICC_REQALL<span class="token punctuation">,</span> ucArray_ID <span class="token punctuation">)</span><span class="token punctuation">;</span>
			
			<span class="token keyword">if</span> <span class="token punctuation">(</span> ucStatusReturn <span class="token operator">==</span> MI_OK  <span class="token punctuation">)</span>
			<span class="token punctuation">{<!-- --></span>	
					sprintf <span class="token punctuation">(</span> tStr<span class="token punctuation">,</span> <span class="token string">"The Card Type is: %02X%02X"</span><span class="token punctuation">,</span>
										ucArray_ID <span class="token punctuation">[</span> <span class="token number">0</span> <span class="token punctuation">]</span><span class="token punctuation">,</span>
										ucArray_ID <span class="token punctuation">[</span> <span class="token number">1</span> <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
									
					printf <span class="token punctuation">(</span> <span class="token string">"%s\r\n"</span><span class="token punctuation">,</span>tStr <span class="token punctuation">)</span><span class="token punctuation">;</span> 		
				<span class="token comment">/*防冲撞（当有多张卡进入读写器操作范围时，防冲突机制会从其中选择一张进行操作）*/</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span> PcdAnticoll <span class="token punctuation">(</span> ucArray_ID <span class="token punctuation">)</span> <span class="token operator">==</span> MI_OK <span class="token punctuation">)</span>                                                                   
				<span class="token punctuation">{<!-- --></span>
					sprintf <span class="token punctuation">(</span> cStr<span class="token punctuation">,</span> <span class="token string">"The Card ID is: %02X%02X%02X%02X"</span><span class="token punctuation">,</span>
										ucArray_ID <span class="token punctuation">[</span> <span class="token number">0</span> <span class="token punctuation">]</span><span class="token punctuation">,</span>
										ucArray_ID <span class="token punctuation">[</span> <span class="token number">1</span> <span class="token punctuation">]</span><span class="token punctuation">,</span>
										ucArray_ID <span class="token punctuation">[</span> <span class="token number">2</span> <span class="token punctuation">]</span><span class="token punctuation">,</span>
										ucArray_ID <span class="token punctuation">[</span> <span class="token number">3</span> <span class="token punctuation">]</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
									
					printf <span class="token punctuation">(</span> <span class="token string">"%s\r\n"</span><span class="token punctuation">,</span>cStr <span class="token punctuation">)</span><span class="token punctuation">;</span> 						
				<span class="token punctuation">}</span>		
			<span class="token punctuation">}</span>	
  <span class="token punctuation">}</span>		
<span class="token punctuation">}</span>
<span class="token comment">/* 函数名：RC522_Init
 * 描述  ：初始化RC522配置
 * 输入  ：无
 * 返回  : 无
 * 调用  ：外部调用              */</span>
<span class="token keyword">void</span> RC522_Init <span class="token punctuation">(</span> <span class="token keyword">void</span> <span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token function">RC522_GPIO_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//初始化相关引脚</span>
	<span class="token function">SPI2_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//初始化SPI2</span>
	<span class="token function">RC522_Reset_Disable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	      <span class="token comment">//将RST置高，启动内部复位阶段；</span>
	<span class="token function">RC522_CS_Disable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	PcdReset <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                  <span class="token comment">//复位RC522 </span>
  <span class="token function">PcdAntennaOff</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>              <span class="token comment">//关闭天线</span>
<span class="token comment">//	//RC522_DELAY();                //delay 1ms</span>
	<span class="token function">delay_us</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">PcdAntennaOn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>               <span class="token comment">//打开天线</span>
	M500PcdConfigISOType <span class="token punctuation">(</span> <span class="token string">'A'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//设置工作方式</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
  * @Name    RC522_GPIO_Init
  * @brief   初始化RC522 GPIO引脚
  * @param   None
  * @retval
  * @author  NameisBoy
  * @Data    2020-09-04
 **/</span>
<span class="token keyword">void</span> <span class="token function">RC522_GPIO_Init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	  GPIO_InitTypeDef GPIO_InitStructure<span class="token punctuation">;</span>
 	  <span class="token function">RCC_APB2PeriphClockCmd</span><span class="token punctuation">(</span>	RCC_APB2Periph_GPIOB <span class="token operator">|</span> RCC_APB2Periph_GPIOC<span class="token punctuation">,</span> ENABLE <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//PORTB时钟使能 </span>
	
	  <span class="token comment">// NSS PC7  设置推挽输出</span>
	  <span class="token comment">// RST PC8</span>
    GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Pin <span class="token operator">=</span> GPIO_Pin_7 <span class="token operator">|</span> GPIO_Pin_8<span class="token punctuation">;</span>	 
    GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Mode <span class="token operator">=</span> GPIO_Mode_Out_PP<span class="token punctuation">;</span> 		 <span class="token comment">//推挽输出</span>
    GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Speed <span class="token operator">=</span> GPIO_Speed_50MHz<span class="token punctuation">;</span>		 <span class="token comment">//IO口速度为50MHz</span>
    <span class="token function">GPIO_Init</span><span class="token punctuation">(</span>GPIOC<span class="token punctuation">,</span> <span class="token operator">&amp;</span>GPIO_InitStructure<span class="token punctuation">)</span><span class="token punctuation">;</span>					 <span class="token comment">//根据设定参数初始化</span>
    
    <span class="token comment">// SCK  PB13 设置复用推完输出</span>
		<span class="token comment">// MISO PB14</span>
		<span class="token comment">// MOSI	PB15</span>
    GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Pin <span class="token operator">=</span> GPIO_Pin_13<span class="token operator">|</span>GPIO_Pin_14<span class="token operator">|</span>GPIO_Pin_15<span class="token punctuation">;</span>	 
    GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Mode <span class="token operator">=</span> GPIO_Mode_AF_PP<span class="token punctuation">;</span> 		 <span class="token comment">//复用推挽输出</span>
    GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Speed <span class="token operator">=</span> GPIO_Speed_50MHz<span class="token punctuation">;</span>		 <span class="token comment">//IO口速度为50MHz</span>
		<span class="token function">GPIO_Init</span><span class="token punctuation">(</span>GPIOB<span class="token punctuation">,</span> <span class="token operator">&amp;</span>GPIO_InitStructure<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">/* 函数名：SPI2_Init
 * 描述  ：初始化SPI1的配置
 * 输入  ：无
 * 返回  : 无
 * 调用  ：外部调用              */</span>
<span class="token keyword">void</span> SPI2_Init <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>	
<span class="token punctuation">{<!-- --></span>
	  SPI_InitTypeDef  SPI_InitStructure<span class="token punctuation">;</span> 
	
		<span class="token function">RC522_CS_Disable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//置高CS片选，失能</span>
		<span class="token comment">//失能SPI2</span>
		<span class="token function">SPI_Cmd</span><span class="token punctuation">(</span>SPI2 <span class="token punctuation">,</span> DISABLE<span class="token punctuation">)</span><span class="token punctuation">;</span> 
		<span class="token comment">//使能时钟线</span>
		<span class="token function">RCC_APB1PeriphClockCmd</span><span class="token punctuation">(</span>RCC_APB1Periph_SPI2<span class="token punctuation">,</span> ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">//spi2配置</span>
		SPI_InitStructure<span class="token punctuation">.</span>SPI_Direction <span class="token operator">=</span> SPI_Direction_2Lines_FullDuplex<span class="token punctuation">;</span>           <span class="token comment">//全双工；</span>
    SPI_InitStructure<span class="token punctuation">.</span>SPI_Mode <span class="token operator">=</span> SPI_Mode_Master<span class="token punctuation">;</span>                                <span class="token comment">//主机模式；</span>
    SPI_InitStructure<span class="token punctuation">.</span>SPI_DataSize <span class="token operator">=</span> SPI_DataSize_8b<span class="token punctuation">;</span>                            <span class="token comment">//传输数据为8位；</span>
    SPI_InitStructure<span class="token punctuation">.</span>SPI_CPOL <span class="token operator">=</span> SPI_CPOL_Low<span class="token punctuation">;</span>                                   <span class="token comment">//时钟极性CPOL为空闲时低电平；</span>
    SPI_InitStructure<span class="token punctuation">.</span>SPI_CPHA <span class="token operator">=</span> SPI_CPHA_1Edge<span class="token punctuation">;</span>                                 <span class="token comment">//时钟采样点为时钟奇数沿（上升沿）；</span>
    SPI_InitStructure<span class="token punctuation">.</span>SPI_NSS <span class="token operator">=</span> SPI_NSS_Soft<span class="token punctuation">;</span>                                    <span class="token comment">//NSS引脚由软件改变；</span>
    SPI_InitStructure<span class="token punctuation">.</span>SPI_BaudRatePrescaler <span class="token operator">=</span> SPI_BaudRatePrescaler_256<span class="token punctuation">;</span>          <span class="token comment">//预分频系数64；</span>
    SPI_InitStructure<span class="token punctuation">.</span>SPI_FirstBit <span class="token operator">=</span> SPI_FirstBit_MSB<span class="token punctuation">;</span>                           <span class="token comment">//MSB先行模式；</span>
    SPI_InitStructure<span class="token punctuation">.</span>SPI_CRCPolynomial <span class="token operator">=</span> <span class="token number">7</span><span class="token punctuation">;</span>                                     <span class="token comment">//CRC校验；</span>
		<span class="token comment">//初始化SPI2</span>
    <span class="token function">SPI_Init</span><span class="token punctuation">(</span>SPI2 <span class="token punctuation">,</span> <span class="token operator">&amp;</span>SPI_InitStructure<span class="token punctuation">)</span><span class="token punctuation">;</span>
		
		<span class="token comment">//使能SPI2</span>
		<span class="token function">SPI_Cmd</span><span class="token punctuation">(</span>SPI2 <span class="token punctuation">,</span> ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span> 
 <span class="token punctuation">}</span>

<span class="token comment">/* 函数名：PcdRese
 * 描述  ：复位RC522 
 * 输入  ：无
 * 返回  : 无
 * 调用  ：外部调用              */</span>
<span class="token keyword">void</span> PcdReset <span class="token punctuation">(</span> <span class="token keyword">void</span> <span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">RC522_Reset_Disable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    delay_us <span class="token punctuation">(</span> <span class="token number">1</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">RC522_Reset_Enable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    delay_us <span class="token punctuation">(</span> <span class="token number">1</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">RC522_Reset_Disable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    delay_us <span class="token punctuation">(</span> <span class="token number">1</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    WriteRawRC <span class="token punctuation">(</span> CommandReg<span class="token punctuation">,</span> <span class="token number">0x0f</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">while</span> <span class="token punctuation">(</span> ReadRawRC <span class="token punctuation">(</span> CommandReg <span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0x10</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
	
    delay_us <span class="token punctuation">(</span> <span class="token number">1</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    WriteRawRC <span class="token punctuation">(</span> ModeReg<span class="token punctuation">,</span> <span class="token number">0x3D</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment">//定义发送和接收常用模式 和Mifare卡通讯，CRC初始值0x6363</span>
    WriteRawRC <span class="token punctuation">(</span> TReloadRegL<span class="token punctuation">,</span> <span class="token number">30</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>              <span class="token comment">//16位定时器低位    </span>
    WriteRawRC <span class="token punctuation">(</span> TReloadRegH<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>			     <span class="token comment">//16位定时器高位</span>
    WriteRawRC <span class="token punctuation">(</span> TModeReg<span class="token punctuation">,</span> <span class="token number">0x8D</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>				 <span class="token comment">//定义内部定时器的设置</span>
    WriteRawRC <span class="token punctuation">(</span> TPrescalerReg<span class="token punctuation">,</span> <span class="token number">0x3E</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>			 <span class="token comment">//设置定时器分频系数</span>
    WriteRawRC <span class="token punctuation">(</span> TxAutoReg<span class="token punctuation">,</span> <span class="token number">0x40</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>				 <span class="token comment">//调制发送信号为100%ASK		</span>
<span class="token punctuation">}</span>

<span class="token comment">/* 函数名：SPI_RC522_SendByte
 * 描述  ：向RC522发送1 Byte 数据
 * 输入  ：byte，要发送的数据
 * 返回  : RC522返回的数据
 * 调用  ：内部调用                 */</span>
u8 SPI_RC522_SendByte <span class="token punctuation">(</span> u8 byte <span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
<span class="token comment">//	  while (SPI_I2S_GetFlagStatus(SPI2, SPI_I2S_FLAG_TXE) == RESET);         </span>
<span class="token comment">//		SPI_I2S_SendData(SPI2, byte);  //等待发送缓冲区空，发送数据               </span>
<span class="token comment">//    while (SPI_I2S_GetFlagStatus(SPI2, SPI_I2S_FLAG_RXNE) == RESET); </span>
<span class="token comment">//    return 	SPI_I2S_ReceiveData(SPI2);</span>
		u8 retry<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
		<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token function">SPI_I2S_GetFlagStatus</span><span class="token punctuation">(</span>SPI2<span class="token punctuation">,</span> SPI_I2S_FLAG_TXE<span class="token punctuation">)</span> <span class="token operator">==</span> RESET<span class="token punctuation">)</span> <span class="token comment">//检查指定的SPI标志位设置与否:发送缓存空标志位</span>
		<span class="token punctuation">{<!-- --></span>
			retry<span class="token operator">++</span><span class="token punctuation">;</span>
			<span class="token keyword">if</span><span class="token punctuation">(</span>retry<span class="token operator">&gt;</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token function">SPI_I2S_SendData</span><span class="token punctuation">(</span>SPI2<span class="token punctuation">,</span> byte<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//通过外设 SPIx 发送一个数据</span>
		retry<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
		<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token function">SPI_I2S_GetFlagStatus</span><span class="token punctuation">(</span>SPI2<span class="token punctuation">,</span> SPI_I2S_FLAG_RXNE<span class="token punctuation">)</span> <span class="token operator">==</span> RESET<span class="token punctuation">)</span><span class="token comment">//检查指定的SPI 标志位设置与否:接受缓存非空标志位</span>
		<span class="token punctuation">{<!-- --></span>
			retry<span class="token operator">++</span><span class="token punctuation">;</span>
			<span class="token keyword">if</span><span class="token punctuation">(</span>retry<span class="token operator">&gt;</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">return</span> <span class="token function">SPI_I2S_ReceiveData</span><span class="token punctuation">(</span>SPI2<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//返回通过 SPIx 最近接收的数据</span>
<span class="token punctuation">}</span>


<span class="token comment">/* 函数名：ReadRawRC
 * 描述  ：读RC522寄存器
 * 输入  ：ucAddress，寄存器地址
 * 返回  : 寄存器的当前值
 * 调用  ：内部调用                 */</span>
u8 ReadRawRC <span class="token punctuation">(</span> u8 ucAddress <span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	u8 ucAddr<span class="token punctuation">,</span> ucReturn<span class="token punctuation">;</span>
	ucAddr <span class="token operator">=</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span> ucAddress <span class="token operator">&lt;&lt;</span> <span class="token number">1</span> <span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0x7E</span> <span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token number">0x80</span><span class="token punctuation">;</span>      

	<span class="token function">RC522_CS_Enable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	SPI_RC522_SendByte <span class="token punctuation">(</span> ucAddr <span class="token punctuation">)</span><span class="token punctuation">;</span>
	ucReturn <span class="token operator">=</span> SPI_RC522_ReadByte <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">RC522_CS_Disable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> ucReturn<span class="token punctuation">;</span>
<span class="token punctuation">}</span>


 <span class="token comment">/* 函数名：WriteRawRC
 * 描述  ：写RC522寄存器
 * 输入  ：ucAddress，寄存器地址  、 ucValue，写入寄存器的值
 * 返回  : 无
 * 调用  ：内部调用   */</span>
<span class="token keyword">void</span> WriteRawRC <span class="token punctuation">(</span> u8 ucAddress<span class="token punctuation">,</span> u8 ucValue <span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>  
	u8 ucAddr<span class="token punctuation">;</span>
	ucAddr <span class="token operator">=</span> <span class="token punctuation">(</span> ucAddress <span class="token operator">&lt;&lt;</span> <span class="token number">1</span> <span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0x7E</span><span class="token punctuation">;</span>   
	
	<span class="token function">RC522_CS_Enable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	
	SPI_RC522_SendByte <span class="token punctuation">(</span> ucAddr <span class="token punctuation">)</span><span class="token punctuation">;</span>
	SPI_RC522_SendByte <span class="token punctuation">(</span> ucValue <span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">RC522_CS_Disable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	
<span class="token punctuation">}</span>

<span class="token comment">/* 函数名：M500PcdConfigISOType
 * 描述  ：设置RC522的工作方式
 * 输入  ：ucType，工作方式
 * 返回  : 无
 * 调用  ：外部调用        */</span>
<span class="token keyword">void</span> M500PcdConfigISOType <span class="token punctuation">(</span> u8 ucType <span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span> ucType <span class="token operator">==</span> <span class="token string">'A'</span><span class="token punctuation">)</span>                     <span class="token comment">//ISO14443_A</span>
  <span class="token punctuation">{<!-- --></span>
		ClearBitMask <span class="token punctuation">(</span> Status2Reg<span class="token punctuation">,</span> <span class="token number">0x08</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>		

    WriteRawRC <span class="token punctuation">(</span> ModeReg<span class="token punctuation">,</span> <span class="token number">0x3D</span> <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//3F	</span>
		WriteRawRC <span class="token punctuation">(</span> RxSelReg<span class="token punctuation">,</span> <span class="token number">0x86</span> <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//84</span>
		WriteRawRC <span class="token punctuation">(</span> RFCfgReg<span class="token punctuation">,</span> <span class="token number">0x7F</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//4F</span>
		WriteRawRC <span class="token punctuation">(</span> TReloadRegL<span class="token punctuation">,</span> <span class="token number">30</span> <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//tmoLength);// TReloadVal = 'h6a =tmoLength(dec) </span>
		WriteRawRC <span class="token punctuation">(</span> TReloadRegH<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
		WriteRawRC <span class="token punctuation">(</span> TModeReg<span class="token punctuation">,</span> <span class="token number">0x8D</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
		WriteRawRC <span class="token punctuation">(</span> TPrescalerReg<span class="token punctuation">,</span> <span class="token number">0x3E</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
		delay_us   <span class="token punctuation">(</span> <span class="token number">2</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
		
		PcdAntennaOn <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//开天线</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">/*
 * 函数名：SetBitMask
 * 描述  ：对RC522寄存器置位
 * 输入  ：ucReg，寄存器地址
 *         ucMask，置位值
 * 返回  : 无
 * 调用  ：内部调用
 */</span>
<span class="token keyword">void</span> SetBitMask <span class="token punctuation">(</span> u8 ucReg<span class="token punctuation">,</span> u8 ucMask <span class="token punctuation">)</span>  
<span class="token punctuation">{<!-- --></span>
    u8 ucTemp<span class="token punctuation">;</span>

    ucTemp <span class="token operator">=</span> ReadRawRC <span class="token punctuation">(</span> ucReg <span class="token punctuation">)</span><span class="token punctuation">;</span>
    WriteRawRC <span class="token punctuation">(</span> ucReg<span class="token punctuation">,</span> ucTemp <span class="token operator">|</span> ucMask <span class="token punctuation">)</span><span class="token punctuation">;</span>         <span class="token comment">// set bit mask</span>
<span class="token punctuation">}</span>

<span class="token comment">/* 函数名：ClearBitMask
 * 描述  ：对RC522寄存器清位
 * 输入  ：ucReg，寄存器地址
 *         ucMask，清位值
 * 返回  : 无
 * 调用  ：内部调用           */</span>
<span class="token keyword">void</span> ClearBitMask <span class="token punctuation">(</span> u8 ucReg<span class="token punctuation">,</span> u8 ucMask <span class="token punctuation">)</span>  
<span class="token punctuation">{<!-- --></span>
    u8 ucTemp<span class="token punctuation">;</span>
    ucTemp <span class="token operator">=</span> ReadRawRC <span class="token punctuation">(</span> ucReg <span class="token punctuation">)</span><span class="token punctuation">;</span>
	
    WriteRawRC <span class="token punctuation">(</span> ucReg<span class="token punctuation">,</span> ucTemp <span class="token operator">&amp;</span> <span class="token punctuation">(</span> <span class="token operator">~</span> ucMask<span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// clear bit mask</span>
	
<span class="token punctuation">}</span>

<span class="token comment">/* 函数名：PcdAntennaOn
 * 描述  ：开启天线 
 * 输入  ：无
 * 返回  : 无
 * 调用  ：内部调用            */</span>
<span class="token keyword">void</span> PcdAntennaOn <span class="token punctuation">(</span> <span class="token keyword">void</span> <span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    u8 uc<span class="token punctuation">;</span>
    uc <span class="token operator">=</span> ReadRawRC <span class="token punctuation">(</span> TxControlReg <span class="token punctuation">)</span><span class="token punctuation">;</span>
	
    <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span> <span class="token punctuation">(</span> uc <span class="token operator">&amp;</span> <span class="token number">0x03</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span>
			<span class="token function">SetBitMask</span><span class="token punctuation">(</span>TxControlReg<span class="token punctuation">,</span> <span class="token number">0x03</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>

<span class="token comment">/* 函数名：PcdAntennaOff
 * 描述  ：开启天线 
 * 输入  ：无
 * 返回  : 无
 * 调用  ：内部调用             */</span>
<span class="token keyword">void</span> PcdAntennaOff <span class="token punctuation">(</span> <span class="token keyword">void</span> <span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    ClearBitMask <span class="token punctuation">(</span> TxControlReg<span class="token punctuation">,</span> <span class="token number">0x03</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">ShowID</span><span class="token punctuation">(</span>u16 x<span class="token punctuation">,</span>u16 y<span class="token punctuation">,</span> u8 <span class="token operator">*</span>p<span class="token punctuation">,</span> u16 charColor<span class="token punctuation">,</span> u16 bkColor<span class="token punctuation">)</span>  <span class="token comment">//显示卡的卡号，以十六进制显示</span>
<span class="token punctuation">{<!-- --></span>
    u8 num<span class="token punctuation">[</span><span class="token number">9</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"ID&gt;&gt;&gt;%s\r\n"</span><span class="token punctuation">,</span> num<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>

<span class="token comment">/* 函数名：PcdComMF522
 * 描述  ：通过RC522和ISO14443卡通讯
 * 输入  ：ucCommand，RC522命令字
 *         pInData，通过RC522发送到卡片的数据
 *         ucInLenByte，发送数据的字节长度
 *         pOutData，接收到的卡片返回数据
 *         pOutLenBit，返回数据的位长度
 * 返回  : 状态值
 *         = MI_OK，成功
 * 调用  ：内部调用              */</span>
<span class="token keyword">char</span> PcdComMF522 <span class="token punctuation">(</span> u8 ucCommand<span class="token punctuation">,</span> u8 <span class="token operator">*</span> pInData<span class="token punctuation">,</span> u8 ucInLenByte<span class="token punctuation">,</span> u8 <span class="token operator">*</span> pOutData<span class="token punctuation">,</span> u32 <span class="token operator">*</span> pOutLenBit <span class="token punctuation">)</span>		
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">char</span> cStatus <span class="token operator">=</span> MI_ERR<span class="token punctuation">;</span>
    u8 ucIrqEn   <span class="token operator">=</span> <span class="token number">0x00</span><span class="token punctuation">;</span>
    u8 ucWaitFor <span class="token operator">=</span> <span class="token number">0x00</span><span class="token punctuation">;</span>
    u8 ucLastBits<span class="token punctuation">;</span>
    u8 ucN<span class="token punctuation">;</span>
    u32 ul<span class="token punctuation">;</span>

    <span class="token keyword">switch</span> <span class="token punctuation">(</span> ucCommand <span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
       <span class="token keyword">case</span> PCD_AUTHENT<span class="token punctuation">:</span>		<span class="token comment">//Mifare认证</span>
          ucIrqEn   <span class="token operator">=</span> <span class="token number">0x12</span><span class="token punctuation">;</span>		<span class="token comment">//允许错误中断请求ErrIEn  允许空闲中断IdleIEn</span>
          ucWaitFor <span class="token operator">=</span> <span class="token number">0x10</span><span class="token punctuation">;</span>		<span class="token comment">//认证寻卡等待时候 查询空闲中断标志位</span>
          <span class="token keyword">break</span><span class="token punctuation">;</span>
			 
       <span class="token keyword">case</span> PCD_TRANSCEIVE<span class="token punctuation">:</span>		<span class="token comment">//接收发送 发送接收</span>
          ucIrqEn   <span class="token operator">=</span> <span class="token number">0x77</span><span class="token punctuation">;</span>		<span class="token comment">//允许TxIEn RxIEn IdleIEn LoAlertIEn ErrIEn TimerIEn</span>
          ucWaitFor <span class="token operator">=</span> <span class="token number">0x30</span><span class="token punctuation">;</span>		<span class="token comment">//寻卡等待时候 查询接收中断标志位与 空闲中断标志位</span>
          <span class="token keyword">break</span><span class="token punctuation">;</span>
			 
       <span class="token keyword">default</span><span class="token punctuation">:</span>
         <span class="token keyword">break</span><span class="token punctuation">;</span>
			 
    <span class="token punctuation">}</span>
   
    WriteRawRC <span class="token punctuation">(</span> ComIEnReg<span class="token punctuation">,</span> ucIrqEn <span class="token operator">|</span> <span class="token number">0x80</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">//IRqInv置位管脚IRQ与Status1Reg的IRq位的值相反 </span>
    ClearBitMask <span class="token punctuation">(</span> ComIrqReg<span class="token punctuation">,</span> <span class="token number">0x80</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>			<span class="token comment">//Set1该位清零时，CommIRqReg的屏蔽位清零</span>
    WriteRawRC <span class="token punctuation">(</span> CommandReg<span class="token punctuation">,</span> PCD_IDLE <span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">//写空闲命令</span>
    SetBitMask <span class="token punctuation">(</span> FIFOLevelReg<span class="token punctuation">,</span> <span class="token number">0x80</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>			<span class="token comment">//置位FlushBuffer清除内部FIFO的读和写指针以及ErrReg的BufferOvfl标志位被清除</span>
    
    <span class="token keyword">for</span> <span class="token punctuation">(</span> ul <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> ul <span class="token operator">&lt;</span> ucInLenByte<span class="token punctuation">;</span> ul <span class="token operator">++</span> <span class="token punctuation">)</span>
		WriteRawRC <span class="token punctuation">(</span> FIFODataReg<span class="token punctuation">,</span> pInData <span class="token punctuation">[</span> ul <span class="token punctuation">]</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>    		<span class="token comment">//写数据进FIFOdata</span>
			
    WriteRawRC <span class="token punctuation">(</span> CommandReg<span class="token punctuation">,</span> ucCommand <span class="token punctuation">)</span><span class="token punctuation">;</span>					<span class="token comment">//写命令</span>
   
    
    <span class="token keyword">if</span> <span class="token punctuation">(</span> ucCommand <span class="token operator">==</span> PCD_TRANSCEIVE <span class="token punctuation">)</span>
			<span class="token function">SetBitMask</span><span class="token punctuation">(</span>BitFramingReg<span class="token punctuation">,</span><span class="token number">0x80</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  				<span class="token comment">//StartSend置位启动数据发送 该位与收发命令使用时才有效</span>
    
    ul <span class="token operator">=</span> <span class="token number">1000</span><span class="token punctuation">;</span><span class="token comment">//根据时钟频率调整，操作M1卡最大等待时间25ms</span>
		
    <span class="token keyword">do</span> 														<span class="token comment">//认证 与寻卡等待时间	</span>
    <span class="token punctuation">{<!-- --></span>
         ucN <span class="token operator">=</span> ReadRawRC <span class="token punctuation">(</span> ComIrqReg <span class="token punctuation">)</span><span class="token punctuation">;</span>							<span class="token comment">//查询事件中断</span>
         ul <span class="token operator">--</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span> ul <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span> <span class="token operator">!</span> <span class="token punctuation">(</span> ucN <span class="token operator">&amp;</span> <span class="token number">0x01</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span> <span class="token operator">!</span> <span class="token punctuation">(</span> ucN <span class="token operator">&amp;</span> ucWaitFor <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">//退出条件i=0,定时器中断，与写空闲命令</span>
		
    ClearBitMask <span class="token punctuation">(</span> BitFramingReg<span class="token punctuation">,</span> <span class="token number">0x80</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>					<span class="token comment">//清理允许StartSend位</span>
		
    <span class="token keyword">if</span> <span class="token punctuation">(</span> ul <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span> <span class="token punctuation">(</span><span class="token punctuation">(</span> ReadRawRC <span class="token punctuation">(</span> ErrorReg <span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0x1B</span> <span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>			<span class="token comment">//读错误标志寄存器BufferOfI CollErr ParityErr ProtocolErr</span>
		<span class="token punctuation">{<!-- --></span>
			cStatus <span class="token operator">=</span> MI_OK<span class="token punctuation">;</span>
			
			<span class="token keyword">if</span> <span class="token punctuation">(</span> ucN <span class="token operator">&amp;</span> ucIrqEn <span class="token operator">&amp;</span> <span class="token number">0x01</span> <span class="token punctuation">)</span>					<span class="token comment">//是否发生定时器中断</span>
			  cStatus <span class="token operator">=</span> MI_NOTAGERR<span class="token punctuation">;</span>   
				
			<span class="token keyword">if</span> <span class="token punctuation">(</span> ucCommand <span class="token operator">==</span> PCD_TRANSCEIVE <span class="token punctuation">)</span>
			<span class="token punctuation">{<!-- --></span>
				ucN <span class="token operator">=</span> ReadRawRC <span class="token punctuation">(</span> FIFOLevelReg <span class="token punctuation">)</span><span class="token punctuation">;</span>			<span class="token comment">//读FIFO中保存的字节数</span>
				
				ucLastBits <span class="token operator">=</span> ReadRawRC <span class="token punctuation">(</span> ControlReg <span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0x07</span><span class="token punctuation">;</span>	<span class="token comment">//最后接收到得字节的有效位数</span>
				
				<span class="token keyword">if</span> <span class="token punctuation">(</span> ucLastBits <span class="token punctuation">)</span>
					<span class="token operator">*</span> pOutLenBit <span class="token operator">=</span> <span class="token punctuation">(</span> ucN <span class="token operator">-</span> <span class="token number">1</span> <span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">8</span> <span class="token operator">+</span> ucLastBits<span class="token punctuation">;</span>   	<span class="token comment">//N个字节数减去1（最后一个字节）+最后一位的位数 读取到的数据总位数</span>
				<span class="token keyword">else</span>
					<span class="token operator">*</span> pOutLenBit <span class="token operator">=</span> ucN <span class="token operator">*</span> <span class="token number">8</span><span class="token punctuation">;</span>   					<span class="token comment">//最后接收到的字节整个字节有效</span>
				
				<span class="token keyword">if</span> <span class="token punctuation">(</span> ucN <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">)</span>	
                    ucN <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>    
				
				<span class="token keyword">if</span> <span class="token punctuation">(</span> ucN <span class="token operator">&gt;</span> MAXRLEN <span class="token punctuation">)</span>
					ucN <span class="token operator">=</span> MAXRLEN<span class="token punctuation">;</span>   
				
				<span class="token keyword">for</span> <span class="token punctuation">(</span> ul <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> ul <span class="token operator">&lt;</span> ucN<span class="token punctuation">;</span> ul <span class="token operator">++</span> <span class="token punctuation">)</span>
				  pOutData <span class="token punctuation">[</span> ul <span class="token punctuation">]</span> <span class="token operator">=</span> ReadRawRC <span class="token punctuation">(</span> FIFODataReg <span class="token punctuation">)</span><span class="token punctuation">;</span>   
			<span class="token punctuation">}</span>		
        <span class="token punctuation">}</span>
			<span class="token keyword">else</span>
				cStatus <span class="token operator">=</span> MI_ERR<span class="token punctuation">;</span>   
    <span class="token punctuation">}</span>
   
   SetBitMask <span class="token punctuation">(</span> ControlReg<span class="token punctuation">,</span> <span class="token number">0x80</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>           <span class="token comment">// stop timer now</span>
   WriteRawRC <span class="token punctuation">(</span> CommandReg<span class="token punctuation">,</span> PCD_IDLE <span class="token punctuation">)</span><span class="token punctuation">;</span> 
	
   <span class="token keyword">return</span> cStatus<span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token comment">/* 函数名：PcdRequest
 * 描述  ：寻卡
 * 输入  ：ucReq_code，寻卡方式
 *                     = 0x52，寻感应区内所有符合14443A标准的卡
 *                     = 0x26，寻未进入休眠状态的卡
 *         pTagType，卡片类型代码
 *                   = 0x4400，Mifare_UltraLight
 *                   = 0x0400，Mifare_One(S50)
 *                   = 0x0200，Mifare_One(S70)
 *                   = 0x0800，Mifare_Pro(X))
 *                   = 0x4403，Mifare_DESFire
 * 返回  : 状态值
 *         = MI_OK，成功
 * 调用  ：外部调用            */</span>
<span class="token keyword">char</span> PcdRequest <span class="token punctuation">(</span> u8 ucReq_code<span class="token punctuation">,</span> u8 <span class="token operator">*</span> pTagType <span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">char</span> cStatus<span class="token punctuation">;</span>  
    u8 ucComMF522Buf <span class="token punctuation">[</span> MAXRLEN <span class="token punctuation">]</span><span class="token punctuation">;</span> 
    u32 ulLen<span class="token punctuation">;</span>

    ClearBitMask <span class="token punctuation">(</span> Status2Reg<span class="token punctuation">,</span> <span class="token number">0x08</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//清理指示MIFARECyptol单元接通以及所有卡的数据通信被加密的情况</span>
    WriteRawRC <span class="token punctuation">(</span> BitFramingReg<span class="token punctuation">,</span> <span class="token number">0x07</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//	发送的最后一个字节的 七位</span>
    SetBitMask <span class="token punctuation">(</span> TxControlReg<span class="token punctuation">,</span> <span class="token number">0x03</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//TX1,TX2管脚的输出信号传递经发送调制的13.56的能量载波信号</span>

    ucComMF522Buf <span class="token punctuation">[</span> <span class="token number">0</span> <span class="token punctuation">]</span> <span class="token operator">=</span> ucReq_code<span class="token punctuation">;</span>		<span class="token comment">//存入 卡片命令字</span>

    cStatus <span class="token operator">=</span> PcdComMF522 <span class="token punctuation">(</span> PCD_TRANSCEIVE<span class="token punctuation">,</span>	ucComMF522Buf<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> ucComMF522Buf<span class="token punctuation">,</span> <span class="token operator">&amp;</span> ulLen <span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//寻卡  </span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span> cStatus <span class="token operator">==</span> MI_OK <span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span> ulLen <span class="token operator">==</span> <span class="token number">0x10</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span>	<span class="token comment">//寻卡成功返回卡类型 </span>
    <span class="token punctuation">{<!-- --></span>    
       <span class="token operator">*</span> pTagType <span class="token operator">=</span> ucComMF522Buf <span class="token punctuation">[</span> <span class="token number">0</span> <span class="token punctuation">]</span><span class="token punctuation">;</span>
       <span class="token operator">*</span> <span class="token punctuation">(</span> pTagType <span class="token operator">+</span> <span class="token number">1</span> <span class="token punctuation">)</span> <span class="token operator">=</span> ucComMF522Buf <span class="token punctuation">[</span> <span class="token number">1</span> <span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
     
    <span class="token keyword">else</span>
     cStatus <span class="token operator">=</span> MI_ERR<span class="token punctuation">;</span>

    <span class="token keyword">return</span> cStatus<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/* 函数名：PcdAnticoll
 * 描述  ：防冲撞
 * 输入  ：pSnr，卡片序列号，4字节
 * 返回  : 状态值
 *         = MI_OK，成功
 * 调用  ：外部调用           */</span>
<span class="token keyword">char</span> PcdAnticoll <span class="token punctuation">(</span> u8 <span class="token operator">*</span> pSnr <span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">char</span> cStatus<span class="token punctuation">;</span>
    u8 uc<span class="token punctuation">,</span> ucSnr_check <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    u8 ucComMF522Buf <span class="token punctuation">[</span> MAXRLEN <span class="token punctuation">]</span><span class="token punctuation">;</span> 
	  u32 ulLen<span class="token punctuation">;</span>

    ClearBitMask <span class="token punctuation">(</span> Status2Reg<span class="token punctuation">,</span> <span class="token number">0x08</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">//清MFCryptol On位 只有成功执行MFAuthent命令后，该位才能置位</span>
    WriteRawRC <span class="token punctuation">(</span> BitFramingReg<span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">//清理寄存器 停止收发</span>
    ClearBitMask <span class="token punctuation">(</span> CollReg<span class="token punctuation">,</span> <span class="token number">0x80</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>			<span class="token comment">//清ValuesAfterColl所有接收的位在冲突后被清除</span>
   
    ucComMF522Buf <span class="token punctuation">[</span> <span class="token number">0</span> <span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x93</span><span class="token punctuation">;</span>	<span class="token comment">//卡片防冲突命令</span>
    ucComMF522Buf <span class="token punctuation">[</span> <span class="token number">1</span> <span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x20</span><span class="token punctuation">;</span>
   
    cStatus <span class="token operator">=</span> PcdComMF522 <span class="token punctuation">(</span> PCD_TRANSCEIVE<span class="token punctuation">,</span> ucComMF522Buf<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> ucComMF522Buf<span class="token punctuation">,</span> <span class="token operator">&amp;</span> ulLen<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//与卡片通信</span>
	
    <span class="token keyword">if</span> <span class="token punctuation">(</span> cStatus <span class="token operator">==</span> MI_OK<span class="token punctuation">)</span>		<span class="token comment">//通信成功</span>
    <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">for</span> <span class="token punctuation">(</span> uc <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> uc <span class="token operator">&lt;</span> <span class="token number">4</span><span class="token punctuation">;</span> uc <span class="token operator">++</span> <span class="token punctuation">)</span>
			<span class="token punctuation">{<!-- --></span>
					<span class="token operator">*</span> <span class="token punctuation">(</span> pSnr <span class="token operator">+</span> uc <span class="token punctuation">)</span>  <span class="token operator">=</span> ucComMF522Buf <span class="token punctuation">[</span> uc <span class="token punctuation">]</span><span class="token punctuation">;</span>			<span class="token comment">//读出UID</span>
					ucSnr_check <span class="token operator">^</span><span class="token operator">=</span> ucComMF522Buf <span class="token punctuation">[</span> uc <span class="token punctuation">]</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			
        <span class="token keyword">if</span> <span class="token punctuation">(</span> ucSnr_check <span class="token operator">!=</span> ucComMF522Buf <span class="token punctuation">[</span> uc <span class="token punctuation">]</span> <span class="token punctuation">)</span>
        		cStatus <span class="token operator">=</span> MI_ERR<span class="token punctuation">;</span>    		 
    <span class="token punctuation">}</span>
    SetBitMask <span class="token punctuation">(</span> CollReg<span class="token punctuation">,</span> <span class="token number">0x80</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> cStatus<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/* 函数名：PcdSelect
 * 描述  ：选定卡片
 * 输入  ：pSnr，卡片序列号，4字节
 * 返回  : 状态值
 *         = MI_OK，成功
 * 调用  ：外部调用         */</span>
<span class="token keyword">char</span> PcdSelect <span class="token punctuation">(</span> u8 <span class="token operator">*</span> pSnr <span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">char</span> ucN<span class="token punctuation">;</span>
    u8 uc<span class="token punctuation">;</span>
    u8 ucComMF522Buf <span class="token punctuation">[</span> MAXRLEN <span class="token punctuation">]</span><span class="token punctuation">;</span> 
    u32  ulLen<span class="token punctuation">;</span>

    ucComMF522Buf <span class="token punctuation">[</span> <span class="token number">0</span> <span class="token punctuation">]</span> <span class="token operator">=</span> PICC_ANTICOLL1<span class="token punctuation">;</span>
    ucComMF522Buf <span class="token punctuation">[</span> <span class="token number">1</span> <span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x70</span><span class="token punctuation">;</span>
    ucComMF522Buf <span class="token punctuation">[</span> <span class="token number">6</span> <span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    
    <span class="token keyword">for</span> <span class="token punctuation">(</span> uc <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> uc <span class="token operator">&lt;</span> <span class="token number">4</span><span class="token punctuation">;</span> uc <span class="token operator">++</span> <span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        ucComMF522Buf <span class="token punctuation">[</span> uc <span class="token operator">+</span> <span class="token number">2</span> <span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">*</span> <span class="token punctuation">(</span> pSnr <span class="token operator">+</span> uc <span class="token punctuation">)</span><span class="token punctuation">;</span>
        ucComMF522Buf <span class="token punctuation">[</span> <span class="token number">6</span> <span class="token punctuation">]</span> <span class="token operator">^</span><span class="token operator">=</span> <span class="token operator">*</span> <span class="token punctuation">(</span> pSnr <span class="token operator">+</span> uc <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
        
    CalulateCRC <span class="token punctuation">(</span> ucComMF522Buf<span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span> ucComMF522Buf <span class="token punctuation">[</span> <span class="token number">7</span> <span class="token punctuation">]</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    ClearBitMask <span class="token punctuation">(</span> Status2Reg<span class="token punctuation">,</span> <span class="token number">0x08</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    ucN <span class="token operator">=</span> PcdComMF522 <span class="token punctuation">(</span> PCD_TRANSCEIVE<span class="token punctuation">,</span> ucComMF522Buf<span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> ucComMF522Buf<span class="token punctuation">,</span> <span class="token operator">&amp;</span> ulLen <span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span> ucN <span class="token operator">==</span> MI_OK <span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span> ulLen <span class="token operator">==</span> <span class="token number">0x18</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span>
      ucN <span class="token operator">=</span> MI_OK<span class="token punctuation">;</span>  
    <span class="token keyword">else</span>
      ucN <span class="token operator">=</span> MI_ERR<span class="token punctuation">;</span>    

    <span class="token keyword">return</span> ucN<span class="token punctuation">;</span> 
<span class="token punctuation">}</span>

<span class="token comment">/* 函数名：CalulateCRC
 * 描述  ：用RC522计算CRC16
 * 输入  ：pIndata，计算CRC16的数组
 *         ucLen，计算CRC16的数组字节长度
 *         pOutData，存放计算结果存放的首地址
 * 返回  : 无
 * 调用  ：内部调用              */</span>
<span class="token keyword">void</span> CalulateCRC <span class="token punctuation">(</span> u8 <span class="token operator">*</span> pIndata<span class="token punctuation">,</span> u8 ucLen<span class="token punctuation">,</span> u8 <span class="token operator">*</span> pOutData <span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    u8 uc<span class="token punctuation">,</span> ucN<span class="token punctuation">;</span>

    <span class="token function">ClearBitMask</span><span class="token punctuation">(</span>DivIrqReg<span class="token punctuation">,</span><span class="token number">0x04</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">WriteRawRC</span><span class="token punctuation">(</span>CommandReg<span class="token punctuation">,</span>PCD_IDLE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">SetBitMask</span><span class="token punctuation">(</span>FIFOLevelReg<span class="token punctuation">,</span><span class="token number">0x80</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">for</span> <span class="token punctuation">(</span> uc <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> uc <span class="token operator">&lt;</span> ucLen<span class="token punctuation">;</span> uc <span class="token operator">++</span><span class="token punctuation">)</span>
        WriteRawRC <span class="token punctuation">(</span> FIFODataReg<span class="token punctuation">,</span> <span class="token operator">*</span> <span class="token punctuation">(</span> pIndata <span class="token operator">+</span> uc <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>   

    WriteRawRC <span class="token punctuation">(</span> CommandReg<span class="token punctuation">,</span> PCD_CALCCRC <span class="token punctuation">)</span><span class="token punctuation">;</span>
    uc <span class="token operator">=</span> <span class="token number">0xFF</span><span class="token punctuation">;</span>

    <span class="token keyword">do</span> <span class="token punctuation">{<!-- --></span>
        ucN <span class="token operator">=</span> ReadRawRC <span class="token punctuation">(</span> DivIrqReg <span class="token punctuation">)</span><span class="token punctuation">;</span>
        uc <span class="token operator">--</span><span class="token punctuation">;</span><span class="token punctuation">}</span> 
    <span class="token keyword">while</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span> uc <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span> <span class="token punctuation">(</span> ucN <span class="token operator">&amp;</span> <span class="token number">0x04</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
        
    pOutData <span class="token punctuation">[</span> <span class="token number">0</span> <span class="token punctuation">]</span> <span class="token operator">=</span> ReadRawRC <span class="token punctuation">(</span> CRCResultRegL <span class="token punctuation">)</span><span class="token punctuation">;</span>
    pOutData <span class="token punctuation">[</span> <span class="token number">1</span> <span class="token punctuation">]</span> <span class="token operator">=</span> ReadRawRC <span class="token punctuation">(</span> CRCResultRegM <span class="token punctuation">)</span><span class="token punctuation">;</span>
    
<span class="token punctuation">}</span>

<span class="token comment">/* 函数名：PcdAuthState
 * 描述  ：验证卡片密码
 * 输入  ：ucAuth_mode，密码验证模式
 *                     = 0x60，验证A密钥
 *                     = 0x61，验证B密钥
 *         u8 ucAddr，块地址
 *         pKey，密码
 *         pSnr，卡片序列号，4字节
 * 返回  : 状态值
 *         = MI_OK，成功
 * 调用  ：外部调用          */</span>
<span class="token keyword">char</span> PcdAuthState <span class="token punctuation">(</span> u8 ucAuth_mode<span class="token punctuation">,</span> u8 ucAddr<span class="token punctuation">,</span> u8 <span class="token operator">*</span> pKey<span class="token punctuation">,</span> u8 <span class="token operator">*</span> pSnr <span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">char</span> cStatus<span class="token punctuation">;</span>
    u8 uc<span class="token punctuation">,</span> ucComMF522Buf <span class="token punctuation">[</span> MAXRLEN <span class="token punctuation">]</span><span class="token punctuation">;</span>
    u32 ulLen<span class="token punctuation">;</span>

    ucComMF522Buf <span class="token punctuation">[</span> <span class="token number">0</span> <span class="token punctuation">]</span> <span class="token operator">=</span> ucAuth_mode<span class="token punctuation">;</span>
    ucComMF522Buf <span class="token punctuation">[</span> <span class="token number">1</span> <span class="token punctuation">]</span> <span class="token operator">=</span> ucAddr<span class="token punctuation">;</span>
    
    <span class="token keyword">for</span> <span class="token punctuation">(</span> uc <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> uc <span class="token operator">&lt;</span> <span class="token number">6</span><span class="token punctuation">;</span> uc <span class="token operator">++</span> <span class="token punctuation">)</span>
        ucComMF522Buf <span class="token punctuation">[</span> uc <span class="token operator">+</span> <span class="token number">2</span> <span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">*</span> <span class="token punctuation">(</span> pKey <span class="token operator">+</span> uc <span class="token punctuation">)</span><span class="token punctuation">;</span>   
    
    <span class="token keyword">for</span> <span class="token punctuation">(</span> uc <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> uc <span class="token operator">&lt;</span> <span class="token number">6</span><span class="token punctuation">;</span> uc <span class="token operator">++</span> <span class="token punctuation">)</span>
        ucComMF522Buf <span class="token punctuation">[</span> uc <span class="token operator">+</span> <span class="token number">8</span> <span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">*</span> <span class="token punctuation">(</span> pSnr <span class="token operator">+</span> uc <span class="token punctuation">)</span><span class="token punctuation">;</span>   

    cStatus <span class="token operator">=</span> PcdComMF522 <span class="token punctuation">(</span> PCD_AUTHENT<span class="token punctuation">,</span> ucComMF522Buf<span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">,</span> ucComMF522Buf<span class="token punctuation">,</span> <span class="token operator">&amp;</span> ulLen <span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span> cStatus <span class="token operator">!=</span> MI_OK <span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span> <span class="token operator">!</span> <span class="token punctuation">(</span> ReadRawRC <span class="token punctuation">(</span> Status2Reg <span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0x08</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            cStatus <span class="token operator">=</span> MI_ERR<span class="token punctuation">;</span> 
    <span class="token punctuation">}</span>
		
    <span class="token keyword">return</span> cStatus<span class="token punctuation">;</span>    
<span class="token punctuation">}</span>

<span class="token comment">/* 函数名：PcdWrite
 * 描述  ：写数据到M1卡一块
 * 输入  ：u8 ucAddr，块地址
 *         pData，写入的数据，16字节
 * 返回  : 状态值
 *         = MI_OK，成功
 * 调用  ：外部调用           */</span>
<span class="token keyword">char</span> PcdWrite <span class="token punctuation">(</span> u8 ucAddr<span class="token punctuation">,</span> u8 <span class="token operator">*</span> pData <span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">char</span> cStatus<span class="token punctuation">;</span>
      u8 uc<span class="token punctuation">,</span> ucComMF522Buf <span class="token punctuation">[</span> MAXRLEN <span class="token punctuation">]</span><span class="token punctuation">;</span>
    u32 ulLen<span class="token punctuation">;</span>

    ucComMF522Buf <span class="token punctuation">[</span> <span class="token number">0</span> <span class="token punctuation">]</span> <span class="token operator">=</span> PICC_WRITE<span class="token punctuation">;</span>
    ucComMF522Buf <span class="token punctuation">[</span> <span class="token number">1</span> <span class="token punctuation">]</span> <span class="token operator">=</span> ucAddr<span class="token punctuation">;</span>
    
    CalulateCRC <span class="token punctuation">(</span> ucComMF522Buf<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span> ucComMF522Buf <span class="token punctuation">[</span> <span class="token number">2</span> <span class="token punctuation">]</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
 
    cStatus <span class="token operator">=</span> PcdComMF522 <span class="token punctuation">(</span> PCD_TRANSCEIVE<span class="token punctuation">,</span> ucComMF522Buf<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> ucComMF522Buf<span class="token punctuation">,</span> <span class="token operator">&amp;</span> ulLen <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span> cStatus <span class="token operator">!=</span> MI_OK <span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span> ulLen <span class="token operator">!=</span> <span class="token number">4</span> <span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span> ucComMF522Buf <span class="token punctuation">[</span> <span class="token number">0</span> <span class="token punctuation">]</span> <span class="token operator">&amp;</span> <span class="token number">0x0F</span> <span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0x0A</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span>
      cStatus <span class="token operator">=</span> MI_ERR<span class="token punctuation">;</span>   
        
    <span class="token keyword">if</span> <span class="token punctuation">(</span> cStatus <span class="token operator">==</span> MI_OK <span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
      <span class="token function">memcpy</span><span class="token punctuation">(</span>ucComMF522Buf<span class="token punctuation">,</span> pData<span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span> uc <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> uc <span class="token operator">&lt;</span> <span class="token number">16</span><span class="token punctuation">;</span> uc <span class="token operator">++</span> <span class="token punctuation">)</span>
              ucComMF522Buf <span class="token punctuation">[</span> uc <span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">*</span> <span class="token punctuation">(</span> pData <span class="token operator">+</span> uc <span class="token punctuation">)</span><span class="token punctuation">;</span>  
            
      CalulateCRC <span class="token punctuation">(</span> ucComMF522Buf<span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span> ucComMF522Buf <span class="token punctuation">[</span> <span class="token number">16</span> <span class="token punctuation">]</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

      cStatus <span class="token operator">=</span> PcdComMF522 <span class="token punctuation">(</span> PCD_TRANSCEIVE<span class="token punctuation">,</span> ucComMF522Buf<span class="token punctuation">,</span> <span class="token number">18</span><span class="token punctuation">,</span> ucComMF522Buf<span class="token punctuation">,</span> <span class="token operator">&amp;</span> ulLen <span class="token punctuation">)</span><span class="token punctuation">;</span>
            
            <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span> cStatus <span class="token operator">!=</span> MI_OK <span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span> ulLen <span class="token operator">!=</span> <span class="token number">4</span> <span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span> ucComMF522Buf <span class="token punctuation">[</span> <span class="token number">0</span> <span class="token punctuation">]</span> <span class="token operator">&amp;</span> <span class="token number">0x0F</span> <span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0x0A</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span>
        cStatus <span class="token operator">=</span> MI_ERR<span class="token punctuation">;</span>   
            
    <span class="token punctuation">}</span> 

    <span class="token keyword">return</span> cStatus<span class="token punctuation">;</span>
    
<span class="token punctuation">}</span>

<span class="token comment">/* 函数名：PcdRead
 * 描述  ：读取M1卡一块数据
 * 输入  ：u8 ucAddr，块地址
 *         pData，读出的数据，16字节
 * 返回  : 状态值
 *         = MI_OK，成功
 * 调用  ：外部调用             */</span>
<span class="token keyword">char</span> PcdRead <span class="token punctuation">(</span> u8 ucAddr<span class="token punctuation">,</span> u8 <span class="token operator">*</span> pData <span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">char</span> cStatus<span class="token punctuation">;</span>
    u8 uc<span class="token punctuation">,</span> ucComMF522Buf <span class="token punctuation">[</span> MAXRLEN <span class="token punctuation">]</span><span class="token punctuation">;</span> 
    u32 ulLen<span class="token punctuation">;</span>

    ucComMF522Buf <span class="token punctuation">[</span> <span class="token number">0</span> <span class="token punctuation">]</span> <span class="token operator">=</span> PICC_READ<span class="token punctuation">;</span>
    ucComMF522Buf <span class="token punctuation">[</span> <span class="token number">1</span> <span class="token punctuation">]</span> <span class="token operator">=</span> ucAddr<span class="token punctuation">;</span>
    
    CalulateCRC <span class="token punctuation">(</span> ucComMF522Buf<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span> ucComMF522Buf <span class="token punctuation">[</span> <span class="token number">2</span> <span class="token punctuation">]</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
   
    cStatus <span class="token operator">=</span> PcdComMF522 <span class="token punctuation">(</span> PCD_TRANSCEIVE<span class="token punctuation">,</span> ucComMF522Buf<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> ucComMF522Buf<span class="token punctuation">,</span> <span class="token operator">&amp;</span> ulLen <span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span> cStatus <span class="token operator">==</span> MI_OK <span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span> ulLen <span class="token operator">==</span> <span class="token number">0x90</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span> uc <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> uc <span class="token operator">&lt;</span> <span class="token number">16</span><span class="token punctuation">;</span> uc <span class="token operator">++</span> <span class="token punctuation">)</span>
        <span class="token operator">*</span> <span class="token punctuation">(</span> pData <span class="token operator">+</span> uc <span class="token punctuation">)</span> <span class="token operator">=</span> ucComMF522Buf <span class="token punctuation">[</span> uc <span class="token punctuation">]</span><span class="token punctuation">;</span>   
    <span class="token punctuation">}</span>
        
    <span class="token keyword">else</span>
      cStatus <span class="token operator">=</span> MI_ERR<span class="token punctuation">;</span>   
    
    <span class="token keyword">return</span> cStatus<span class="token punctuation">;</span>

<span class="token punctuation">}</span>

<span class="token comment">/* 函数名：PcdHalt
 * 描述  ：命令卡片进入休眠状态
 * 输入  ：无
 * 返回  : 状态值
 *         = MI_OK，成功
 * 调用  ：外部调用        */</span>
<span class="token keyword">char</span> <span class="token function">PcdHalt</span><span class="token punctuation">(</span> <span class="token keyword">void</span> <span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    u8 ucComMF522Buf <span class="token punctuation">[</span> MAXRLEN <span class="token punctuation">]</span><span class="token punctuation">;</span> 
    u32  ulLen<span class="token punctuation">;</span>

    ucComMF522Buf <span class="token punctuation">[</span> <span class="token number">0</span> <span class="token punctuation">]</span> <span class="token operator">=</span> PICC_HALT<span class="token punctuation">;</span>
    ucComMF522Buf <span class="token punctuation">[</span> <span class="token number">1</span> <span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    CalulateCRC <span class="token punctuation">(</span> ucComMF522Buf<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span> ucComMF522Buf <span class="token punctuation">[</span> <span class="token number">2</span> <span class="token punctuation">]</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    PcdComMF522 <span class="token punctuation">(</span> PCD_TRANSCEIVE<span class="token punctuation">,</span> ucComMF522Buf<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> ucComMF522Buf<span class="token punctuation">,</span> <span class="token operator">&amp;</span> ulLen <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> MI_OK<span class="token punctuation">;</span>   
<span class="token punctuation">}</span>


</code></pre>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f62:6c6f672e6373646e2e6e65742f71715f34313739303037382f:61727469636c652f64657461696c732f313132353134343338" class_="artid" style="display:none">
 </p>
</div>


