---
layout: post
title: "比较两个数据库有何差异生成更新的SQL语句脚本"
date: 2024-12-13 10:33:35 +0800
description: "MySQL Utilities提供了一系列MySQL服务器和数据库的管理工具。完全支持MySQL5."
keywords: "mysql数据库数据差异对比 并生成sql语句"
categories: ['Mysql']
tags: ['无标签']
artid: "104357420"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=104357420
    alt: "比较两个数据库有何差异生成更新的SQL语句脚本"
render_with_liquid: false
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     比较两个数据库有何差异生成更新的SQL语句脚本
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="htmledit_views" id="content_views">
    <p>
     <strong>
      MySQL Utilities
     </strong>
     提供了一系列MySQL服务器和数据库的管理工具。
    </p>
    <p>
     完全支持MySQL5.1及以上版本，也兼容MySQL5.0版本，不过有些特性不支持。
    </p>
    <p>
     不支持MySQL4.0版本。
    </p>
    <p>
     下面这些工具工作在数据库级别，可以用来管理一个或多个服务器的数据库。
    </p>
    <h4>
     1 mysqldbcompare
    </h4>
    <ul>
     <li>
      比较两个服务器或同个服务器上的数据库
     </li>
     <li>
      比较定义文件和数据
     </li>
     <li>
      产生差异报告
     </li>
     <li>
      生成差异性的转换SQL语句
     </li>
    </ul>
    <p>
     <a href="https://www.awaimai.com/1531.html" rel="nofollow">
      查看mysqldbcompare教程
     </a>
    </p>
    <h4>
     2 mysqldiff
    </h4>
    <ul>
     <li>
      比较数据表
     </li>
     <li>
      比较表对象的定义
     </li>
     <li>
      产生差异的报告
     </li>
     <li>
      生成差异性的转换SQL语句
     </li>
    </ul>
    <p>
     <a href="https://www.awaimai.com/1513.html" rel="nofollow">
      查看mysqldiff教程
     </a>
    </p>
    <h4>
     3 mysqldbcopy
    </h4>
    <ul>
     <li>
      服务器之间复制数据库
     </li>
     <li>
      在同一台服务器上克隆数据库
     </li>
     <li>
      支持重命名
     </li>
    </ul>
    <h4>
     4 mysqldbexport
    </h4>
    <ul>
     <li>
      从一个或多个数据库导出元数据和或数据
     </li>
     <li>
      支持的格式: SQL, CSV, TAB, Grid, Vertical
     </li>
    </ul>
    <h4>
     5 mysqldbimport
    </h4>
    <ul>
     <li>
      从一个或多个文件导入元数据和数据
     </li>
     <li>
      支持mysqldbexport各种格式
     </li>
    </ul>
    <p>
    </p>
    <h2>
     mysqldbcompare MySQL数据库比较工具
    </h2>
    <p>
     <code>
      mysqldbcompare
     </code>
     用于比较两个服务器或同个服务器上的
     <strong>
      数据库
     </strong>
     ，有文件和数据，并生成差异性SQL语句。
    </p>
    <p>
     要比较
     <strong>
      数据表
     </strong>
     ，请用另外一个工具：
     <code>
      mysqldiff
     </code>
     （
     <a href="http://www.awaimai.com/1513.html" rel="nofollow">
      点击查看教程
     </a>
     ）。
    </p>
    <p>
     以下是
     <code>
      mysqldbcompare
     </code>
     的用法。
    </p>
    <h3>
     1 安装
    </h3>
    <p>
     <code>
      mysqldbcompare
     </code>
     是
     <strong>
      MySQL Utilities
     </strong>
     中的一个脚本，默认的MySQL不包含工具集，所以需要独立安装。
    </p>
    <ul>
     <li>
      MySQL Utilities下载地址：
      <a href="http://downloads.mysql.com/archives/utilities/" rel="nofollow">
       http://downloads.mysql.com/archives/utilities/
      </a>
      。
     </li>
     <li>
      Windows系统中需提前安装“
      <strong>
       Visual C++ Redistributable Packages for Visual Studio 2013
      </strong>
      ”，下载地址：
      <a href="https://www.microsoft.com/en-gb/download/details.aspx?id=40784" rel="nofollow">
       https://www.microsoft.com/en-gb/download/details.aspx?id=40784
      </a>
      。
     </li>
    </ul>
    <p>
     Linux系统在下载页面选择对应发行版。
    </p>
    <h3>
     2 语法
    </h3>
    <p>
     <code>
      mysqldbcompare
     </code>
     的语法如下：
    </p>
    <pre>$ mysqldbcompare --server1=user:pass@host:port:socket --server2=user:pass@host:port:socket db1:db2</pre>
    <p>
     以上参数中：
    </p>
    <ul>
     <li>
      <code>
       --server1
      </code>
      ：MySQL服务器1配置。
     </li>
     <li>
      <code>
       --server2
      </code>
      ：MySQL服务器2配置。如果是同一服务器，
      <code>
       --server2
      </code>
      可以省略。
     </li>
     <li>
      <code>
       db1:db2
      </code>
      ：要比较的两个数据库。如果比较不同服务器上的同名数据库，可以省略
      <code>
       :db2
      </code>
      。
     </li>
     <li>
      <code>
       --all
      </code>
      ：比较所有两服务器上所有的同名数据库。
      <code>
       --exclude
      </code>
      排除无需比较的数据库。
     </li>
     <li>
      <code>
       --run-all-tests
      </code>
      ：运行完整比较，遇到第一次差异时不停止。
     </li>
     <li>
      <code>
       --changes-for=
      </code>
      ：修改对象。例如
      <code>
       --changes-for=server2
      </code>
      ，那么对比以
      <code>
       sever1
      </code>
      为主，生成的差异的修改也是针对
      <code>
       server2
      </code>
      的对象的修改。
     </li>
     <li>
      <code>
       -d DIFFTYPE
      </code>
      ,
      <code>
       --difftype=DIFFTYPE
      </code>
      ：差异的信息显示的方式，有
      <code>
       [unified|context|differ|sql]
      </code>
      ，默认是
      <code>
       unified
      </code>
      。如果使用sql，那么就直接生成差异的SQL，这样非常方便。
     </li>
     <li>
      <code>
       --show-reverse
      </code>
      ：在生成的差异修改里面，同时会包含
      <code>
       server2
      </code>
      和
      <code>
       server1
      </code>
      的修改。
     </li>
     <li>
      <code>
       --skip-table-options
      </code>
      ：保持表的选项不变，即对比的差异里面不包括
      <code>
       表名
      </code>
      、
      <code>
       AUTO_INCREMENT
      </code>
      、
      <code>
       ENGINE
      </code>
      、
      <code>
       CHARSET
      </code>
      等差异。
     </li>
     <li>
      <code>
       --skip-diff
      </code>
      ：跳过对象定义比较检查。所谓对象定义，就是
      <code>
       CREATE
      </code>
      语句
      <code>
       ()
      </code>
      里面的部分，
      <code>
       --skip-table-options
      </code>
      是()外面的部分。
     </li>
     <li>
      <code>
       --skip-object-compare
      </code>
      ：默认情况下，先检查两个数据库中相互缺失的对象，再对都存在对象间的差异。这个参数的作用就是，跳过第一步，不检查相互缺失的对象。
     </li>
     <li>
      <code>
       --skip-checksum-table
      </code>
      ：数据一致性验证时跳过
      <code>
       CHECKSUM TABLE
      </code>
      。
     </li>
     <li>
      <code>
       --skip-data-check
      </code>
      ：跳过数据一致性验证。
     </li>
     <li>
      <code>
       --skip-row-count
      </code>
      ：跳过字段数量检查。
     </li>
    </ul>
    <h3>
     3 示例
    </h3>
    <p>
     比较两个数据库，并生成差异SQL：
    </p>
    <pre>$ mysqldbcompare --server1=root:root@localhost --server2=root:root@localhost db1:db2 --changes-for=server1 -a --difftype=sql


# WARNING: Objects in server1.db1 but not in server1.db2:
# TABLE: table2
#
# WARNING: Objects in server1.db2 but not in server1.tb1:
# TABLE: table3
#
#                                                   Defn    Row     Data
# Type      Object Name                             Diff    Count   Check
#-------------------------------------------------------------------------
# TABLE     t1                                      pass    pass    -
#           - Compare table checksum                                FAIL
#           - Find row differences                                  FAIL
#
# Transformation for --changes-for=server1:
#

# Data differences found among rows:
UPDATE db1.t1 SET b = 'Test 123' WHERE a = '1';
UPDATE db1.t1 SET b = 'Test 789' WHERE a = '3';
DELETE FROM db1.t1 WHERE a = '4';
INSERT INTO db1.t1 (a, b) VALUES('5', 'New row - db2');


# Database consistency check failed.
#
# ...done</pre>
    <p>
     <code>
      WARNING
     </code>
     之后提示两个数据库表之间的差异，也就是一个数据库中有，另一个数据库没有的数据表。
    </p>
    <p>
     之后就是差异的SQL语句了，把有
     <code>
      #
     </code>
     号注释的行删掉，就能直接在数据库中执行了。
    </p>
    <blockquote>
     <p>
      说明：执行MySQL语句时可能会遇到这样错误：Error 1054 - Unknown column 'name' in 'aspect'
     </p>
     <p>
      这是因为
      <code>
       mysqldbcompare
      </code>
      生成的
      <code>
       ALTER
      </code>
      语句中，用逗号
      <code>
       ,
      </code>
      拼装了多条
      <code>
       ADD
      </code>
      、
      <code>
       CHANGE
      </code>
      等语句，如果这些语句还包含
      <code>
       AFTER
      </code>
      关键字，就会提示这个错误并中断执行MySQL语句。解决的办法就是：去除
      <code>
       AFTER
      </code>
      及其后面的条件。
     </p>
     <p>
      这可能是MySQL的一个Bug，详情参考：
      <a href="http://bugs.mysql.com/bug.php?id=34972" rel="nofollow">
       http://bugs.mysql.com/bug.php?id=34972
      </a>
      和
      <a href="http://bugs.mysql.com/bug.php?id=60650" rel="nofollow">
       http://bugs.mysql.com/bug.php?id=60650
      </a>
      。
     </p>
    </blockquote>
    <p>
    </p>
    <p>
     <strong>
      参考链接：
     </strong>
    </p>
    <ol>
     <li>
      <a href="http://blog.itpub.net/26418713/viewspace-1398195/" rel="nofollow">
       mysql之mysqldbcompare实现多库数据对比
      </a>
     </li>
     <li>
      <a href="https://dev.mysql.com/doc/mysql-utilities/1.5/en/mysqldbcompare.html" rel="nofollow">
       mysqldbcompare — Compare Two Databases and Identify Differences
      </a>
     </li>
    </ol>
    <p>
    </p>
    <p>
     cd /download
     <br/>
     wget https://cdn.mysql.com/archives/mysql-utilities/mysql-utilities-1.6.5.tar.gz
     <br/>
     tar xvf mysql-utilities-1.6.5.tar.gz
     <br/>
     cd mysql-utilities-1.6.5
     <br/>
     python setup.py build
     <br/>
     python setup.py insta
    </p>
    <p>
    </p>
    <p>
     -h192.168.11.2 -uroot -p'zq!aHHHDmgH4DIq!si'
    </p>
    <p>
     -h192.168.8.73 -umoHsh -p'NAH43aHHHHjog9bGYQk'
    </p>
    <p>
     mysqldbcompare --server1=root:root@localhost --server2=root:root@localhost db1:db2 --changes-for=server1 -a --difftype=sql
     <br/>
     <br/>
     mysqldbcompare --server1=root:'zqHH4DIq!si'@192.168.11.232 --server2=moHsh:'NAHHg9bGYQk'@192.168.8.3 system232:system --run-all-tests --changes-for=server1  --difftype=sql
    </p>
    <p>
    </p>
    <p>
    </p>
    <p>
     一、简介
     <br/>
     在使用mysql replication时，有时候会担心，如果主库和备库的数据不一致，怎么办？之前，自己用过一个非常笨的办法，就是，根据生产库的中的主键，从information_schema中，把生产库中的表和字段全部查出来，然后查询每个字段的数据，一一对比。这样的话，在数据量特别大的情况下，耗时简直恐怖。
     <br/>
     最近找到了一个mysql的工具，mysqldbcompare，可以实现对多库数据的对比。
     <br/>
     官方文档：http://dev.mysql.com/doc/mysql-utilities/1.3/en/mysqldbcompare.html
     <br/>
     工具下载地址：http://downloads.mysql.com/snapshots/pb/mysql-connector-utilities-fabric/mysql-utilities-1.4.0-labs-fabric.tar.gz
     <br/>
     二、安装
     <br/>
     解压安装后，需要使用python命令进行安装
     <br/>
     cd mysql-utilities-1.4.0-labs-fabric
     <br/>
     python setup.py install
     <br/>
     安装完成后，mysqldbcompare命令在/usr/local/bin下面。
     <br/>
     三、mysqldb用法
     <br/>
     详细的参数解释，可以参照官方文档。这里只解释几个常用的参数
     <br/>
     --server1=user:passwprd@host    要对比的第一个库，指定用户、密码和主机。如果没有密码，密码可以忽略
     <br/>
     --server2=user:password@host    要对比的第二个库，指定用户、密码和主机。如果没有密码，密码可以忽略
     <br/>
     --difftype=[
     <strong>
      unified
     </strong>
     |
     <strong>
      context
     </strong>
     |
     <strong>
      differ
     </strong>
     |
     <strong>
      sql
     </strong>
     ] unified和context、differ:会显示相差的具体的数据。sql：会生成的具体的SQL。具体信息，如下：
     <br/>
     <a href="http://blog.itpub.net/blog/downLoad/fileid/42678" rel="nofollow">
      difftype_sql.txt
     </a>
    </p>
    <p>
     <a href="http://blog.itpub.net/blog/downLoad/fileid/42679" rel="nofollow">
      difftype_differ.txt
     </a>
    </p>
    <p>
     <a href="http://blog.itpub.net/blog/downLoad/fileid/42680" rel="nofollow">
      difftype_unified.txt
     </a>
    </p>
    <p>
     <a href="http://blog.itpub.net/blog/downLoad/fileid/42681" rel="nofollow">
      difftype_context.txt
     </a>
     <br/>
     --changes-for=[server1|server2] 以difftype=sql为例,如果设置changes-for=server1，那么，生成的sql是update server1.tables set * * * *
     <br/>
     --run-all-test 检查所有，即使检测到第一个不一致的数据，仍然继续。
     <br/>
     绝大部分情况下，我们需要检查特定的几个库，这是可以指定命令，比如：
     <br/>
     mysqldbcompare --server1=root:root@127.0.0.1:3306 --server2=root:root@127.0.0.1:3307 --run-all-test --changes-for=server1 --difftype=sql test1:test2
     <br/>
     其中，test1库是server1上的库，test2是server2上的库。这样，我们就只检查test1和test2这两个库。
    </p>
   </div>
  </div>
 </article>
 <p alt="6874747073:3a2f2f626c6f672e6373646e2e6e65742f6561676c6538392f:61727469636c652f64657461696c732f313034333537343230" class_="artid" style="display:none">
 </p>
</div>


