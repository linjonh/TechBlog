---
layout: post
title: "Django-服务器部署全过程"
date: 2023-05-18 15:54:30 +0800
description: "本文详细介绍了如何将Django工程部署到云服务器，包括准备Git仓库的Django项目，购买和配置"
keywords: "django部署到服务器"
categories: ['Python']
tags: ['服务器', 'Python', 'Django']
artid: "130748843"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=130748843
    alt: "Django-服务器部署全过程"
render_with_liquid: false
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     Django 服务器部署全过程
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <p>
    </p>
    <div class="toc">
     <h4>
      目录
     </h4>
     <ul>
      <li>
       <ul>
        <li>
         <a href="#_1" rel="nofollow">
          准备工作
         </a>
        </li>
        <li>
         <a href="#_13" rel="nofollow">
          服务器软件环境
         </a>
        </li>
        <li>
         <ul>
          <li>
           <a href="#Nginx_77" rel="nofollow">
            Nginx配置
           </a>
          </li>
         </ul>
        </li>
        <li>
         <a href="#https_126" rel="nofollow">
          https访问配置
         </a>
        </li>
        <li>
         <a href="#_screen_164" rel="nofollow">
          终端管理工具 screen
         </a>
        </li>
       </ul>
      </li>
     </ul>
    </div>
    <p>
    </p>
    <h3>
     <a id="_1">
     </a>
     准备工作
    </h3>
    <p>
     需要准备的内容有：
    </p>
    <ol>
     <li>
      托管到git服务器的Django工程；
     </li>
     <li>
      购买腾讯、阿里或其他品牌的云服务器；
     </li>
     <li>
      如果需要部署https服务，另外购买一个域名。
     </li>
    </ol>
    <p>
     本文档测试环境：
     <br/>
     腾讯云轻量服务器，Ubuntu22.04操作系统，系统自带Python 3.10版
     <br/>
     Django工程使用MySQL数据库，redis缓存
    </p>
    <h3>
     <a id="_13">
     </a>
     服务器软件环境
    </h3>
    <p>
     云服务器建议使用密钥登陆，可在网页端或电脑上使用MobaXterm等ssh终端登陆。
    </p>
    <p>
     服务器软件环境主要包括 Django的运行环境 和 Nginx服务。
    </p>
    <p>
     首先安装Django的运行环境软件
    </p>
    <pre><code class="prism language-sh">echo y | sudo apt update
echo y | sudo apt upgrade
echo y | sudo apt install nginx mysql-server redis python3-dev default-libmysqlclient-dev build-essential

# git 配置
git config --global user.name "xxx"
git config --global user.email "xxx@xx.com"
git config --global credential.helper store

# 切换用户工作目录
cd /home/ubuntu/

# 创建Python 虚拟环境
echo y | sudo apt install python3.10-venv
python3 -m venv django32
source ./django32/bin/activate

# 创建源代代码工作目录, 并同步源代码，需要输入git的账号密码
mkdir webapp
cd webapp

git clone https://gitee.com/xxx/django_project.git

cd django_project
pip install -r requirements.txt

</code></pre>
    <p>
     然后准备完成数据库迁移。
     <br/>
     需要先为Django项目创建数据库和数据库访问用户，与Django代码中的数据库配置一致
     <br/>
     这里需要先在服务器上做好数据库的设置。可参考以下操作命令：
    </p>
    <pre><code class="prism language-sh"># 初次登陆mysql不需要密码
mysql -u root
# 修改root密码
ALTER user 'root'@'localhost' IDENTIFIED WITH mysql_native_password BY 'Xpassword'; 
# 为Django项目创建数据库 和 数据库用户
CREATE DATABASE django_db ;
CREATE USER 'django_user'@'localhost' IDENTIFIED BY 'password';
GRANT ALL ON `django_db`.*  TO 'django_user'@'localhost';
GRANT SYSTEM_USER ON *.*  TO 'django_user'@'localhost';
# 退出MySQL
exit;
# Django数据迁移
python manage.py makemigrations 
python manage.py migrate

# Django静态文件迁移
python manage.py collectstatic

</code></pre>
    <p>
     这里也可以使用云数据库，修改数据库配置的账号密码，主机地址与云端一一对应即可。
    </p>
    <h4>
     <a id="Nginx_77">
     </a>
     Nginx配置
    </h4>
    <p>
     运行Nginx服务前，需要为Django项目写一个配置文件：
    </p>
    <pre><code class="prism language-sh">touch /etc/nginx/sites-available/django.conf 
ln -s /etc/nginx/sites-available/django.conf  /etc/nginx/sites-enabled/django
</code></pre>
    <p>
     django.conf 参考配置内容如下：
    </p>
    <pre><code>server{
    listen 80;
	server_name 127.0.0.1;                              #访问django项目的网站
	client_max_body_size 8m;                            #上传数据的大小限制
	access_log /var/www/log/nginx.access.log;           #访问日志,需要事先生成这个文件
	error_log /var/www/log/nginx.error.log;             #错误日志,需要事先生成这个文件
	location /static/ {
        root /home/ubuntu/webapp/django_project/;
		expires 30d;
    }
	location /uploads/ {                                # 对应Django设置文件中的 MEDIA_ROOT
        alias /home/ubuntu/webapp/django_project/;
		expires 30d;
    }
    location / {
        #动态请求交给gunicorn ，这里的端口号与下文 gunicorn 执行命令中的端口号必须一致
		proxy_pass http://127.0.0.1:8899;
		proxy_connect_timeout 500s;		# 超时时间设置
		proxy_read_timeout 500s;
		proxy_send_timeout 500s;
		proxy_set_header Host $host;
		proxy_set_header X-Real-IP $remote_addr;
		proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
}

</code></pre>
    <p>
     执行以下命令检查Nginx配置是否正确，并重启Nginx
    </p>
    <pre><code class="prism language-sh">nginx -t 
ningx -s reload
</code></pre>
    <p>
     运行Django项目：
     <code>
      gunicorn -k gevent -t 120 -w 2 -b 127.0.0.1:8899 django_project.wsgi
     </code>
     . 这里的
     <strong>
      端口号必须与Nginx配置项一致
     </strong>
     。
     <br/>
     至此已经可以通过IP地址访问Django网站了。
    </p>
    <h3>
     <a id="https_126">
     </a>
     https访问配置
    </h3>
    <p>
     https配置需要事先买一个域名，并配置好域名解析。
     <br/>
     <img alt="" src="https://i-blog.csdnimg.cn/blog_migrate/12d0f35da9634252faef3c71129ef010.png"/>
    </p>
    <p>
     <strong>
      https配置
     </strong>
     参考certbot网站的方案：
    </p>
    <p>
     <img alt="" src="https://i-blog.csdnimg.cn/blog_migrate/00451908aa0a4487f677ebe2d7927b78.png"/>
    </p>
    <p>
     在certbot网页界面上选择web服务软件和服务器操作系统，按提示命令一步步操作。
    </p>
    <p>
     然后在打开文件 /etc/nginx/sites-available/default ，将其中SSL配置项复制到Django项目的Nginx配置文件中：
    </p>
    <pre><code>server{
    listen 443 ssl; # managed by Certbot
    server_name you_domain.com;                              # 域名
    ssl_certificate /etc/letsencrypt/live/clzw.tech/fullchain.pem; # managed by Certbot
    ssl_certificate_key /etc/letsencrypt/live/clzw.tech/privkey.pem; # managed by Certbot
    include /etc/letsencrypt/options-ssl-nginx.conf; # managed by Certbot
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem; # managed by Certbot

    # listen 80;
	# server_name ;                              #访问django项目的网站
	client_max_body_size 8m;                            #上传数据的大小限制
	access_log /var/www/log/nginx.access.log;           #访问日志,需要事先生成这个文件
	error_log /var/www/log/nginx.error.log;             #错误日志,需要事先生成这个文件
    ...
}

</code></pre>
    <p>
     重启nginx服务。
    </p>
    <p>
     如果出现静态资源目录下面文件无法访问，浏览器访问提示403 forbidden，可以修改 /etc/nginx/nginx.conf 配置文件头部的user设置。
     <a href="https://segmentfault.com/a/1190000009012487" rel="nofollow">
      参考链接
     </a>
    </p>
    <h3>
     <a id="_screen_164">
     </a>
     终端管理工具 screen
    </h3>
    <p>
     使用screen 可以让linux命令行（ 比如 gunicorn 命令行 ）在退出MobaXTeam或网页终端界面后继续执行 ，下次登陆时可以回到先前的中断界面 查看程序输出。
     <br/>
     常用的命令参数如下：
    </p>
    <p>
     screen -S yourname -&gt; 新建一个叫yourname的session
     <br/>
     screen -ls -&gt; 列出当前所有的session
     <br/>
     screen -r yourname -&gt; 回到yourname这个session
     <br/>
     screen -d yourname -&gt; 远程detach某个session
     <br/>
     screen -d -r yourname -&gt; 结束当前session并回到yourname这个session
    </p>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a:2f2f626c6f672e6373646e2e6e65742f77756a62636c7a772f:61727469636c652f64657461696c732f313330373438383433" class_="artid" style="display:none">
 </p>
</div>


