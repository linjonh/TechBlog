---
layout: post
title: "-微信小程序的坑之wx.miniProgram.postMessage"
date: 2025-01-14 05:30:00 +0800
description: "工作中有个需求是小程序的网页在关闭的时候，需要回传给小程序一个参数查阅小程序官方文档，有这样一个接口"
keywords: "wx.miniprogram.postmessage"
categories: ["未分类"]
tags: ["开发工具", "Viewui", "Php", "Javascript"]
artid: "88717625"
image:
  path: https://api.vvhan.com/api/bing?rand=sj&artid=88717625
  alt: "-微信小程序的坑之wx.miniProgram.postMessage"
render_with_liquid: false
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     微信小程序的坑之wx.miniProgram.postMessage
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="htmledit_views" id="content_views">
    <div class="article fmt article__content">
     <p>
      工作中有个需求是小程序的网页在关闭的时候，需要回传给小程序一个参数
     </p>
     <p>
      查阅
      <a href="https://developers.weixin.qq.com/miniprogram/dev/component/web-view.html?search-key=wx.miniProgram.postMessage" rel="nofollow">
       小程序官方文档
      </a>
      ，有这样一个接口
      <code>
       wx.miniProgram.postMessage
      </code>
      ，可以用来从网页向小程序发送消息，然后通过
      <code>
       bindmessage
      </code>
      事件来监听消息，如下是官方文档描述
     </p>
     <p>
      <span class="img-wrap">
       <img alt="clipboard.png" src="https://i-blog.csdnimg.cn/blog_migrate/89660a08022704d695dd9b6cb47d484c.png" title="clipboard.png"/>
      </span>
     </p>
     <p>
      以下是代码：
     </p>
     <pre><code>// 网页代码
&lt;!DOCTYPE html&gt;
&lt;html&gt;
    &lt;head&gt;
        &lt;meta charset="utf-8"&gt;
        &lt;meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no"&gt;
        &lt;title&gt;postMessage&lt;/title&gt;
    &lt;/head&gt;

    &lt;body&gt;
        &lt;script type="text/javascript" src="https://res.wx.qq.com/open/js/jweixin-1.3.2.js"&gt;&lt;/script&gt;
        &lt;script type="text/javascript"&gt;
            wx.miniProgram.postMessage({ data: '获取成功' })

            wx.miniProgram.navigateBack({delta: 1})
        &lt;/script&gt;
    &lt;/body&gt;

&lt;/html&gt;
</code></pre>
<pre><code>// 小程序代码
&lt;web-view bindmessage="handleGetMessage" src="test.html"&gt;&lt;/web-view&gt;

Page({
handleGetMessage: function(e) {
console.log(e.target.data)
}
})</code></pre>
<p>
<strong>
写完试了下，期待打印 “获取成功” ，而实际小程序里面啥也没打印。。。
</strong>
</p>
<p>
然后仔细看官方文档，发现有这句话：
</p>
<blockquote>
网页向小程序
<code>
postMessage
</code>
时，会在
<strong>
特定时机（小程序后退、组件销毁、分享）触发
</strong>
并收到消息。
</blockquote>
<p>
也就是只有在小程序后退、组件销毁、分享时才会触发
</p>
<p>
所以应该改变
<code>
postMessage
</code>
的时机，调换顺序就可以了
</p>
<pre><code>&lt;script type="text/javascript"&gt;
wx.miniProgram.navigateBack({delta: 1})

    wx.miniProgram.postMessage({ data: '获取成功' })

&lt;/script&gt;</code></pre>
<p>
这样再试试，发现能正常捕获消息了
</p>
</div>

   </div>
  </div>
  <div id="recommendDown">
  </div>
 </article>
 <p alt="68747470733a2f2f626c6f67:2e6373646e2e6e65742f77656978696e5f3333383538323439:2f61727469636c652f64657461696c732f3838373137363235" class_="artid" style="display:none">
 </p>
</div>
