---
layout: post
title: "小程序静默登录-登录拦截实现方案全局loginPromis加页面拦截"
date: 2024-09-05 18:55:07 +0800
description: "文章讲述了在微信小程序中，由于生命周期函数不支持异步阻塞，可能导致未完成登录就尝试访问需要验证接口的"
keywords: "小程序登录拦截"
categories: ['未分类']
tags: ['小程序']
artid: "134619427"
image:
  path: https://api.vvhan.com/api/bing?rand=sj&artid=134619427
  alt: "小程序静默登录-登录拦截实现方案全局loginPromis加页面拦截"
render_with_liquid: false
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     小程序静默登录-登录拦截实现方案【全局loginPromis加页面拦截】
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <h3>
     <a id="_0">
     </a>
     实现效果：
    </h3>
    <p>
     用户进入小程序访问所有页面运行onload、onShow、onReady函数时保证业务登录态是有效的
    </p>
    <h3>
     <a id="_3">
     </a>
     实现难点：
    </h3>
    <p>
     由于小程序的启动流程中，页面级和组件级的生命周期函数都不支持异步阻塞；因此会造成一个情况，app.onLaunch或者app.onShow中发起的wx.login还没有成功的时候，页面级的生命周期函数已经向服务器发起了请求。由于我们的接口设计大部分都是需要验证的，此时登录还未成功，token也还没有正确返回，因此页面级的生命周期发起的数据获取接口肯定是会报错的（例如返回了401）
    </p>
    <p>
     这样子的话每个页面都需要加登录判断，维护难度很大。
    </p>
    <h3>
     <a id="_8">
     </a>
     解决思路：
    </h3>
    <p>
     挟持Page并使用全局loginPromise形式，可保障任意页面执行onload、onShow、onReady函数前保证业务登录态的有效。无登录态或者登录态失效时先await等待全局loginPromise推向resolve后，才释放页面的onload、onShow、onReady函数的执行。下面用wps画的小程序登录流程流程图：
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/cdc77b71b5507ea122dfb92b476b9eea.jpeg#pic_center"/>
    </p>
    <h3>
     <a id="_12">
     </a>
     流程图应该是很明白了，直接上代码：
    </h3>
    <pre><code class="prism language-js"><span class="token comment">// app.js</span>
<span class="token keyword">import</span> <span class="token string">'./utils/login-intercept'</span><span class="token punctuation">;</span>
<span class="token function">App</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
  <span class="token literal-property property">globalData</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token literal-property property">loginPro</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function">onLaunch</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function">onShow</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">checkLoginStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token keyword">async</span> <span class="token function">checkLoginStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>globalData<span class="token punctuation">.</span>loginPro <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
      <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 模拟登录需要三秒 如果之前有业务登录态且业务登录态有效那么直接resolve</span>
        <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'login Status is valid!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre>
<pre><code class="prism language-js"><span class="token comment">// utils/login-intercept.js</span>
<span class="token comment">// 页面扩展</span>
<span class="token keyword">const</span> oldPage <span class="token operator">=</span> Page<span class="token punctuation">;</span>
<span class="token function-variable function">Page</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">pageParams</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token keyword">const</span> <span class="token punctuation">{<!-- --></span> onLoad<span class="token punctuation">,</span> onShow<span class="token punctuation">,</span> onReady <span class="token punctuation">}</span> <span class="token operator">=</span> pageParams<span class="token punctuation">;</span>
pageParams<span class="token punctuation">.</span><span class="token function-variable function">onLoad</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">params</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token keyword">await</span> <span class="token function">getApp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>globalData<span class="token punctuation">.</span>loginPro<span class="token punctuation">;</span>
onLoad <span class="token operator">&amp;&amp;</span> <span class="token function">onLoad</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> params<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

pageParams<span class="token punctuation">.</span><span class="token function-variable function">onShow</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token keyword">await</span> <span class="token function">getApp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>globalData<span class="token punctuation">.</span>loginPro<span class="token punctuation">;</span>
onShow <span class="token operator">&amp;&amp;</span> <span class="token function">onShow</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

pageParams<span class="token punctuation">.</span><span class="token function-variable function">onReady</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token keyword">await</span> <span class="token function">getApp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>globalData<span class="token punctuation">.</span>loginPro<span class="token punctuation">;</span>
onReady <span class="token operator">&amp;&amp;</span> <span class="token function">onReady</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">return</span> <span class="token function">oldPage</span><span class="token punctuation">(</span>pageParams<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

</code></pre>
<h3>
<a id="_62">
</a>
代码片段
</h3>
<p>
<a href="https://developers.weixin.qq.com/s/QbGqfwmR7pNH" rel="nofollow">
https://developers.weixin.qq.com/s/QbGqfwmR7pNH
</a>
</p>
<p>
参考文章：
<br/>
<a href="https://juejin.cn/post/7046970790050267149" rel="nofollow">
如何保证小程序的每个页面，在执行页面周期时，都是已登录
<br/>
</a>
<br/>
按照参考文章写代码的时候发现了一个问题：里面用的发布订阅模式在使用时，先得在页面订阅，在 app.js 里的 onLauch 或 onShow 执行完后发布后，页面 onLoad、onShow、onReady 函数里可能还未进行订阅，这时这种方案就有问题。最后采用了参考文章里的页面劫持方案和全局 loginPromise 的方式完成了登录页面拦截的实现方案。
<br/>
最后： 感谢参考文章的作者大大，给了我们一个页面劫持的方案
</p>

   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f626c6f672e:6373646e2e6e65742f77656978696e5f34353436333036312f:61727469636c652f64657461696c732f313334363139343237" class_="artid" style="display:none">
 </p>
</div>
