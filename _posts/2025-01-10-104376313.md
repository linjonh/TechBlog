---
layout: post
title: "微信小程序订阅消息功能实现"
date: 2025-01-10 14:01:51 +0800
description: "博客简介本篇博客介绍如何自建服务器使用微信小程序的订阅消息功能，消息能力是小程序能力中的重要组成，为"
keywords: "wx.requestsubscribemessage传的tmplids是什么"
categories: ['=>微信小程序开发']
tags: ['无标签']
artid: "104376313"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=104376313
    alt: "微信小程序订阅消息功能实现"
render_with_liquid: false
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     微信小程序订阅消息功能实现
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-github-gist" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <h3>
     <a id="_0">
     </a>
     博客简介
    </h3>
    <p>
     本篇博客介绍如何自建服务器使用微信小程序的订阅消息功能，消息能力是小程序能力中的重要组成，为实现服务的闭环和更优的体验。使用方法步骤如下：
    </p>
    <ul>
     <li>
      步骤一：获取模板 ID
     </li>
     <li>
      步骤二：获取下发权限
     </li>
     <li>
      步骤三：调用接口下发订阅消息
     </li>
    </ul>
    <h3>
     <a id="_ID_7">
     </a>
     步骤一：获取模板 ID
    </h3>
    <p>
     在使模板的过程中，我们必须知道要获取的是哪个模板，微信官方为我们提供了这样的模板，我们需要订阅模板，并且获取模板的唯一标识id：
    </p>
    <ul>
     <li>
      在微信公众平台手动配置获取模板 ID
     </li>
     <li>
      网址：
      <a href="https://mp.weixin.qq.com" rel="nofollow">
       https://mp.weixin.qq.com
      </a>
      获取模板
     </li>
     <li>
      如果没有合适的模板，可以申请添加新模板，审核通过后可使用
     </li>
    </ul>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/14ec3b1caba51ec7674b954fc4aaad92.png"/>
    </p>
    <h3>
     <a id="_15">
     </a>
     步骤二：获取下发权限
    </h3>
    <p>
     下发权限的获取十分简单，只需要在小程序端调用requestSubscribeMessage API即可
     <br/>
     参数如下：
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/ff129260640238944bc905cfdd12c7c3.png">
      <br/>
      使用方法：
     </img>
    </p>
    <pre><code class="prism language-javascript">wx<span class="token punctuation">.</span><span class="token function">requestSubscribeMessage</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
  tmplIds<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">''</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token function">success</span> <span class="token punctuation">(</span>res<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre>
    <p>
     这个时候我们可以看到调用时，屏幕下部弹出一个消息框：
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/132bc0842fc015f1e45780c0eb8bc98e.png"/>
    </p>
    <h3>
     <a id="_29">
     </a>
     步骤三：调用接口下发订阅消息
    </h3>
    <h4>
     <a id="1POSTsubscribeMessagesend_30">
     </a>
     （1）下发消息的核心在于发送POST请求：
     <code>
      subscribeMessage.send
     </code>
     ，通过此条请求我们将获得下发能力：
    </h4>
    <ul>
     <li>
      subscribeMessage.send支持https调用和云调用
     </li>
     <li>
      请求地址：
      <a rel="nofollow">
       POST https://api.weixin.qq.com/cgi-bin/message/subscribe/send?access_token=ACCESS_TOKEN
      </a>
     </li>
     <li>
      请求参数
      <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/2545259393c0cf8d9700845169336b08.png"/>
     </li>
     <li>
      请求示例：
     </li>
    </ul>
    <pre><code class="prism language-javascript"><span class="token punctuation">{<!-- --></span>
  <span class="token string">"touser"</span><span class="token punctuation">:</span> <span class="token string">"OPENID"</span><span class="token punctuation">,</span>
  <span class="token string">"template_id"</span><span class="token punctuation">:</span> <span class="token string">"TEMPLATE_ID"</span><span class="token punctuation">,</span>
  <span class="token string">"page"</span><span class="token punctuation">:</span> <span class="token string">"index"</span><span class="token punctuation">,</span>
  <span class="token string">"miniprogram_state"</span><span class="token punctuation">:</span><span class="token string">"developer"</span><span class="token punctuation">,</span>
  <span class="token string">"lang"</span><span class="token punctuation">:</span><span class="token string">"zh_CN"</span><span class="token punctuation">,</span>
  <span class="token string">"data"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string">"number01"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
          <span class="token string">"value"</span><span class="token punctuation">:</span> <span class="token string">"339208499"</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token string">"date01"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
          <span class="token string">"value"</span><span class="token punctuation">:</span> <span class="token string">"2015年01月05日"</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token string">"site01"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
          <span class="token string">"value"</span><span class="token punctuation">:</span> <span class="token string">"TIT创意园"</span>
      <span class="token punctuation">}</span> <span class="token punctuation">,</span>
      <span class="token string">"site02"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
          <span class="token string">"value"</span><span class="token punctuation">:</span> <span class="token string">"广州市新港中路397号"</span>
      <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <h4>
     <a id="2_61">
     </a>
     （2）请求并不复杂，重要的是参数的获取，发送请求我们至少需要这些参数：
    </h4>
    <ul>
     <li>
      access_token接口调用凭证：参考博客：
      <a href="https://littlede.blog.csdn.net/article/details/104377059" rel="nofollow">
       微信小程序获取access_token
      </a>
     </li>
     <li>
      touser用户的 openid：参考博客：
      <a href="https://blog.csdn.net/weixin_44307065/article/details/104369579">
       微信小程序获取openid
      </a>
     </li>
     <li>
      所需下发的订阅模板id
     </li>
     <li>
      以上三个参数我们均已经获取，下面开始将数据传入服务器
     </li>
    </ul>
    <h5>
     <a id="data_69">
     </a>
     数据包部分：data在前端填写好参数，传入服务器，注意数据包的参数规则：
    </h5>
    <p>
     例如，模板的内容为
    </p>
    <pre><code class="prism language-javascript">姓名<span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span>name01<span class="token punctuation">.</span><span class="token constant">DATA</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
金额<span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span>amount01<span class="token punctuation">.</span><span class="token constant">DATA</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
行程<span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span>thing01<span class="token punctuation">.</span><span class="token constant">DATA</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
日期<span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span>date01<span class="token punctuation">.</span><span class="token constant">DATA</span><span class="token punctuation">}</span><span class="token punctuation">}</span>

</code></pre>
    <p>
     则对应的json为
    </p>
    <pre><code class="prism language-javascript"><span class="token punctuation">{<!-- --></span>
  <span class="token string">"touser"</span><span class="token punctuation">:</span> <span class="token string">"OPENID"</span><span class="token punctuation">,</span>
  <span class="token string">"template_id"</span><span class="token punctuation">:</span> <span class="token string">"TEMPLATE_ID"</span><span class="token punctuation">,</span>
  <span class="token string">"page"</span><span class="token punctuation">:</span> <span class="token string">"index"</span><span class="token punctuation">,</span>
  <span class="token string">"data"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string">"name01"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
          <span class="token string">"value"</span><span class="token punctuation">:</span> <span class="token string">"某某"</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token string">"amount01"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
          <span class="token string">"value"</span><span class="token punctuation">:</span> <span class="token string">"￥100"</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token string">"thing01"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
          <span class="token string">"value"</span><span class="token punctuation">:</span> <span class="token string">"广州至北京"</span>
      <span class="token punctuation">}</span> <span class="token punctuation">,</span>
      <span class="token string">"date01"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
          <span class="token string">"value"</span><span class="token punctuation">:</span> <span class="token string">"2018-01-01"</span>
      <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <ul>
     <li>
      用这样的参数规则我们将前端的参数传入后台：
     </li>
    </ul>
    <pre><code class="prism language-javascript">  <span class="token comment">//发送订阅消息</span>
  message<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">var</span> that <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token comment">//订阅消息模板id</span>
    <span class="token keyword">var</span> template_id <span class="token operator">=</span><span class="token string">"fqgotens_HRal3Ygiy7_WafYLsvDyMxvnNv9P8uJ_Ro"</span><span class="token punctuation">;</span>
    wx<span class="token punctuation">.</span><span class="token function">requestSubscribeMessage</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
      tmplIds<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'fqgotens_HRal3Ygiy7_WafYLsvDyMxvnNv9P8uJ_Ro'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token function">success</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">//发送access_token请求</span>
        wx<span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
          url<span class="token punctuation">:</span> <span class="token string">'https://littlede.applinzi.com/message.php'</span><span class="token punctuation">,</span>
          data<span class="token punctuation">:</span><span class="token punctuation">{<!-- --></span>
            access_token<span class="token punctuation">:</span> that<span class="token punctuation">.</span>data<span class="token punctuation">.</span>accessToken<span class="token punctuation">,</span>
            <span class="token comment">//数据包</span>
            data<span class="token punctuation">:</span><span class="token punctuation">{<!-- --></span>
            <span class="token comment">//openid</span>
              <span class="token string">"touser"</span><span class="token punctuation">:</span> that<span class="token punctuation">.</span>data<span class="token punctuation">.</span>openid<span class="token punctuation">,</span>
            <span class="token comment">//模板id</span>
              <span class="token string">"template_id"</span><span class="token punctuation">:</span> template_id<span class="token punctuation">,</span>
              <span class="token string">"page"</span><span class="token punctuation">:</span> <span class="token string">"index"</span><span class="token punctuation">,</span>
              <span class="token string">"miniprogram_state"</span><span class="token punctuation">:</span> <span class="token string">"developer"</span><span class="token punctuation">,</span>
              <span class="token string">"lang"</span><span class="token punctuation">:</span> <span class="token string">"zh_CN"</span><span class="token punctuation">,</span>
              <span class="token string">"data"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
                <span class="token string">"date1"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
                  <span class="token string">"value"</span><span class="token punctuation">:</span> <span class="token string">"2020年02月18日"</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token string">"phrase2"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
                  <span class="token string">"value"</span><span class="token punctuation">:</span> <span class="token string">"岳阳市"</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token string">"phrase3"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
                  <span class="token string">"value"</span><span class="token punctuation">:</span> <span class="token string">"晴"</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token string">"character_string4"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
                  <span class="token string">"value"</span><span class="token punctuation">:</span> <span class="token string">"15℃"</span>
                <span class="token punctuation">}</span>
              <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
          success<span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"订阅成功"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
          fail<span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"订阅失败"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre>
    <ul>
     <li>
      服务器端代码：
      <br/>
      获取参数
      <br/>
      发送post请求
     </li>
    </ul>
    <pre><code class="prism language-php"><span class="token delimiter important">&lt;?php</span>
	<span class="token comment">//获取参数</span>
	<span class="token variable">$access_token</span><span class="token operator">=</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token double-quoted-string string">"access_token"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token variable">$data</span><span class="token operator">=</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token double-quoted-string string">"data"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token comment">//拼接subscribeMessage.send的URL</span>
	<span class="token variable">$api</span><span class="token operator">=</span><span class="token double-quoted-string string">"https://api.weixin.qq.com/cgi-bin/message/subscribe/send?access_token=<span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token variable">$access_token</span><span class="token punctuation">}</span></span>"</span><span class="token punctuation">;</span>
    <span class="token comment">//php post请求网络的方法</span>
   <span class="token keyword">function</span> <span class="token function">http_request</span><span class="token punctuation">(</span><span class="token variable">$url</span><span class="token punctuation">,</span><span class="token variable">$data</span> <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">,</span><span class="token variable">$headers</span><span class="token operator">=</span><span class="token keyword">array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token variable">$curl</span> <span class="token operator">=</span> <span class="token function">curl_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token variable">$headers</span><span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token number">1</span> <span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token function">curl_setopt</span><span class="token punctuation">(</span><span class="token variable">$curl</span><span class="token punctuation">,</span> <span class="token constant">CURLOPT_HTTPHEADER</span><span class="token punctuation">,</span> <span class="token variable">$headers</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">curl_setopt</span><span class="token punctuation">(</span><span class="token variable">$curl</span><span class="token punctuation">,</span> <span class="token constant">CURLOPT_URL</span><span class="token punctuation">,</span> <span class="token variable">$url</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">curl_setopt</span><span class="token punctuation">(</span><span class="token variable">$curl</span><span class="token punctuation">,</span> <span class="token constant">CURLOPT_SSL_VERIFYPEER</span><span class="token punctuation">,</span> <span class="token constant">FALSE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">curl_setopt</span><span class="token punctuation">(</span><span class="token variable">$curl</span><span class="token punctuation">,</span> <span class="token constant">CURLOPT_SSL_VERIFYHOST</span><span class="token punctuation">,</span> <span class="token constant">FALSE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token function">curl_setopt</span><span class="token punctuation">(</span><span class="token variable">$curl</span><span class="token punctuation">,</span> <span class="token constant">CURLOPT_POST</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">curl_setopt</span><span class="token punctuation">(</span><span class="token variable">$curl</span><span class="token punctuation">,</span> <span class="token constant">CURLOPT_POSTFIELDS</span><span class="token punctuation">,</span> <span class="token variable">$data</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">curl_setopt</span><span class="token punctuation">(</span><span class="token variable">$curl</span><span class="token punctuation">,</span> <span class="token constant">CURLOPT_RETURNTRANSFER</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$output</span> <span class="token operator">=</span> <span class="token function">curl_exec</span><span class="token punctuation">(</span><span class="token variable">$curl</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">curl_close</span><span class="token punctuation">(</span><span class="token variable">$curl</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token variable">$output</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
	<span class="token variable">$str</span><span class="token operator">=</span><span class="token function">http_request</span><span class="token punctuation">(</span><span class="token variable">$api</span><span class="token punctuation">,</span><span class="token variable">$data</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">echo</span> <span class="token variable">$str</span><span class="token punctuation">;</span>
<span class="token delimiter important">?&gt;</span>
</code></pre>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/1b1852d6845aa762d601e78b049557c1.png"/>
    </p>
    <p>
     最后我们调用函数，获取用户openid，获取access_token，获取模板id，发送subscribeMessage.send`post请求，可以看到用户成功接收到订阅消息：
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/2a9c49b22f883c7f5bb81360ebecc683.png"/>
    </p>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f626c6f672e:6373646e2e6e65742f77656978696e5f34343330373036352f:61727469636c652f64657461696c732f313034333736333133" class_="artid" style="display:none">
 </p>
</div>


