---
layout: post
title: "cocos-creator大厅和子游戏"
date: 2024-12-25 17:01:34 +0800
description: "cocos creator大厅和子游戏 热更新_cocoscreato"
keywords: "cocoscreator大厅子游戏"
categories: ['X']
tags: ['子游戏更新', '大厅', 'Creator', 'Cocos', 'Cocos']
artid: "89228633"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=89228633
    alt: "cocos-creator大厅和子游戏"
render_with_liquid: false
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     cocos creator大厅和子游戏
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-tomorrow-night" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <blockquote>
     <p>
      思考：鄙人从业cocos开发5、6年，之前一直用cocos2d-x c++版开发儿童教育类游戏。随着业务的增加，子游戏达到80多个了。也伴随一些问题出现，比如这些问题：1、包体太大。我们app包最大的时候达到200M，这对于用户来说实在是比较大呀！特别是安卓用户。2、如果某个学习的游戏有bug,需要再次发版修复。安卓平台审核比较快，可是苹果可慢了，一周的时间。之前我和小伙伴们也有想着解决这些问题。比如，让子游戏的资源可以从服务器下载，代码生成的.a、 .so动态库也下载。虽然解决了上述的问题，但是，太多的子游戏编译比较长，上传服务器测试等待时间长等问题。我们的业务已经不适合用cocos2d-x来做了。我也承认c++更加流畅、功能丰富、库多、调试方便，可是能驾驭c++的程序员有几个。一直关注CocosCreator的发展，发现这个新产物完全可以满足我们的业务。
     </p>
    </blockquote>
    <h5>
     <a id="___3">
     </a>
     接下来我们带着几个问题来探讨如何实现大厅和子游戏的^ - ^
    </h5>
    <h3>
     <a id="CocosCreator_5">
     </a>
     一、CocosCreator能热更新吗?就是可以将代码和资源一起下载下来的那种可以吗？子游戏可以下载吗？
    </h3>
    <p>
     答：答案是可以，cocos官网就有详细的文档介绍热更新了。
     <a href="https://docs.cocos.com/creator/manual/zh/advanced-topics/assets-manager.html" rel="nofollow">
      热更新文档
     </a>
     在这里就不在介绍了。
     <br/>
     大概的步骤:
    </p>
    <ul>
     <li>
      1、用
      <a href="https://github.com/cocos-creator/tutorial-hot-update/blob/master/version_generator.js">
       version_generator.js
      </a>
      生成新版本的资源配置文件；
     </li>
     <li>
      2、将资源放到配置文件对应的服务器中，最好是zip包;
     </li>
     <li>
      3、每次进入游戏时，用
      <code>
       jsb.AssetsManager
      </code>
      检查版本
      <code>
       checkUpdate()
      </code>
      检查版本和更新版本
      <code>
       update()
      </code>
     </li>
    </ul>
    <p>
     问题来了，我们子游戏如何热更新呢？经过测试，子游戏只要服务器保存的地址不一样，版本号不一样就可以热更新。一般大厅都是一个游戏列表，携带子游戏的下载地址、是否更新、游戏图片、游戏名称等。点击大厅某个子游戏图标然后，热更新对应子游戏的地址。如果版本和本地不一致,assetsManager就会更新下载。客户端保存的子游戏的地方一般是
     <code>
      jsb.fileUtils.getWritablePath()+'/'+md5(子游戏版服务器地址+子游戏版本）
     </code>
    </p>
    <p>
     下面是提供新版本2.0.6的代码
    </p>
    <pre><code class="prism language-javascript">@ccclass
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">HomeScene</span> <span class="token keyword">extends</span> <span class="token class-name">cc<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{<!-- --></span>

	<span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token function">initAssetManage</span><span class="token punctuation">(</span><span class="token string">"game1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 		<span class="token function">checkUpdate</span><span class="token punctuation">(</span><span class="token string">"game1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//**        热更新代码       ***/</span>
    <span class="token function">initAssetManage</span><span class="token punctuation">(</span>gameName<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>cc<span class="token punctuation">.</span>sys<span class="token punctuation">.</span>isBrowser<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>storagePath <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>jsb<span class="token punctuation">.</span>fileUtils <span class="token operator">?</span> jsb<span class="token punctuation">.</span>fileUtils<span class="token punctuation">.</span><span class="token function">getWritablePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token string">''</span><span class="token punctuation">)</span> <span class="token operator">+</span> gameName<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">let</span> <span class="token function-variable function">versionComareHandle</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>versionA<span class="token punctuation">,</span> versionB<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">let</span> vA <span class="token operator">=</span> versionA<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">let</span> vB <span class="token operator">=</span> versionB<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> vA<span class="token punctuation">.</span>length<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">let</span> a <span class="token operator">=</span> <span class="token function">parseInt</span><span class="token punctuation">(</span>vA<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">let</span> b <span class="token operator">=</span> <span class="token function">parseInt</span><span class="token punctuation">(</span>vB<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>a <span class="token operator">!==</span> b<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">return</span> a <span class="token operator">-</span> b<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> vB<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> vA<span class="token punctuation">.</span>length <span class="token operator">?</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">this</span><span class="token punctuation">.</span>assetsManager <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">jsb<span class="token punctuation">.</span>AssetsManager</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>storagePath<span class="token punctuation">,</span> versionComareHandle<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// this.assetsManager.setVerifyCallback((filePath, asset) =&gt; {           </span>
        <span class="token comment">//获取下载下来的文件的MD5跟manifest文件的md5进行比较，是否文件有问题</span>
        <span class="token comment">// if (filePath.endsWith('project.manifest')) return true;</span>
        <span class="token comment">// let data = jsb.fileUtils.getDataFromFile(filePath);</span>
        <span class="token comment">// let fileMD5 = MD5(data);</span>
        <span class="token comment">// let assetsMD5 = asset.md5;</span>
        <span class="token comment">// return (fileMD5 === assetsMD5 || assetsMD5 === '111111');</span>
        <span class="token comment">// });</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>cc<span class="token punctuation">.</span>sys<span class="token punctuation">.</span>os <span class="token operator">===</span> cc<span class="token punctuation">.</span>sys<span class="token punctuation">.</span><span class="token constant">OS_ANDROID</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>assetsManager<span class="token punctuation">.</span><span class="token function">setMaxConcurrentTask</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

    <span class="token punctuation">}</span>


    <span class="token function">checkCb</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span><span class="token function">getEventCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">case</span> jsb<span class="token punctuation">.</span>EventAssetsManager<span class="token punctuation">.</span><span class="token constant">ERROR_NO_LOCAL_MANIFEST</span><span class="token punctuation">:</span>
                cc<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'本地没有配置文件: '</span> <span class="token operator">+</span> event<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> jsb<span class="token punctuation">.</span>EventAssetsManager<span class="token punctuation">.</span><span class="token constant">ERROR_DOWNLOAD_MANIFEST</span><span class="token punctuation">:</span>
                cc<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'下载配置文件错误: '</span> <span class="token operator">+</span> event<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> jsb<span class="token punctuation">.</span>EventAssetsManager<span class="token punctuation">.</span><span class="token constant">ERROR_PARSE_MANIFEST</span><span class="token punctuation">:</span>
                cc<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'解析文件错误: '</span> <span class="token operator">+</span> event<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> jsb<span class="token punctuation">.</span>EventAssetsManager<span class="token punctuation">.</span><span class="token constant">ALREADY_UP_TO_DATE</span><span class="token punctuation">:</span>
                cc<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'已经是最新的: '</span> <span class="token operator">+</span> event<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getCourseConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> jsb<span class="token punctuation">.</span>EventAssetsManager<span class="token punctuation">.</span><span class="token constant">NEW_VERSION_FOUND</span><span class="token punctuation">:</span>
                cc<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'找到新版本'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">hotUpdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token keyword">default</span><span class="token punctuation">:</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token function">checkUpdate</span><span class="token punctuation">(</span>gameName<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>cc<span class="token punctuation">.</span>sys<span class="token punctuation">.</span>isBrowser<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>

        <span class="token keyword">let</span> <span class="token constant">UIRLFILE</span> <span class="token operator">=</span> <span class="token string">"http://192.168.0.1:8080/server/"</span> <span class="token operator">+</span> gameName<span class="token punctuation">;</span>
        <span class="token keyword">let</span> remoteManifestUrl <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>storagePath <span class="token operator">+</span> <span class="token string">"/project.manifest"</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>manifestUrl <span class="token operator">=</span> remoteManifestUrl<span class="token punctuation">;</span>

        <span class="token keyword">let</span> customManifestStr <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
            <span class="token string">"packageUrl"</span><span class="token punctuation">:</span> <span class="token constant">UIRLFILE</span><span class="token punctuation">,</span>
            <span class="token string">"remoteManifestUrl"</span><span class="token punctuation">:</span> <span class="token constant">UIRLFILE</span> <span class="token operator">+</span> <span class="token string">"/project.manifest"</span><span class="token punctuation">,</span>
            <span class="token string">"remoteVersionUrl"</span><span class="token punctuation">:</span> <span class="token constant">UIRLFILE</span> <span class="token operator">+</span> <span class="token string">"/version.manifest"</span><span class="token punctuation">,</span>
            <span class="token string">"version"</span><span class="token punctuation">:</span> <span class="token string">"1.0.0.0"</span><span class="token punctuation">,</span>
            <span class="token string">"assets"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token string">"searchPaths"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


        <span class="token keyword">this</span><span class="token punctuation">.</span>assetsManager<span class="token punctuation">.</span><span class="token function">setEventCallback</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>checkCb<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>assetsManager<span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">===</span> jsb<span class="token punctuation">.</span>AssetsManager<span class="token punctuation">.</span>State<span class="token punctuation">.</span><span class="token constant">UNINITED</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>jsb<span class="token punctuation">.</span>fileUtils<span class="token punctuation">.</span><span class="token function">isFileExist</span><span class="token punctuation">(</span>remoteManifestUrl<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                cc<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'加载本地Manifest'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>assetsManager<span class="token punctuation">.</span><span class="token function">loadLocalManifest</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>manifestUrl<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                cc<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'加载网络Manifest'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">let</span> manifest <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">jsb<span class="token punctuation">.</span>Manifest</span><span class="token punctuation">(</span>customManifestStr<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>storagePath<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>assetsManager<span class="token punctuation">.</span><span class="token function">loadLocalManifest</span><span class="token punctuation">(</span>manifest<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>storagePath<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        cc<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"检查文件更新:"</span> <span class="token operator">+</span> remoteManifestUrl<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>assetsManager<span class="token punctuation">.</span><span class="token function">checkUpdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token function">updateCb</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span><span class="token function">getEventCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">case</span> jsb<span class="token punctuation">.</span>EventAssetsManager<span class="token punctuation">.</span><span class="token constant">ERROR_NO_LOCAL_MANIFEST</span><span class="token punctuation">:</span>
                <span class="token comment">/*0 本地没有配置文件*/</span>
                cc<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'本地没有配置文件: '</span> <span class="token operator">+</span> event<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> jsb<span class="token punctuation">.</span>EventAssetsManager<span class="token punctuation">.</span><span class="token constant">ERROR_DOWNLOAD_MANIFEST</span><span class="token punctuation">:</span>
                <span class="token comment">/*1下载配置文件错误*/</span>
                cc<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'下载配置文件错误: '</span> <span class="token operator">+</span> event<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> jsb<span class="token punctuation">.</span>EventAssetsManager<span class="token punctuation">.</span><span class="token constant">ERROR_PARSE_MANIFEST</span><span class="token punctuation">:</span>
                <span class="token comment">/*2 解析文件错误*/</span>
                cc<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'解析文件错误: '</span> <span class="token operator">+</span> event<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> jsb<span class="token punctuation">.</span>EventAssetsManager<span class="token punctuation">.</span><span class="token constant">NEW_VERSION_FOUND</span><span class="token punctuation">:</span>
                <span class="token comment">/*3发现新的更新*/</span>
                cc<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'发现新的更新: '</span> <span class="token operator">+</span> event<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> jsb<span class="token punctuation">.</span>EventAssetsManager<span class="token punctuation">.</span><span class="token constant">ALREADY_UP_TO_DATE</span><span class="token punctuation">:</span>
                <span class="token comment">/*4 已经是最新的*/</span>
                cc<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'已经是最新的: '</span> <span class="token operator">+</span> event<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> jsb<span class="token punctuation">.</span>EventAssetsManager<span class="token punctuation">.</span><span class="token constant">UPDATE_PROGRESSION</span><span class="token punctuation">:</span>
                <span class="token comment">/*5 最新进展  做 进度的*/</span>
                <span class="token keyword">var</span> msg <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">round</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span><span class="token function">getPercent</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">100</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"%"</span><span class="token punctuation">;</span>
                cc<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'进度: '</span> <span class="token operator">+</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// this.progress.string =  msg;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> jsb<span class="token punctuation">.</span>EventAssetsManager<span class="token punctuation">.</span><span class="token constant">ASSET_UPDATED</span><span class="token punctuation">:</span>
                <span class="token comment">/*6需要更新*/</span>
                <span class="token comment">// cc.log('需要更新: ' + event.getMessage());</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> jsb<span class="token punctuation">.</span>EventAssetsManager<span class="token punctuation">.</span><span class="token constant">ERROR_UPDATING</span><span class="token punctuation">:</span>
                <span class="token comment">/*7更新错误*/</span>
                cc<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'更新错误: '</span> <span class="token operator">+</span> event<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> jsb<span class="token punctuation">.</span>EventAssetsManager<span class="token punctuation">.</span><span class="token constant">UPDATE_FINISHED</span><span class="token punctuation">:</span>
                <span class="token comment">/*8更新完成*/</span>
                cc<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"更新完成"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getCourseConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> jsb<span class="token punctuation">.</span>EventAssetsManager<span class="token punctuation">.</span><span class="token constant">UPDATE_FAILED</span><span class="token punctuation">:</span>
                <span class="token comment">/*9更新失败*/</span>
                cc<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'更新失败: '</span> <span class="token operator">+</span> event<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// this.getfiles("subgame", 1);</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> jsb<span class="token punctuation">.</span>EventAssetsManager<span class="token punctuation">.</span><span class="token constant">ERROR_DECOMPRESS</span><span class="token punctuation">:</span>
                <span class="token comment">/*10解压失败*/</span>
                cc<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'解压失败: '</span> <span class="token operator">+</span> event<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token function">hotUpdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>assetsManager<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>assetsManager<span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">===</span> jsb<span class="token punctuation">.</span>AssetsManager<span class="token punctuation">.</span>State<span class="token punctuation">.</span><span class="token constant">UNINITED</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>assetsManager<span class="token punctuation">.</span><span class="token function">loadLocalManifest</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>manifestUrl<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">this</span><span class="token punctuation">.</span>assetsManager<span class="token punctuation">.</span><span class="token function">setEventCallback</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>updateCb<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">this</span><span class="token punctuation">.</span>assetsManager<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//**        热更新代码       ***/</span>
<span class="token punctuation">}</span>
</code></pre>
    <h3>
     <a id="_193">
     </a>
     二、子游戏如何进入退出？
    </h3>
    <p>
     答：这个问题是一个不错的问题，经过2周对CocosCreator的研究，特别游戏启动的过程退出的过程。
     <br/>
     1、让我们先讨论一下【进入】；
     <br/>
     进入流程如下图：
     <br/>
     <img alt="游戏进入流程" src="https://i-blog.csdnimg.cn/blog_migrate/07ff17fdab9ffa1b9d3331047fe5b77e.png"/>
    </p>
    <p>
     从图上来看到，
     <code>
      main.js
     </code>
     是需要好好研究就的。添加一些注释大家可以更好的理解
     <code>
      mian.js
     </code>
     是如何走。
    </p>
    <pre><code class="prism language-javascript"><span class="token comment">// QQPlay window need to be inited first</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token constant">BK</span><span class="token punctuation">.</span>Script<span class="token punctuation">.</span><span class="token function">loadlib</span><span class="token punctuation">(</span><span class="token string">'GameRes://libs/qqplay-adapter.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

window<span class="token punctuation">.</span><span class="token function-variable function">boot</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token comment">//*step2 读取配置 把window._CCStettings</span>
    <span class="token keyword">var</span> settings <span class="token operator">=</span> window<span class="token punctuation">.</span>_CCSettings<span class="token punctuation">;</span>
    window<span class="token punctuation">.</span>_CCSettings <span class="token operator">=</span> undefined<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span>settings<span class="token punctuation">.</span>debug <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">var</span> uuids <span class="token operator">=</span> settings<span class="token punctuation">.</span>uuids<span class="token punctuation">;</span>

        <span class="token keyword">var</span> rawAssets <span class="token operator">=</span> settings<span class="token punctuation">.</span>rawAssets<span class="token punctuation">;</span>
        <span class="token keyword">var</span> assetTypes <span class="token operator">=</span> settings<span class="token punctuation">.</span>assetTypes<span class="token punctuation">;</span>
        <span class="token keyword">var</span> realRawAssets <span class="token operator">=</span> settings<span class="token punctuation">.</span>rawAssets <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> mount <span class="token keyword">in</span> rawAssets<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">var</span> entries <span class="token operator">=</span> rawAssets<span class="token punctuation">[</span>mount<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">var</span> realEntries <span class="token operator">=</span> realRawAssets<span class="token punctuation">[</span>mount<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> id <span class="token keyword">in</span> entries<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">var</span> entry <span class="token operator">=</span> entries<span class="token punctuation">[</span>id<span class="token punctuation">]</span><span class="token punctuation">;</span>
                <span class="token keyword">var</span> type <span class="token operator">=</span> entry<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
                <span class="token comment">// retrieve minified raw asset</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> type <span class="token operator">===</span> <span class="token string">'number'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    entry<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> assetTypes<span class="token punctuation">[</span>type<span class="token punctuation">]</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment">// retrieve uuid</span>
                realEntries<span class="token punctuation">[</span>uuids<span class="token punctuation">[</span>id<span class="token punctuation">]</span> <span class="token operator">||</span> id<span class="token punctuation">]</span> <span class="token operator">=</span> entry<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">var</span> scenes <span class="token operator">=</span> settings<span class="token punctuation">.</span>scenes<span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> scenes<span class="token punctuation">.</span>length<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">var</span> scene <span class="token operator">=</span> scenes<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> scene<span class="token punctuation">.</span>uuid <span class="token operator">===</span> <span class="token string">'number'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                scene<span class="token punctuation">.</span>uuid <span class="token operator">=</span> uuids<span class="token punctuation">[</span>scene<span class="token punctuation">.</span>uuid<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">var</span> packedAssets <span class="token operator">=</span> settings<span class="token punctuation">.</span>packedAssets<span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> packId <span class="token keyword">in</span> packedAssets<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">var</span> packedIds <span class="token operator">=</span> packedAssets<span class="token punctuation">[</span>packId<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> packedIds<span class="token punctuation">.</span>length<span class="token punctuation">;</span> <span class="token operator">++</span>j<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> packedIds<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string">'number'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    packedIds<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> uuids<span class="token punctuation">[</span>packedIds<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">function</span> <span class="token function">setLoadingDisplay</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// Loading splash scene</span>
        <span class="token keyword">var</span> splash <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'splash'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">var</span> progressBar <span class="token operator">=</span> splash<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'.progress-bar span'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        cc<span class="token punctuation">.</span>loader<span class="token punctuation">.</span><span class="token function-variable function">onProgress</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>completedCount<span class="token punctuation">,</span> totalCount<span class="token punctuation">,</span> item<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">var</span> percent <span class="token operator">=</span> <span class="token number">100</span> <span class="token operator">*</span> completedCount <span class="token operator">/</span> totalCount<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>progressBar<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                progressBar<span class="token punctuation">.</span>style<span class="token punctuation">.</span>width <span class="token operator">=</span> percent<span class="token punctuation">.</span><span class="token function">toFixed</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'%'</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        splash<span class="token punctuation">.</span>style<span class="token punctuation">.</span>display <span class="token operator">=</span> <span class="token string">'block'</span><span class="token punctuation">;</span>
        progressBar<span class="token punctuation">.</span>style<span class="token punctuation">.</span>width <span class="token operator">=</span> <span class="token string">'0%'</span><span class="token punctuation">;</span>

        cc<span class="token punctuation">.</span>director<span class="token punctuation">.</span><span class="token function">once</span><span class="token punctuation">(</span>cc<span class="token punctuation">.</span>Director<span class="token punctuation">.</span><span class="token constant">EVENT_AFTER_SCENE_LAUNCH</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            splash<span class="token punctuation">.</span>style<span class="token punctuation">.</span>display <span class="token operator">=</span> <span class="token string">'none'</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

	<span class="token comment">//*step5 初始化大环境后进入具体的场景</span>
    <span class="token keyword">var</span> <span class="token function-variable function">onStart</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        cc<span class="token punctuation">.</span>loader<span class="token punctuation">.</span>downloader<span class="token punctuation">.</span>_subpackages <span class="token operator">=</span> settings<span class="token punctuation">.</span>subpackages<span class="token punctuation">;</span>

        cc<span class="token punctuation">.</span>view<span class="token punctuation">.</span><span class="token function">enableRetina</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        cc<span class="token punctuation">.</span>view<span class="token punctuation">.</span><span class="token function">resizeWithBrowserSize</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token boolean">false</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>cc<span class="token punctuation">.</span>sys<span class="token punctuation">.</span>isBrowser<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token function">setLoadingDisplay</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>cc<span class="token punctuation">.</span>sys<span class="token punctuation">.</span>isMobile<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>settings<span class="token punctuation">.</span>orientation <span class="token operator">===</span> <span class="token string">'landscape'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    cc<span class="token punctuation">.</span>view<span class="token punctuation">.</span><span class="token function">setOrientation</span><span class="token punctuation">(</span>cc<span class="token punctuation">.</span>macro<span class="token punctuation">.</span><span class="token constant">ORIENTATION_LANDSCAPE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>settings<span class="token punctuation">.</span>orientation <span class="token operator">===</span> <span class="token string">'portrait'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    cc<span class="token punctuation">.</span>view<span class="token punctuation">.</span><span class="token function">setOrientation</span><span class="token punctuation">(</span>cc<span class="token punctuation">.</span>macro<span class="token punctuation">.</span><span class="token constant">ORIENTATION_PORTRAIT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                cc<span class="token punctuation">.</span>view<span class="token punctuation">.</span><span class="token function">enableAutoFullScreen</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
                    cc<span class="token punctuation">.</span>sys<span class="token punctuation">.</span><span class="token constant">BROWSER_TYPE_BAIDU</span><span class="token punctuation">,</span>
                    cc<span class="token punctuation">.</span>sys<span class="token punctuation">.</span><span class="token constant">BROWSER_TYPE_WECHAT</span><span class="token punctuation">,</span>
                    cc<span class="token punctuation">.</span>sys<span class="token punctuation">.</span><span class="token constant">BROWSER_TYPE_MOBILE_QQ</span><span class="token punctuation">,</span>
                    cc<span class="token punctuation">.</span>sys<span class="token punctuation">.</span><span class="token constant">BROWSER_TYPE_MIUI</span><span class="token punctuation">,</span>
                <span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>cc<span class="token punctuation">.</span>sys<span class="token punctuation">.</span>browserType<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// Limit downloading max concurrent task to 2,</span>
            <span class="token comment">// more tasks simultaneously may cause performance draw back on some android system / browsers.</span>
            <span class="token comment">// You can adjust the number based on your own test result, you have to set it before any loading process to take effect.</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>cc<span class="token punctuation">.</span>sys<span class="token punctuation">.</span>isBrowser <span class="token operator">&amp;&amp;</span> cc<span class="token punctuation">.</span>sys<span class="token punctuation">.</span>os <span class="token operator">===</span> cc<span class="token punctuation">.</span>sys<span class="token punctuation">.</span><span class="token constant">OS_ANDROID</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                cc<span class="token punctuation">.</span>macro<span class="token punctuation">.</span><span class="token constant">DOWNLOAD_MAX_CONCURRENT</span> <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// init assets 配置项目中资源的uuid，方便后面加载对应资源转换为路径。</span>
        <span class="token comment">//这样进入场景后才能找到资源。</span>
        cc<span class="token punctuation">.</span>AssetLibrary<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
            libraryPath<span class="token punctuation">:</span> <span class="token string">'res/import'</span><span class="token punctuation">,</span>
            rawAssetsBase<span class="token punctuation">:</span> <span class="token string">'res/raw-'</span><span class="token punctuation">,</span>
            rawAssets<span class="token punctuation">:</span> settings<span class="token punctuation">.</span>rawAssets<span class="token punctuation">,</span>
            packedAssets<span class="token punctuation">:</span> settings<span class="token punctuation">.</span>packedAssets<span class="token punctuation">,</span>
            md5AssetsMap<span class="token punctuation">:</span> settings<span class="token punctuation">.</span>md5AssetsMap
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">var</span> launchScene <span class="token operator">=</span> settings<span class="token punctuation">.</span>launchScene<span class="token punctuation">;</span>

        <span class="token comment">// load scene 进入第一个场景</span>
        cc<span class="token punctuation">.</span>director<span class="token punctuation">.</span><span class="token function">loadScene</span><span class="token punctuation">(</span>launchScene<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
            <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>cc<span class="token punctuation">.</span>sys<span class="token punctuation">.</span>isBrowser<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">// show canvas</span>
                    <span class="token keyword">var</span> canvas <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'GameCanvas'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    canvas<span class="token punctuation">.</span>style<span class="token punctuation">.</span>visibility <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span>
                    <span class="token keyword">var</span> div <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'GameDiv'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>div<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        div<span class="token punctuation">.</span>style<span class="token punctuation">.</span>backgroundImage <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                cc<span class="token punctuation">.</span>loader<span class="token punctuation">.</span>onProgress <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Success to load scene: '</span> <span class="token operator">+</span> launchScene<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token comment">// jsList</span>
    <span class="token keyword">var</span> jsList <span class="token operator">=</span> settings<span class="token punctuation">.</span>jsList<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token constant">BK</span><span class="token punctuation">.</span>Script<span class="token punctuation">.</span><span class="token function">loadlib</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
    	<span class="token comment">//*step3 加载项目源码</span>
    	<span class="token comment">//游戏所有源码都被编译成一个文件了，那就src/project.js 没有什么可看</span>
        <span class="token keyword">var</span> bundledScript <span class="token operator">=</span> settings<span class="token punctuation">.</span>debug <span class="token operator">?</span> <span class="token string">'src/project.dev.js'</span> <span class="token punctuation">:</span> <span class="token string">'src/project.js'</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>jsList<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            jsList <span class="token operator">=</span> jsList<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span> <span class="token string">'src/'</span> <span class="token operator">+</span> x<span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            jsList<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>bundledScript<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            jsList <span class="token operator">=</span> <span class="token punctuation">[</span>bundledScript<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">//*step4 根据配置开启游戏</span>
    <span class="token keyword">var</span> option <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
        id<span class="token punctuation">:</span> <span class="token string">'GameCanvas'</span><span class="token punctuation">,</span>
        scenes<span class="token punctuation">:</span> settings<span class="token punctuation">.</span>scenes<span class="token punctuation">,</span>
        debugMode<span class="token punctuation">:</span> settings<span class="token punctuation">.</span>debug <span class="token operator">?</span> cc<span class="token punctuation">.</span>debug<span class="token punctuation">.</span>DebugMode<span class="token punctuation">.</span><span class="token constant">INFO</span> <span class="token punctuation">:</span> cc<span class="token punctuation">.</span>debug<span class="token punctuation">.</span>DebugMode<span class="token punctuation">.</span><span class="token constant">ERROR</span><span class="token punctuation">,</span>
        showFPS<span class="token punctuation">:</span> <span class="token operator">!</span><span class="token boolean">false</span> <span class="token operator">&amp;&amp;</span> settings<span class="token punctuation">.</span>debug<span class="token punctuation">,</span>
        frameRate<span class="token punctuation">:</span> <span class="token number">60</span><span class="token punctuation">,</span>
        jsList<span class="token punctuation">:</span> jsList<span class="token punctuation">,</span>
        groupList<span class="token punctuation">:</span> settings<span class="token punctuation">.</span>groupList<span class="token punctuation">,</span>
        collisionMatrix<span class="token punctuation">:</span> settings<span class="token punctuation">.</span>collisionMatrix<span class="token punctuation">,</span>
    <span class="token punctuation">}</span>

    cc<span class="token punctuation">.</span>game<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span>option<span class="token punctuation">,</span> onStart<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// main.js is qqplay and jsb platform entry file, so we must leave platform init code here</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token constant">BK</span><span class="token punctuation">.</span>Script<span class="token punctuation">.</span><span class="token function">loadlib</span><span class="token punctuation">(</span><span class="token string">'GameRes://src/settings.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token constant">BK</span><span class="token punctuation">.</span>Script<span class="token punctuation">.</span><span class="token function">loadlib</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token constant">BK</span><span class="token punctuation">.</span>Script<span class="token punctuation">.</span><span class="token function">loadlib</span><span class="token punctuation">(</span><span class="token string">'GameRes://libs/qqplay-downloader.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">var</span> <span class="token constant">ORIENTATIONS</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">'portrait'</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
        <span class="token string">'landscape left'</span><span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
        <span class="token string">'landscape right'</span><span class="token punctuation">:</span> <span class="token number">3</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token constant">BK</span><span class="token punctuation">.</span>Director<span class="token punctuation">.</span>screenMode <span class="token operator">=</span> <span class="token constant">ORIENTATIONS</span><span class="token punctuation">[</span>window<span class="token punctuation">.</span>_CCSettings<span class="token punctuation">.</span>orientation<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token function">initAdapter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    cc<span class="token punctuation">.</span>game<span class="token punctuation">.</span><span class="token function">once</span><span class="token punctuation">(</span>cc<span class="token punctuation">.</span>game<span class="token punctuation">.</span><span class="token constant">EVENT_ENGINE_INITED</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">initRendererAdapter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    qqPlayDownloader<span class="token punctuation">.</span><span class="token constant">REMOTE_SERVER_ROOT</span> <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> prevPipe <span class="token operator">=</span> cc<span class="token punctuation">.</span>loader<span class="token punctuation">.</span>md5Pipe <span class="token operator">||</span> cc<span class="token punctuation">.</span>loader<span class="token punctuation">.</span>assetLoader<span class="token punctuation">;</span>
    cc<span class="token punctuation">.</span>loader<span class="token punctuation">.</span><span class="token function">insertPipeAfter</span><span class="token punctuation">(</span>prevPipe<span class="token punctuation">,</span> qqPlayDownloader<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    window<span class="token punctuation">.</span><span class="token function">boot</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>window<span class="token punctuation">.</span>jsb<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token comment">//*step1 加载项目的配置到 window._CCSettings </span>
	<span class="token comment">//查看src/settings.js 发现window._CCSettings={....} 里面都是项目配置</span>
	<span class="token comment">//几个常用：</span>
	<span class="token comment">//groupList 分组</span>
	<span class="token comment">//collisionMatrix 刚体碰撞配置表</span>
	<span class="token comment">//rawAssets 资源列表</span>
	<span class="token comment">//launchScene 开始场景</span>
	<span class="token comment">//packedAssets资源打包列表uuid</span>
    <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'src/settings.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'src/cocos2d-jsb.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'jsb-adapter/engine/index.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    window<span class="token punctuation">.</span><span class="token function">boot</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     大概了解进入流程后，我们假设一个命题：【 在大厅运行的情况下，我们更新配置是否可以进入子游戏。】。这个命题也是有基础支撑的。
     <br/>
     一个是
     <code>
      require('/xxx/x/x/xxxx.js');
     </code>
     ，这个函数可以加载绝对路径的脚本到jsVM，哪怕是sd卡里的。我们可以把子游戏的配置文件(subGamePath/src/settings.js)和代码（subGamePath/src/project.js）加载进来了。
     <br/>
     第二个是
     <code>
      jsb.fileUtils.addSearchPath(subGamePath, true);
     </code>
     ，为什么是他？用过cocos2d-x的小伙伴都知道，它添加搜索路径后，不管游戏资源在哪里都能加载。哪怕还是在sd卡里。这样，子游戏的资源路径加载到搜索路径后，子游戏资源我们就可以找到了。
     <br/>
     有了这两个支撑点，我们可以加载一个完整的子游戏了。之后，就是代码替换的工作了。替换的过程和
     <code>
      main.js
     </code>
     的工作比较相似。让我们看看具体是如何进入子游戏的，直接上代码。
    </p>
    <pre><code class="prism language-javascript"><span class="token comment">//支撑cocoscreator版本2.0.6或更高</span>
cc<span class="token punctuation">.</span>Hall <span class="token operator">=</span> cc<span class="token punctuation">.</span>Hall <span class="token operator">||</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">;</span>

cc<span class="token punctuation">.</span>Hall<span class="token punctuation">.</span><span class="token function-variable function">changeConfig</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>subGamePath<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    subGamePath <span class="token operator">=</span> subGamePath <span class="token operator">?</span> subGamePath <span class="token punctuation">:</span> <span class="token string">''</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>window<span class="token punctuation">.</span>jsb<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">/// 1.初始化资源Lib路径Root.</span>

        <span class="token comment">// var subGamePath = '/storage/emulated/0/bubbleGame/';</span>
        cc<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"Hall -----&gt;subGamePath:"</span> <span class="token operator">+</span> subGamePath<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">/// 2.subgame资源未映射，则初始化资源映射表，否则略过映射.</span>

        <span class="token comment">// cc.sys.garbageCollect();</span>
        <span class="token comment">// cc.sys.restartVM();</span>
        <span class="token comment">/// 加载settings.js</span>
        <span class="token comment">// var hallSettings = window._CCSettings;</span>
        window<span class="token punctuation">.</span><span class="token function">require</span><span class="token punctuation">(</span>subGamePath <span class="token operator">+</span> <span class="token string">'src/settings.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        cc<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"Hall -----&gt;加载settings.js"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">var</span> settings <span class="token operator">=</span> window<span class="token punctuation">.</span>_CCSettings<span class="token punctuation">;</span>
        <span class="token comment">// settings.rawAssets.push(hallSettings.rawAssets);</span>
        <span class="token comment">// settings.packedAssets.push(hallSettings.packedAssets);</span>
        <span class="token comment">// settings.md5AssetsMap.push(hallSettings.md5AssetsMap);</span>

        window<span class="token punctuation">.</span>_CCSettings <span class="token operator">=</span> undefined<span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>settings<span class="token punctuation">.</span>debug<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">var</span> uuids <span class="token operator">=</span> settings<span class="token punctuation">.</span>uuids<span class="token punctuation">;</span>

            <span class="token keyword">var</span> rawAssets <span class="token operator">=</span> settings<span class="token punctuation">.</span>rawAssets<span class="token punctuation">;</span>
            <span class="token keyword">var</span> assetTypes <span class="token operator">=</span> settings<span class="token punctuation">.</span>assetTypes<span class="token punctuation">;</span>
            <span class="token keyword">var</span> realRawAssets <span class="token operator">=</span> settings<span class="token punctuation">.</span>rawAssets <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> mount <span class="token keyword">in</span> rawAssets<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">var</span> entries <span class="token operator">=</span> rawAssets<span class="token punctuation">[</span>mount<span class="token punctuation">]</span><span class="token punctuation">;</span>
                <span class="token keyword">var</span> realEntries <span class="token operator">=</span> realRawAssets<span class="token punctuation">[</span>mount<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">;</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> id <span class="token keyword">in</span> entries<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">var</span> entry <span class="token operator">=</span> entries<span class="token punctuation">[</span>id<span class="token punctuation">]</span><span class="token punctuation">;</span>
                    <span class="token keyword">var</span> type <span class="token operator">=</span> entry<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
                    <span class="token comment">// retrieve minified raw asset</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> type <span class="token operator">===</span> <span class="token string">'number'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        entry<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> assetTypes<span class="token punctuation">[</span>type<span class="token punctuation">]</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment">// retrieve uuid</span>
                    realEntries<span class="token punctuation">[</span>uuids<span class="token punctuation">[</span>id<span class="token punctuation">]</span> <span class="token operator">||</span> id<span class="token punctuation">]</span> <span class="token operator">=</span> entry<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">var</span> scenes <span class="token operator">=</span> settings<span class="token punctuation">.</span>scenes<span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> scenes<span class="token punctuation">.</span>length<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">var</span> scene <span class="token operator">=</span> scenes<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> scene<span class="token punctuation">.</span>uuid <span class="token operator">===</span> <span class="token string">'number'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    scene<span class="token punctuation">.</span>uuid <span class="token operator">=</span> uuids<span class="token punctuation">[</span>scene<span class="token punctuation">.</span>uuid<span class="token punctuation">]</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">var</span> packedAssets <span class="token operator">=</span> settings<span class="token punctuation">.</span>packedAssets<span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> packId <span class="token keyword">in</span> packedAssets<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">var</span> packedIds <span class="token operator">=</span> packedAssets<span class="token punctuation">[</span>packId<span class="token punctuation">]</span><span class="token punctuation">;</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> packedIds<span class="token punctuation">.</span>length<span class="token punctuation">;</span> <span class="token operator">++</span>j<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> packedIds<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string">'number'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        packedIds<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> uuids<span class="token punctuation">[</span>packedIds<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment">/// 加载project.js</span>
        <span class="token keyword">var</span> projectDir <span class="token operator">=</span> <span class="token string">'src/project.js'</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>settings<span class="token punctuation">.</span>debug<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            projectDir <span class="token operator">=</span> <span class="token string">'src/project.dev.js'</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        cc<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"Hall -----&gt;加载project.js"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        window<span class="token punctuation">.</span><span class="token function">require</span><span class="token punctuation">(</span>subGamePath <span class="token operator">+</span> projectDir<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">/// 如果当前搜索路径没有subgame，则添加进去搜索路径。</span>
        <span class="token keyword">var</span> currentSearchPaths <span class="token operator">=</span> jsb<span class="token punctuation">.</span>fileUtils<span class="token punctuation">.</span><span class="token function">getSearchPaths</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        cc<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"Hall -----&gt;currentSearchPaths:"</span> <span class="token operator">+</span> currentSearchPaths<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>currentSearchPaths <span class="token operator">&amp;&amp;</span> currentSearchPaths<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>subGamePath<span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            jsb<span class="token punctuation">.</span>fileUtils<span class="token punctuation">.</span><span class="token function">addSearchPath</span><span class="token punctuation">(</span>subGamePath<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            cc<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Hall -----&gt; 之前未添加，添加下subGamePath'</span> <span class="token operator">+</span> currentSearchPaths<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        cc<span class="token punctuation">.</span>AssetLibrary<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
            libraryPath<span class="token punctuation">:</span>  <span class="token string">'res/import'</span><span class="token punctuation">,</span>
            rawAssetsBase<span class="token punctuation">:</span>  <span class="token string">'res/raw-'</span><span class="token punctuation">,</span>
            rawAssets<span class="token punctuation">:</span> settings<span class="token punctuation">.</span>rawAssets<span class="token punctuation">,</span>
            packedAssets<span class="token punctuation">:</span> settings<span class="token punctuation">.</span>packedAssets<span class="token punctuation">,</span>
            md5AssetsMap<span class="token punctuation">:</span> settings<span class="token punctuation">.</span>md5AssetsMap
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


        cc<span class="token punctuation">.</span>game<span class="token punctuation">.</span>collisionMatrix <span class="token operator">=</span> settings<span class="token punctuation">.</span>collisionMatrix<span class="token punctuation">;</span>
        cc<span class="token punctuation">.</span>game<span class="token punctuation">.</span>groupList <span class="token operator">=</span> settings<span class="token punctuation">.</span>groupList<span class="token punctuation">;</span>

        cc<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Hall -----&gt;AssetLibrary init'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">var</span> launchScene <span class="token operator">=</span> settings<span class="token punctuation">.</span>launchScene<span class="token punctuation">;</span>

        <span class="token comment">/// 将subgame的场景添加到cc.game中，使得cc.director.loadScene可以从cc.game._sceneInfos查找到相关场景</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> settings<span class="token punctuation">.</span>scenes<span class="token punctuation">.</span>length<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            cc<span class="token punctuation">.</span>game<span class="token punctuation">.</span>_sceneInfos<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>settings<span class="token punctuation">.</span>scenes<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">/// 3.加载初始场景</span>
        cc<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Hall -----&gt;加载初始场景'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        cc<span class="token punctuation">.</span>director<span class="token punctuation">.</span><span class="token function">loadScene</span><span class="token punctuation">(</span>launchScene<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
            <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                cc<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Hall -----&gt;成功加载初始场景'</span> <span class="token operator">+</span> launchScene<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>

<span class="token comment">//进入子游戏</span>
cc<span class="token punctuation">.</span>Hall<span class="token punctuation">.</span><span class="token function-variable function">enterSubGame</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>subGamePath<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">changeConfig</span><span class="token punctuation">(</span>subGamePath<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">//回到大厅</span>
cc<span class="token punctuation">.</span>Hall<span class="token punctuation">.</span><span class="token function-variable function">backHall</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">changeConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre>
    <p>
     看了代码后大家可能觉得就这么简单，是的，就这么简单。如何使用：
    </p>
    <pre><code class="prism language-javascript"> <span class="token comment">//进入子游戏</span>
 window<span class="token punctuation">.</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'src/Hall.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token comment">//gamePath子游戏的下载保存路径也许是sd卡也许是jsb.fileUtils.getWritablePath()+'/'+md5(子游戏版服务器地址+子游戏版本）</span>
 cc<span class="token punctuation">.</span>Hall<span class="token punctuation">.</span><span class="token function">enterSubGame</span><span class="token punctuation">(</span>gamePath<span class="token punctuation">)</span><span class="token punctuation">;</span>


<span class="token comment">//回到大厅</span>
 window<span class="token punctuation">.</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'src/Hall.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 cc<span class="token punctuation">.</span>Hall<span class="token punctuation">.</span><span class="token function">backHall</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <p>
     2、让我们讨论一下【退出】；
     <br/>
     为什么退出只是不填路径就可以了？因为大厅的main.js中也没有填路径呀。
     <br/>
     你看上面
     <code>
      main.js
     </code>
     代码里的*step1。没有路径？不是，jsVM在初始化的时候pwd就是指到工程的路径下面了。
    </p>
    <h3>
     <a id="_560">
     </a>
     三、大厅和子游戏如何数据交互？
    </h3>
    <p>
     答：答案在这里-》
     <a href="https://docs.cocos.com/creator/manual/zh/scripting/scene-managing.html" rel="nofollow">
      通过常驻节点进行场景资源管理和参数传递
     </a>
    </p>
    <p>
     具体实现：添加一个Gloal节点和Global.js保存为常驻节点。子游戏在不重启游戏的情况下，可以访问常驻节点数据。
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/05170885e3c4ef9c0df485dcbb04f7dc.png"/>
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/951d5213bcb1a152d86cc50f421259ef.png"/>
    </p>
    <pre><code class="prism language-javascript">
@ccclass
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">Global</span> <span class="token keyword">extends</span> <span class="token class-name">cc<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{<!-- --></span>


    <span class="token comment">//课程资源</span>
    <span class="token keyword">public</span> gameData<span class="token punctuation">;</span>

    <span class="token keyword">public</span> gameScriptName<span class="token punctuation">:</span> string

    <span class="token keyword">public</span> currentGameId <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> currentCourseId <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> engineIsReady <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

@ccclass
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">HomeScene</span> <span class="token keyword">extends</span> <span class="token class-name">cc<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{<!-- --></span>
   <span class="token function">onLoad</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        cc<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"The loading scene did load"</span><span class="token punctuation">)</span>
        <span class="token keyword">let</span> globalNode <span class="token operator">=</span> cc<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token string">'Global'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>cc<span class="token punctuation">.</span>game<span class="token punctuation">.</span><span class="token function">isPersistRootNode</span><span class="token punctuation">(</span>globalNode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            cc<span class="token punctuation">.</span>game<span class="token punctuation">.</span><span class="token function">addPersistRootNode</span><span class="token punctuation">(</span>globalNode<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

@ccclass
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">SubGameScene</span> <span class="token keyword">extends</span> <span class="token class-name">cc<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{<!-- --></span>
   <span class="token function">onLoad</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        cc<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"The loading scene did load"</span><span class="token punctuation">)</span>
       <span class="token keyword">let</span> global <span class="token operator">=</span> cc<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token string">"Global"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getComponent</span><span class="token punctuation">(</span><span class="token string">"Global"</span><span class="token punctuation">)</span> <span class="token keyword">as</span> Global
       <span class="token keyword">let</span> data <span class="token operator">=</span> global<span class="token punctuation">.</span>gameData
	<span class="token punctuation">}</span>

<span class="token punctuation">}</span>

</code></pre>
    <h3>
     <a id="_606">
     </a>
     四、子游戏共享大厅的资源和代码
    </h3>
    <p>
     我：这个下次再说；
     <br/>
     看客：不是不会吧❓；
     <br/>
     我：不是不写，?需要插件去做这个事情，更加方便些。人工去做，太苦。根本不合适。
     <br/>
     看客：你不会写插件吧。
     <br/>
     我：?呵呵。
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/3cb71bcb975b21f06d81c7d023f23b78.png"/>
    </p>
    <p>
     我：能给的自有思路，这个插件你们拿去也没有用不骗人。大概是这样的，打包子游戏的时候，把大厅的资源源码和子游戏一起打包，然后剔除大厅的资源。这样子游戏的settings.js里会有大厅资源的uuid，然而子游戏中代码会有大厅的代码。剔除后子游戏会根据settings.js里的uuid去找大厅的资源。代码在启动大厅的时候已经加载到jsVM,子游戏不会再次加载大厅的代码。
    </p>
    <p>
     结语：好好工作，好好学习
     <br/>
     <img alt="在这里插入图片描述" src="https://timgsa.baidu.com/timg?image&amp;quality=80&amp;size=b9999_10000&amp;sec=1555081764015&amp;di=941185b9fa620f73ef4ff38ada405db7&amp;imgtype=0&amp;src=http://dingyue.nosdn.127.net/c2hYRKzMjOmdN3IaysNfUxzBAOzCCOqcq1andrKugBi8J1537457363838.jpeg"/>
    </p>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a:2f2f626c6f672e6373646e2e6e65742f626f62616932303039:2f61727469636c652f64657461696c732f3839323238363333" class_="artid" style="display:none">
 </p>
</div>


