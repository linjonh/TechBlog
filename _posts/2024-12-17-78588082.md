---
layout: post
title: "分布式文件上传服务架构设计"
date: 2024-12-17 18:18:53 +0800
description: "背景由于某业务需要，需要对文件上传服务进行一次架构调整，初步考虑几点：水平扩展性：上传worker节"
keywords: "文件上传扩展结构图"
categories: ['Others']
tags: ['架构设计', '分布式']
artid: "78588082"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=78588082
    alt: "分布式文件上传服务架构设计"
render_with_liquid: false
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     分布式文件上传服务架构设计
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <h5 id="背景">
     背景
    </h5>
    <p>
     由于某业务需要，需要对文件上传服务进行一次架构调整，初步考虑几点：
    </p>
    <ul>
     <li>
      水平扩展性：上传worker节点按需弹性部署
     </li>
     <li>
      负载均衡：根据上传worker节点的状态随时均衡调度
     </li>
     <li>
      高可用性：无单点问题，快速替换故障点
     </li>
     <li>
      支持断点续传：即需要提供分片上传接口
     </li>
     <li>
      支持秒传：对于上传过的相同文件直接响应完成
     </li>
     <li>
      就近原则：通过离用户最近的区域节点上传文件，通过CDN节点下载文件
     </li>
    </ul>
    <h5 id="初步架构逻辑">
     初步架构逻辑
    </h5>
    <p>
     架构图如图所示：
     <br/>
     <img src="http://moguang.me/img/upload_archi.png">
      <br/>
      重点功能模块说明：
     </img>
    </p>
    <ul>
     <li>
      上传调度服务
      <br/>
      (1)根据用户申请上传的文件判断是否秒传；
      <br/>
      (2)根据用户所在ip及worker节点状态返回上传接口地址。
     </li>
     <li>
      文件上传模块
      <br/>
      (1) 接收用户上传的文件数据(文件/分片)；
      <br/>
      (2) 合并分片/校验文件hash/写入临时存储；
      <br/>
      (3) 定期上报worker节点负载/健康状态；
      <br/>
      (4) 将已上传文件推送到待转移队列；
      <br/>
      (5) 更新数据库文件表信息。
     </li>
     <li>
      文件转移服务
      <br/>
      (1) 将文件从临时存储转移到永久存储文件服务中；
      <br/>
      (2) 更新数据库文件表信息。
     </li>
    </ul>
    <p>
     技术点说明：
    </p>
    <ul>
     <li>
      为什么需要临时存储和永久存储两级文件存储？
      <br/>
      由于永久存储需要做文件校验和副本策略的步骤比较多，并且可能会跨机房传输；如果这样直接写入，用户可能会等待比较长的时间。
      <br/>
      儿用户上传大文件时通过就近的worker节点上传，并持续append到就近的存储服务后，这个时候用户就可以下载了，用户体验较好。
     </li>
     <li>
      文件转移服务的作用
      <br/>
      既然有了两级存储服务，那就需要开启一个文件转移服务来异步将文件进行持续转移，并且根据需要删除临时存储内的文件；因此临时存储容量可以维持在比较稳定的规模。
     </li>
     <li>
      数据库用于存放文件存储位置
      <br/>
      文件未转移时，存储的地址是临时存储中的路径；
      <br/>
      文件转以后，存储的地址是永久存储中的路径；
      <br/>
      这样文件下载服务总是有效的。
     </li>
     <li>
      关于分块合并
      <br/>
      这里需要一整套接口来保证分块上传的完整性和冲突解决，之后再具体描述。
     </li>
     <li>
      关于hash计算
      <br/>
      每个分片算一次hash，并且最后有序的串起来算一次hash，最后作文件完整性校验。
     </li>
     <li>
      关于监控和故障修复
      <br/>
      还需要考虑完善监控完备性，快速报警及修复/替换故障节点。
      <br/>
      考虑到无状态服务情况，客户端需保留几个目标host，以备通讯失败时能及时尝试连接到其他节点。
     </li>
    </ul>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f:2f626c6f672e6373646e2e6e65742f6d6f7869616f6d6f6d6f:2f61727469636c652f64657461696c732f3738353838303832" class_="artid" style="display:none">
 </p>
</div>


