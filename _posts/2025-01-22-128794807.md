---
layout: post
title: "PythonPython操作MySQL详解PyMySQL"
date: 2025-01-22 10:52:02 +0800
description: "PyMySQL模块简介纯Python实现的模块，可以与Python代码兼容衔接，并也几乎兼容MySQ"
keywords: "python pymysql"
categories: ['Python', 'Mysql']
tags: ['Sql', 'Python', 'Mysql']
artid: "128794807"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=128794807
    alt: "PythonPython操作MySQL详解PyMySQL"
render_with_liquid: false
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     【Python】Python操作MySQL详解——PyMySQL
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <p>
    </p>
    <div class="toc">
     <h4>
      Python操作MySQL详解——PyMySQL
     </h4>
     <ul>
      <li>
       <ul>
        <li>
         <a href="#Python_1" rel="nofollow">
          一，Python操作数据库简介
         </a>
        </li>
        <li>
         <a href="#PythonMySQLPyMySQL_11" rel="nofollow">
          二，Python操作MySQL——PyMySQL
         </a>
        </li>
        <li>
         <ul>
          <li>
           <a href="#PyMySQL_12" rel="nofollow">
            （一）PyMySQL模块简介
           </a>
          </li>
          <li>
           <a href="#PyMySQL_15" rel="nofollow">
            （二）PyMySQL使用
           </a>
          </li>
          <li>
           <a href="#SQL_148" rel="nofollow">
            （三）SQL防注入
           </a>
          </li>
         </ul>
        </li>
       </ul>
      </li>
     </ul>
    </div>
    <p>
    </p>
    <h3>
     <a id="Python_1">
     </a>
     一，Python操作数据库简介
    </h3>
    <p>
     Python标准数据库规范为
     <a href="https://peps.python.org/pep-0249/" rel="nofollow">
      DB-API
     </a>
     ， DB-API定义了一系列必须的对象和数据库操作方式，以便为各种数据库系统和数据库访问程序提供一致的访问接口。
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/140f9e9a809e83e84bc0462fedfbeb69.png">
      <br/>
      开发人员将接口封装成不同的数据库操作模块，不同的数据库需要不同数据库操作模块，例如，MySQL数据库，它对应以下操作模块：https://wiki.python.org/moin/MySQL
      <br/>
      <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/643945283e9e4af207a26387dcedd2e7.png">
       <br/>
       其中，最常用的应该是
       <br/>
       1，
       <strong>
        MySQL-python
       </strong>
       ：也就是MySQLdb，底层是通过C操作MySQL，效率高，但是只支持py2，不支持py3。
       <br/>
       2，
       <strong>
        mysqlclient
       </strong>
       ：是MySQL-python的一个分支。它增加了Python 3支持，并修复了许多错误。Django文档推荐的MySQL依赖库。
       <br/>
       3，
       <strong>
        PyMySQL
       </strong>
       ：纯Python实现的模块，可以与Python代码兼容衔接，并也几乎兼容MySQL-python。
       <br/>
       4，
       <strong>
        MySQL Connector/Python
       </strong>
       ：MySQL官方推出的纯Python实现的模块。
      </img>
     </img>
    </p>
    <h3>
     <a id="PythonMySQLPyMySQL_11">
     </a>
     二，Python操作MySQL——PyMySQL
    </h3>
    <h4>
     <a id="PyMySQL_12">
     </a>
     （一）PyMySQL模块简介
    </h4>
    <p>
     纯Python实现的模块，可以与Python代码兼容衔接，并也几乎兼容MySQL-python。遵循 Python 数据库 API v2.0 规范。安装PyMySQL需要满足以下需求。
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/206e8c2840e60f61b0a5da566623b97f.png"/>
    </p>
    <h4>
     <a id="PyMySQL_15">
     </a>
     （二）PyMySQL使用
    </h4>
    <p>
     <strong>
      1，连接数据库
     </strong>
     <br/>
     使用connect函数创建连接对象，此连接对象提供关闭数据库、事务提交、事务回滚等操作。
     <br/>
     传入参数有很多，具体参考文档，一般参数基本连接信息 host, user, password, port(默认为3306), database。
    </p>
    <pre><code class="prism language-python"><span class="token keyword">import</span> pymysql
conn <span class="token operator">=</span> pymysql<span class="token punctuation">.</span>connect<span class="token punctuation">(</span>
    host<span class="token operator">=</span><span class="token string">'127.0.0.1'</span><span class="token punctuation">,</span>
    user<span class="token operator">=</span><span class="token string">'xxx'</span><span class="token punctuation">,</span>
    password<span class="token operator">=</span><span class="token string">'xxxx'</span><span class="token punctuation">,</span>
    port<span class="token operator">=</span><span class="token number">3306</span><span class="token punctuation">,</span>
    database<span class="token operator">=</span><span class="token string">'nba_data'</span>
<span class="token punctuation">)</span>
</code></pre>
    <p>
     <strong>
      主要方法
     </strong>
    </p>
    <table>
     <thead>
      <tr>
       <th>
        方法
       </th>
       <th>
        功能
       </th>
      </tr>
     </thead>
     <tbody>
      <tr>
       <td>
        cursor()
       </td>
       <td>
        获取游标对象，操作数据库，如执行DML操作，调用存储过程等
       </td>
      </tr>
      <tr>
       <td>
        commit()
       </td>
       <td>
        提交事务
       </td>
      </tr>
      <tr>
       <td>
        rollback()
       </td>
       <td>
        回滚事务
       </td>
      </tr>
      <tr>
       <td>
        close()
       </td>
       <td>
        关闭数据库连接
       </td>
      </tr>
     </tbody>
    </table>
    <p>
     <strong>
      2，操作数据库
     </strong>
     <br/>
     使用Cursor对象与数据库进行交互。具体方法参考：https://pymysql.readthedocs.io/en/latest/modules/cursors.html
    </p>
    <p>
     <strong>
      2.1，查询操作
     </strong>
    </p>
    <pre><code class="prism language-python"><span class="token keyword">import</span> pymysql
conn <span class="token operator">=</span> pymysql<span class="token punctuation">.</span>connect<span class="token punctuation">(</span>
    host<span class="token operator">=</span><span class="token string">'127.0.0.1'</span><span class="token punctuation">,</span>
    user<span class="token operator">=</span><span class="token string">'python_link'</span><span class="token punctuation">,</span>
    password<span class="token operator">=</span><span class="token string">'python_link'</span><span class="token punctuation">,</span>
    port<span class="token operator">=</span><span class="token number">3306</span><span class="token punctuation">,</span>
    database<span class="token operator">=</span><span class="token string">'nba_data'</span>
<span class="token punctuation">)</span>
<span class="token comment"># 创建游标，查询数据以元组形式返回</span>
<span class="token comment"># cursor = conn.cursor()</span>

<span class="token comment"># 创建游标，查询数据以字典形式返回</span>
cursor <span class="token operator">=</span> conn<span class="token punctuation">.</span>cursor<span class="token punctuation">(</span>pymysql<span class="token punctuation">.</span>cursors<span class="token punctuation">.</span>DictCursor<span class="token punctuation">)</span>

sql <span class="token operator">=</span> <span class="token string">'select * from player_info_test limit 10'</span>
<span class="token keyword">try</span><span class="token punctuation">:</span>
    cursor<span class="token punctuation">.</span>execute<span class="token punctuation">(</span>sql<span class="token punctuation">)</span>
    <span class="token comment"># result = cursor.fetchall()  # 返回所有数据</span>
    <span class="token comment"># result = cursor.fetchone()  # 返回一行数据</span>
    result <span class="token operator">=</span> cursor<span class="token punctuation">.</span>fetchmany<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>  <span class="token comment"># fetchmany(size) 获取查询结果集中指定数量的记录，size默认为1</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>
<span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
    conn<span class="token punctuation">.</span>rollback<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
<span class="token keyword">finally</span><span class="token punctuation">:</span>
    cursor<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
    conn<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
    <p>
     <strong>
      2.2，插入操作
     </strong>
     <br/>
     插入操作中参数可以
     <em>
      <strong>
       以元组、列表和字典形式传入
      </strong>
     </em>
     ，需要使用到占位符 “%s”，
     <em>
      <strong>
       注意这只是个占位符，不同于Python 中字符串格式化中的转换说明符。
      </strong>
     </em>
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/96e88da2815dba93a2624ca93d26fa33.png"/>
    </p>
    <pre><code class="prism language-python"><span class="token comment"># 元组、列表形式传参</span>
sql <span class="token operator">=</span> <span class="token string">'insert into player_info_test(PERSON_ID,PERSON_NAME,AGE) VALUES(%s, %s, %s)'</span>
<span class="token keyword">try</span><span class="token punctuation">:</span>
    cursor<span class="token punctuation">.</span>execute<span class="token punctuation">(</span>sql<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">"999999"</span><span class="token punctuation">,</span> <span class="token string">"kenny"</span><span class="token punctuation">,</span> <span class="token number">28</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    conn<span class="token punctuation">.</span>commit<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
    conn<span class="token punctuation">.</span>rollback<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
<span class="token keyword">finally</span><span class="token punctuation">:</span>
    cursor<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
    conn<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token comment"># 字典形式传参</span>
sql <span class="token operator">=</span> <span class="token string">'insert into player_info_test(PERSON_ID,PERSON_NAME,AGE) VALUES(%(person_id)s, %(person_name)s, %(age)s)'</span>
<span class="token keyword">try</span><span class="token punctuation">:</span>
    cursor<span class="token punctuation">.</span>execute<span class="token punctuation">(</span>sql<span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span><span class="token string">"person_id"</span><span class="token punctuation">:</span> <span class="token string">"999998"</span><span class="token punctuation">,</span> <span class="token string">"person_name"</span><span class="token punctuation">:</span> <span class="token string">"kenny"</span><span class="token punctuation">,</span> <span class="token string">"age"</span><span class="token punctuation">:</span> <span class="token number">28</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    conn<span class="token punctuation">.</span>commit<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
    conn<span class="token punctuation">.</span>rollback<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
<span class="token keyword">finally</span><span class="token punctuation">:</span>
    cursor<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
    conn<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
    <p>
     <strong>
      2.3，更新操作
     </strong>
    </p>
    <pre><code class="prism language-python">sql <span class="token operator">=</span> <span class="token string">'update  player_info_test set PERSON_NAME=%s where PERSON_ID = %s'</span>
<span class="token keyword">try</span><span class="token punctuation">:</span>
    cursor<span class="token punctuation">.</span>execute<span class="token punctuation">(</span>sql<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'liu'</span><span class="token punctuation">,</span> <span class="token string">'999998'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    conn<span class="token punctuation">.</span>commit<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
    conn<span class="token punctuation">.</span>rollback<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
<span class="token keyword">finally</span><span class="token punctuation">:</span>
    cursor<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
    conn<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
    <p>
     <strong>
      2.4，删除操作
     </strong>
    </p>
    <pre><code class="prism language-python">sql <span class="token operator">=</span> <span class="token string">'delete from  player_info_test where PERSON_ID = %s'</span>
<span class="token keyword">try</span><span class="token punctuation">:</span>
    cursor<span class="token punctuation">.</span>execute<span class="token punctuation">(</span>sql<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'999999'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    conn<span class="token punctuation">.</span>commit<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
    conn<span class="token punctuation">.</span>rollback<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
<span class="token keyword">finally</span><span class="token punctuation">:</span>
    cursor<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
    conn<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
    <p>
     <strong>
      增删改需要有提交事务的操作，除了execute方法，还有批量操作方法executemany()。
     </strong>
    </p>
    <p>
     <strong>
      2.5，批量插入操作
     </strong>
    </p>
    <pre><code class="prism language-python">sql <span class="token operator">=</span> <span class="token string">'insert into player_info_test(PERSON_ID,PERSON_NAME,AGE) VALUES(%s, %s, %s)'</span>
param <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token string">"999999"</span><span class="token punctuation">,</span> <span class="token string">"kenny"</span><span class="token punctuation">,</span> <span class="token number">28</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">"999998"</span><span class="token punctuation">,</span> <span class="token string">"liu"</span><span class="token punctuation">,</span> <span class="token number">28</span><span class="token punctuation">)</span><span class="token punctuation">]</span>   <span class="token comment"># 元组列表作为传入参数</span>
<span class="token keyword">try</span><span class="token punctuation">:</span>
    cursor<span class="token punctuation">.</span>executemany<span class="token punctuation">(</span>sql<span class="token punctuation">,</span> param<span class="token punctuation">)</span>
    conn<span class="token punctuation">.</span>commit<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
    conn<span class="token punctuation">.</span>rollback<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
<span class="token keyword">finally</span><span class="token punctuation">:</span>
    cursor<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
    conn<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
    <h4>
     <a id="SQL_148">
     </a>
     （三）SQL防注入
    </h4>
    <p>
     SQL注入是一种常见的网络攻击手法，它利用sql的语法特性和程序员编写程序时产生的漏洞，用一些特殊符号的组合产生特殊的含义，使得正常的sql语句失效，从而逃脱正常的业务逻辑，完成一些如跳过密码验证等的非法操作。
    </p>
    <p>
     <em>
      <strong>
       产生原因：SQL语句使用了动态拼接的方式。
      </strong>
     </em>
    </p>
    <p>
     比如，登录时，使用以下SQL查询验证用户信息
    </p>
    <pre><code class="prism language-python"><span class="token string">'SELECT username FROM user WHERE username = %s AND password = %s'</span> <span class="token operator">%</span> <span class="token punctuation">(</span>username <span class="token punctuation">,</span>password<span class="token punctuation">)</span>
</code></pre>
    <p>
     并且，没有对用户的输入做任何处理，直接放到了SQL语句中。那么，当黑客输入了’jjyang’ OR 1=1 – jjyang 作为用户名时，原来的SQL语句就会变成下面的样子：
    </p>
    <pre><code class="prism language-python">SELECT username FROM user WHERE username <span class="token operator">=</span> <span class="token string">'jjyang'</span> OR <span class="token number">1</span><span class="token operator">=</span><span class="token number">1</span> <span class="token operator">-</span><span class="token operator">-</span> jjyang AND password<span class="token operator">=</span><span class="token string">''</span>
</code></pre>
    <p>
     WHERE username = ‘jjyang’ OR 1=1 是一个恒成立的条件，所以无论输入什么用户名都会返回True；而–后面的语句被当作注释忽略掉了，密码验证也被跳过。最终，绕过验证，成功登录。
    </p>
    <p>
     <strong>
      针对参数不要采用拼接处理，交给pymysql中的方法（execute）自动处理，并对输入数据进行检查校验
     </strong>
    </p>
    <pre><code class="prism language-python"><span class="token comment"># 元组,列表形式</span>
param <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token string">'jjyangs'</span><span class="token punctuation">,</span><span class="token string">'123445'</span><span class="token punctuation">)</span>
sql <span class="token operator">=</span> <span class="token string">'SELECT username FROM user WHERE username = %s AND password = %s'</span>
cursor<span class="token punctuation">.</span>execute<span class="token punctuation">(</span>sql<span class="token punctuation">,</span> param<span class="token punctuation">)</span>

<span class="token comment"># 字典形式</span>
param <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token string">'name'</span><span class="token punctuation">:</span><span class="token string">'jjyangs'</span><span class="token punctuation">,</span><span class="token string">'pwd'</span><span class="token punctuation">:</span><span class="token string">'123445'</span><span class="token punctuation">}</span>
sql <span class="token operator">=</span> <span class="token string">'SELECT username FROM user WHERE username = %(name)s AND password = %(pwd)s'</span>
cursor<span class="token punctuation">.</span>execute<span class="token punctuation">(</span>sql<span class="token punctuation">,</span> param<span class="token punctuation">)</span>
</code></pre>
    <p>
     <strong>
      需要注意的是，不要因为参数是其他类型而换掉 %s，pymysql 的占位符并不是 python 的通用格式化转换说明符。同时，也不要因为参数是 string 就在 %s 两边加引号，mysql 会自动去处理。
     </strong>
    </p>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f:2f626c6f672e6373646e2e6e65742f79616e676a6a75616e2f:61727469636c652f64657461696c732f313238373934383037" class_="artid" style="display:none">
 </p>
</div>


