---
layout: post
title: "微信小程序静默登录流程等待登录完成方可请求业务,request网络请求封装,上锁避免重复login,区分测试环境体验版"
date: 2021-08-24 18:04:58 +0800
description: "这篇博客介绍了微信小程序的登录流程，包括静默登录的实现，以及如何根据环境动态配置域名。作者分享了登录"
keywords: "微信小程序修改代码后要重新登录"
categories: ['微信小程序', '前端笔记']
tags: ['小程序', '前端', 'Javascript']
artid: "119895436"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=119895436
    alt: "微信小程序静默登录流程等待登录完成方可请求业务,request网络请求封装,上锁避免重复login,区分测试环境体验版"
render_with_liquid: false
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     微信小程序静默登录流程（等待登录完成方可请求业务），request网络请求封装，上锁避免重复login，区分测试环境（体验版）
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <p>
     如有错误或不好的地方，感谢指正
    </p>
    <p>
     <a href="https://developers.weixin.qq.com/miniprogram/dev/framework/open-ability/login.html" rel="nofollow">
      小程序登录
     </a>
    </p>
    <p>
     官方文档是本文的基础
    </p>
    <h3>
     <a id="_6">
     </a>
     为什么有这个
    </h3>
    <ol>
     <li>
      开发小程序时是否用户每次进入小程序都重新wx.login请求更新token？
     </li>
    </ol>
    <p>
     当我刚接触做微信小程序的时候我这样做过，后端同样是这种方式，但显然根据官方的意思这是不合理的，不然你压根用不着checkSession，而且这样是有问题的
    </p>
    <p>
     因此，才想把这一方面的东西记录下来，虽然现在没做小程序的项目，但也简单实现一下，以便自己以后用得着
    </p>
    <ol start="2">
     <li>
      关于静默登录的调用时机
     </li>
    </ol>
    <p>
     当初始页面请求需要身份认证时，也许会遇到还没登录完成，token还没拿到的情况，这是小程序生命周期以及请求异步产生的。
    </p>
    <p>
     这带来很多问题，比如你可能需要在页面onLoad监测token延时请求，但这样是麻烦的，所以我希望在request上再封装一层，
    </p>
    <p>
     设置了当login 上锁，并且避免了多个请求都触发login的问题，但这样请求没办法拦截。这里想到了维护一个单队列或许能很好解决
    </p>
    <ol start="3">
     <li>
      如何在微信小程序根据不同环境配置不同的域名？
     </li>
    </ol>
    <p>
     这里使用了wx.getAccountInfoSync().miniProgram 对应区分开发，体验（测试）、生产环境
    </p>
    <p>
     <a href="https://gitee.com/c_jiaming/weapp_login_template/tree/js_version/" rel="nofollow">
      gitee上的demo
     </a>
     可以直接在此下载运行，但建议你从下面代码中选择你需要的，因为，我也不知道有没有bug。
    </p>
    <p>
     以下是所有代码，都有详细注释
    </p>
    <h4>
     <a id="network_29">
     </a>
     network目录
    </h4>
    <p>
     token认证请配合utils.login.js &amp; app.js=&gt;onLaunch中关于登录相关代码使用 ，当然也可以根据业务自行修改 ，其他均为项目自动生成文件
    </p>
    <p>
     目前仅有wx.request
    </p>
    <p>
     wx.downloadFile wx.uploadFile 等未在涉及范围内
    </p>
    <ol>
     <li>
      <p>
       适用token认证方式，静默登录
      </p>
     </li>
     <li>
      <p>
       <strong>
        默认request接口传参 identity 区分该请求是否需要token认证
       </strong>
      </p>
     </li>
     <li>
      <p>
       默认后端返回格式为
       <strong>
        { code: xxx, message: xxx, result: xxx }
       </strong>
       , code,message,result字段名可根据业务在config内修改，如有很大差异，这可能需要你在逻辑代码中调整
      </p>
     </li>
     <li>
      <p>
       为达到不同环境切换不同域名的目的，采用 wx.getAccountInfoSync().miniProgram 以此区分开发版，体验版（用作测试版本），正式版
      </p>
     </li>
    </ol>
    <p>
     /network/config.js 主要的配置
    </p>
    <pre><code class="prism language-js"><span class="token keyword">const</span> <span class="token punctuation">{<!-- --></span> envVersion <span class="token punctuation">}</span> <span class="token operator">=</span> wx<span class="token punctuation">.</span><span class="token function">getAccountInfoSync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>miniProgram<span class="token punctuation">;</span>

<span class="token comment">// **请根据业务修改**</span>
<span class="token keyword">const</span> domainOptions <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
  <span class="token literal-property property">develop</span><span class="token operator">:</span> <span class="token string">"http://127.0.0.1:3000"</span><span class="token punctuation">,</span> <span class="token comment">//开发版</span>
  <span class="token literal-property property">trial</span><span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">,</span> <span class="token comment">//体验版</span>
  <span class="token literal-property property">release</span><span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">,</span> <span class="token comment">//正式版</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token constant">DOMAIN</span> <span class="token operator">=</span> domainOptions<span class="token punctuation">[</span>envVersion<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">//不同环境的域名</span>

<span class="token comment">// **请根据业务修改**</span>
<span class="token comment">// 后端响应字段</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> resCode <span class="token operator">=</span> <span class="token string">"code"</span><span class="token punctuation">;</span> <span class="token comment">//对应业务逻辑自定的状态码  如果是request http请求响应的状态码处理逻辑，请修改为 statusCode</span>
<span class="token comment">// export const resMes = "message";//对应业务逻辑自定的提示</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> resResult <span class="token operator">=</span> <span class="token string">"result"</span><span class="token punctuation">;</span> <span class="token comment">//对应业务逻辑自定的数据结果</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token constant">DELAYED</span> <span class="token operator">=</span> <span class="token number">200</span><span class="token punctuation">;</span> <span class="token comment">//每次等待登录的延时时间，毫秒</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> Authorization <span class="token operator">=</span> <span class="token string">"Authorization"</span><span class="token punctuation">;</span> <span class="token comment">//token命名，请求header以及Storage中的名字</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token constant">CONTENT_TYPE</span> <span class="token operator">=</span> <span class="token string">"application/json"</span><span class="token punctuation">;</span> <span class="token comment">//application/x-www-form-urlencoded</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token constant">TIMEOUT</span> <span class="token operator">=</span> <span class="token number">12000</span><span class="token punctuation">;</span> <span class="token comment">//超时</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token constant">HTTP_STATUS</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
  <span class="token constant">SUCCESS</span><span class="token operator">:</span> <span class="token number">20000</span><span class="token punctuation">,</span> <span class="token comment">//成功，也可以是一个数组  **请根据业务修改** 必填</span>
  <span class="token constant">CLIENT_ERROR</span><span class="token operator">:</span> <span class="token number">40000</span><span class="token punctuation">,</span> <span class="token comment">//客户端错误</span>
  <span class="token constant">AUTHENTICATE</span><span class="token operator">:</span> <span class="token number">40100</span><span class="token punctuation">,</span> <span class="token comment">//默认401为token验证失效 **请根据业务修改**  必填</span>
  <span class="token constant">FORBIDDEN</span><span class="token operator">:</span> <span class="token number">40003</span><span class="token punctuation">,</span> <span class="token comment">//禁止，无权限</span>
  <span class="token constant">NOT_FOUND</span><span class="token operator">:</span> <span class="token number">40004</span><span class="token punctuation">,</span> <span class="token comment">//无请求地址</span>
  <span class="token constant">SERVER_ERROR</span><span class="token operator">:</span> <span class="token number">50000</span><span class="token punctuation">,</span> <span class="token comment">//服务器错误</span>
  <span class="token constant">BAD_GATEWAY</span><span class="token operator">:</span> <span class="token number">50002</span><span class="token punctuation">,</span> <span class="token comment">//网关问题</span>
  <span class="token constant">SERVICE_UNAVAILABLE</span><span class="token operator">:</span> <span class="token number">50003</span><span class="token punctuation">,</span> <span class="token comment">//服务不可用</span>
  <span class="token constant">GATEWAY_TIMEOUT</span><span class="token operator">:</span> <span class="token number">50004</span><span class="token punctuation">,</span> <span class="token comment">//超时</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

</code></pre>
    <p>
     /network/index.js 所有请求接口将在这里维护
    </p>
    <pre><code class="prism language-js"><span class="token keyword">import</span> <span class="token punctuation">{<!-- --></span> request <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"./request"</span><span class="token punctuation">;</span>
<span class="token comment">/**
 * 
 * @param method 以GET,POST为例，需要其他请求方法的自行修改
 * @param data 一个json对象参数
 * @param header 自定的header，与默认重复的key将覆盖默认的header设置
 */</span>

<span class="token comment">//登录接口，根据业务替换为真实的请求路径  默认参数传递 为 {code:wxCode}  如有必要可在utils/login.js =&gt; refreshLogin 方法中更改</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">login</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">data<span class="token punctuation">,</span>header</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">request</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span><span class="token literal-property property">method</span><span class="token operator">:</span><span class="token string">'POST'</span><span class="token punctuation">,</span><span class="token literal-property property">url</span><span class="token operator">:</span><span class="token string">'/login'</span><span class="token punctuation">,</span> <span class="token literal-property property">identity</span><span class="token operator">:</span><span class="token boolean">false</span><span class="token punctuation">,</span> data<span class="token punctuation">,</span>header<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//GET</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">testGet</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">data<span class="token punctuation">,</span>header</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">request</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span><span class="token literal-property property">method</span><span class="token operator">:</span><span class="token string">'GET'</span><span class="token punctuation">,</span><span class="token literal-property property">url</span><span class="token operator">:</span><span class="token string">'/test'</span><span class="token punctuation">,</span> <span class="token literal-property property">identity</span><span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">,</span> data<span class="token punctuation">,</span>header<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//testGet2</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">testGet2</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">data<span class="token punctuation">,</span>header</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">request</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span><span class="token literal-property property">method</span><span class="token operator">:</span><span class="token string">'GET'</span><span class="token punctuation">,</span><span class="token literal-property property">url</span><span class="token operator">:</span><span class="token string">'/test2'</span><span class="token punctuation">,</span> <span class="token literal-property property">identity</span><span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">,</span> data<span class="token punctuation">,</span>header<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//tokenInvalid</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">tokenInvalid</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">data<span class="token punctuation">,</span>header</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">request</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span><span class="token literal-property property">method</span><span class="token operator">:</span><span class="token string">'GET'</span><span class="token punctuation">,</span><span class="token literal-property property">url</span><span class="token operator">:</span><span class="token string">'/tokenInvalid'</span><span class="token punctuation">,</span> <span class="token literal-property property">identity</span><span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">,</span> data<span class="token punctuation">,</span>header<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <p>
     /network/request.js request请求相关逻辑
    </p>
    <pre><code class="prism language-js"><span class="token keyword">import</span> <span class="token punctuation">{<!-- --></span>
  <span class="token constant">DOMAIN</span><span class="token punctuation">,</span>
  <span class="token constant">TIMEOUT</span><span class="token punctuation">,</span>
  <span class="token constant">CONTENT_TYPE</span><span class="token punctuation">,</span>
  <span class="token constant">HTTP_STATUS</span><span class="token punctuation">,</span>
  <span class="token constant">DELAYED</span><span class="token punctuation">,</span>
  Authorization<span class="token punctuation">,</span>
  resCode<span class="token punctuation">,</span>
  resResult<span class="token punctuation">,</span>
<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"./config"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{<!-- --></span> refreshLogin <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"../utils/login.js"</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">request</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">params</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">//request更多配置参考文档 https://developers.weixin.qq.com/miniprogram/dev/api/network/request/wx.request.html</span>
    <span class="token keyword">let</span> <span class="token punctuation">{<!-- --></span> method<span class="token punctuation">,</span> url<span class="token punctuation">,</span> identity<span class="token punctuation">,</span> data <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">,</span> header <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span> <span class="token punctuation">}</span> <span class="token operator">=</span> params<span class="token punctuation">;</span>
    <span class="token keyword">let</span> token <span class="token operator">=</span> wx<span class="token punctuation">.</span><span class="token function">getStorageSync</span><span class="token punctuation">(</span>Authorization<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//LOGIN_SWITCH不在此判断 是因为请求异步 除非维护一个请求队列 否则 无法避免 所以 折中选择token失效后再重新请求</span>
    <span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">getApp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token constant">FIRST_RUN</span> <span class="token operator">=</span> app<span class="token punctuation">.</span>globalData<span class="token punctuation">.</span><span class="token constant">FIRST_RUN</span><span class="token punctuation">;</span> <span class="token comment">// 小程序首次启动，等待checklogin</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>identity <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token operator">!</span>token <span class="token operator">||</span> <span class="token constant">FIRST_RUN</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">//首次进入需要认证并且当前无登录状态时延时请求,默认200毫秒等待  小程序初始化的登录</span>
      <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token function">request</span><span class="token punctuation">(</span>params<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token constant">DELAYED</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">let</span> defaultHeader <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
      <span class="token punctuation">[</span>Authorization<span class="token punctuation">]</span><span class="token operator">:</span> token<span class="token punctuation">,</span>
      <span class="token string-property property">"content-type"</span><span class="token operator">:</span> <span class="token constant">CONTENT_TYPE</span><span class="token punctuation">,</span> <span class="token comment">// 默认值</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    wx<span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
      method<span class="token punctuation">,</span> <span class="token comment">//请求方式</span>
      <span class="token literal-property property">url</span><span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^http(s?):\/\/</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span> <span class="token operator">?</span> url <span class="token operator">:</span> <span class="token constant">DOMAIN</span> <span class="token operator">+</span> url<span class="token punctuation">,</span> <span class="token comment">//当传入url带协议时，将不加配置项的域名</span>
      data<span class="token punctuation">,</span> <span class="token comment">//请求参数</span>
      <span class="token literal-property property">header</span><span class="token operator">:</span> Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span>defaultHeader<span class="token punctuation">,</span> header<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">//相同header设置将覆盖默认</span>
      <span class="token literal-property property">timeout</span><span class="token operator">:</span> <span class="token constant">TIMEOUT</span><span class="token punctuation">,</span> <span class="token comment">//设置超时</span>
      <span class="token function">success</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 默认对请求响应的res.data中后端自行定义的code处理，如你需要 request http请求响应的状态码处理逻辑，需要自行修改</span>
        <span class="token keyword">const</span> code <span class="token operator">=</span> res<span class="token punctuation">.</span>data<span class="token punctuation">[</span>resCode<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token comment">// 如果响应状态码在正确范围内，直接响应数据</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>
          <span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span><span class="token constant">HTTP_STATUS</span><span class="token punctuation">.</span><span class="token constant">SUCCESS</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
            <span class="token constant">HTTP_STATUS</span><span class="token punctuation">.</span><span class="token constant">SUCCESS</span><span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">||</span>
          code <span class="token operator">===</span> <span class="token constant">HTTP_STATUS</span><span class="token punctuation">.</span><span class="token constant">SUCCESS</span>
        <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token function">resolve</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>data<span class="token punctuation">[</span>resResult<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>code <span class="token operator">===</span> <span class="token constant">HTTP_STATUS</span><span class="token punctuation">.</span><span class="token constant">AUTHENTICATE</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token comment">//当提示token失效时</span>
          <span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">getApp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">const</span> <span class="token constant">LOGIN_SWITCH</span> <span class="token operator">=</span> app<span class="token punctuation">.</span>globalData<span class="token punctuation">.</span><span class="token constant">LOGIN_SWITCH</span><span class="token punctuation">;</span> <span class="token comment">// login锁，确保没有登录冲突</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">LOGIN_SWITCH</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">//如果已锁说明有 在重新登录 只需要等待一下 继续请求</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">1231</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
              <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token function">request</span><span class="token punctuation">(</span>params<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token constant">DELAYED</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">//重新登录并继续请求</span>
            <span class="token function">refreshLogin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
              <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token function">request</span><span class="token punctuation">(</span>params<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
          <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//更多状态码处理在这处理  建议success都返回res.data 以便未来需要在业务逻辑处理不同状态，当然，你也可以 非20000 就直接reject</span>
        <span class="token function">reject</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token function">fail</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        wx<span class="token punctuation">.</span><span class="token function">showToast</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
          <span class="token literal-property property">title</span><span class="token operator">:</span> <span class="token string">"网络出错啦！"</span><span class="token punctuation">,</span>
          <span class="token literal-property property">icon</span><span class="token operator">:</span> <span class="token string">"error"</span><span class="token punctuation">,</span>
          <span class="token literal-property property">duration</span><span class="token operator">:</span> <span class="token number">3000</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">reject</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

</code></pre>
    <h4>
     <a id="server__189">
     </a>
     server 目录
    </h4>
    <p>
     server/index.js 写的时候用到的一些模拟响应的接口，依赖express
    </p>
    <pre><code class="prism language-js"><span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">let</span> num <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>express<span class="token punctuation">.</span><span class="token function">urlencoded</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span> <span class="token literal-property property">extended</span><span class="token operator">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>express<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/test'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span> <span class="token literal-property property">code</span><span class="token operator">:</span> <span class="token number">20000</span><span class="token punctuation">,</span> <span class="token literal-property property">message</span><span class="token operator">:</span> <span class="token string">"ok"</span><span class="token punctuation">,</span> <span class="token literal-property property">result</span><span class="token operator">:</span> <span class="token string">'get响应数据'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/test2'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span> <span class="token literal-property property">code</span><span class="token operator">:</span> <span class="token number">20000</span><span class="token punctuation">,</span> <span class="token literal-property property">message</span><span class="token operator">:</span> <span class="token string">"ok"</span><span class="token punctuation">,</span> <span class="token literal-property property">result</span><span class="token operator">:</span> <span class="token string">'get响应数据2'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/tokenInvalid'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>req<span class="token punctuation">.</span>headers<span class="token punctuation">.</span>token <span class="token operator">===</span> <span class="token string">'2222222222'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span> <span class="token literal-property property">code</span><span class="token operator">:</span> <span class="token number">40001</span><span class="token punctuation">,</span> <span class="token literal-property property">message</span><span class="token operator">:</span> <span class="token string">"token失效，请重新登录"</span><span class="token punctuation">,</span> <span class="token literal-property property">result</span><span class="token operator">:</span> <span class="token string">''</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
    res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span> <span class="token literal-property property">code</span><span class="token operator">:</span> <span class="token number">20000</span><span class="token punctuation">,</span> <span class="token literal-property property">message</span><span class="token operator">:</span> <span class="token string">"ok"</span><span class="token punctuation">,</span> <span class="token literal-property property">result</span><span class="token operator">:</span> <span class="token string">'成功拿到'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

<span class="token punctuation">}</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/login'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span> <span class="token literal-property property">code</span><span class="token operator">:</span> <span class="token number">20000</span><span class="token punctuation">,</span> <span class="token literal-property property">message</span><span class="token operator">:</span> <span class="token string">"ok"</span><span class="token punctuation">,</span> <span class="token literal-property property">result</span><span class="token operator">:</span> <span class="token string">'1111111111'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token comment">// res.json({ code: 20000, message: "ok", result: '2222222222' })</span>

<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// 监听端口</span>
app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">8888</span><span class="token punctuation">)</span>
</code></pre>
    <h4>
     <a id="utils_loginjs_224">
     </a>
     utils 原文件夹新增了一个login.js
    </h4>
    <p>
     utils/login.js 登录逻辑写在这里了
    </p>
    <pre><code class="prism language-javascript"><span class="token comment">/**
 * 登录相关 **仅做参考** 如有必要请自行修改
 * 遵循官方给出的 wx.login 的最佳实践
 * 尽可能以 session_key 有效期作为自身登录态有效期
 * 这里默认后端缓存sesion_key,每次进入小程序前端会监测是否过期， 重新登录后端就可以刷新sesion_key
 */</span>
<span class="token keyword">import</span> <span class="token punctuation">{<!-- --></span> Authorization <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"../network/config"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{<!-- --></span> login <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"../network/index.js"</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * 用户登录逻辑,首次进入小程序或任意时刻重新登录
 */</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">userLogin</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 检查登录状态 成功的话就用久的token</span>
    <span class="token function">checkLogin</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">token</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"old_token ===="</span><span class="token punctuation">,</span> token<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">resolve</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 失败就重新获取登录凭证 总之都会返回一个token</span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
          <span class="token keyword">const</span> token <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">refreshLogin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"new_token："</span><span class="token punctuation">,</span> token<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token function">resolve</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token function">reject</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * 用户进入小程序静默登录前监测登录态
 */</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">checkLogin</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// wxapi直接判断是否过期</span>
    wx<span class="token punctuation">.</span><span class="token function">checkSession</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
      <span class="token function">success</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//session_key 未过期，并且在本生命周期内将一直有效</span>
        <span class="token comment">// session 成功但 token 不存在时，这种情况基本不会出现</span>
        <span class="token keyword">const</span> token <span class="token operator">=</span> wx<span class="token punctuation">.</span><span class="token function">getStorageSync</span><span class="token punctuation">(</span>Authorization<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>token<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token function">resolve</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
          <span class="token function">reject</span><span class="token punctuation">(</span><span class="token string">"token_err"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token function">fail</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// session_key 已经失效，不管有没有token都需要重新执行登录流程</span>
        <span class="token function">reject</span><span class="token punctuation">(</span><span class="token string">"session_key_err"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * 重新登录======token不存在或过期 session_key失效时
 */</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">refreshLogin</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">getApp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  app<span class="token punctuation">.</span>globalData<span class="token punctuation">.</span><span class="token constant">LOGIN_SWITCH</span> <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  wx<span class="token punctuation">.</span><span class="token function">removeStorageSync</span><span class="token punctuation">(</span>Authorization<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">// 获取到微信code</span>
      <span class="token keyword">const</span> code <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getWxCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 请求login接口，把code给服务端进行微信登录</span>
      <span class="token function">login</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span> code <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
          console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"重新登录"</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token comment">// 拿到token存到storage</span>
          <span class="token keyword">const</span> <span class="token punctuation">{<!-- --></span> token <span class="token punctuation">}</span> <span class="token operator">=</span> data<span class="token punctuation">;</span>
          wx<span class="token punctuation">.</span><span class="token function">setStorageSync</span><span class="token punctuation">(</span>Authorization<span class="token punctuation">,</span> token<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token comment">// 登录锁解掉</span>
          app<span class="token punctuation">.</span>globalData<span class="token punctuation">.</span><span class="token constant">LOGIN_SWITCH</span> <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
          <span class="token function">resolve</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
          <span class="token function">reject</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token function">reject</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * 获取 小程序的code
 */</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">getWxCode</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
    wx<span class="token punctuation">.</span><span class="token function">login</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
      <span class="token function">success</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>res<span class="token punctuation">.</span>code<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token comment">// 把微信code返回</span>
          <span class="token function">resolve</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>code<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
          wx<span class="token punctuation">.</span><span class="token function">showToast</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
            <span class="token literal-property property">title</span><span class="token operator">:</span> <span class="token string">"登录失败，请重新进入小程序"</span><span class="token punctuation">,</span>
            <span class="token literal-property property">icon</span><span class="token operator">:</span> <span class="token string">"none"</span><span class="token punctuation">,</span>
            <span class="token literal-property property">duration</span><span class="token operator">:</span> <span class="token number">3000</span><span class="token punctuation">,</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

</code></pre>
    <h4>
     <a id="appjs_342">
     </a>
     app.js
    </h4>
    <p>
     /app.js
    </p>
    <pre><code class="prism language-js"><span class="token comment">// app.js</span>
<span class="token comment">// app.js</span>
<span class="token keyword">import</span> <span class="token punctuation">{<!-- --></span>userLogin <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"./utils/login"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{<!-- --></span>getUserInfo <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./network/index.js'</span><span class="token punctuation">;</span>
<span class="token function">App</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
  <span class="token function">onLaunch</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// login start</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>globalData<span class="token punctuation">.</span><span class="token constant">FIRST_RUN</span> <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token function">userLogin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">token</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{<!-- --></span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'登录流程结束'</span><span class="token punctuation">)</span>
      <span class="token comment">//如果需要获取用户信息等 可以选择在此处理 或 修改utils/login.js的逻辑</span>
      <span class="token comment">// dosometion</span>
      <span class="token function">getUserInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">result</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>globalData<span class="token punctuation">.</span>userInfo <span class="token operator">=</span> result<span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">[</span>

    <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">finally</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{<!-- --></span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>globalData<span class="token punctuation">.</span><span class="token constant">FIRST_RUN</span> <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token comment">// login end</span>


    <span class="token comment">/* 官方生成代码
    // 展示本地存储能力
    const logs = wx.getStorageSync('logs') || []
    logs.unshift(Date.now())
    wx.setStorageSync('logs', logs)

    // 登录
    wx.login({
      success: res =&gt; {
        // 发送 res.code 到后台换取 openId, sessionKey, unionId
      }
    })
    */</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token literal-property property">globalData</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token constant">FIRST_RUN</span><span class="token operator">:</span><span class="token boolean">false</span><span class="token punctuation">,</span>
    <span class="token constant">LOGIN_SWITCH</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    <span class="token literal-property property">userInfo</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    <span class="token constant">BASE_URL</span><span class="token operator">:</span><span class="token string">"http://media.top/"</span><span class="token punctuation">,</span>
    <span class="token literal-property property">userInfo</span><span class="token operator">:</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

</code></pre>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f626c6f672e:6373646e2e6e65742f77656978696e5f34323939383730372f:61727469636c652f64657461696c732f313139383935343336" class_="artid" style="display:none">
 </p>
</div>


