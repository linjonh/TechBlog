---
layout: post
title: "ffmpeg学习笔记-多线程音视频解码"
date: 2019-04-05 23:35:53 +0800
description: "之前的视频解码仍然存在问题，那就是是在主线程中去完成解码的，会造成线程阻塞，这里将其改为多线程解码，"
keywords: "ffmpeg 多线程"
categories: ['Android']
tags: ['Ffmpeg']
artid: "89049120"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=89049120
    alt: "ffmpeg学习笔记-多线程音视频解码"
render_with_liquid: false
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     ffmpeg学习笔记-多线程音视频解码
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-tomorrow-night-eighties" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <p>
     之前的视频解码仍然存在问题，那就是是在主线程中去完成解码的，会造成线程阻塞，这里将其改为多线程解码，使其主线程不被阻塞
    </p>
    <p>
     前面介绍了音视频的主线程解码，那样会阻塞主线程，在前面学习了多线程以后，就可以对音频和视频分离开来在子线程里解析了，但这样存在音视频同步的问题了，这里贴出代码，只是提供一种思路，其运行存在大量问题，还需要慢慢解决。例如，退出发生异常，音视频不同步
    </p>
    <pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;android/log.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;pthread.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;android/native_window.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;android/native_window_jni.h&gt;</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"com_cj5785_ffmpegvideothread_VideoPlayer.h"</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"include/ffmpeg/libavformat/avformat.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"include/ffmpeg/libavcodec/avcodec.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"include/ffmpeg/libswscale/swscale.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"include/ffmpeg/libswresample/swresample.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"include/libyuv/libyuv.h"</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">LOGI</span><span class="token expression"><span class="token punctuation">(</span>FORMAT<span class="token punctuation">,</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> <span class="token function">__android_log_print</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span></span><span class="token string">"cj5785"</span><span class="token expression"><span class="token punctuation">,</span>FORMAT<span class="token punctuation">,</span></span><span class="token punctuation">##</span><span class="token expression">__VA_ARGS__<span class="token punctuation">)</span><span class="token punctuation">;</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">LOGE</span><span class="token expression"><span class="token punctuation">(</span>FORMAT<span class="token punctuation">,</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> <span class="token function">__android_log_print</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">,</span></span><span class="token string">"cj5785"</span><span class="token expression"><span class="token punctuation">,</span>FORMAT<span class="token punctuation">,</span></span><span class="token punctuation">##</span><span class="token expression">__VA_ARGS__<span class="token punctuation">)</span><span class="token punctuation">;</span></span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MAX_STREAM</span> <span class="token expression"><span class="token number">2</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">VIDEO_STREAM_TYPE</span> <span class="token expression"><span class="token number">0</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">AUDIO_STREAM_TYPE</span> <span class="token expression"><span class="token number">1</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MAX_AUDIO_FRME_SIZE</span> <span class="token expression"><span class="token number">48000</span> <span class="token operator">*</span> <span class="token number">4</span></span></span>

<span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">_Player</span>
<span class="token punctuation">{<!-- --></span>
	JavaVM <span class="token operator">*</span>javaVM<span class="token punctuation">;</span>
	AVFormatContext <span class="token operator">*</span>input_format_ctx<span class="token punctuation">;</span>
	<span class="token keyword">int</span> video_stream_index<span class="token punctuation">;</span>
	<span class="token keyword">int</span> audio_stream_index<span class="token punctuation">;</span>
	AVCodecContext <span class="token operator">*</span>input_codec_ctx<span class="token punctuation">[</span>MAX_STREAM<span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token class-name">pthread_t</span> decode_threads<span class="token punctuation">[</span>MAX_STREAM<span class="token punctuation">]</span><span class="token punctuation">;</span>
	ANativeWindow<span class="token operator">*</span> nativeWindow<span class="token punctuation">;</span>
	SwrContext <span class="token operator">*</span>swr_ctx<span class="token punctuation">;</span>
	<span class="token keyword">enum</span> <span class="token class-name">AVSampleFormat</span> in_sample_fmt<span class="token punctuation">;</span>
	<span class="token keyword">enum</span> <span class="token class-name">AVSampleFormat</span> out_sample_fmt<span class="token punctuation">;</span>
	<span class="token keyword">int</span> in_sample_rate<span class="token punctuation">;</span>
	<span class="token keyword">int</span> out_sample_rate<span class="token punctuation">;</span>
	<span class="token keyword">int</span> out_channel_nb<span class="token punctuation">;</span>
	jobject audio_track<span class="token punctuation">;</span>
	jmethodID audio_track_write_mid<span class="token punctuation">;</span>
<span class="token punctuation">}</span>Player<span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">init_input_format_ctx</span><span class="token punctuation">(</span>Player <span class="token operator">*</span>player<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>input<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token comment">//注册组件</span>
	<span class="token function">av_register_all</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	AVFormatContext <span class="token operator">*</span>format_ctx <span class="token operator">=</span> <span class="token function">avformat_alloc_context</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//打开视频文件</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">avformat_open_input</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>format_ctx<span class="token punctuation">,</span> input<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token function">LOGE</span><span class="token punctuation">(</span><span class="token string">"%s"</span><span class="token punctuation">,</span> <span class="token string">"打开文件失败!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token comment">//获取视频相关信息</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">avformat_find_stream_info</span><span class="token punctuation">(</span>format_ctx<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token function">LOGE</span><span class="token punctuation">(</span><span class="token string">"%s"</span><span class="token punctuation">,</span> <span class="token string">"获取视频信息失败!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token comment">//判断输入流的类型</span>
	<span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> format_ctx<span class="token operator">-&gt;</span>nb_streams<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>format_ctx<span class="token operator">-&gt;</span>streams<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">-&gt;</span>codec<span class="token operator">-&gt;</span>codec_type <span class="token operator">==</span> AVMEDIA_TYPE_VIDEO<span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			player<span class="token operator">-&gt;</span>video_stream_index <span class="token operator">=</span> i<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>format_ctx<span class="token operator">-&gt;</span>streams<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">-&gt;</span>codec<span class="token operator">-&gt;</span>codec_type <span class="token operator">==</span> AVMEDIA_TYPE_AUDIO<span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			player<span class="token operator">-&gt;</span>audio_stream_index <span class="token operator">=</span> i<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>

	player<span class="token operator">-&gt;</span>input_format_ctx <span class="token operator">=</span> format_ctx<span class="token punctuation">;</span>

<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">init_codec_context</span><span class="token punctuation">(</span>Player <span class="token operator">*</span>player<span class="token punctuation">,</span><span class="token keyword">int</span> stream_idx<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
	AVFormatContext <span class="token operator">*</span>format_ctx <span class="token operator">=</span> player<span class="token operator">-&gt;</span>input_format_ctx<span class="token punctuation">;</span>
	<span class="token comment">//获取解码器</span>
	AVCodecContext <span class="token operator">*</span>codec_ctx <span class="token operator">=</span> format_ctx<span class="token operator">-&gt;</span>streams<span class="token punctuation">[</span>stream_idx<span class="token punctuation">]</span><span class="token operator">-&gt;</span>codec<span class="token punctuation">;</span>
	AVCodec <span class="token operator">*</span>codec <span class="token operator">=</span> <span class="token function">avcodec_find_decoder</span><span class="token punctuation">(</span>codec_ctx<span class="token operator">-&gt;</span>codec_id<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>codec <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
		<span class="token function">LOGE</span><span class="token punctuation">(</span><span class="token string">"%s"</span><span class="token punctuation">,</span><span class="token string">"无法解码"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token comment">//打开解码器</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">avcodec_open2</span><span class="token punctuation">(</span>codec_ctx<span class="token punctuation">,</span> codec<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
		<span class="token function">LOGE</span><span class="token punctuation">(</span><span class="token string">"%s"</span><span class="token punctuation">,</span><span class="token string">"解码器无法打开"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	player<span class="token operator">-&gt;</span>input_codec_ctx<span class="token punctuation">[</span>stream_idx<span class="token punctuation">]</span> <span class="token operator">=</span> codec_ctx<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">decode_video_prepare</span><span class="token punctuation">(</span>JNIEnv <span class="token operator">*</span>env<span class="token punctuation">,</span>Player <span class="token operator">*</span>player<span class="token punctuation">,</span>jobject surface<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
	player<span class="token operator">-&gt;</span>nativeWindow <span class="token operator">=</span> <span class="token function">ANativeWindow_fromSurface</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> surface<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">decode_video</span><span class="token punctuation">(</span>Player <span class="token operator">*</span>player<span class="token punctuation">,</span>AVPacket <span class="token operator">*</span>packet<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token comment">//像素数据（解码数据）</span>
	AVFrame <span class="token operator">*</span>yuv_frame <span class="token operator">=</span> <span class="token function">av_frame_alloc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	AVFrame <span class="token operator">*</span>rgb_frame <span class="token operator">=</span> <span class="token function">av_frame_alloc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//绘制时的缓冲区</span>
	ANativeWindow_Buffer outBuffer<span class="token punctuation">;</span>
	AVCodecContext <span class="token operator">*</span>codec_ctx <span class="token operator">=</span> player<span class="token operator">-&gt;</span>input_codec_ctx<span class="token punctuation">[</span>player<span class="token operator">-&gt;</span>video_stream_index<span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> got_frame<span class="token punctuation">;</span>
	<span class="token comment">//解码AVPacket-&gt;AVFrame</span>
	<span class="token function">avcodec_decode_video2</span><span class="token punctuation">(</span>codec_ctx<span class="token punctuation">,</span> yuv_frame<span class="token punctuation">,</span> <span class="token operator">&amp;</span>got_frame<span class="token punctuation">,</span> packet<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//Zero if no frame could be decompressed</span>
	<span class="token comment">//非零，正在解码</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>got_frame<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
		<span class="token comment">//lock</span>
		<span class="token comment">//设置缓冲区的属性（宽、高、像素格式）</span>
		<span class="token function">ANativeWindow_setBuffersGeometry</span><span class="token punctuation">(</span>player<span class="token operator">-&gt;</span>nativeWindow<span class="token punctuation">,</span> codec_ctx<span class="token operator">-&gt;</span>width<span class="token punctuation">,</span> codec_ctx<span class="token operator">-&gt;</span>height<span class="token punctuation">,</span>WINDOW_FORMAT_RGBA_8888<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">ANativeWindow_lock</span><span class="token punctuation">(</span>player<span class="token operator">-&gt;</span>nativeWindow<span class="token punctuation">,</span><span class="token operator">&amp;</span>outBuffer<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment">//设置rgb_frame的属性（像素格式、宽高）和缓冲区</span>
		<span class="token comment">//rgb_frame缓冲区与outBuffer.bits是同一块内存</span>
		<span class="token function">avpicture_fill</span><span class="token punctuation">(</span><span class="token punctuation">(</span>AVPicture <span class="token operator">*</span><span class="token punctuation">)</span>rgb_frame<span class="token punctuation">,</span> outBuffer<span class="token punctuation">.</span>bits<span class="token punctuation">,</span> AV_PIX_FMT_RGBA<span class="token punctuation">,</span> codec_ctx<span class="token operator">-&gt;</span>width<span class="token punctuation">,</span> codec_ctx<span class="token operator">-&gt;</span>height<span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment">//YUV-&gt;RGBA_8888</span>
		<span class="token function">I420ToARGB</span><span class="token punctuation">(</span>yuv_frame<span class="token operator">-&gt;</span>data<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>yuv_frame<span class="token operator">-&gt;</span>linesize<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
				yuv_frame<span class="token operator">-&gt;</span>data<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span>yuv_frame<span class="token operator">-&gt;</span>linesize<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
				yuv_frame<span class="token operator">-&gt;</span>data<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>yuv_frame<span class="token operator">-&gt;</span>linesize<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
				rgb_frame<span class="token operator">-&gt;</span>data<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> rgb_frame<span class="token operator">-&gt;</span>linesize<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
				codec_ctx<span class="token operator">-&gt;</span>width<span class="token punctuation">,</span>codec_ctx<span class="token operator">-&gt;</span>height<span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment">//unlock</span>
		<span class="token function">ANativeWindow_unlockAndPost</span><span class="token punctuation">(</span>player<span class="token operator">-&gt;</span>nativeWindow<span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token function">usleep</span><span class="token punctuation">(</span><span class="token number">1000</span> <span class="token operator">*</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token function">av_frame_free</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>yuv_frame<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">av_frame_free</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>rgb_frame<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">decode_audio_prepare</span><span class="token punctuation">(</span>Player <span class="token operator">*</span>player<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
	SwrContext <span class="token operator">*</span>swr_ctx <span class="token operator">=</span> <span class="token function">swr_alloc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	AVCodecContext <span class="token operator">*</span>codec_ctx <span class="token operator">=</span> player<span class="token operator">-&gt;</span>input_codec_ctx<span class="token punctuation">[</span>player<span class="token operator">-&gt;</span>audio_stream_index<span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token keyword">enum</span> <span class="token class-name">AVSampleFormat</span> in_sample_fmt <span class="token operator">=</span> codec_ctx<span class="token operator">-&gt;</span>sample_fmt<span class="token punctuation">;</span>
	<span class="token keyword">enum</span> <span class="token class-name">AVSampleFormat</span> out_sample_fmt <span class="token operator">=</span> AV_SAMPLE_FMT_S16<span class="token punctuation">;</span>
	<span class="token keyword">int</span> in_sample_rate <span class="token operator">=</span> codec_ctx<span class="token operator">-&gt;</span>sample_rate<span class="token punctuation">;</span>
	<span class="token keyword">int</span> out_sample_rate <span class="token operator">=</span> in_sample_rate<span class="token punctuation">;</span>
	<span class="token class-name">uint64_t</span> in_ch_layout <span class="token operator">=</span> codec_ctx<span class="token operator">-&gt;</span>channel_layout<span class="token punctuation">;</span>
	<span class="token class-name">uint64_t</span> out_ch_layout <span class="token operator">=</span> AV_CH_LAYOUT_STEREO<span class="token punctuation">;</span>
	<span class="token function">swr_alloc_set_opts</span><span class="token punctuation">(</span>swr_ctx<span class="token punctuation">,</span>
			out_ch_layout<span class="token punctuation">,</span> out_sample_fmt<span class="token punctuation">,</span> out_sample_rate<span class="token punctuation">,</span>
			in_ch_layout<span class="token punctuation">,</span> in_sample_fmt<span class="token punctuation">,</span> in_sample_rate<span class="token punctuation">,</span>
			<span class="token number">0</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">swr_init</span><span class="token punctuation">(</span>swr_ctx<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> out_channel_nb <span class="token operator">=</span> <span class="token function">av_get_channel_layout_nb_channels</span><span class="token punctuation">(</span>out_ch_layout<span class="token punctuation">)</span><span class="token punctuation">;</span>

	player<span class="token operator">-&gt;</span>in_sample_fmt <span class="token operator">=</span> in_sample_fmt<span class="token punctuation">;</span>
	player<span class="token operator">-&gt;</span>out_sample_fmt <span class="token operator">=</span> out_sample_fmt<span class="token punctuation">;</span>
	player<span class="token operator">-&gt;</span>in_sample_rate <span class="token operator">=</span> in_sample_rate<span class="token punctuation">;</span>
	player<span class="token operator">-&gt;</span>out_sample_rate <span class="token operator">=</span> out_sample_rate<span class="token punctuation">;</span>
	player<span class="token operator">-&gt;</span>out_channel_nb <span class="token operator">=</span> out_channel_nb<span class="token punctuation">;</span>
	player<span class="token operator">-&gt;</span>swr_ctx <span class="token operator">=</span> swr_ctx<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">jni_audio_prepare</span><span class="token punctuation">(</span>JNIEnv <span class="token operator">*</span>env<span class="token punctuation">,</span> jobject jobj<span class="token punctuation">,</span> Player <span class="token operator">*</span>player<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	jclass player_class <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">GetObjectClass</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> jobj<span class="token punctuation">)</span><span class="token punctuation">;</span>
	jmethodID create_audio_track_mid <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">GetMethodID</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> player_class<span class="token punctuation">,</span> <span class="token string">"createAudioTrack"</span><span class="token punctuation">,</span> <span class="token string">"(II)Landroid/media/AudioTrack;"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	jobject audio_track <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">CallObjectMethod</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> jobj<span class="token punctuation">,</span> create_audio_track_mid<span class="token punctuation">,</span> player<span class="token operator">-&gt;</span>out_sample_rate<span class="token punctuation">,</span> player<span class="token operator">-&gt;</span>out_channel_nb<span class="token punctuation">)</span><span class="token punctuation">;</span>
	jclass audio_track_class <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">GetObjectClass</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> audio_track<span class="token punctuation">)</span><span class="token punctuation">;</span>
	jmethodID audio_track_play_mid <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">GetMethodID</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> audio_track_class<span class="token punctuation">,</span> <span class="token string">"play"</span><span class="token punctuation">,</span> <span class="token string">"()V"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">CallVoidMethod</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> audio_track<span class="token punctuation">,</span> audio_track_play_mid<span class="token punctuation">)</span><span class="token punctuation">;</span>
	jmethodID audio_track_write_mid <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">GetMethodID</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> audio_track_class<span class="token punctuation">,</span> <span class="token string">"write"</span><span class="token punctuation">,</span> <span class="token string">"([BII)I"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	player<span class="token operator">-&gt;</span>audio_track <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">NewGlobalRef</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> audio_track<span class="token punctuation">)</span><span class="token punctuation">;</span>
	player<span class="token operator">-&gt;</span>audio_track_write_mid <span class="token operator">=</span> audio_track_write_mid<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">decode_audio</span><span class="token punctuation">(</span>Player <span class="token operator">*</span>player<span class="token punctuation">,</span> AVPacket <span class="token operator">*</span>packet<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	JNIEnv <span class="token operator">*</span>env <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	JavaVM <span class="token operator">*</span>javaVM <span class="token operator">=</span> player<span class="token operator">-&gt;</span>javaVM<span class="token punctuation">;</span>
	<span class="token punctuation">(</span><span class="token operator">*</span>javaVM<span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">AttachCurrentThread</span><span class="token punctuation">(</span>javaVM<span class="token punctuation">,</span> <span class="token operator">&amp;</span>env<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token class-name">uint8_t</span> <span class="token operator">*</span>out_buffer <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">uint8_t</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">av_malloc</span><span class="token punctuation">(</span>MAX_AUDIO_FRME_SIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
	AVCodecContext <span class="token operator">*</span>codec_ctx <span class="token operator">=</span> player<span class="token operator">-&gt;</span>input_codec_ctx<span class="token punctuation">[</span>player<span class="token operator">-&gt;</span>audio_stream_index<span class="token punctuation">]</span><span class="token punctuation">;</span>
	AVFrame <span class="token operator">*</span>frame <span class="token operator">=</span> <span class="token function">av_frame_alloc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> got_frame <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token function">avcodec_decode_audio4</span><span class="token punctuation">(</span>codec_ctx<span class="token punctuation">,</span> frame<span class="token punctuation">,</span> <span class="token operator">&amp;</span>got_frame<span class="token punctuation">,</span> packet<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>got_frame<span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token function">swr_convert</span><span class="token punctuation">(</span>player<span class="token operator">-&gt;</span>swr_ctx<span class="token punctuation">,</span> <span class="token operator">&amp;</span>out_buffer<span class="token punctuation">,</span> MAX_AUDIO_FRME_SIZE<span class="token punctuation">,</span>
				<span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token class-name">uint8_t</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">)</span>frame<span class="token operator">-&gt;</span>data<span class="token punctuation">,</span> frame<span class="token operator">-&gt;</span>nb_samples<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">int</span> out_buffer_size <span class="token operator">=</span> <span class="token function">av_samples_get_buffer_size</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> player<span class="token operator">-&gt;</span>out_channel_nb<span class="token punctuation">,</span>
				frame<span class="token operator">-&gt;</span>nb_samples <span class="token punctuation">,</span>player<span class="token operator">-&gt;</span>out_sample_fmt<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		jbyteArray audio_sample_array <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">NewByteArray</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> out_buffer_size<span class="token punctuation">)</span><span class="token punctuation">;</span>
		jbyte <span class="token operator">*</span>sample_byte <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">GetByteArrayElements</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> audio_sample_array<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">memcpy</span><span class="token punctuation">(</span>sample_byte<span class="token punctuation">,</span> out_buffer<span class="token punctuation">,</span> out_buffer_size<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">ReleaseByteArrayElements</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> audio_sample_array<span class="token punctuation">,</span> sample_byte<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">CallIntMethod</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> player<span class="token operator">-&gt;</span>audio_track<span class="token punctuation">,</span> player<span class="token operator">-&gt;</span>audio_track_write_mid<span class="token punctuation">,</span>
				audio_sample_array<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> out_buffer_size<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">DeleteLocalRef</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span>audio_sample_array<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">(</span><span class="token operator">*</span>javaVM<span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">DetachCurrentThread</span><span class="token punctuation">(</span>javaVM<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">usleep</span><span class="token punctuation">(</span><span class="token number">16</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token function">av_frame_free</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>frame<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span><span class="token operator">*</span> <span class="token function">decode_data</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span> arg<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
	Player <span class="token operator">*</span>player <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">Player</span><span class="token operator">*</span><span class="token punctuation">)</span>arg<span class="token punctuation">;</span>
	AVFormatContext <span class="token operator">*</span>format_ctx <span class="token operator">=</span> player<span class="token operator">-&gt;</span>input_format_ctx<span class="token punctuation">;</span>
	<span class="token comment">//编码数据</span>
	AVPacket <span class="token operator">*</span>packet <span class="token operator">=</span> <span class="token punctuation">(</span>AVPacket <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">av_malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>AVPacket<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//6.一阵一阵读取压缩的视频数据AVPacket</span>
	<span class="token keyword">int</span> video_frame_count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token function">av_read_frame</span><span class="token punctuation">(</span>format_ctx<span class="token punctuation">,</span>packet<span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>packet<span class="token operator">-&gt;</span>stream_index <span class="token operator">==</span> player<span class="token operator">-&gt;</span>video_stream_index<span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			<span class="token comment">//decode_video(player,packet);</span>
		<span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>packet<span class="token operator">-&gt;</span>stream_index <span class="token operator">==</span> player<span class="token operator">-&gt;</span>audio_stream_index<span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			<span class="token function">decode_audio</span><span class="token punctuation">(</span>player<span class="token punctuation">,</span>packet<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token function">av_free_packet</span><span class="token punctuation">(</span>packet<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

JNIEXPORT <span class="token keyword">void</span> JNICALL <span class="token function">Java_com_cj5785_ffmpegvideothread_VideoPlayer_play</span>
  <span class="token punctuation">(</span>JNIEnv <span class="token operator">*</span>env<span class="token punctuation">,</span> jobject jobj<span class="token punctuation">,</span> jstring jstr_path<span class="token punctuation">,</span> jobject obj_surface<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token function">LOGE</span><span class="token punctuation">(</span><span class="token string">"%s"</span><span class="token punctuation">,</span> <span class="token string">"开始"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>input_cstr <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">GetStringUTFChars</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> jstr_path<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	Player <span class="token operator">*</span>player <span class="token operator">=</span> <span class="token punctuation">(</span>Player <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">calloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>Player<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">GetJavaVM</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span><span class="token operator">&amp;</span><span class="token punctuation">(</span>player<span class="token operator">-&gt;</span>javaVM<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">//初始化封装格式上下文</span>
	<span class="token function">init_input_format_ctx</span><span class="token punctuation">(</span>player<span class="token punctuation">,</span>input_cstr<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> video_stream_index <span class="token operator">=</span> player<span class="token operator">-&gt;</span>video_stream_index<span class="token punctuation">;</span>
	<span class="token keyword">int</span> audio_stream_index <span class="token operator">=</span> player<span class="token operator">-&gt;</span>audio_stream_index<span class="token punctuation">;</span>
	<span class="token comment">//获取音视频解码器，并打开</span>
	<span class="token function">init_codec_context</span><span class="token punctuation">(</span>player<span class="token punctuation">,</span>video_stream_index<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">init_codec_context</span><span class="token punctuation">(</span>player<span class="token punctuation">,</span>audio_stream_index<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">decode_video_prepare</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> player<span class="token punctuation">,</span> obj_surface<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">decode_audio_prepare</span><span class="token punctuation">(</span>player<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">jni_audio_prepare</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span>jobj<span class="token punctuation">,</span>player<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">//创建子线程解码</span>
	<span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token punctuation">(</span>player<span class="token operator">-&gt;</span>decode_threads<span class="token punctuation">[</span>video_stream_index<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span>decode_data<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span>player<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token punctuation">(</span>player<span class="token operator">-&gt;</span>decode_threads<span class="token punctuation">[</span>audio_stream_index<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span>decode_data<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span>player<span class="token punctuation">)</span><span class="token punctuation">;</span>


	<span class="token comment">/*ANativeWindow_release(nativeWindow);
	av_frame_free(&amp;yuv_frame);
	avcodec_close(pCodeCtx);
	avformat_free_context(pFormatCtx);

	(*env)-&gt;ReleaseStringUTFChars(env,input_jstr,input_cstr);

	free(player);*/</span>

<span class="token punctuation">}</span>
</code></pre>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="687474:70733a2f2f626c6f672e6373646e2e6e65742f636a35373835:2f61727469636c652f64657461696c732f3839303439313230" class_="artid" style="display:none">
 </p>
</div>


