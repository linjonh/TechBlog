---
layout: post
title: "超简单的CAN通信原理讲解一"
date: 2024-03-05 21:48:58 +0800
description: "参考文件，可以在瑞萨官网下载到，讲的很细，想深究CAN协议的可以去好好研究。CAN协议是 Contr"
keywords: "can协议 mcu"
categories: ['单片机相关']
tags: ['车载系统', '硬件工程', '汽车', '嵌入式硬件', 'Stm', 'Mcu', 'C']
artid: "136461673"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=136461673
    alt: "超简单的CAN通信原理讲解一"
render_with_liquid: false
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     超简单的CAN通信原理讲解（一）
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-tomorrow-night" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <h2>
     <a id="MCU_0">
     </a>
     MCU常用协议讲解
    </h2>
    <h3>
     <a id="CAN_1">
     </a>
     超简单的CAN通信原理讲解（一）
    </h3>
    <p>
    </p>
    <div class="toc">
     <h4>
      文章目录
     </h4>
     <ul>
      <li>
       <a href="#MCU_0" rel="nofollow">
        MCU常用协议讲解
       </a>
      </li>
      <li>
       <ul>
        <li>
         <a href="#CAN_1" rel="nofollow">
          超简单的CAN通信原理讲解（一）
         </a>
        </li>
       </ul>
      </li>
      <li>
       <a href="#_9" rel="nofollow">
        前言
       </a>
      </li>
      <li>
       <a href="#CAN_16" rel="nofollow">
        一、CAN协议是什么？
       </a>
      </li>
      <li>
       <a href="#CAN_24" rel="nofollow">
        二、CAN协议使用场景
       </a>
      </li>
      <li>
       <a href="#CAN_29" rel="nofollow">
        三、CAN网络拓扑图
       </a>
      </li>
      <li>
       <a href="#CAN_39" rel="nofollow">
        四、CAN网络硬件接线图
       </a>
      </li>
      <li>
       <a href="#_55" rel="nofollow">
        五、协议分析
       </a>
      </li>
      <li>
       <ul>
        <li>
         <a href="#1CAN_56" rel="nofollow">
          1.CAN协议帧的种类
         </a>
        </li>
        <li>
         <a href="#2CAN_67" rel="nofollow">
          2.CAN协议数据帧
         </a>
        </li>
        <li>
         <a href="#3CAN_86" rel="nofollow">
          3.CAN协议的波特率计算
         </a>
        </li>
       </ul>
      </li>
      <li>
       <a href="#_109" rel="nofollow">
        总结
       </a>
      </li>
     </ul>
    </div>
    <p>
    </p>
    <hr/>
    <h2>
     <a id="_9">
     </a>
     前言
    </h2>
    <p>
     <strong>
      参考文件
     </strong>
     ：
     <br/>
     <strong>
      &lt;瑞萨电子can入门教程&gt;
     </strong>
     ，可以在瑞萨官网下载到，讲的很细，想深究CAN协议的可以去好好研究。
    </p>
    <p>
     🤦‍♂️想看完协议写出CAN的代码还是很难的，很多具体的操作需要结合CAN控制器去说明，CAN的协议文档我看了10多遍但是让我写出CAN的
     <br/>
     通信代码我觉得还是很困难，只能做到给我一份CAN的代码我理解他的意思。所以我分两篇去讲解CAN协议，第一篇根据
     <mark>
      CAN手册
     </mark>
     去分析CAN协议具体的规范和格式，第二篇结合具体
     <mark>
      CAN控制器
     </mark>
     和CAN收发器去跟着理解CAN代码，笔者是一个理解能力一般的人😒，所以我会写文档一般都会很细致，如果别人看了我的文档能理解CAN写出CAN代码说明我才真正掌握CAN了🤣。
    </p>
    <h2>
     <a id="CAN_16">
     </a>
     一、CAN协议是什么？
    </h2>
    <p>
     CAN协议是 Controller Area Network的缩写，全称控制器局域网络，是 ISO 国际标准化的串行通信协议。由德国电气商博世公司提出，并
     <br/>
     通过了
     <mark>
      ISO11898
     </mark>
     和
     <mark>
      ISO11519
     </mark>
     进行了标准化，所以CAN协议也就有了两种执行标准，两种数据定义。
     <br/>
     所以ISO11898也叫高速CAN（经典CAN），ISO 11519-2也叫容错CAN，高速很好理解，容错的话见后面，
     <mark>
      汽车上常用的是高速CAN
     </mark>
     <br/>
     下面放出两种协议对比，显性隐性不需要强记，知道总线电平等于他们的电位差(CAN_HIGH-CAN_LOW)即可
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/16d664b148052de03eb1926089f2dbf3.png"/>
    </p>
    <h2>
     <a id="CAN_24">
     </a>
     二、CAN协议使用场景
    </h2>
    <p>
     CAN协议最广泛的使用场景，就在于汽车领域了，基本现在所有的汽车电子控制都是使用CAN协议的，CAN最早提出也是为了解决汽车领域复杂电子期间之间的通信，同时兼顾可靠性。下面放一个老图，汽车CAN网络勾想
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/c25207e7ee9218df6378d53db9c5de22.png"/>
    </p>
    <hr/>
    <h2>
     <a id="CAN_29">
     </a>
     三、CAN网络拓扑图
    </h2>
    <p>
     CAN网络中的控制器和收发器是两种不同的东西，CAN控制器不直接连接CAN网络，CAN网络上的电平分为
     <mark>
      显式
     </mark>
     和
     <mark>
      隐式
     </mark>
     两种，
     <br/>
     CAN协议使用差分信号进行通信，两根线分别为CAN_L和CAN_H
     <br/>
     控制器：与MCU连接
     <br/>
     收发器：把TTL电平转成CAN信号，或者把CAN信号转成TTL电平
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/c409473b126e6b01702a0223027dce6e.png"/>
    </p>
    <h2>
     <a id="CAN_39">
     </a>
     四、CAN网络硬件接线图
    </h2>
    <p>
     两种协议下的CAN硬件电路连接也不同，可以通过末端电阻来判断是哪种连接方式，第一种在网络末端并联两个120Ω的电阻(有点像485通信)，第二种在CAN_L和CAN_H分别串联两个2.2k的电阻，也可以通过这种方式来区分出是使用什么协议。
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/ef3903a3bb3d3b04023c47f02da02349.png"/>
    </p>
    <p>
     显性和隐性（这里注意黄色字体和认知中的显性对应1有点区别）
     <br/>
     以常用高速CAN ISO11898说明：只需要记住典型值即可
    </p>
    <ol>
     <li>
      典型电平是CAN_L = CAN_LOW = 2.5V
     </li>
     <li>
      典型显性CAN_H -CAN_L = 0V
      <mark>
       --------------------》输出逻辑0
      </mark>
     </li>
     <li>
      典型隐性CAN_H(3.5V) -CAN_L(1.5V) = 2V
      <mark>
       --------------------》输出逻辑1
      </mark>
     </li>
    </ol>
    <table>
     <thead>
      <tr>
       <th align="center">
        CAN_HIGH
       </th>
       <th align="center">
        CAN_LOW
       </th>
       <th align="center">
        CAN_HIGH - CAN_LOW
       </th>
       <th align="center">
        显隐性
       </th>
       <th align="center">
        逻辑电平(CAN收发器上TXD或者RXD上电平)
       </th>
      </tr>
     </thead>
     <tbody>
      <tr>
       <td align="center">
        2.5V
       </td>
       <td align="center">
        2.5V
       </td>
       <td align="center">
        0V
       </td>
       <td align="center">
        显性
       </td>
       <td align="center">
        0
       </td>
      </tr>
      <tr>
       <td align="center">
        3.5V
       </td>
       <td align="center">
        1.5V
       </td>
       <td align="center">
        2V
       </td>
       <td align="center">
        隐性
       </td>
       <td align="center">
        1
       </td>
      </tr>
     </tbody>
    </table>
    <p>
     <code>
      隐性代表无数据，显性代表有数据。总线上执行逻辑上的线“与”时，显性电平的逻辑值为“0”，隐性电平为“1”
     </code>
    </p>
    <h2>
     <a id="_55">
     </a>
     五、协议分析
    </h2>
    <h3>
     <a id="1CAN_56">
     </a>
     1.CAN协议帧的种类
    </h3>
    <p>
     • 数据帧
     <br/>
     • 遥控帧
     <br/>
     • 错误帧
     <br/>
     • 过载帧
     <br/>
     • 帧间隔
    </p>
    <p>
     CAN协议分为这五种帧，就快速使用来说，我们需要关注数据帧即可。
     <br/>
     为什么只关注数据帧，因为数据帧是控制器组包去主动发送的，而类似错误帧之类的是总线单元主动发出的，例如标准的UART协议实际上是10bit（1个起始位，7个数据位，1个校验位，1个结束位），但是我们串口实际上只组包了7bit的数据，校验终止都是UART单元去组包的，
     <br/>
     这里同理。我们控制器组包需要对
     <mark>
      数据帧
     </mark>
     组包，错误帧遥控帧等其他帧等明白了数据帧组包CAN总线也理解差不多了，可以去看协议文档学习。
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/7637c6e1834587b03612b9924e4c80c1.png"/>
    </p>
    <h3>
     <a id="2CAN_67">
     </a>
     2.CAN协议数据帧
    </h3>
    <p>
     数据帧由 7 个段构成。
     <br/>
     (1) 帧起始
     <br/>
     表示数据帧开始的段。
     <mark>
      1bit低电平(显性)
     </mark>
     <br/>
     (2) 仲裁段
     <br/>
     表示该帧优先级的段。
     <mark>
      11bit或者29bit的ID，29bit为扩展格式，大部分都是11bit标准格式
     </mark>
     <br/>
     (3) 控制段
     <br/>
     表示数据的字节数及保留位的段。
     <mark>
      6bit表示数据的长度(可设置为0-8字节)
     </mark>
     <br/>
     (4) 数据段
     <br/>
     数据的内容，可发送 0～8 个字节的数据。
     <mark>
      最大8byte
     </mark>
     <br/>
     (5) CRC 段
     <br/>
     检查帧的传输错误的段。
     <mark>
      16bit(15bit的CRC和1bit的分隔符)
     </mark>
     <br/>
     (6) ACK 段
     <br/>
     表示确认正常接收的段。
     <mark>
      2bit(ACK槽+ACK界定符)
     </mark>
     <br/>
     (7) 帧结束
     <br/>
     表示数据帧结束的段。
     <mark>
      7bit高电平(隐性位)
     </mark>
    </p>
    <p>
     数据帧格式如下:其中标准模式为常用模式，遵循ISO11898协议
     <br/>
     <img alt="数据帧说明" src="https://i-blog.csdnimg.cn/blog_migrate/e997e160ea13c4db70167d0d69a67f52.png"/>
    </p>
    <h3>
     <a id="3CAN_86">
     </a>
     3.CAN协议的波特率计算
    </h3>
    <p>
     CAN协议是差分信号传输，不像I2C和SPI有单独的时钟总线，那么如何决定传输速率，如何判定1us内传输的是1bit还是1byte呢?
    </p>
    <p>
     <strong>
      位时序
     </strong>
     <br/>
     由发送单元在非同步的情况下每秒钟发送的位数称为位速率。一个位分为四段
     <br/>
     <strong>
      tq
     </strong>
     <br/>
     全程time Quantun,是最小时间单位，类似于I2C同步时钟里面的一个最小方波，
     <mark>
      tq = 1 / 波特率
     </mark>
     ，每个段由不同数目的tq组成
    </p>
    <p>
     • 同步段（SS）
     <br/>
     • 传播时间段（PTS）
     <br/>
     • 相位缓冲段 1（PBS1）
     <br/>
     • 相位缓冲段 2（PBS2)
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/0e9589d7a917ee1f3c840a494342f86f.png"/>
    </p>
    <p>
     波特率=时钟频率 / （分频系数 + 1）/ （时间段1+时间段2+同步跳转长度）
     <br/>
     <mark>
      bps = Fpclk1/ ((tbs1+1+tbs2+1+1)*brp)
     </mark>
    </p>
    <p>
     可以使用下面CAN波特率计算网站快速计算波特率
     <br/>
     <a href="http://www.bittiming.can-wiki.info/?CLK=8&amp;ctype=Philips&amp;calc=1" rel="nofollow">
      can波特率计算网站
     </a>
    </p>
    <hr/>
    <h2>
     <a id="_109">
     </a>
     总结
    </h2>
    <p>
     下一篇会结合STM32的CAN控制器去逐步分析代码。。。
    </p>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f62:6c6f672e6373646e2e6e65742f71715f33393634323734302f:61727469636c652f64657461696c732f313336343631363733" class_="artid" style="display:none">
 </p>
</div>


