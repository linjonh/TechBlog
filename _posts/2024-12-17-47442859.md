---
layout: post
title: "关系型数据库表结构的两个设计技巧"
date: 2024-12-17 08:00:00 +0800
description: "设计关系型数据库的表时，需要给表添加一个ID字段（自增字段，或者uuid字段）和一个version字"
keywords: "数据库(表结构)设计技巧及注意事项"
categories: ['编程原理', 'Python', 'Oop', 'Java']
tags: ['无标签']
artid: "47442859"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=47442859
    alt: "关系型数据库表结构的两个设计技巧"
render_with_liquid: false
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     关系型数据库表结构的两个设计技巧
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="htmledit_views" id="content_views">
    <p>
     <span style="font-family:Times New Roman,serif">
      By
     </span>
     良少
     <span style="font-family:Times New Roman,serif">
     </span>
     <span style="font-family:Times New Roman,serif">
      <span style="color:#000080">
       <span lang="zxx">
        <u>
         <a href="http://blog.csdn.net/shendl" rel="noopener noreferrer" target="_blank">
          http://blog.csdn.net/shendl
         </a>
        </u>
       </span>
      </span>
     </span>
     <br/>
    </p>
    <p>
     关系型数据库表结构的设计，有下面两个设计技巧：
    </p>
    <p>
     <br/>
    </p>
    <h2>
     物理主键作为关联的外键
    </h2>
    关系型数据库，由多个数据表构成。每一个数据表的结构是相同的，不同表之间可能存在关联关系。表之间的关联关系，正是关系型数据库得名的原因。
    <br/>
    一个表由多个字段构成。其中可能有多个字段适合作为主键。主键字段，就是表中每一行都不会有重复数据的字段。
    <br/>
    主键，可以分为两种：物理主键和逻辑主键。
    <br/>
    每一张数据库的表，都使用自增长的id字段作为物理主键。
    <br/>
    多表之间的外键关联，都关联其他表的物理主键，也就是关联其他表的id字段。
    <br/>
    <p>
     逻辑主键，就是除了id字段外的不重复的字段。我们设计数据库的外键关联时，不使用逻辑主键，而是使用物理主键。
    </p>
    <p>
     <br/>
    </p>
    <p>
     这是因为，物理主键肯定是主键，因为它是自增的。（对于不支持自增字段的关系数据库，可以使用uuid保证物理主键的唯一性）
    </p>
    <p>
     <br/>
    </p>
    而逻辑主键，则可能随着业务的发展，成为可重复的字段。一旦这种情况发生，关系数据库的外键关系就被破坏了。如，可能你觉得姓名是逻辑主键，但可能后面发现有人重名，那么这个字段就不再是主键了。而如果之前使用这个字段作为外键，那么查询返回的数据就不是一一对应的了。
    <br/>
    这就是为什么要使用物理主键，以及用物理主键作为关联外键的原因。
    <br/>
    <br/>
    <br/>
    <h3>
     使用乐观锁更新依赖之前状态的记录
    </h3>
    考虑这样一种数据库的应用场景：
    <br/>
    任务单的接管：多个操作人员从一个任务池中接管一个任务。只有第一个获取任务的操作人员才能成功接管该任务，后续操作人员的接管操作都必须失败。
    <br/>
    这时，就需要一种数据库记录的锁定机制。只有第一个事务才能更新记录。
    <br/>
    <br/>
    数据库可以使用悲观锁和乐观锁来锁定数据库记录。
    <br/>
    悲观锁是如下sql语句实现的：
    <br/>
    SELECT * FROM t FOR UPDATE
    <br/>
    这条语句会在其他修改内容的事务提交后返回最新的数据。
    <br/>
    一旦执行这条语句，这些记录就被锁住了，不能被其他sql事务修改。直到本事务提交。
    <br/>
    <br/>
    <br/>
    乐观锁，是应用程序实现的，不是数据库实现的机制。乐观锁，对于数据库来说，就是没有上锁。事务可以select其他事务已经提交的数据。更新数据时，数据库保证多个事务的更新是原子的。
    <br/>
    <br/>
    悲观锁，会导致事务等待其他事务完成。乐观锁，只会等待其他事务的更新语句的完成，不会等待整个事务完成，因此效率较高。
    <br/>
    <br/>
    实现乐观锁的方法：
    <br/>
    给数据库表添加一个version字段。version是一个数字类型的字段，每次更新都加1。每次更新时都要检测version字段是否和当前事务的值相同。如果version字段不同，那么就表明在查询数据之后，有其他事务已经更新了该记录，就会导致此次更新失败。应用必须重新载入最新的数据，然后重新更新数据。
    <br/>
    <br/>
    <br/>
    如果使用乐观锁，那么如果数据库中version和应用中version相同，则用version+1的版本值更新version字段。
    <br/>
    SQL语句如下：
    <br/>
    update studentVersion set ver=?, name=? where id=? and ver=?
    <br/>
    <br/>
    <h4>
     不使用锁更新独立状态的记录
     <br/>
    </h4>
    <p>
     <br/>
     考虑这样一种数据库的应用场景：
     <br/>
     需要更新虚拟机的状态。多个事务可能会同时更新虚拟机的状态为start或者stop。这种状态的更新和前一个阶段的状态是无关的，因此不需要锁定记录。直接更新即可。此时不需要使用悲观锁或者乐观锁。
     <br/>
     <br/>
     如果这个表添加了version字段，直接忽略对version字段的比较和更新即可。
     <br/>
     SQL语句如下：
     <br/>
     update studentVersion set   name=? where id=?
     <br/>
    </p>
    <h4>
     <br/>
    </h4>
    <br/>
    <h2>
     总结
    </h2>
    <p>
    </p>
    <p>
     设计关系型数据库的表时，需要给表添加一个ID字段（自增字段，或者uuid字段）和一个version字段（数值类型）。ID字段作为物理主键，用于保证记录的不可重复性和用作外键关联。
    </p>
    <p>
     version字段用于实现乐观锁，提供比悲观锁更好的性能。特别是对于UI显示并可能出现并发更新的数据，更需要使用乐观锁来提升数据库访问性能。
    </p>
    <p>
     对于后台自动更新的任务，可以使用乐观锁实现。但需要在冲突发生时实现自动退让。也可以使用悲观锁在数据库上对事务进行排队来解决更新冲突问题。
    </p>
    <p>
     对于不关心记录的状态之间关系的场景，可以直接更新记录，忽略掉version字段的检测和更新。
    </p>
    <p>
     <br/>
    </p>
    <p>
     <br/>
    </p>
    <p>
     <br/>
    </p>
    <h4>
     <br/>
    </h4>
    <br/>
   </div>
  </div>
 </article>
 <p alt="687474:70733a2f2f626c6f672e6373646e2e6e65742f7368656e646c:2f61727469636c652f64657461696c732f3437343432383539" class_="artid" style="display:none">
 </p>
</div>


