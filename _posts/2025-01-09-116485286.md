---
layout: post
title: "动态路由前端后端-控制"
date: 2025-01-09 16:13:12 +0800
description: "动态路由后台管理系统，大部分都会涉及到权限控制这一项需求，即：根据不同登录角色渲染不同页面功能现在主"
keywords: "前端动态路由"
categories: ['Vue']
tags: ['后端路由', '前端路由', 'Vue']
artid: "116485286"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=116485286
    alt: "动态路由前端后端-控制"
render_with_liquid: false
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     动态路由（前端/后端 控制）
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <h3>
     <a id="_1">
     </a>
     动态路由
    </h3>
    <p>
     后台管理系统，大部分都会涉及到权限控制这一项需求，即：根据不同登录角色渲染不同页面功能
    </p>
    <p>
     现在主流有两种方式：
    </p>
    <ol>
     <li>
      <p>
       前端控制
      </p>
      <p>
       逻辑简单，上手快
      </p>
     </li>
     <li>
      <p>
       后端控制
      </p>
      <p>
       相对安全，需要后期改动
      </p>
     </li>
    </ol>
    <h3>
     <a id="_15">
     </a>
     后端控制
    </h3>
    <p>
     后端路由时大部分后台管理项目的解决方案
    </p>
    <p>
     核心：用户登录以后，后端根据该角色生成可访问的路由数据，前端根据这个路由数据转换成自己需要的路由结构
    </p>
    <p>
     具体代码结构：
    </p>
    <ol>
     <li>
      <p>
       router 文件中，只放一些静态路由和公共路由
      </p>
      <p>
       代码参考：
       <a href="https://github.com/PanJiaChen/vue-element-admin/blob/master/src/router/index.js">
        https://github.com/PanJiaChen/vue-element-admin/blob/master/src/router/index.js
       </a>
      </p>
     </li>
     <li>
      <p>
       在 vuex 中写一个 state，把路由和获取到的角色进行匹配，控制菜单栏的显示隐藏
      </p>
      <pre><code class="prism language-js"><span class="token keyword">import</span> <span class="token punctuation">{<!-- --></span> constantRoutes <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@/router'</span>
<span class="token keyword">import</span> <span class="token punctuation">{<!-- --></span> getRoutes <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@/api/menu'</span>
<span class="token keyword">import</span> Layout <span class="token keyword">from</span> <span class="token string">'@/layout/index'</span>

<span class="token comment">// 遍历后台传来的路由字符串，转换为组件对象</span>
<span class="token keyword">function</span> <span class="token function">filterAsyncRoutes</span><span class="token punctuation">(</span><span class="token parameter">asyncRouterMap</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">return</span> asyncRouterMap<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token parameter">route</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>route<span class="token punctuation">.</span>component<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">// Layout组件特殊处理</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>route<span class="token punctuation">.</span>component <span class="token operator">===</span> <span class="token string">'Layout'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        route<span class="token punctuation">.</span>component <span class="token operator">=</span> Layout
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        route<span class="token punctuation">.</span>component <span class="token operator">=</span> <span class="token function">loadView</span><span class="token punctuation">(</span>route<span class="token punctuation">.</span>component<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>route<span class="token punctuation">.</span>children <span class="token operator">&amp;&amp;</span> route<span class="token punctuation">.</span>children<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      route<span class="token punctuation">.</span>children <span class="token operator">=</span> <span class="token function">filterAsyncRoutes</span><span class="token punctuation">(</span>route<span class="token punctuation">.</span>children<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">loadView</span><span class="token punctuation">(</span><span class="token parameter">view</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token comment">// 注意：webpack4动态import不支持变量方式，如下写法是不行的</span>
  <span class="token comment">// return () =&gt; import(`@/views/${view}`)</span>
  <span class="token keyword">return</span> <span class="token parameter">resolve</span> <span class="token operator">=&gt;</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">@/views/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span>view<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">]</span><span class="token punctuation">,</span> resolve<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> permission <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
  state<span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    routes<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    addRoutes<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  mutations<span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function-variable function">SET_ROUTES</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">state<span class="token punctuation">,</span> routes</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
      state<span class="token punctuation">.</span>addRoutes <span class="token operator">=</span> routes
      state<span class="token punctuation">.</span>routes <span class="token operator">=</span> constantRoutes<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>routes<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  actions<span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">GenerateRoutes</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{<!-- --></span> commit <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">const</span> Id <span class="token operator">=</span> sessionStorage<span class="token punctuation">.</span><span class="token function">getItem</span><span class="token punctuation">(</span><span class="token string">'SESSION_KEY'</span><span class="token punctuation">)</span>
      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token parameter">resolve</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">getRoutes</span><span class="token punctuation">(</span>Id<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
          <span class="token keyword">const</span> accessedRoutes <span class="token operator">=</span> <span class="token function">filterAsyncRoutes</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>data<span class="token punctuation">)</span>
          accessedRoutes<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span> path<span class="token operator">:</span> <span class="token string">'*'</span><span class="token punctuation">,</span> redirect<span class="token operator">:</span> <span class="token string">'/404'</span><span class="token punctuation">,</span> hidden<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
          <span class="token function">commit</span><span class="token punctuation">(</span><span class="token string">'SET_ROUTES'</span><span class="token punctuation">,</span> accessedRoutes<span class="token punctuation">)</span>
          <span class="token function">resolve</span><span class="token punctuation">(</span>accessedRoutes<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre>
     </li>
     <li>
      <p>
       给后端整理一份前端需要的 router 数据结构
      </p>
      <p>
       一般必须有的参数：id、path、name、title、children
      </p>
      <pre><code class="prism language-bash">path: <span class="token comment"># 路由地址</span>
name: <span class="token comment"># 路由名称</span>
id: <span class="token comment"># id</span>
component: <span class="token comment"># 组件路径</span>
meta-<span class="token operator">&gt;</span>title: <span class="token comment"># 菜单名称(和path同级就可以)</span>
meta-<span class="token operator">&gt;</span>icon: <span class="token comment"># 菜单图标(和path同级就可以)</span>
meta-<span class="token operator">&gt;</span>type: <span class="token comment"># 菜单类型，用于区分模块、目录、菜单、按钮</span>
meta-<span class="token operator">&gt;</span>hidden: <span class="token comment"># 是否全局隐藏此菜单</span>
children: <span class="token comment"># 子集集合</span>
</code></pre>
      <p>
       如果后端传的不是 children，是 parentId 那种类型，则需要写一个转换方法
      </p>
      <p>
       方法可以参考这篇文章：
       <a href="https://blog.csdn.net/qq_38689395/article/details/116019842?spm=1001.2014.3001.5501">
        Vue 封装无限层级树形菜单组件（后台传的是扁平数组）
       </a>
      </p>
     </li>
     <li>
      <p>
       在导航守卫中，使用
       <code>
        router.beforeEach
       </code>
       进行拦截，可以动态添加可访问的路由表（使用 addRoutes 添加）
      </p>
      <pre><code class="prism language-js"><span class="token keyword">import</span> NProgress <span class="token keyword">from</span> <span class="token string">'nprogress'</span>
<span class="token keyword">import</span> <span class="token string">'nprogress/nprogress.css'</span>

NProgress<span class="token punctuation">.</span><span class="token function">configure</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span> showSpinner<span class="token operator">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> whiteList <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'/login'</span><span class="token punctuation">,</span> <span class="token string">'/auth-redirect'</span><span class="token punctuation">,</span> <span class="token string">'/bind'</span><span class="token punctuation">,</span> <span class="token string">'/register'</span><span class="token punctuation">]</span>

router<span class="token punctuation">.</span><span class="token function">beforeEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">to<span class="token punctuation">,</span> <span class="token keyword">from</span><span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
  NProgress<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token comment">// 判断是否有token</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>store<span class="token punctuation">.</span>getters<span class="token punctuation">.</span>token<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>to<span class="token punctuation">.</span>path <span class="token operator">===</span> <span class="token string">'/login'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span> path<span class="token operator">:</span> <span class="token string">'/'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">// 判断当前用户是否已拉取完user_info信息</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>store<span class="token punctuation">.</span>getters<span class="token punctuation">.</span>roles<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 获取info信息</span>
        store<span class="token punctuation">.</span><span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token string">'GetInfo'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
          <span class="token keyword">const</span> roles <span class="token operator">=</span> res<span class="token punctuation">.</span>roles
          store
            <span class="token punctuation">.</span><span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token string">'GenerateRoutes'</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span> roles <span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">accessRoutes</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
              <span class="token comment">// 动态添加可访问路由表</span>
              router<span class="token punctuation">.</span><span class="token function">addRoutes</span><span class="token punctuation">(</span>accessRoutes<span class="token punctuation">)</span>
              <span class="token comment">// hack方法 确保addRoutes已完成</span>
              <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span> <span class="token operator">...</span>to<span class="token punctuation">,</span> replace<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token parameter">err</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
              console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 当有用户权限的时候，说明可访问路由表已生成</span>
        <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>whiteList<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>to<span class="token punctuation">.</span>path<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">// 在免登录白名单，直接进入</span>
      <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">// 否则全部重定向到登录页</span>
      <span class="token function">next</span><span class="token punctuation">(</span><span class="token string">'/login'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre>
     </li>
     <li>
      <p>
       从 router 中取出可用的路由对象，来进行侧边栏的渲染
      </p>
     </li>
    </ol>
    <p>
     也可以参考这篇文章：
     <a href="https://blog.csdn.net/weixin_46923775/article/details/108366807?utm_medium=distribute.pc_relevant.none-task-blog-2%7Edefault%7EBlogCommendFromBaidu%7Edefault-18.control&amp;dist_request_id=1619664910213_44556&amp;depth_1-utm_source=distribute.pc_relevant.none-task-blog-2%7Edefault%7EBlogCommendFromBaidu%7Edefault-18.control">
      后端控制路由
     </a>
    </p>
    <h3>
     <a id="_158">
     </a>
     前端控制
    </h3>
    <p>
     可以参考花裤衩的文章，
     <a href="https://segmentfault.com/a/1190000009506097" rel="nofollow">
      手摸手，带你用vue撸后台 系列二(登录权限篇)
     </a>
    </p>
    <p>
     核心：通过 token 获取用户的 role，根据 role 动态跟路由表
     <code>
      meta.role
     </code>
     进行匹配，形成可访问的路由再通过
     <code>
      router.addRotes
     </code>
     动态挂载路由
    </p>
    <p>
     具体代码结构：
    </p>
    <ul>
     <li>
      可以参考：
      <a href="https://juejin.cn/post/6844904145267195917" rel="nofollow">
       动态路由前端控制还是后端控制？（附代码）
      </a>
     </li>
    </ul>
    <ol>
     <li>
      <p>
       把动态路由和静态路由分别写在 router 文件中（
       <code>
        asyncRoutes/constantRoutes
       </code>
       ）。在动态路由的 meta 元信息中添加 roles 权限
      </p>
      <p>
       代码参考：
       <a href="https://github.com/PanJiaChen/vue-element-admin/blob/master/src/router/index.js">
        https://github.com/PanJiaChen/vue-element-admin/blob/master/src/router/index.js
       </a>
      </p>
     </li>
     <li>
      <p>
       在 vuex 中写一个 state，把路由和获取到的角色进行匹配，控制菜单栏的显示隐藏
      </p>
      <p>
       代码参考：
       <a href="https://github.com/PanJiaChen/vue-element-admin/blob/master/src/store/modules/permission.js">
        https://github.com/PanJiaChen/vue-element-admin/blob/master/src/store/modules/permission.js
       </a>
      </p>
     </li>
     <li>
      <p>
       在导航守卫中，使用
       <code>
        router.beforeEach
       </code>
       进行拦截，可以动态添加可访问的路由表（使用 addRoutes 添加）
      </p>
      <p>
       <a href="https://github.com/PanJiaChen/vue-element-admin/blob/master/src/permission.js">
        https://github.com/PanJiaChen/vue-element-admin/blob/master/src/permission.js
       </a>
      </p>
     </li>
     <li>
      <p>
       从 router 中取出可用的路由对象，来进行侧边栏的渲染
      </p>
      <p>
       <a href="https://github.com/PanJiaChen/vue-element-admin/blob/master/src/layout/components/Sidebar/index.vue">
        https://github.com/PanJiaChen/vue-element-admin/blob/master/src/layout/components/Sidebar/index.vue
       </a>
      </p>
      <p>
       <a href="https://github.com/PanJiaChen/vue-element-admin/blob/master/src/layout/components/Sidebar/SidebarItem.vue">
        https://github.com/PanJiaChen/vue-element-admin/blob/master/src/layout/components/Sidebar/SidebarItem.vue
       </a>
      </p>
     </li>
    </ol>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f62:6c6f672e6373646e2e6e65742f71715f33383638393339352f:61727469636c652f64657461696c732f313136343835323836" class_="artid" style="display:none">
 </p>
</div>


