---
layout: post
title: "vue项目使用mqtt前端部分"
date: 2020-06-02 13:44:01 +0800
description: "文章浏览阅读7.3k次，点赞4次，大部分项目中，前后端交互只是前端请求后端接口，拿到返回的数据之后再"
keywords: "mqtt vue"
categories: ['']
tags: ['前端', 'Vue', 'Javascript']
artid: "106491395"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=106491395
    alt: "vue项目使用mqtt前端部分"
render_with_liquid: false
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     vue项目使用mqtt（前端部分）
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <p>
     大部分项目中，前后端交互只是前端请求后端接口，拿到返回的数据之后再处理即可，但是还是有些需要等待后端处理完成之后，主动通知前端，比如异步支付、消息通知等需求，或者前端自己两个页面间通信，尤其是那种需要实时更新却不方便通过传参等方式解决的，mqtt就可以很好的解决这些问题
    </p>
    <p>
     关于mqtt原理等的文章已经有很多，此文仅是记录前端在vue项目中使用的实例，方便刚接触mqtt的前端朋友快速入门使用
    </p>
    <p>
     <strong>
      1、使用前的准备工作
     </strong>
     <br/>
     先创建一些基础方法方便使用
    </p>
    <pre><code class="prism language-javascript"><span class="token comment">// 准备好日期、随机、判断等基础方法</span>
<span class="token class-name">Date</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">Format</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">fmt</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">let</span> o <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"M+"</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getMonth</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token comment">//月份</span>
        <span class="token string-property property">"d+"</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getDate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">//日</span>
        <span class="token string-property property">"h+"</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getHours</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">//小时</span>
        <span class="token string-property property">"m+"</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getMinutes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">//分</span>
        <span class="token string-property property">"s+"</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getSeconds</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">//秒</span>
        <span class="token string-property property">"q+"</span><span class="token operator">:</span> Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getMonth</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">//季度</span>
        <span class="token string-property property">"S"</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getMilliseconds</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">//毫秒</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">(y+)</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>fmt<span class="token punctuation">)</span><span class="token punctuation">)</span> fmt <span class="token operator">=</span> fmt<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>RegExp<span class="token punctuation">.</span>$1<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getFullYear</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">substr</span><span class="token punctuation">(</span><span class="token number">4</span> <span class="token operator">-</span> RegExp<span class="token punctuation">.</span>$1<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> k <span class="token keyword">in</span> o<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">RegExp</span><span class="token punctuation">(</span><span class="token string">"("</span> <span class="token operator">+</span> k <span class="token operator">+</span> <span class="token string">")"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>fmt<span class="token punctuation">)</span><span class="token punctuation">)</span> fmt <span class="token operator">=</span> fmt<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>RegExp<span class="token punctuation">.</span>$1<span class="token punctuation">,</span> <span class="token punctuation">(</span>RegExp<span class="token punctuation">.</span>$1<span class="token punctuation">.</span>length <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token punctuation">(</span>o<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token string">"00"</span> <span class="token operator">+</span> o<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">substr</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token string">""</span> <span class="token operator">+</span> o<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> fmt<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> <span class="token function-variable function">random</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">n</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">let</span> res <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> res<span class="token punctuation">.</span>length <span class="token operator">&lt;</span> n<span class="token punctuation">;</span> res <span class="token operator">+=</span> Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token number">36</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">substr</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toUpperCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
    <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">substr</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> n<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> <span class="token function-variable function">datePrefixRandomStr</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">len</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Format</span><span class="token punctuation">(</span><span class="token string">"yyMMddhhmmss-"</span><span class="token punctuation">)</span><span class="token operator">+</span> <span class="token function">random</span><span class="token punctuation">(</span>len<span class="token punctuation">)</span> <span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> <span class="token function-variable function">isNotNull</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">obj</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token keyword">null</span> <span class="token operator">!==</span> obj <span class="token operator">&amp;&amp;</span> 	<span class="token keyword">undefined</span> <span class="token operator">!==</span> obj<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>


</code></pre>
    <p>
     <strong>
      2、创建订阅者方法
     </strong>
    </p>
    <p>
     hostname、port、topic、username、password等参数都需要按照自己项目实际填写，可以直接问部署mqtt服务器相关人员，其他的可以参考以下，或者根据项目实际需求更改
    </p>
    <pre><code class="prism language-javascript"><span class="token comment">// 处理初始值、订阅者方法</span>
<span class="token keyword">let</span> <span class="token function-variable function">MqttConsumer</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">jsonParam</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>jsonParam<span class="token punctuation">.</span>topic<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">throw</span> <span class="token string">"topic不能为空"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>hostname <span class="token operator">=</span> <span class="token function">isNotNull</span><span class="token punctuation">(</span>jsonParam<span class="token punctuation">.</span>hostname<span class="token punctuation">)</span> <span class="token operator">?</span> jsonParam<span class="token punctuation">.</span>hostname <span class="token operator">:</span> <span class="token string">'127.0.0.1'</span><span class="token punctuation">;</span>
    <span class="token comment">// this.port = null;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>port <span class="token operator">=</span> <span class="token function">isNotNull</span><span class="token punctuation">(</span>jsonParam<span class="token punctuation">.</span>port<span class="token punctuation">)</span> <span class="token operator">?</span> jsonParam<span class="token punctuation">.</span>port <span class="token operator">:</span> <span class="token number">8084</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>clientId <span class="token operator">=</span> <span class="token function">isNotNull</span><span class="token punctuation">(</span>jsonParam<span class="token punctuation">.</span>clientId<span class="token punctuation">)</span> <span class="token operator">?</span> jsonParam<span class="token punctuation">.</span>clientId <span class="token operator">:</span>  <span class="token string">'ws-consumer-'</span> <span class="token operator">+</span> <span class="token function">datePrefixRandomStr</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>timeout <span class="token operator">=</span> <span class="token function">isNotNull</span><span class="token punctuation">(</span>jsonParam<span class="token punctuation">.</span>timeout<span class="token punctuation">)</span> <span class="token operator">?</span> jsonParam<span class="token punctuation">.</span>timeout <span class="token operator">:</span> <span class="token number">5</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>keepAlive <span class="token operator">=</span> <span class="token function">isNotNull</span><span class="token punctuation">(</span>jsonParam<span class="token punctuation">.</span>keepAlive<span class="token punctuation">)</span> <span class="token operator">?</span> jsonParam<span class="token punctuation">.</span>keepAlive <span class="token operator">:</span> <span class="token number">10</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>reConnectionTimeout <span class="token operator">=</span> <span class="token function">isNotNull</span><span class="token punctuation">(</span>jsonParam<span class="token punctuation">.</span>reConnectionTimeout<span class="token punctuation">)</span> <span class="token operator">?</span> jsonParam<span class="token punctuation">.</span>reConnectionTimeout <span class="token operator">*</span> <span class="token number">1000</span> <span class="token operator">:</span> <span class="token number">5000</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>cleanSession <span class="token operator">=</span> <span class="token function">isNotNull</span><span class="token punctuation">(</span>jsonParam<span class="token punctuation">.</span>cleanSession<span class="token punctuation">)</span> <span class="token operator">?</span> jsonParam<span class="token punctuation">.</span>cleanSession <span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>ssl <span class="token operator">=</span> <span class="token function">isNotNull</span><span class="token punctuation">(</span>jsonParam<span class="token punctuation">.</span>ssl<span class="token punctuation">)</span> <span class="token operator">?</span> jsonParam<span class="token punctuation">.</span>ssl <span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>userName <span class="token operator">=</span> jsonParam<span class="token punctuation">.</span>userName<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>password <span class="token operator">=</span> jsonParam<span class="token punctuation">.</span>password<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>topic <span class="token operator">=</span> jsonParam<span class="token punctuation">.</span>topic<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>qos <span class="token operator">=</span> <span class="token function">isNotNull</span><span class="token punctuation">(</span>jsonParam<span class="token punctuation">.</span>qos<span class="token punctuation">)</span> <span class="token operator">?</span> jsonParam<span class="token punctuation">.</span>qos <span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>client <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>connParam <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 订阅者准备工作</span>
<span class="token class-name">MqttConsumer</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">prepareParam</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">fnConnectionFail<span class="token punctuation">,</span> fnConnectionSuccess</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    <span class="token keyword">let</span> self <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    self<span class="token punctuation">.</span>connParam <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
        <span class="token literal-property property">invocationContext</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token literal-property property">host</span> <span class="token operator">:</span> self<span class="token punctuation">.</span>hostname<span class="token punctuation">,</span>
            <span class="token literal-property property">port</span><span class="token operator">:</span> self<span class="token punctuation">.</span>port<span class="token punctuation">,</span>
            <span class="token literal-property property">path</span><span class="token operator">:</span> <span class="token string">"/mqtt"</span><span class="token punctuation">,</span>
            <span class="token literal-property property">clientId</span><span class="token operator">:</span> self<span class="token punctuation">.</span>clientId
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token literal-property property">timeout</span><span class="token operator">:</span> self<span class="token punctuation">.</span>timeout<span class="token punctuation">,</span>
        <span class="token literal-property property">keepAliveInterval</span><span class="token operator">:</span> self<span class="token punctuation">.</span>keepAlive<span class="token punctuation">,</span>
        <span class="token literal-property property">cleanSession</span><span class="token operator">:</span> self<span class="token punctuation">.</span>cleanSession<span class="token punctuation">,</span>
        <span class="token literal-property property">useSSL</span><span class="token operator">:</span> self<span class="token punctuation">.</span>ssl<span class="token punctuation">,</span>
        <span class="token literal-property property">userName</span><span class="token operator">:</span> self<span class="token punctuation">.</span>userName<span class="token punctuation">,</span>
        <span class="token literal-property property">password</span><span class="token operator">:</span> self<span class="token punctuation">.</span>password<span class="token punctuation">,</span>
        <span class="token function-variable function">onSuccess</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            console<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>clientId <span class="token operator">+</span> <span class="token string">": 连接成功"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            fnConnectionSuccess <span class="token operator">&amp;&amp;</span> <span class="token function">fnConnectionSuccess</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            self<span class="token punctuation">.</span>client<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>topic<span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">qos</span><span class="token operator">:</span> self<span class="token punctuation">.</span>qos<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token function-variable function">onFailure</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>clientId <span class="token operator">+</span> <span class="token string">": 连接服务器失败,"</span> <span class="token operator">+</span> e<span class="token punctuation">.</span>errorMessage<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                fnConnectionFail <span class="token operator">&amp;&amp;</span> <span class="token function">fnConnectionFail</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
            <span class="token keyword">let</span> reconnect <span class="token operator">=</span> <span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>clientId <span class="token operator">+</span> <span class="token string">": 重连中..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">delete</span> self<span class="token punctuation">.</span>connParam<span class="token punctuation">.</span>mqttVersion<span class="token punctuation">;</span>
                    <span class="token keyword">delete</span> self<span class="token punctuation">.</span>connParam<span class="token punctuation">.</span>mqttVersionExplicit<span class="token punctuation">;</span>
                    self<span class="token punctuation">.</span>client<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>connParam<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token function">clearInterval</span><span class="token punctuation">(</span>reconnect<span class="token punctuation">)</span><span class="token punctuation">,</span> reconnect <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>reConnectionTimeout<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 连接</span>
<span class="token class-name">MqttConsumer</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">connect</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">fnOnMessage<span class="token punctuation">,</span> fnConnectionFail<span class="token punctuation">,</span> fnConnectionSuccess<span class="token punctuation">,</span> fnConnectionLost</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>

    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">prepareParam</span><span class="token punctuation">(</span>fnConnectionFail<span class="token punctuation">,</span> fnConnectionSuccess<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>client <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Paho<span class="token punctuation">.</span>MQTT<span class="token punctuation">.</span>Client</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>hostname<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>port<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>clientId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>client<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>connParam<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> self <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    self<span class="token punctuation">.</span>client<span class="token punctuation">.</span><span class="token function-variable function">onConnectionLost</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">responseObject</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>responseObject<span class="token punctuation">.</span>errorCode <span class="token operator">!==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>clientId <span class="token operator">+</span> <span class="token string">": 与服务器断开连接，"</span> <span class="token operator">+</span> responseObject<span class="token punctuation">.</span>errorMessage<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">let</span> interval <span class="token operator">=</span> <span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>clientId <span class="token operator">+</span> <span class="token string">"：重连中..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        self<span class="token punctuation">.</span><span class="token function">prepareParam</span><span class="token punctuation">(</span>fnConnectionFail<span class="token punctuation">,</span> fnConnectionSuccess<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        self<span class="token punctuation">.</span>client<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>connParam<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token function">clearInterval</span><span class="token punctuation">(</span>interval<span class="token punctuation">)</span><span class="token punctuation">,</span> interval <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>reConnectionTimeout<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        fnConnectionLost <span class="token operator">&amp;&amp;</span> <span class="token function">fnConnectionLost</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    self<span class="token punctuation">.</span>client<span class="token punctuation">.</span><span class="token function-variable function">onMessageArrived</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">messageBody</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">try</span><span class="token punctuation">{<!-- --></span> 
            fnOnMessage <span class="token operator">&amp;&amp;</span> <span class="token function">fnOnMessage</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> messageBody<span class="token punctuation">.</span>destinationName<span class="token punctuation">,</span> messageBody<span class="token punctuation">.</span>payloadString<span class="token punctuation">,</span> messageBody<span class="token punctuation">.</span>qos<span class="token punctuation">,</span> messageBody<span class="token punctuation">.</span>retained<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>ex<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
    <p>
     <strong>
      3、创建发布者方法
     </strong>
    </p>
    <p>
     发布者处方法和订阅者类似
    </p>
    <pre><code class="prism language-javascript"><span class="token keyword">let</span> <span class="token function-variable function">MqttProducer</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">jsonParam</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>hostname <span class="token operator">=</span> <span class="token function">isNotNull</span><span class="token punctuation">(</span>jsonParam<span class="token punctuation">.</span>hostname<span class="token punctuation">)</span> <span class="token operator">?</span> jsonParam<span class="token punctuation">.</span>hostname <span class="token operator">:</span> <span class="token string">'127.0.0.1'</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>port <span class="token operator">=</span> <span class="token function">isNotNull</span><span class="token punctuation">(</span>jsonParam<span class="token punctuation">.</span>port<span class="token punctuation">)</span> <span class="token operator">?</span> jsonParam<span class="token punctuation">.</span>port <span class="token operator">:</span> <span class="token number">8084</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>clientId <span class="token operator">=</span> <span class="token function">isNotNull</span><span class="token punctuation">(</span>jsonParam<span class="token punctuation">.</span>clientId<span class="token punctuation">)</span> <span class="token operator">?</span> jsonParam<span class="token punctuation">.</span>clientId <span class="token operator">:</span> <span class="token string">'ws-producer-'</span> <span class="token operator">+</span> <span class="token function">datePrefixRandomStr</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>timeout <span class="token operator">=</span> <span class="token function">isNotNull</span><span class="token punctuation">(</span>jsonParam<span class="token punctuation">.</span>timeout<span class="token punctuation">)</span> <span class="token operator">?</span> jsonParam<span class="token punctuation">.</span>timeout <span class="token operator">:</span> <span class="token number">5</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>keepAlive <span class="token operator">=</span> <span class="token function">isNotNull</span><span class="token punctuation">(</span>jsonParam<span class="token punctuation">.</span>keepAlive<span class="token punctuation">)</span> <span class="token operator">?</span> jsonParam<span class="token punctuation">.</span>keepAlive <span class="token operator">:</span> <span class="token number">10</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>reConnectionTimeout <span class="token operator">=</span> <span class="token function">isNotNull</span><span class="token punctuation">(</span>jsonParam<span class="token punctuation">.</span>reConnectionTimeout<span class="token punctuation">)</span> <span class="token operator">?</span> jsonParam<span class="token punctuation">.</span>reConnectionTimeout <span class="token operator">*</span> <span class="token number">1000</span> <span class="token operator">:</span> <span class="token number">5000</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>cleanSession <span class="token operator">=</span> <span class="token function">isNotNull</span><span class="token punctuation">(</span>jsonParam<span class="token punctuation">.</span>cleanSession<span class="token punctuation">)</span> <span class="token operator">?</span> jsonParam<span class="token punctuation">.</span>cleanSession <span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>ssl <span class="token operator">=</span> <span class="token function">isNotNull</span><span class="token punctuation">(</span>jsonParam<span class="token punctuation">.</span>ssl<span class="token punctuation">)</span> <span class="token operator">?</span> jsonParam<span class="token punctuation">.</span>ssl <span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>userName <span class="token operator">=</span> jsonParam<span class="token punctuation">.</span>userName<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>password <span class="token operator">=</span> jsonParam<span class="token punctuation">.</span>password<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>qos <span class="token operator">=</span> <span class="token function">isNotNull</span><span class="token punctuation">(</span>jsonParam<span class="token punctuation">.</span>qos<span class="token punctuation">)</span> <span class="token operator">?</span> jsonParam<span class="token punctuation">.</span>qos <span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>client <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>connParam <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token class-name">MqttProducer</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">prepareParam</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">fnConnectionFail<span class="token punctuation">,</span> fnConnectionSuccess</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    <span class="token keyword">let</span> self <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    self<span class="token punctuation">.</span>connParam <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
        <span class="token literal-property property">invocationContext</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token literal-property property">host</span> <span class="token operator">:</span> self<span class="token punctuation">.</span>hostname<span class="token punctuation">,</span>
            <span class="token literal-property property">port</span><span class="token operator">:</span> self<span class="token punctuation">.</span>port<span class="token punctuation">,</span>
            <span class="token literal-property property">path</span><span class="token operator">:</span> <span class="token string">"/mqtt"</span><span class="token punctuation">,</span>
            <span class="token literal-property property">clientId</span><span class="token operator">:</span> self<span class="token punctuation">.</span>clientId
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token literal-property property">timeout</span><span class="token operator">:</span> self<span class="token punctuation">.</span>timeout<span class="token punctuation">,</span>
        <span class="token literal-property property">keepAliveInterval</span><span class="token operator">:</span> self<span class="token punctuation">.</span>keepAlive<span class="token punctuation">,</span>
        <span class="token literal-property property">cleanSession</span><span class="token operator">:</span> self<span class="token punctuation">.</span>cleanSession<span class="token punctuation">,</span>
        <span class="token literal-property property">useSSL</span><span class="token operator">:</span> self<span class="token punctuation">.</span>ssl<span class="token punctuation">,</span>
        <span class="token literal-property property">userName</span><span class="token operator">:</span> self<span class="token punctuation">.</span>userName<span class="token punctuation">,</span>
        <span class="token literal-property property">password</span><span class="token operator">:</span> self<span class="token punctuation">.</span>password<span class="token punctuation">,</span>
        <span class="token function-variable function">onSuccess</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            console<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>clientId <span class="token operator">+</span> <span class="token string">": 连接成功"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            fnConnectionSuccess <span class="token operator">&amp;&amp;</span> <span class="token function">fnConnectionSuccess</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token function-variable function">onFailure</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            console<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>clientId <span class="token operator">+</span> <span class="token string">": 连接服务器失败,"</span> <span class="token operator">+</span> e<span class="token punctuation">.</span>errorMessage<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                fnConnectionFail <span class="token operator">&amp;&amp;</span> <span class="token function">fnConnectionFail</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
            <span class="token keyword">let</span> reconnect <span class="token operator">=</span> <span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                    console<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>clientId <span class="token operator">+</span> <span class="token string">": 重连中..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">delete</span> self<span class="token punctuation">.</span>connParam<span class="token punctuation">.</span>mqttVersion<span class="token punctuation">;</span>
                    <span class="token keyword">delete</span> self<span class="token punctuation">.</span>connParam<span class="token punctuation">.</span>mqttVersionExplicit<span class="token punctuation">;</span>
                    self<span class="token punctuation">.</span>client<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>connParam<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token function">clearInterval</span><span class="token punctuation">(</span>reconnect<span class="token punctuation">)</span><span class="token punctuation">,</span> reconnect <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    console<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>reConnectionTimeout<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token class-name">MqttProducer</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">connect</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">fnConnectionFail<span class="token punctuation">,</span> fnConnectionSuccess<span class="token punctuation">,</span> fnConnectionLost</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">prepareParam</span><span class="token punctuation">(</span>fnConnectionFail<span class="token punctuation">,</span> fnConnectionSuccess<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>client <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Paho<span class="token punctuation">.</span>MQTT<span class="token punctuation">.</span>Client</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>hostname<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>port<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>clientId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>client<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>connParam<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> self <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    self<span class="token punctuation">.</span>client<span class="token punctuation">.</span><span class="token function-variable function">onConnectionLost</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">responseObject</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>responseObject<span class="token punctuation">.</span>errorCode <span class="token operator">!==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                console<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>clientId <span class="token operator">+</span> <span class="token string">": 与服务器断开连接，"</span> <span class="token operator">+</span> responseObject<span class="token punctuation">.</span>errorMessage<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">let</span> interval <span class="token operator">=</span> <span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                        console<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>clientId <span class="token operator">+</span> <span class="token string">"：重连中..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        self<span class="token punctuation">.</span><span class="token function">prepareParam</span><span class="token punctuation">(</span>fnConnectionFail<span class="token punctuation">,</span> fnConnectionSuccess<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        self<span class="token punctuation">.</span>client<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>connParam<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token function">clearInterval</span><span class="token punctuation">(</span>interval<span class="token punctuation">)</span><span class="token punctuation">,</span> interval <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        console<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>reConnectionTimeout<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        fnConnectionLost <span class="token operator">&amp;&amp;</span> <span class="token function">fnConnectionLost</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">// 发送消息的发方法</span>
<span class="token class-name">MqttProducer</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">send</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">topic<span class="token punctuation">,</span> msg<span class="token punctuation">,</span> qos</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">let</span> message <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Paho<span class="token punctuation">.</span>MQTT<span class="token punctuation">.</span>Message</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    message<span class="token punctuation">.</span>destinationName <span class="token operator">=</span> topic<span class="token punctuation">;</span>
    message<span class="token punctuation">.</span>qos <span class="token operator">=</span> <span class="token function">isNotNull</span><span class="token punctuation">(</span>qos<span class="token punctuation">)</span> <span class="token operator">?</span> qos <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>qos<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>client<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     <strong>
      4、使用
     </strong>
    </p>
    <p>
     这里直接举例前端从发送消息到接收的简单过程
    </p>
    <p>
     先在页面中创建发布者
    </p>
    <pre><code class="prism language-javascript"><span class="token keyword">function</span> <span class="token function">createProducer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    producer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MqttProducer</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
        <span class="token literal-property property">hostname</span> <span class="token operator">:</span> ‘http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>xxx<span class="token punctuation">.</span>com<span class="token operator">/</span>mqtt’<span class="token punctuation">,</span> <span class="token comment">// 此处为服务端mqtt域名，需后端配置</span>
        <span class="token literal-property property">port</span> <span class="token operator">:</span> <span class="token number">8084</span><span class="token punctuation">,</span> <span class="token comment">// 端口按照实际的来 </span>
        <span class="token literal-property property">userName</span> <span class="token operator">:</span> <span class="token string">'username'</span><span class="token punctuation">,</span> <span class="token comment">// 用户名</span>
        <span class="token literal-property property">password</span> <span class="token operator">:</span> <span class="token string">'password'</span> <span class="token comment">// 密码</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    producer<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     然后发送消息
     <br/>
     注意：topic需要和订阅者的topic相同，才能接收到消息
    </p>
    <pre><code class="prism language-javascript"><span class="token keyword">function</span> <span class="token function">sendMQTTmessage</span><span class="token punctuation">(</span><span class="token parameter">user<span class="token punctuation">,</span> message</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token comment">// topic需要和接收者的topic相同，才能接收到消息，此处user是我用来确定发布和接收者唯一性的参数</span>
    <span class="token keyword">let</span> topic <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">/mqtt/m/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span>user<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
    <span class="token comment">// message就是需要发送的消息内容，需要string类型</span>
    producer<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>topic<span class="token punctuation">,</span> message<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     在接收页创建订阅者
     <br/>
     注意：订阅处配置需要和发布处相同
    </p>
    <pre><code class="prism language-javascript"><span class="token comment">// 初始化mqtt连接等</span>
<span class="token keyword">function</span> <span class="token function">registerMqttConsumer</span><span class="token punctuation">(</span><span class="token parameter">user</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">let</span> consumer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MqttConsumer</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
		<span class="token literal-property property">hostname</span> <span class="token operator">:</span> ‘http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>xxx<span class="token punctuation">.</span>com<span class="token operator">/</span>mqtt’<span class="token punctuation">,</span>
		<span class="token literal-property property">port</span> <span class="token operator">:</span> <span class="token number">8084</span><span class="token punctuation">,</span>
		<span class="token literal-property property">userName</span> <span class="token operator">:</span> <span class="token string">'username'</span><span class="token punctuation">,</span>
		<span class="token literal-property property">password</span> <span class="token operator">:</span> <span class="token string">'password'</span><span class="token punctuation">,</span>
		<span class="token literal-property property">topic</span> <span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">/mqtt/m/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span>user<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	consumer<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">topic<span class="token punctuation">,</span> message<span class="token punctuation">,</span> qos<span class="token punctuation">,</span> retained</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 接收到消息了</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     <strong>
      5、使用过的其他情况
     </strong>
    </p>
    <p>
     注意：如果项目使用的mqtt通知消息时，主题topic有多个层级，但是主要区别是最后一个层级的话，也可以只订阅一次，订阅时topic使用多层通配符----&gt;“#”，“#”是用于匹配主题中任意层级的通配符，需要注意的是无论什么时候，它都必须是主题过滤器的最后一个字符 .
    </p>
    <p>
     比如如下情况，就可以订阅到/mqtt/m/ 下所有发出的消息，此种情况下可以直接在接收到消息的时候判断topic完整的主题字符串找出当前发的消息具体是哪个，然后再继续做处理即可
    </p>
    <pre><code class="prism language-javascript"><span class="token keyword">function</span> <span class="token function">registerMqttConsumer</span><span class="token punctuation">(</span><span class="token parameter">user</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">let</span> consumer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MqttConsumer</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
		<span class="token literal-property property">hostname</span> <span class="token operator">:</span> ‘http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>xxx<span class="token punctuation">.</span>com<span class="token operator">/</span>mqtt’<span class="token punctuation">,</span>
		<span class="token literal-property property">port</span> <span class="token operator">:</span> <span class="token number">8084</span><span class="token punctuation">,</span>
		<span class="token literal-property property">userName</span> <span class="token operator">:</span> <span class="token string">'username'</span><span class="token punctuation">,</span>
		<span class="token literal-property property">password</span> <span class="token operator">:</span> <span class="token string">'password'</span><span class="token punctuation">,</span>
		<span class="token literal-property property">topic</span> <span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">/mqtt/m/#</span><span class="token template-punctuation string">`</span></span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	consumer<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">topic<span class="token punctuation">,</span> message<span class="token punctuation">,</span> qos<span class="token punctuation">,</span> retained</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 接收到消息了</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     以上即为前端使用mqtt的完整步骤，mqttws31.js的文件我会把链接放上，以上。
     <br/>
     <a href="https://download.csdn.net/download/xt_XiTu/12488593?spm=1001.2014.3001.5503">
      https://download.csdn.net/download/xt_XiTu/12488593?spm=1001.2014.3001.5503
     </a>
    </p>
    <p>
     这种方法是几年前刚接触mqtt时的公司中的用法，实际项目中使用时可以直接在npm上寻找适合需求的插件
    </p>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="6874747073:3a2f2f626c6f672e6373646e2e6e65742f78745f586954752f:61727469636c652f64657461696c732f313036343931333935" class_="artid" style="display:none">
 </p>
</div>


