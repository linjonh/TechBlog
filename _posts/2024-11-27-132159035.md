---
layout: post
title: "最全总结聊聊-Python-调用-JS-的几种方式"
date: 2024-11-27 17:50:17 +0800
description: "js2py作为一个纯 Python 实现的 JS 解释器，可以完全脱离 JS 环境，直接将 JS 代"
keywords: "python程序如何调用js代码"
categories: ['']
tags: ['开发语言', 'Python', 'Javascript']
artid: "132159035"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=132159035
    alt: "最全总结聊聊-Python-调用-JS-的几种方式"
render_with_liquid: false
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     最全总结！聊聊 Python 调用 JS 的几种方式
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-light" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <article class="syl-article-base tt-article-content syl-page-article syl-device-pc">
     <h2 class="pgc-h-arrow-right">
      <strong>
       1. 前言
      </strong>
     </h2>
     <p>
      日常 Web 端爬虫过程中，经常会遇到参数被加密的场景，因此，我们需要分析网页源代码
     </p>
     <p>
      通过调式，一层层剥离出关键的 JS 代码，使用 Python 去执行这段代码，得出参数加密前后的 Python 实现
     </p>
     <p>
      本文将聊聊利用 Python 调用 JS 的4种方式
     </p>
     <h2 class="pgc-h-arrow-right">
      <strong>
       2. 准备
      </strong>
     </h2>
     <p>
      以一段简单的 JS 脚本为例，将代码写入到文件中
     </p>
     <pre><code class="language-javascript"><code><span class="hljs-comment">//norm.js</span>
<span class="hljs-comment">//计算两个数的和</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">add</span>(<span class="hljs-params">num1, num2</span>) </span>{
    <span class="hljs-keyword">return</span> num1 + num2;
}</code></code></pre>
     <p>
      其中，定义了一个方法，计算两个数的和
     </p>
     <h2 class="pgc-h-arrow-right">
      <strong>
       3. 方式一：PyExecJS
      </strong>
     </h2>
     <p>
      PyExecJS 是使用最多的一种方式，底层实现方式是：在本地 JS 环境下运行 JS 代码
     </p>
     <p>
      支持的 JS 环境包含：Node.js、PyV8、PhantomJS、Nashorn 等
     </p>
     <p>
      首先，我们需要安装依赖包 PyExecJS
     </p>
     <pre><code class="language-cpp"><code><span class="hljs-comment">//py_exec_js_demo.py</span>
</code></code></pre>
    </article>
    <p>
     <span class="hljs-comment">
      //安装依赖
     </span>
     <br/>
     pip3 install PyExecJS
    </p>
    <p>
     然后，从 JS 文件中读取源码
    </p>
    <pre><code class="language-python"><code><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">js_from_file</span><span class="hljs-params">(file_name)</span>:</span><br/>
    <span class="hljs-string">“”"<br/>
    读取js文件<br/>
    :return:<br/>
    “”"</span><br/>
    <span class="hljs-keyword">with</span> open(file_name, <span class="hljs-string">‘r’</span>, encoding=<span class="hljs-string">‘UTF-8’</span>) <span class="hljs-keyword">as</span> file:<br/>
        result = file.read()
</code></code></pre>
    <p>
     <span class="hljs-keyword">
      return
     </span>
     result
    </p>
    <p>
     最后，使用 execjs 类的compile()方法编译加载上面的 JS 字符串，返回一个上下文对象
    </p>
    <pre class="syl-page-code hljs coffeescript"><code><span class="hljs-keyword">import</span> execjs
</code></pre>
    <p>
     <span class="hljs-keyword">
      from
     </span>
     js_code
     <span class="hljs-keyword">
      import
     </span>
     *
    </p>
    <p>
     <span class="hljs-comment">
      # 编译加载js字符串
     </span>
     <br/>
     context1 = execjs.compile(js_from_file(
     <span class="hljs-string">
      ‘./norm.js’
     </span>
     ))
    </p>
    <p>
     最后，调用上下文对象的call() 方法执行 JS 方法
    </p>
    <p>
     其中，参数包含：JS 代码被调的方法名、对应方法的传入参数
    </p>
    <pre class="syl-page-code hljs bash"><code><span class="hljs-comment"># 调用js代码中的add()方法，参数为2和3</span><br/>
<span class="hljs-comment"># 方法名：add</span><br/>
<span class="hljs-comment"># 参数：2和3</span><br/>
result1 = context1.call(<span class="hljs-string">“add”</span>, 2, 3)
</code></pre>
    <p>
     <span class="hljs-built_in">
      print
     </span>
     (result1)
    </p>
    <p>
     需要注意的，由于 PyExecJS 运行在本地 JS 环境下，使用之前会启动 JS 环境，最终导致运行速度会偏慢
    </p>
    <p>
     更多功能可以参考：
    </p>
    <p class="syl-line-pure-english">
     <u>
      https://github.com/doloopwhile/PyExecJS
     </u>
    </p>
    <h2 class="pgc-h-arrow-right">
     <strong>
      4. 方式二：js2py
     </strong>
    </h2>
    <p>
     js2py作为一个纯 Python 实现的 JS 解释器，可以完全脱离 JS 环境，直接将 JS 代码转换为 Python 代码
    </p>
    <p class="syl-page-br">
     <br/>
    </p>
    <p>
     首先，安装依赖库
    </p>
    <p class="syl-page-br">
     <br/>
    </p>
    <pre class="syl-page-code hljs nginx"><code><span class="hljs-comment"># 安装依赖库</span><br/>
<span class="hljs-attribute">pip3</span> install js2py</code></pre>
    <p class="syl-page-br">
     <br/>
    </p>
    <p>
     然后使用 js2py 中的EvalJs()方法生成一个上下文对象
    </p>
    <p class="syl-page-br">
     <br/>
    </p>
    <pre class="syl-page-code hljs ini"><code><span class="hljs-comment"># 使用获取上下js2py生成一个上下文环境</span><br/>
<span class="hljs-attr">context</span> = js2py.EvalJs()</code></pre>
    <p class="syl-page-br">
     <br/>
    </p>
    <p>
     接着利用上下文对象执行 JS 脚本，转换为 Python 代码
    </p>
    <p class="syl-page-br">
     <br/>
    </p>
    <pre class="syl-page-code hljs apache"><code><span class="hljs-comment"># 执行整段JS代码</span><br/>
<span class="hljs-attribute">context</span>.execute(js_content)</code></pre>
    <p class="syl-page-br">
     <br/>
    </p>
    <p>
     最后，利用上下文调用 JS 中的方法，并制定输入参数即可
    </p>
    <p class="syl-page-br">
     <br/>
    </p>
    <pre class="syl-page-code hljs bash"><code><span class="hljs-comment"># 使用上下文context调用具体的函数</span><br/>
<span class="hljs-comment"># 函数名：add</span><br/>
<span class="hljs-comment"># 参数：1，2</span><br/>
result = context.add(1, 2)<br/>
<span class="hljs-built_in">print</span>(result)</code></pre>
    <p>
     需要注意是，如果 JS 是很长的混淆代码，转换为 Python 的过程可能会报错
    </p>
    <p>
     更多功能可以参考：
    </p>
    <p class="syl-line-pure-english">
     <u>
      https://github.com/PiotrDabkowski/Js2Py
     </u>
    </p>
    <h2 class="pgc-h-arrow-right">
     <strong>
      5. 方式三：Node.js
     </strong>
    </h2>
    <p>
     实际上是使用 Python 的os.popen执行 node 命令，执行 JS 脚本
    </p>
    <p>
     首先，确保本地已经安装了 Node.js 环境
    </p>
    <p>
     修改 JS 脚本，新增一个导出函数 init ，方便内部函数被调用
    </p>
    <pre><code class="language-javascript"><code><span class="hljs-comment">//计算两个数的和</span><br/>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">add</span>(<span class="hljs-params">num1, num2</span>) </span>{<!-- --><br/>
    <span class="hljs-keyword">return</span> num1 + num2;<br/>
}
</code></code></pre>
    <p>
     <span class="hljs-comment">
      //新增一个导出函数（node方式）
     </span>
     <br/>
     <span class="hljs-built_in">
      module
     </span>
     .exports.init =
     <span class="hljs-function">
      <span class="hljs-keyword">
       function
      </span>
      (
      <span class="hljs-params">
       arg1, arg2
      </span>
      )
     </span>
     {
     <!-- -->
     <br/>
     <span class="hljs-comment">
      //调用函数，并返回
     </span>
     <br/>
     <span class="hljs-built_in">
      console
     </span>
     .log(add(arg1, arg2));
     <br/>
     };
    </p>
    <p>
     然后，将调用 JS 方法的命令组成一个字符串
    </p>
    <pre class="syl-page-code hljs ini"><code><span class="hljs-comment"># 组成调用js的命令</span><br/>
<span class="hljs-comment"># node命令：node -e</span><br/>
<span class="hljs-attr">cmd</span> = <span class="hljs-string">‘node -e “require(\”%s\“).init(%s,%s)”’</span> % (<span class="hljs-string">‘./norm’</span>, <span class="hljs-number">3</span>, <span class="hljs-number">5</span>)</code></pre>
    <p>
     最后，通过 os.popen 执行命令即可
    </p>
    <pre class="syl-page-code hljs lua"><code>pipeline = <span class="hljs-built_in">os</span>.<span class="hljs-built_in">popen</span>(cmd)
</code></pre>
    <p>
     # 读取结果
     <br/>
     result = pipeline.
     <span class="hljs-built_in">
      read
     </span>
     ()
    </p>
    <p>
     <span class="hljs-built_in">
      print
     </span>
     (
     <span class="hljs-string">
      ‘结果是:’
     </span>
     , result)
    </p>
    <h2 class="pgc-h-arrow-right">
     <strong>
      6. 方式四：PyV8
     </strong>
    </h2>
    <p>
    </p>
    <p>
     PyV8 是 Google 将 Chrome V8 引擎用 Python 封装的依赖库
    </p>
    <p>
     它不依赖本地 JS 环境，运行速度很快
    </p>
    <pre><code class="language-python"><code><span class="hljs-keyword">import</span> PyV8<br/>
<span class="hljs-keyword">from</span> js_code <span class="hljs-keyword">import</span> js_from_file
</code></code></pre>
    <p>
     <span class="hljs-keyword">
      with
     </span>
     PyV8.JSContext()
     <span class="hljs-keyword">
      as
     </span>
     ctx:
     <br/>
     ctx.eval(js_from_file(
     <span class="hljs-string">
      ‘./norm.js’
     </span>
     ))
    </p>
    <p>
     <span class="hljs-comment">
      # 调用js函数，指定参数
     </span>
     <br/>
     ctx.locals.add(
     <span class="hljs-number">
      1
     </span>
     ,
     <span class="hljs-number">
      2
     </span>
     )
    </p>
    <p>
     但是经过反复测试发现，MAC 和 PC 在 Python3 环境下，使用 PyV8 会报各种奇怪的问题，所以不推荐使用！
    </p>
    <p>
     更多功能可以参考：
    </p>
    <p>
     <u>
      https://github.com/emmetio/pyv8-binaries
     </u>
    </p>
    <h2 class="pgc-h-arrow-right">
     <strong>
      7. 最后
     </strong>
    </h2>
    <p>
     上面总结了 Python 调用 JS 的 4 种方式
    </p>
    <p>
     实际爬虫项目中，一般会先使用 node 命令进行一次测试，确保没问题后，再使用前 3 种方式的任意一种进行 Python 改写
    </p>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f62:6c6f672e6373646e2e6e65742f61313133373538383030332f:61727469636c652f64657461696c732f313332313539303335" class_="artid" style="display:none">
 </p>
</div>


