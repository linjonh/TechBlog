---
layout: post
title: "SpringBoot-使用-Testcontainers-进行容器化集成测试"
date: 2024-12-05 15:54:39 +0800
description: "Testcontainers是一个Java测试库，用于在测试中启动Docker容器。Testcont"
keywords: "Testcontainers,SpringBoot,容器化集成测试"
categories: ['教程', 'Java']
tags: ['集成测试', 'Spring', 'Docker', 'Boot']
artid: "131372168"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=131372168
    alt: "SpringBoot-使用-Testcontainers-进行容器化集成测试"
render_with_liquid: false
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     SpringBoot 使用 Testcontainers 进行容器化集成测试
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-light" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <h2>
     <a id="SpringBoot__Testcontainers__0">
     </a>
     SpringBoot 使用 Testcontainers 进行容器化集成测试
    </h2>
    <p>
     容器化集成测试是测试应用程序与其依赖项之间的集成，其中依赖项以容器的形式运行。SpringBoot提供了Testcontainers来测试应用程序与依赖项之间的集成，本文将介绍如何使用Testcontainers进行容器化集成测试。
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/096e3a402aa5668ca56a7e5791f5b3ac.png"/>
    </p>
    <h3>
     <a id="1__Testcontainers_7">
     </a>
     1. 什么是 Testcontainers
    </h3>
    <p>
     Testcontainers是一个Java测试库，用于在测试中启动Docker容器。Testcontainers可以在测试运行时自动启动和停止Docker容器，并提供简单的API来访问容器中的服务。Testcontainers支持各种数据库、消息代理和其他服务，以便在测试中模拟外部依赖项。
    </p>
    <h3>
     <a id="2__Testcontainers_11">
     </a>
     2. 如何使用 Testcontainers
    </h3>
    <p>
     使用Testcontainers非常简单，只需要在测试类中创建一个Testcontainers实例，并使用该实例启动Docker容器即可。例如，以下是一个使用Testcontainers测试MySQL数据库的示例：
    </p>
    <pre><code class="prism language-java"><span class="token annotation punctuation">@RunWith</span><span class="token punctuation">(</span><span class="token class-name">SpringRunner</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@SpringBootTest</span>
<span class="token annotation punctuation">@Testcontainers</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserRepositoryIntegrationTest</span> <span class="token punctuation">{<!-- --></span>

    <span class="token annotation punctuation">@Container</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">MySQLContainer</span> mysqlContainer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MySQLContainer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">withUsername</span><span class="token punctuation">(</span><span class="token string">"test"</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">withPassword</span><span class="token punctuation">(</span><span class="token string">"test"</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">withDatabaseName</span><span class="token punctuation">(</span><span class="token string">"test"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">UserRepository</span> userRepository<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">shouldSaveUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">User</span> user <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token string">"John Smith"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        userRepository<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">assertThat</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isNotNull</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     在测试中，使用了Spring Boot Test和JUnit的注解来配置测试环境。@Testcontainers注解用于启用Testcontainers，@Container注解用于创建MySQL容器。在测试方法中，使用自动注入的UserRepository实例保存用户，并使用断言验证用户ID是否已设置。
    </p>
    <h3>
     <a id="3_Testcontainers__41">
     </a>
     3. Testcontainers 的高级用法
    </h3>
    <p>
     Testcontainers提供了许多高级用法，以便在测试中启动和管理Docker容器。以下是一些常见的高级用法：
    </p>
    <h4>
     <a id="31__Docker__45">
     </a>
     3.1 使用自定义 Docker 镜像
    </h4>
    <p>
     Testcontainers支持使用自定义Docker镜像启动容器。您可以使用以下代码指定自定义Docker镜像：
    </p>
    <pre><code class="prism language-java"><span class="token annotation punctuation">@Container</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">GenericContainer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> container <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">GenericContainer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token string">"my-image:1.0.0"</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">withExposedPorts</span><span class="token punctuation">(</span><span class="token number">8080</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <p>
     在此示例中，使用了GenericContainer来创建容器，并指定了自定义Docker镜像和端口号。
    </p>
    <h4>
     <a id="32__57">
     </a>
     3.2 使用容器网络
    </h4>
    <p>
     Testcontainers支持使用容器网络连接多个容器。您可以使用以下代码指定容器网络：
    </p>
    <pre><code class="prism language-java"><span class="token annotation punctuation">@Container</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Network</span> network <span class="token operator">=</span> <span class="token class-name">Network</span><span class="token punctuation">.</span><span class="token function">newNetwork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Container</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">MySQLContainer</span> mysqlContainer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MySQLContainer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">withNetwork</span><span class="token punctuation">(</span>network<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">withNetworkAliases</span><span class="token punctuation">(</span><span class="token string">"mysql"</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">withUsername</span><span class="token punctuation">(</span><span class="token string">"test"</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">withPassword</span><span class="token punctuation">(</span><span class="token string">"test"</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">withDatabaseName</span><span class="token punctuation">(</span><span class="token string">"test"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Container</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">MyApplicationContainer</span> appContainer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyApplicationContainer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">withNetwork</span><span class="token punctuation">(</span>network<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">withEnv</span><span class="token punctuation">(</span><span class="token string">"SPRING_DATASOURCE_URL"</span><span class="token punctuation">,</span> <span class="token string">"jdbc:mysql://mysql:3306/test"</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">withEnv</span><span class="token punctuation">(</span><span class="token string">"SPRING_DATASOURCE_USERNAME"</span><span class="token punctuation">,</span> <span class="token string">"test"</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">withEnv</span><span class="token punctuation">(</span><span class="token string">"SPRING_DATASOURCE_PASSWORD"</span><span class="token punctuation">,</span> <span class="token string">"test"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <p>
     在此示例中，使用了Network来创建容器网络，并将MySQL容器和应用程序容器连接到同一网络。应用程序容器使用了MySQL容器的网络别名来访问MySQL数据库。
    </p>
    <h4>
     <a id="33__83">
     </a>
     3.3 使用容器等待策略
    </h4>
    <p>
     Testcontainers支持使用容器等待策略等待容器启动。您可以使用以下代码指定容器等待策略：
    </p>
    <pre><code class="prism language-java"><span class="token annotation punctuation">@Container</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">MySQLContainer</span> mysqlContainer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MySQLContainer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">withStartupTimeout</span><span class="token punctuation">(</span><span class="token class-name">Duration</span><span class="token punctuation">.</span><span class="token function">ofSeconds</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">withUsername</span><span class="token punctuation">(</span><span class="token string">"test"</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">withPassword</span><span class="token punctuation">(</span><span class="token string">"test"</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">withDatabaseName</span><span class="token punctuation">(</span><span class="token string">"test"</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">waitingFor</span><span class="token punctuation">(</span><span class="token class-name">Wait</span><span class="token punctuation">.</span><span class="token function">forLogMessage</span><span class="token punctuation">(</span><span class="token string">".*ready for connections.*\\n"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <p>
     在此示例中，使用了MySQL容器的waitingFor方法来等待MySQL容器启动，并打印"ready for connections"日志消息。
    </p>
    <h4>
     <a id="34__99">
     </a>
     3.4 使用容器卷
    </h4>
    <p>
     Testcontainers支持使用容器卷将本地文件映射到容器中。您可以使用以下代码指定容器卷：
    </p>
    <pre><code class="prism language-java"><span class="token annotation punctuation">@Container</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">MySQLContainer</span> mysqlContainer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MySQLContainer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">withUsername</span><span class="token punctuation">(</span><span class="token string">"test"</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">withPassword</span><span class="token punctuation">(</span><span class="token string">"test"</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">withDatabaseName</span><span class="token punctuation">(</span><span class="token string">"test"</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">withCopyFileToContainer</span><span class="token punctuation">(</span><span class="token class-name">MountableFile</span><span class="token punctuation">.</span><span class="token function">forClasspathResource</span><span class="token punctuation">(</span><span class="token string">"test.sql"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"/docker-entrypoint-initdb.d/test.sql"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <p>
     在此示例中，使用了MySQL容器的withCopyFileToContainer方法将本地资源文件test.sql复制到MySQL容器的/docker-entrypoint-initdb.d目录中，以便在容器启动时自动运行SQL脚本。
    </p>
    <h3>
     <a id="4__114">
     </a>
     4. 总结
    </h3>
    <p>
     Testcontainers是一个强大的Java测试库，用于在测试中启动和管理Docker容器。使用Testcontainers可以方便地测试应用程序与其依赖项之间的集成，以及模拟外部依赖项。本文介绍了Testcontainers的基本用法和一些高级用法，包括使用自定义Docker镜像、容器网络、容器等待策略和容器卷。
    </p>
    <p>
     在SpringBoot应用程序中使用Testcontainers非常简单，只需要在测试类中创建Testcontainers实例，并使用该实例启动Docker容器即可。使用Testcontainers进行容器化集成测试可以帮助我们更好地测试应用程序与其依赖项之间的集成，提高测试覆盖率和测试质量。
    </p>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
  <div class="blog-extension-box" id="blogExtensionBox" style="width:400px;margin:auto;margin-top:12px">
  </div>
 </article>
 <p alt="68747470733a2f:2f626c6f672e6373646e2e6e65742f79756a756e323032332f:61727469636c652f64657461696c732f313331333732313638" class_="artid" style="display:none">
 </p>
</div>


