---
layout: post
title: 微信小程序登录流程与实现
date: 2023-03-26 23:43:13 +0800
categories: ['原生微信小程序']
tags: ['微信小程序', '小程序', '前端', 'Uniapp', 'Javascript']
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=129785440
    alt: 微信小程序登录流程与实现
artid: 129785440
render_with_liquid: false
---
<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     微信小程序登录流程与实现
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-light" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <p>
     在了解小程序登录之前，请大家先了解小程序的全局实例和全局组件，以方便理解本文的后续内容，已经了解的可以直接开始。
     <br/>
     <a href="https://blog.csdn.net/qq_44793507/article/details/129186566">
      全局实例和全局组件
     </a>
     （ 👈 点击直达）
    </p>
    <h4>
     <a id="_3">
     </a>
     微信小程序的登录流程
    </h4>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/3c697e9f8bdc2322f02292272cb24b06.jpeg#pic_center"/>
    </p>
    <h4>
     <a id="_6">
     </a>
     微信小程序的登录
    </h4>
    <p>
     首先需要写一个微信小程序的登录弹窗，登录弹窗的作用就是发起登录，让用户点击授权后登录小程序，该弹窗是一个全局弹窗，因为小程序是有分享功能的，如果新用户是从分享的链接进来的，那么会先让新用户登录再做后续操作。
     <br/>
     所以，登录功能得是一个组件，而且，登录必须是全局弹窗。
     <br/>
     在登录页面的
     <code>
      index.json
     </code>
     文件中，设置登录弹窗为组件
    </p>
    <pre><code class="prism language-js"><span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"component"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token string-property property">"usingComponents"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
     <span class="token comment">// xxxx.....</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <blockquote>
     <p>
      登录弹窗上需要有授权的选项，如果未勾选授权直接点击登录，需要提示用户先授权再登录
     </p>
    </blockquote>
    <p>
     用户勾选授权后，点击登录。 小程序登录需要使用
     <code>
      button
     </code>
     组件，将
     <code>
      button
     </code>
     组件的
     <code>
      open-type
     </code>
     的值设置为
     <code>
      getPhoneNumber
     </code>
     ，当用户点击并同意之后，可以通过
     <code>
      bindgetphonenumber
     </code>
     事件回调获取到动态令牌
     <code>
      code
     </code>
     ，然后把
     <code>
      code
     </code>
     传到开发者后台，并在开发者后台调用微信后台提供的
     <code>
      phonenumber.getPhoneNumber
     </code>
     接口，消费
     <code>
      code
     </code>
     来换取用户手机号。并且每个
     <code>
      code
     </code>
     有效期为
     <code>
      5
     </code>
     分钟，且只能消费一次。
     <br/>
     <a href="https://developers.weixin.qq.com/miniprogram/dev/framework/open-ability/getPhoneNumber.html#%E8%BF%94%E5%9B%9E%E5%8F%82%E6%95%B0%E8%AF%B4%E6%98%8E" rel="nofollow">
      open-type="getPhoneNumber"使用文档
     </a>
     （ 👈 点击直达）
    </p>
    <blockquote>
     <p>
      注：
      <code>
       getPhoneNumber
      </code>
      返回的
      <code>
       code
      </code>
      与
      <code>
       wx.login
      </code>
      返回的
      <code>
       code
      </code>
      作用是不一样的，不能混用。
     </p>
    </blockquote>
    <pre><code class="prism language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">open-type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>getPhoneNumber<span class="token punctuation">"</span></span> <span class="token attr-name">bindgetphonenumber</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>handleConfirm<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
</code></pre>
    <pre><code class="prism language-js">  <span class="token literal-property property">data</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token literal-property property">show</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>     <span class="token comment">// 登录弹窗是否显示</span>
    <span class="token literal-property property">selected</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>  <span class="token comment">// 是否勾选授权</span>
    <span class="token literal-property property">loginSuccess</span><span class="token operator">:</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span>
    <span class="token literal-property property">loginFail</span><span class="token operator">:</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  
    <span class="token comment">// 确认授权手机号-这里可以做节流操作，防止用户点击次数过多，为了便于演示，这里未做节流</span>
    <span class="token keyword">async</span> <span class="token function">handleConfirm</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">const</span> <span class="token punctuation">{<!-- --></span>selected<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>data
      <span class="token comment">// 用户未勾选，提示请勾选</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>selected<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        wx<span class="token punctuation">.</span><span class="token function">showToast</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
          <span class="token literal-property property">title</span><span class="token operator">:</span> <span class="token string">'请同意《用户隐私协议》'</span><span class="token punctuation">,</span>
          <span class="token literal-property property">icon</span><span class="token operator">:</span> <span class="token string">'none'</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// data.detail.code就是获取手机号的动态令牌</span>
      <span class="token keyword">let</span> info <span class="token operator">=</span> data<span class="token punctuation">.</span>detail
      <span class="token keyword">let</span> fail <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>loginFail
      <span class="token keyword">if</span> <span class="token punctuation">(</span>info<span class="token punctuation">.</span>code<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// info.code就是手机号动态令牌</span>
        
        <span class="token comment">/**新版本微信小程序不需要提前调用wx.login进行登录，这里的写法是为了实配老版本，在获取手机号授权登录之前先调用wx.login
           这里的app.globalData.userInfo为全局挂载的userInfo，关于userInfo的解释在本文下方
        */</span>
        <span class="token comment">/* 使用awiat阻塞进程 */</span>
        <span class="token keyword">await</span> app<span class="token punctuation">.</span>globalData<span class="token punctuation">.</span>userInfo<span class="token punctuation">.</span><span class="token function">_getLoginCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">// wx.login登录</span>
        <span class="token comment">// 调用了wx.login后进入下一步</span>
        
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setPhoneInfo</span><span class="token punctuation">(</span>info<span class="token punctuation">)</span>  <span class="token comment">// 绑定手机号-获取手机号授权用户登录功能</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        fail <span class="token operator">&amp;&amp;</span> <span class="token function">fail</span><span class="token punctuation">(</span>info<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    

<span class="token comment">// 绑定手机号-获取手机号授权用户登录功能</span>
<span class="token function">setPhoneInfo</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">let</span> success <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>loginSuccess
  <span class="token keyword">let</span> fail <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>loginFail
  <span class="token comment">// data.jsCode保存通过login获取的code</span>
  data<span class="token punctuation">.</span>jsCode <span class="token operator">=</span> app<span class="token punctuation">.</span>globalData<span class="token punctuation">.</span>userInfo<span class="token punctuation">.</span>code
  <span class="token comment">// 手机号动态令牌</span>
  data<span class="token punctuation">.</span>phoneCode <span class="token operator">=</span> data<span class="token punctuation">.</span>code 
  <span class="token comment">// 调用用户登录接口，removeNull其实是一个封装的方法， 用来去掉空格，本质就是传了一个data</span>
  <span class="token function">getLoginSession</span><span class="token punctuation">(</span><span class="token function">removeNull</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token parameter">res</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// then为登录成功，存入token</span>
    wx<span class="token punctuation">.</span><span class="token function">setStorageSync</span><span class="token punctuation">(</span><span class="token string">'token'</span><span class="token punctuation">,</span> res<span class="token punctuation">.</span>data<span class="token punctuation">)</span>
    <span class="token comment">// 手机号授权算登录成功</span>
    success <span class="token operator">&amp;&amp;</span> <span class="token function">success</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">// 设置全局userInfo属性,isLogin = true，表示登录成功</span>
    app<span class="token punctuation">.</span>globalData<span class="token punctuation">.</span>userInfo<span class="token punctuation">.</span>isLogin <span class="token operator">=</span> <span class="token boolean">true</span>
    <span class="token comment">// 清除等待列表</span>
    wx<span class="token punctuation">.</span>queue<span class="token punctuation">.</span><span class="token function">asyncExe</span><span class="token punctuation">(</span><span class="token string">"login_back"</span><span class="token punctuation">)</span>
    <span class="token comment">// 调用全局的_getUserInfo方法,传入'login'参数</span>
    <span class="token keyword">await</span> app<span class="token punctuation">.</span>globalData<span class="token punctuation">.</span>userInfo<span class="token punctuation">.</span><span class="token function">_getUserInfo</span><span class="token punctuation">(</span><span class="token string">'login'</span><span class="token punctuation">)</span>
    <span class="token comment">// 关闭弹框</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">hideLogin</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token parameter">e</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span>data<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">"已绑定"</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      success <span class="token operator">&amp;&amp;</span> <span class="token function">success</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      wx<span class="token punctuation">.</span><span class="token function">setStorageSync</span><span class="token punctuation">(</span><span class="token string">"token"</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span>data<span class="token punctuation">)</span>
      <span class="token keyword">await</span> app<span class="token punctuation">.</span>globalData<span class="token punctuation">.</span>userInfo<span class="token punctuation">.</span><span class="token function">_getUserInfo</span><span class="token punctuation">(</span><span class="token string">'login'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
      fail <span class="token operator">&amp;&amp;</span> <span class="token function">fail</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 关闭弹框</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">hideLogin</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>


<span class="token comment">// 关闭弹框</span>
<span class="token function">hideLogin</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">// 关闭弹框</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
        <span class="token literal-property property">show</span><span class="token operator">:</span> <span class="token boolean">false</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isPopup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token comment">// 显示tabbar()</span>
          <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getTabBar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">300</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
 <span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre>
    <p>
     旧版本的微信小程序是需要提前调用
     <code>
      wx.login
     </code>
     获取
     <code>
      code
     </code>
     才能进行下一步操作，而新版本则不需要提前调用
     <code>
      wx.login
     </code>
     进行登录。
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/3b569c08bc4419621b9e1c1b398de32b.png">
      <br/>
      <a href="https://developers.weixin.qq.com/miniprogram/dev/api/open-api/login/wx.login.html" rel="nofollow">
       wx.login文档
      </a>
      （ 👈 点击直达）
     </img>
    </p>
    <p>
     下面是
     <code>
      userInfo.js
     </code>
     文件，该文件内部创建了一个
     <code>
      class
     </code>
     类，该类会挂载到全局实例身上
    </p>
    <pre><code class="prism language-js"><span class="token comment">// userInfo.js</span>
<span class="token keyword">import</span> <span class="token punctuation">{<!-- --></span>
  getUserInfo
<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../service/user'</span>
<span class="token keyword">class</span> <span class="token class-name">UserInfo</span> <span class="token punctuation">{<!-- --></span>
  code <span class="token operator">=</span> <span class="token string">''</span> <span class="token comment">// 用户授权登录时需要用到的code</span>
  isLogin <span class="token operator">=</span> <span class="token boolean">false</span> <span class="token comment">// 判断用户是否已经登录拿到token</span>
  isInfo <span class="token operator">=</span> <span class="token boolean">false</span>  <span class="token comment">// 判断用户是否已经登录了</span>

  <span class="token comment">/**
   * 获取用户信息
   */</span>
  <span class="token function">_getUserInfo</span><span class="token punctuation">(</span><span class="token parameter">type</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span>reject</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{<!-- --></span>
      <span class="token comment">// isInfo初始化为false，表示未登录过，如登录过isInfo = true,如果登录过则直接获取本地的token</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span>type<span class="token operator">==</span><span class="token string">"login"</span><span class="token operator">&amp;&amp;</span><span class="token keyword">this</span><span class="token punctuation">.</span>isInfo<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">resolve</span><span class="token punctuation">(</span>wx<span class="token punctuation">.</span><span class="token function">getStorageSync</span><span class="token punctuation">(</span><span class="token string">'userInfo'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>isInfo <span class="token operator">=</span> <span class="token boolean">true</span>
      <span class="token comment">// 调用获取用户信息的接口</span>
      <span class="token function">getUserInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token operator">=&gt;</span><span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 如果返回200，拿到token以后，保存用户的信息，主要是名称和头像</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>res<span class="token punctuation">.</span>code <span class="token operator">==</span> <span class="token number">200</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token comment">// 保存用户信息到本地</span>
          wx<span class="token punctuation">.</span><span class="token function">setStorageSync</span><span class="token punctuation">(</span><span class="token string">'userInfo'</span><span class="token punctuation">,</span> res<span class="token punctuation">.</span>data<span class="token punctuation">)</span>
          <span class="token comment">// resolve返回</span>
          <span class="token function">resolve</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 不等于200 isInfo = false，表示已经登录过，重新获取即可</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>isInfo <span class="token operator">=</span> <span class="token boolean">false</span>
        <span class="token comment">// 不等于200 返回错误信息</span>
        <span class="token function">reject</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 不等于200 isInfo = false，表示已经登录过，重新获取即可</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>isInfo <span class="token operator">=</span> <span class="token boolean">false</span>
        <span class="token comment">// 不等于200 返回错误信息</span>
        <span class="token function">reject</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * 通过wx.login获取code
   * 不全局调用，每次授权调用Login方法前，都重新获取一次
   */</span>
  <span class="token keyword">async</span> <span class="token function">_getLoginCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">const</span> loginCodeRes <span class="token operator">=</span> <span class="token keyword">await</span> wx<span class="token punctuation">.</span>p<span class="token punctuation">.</span><span class="token function">login</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>loginCodeRes<span class="token punctuation">)</span>
      <span class="token comment">/**loginCodeRes.code : 用户登录凭证（有效期五分钟）。开发者需要在开发者服务器后台调用 code2Session，使用 code 换取 openid、unionid、session_key 等信息 */</span>

      <span class="token comment">// 将该code挂载到全局的global.userInfo中</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>code <span class="token operator">=</span> loginCodeRes<span class="token punctuation">.</span>code
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>error<span class="token punctuation">,</span> <span class="token string">'get jscode error'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> UserInfo
</code></pre>
    <pre><code class="prism language-js"><span class="token comment">// app.js</span>
<span class="token keyword">import</span> UserInfo <span class="token keyword">from</span> <span class="token string">'./private/UserInfo'</span>

<span class="token function">App</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
  <span class="token comment">/** 小程序生命周期，全局调用一次onLaunch */</span>
  <span class="token function">onLaunch</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">/**new UserInfo() */</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>globalData<span class="token punctuation">.</span>userInfo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UserInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>

  <span class="token function">onShow</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  
  <span class="token literal-property property">globalData</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token literal-property property">userInfo</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>   <span class="token comment">/**private -&gt; UserInfo的属性和方法挂载到这里 */</span>
    <span class="token literal-property property">show</span><span class="token operator">:</span><span class="token boolean">false</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre>
    <hr/>
    <h4>
     <a id="_208">
     </a>
     流程总结
    </h4>
    <p>
     通过
     <code>
      getPhoneNumber
     </code>
     的方式登录
    </p>
    <p>
     1、
     <code>
      components
     </code>
     中创建
     <code>
      auth
     </code>
     文件夹，该文件夹就是内的
     <code>
      html
     </code>
     就是小程序的登录弹窗，
     <code>
      auth
     </code>
     是一个全局组件，在
     <code>
      app.json
     </code>
     中挂载
    </p>
    <p>
     2、在
     <code>
      private
     </code>
     文件夹中封装小程序的登录方法 ——&gt;
     <code>
      UserInfo.js
     </code>
     ——&gt;
     <code>
      js
     </code>
     文件内创建
     <code>
      class
     </code>
     类，在
     <code>
      class
     </code>
     中
     <code>
      封装方法并导出
     </code>
    </p>
    <p>
     3、在
     <code>
      app.js
     </code>
     的
     <code>
      onLaunch
     </code>
     中
     <code>
      new UserInfo
     </code>
     获取之前封装好的小程序登录方法，该方法挂载到
     <code>
      globalData.userInfo
     </code>
     中
    </p>
    <pre><code class="prism language-js"><span class="token keyword">import</span> UserInfo <span class="token keyword">from</span> <span class="token string">'./private/UserInfo'</span>
<span class="token function">App</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
    <span class="token function">onLaunch</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>globalData<span class="token punctuation">.</span>userInfo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UserInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre>
    <p>
     4、
     <code>
      auth
     </code>
     文件夹为小程序的全局授权登录弹窗，从基础库
     <code>
      2.21.2
     </code>
     开始，对获取手机号的接口进行了安全升级，新版小程序需要用户自动触发才能获取手机号接口，需用
     <a href="https://developers.weixin.qq.com/miniprogram/dev/component/button.html" rel="nofollow">
      button
     </a>
     组件的点击来触发。新版小程序不再需要提前调用
     <code>
      wx.login
     </code>
     进行登录
    </p>
    <pre><code class="prism language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">open-type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>getPhoneNumber<span class="token punctuation">"</span></span> <span class="token attr-name">bindgetphonenumber</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>getPhoneNumber<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
</code></pre>
    <pre><code class="prism language-js"><span class="token function">Page</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
  <span class="token function">getPhoneNumber</span> <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>detail<span class="token punctuation">.</span>code<span class="token punctuation">)</span>  <span class="token comment">// 该code就是动态令牌，用于换取用户手机号</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre>
    <p>
     需要将
     <a href="https://developers.weixin.qq.com/miniprogram/dev/component/button.html" rel="nofollow">
      button
     </a>
     组件
     <code>
      open-type
     </code>
     的值设置为
     <code>
      getPhoneNumber
     </code>
     ，当用户点击并同意之后，可以通过
     <code>
      bindgetphonenumber
     </code>
     事件回调获取到动态令牌
     <code>
      code
     </code>
     ，然后把
     <code>
      code
     </code>
     传到开发者后台，并在开发者后台调用微信后台提供的
     <a href="https://developers.weixin.qq.com/miniprogram/dev/api-backend/open-api/phonenumber/phonenumber.getPhoneNumber.html" rel="nofollow">
      phonenumber.getPhoneNumber
     </a>
     接口，消费
     <code>
      code
     </code>
     来换取用户手机号。每个
     <code>
      code
     </code>
     有效期为5分钟，且只能消费一次。
    </p>
    <blockquote>
     <p>
      注：
      <code>
       getPhoneNumber
      </code>
      返回的
      <code>
       code
      </code>
      与
      <code>
       wx.login
      </code>
      返回的
      <code>
       code
      </code>
      作用是不一样的，不能混用。
     </p>
    </blockquote>
    <p>
     5、用户点击弹框后，先让用户勾选协议，勾选后才允许点击登录，调用登录接口，将登录接口单独封装起来，将获取到的
     <code>
      code
     </code>
     手机号动态令牌当参数传入登录方法。
    </p>
    <blockquote>
     <p>
      新版本微信不许要提前调用
      <code>
       login
      </code>
      来获取
      <code>
       code
      </code>
      码，旧版本微信小程序是需要提前调用
      <code>
       login
      </code>
      获取
      <code>
       code
      </code>
      码
     </p>
     <p>
      为了演示，所以这里提前调用
      <code>
       wx.login
      </code>
      来获取
      <code>
       code
      </code>
      码，并将该
      <code>
       code
      </code>
      码存入全局
      <code>
       app.globalData.userInfo
      </code>
      中，需要注意的是，该
      <code>
       code
      </code>
      码的有效期是
      <code>
       5分钟
      </code>
     </p>
    </blockquote>
    <p>
     6、调用登录方法， 携带
     <code>
      code
     </code>
     手机号动态令牌和接口规定的必传参数，请求登录接口，返回
     <code>
      200
     </code>
     为登录成功，
    </p>
    <pre><code class="prism language-js"><span class="token number">1</span><span class="token punctuation">)</span>、将登录成功的token存入本地
	
<span class="token number">2</span><span class="token punctuation">)</span>、设置全局属性app<span class="token punctuation">.</span>globalData<span class="token punctuation">.</span>userInfo<span class="token punctuation">.</span>isLogin <span class="token operator">=</span> <span class="token boolean">true</span>表示登录成功
	
<span class="token number">3</span><span class="token punctuation">)</span>、清除等待列表
</code></pre>
    <p>
     7、调用获取用户信息接口，也就是全局挂载的
     <code>
      await app.globalData.userInfo._getUserInfo()
     </code>
     ，关闭登录弹框
    </p>
    <pre><code class="prism language-js"><span class="token keyword">await</span> app<span class="token punctuation">.</span>globalData<span class="token punctuation">.</span>userInfo<span class="token punctuation">.</span><span class="token function">_getUserInfo</span><span class="token punctuation">(</span><span class="token string">'login'</span><span class="token punctuation">)</span>
</code></pre>
    <p>
     8、获取用户信息接口，通过传入的参数判断是是否要登录，这里有两种情况：
    </p>
    <pre><code class="prism language-js"><span class="token number">1</span><span class="token punctuation">)</span>、用户已经登录了，只是想重新获取一下token
	
<span class="token number">2</span><span class="token punctuation">)</span>、用户第一次登录，要获取用户信息，例如头像、用户名称
</code></pre>
    <p>
     根据这两种情况，传入的参数
     <code>
      "login"
     </code>
     当然是不够的，所以需要再加一个状态，
     <code>
      isInfo
     </code>
     ，
     <code>
      isInfo
     </code>
     默认为
     <code>
      false
     </code>
    </p>
    <pre><code class="prism language-js">  <span class="token comment">/**
   * 获取用户信息
   */</span>
  <span class="token function">_getUserInfo</span><span class="token punctuation">(</span><span class="token parameter">type</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span>reject</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{<!-- --></span>
      <span class="token comment">// 用户登录过</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span>type<span class="token operator">==</span><span class="token string">"login"</span><span class="token operator">&amp;&amp;</span><span class="token keyword">this</span><span class="token punctuation">.</span>isInfo<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">resolve</span><span class="token punctuation">(</span>wx<span class="token punctuation">.</span><span class="token function">getStorageSync</span><span class="token punctuation">(</span><span class="token string">'userInfo'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        
      <span class="token comment">// 设置isInfo = true，因为下面要走获取用户信息流程，获取后，第二次调用_getUserInfo判断isInfo = true,直接return掉</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>isInfo <span class="token operator">=</span> <span class="token boolean">true</span>
      <span class="token comment">// 调用获取用户信息的接口</span>
      <span class="token function">getUserInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token operator">=&gt;</span><span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 如果返回200，拿到token以后，保存用户的信息，主要是名称和头像</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>res<span class="token punctuation">.</span>code <span class="token operator">==</span> <span class="token number">200</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token comment">// 保存用户信息到本地</span>
          wx<span class="token punctuation">.</span><span class="token function">setStorageSync</span><span class="token punctuation">(</span><span class="token string">'userInfo'</span><span class="token punctuation">,</span> res<span class="token punctuation">.</span>data<span class="token punctuation">)</span>
          <span class="token comment">// resolve返回</span>
          <span class="token function">resolve</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 不等于200 isInfo = false，表示已经登录过，重新获取即可</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>isInfo <span class="token operator">=</span> <span class="token boolean">false</span>
        <span class="token comment">// 不等于200 返回错误信息</span>
        <span class="token function">reject</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 不等于200 isInfo = false，表示已经登录过，重新获取即可</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>isInfo <span class="token operator">=</span> <span class="token boolean">false</span>
        <span class="token comment">// 不等于200 返回错误信息</span>
        <span class="token function">reject</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
</code></pre>
    <p>
     最后附上
     <a href="https://developers.weixin.qq.com/miniprogram/dev/framework/open-ability/login.html" rel="nofollow">
      微信官方对登录的说明
     </a>
     （ 👈 点击直达）
    </p>
    <p>
     以上就是微信小程序的登录流程，这些步骤都是按实际需求编写的，有些时候流程的2、3、4、5、6都是混着写的，大家可以根据项目的实际需求做自由调整。
    </p>
    <hr/>
    <p>
     如果觉得这篇文章对你有帮助，欢迎点赞、收藏、转发哦~
    </p>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
  <div class="blog-extension-box" id="blogExtensionBox" style="width:400px;margin:auto;margin-top:12px">
  </div>
 </article>
</div>


