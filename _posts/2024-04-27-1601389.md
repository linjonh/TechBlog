---
layout: post
title: "Access数据库它已经被别的用户以独占方式打开,操作必须使用一个可更新的查询,不能锁定文件"
date: 2024-04-27 17:29:12 +0800
description: "转自：http://iasp.bokee.com/  笔名：iasp由于网络开发过程，或者一些下载的"
keywords: "microsoft ace连接文件用的用户"
categories: ['数据库']
tags: ['服务器', '数据库', '加密', 'Asp', 'Asp', 'Access']
artid: "1601389"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=1601389
    alt: "Access数据库它已经被别的用户以独占方式打开,操作必须使用一个可更新的查询,不能锁定文件"
render_with_liquid: false
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     Access数据库：它已经被别的用户以独占方式打开,操作必须使用一个可更新的查询,不能锁定文件
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="htmledit_views" id="content_views">
    <p>
     转自：
     <a href="http://iasp.bokee.com/">
      http://iasp.bokee.com/
     </a>
     笔名：iasp
    </p>
    <p>
     由于网络开发过程，或者一些下载的例子工程一般都用Access数据库，因为它方便不需要服务器，以文件方式就可以访问。
    </p>
    <p>
     Access数据库在使用过程中一般都会遇到这些问题，希望解决正在为此问题困惑的朋友的问题。
    </p>
    <p>
     -------------------------------------------以下是引用内容-------------------------------------------------------------------
    </p>
    <p>
    </p>
    <table border="0" cellpadding="0" cellspacing="0" width="100%">
     <tbody>
      <tr>
       <td>
        篇首语：原来改mdb为asp就能防下载是鬼话。
        <br/>
        <br/>
        引子：昨天和animator试验了一下，把data.mdb文件改名为data.asp文件后放在wwwroot目录里。然后在IE中输入data.asp路径后，发现IE显示一片空白，右键-&gt;察看源文件，跳出记事本，将内容另存为.mdb文件，用ACCESS打开，发现需要密码，也就是说至少文件头被破坏。
        <br/>
        然后用Flashget试验下载data.asp文件，并另存为data.mdb文件，发现用ACCESS打开完好无损！！！看来，好一些编程人员在开发的时候都认为，改了mdb后缀为asp就能防下载的概念，是错的！后台数据库被下载对于一个asp+access的网站来说无疑是一场惨绝人寰的灾难。今天找了各方的文章，归纳一下有以下9种办法防止数据库被下载(欢迎补充)：
        <br/>
       </td>
      </tr>
     </tbody>
    </table>
    <br/>
    <br/>
    不用说，这是最最偷懒的方法，但是若攻击者通过第三方途径获得了数据库的路径)，就玩完了。比如说攻击者本来只能拿到list权，结果意外看到了数据库路径，就可以冠冕堂皇地把数据库下载回去研究了。另外，数据文件通常大小都比较大，起再隐蔽的文件名都瞒不了人。故保密性为最低。
    <br/>
    <br/>
    <br/>
    2.数据库名后缀改为ASA、ASP等
    <br/>
    <br/>
    此法须配合一些要进行一些设置，否则就会出现本文开头的那种情况
    <br/>
    <br/>
    (1)二进制字段添加(此招我还没有炼成-_-+)。
    <br/>
    <br/>
    (2)在这个文件中加入&lt;%或%&gt;，IIS就会按ASP语法来解析，然后就会报告500错误，自然不能下载了。可是如果只是简单的在数据库的文本或者备注字段加入&lt;%是没用的，因为ACCESS会对其中的内容进行处理，在数据库里他会以&lt; %的形式存在，无效！正确的方法是将&lt;%存入OLE对象字段里，这样我们的目的就能达到了。
    <br/>
    作方法：
    <br/>
    首先，用notepad新建一个内容为 &lt;% 的文本文件，随便起个名字存档。
    <br/>
    接着，用Access打开您的数据库文件，新建一个表，随便起个名字，在表中添加一个OLE对象的字段，然后添加一个记录，插入之前建立的文本文件，如果操作正确的话，应该可以看到一个新的名为"数据包＂的记录。即可
    <br/>
    <br/>
    <br/>
    3.数据库名前加"#"
    <br/>
    只需要把数据库文件前名加上#、然后修改数据库连接文件（如conn.asp）中的数据库地址。原理是下载的时候只能识别 #号前名的部分，对于后面的自动去掉，比如你要下载：http://www.pcdigest.com/date/#123.mdb(假设存在的话）。无论是IE还是FLASHGET等下到的都是http://www.test.com/date/index.htm(index.asp、default.jsp等你在IIS设置的首页文档)
    <br/>
    另外在数据库文件名中保留一些空格也起到类似作用，由于HTTP协议对地址解析的特殊性，空格会被编码为"%",如http://www.test.com/date/123  ;456.mdb，下载的时http://www.test.com/date/123 %456.mdb。而我们的目录就根本没有123%456.mdb这个文件，所以下载也是无效的这样的修改后，即使你暴露了数据库地址，一般情况下别人也是无法下载！
    <br/>
    <br/>
    <br/>
    4.加密数据库
    <br/>
    首先在选取"工具-&gt;安全-&gt;加密/解密数据库，选取数据库（如：employer.mdb），然后接确定，接着会出现"数据库加密后另存为"的窗口，存为：employer1.mdb。接着employer.mdb就会被编码，然后存为employer1.mdb..要注意的是，以上的动作并不是对数据库设置密码，而只是对数据库文件加以编码，目的是为了防止他人使用别的工具来查看数据库文件的内容。
    <br/>
    接下来我们为数据库加密，首先以打开经过编码了的  employer1.mdb，在打开时，选择"独占"方式。然后选取功能表的"工具-&gt;安全-&gt;设置数据库密码"， 接着输入密码即可。这样即使他人得到了employer1.mdb文件，没有密码他是无法看到 employer1.mdb的。
    <br/>
    加密后要修改数据库连接页， 如：
    <br/>
    conn.open "driver={microsoft access driver (*.mdb)};uid=admin;pwd=数据库密码;dbq=数据库路径"
    <br/>
    这样修改后，数据库即使被人下载了，别人也无法打开（前提是你的数据库连接页中的密码没有被泄露）
    <br/>
    但值得注意的是，由于Access数据库的加密机制比较简单，即使设置了密码，解密也很容易。该数据库系统通过将用户输入的密码与某一固定密钥进行"异或"来形成一个加密串，并将其存储在*.mdb文件从地址"&amp;H42"开始的区域内。所以一个好的程序员可以轻松制作一个几十行的小程序就可以轻松地获得任何Access数据库的密码。因此，只要数据库被下载，其信息安全依然是个未知数。
    <br/>
    <br/>
    <br/>
    5.数据库放在WEB目录外或将数据库连接文件放到其他虚拟目录下
    <br/>
    如你的WEB目录是e:/webroot，可以把数据库放到e:/data这个文件夹里，在e:/webroot里的数据库连接页中修改数据库连接地址为："../data/数据库名" 的形式，这样数据库可以正常调用，但是无法下载的，因为它不在WEB目录里！这个方法一般也不适合购买虚拟空间的用户。
    <br/>
    <br/>
    <br/>
    6.使用ODBC数据源。
    <br/>
    在ASP等程序设计中，如果有条件，应尽量使用ODBC数据源，不要把数据库名写在程序中，否则，数据库名将随ASP源代码的失密而一同失密，例如： DBPath = Server.MapPath("../123/abc/asfadf.mdb ")
    <br/>
    conn.open "driver={Microsoft Access Driver (*.mdb)};dbq="&amp; DBPath
    <br/>
    可见，即使数据库名字起得再怪异，隐藏的目录再深，ASP源代码失密后，也很容易被下载下来。如果使用ODBC数据源，就不会存在这样的问题了： conn.open "ODBC-DSN名" ,不过这样是比较烦的，目录移动的话又要重新设置数据源了，更方便的方法请看第7，8法！
    <br/>
    <br/>
    <br/>
    7.添加数据库名的如MDB的扩展映射
    <br/>
    这个方法就是通过修改IIS设置来实现，适合有IIS控制权的朋友，不适合购买虚拟主机用户(除非管理员已经设置了）。这个方法我认为是目前最好的。只要修改一处，整个站点的数据库都可以防止被下载。无须修改代码即使暴露目标地址也可以防止下载。
    <br/>
    我们在IIS属性---主目录---配置---映射---应用程序扩展那里添加.mdb文件的应用解析。注意这里的选择的DLL（或EXE等）似乎也不是任意的，选择不当，这个MDB文件还是可以被下载的，  注意最好不要选择选择asp.dll等。你可以自己多测试下
    <br/>
    这样修改后下载数据库如：http://www.test.com/data/dvbbs6.mdb。就出现（404或500等错误）
    <br/>
    <br/>
    <br/>
    8：使用.net的优越性
    <br/>
    动网的木鸟就写过一个防非法下载文件的"WBAL 防盗链工具"。具体可以登陆http://www.9seek.com/WBAL/  ;
    <br/>
    不过 那个只实现了防止非本地下载的 ，没有起到真正的防下载数据库的功能。不过这个方法已经跟5法差不多可以通过修改.NET文件，实现本地也不能下载！
    <br/>
    <br/>
    这几个方法中，只有第7和8个是统一性改的，一次修改配置后，整个站点的数据库都可以防止下载，其他几个就要分别修改数据库名和连接文件，比较麻烦，不过对于虚拟主机的朋友也只能这样了！
    <br/>
    <br/>
    其实第6个方法应该是第5个方法的扩展，可以实现特殊的功能，但对于不支持.net的主机或者怕设置麻烦的话，还是直接用第5个方法了，而且默认情况下第6个方法，依然可以通过复制连接到同主机的论坛或留言本发表，然后就可以点击下载了（因为这样的引用页是来自同主机的）
    <br/>
    <br/>
    9.利用NTFS分区的文件权限设置(by percyboy)
    <br/>
    我们已经知道，ASP.NET 中使用 ADO.NET 访问数据库，通过 OleDb 的连接可以访问 Access 数据库——我们非常常用的低端数据库之一。本文讨论了 ASP.NET 中可能看到的若干错误提示，从中看到 Access 2000 和 Access XP 创建的数据库文件，在访问出现错误时会出现不太相同的错误提示。希望对大家有所帮助。另一个要点是，希望通过此文，使大家对 ASP.NET 中 Access 数据库文件的 NTFS 权限设置有所新的认识。
    <br/>
    <br/>
    <br/>
    <br/>
    (一)实验过程
    <br/>
    <br/>
    <br/>
    为了叙述方便，举个具体例子做个实验：应用程序为 /test ，数据库存放在 D:/wwwroot/test/data/db1.mdb，我们已经知道在 ASP.NET 中是以一个叫做 ASPNET 虚拟用户的身份访问数据库的，我们需要给这个账户以特定的 NTFS 权限才能使 ASP.NET 程序正常运行。
    <br/>
    <br/>
    <br/>
    <br/>
    <br/>
    为了得到最严格的 NTFS 权限设置，实验开始时我们给程序最低的 NTFS 权限：
    <br/>
    <br/>
    a) D:/wwwroot/test/data/ 文件夹的给用户ASPNET以如下权限：
    <br/>
    允许  拒绝
    <br/>
    完全控制          □    □
    <br/>
    修改              □    □
    <br/>
    读取及运行        √    □
    <br/>
    列出文件夹目录    √    □
    <br/>
    读取              √    □
    <br/>
    写入              □    □
    <br/>
    <br/>
    b) D:/wwwroot/test/data/db1.mdb 文件本身给用户ASPNET以如下权限：
    <br/>
    √ 允许将来自父系的可继承权限传播给该对象
    <br/>
    <br/>
    <br/>
    <br/>
    <br/>
    1.1  对于某个只包含有"SELECT"命令的aspx程序，上述权限设置运行时无障碍，即：上述权限已经满足这类程序的运行了。
    <br/>
    <br/>
    <br/>
    <br/>
    1.2  对于包含有"UPDATE""INSERT""UPDATE"等命令的aspx程序，
    <br/>
    <br/>
    (a) 如果 db1.mdb 是 Access 2000 创建的数据库，出现如下错误：
    <br/>
    <br/>
    "/test"应用程序中的服务器错误。
    <br/>
    ---------------------------------------
    <br/>
    Microsoft Jet 数据库引擎打不开文件'D:/wwwroot/test/data/'。 它已经被别的用户以独占方式打开，或没有查看数据的权限。
    <br/>
    说明: 执行当前 Web 请求期间，出现未处理的异常。请检查堆栈跟踪信息，以了解有关该错误以及代码中导致错误的出处的详细信息。
    <br/>
    异常详细信息: System.Data.OleDb.OleDbException: Microsoft Jet 数据库引擎打不开文件'D:/wwwroot/test/data/'。 它已经被别的用户以独占方式打开，或没有查看数据的权限。
    <br/>
    <br/>
    <br/>
    <br/>
    (b) 如果 db1.mdb 是 Access XP 创建的数据库，出现如下错误：
    <br/>
    <br/>
    "/test"应用程序中的服务器错误。
    <br/>
    ----------------------------------------------
    <br/>
    操作必须使用一个可更新的查询。
    <br/>
    说明: 执行当前 Web 请求期间，出现未处理的异常。请检查堆栈跟踪信息，以了解有关该错误以及代码中导致错误的出处的详细信息。
    <br/>
    异常详细信息: System.Data.OleDb.OleDbException: 操作必须使用一个可更新的查询。
    <br/>
    <br/>
    <br/>
    <br/>
    (c) 原因初步分析：因为包含有"UPDATE""INSERT""UPDATE"等命令，需要对数据库文件本身进行写入操作，所以上述权限不能满足此需求，我们需要进一步放开权限。
    <br/>
    <br/>
    我们放开一些权限，
    <br/>
    a) D:/wwwroot/test/data/ 文件夹不变：
    <br/>
    <br/>
    b) D:/wwwroot/test/data/db1.mdb 文件本身给用户ASPNET以如下权限：
    <br/>
    允许  拒绝
    <br/>
    完全控制          □    □
    <br/>
    修改              □    □
    <br/>
    读取及运行        √    □
    <br/>
    列出文件夹目录    √    □
    <br/>
    读取              √    □
    <br/>
    写入              √    □
    <br/>
    <br/>
    <br/>
    <br/>
    <br/>
    <br/>
    1.3  放开权限后继续实验，
    <br/>
    <br/>
    (a) 如果 db1.mdb 是 Access 2000 创建的数据库，出现如下错误：
    <br/>
    <br/>
    "/test"应用程序中的服务器错误。
    <br/>
    ------------------------------------------
    <br/>
    不能锁定文件。
    <br/>
    说明: 执行当前 Web 请求期间，出现未处理的异常。请检查堆栈跟踪信息，以了解有关该错误以及代码中导致错误的出处的详细信息。
    <br/>
    异常详细信息: System.Data.OleDb.OleDbException: 不能锁定文件。
    <br/>
    <br/>
    <br/>
    <br/>
    (b) 如果 db1.mdb 是 Access XP 创建的数据库，没有出现错误。
    <br/>
    <br/>
    <br/>
    <br/>
    (c) 原因初步分析：我们发现在打开 Access 数据库时，同时会在所在目录生成一个同名的 *.ldb 文件，这是一个 Access 的锁定标记。鉴于此，我们猜测，用户 ASPNET 访问 Access 数据库时，也需要生成一个锁定标记，而该目录没有允许其写入，因此出错。至于 Access XP 创建的数据库为什么没有这个错误，原因还不得而知。
    <br/>
    <br/>
    我们进一步放开权限，
    <br/>
    a) D:/wwwroot/test/data/ 文件夹给用户ASPNET以如下权限：
    <br/>
    允许  拒绝
    <br/>
    完全控制          □    □
    <br/>
    修改              □    □
    <br/>
    读取及运行        √    □
    <br/>
    列出文件夹目录    √    □
    <br/>
    读取              √    □
    <br/>
    写入              √    □
    <br/>
    <br/>
    b) D:/wwwroot/test/data/db1.mdb 文件本身给用户ASPNET以如下权限：
    <br/>
    √ 允许将来自父系的可继承权限传播给该对象
    <br/>
    <br/>
    <br/>
    <br/>
    <br/>
    <br/>
    1.4 继续实验，发现错误已解决，那么上面这个权限就是我们需要放开的"最低权限"。
    <br/>
    <br/>
    (a) 如果 db1.mdb 是 Access 2000 创建的数据库，我们会发现一个小问题：生成的 *.ldb 文件不会自己删除，访问后该文件依然存在，但这个问题不会影响 ASP.NET 的正常运行。
    <br/>
    <br/>
    <br/>
    <br/>
    (b) 如果 db1.mdb 是 Access XP 创建的数据库，没有出现上面类似问题。
    <br/>
    <br/>
    <br/>
    <br/>
    (c) 原因初步分析：我们仅仅是给了 ASPNET 以写入文件夹的权限，没有给它修改的权限，所以文件一旦写入，便无法修改其内容，*.ldb 也就删除不掉了。
    <br/>
    <br/>
    <br/>
    <br/>
    如果非要解决这个问题，进一步放开权限为：
    <br/>
    a) D:/wwwroot/test/data/ 文件夹给用户ASPNET以如下权限：
    <br/>
    允许  拒绝
    <br/>
    完全控制          □    □
    <br/>
    修改              √    □
    <br/>
    读取及运行        √    □
    <br/>
    列出文件夹目录    √    □
    <br/>
    读取              √    □
    <br/>
    写入              √    □
    <br/>
    <br/>
    b) D:/wwwroot/test/data/db1.mdb 文件本身给用户ASPNET以如下权限：
    <br/>
    √ 允许将来自父系的可继承权限传播给该对象
    <br/>
    <br/>
    <br/>
    <br/>
    <br/>
    <br/>
    1.5  附带着，实验另一种情形：我们把 db1.mdb 在 Access 打开编辑，同时访问 ASP.NET。
    <br/>
    <br/>
    (a) 如果 db1.mdb 是 Access 2000 创建的数据库，我们发现并没有出现什么问题。
    <br/>
    <br/>
    <br/>
    (b) 如果 db1.mdb 是 Access XP 创建的数据库，出现如下错误：
    <br/>
    <br/>
    "/zhao"应用程序中的服务器错误。
    <br/>
    ------------------------------------------------
    <br/>
    不能使用 ''；文件已在使用中。
    <br/>
    说明: 执行当前 Web 请求期间，出现未处理的异常。请检查堆栈跟踪信息，以了解有关该错误以及代码中导致错误的出处的详细信息。
    <br/>
    异常详细信息: System.Data.OleDb.OleDbException: 不能使用 ''；文件已在使用中。
    <br/>
    <br/>
    <br/>
    <br/>
    (c) 原因初步分析：Access 数据库是单用户单线程的数据库，我们在 Access 里面打开编辑数据库文件时其实是以当前 Windows 用户(比如Administrator)身份打开数据库，而 ASP.NET 默认使用的是 ASPNET 虚拟用户（隶属于 Users 组），级别低于 Administrator，无法和 Administrator "抢夺"权限，所以出现冲突错误。至于 Access 2000 忽略这个问题的情形我们也不必做讨论了，可能是 Access 2000 没有考虑那么多因素吧。
    <br/>
    <br/>
    <br/>
    <br/>
    1.6  再附带一种情形：将 db1.mdb 的属性改为"只读"，无论是 Access 2000 还是 Access XP 都将分别出现与 1.2 中各自的错误相同的错误提示。
    <br/>
    <br/>
    <br/>
    <br/>
    (二)实验结论
    <br/>
    <br/>
    <br/>
    (1) 我们首先再次总结一下 Access 数据库文件的 NTFS 权限设置的缘起：
    <br/>
    <br/>
    在 ASP.NET 中默认是以一个叫做 ASPNET 的虚拟用户的身份来访问、操作数据库的，你可以在"控制面板"-"管理工具"-"计算机管理"-"本地用户和组"-"用户"中看到这个用户，默认情况下是：
    <br/>
    <br/>
    全名：ASP.NET 计算机帐户
    <br/>
    描述为：用于运行 ASP.NET 辅助进程(aspnet_wp.exe)的帐户。
    <br/>
    隶属于：Users组。
    <br/>
    <br/>
    使用这么一个隶属于 Users 组的用户来进行文件操作、数据库操作的风险是要比用一个 Administrators 组的用户的风险要小得多，这也是 ASP.NET 在安全方面的一个考虑吧。
    <br/>
    <br/>
    既然是这么一个用户需要访问、操作数据库文件本身，那么我们就需要给它一定的 NTFS 权限以允许它的访问。显然没有 NTFS 的权限许可，ASPNET 就无法访问、操作数据库，就会出现上面实验中所看到的那些错误了。
    <br/>
    <br/>
    <br/>
    (2) 经过上面的实验，我们已经知道如下的 NTFS 权限设置是可以满足一般需求的：
    <br/>
    <br/>
    a) D:/wwwroot/test/data/ 文件夹给用户ASPNET以如下权限：
    <br/>
    允许  拒绝
    <br/>
    完全控制          □    □
    <br/>
    修改              □    □
    <br/>
    读取及运行        √    □
    <br/>
    列出文件夹目录    √    □
    <br/>
    读取              √    □
    <br/>
    写入              √    □
    <br/>
    <br/>
    b) D:/wwwroot/test/data/db1.mdb 文件本身给用户ASPNET以如下权限：
    <br/>
    √ 允许将来自父系的可继承权限传播给该对象
    <br/>
    <br/>
    <br/>
    同时我们也注意到 db1.mdb 是否为"只读"文件对 ASPNET 的访问也会有一定影响。
    <br/>
    <br/>
    <br/>
    <br/>
    (3) 上述权限设置可以直接设置给 ASPNET 用户自己，也可以设置给 Users 组，或者直接给 Everyone 组上述权限都是可以的。因为 ASPNET 隶属于 Users 组，可以通过 用户组 给 ASPNET 设置权限。
    <br/>
    <br/>
    <br/>
    <br/>
    (4) NTFS 权限在文件或文件夹右击后得到的"属性"对话框-"安全"选项卡中设置，一般情况下，可以考虑给 Adminitrators 组以"完全控制"的权限，同时不要轻易在"拒绝"中打勾，有关 NTFS 权限设置的技巧，可以咨询网络管理员、网络安全专家的建议。
    <br/>
    <br/>
    注：FAT, FAT32 格式的分区中不支持 NTFS 权限。
    <br/>
    <br/>
    <br/>
    <br/>
    (5) Windows 2000 系列，Windows Server 2003 系列的"安全"选项卡默认是很容易找到的，但 Windows XP Professional 中的"安全"选项卡默认是关闭的，可以将"控制面板"-"文件夹选项"-"查看"选项卡中的"高级设置"中"使用简单共享（推荐）"一项的"√"去除，"确定"之后，再次按照上面的方法即可看到"安全"选项卡了。
    <br/>
    <br/>
    <br/>
    ===========
    <br/>
    综上所述，2、3、4法一起使用，是防止数据库被下载最基本，最行之有效的方法，既适用于对服务器有管辖权的网管，又适用于虚拟主机的用户，推荐每一个制作者同时必用这三种方法
    <br/>
    <br/>
    若你对服务器拥有管辖权，推荐再加上方法9，你的ACCESS数据库的安全性就可以大大提高了
    <p>
    </p>
   </div>
  </div>
 </article>
 <p alt="68747470733a2f2f:626c6f672e6373646e2e6e65742f677569736875616e676c69:6e2f61727469636c652f64657461696c732f31363031333839" class_="artid" style="display:none">
 </p>
</div>


