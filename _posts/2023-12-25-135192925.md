---
layout: post
title: "C通讯关于Winform中的简单的Http服务器与客户端"
date: 2023-12-25 11:10:03 +0800
description: "文章浏览阅读5k次，点赞28次，C#通讯——关于Winform中的简单的Http服务器与客户端"
keywords: "C#通讯——关于Winform中的简单的Http服务器与客户端"
categories: ['C']
tags: ['服务器', 'Http', 'C']
artid: "135192925"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=135192925
    alt: "C通讯关于Winform中的简单的Http服务器与客户端"
render_with_liquid: false
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     C#通讯——关于Winform中的简单的Http服务器与客户端
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-light" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <p>
    </p>
    <div class="toc">
     <h4>
      C#通讯——关于Winform中的简单的Http服务器与客户端
     </h4>
     <ul>
      <li>
       <a href="#_6" rel="nofollow">
        前言
       </a>
      </li>
      <li>
       <a href="#Http_11" rel="nofollow">
        一、Http是什么？
       </a>
      </li>
      <li>
       <a href="#Http_29" rel="nofollow">
        二、简单的Http服务器
       </a>
      </li>
      <li>
       <a href="#Http_142" rel="nofollow">
        三、简单的Http客户端
       </a>
      </li>
      <li>
       <a href="#_205" rel="nofollow">
        四、实际调用
       </a>
      </li>
      <li>
       <a href="#WinformHttpWebApi_282" rel="nofollow">
        五、Winform中Http服务器和WebApi的区别？
       </a>
      </li>
     </ul>
    </div>
    <p>
    </p>
    <hr/>
    <h2>
     <a id="_6">
     </a>
     前言
    </h2>
    <p>
     在实际项目中通讯的交互的过程中，遇见数据传输时同事和我说用WebApi，Get，Post等等，以前没用搞过这个块的我傻傻分不清。查询资料了解过后发现只是个简单的Http交互通讯，在此记录下Winform中的简单服务器和客户端的编写，并简要描述webapi与http通讯的差异。
    </p>
    <hr/>
    <h2>
     <a id="Http_11">
     </a>
     一、Http是什么？
    </h2>
    <p>
     HTTP（Hypertext Transfer Protocol）是一种用于在网络上传输超文本的协议。它是一个用于传输和交换超文本、图像、视频、音频以及其他多媒体资源的应用层协议。
    </p>
    <p>
     HTTP是Web的基础，它定义了客户端和服务器之间的通信规则。通常，当你在浏览器中输入网址、点击链接或者提交表单时，浏览器会发送HTTP请求到服务器，服务器收到请求后进行处理，然后返回HTTP响应给客户端（浏览器），最终在你的浏览器上显示网页内容。
    </p>
    <p>
     <mark>
      HTTP协议的主要特点包括：
     </mark>
    </p>
    <ul>
     <li>
      无状态性（Stateless）：
      <br/>
      HTTP协议本身是无状态的，每个请求都是相互独立的，服务器并不会保留前后请求之间的状态信息。这导致每个请求都需要包含足够的信息来被服务器正确处理，比如会话标识或者其他验证信息。
     </li>
     <li>
      基于请求-响应模型：
      <br/>
      客户端发送请求给服务器，服务器处理请求并返回响应。这个
      <mark>
       请求-响应
      </mark>
      模型是HTTP的核心概念，通过这种方式客户端能够请求不同资源并且服务器能够提供响应。
     </li>
     <li>
      支持多种请求方法：
      <br/>
      HTTP定义了一系列请求方法（也称为HTTP谓词），包括GET（用于获取资源）、POST（用于提交数据给服务器）、PUT（用于更新资源）、DELETE（用于删除资源）等。
     </li>
     <li>
      URL定位资源：
      <br/>
      每个HTTP请求都包含一个URL（Uniform Resource Locator），用于指定被请求的资源的位置。
     </li>
     <li>
      无连接性：
      <br/>
      HTTP协议本身是无连接的，即
      <mark>
       每次请求完成后，连接会立即关闭
      </mark>
      。这意味着每个请求都需要重新建立连接，可能会造成一定的性能开销。
     </li>
    </ul>
    <h2>
     <a id="Http_29">
     </a>
     二、简单的Http服务器
    </h2>
    <pre><code class="prism language-csharp"><span class="token keyword">using</span> <span class="token namespace">System</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Collections<span class="token punctuation">.</span>Generic</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Net</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Threading<span class="token punctuation">.</span>Tasks</span><span class="token punctuation">;</span>

<span class="token keyword">namespace</span> <span class="token namespace">httpServer</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">class</span> <span class="token class-name">HttpServer_DP</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name"><span class="token keyword">string</span></span> mUrl<span class="token punctuation">;</span> <span class="token comment">// 服务器监听的URL</span>
        <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">HttpListener</span> mListener<span class="token punctuation">;</span> <span class="token comment">// HttpListener实例</span>
        <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">Dictionary<span class="token punctuation">&lt;</span><span class="token keyword">string</span><span class="token punctuation">,</span> Func<span class="token punctuation">&lt;</span>HttpListenerContext<span class="token punctuation">,</span> Task<span class="token punctuation">&lt;</span><span class="token keyword">string</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> mRoutes<span class="token punctuation">;</span> <span class="token comment">// 路由映射</span>

        <span class="token comment">// 构造函数，接收服务器监听地址和端口的数组</span>
        <span class="token keyword">public</span> <span class="token function">HttpServer_DP</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> prefixes<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>HttpListener<span class="token punctuation">.</span>IsSupported<span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">NotSupportedException</span><span class="token punctuation">(</span><span class="token string">"HttpListener is not supported on this platform."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            mListener <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">HttpListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 初始化HttpListener实例</span>
            mRoutes <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Dictionary<span class="token punctuation">&lt;</span><span class="token keyword">string</span><span class="token punctuation">,</span> Func<span class="token punctuation">&lt;</span>HttpListenerContext<span class="token punctuation">,</span> Task<span class="token punctuation">&lt;</span><span class="token keyword">string</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 初始化路由映射字典</span>

            <span class="token comment">// 为服务器添加监听地址和端口</span>
            <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> prefix <span class="token keyword">in</span> prefixes<span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                mListener<span class="token punctuation">.</span>Prefixes<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>prefix<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            mUrl <span class="token operator">=</span> prefixes<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 记录第一个监听地址</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">bool</span></span> IsOpen <span class="token punctuation">{<!-- --></span> <span class="token keyword">get</span> <span class="token punctuation">{<!-- --></span> <span class="token keyword">return</span> mListener<span class="token punctuation">.</span>IsListening<span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span>

        <span class="token comment">// 启动服务器</span>
        <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            mListener<span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$"Server started and listening on </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token expression language-csharp">mUrl</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            mListener<span class="token punctuation">.</span><span class="token function">BeginGetContext</span><span class="token punctuation">(</span>ProcessRequestCallback<span class="token punctuation">,</span> mListener<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 处理客户端请求</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 停止服务器</span>
        <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            mListener<span class="token punctuation">.</span><span class="token function">Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            mListener<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"Server stopped."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 添加路由和处理程序的映射关系</span>
        <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">AddRoute</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> route<span class="token punctuation">,</span> <span class="token class-name">Func<span class="token punctuation">&lt;</span>HttpListenerContext<span class="token punctuation">,</span> Task<span class="token punctuation">&lt;</span><span class="token keyword">string</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> handler<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            mRoutes<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>route<span class="token punctuation">,</span> handler<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 处理客户端请求的回调函数</span>
        <span class="token keyword">private</span> <span class="token keyword">async</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">ProcessRequestCallback</span><span class="token punctuation">(</span><span class="token class-name">IAsyncResult</span> result<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">HttpListener</span> listener <span class="token operator">=</span> <span class="token punctuation">(</span>HttpListener<span class="token punctuation">)</span>result<span class="token punctuation">.</span>AsyncState<span class="token punctuation">;</span>

            <span class="token comment">// 开始下一个请求的监听</span>
            listener<span class="token punctuation">.</span><span class="token function">BeginGetContext</span><span class="token punctuation">(</span>ProcessRequestCallback<span class="token punctuation">,</span> listener<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">try</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// 获取传入的请求</span>
                <span class="token class-name">HttpListenerContext</span> context <span class="token operator">=</span> listener<span class="token punctuation">.</span><span class="token function">EndGetContext</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment">// 获取请求方法和URL路径</span>
                <span class="token class-name"><span class="token keyword">string</span></span> httpMethod <span class="token operator">=</span> context<span class="token punctuation">.</span>Request<span class="token punctuation">.</span>HttpMethod<span class="token punctuation">;</span>
                <span class="token class-name"><span class="token keyword">string</span></span> responseString <span class="token operator">=</span> <span class="token string">"No Data!"</span><span class="token punctuation">;</span> <span class="token comment">// 默认响应字符串</span>
                <span class="token class-name"><span class="token keyword">string</span></span> url <span class="token operator">=</span> context<span class="token punctuation">.</span>Request<span class="token punctuation">.</span>Url<span class="token punctuation">.</span>AbsolutePath<span class="token punctuation">;</span>
                <span class="token class-name">Func<span class="token punctuation">&lt;</span>HttpListenerContext<span class="token punctuation">,</span> Task<span class="token punctuation">&lt;</span><span class="token keyword">string</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> handler<span class="token punctuation">;</span>

                <span class="token comment">// 如果请求路径存在于路由映射中，执行相应的处理程序</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>mRoutes<span class="token punctuation">.</span><span class="token function">TryGetValue</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token keyword">out</span> handler<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">{<!-- --></span>
                    responseString <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">handler</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 获取处理程序返回的响应数据</span>

                    <span class="token comment">// 将响应数据编码成字节数组</span>
                    <span class="token class-name"><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> buffer <span class="token operator">=</span> System<span class="token punctuation">.</span>Text<span class="token punctuation">.</span>Encoding<span class="token punctuation">.</span>UTF8<span class="token punctuation">.</span><span class="token function">GetBytes</span><span class="token punctuation">(</span>responseString<span class="token punctuation">)</span><span class="token punctuation">;</span>

                    <span class="token comment">// 设置响应的内容长度和状态码</span>
                    context<span class="token punctuation">.</span>Response<span class="token punctuation">.</span>ContentLength64 <span class="token operator">=</span> buffer<span class="token punctuation">.</span>Length<span class="token punctuation">;</span>
                    context<span class="token punctuation">.</span>Response<span class="token punctuation">.</span>StatusCode <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>HttpStatusCode<span class="token punctuation">.</span>OK<span class="token punctuation">;</span>

                    <span class="token comment">// 将响应写入输出流并关闭输出流</span>
                    context<span class="token punctuation">.</span>Response<span class="token punctuation">.</span>OutputStream<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span>buffer<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> buffer<span class="token punctuation">.</span>Length<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    context<span class="token punctuation">.</span>Response<span class="token punctuation">.</span>OutputStream<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">else</span>
                <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">// 如果请求路径不存在于路由映射中，返回404 Not Found</span>
                    context<span class="token punctuation">.</span>Response<span class="token punctuation">.</span>StatusCode <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>HttpStatusCode<span class="token punctuation">.</span>NotFound<span class="token punctuation">;</span>
                    context<span class="token punctuation">.</span>Response<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ex<span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$"Error processing request: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token expression language-csharp">ex<span class="token punctuation">.</span>Message</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     <mark>
      需要注意的是：Dictionary&lt;string, Func&lt;HttpListenerContext, Task&gt;&gt; mRoutes; // 路由映射
     </mark>
     <br/>
     <mark>
      为了方便根据客户端传入的URL的不同路径来选择进行不同的处理流程
     </mark>
    </p>
    <h2>
     <a id="Http_142">
     </a>
     三、简单的Http客户端
    </h2>
    <pre><code class="prism language-csharp"><span class="token keyword">using</span> <span class="token namespace">System</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Net<span class="token punctuation">.</span>Http</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Threading<span class="token punctuation">.</span>Tasks</span><span class="token punctuation">;</span>

<span class="token keyword">namespace</span> <span class="token namespace">Http</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">class</span> <span class="token class-name">HttpClient_DP</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">HttpClient</span> _client<span class="token punctuation">;</span> <span class="token comment">// HttpClient 实例</span>

        <span class="token comment">// 构造函数，初始化 HttpClient 实例</span>
        <span class="token keyword">public</span> <span class="token function">HttpClient_DP</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            _client <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">HttpClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 设置超时时间</span>
        <span class="token keyword">public</span> <span class="token return-type class-name">TimeSpan</span> TimeOut <span class="token punctuation">{<!-- --></span> <span class="token keyword">set</span> <span class="token punctuation">{<!-- --></span> _client<span class="token punctuation">.</span>Timeout <span class="token operator">=</span> <span class="token keyword">value</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span>

        <span class="token comment">// 发送 GET 请求并返回响应内容</span>
        <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span><span class="token keyword">string</span><span class="token punctuation">&gt;</span></span> <span class="token function">Get</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> url<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">HttpResponseMessage</span> response <span class="token operator">=</span> <span class="token keyword">await</span> _client<span class="token punctuation">.</span><span class="token function">GetAsync</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 发送 GET 请求</span>
             
            <span class="token keyword">if</span> <span class="token punctuation">(</span>response<span class="token punctuation">.</span>IsSuccessStatusCode<span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token class-name"><span class="token keyword">string</span></span> content <span class="token operator">=</span> <span class="token keyword">await</span> response<span class="token punctuation">.</span>Content<span class="token punctuation">.</span><span class="token function">ReadAsStringAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 读取响应内容</span>
                <span class="token keyword">return</span> content<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span> <span class="token interpolation-string"><span class="token string">$"Error: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token expression language-csharp">response<span class="token punctuation">.</span>StatusCode</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">;</span> <span class="token comment">// 返回错误信息</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 发送 POST 请求并返回响应内容</span>
        <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span><span class="token keyword">string</span><span class="token punctuation">&gt;</span></span> <span class="token function">Post</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> url<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">string</span></span> data<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">HttpContent</span> content <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">StringContent</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 创建包含请求数据的 HttpContent 实例</span>

            <span class="token class-name">HttpResponseMessage</span> response <span class="token operator">=</span> <span class="token keyword">await</span> _client<span class="token punctuation">.</span><span class="token function">PostAsync</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> content<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 发送 POST 请求</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>response<span class="token punctuation">.</span>IsSuccessStatusCode<span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token class-name"><span class="token keyword">string</span></span> responseData <span class="token operator">=</span> <span class="token keyword">await</span> response<span class="token punctuation">.</span>Content<span class="token punctuation">.</span><span class="token function">ReadAsStringAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 读取响应内容</span>
                <span class="token keyword">return</span> responseData<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span> <span class="token interpolation-string"><span class="token string">$"Error: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token expression language-csharp">response<span class="token punctuation">.</span>StatusCode</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">;</span> <span class="token comment">// 返回错误信息</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     <mark>
      其中只实现的Get与Post的相关代码，这也是当前我最常用的两个方法。
     </mark>
     <br/>
     <mark>
      其中 public TimeSpan TimeOut为超时时间，不设置时将永久等待服务器响应。当响应超时时，外部可以通过(try-catch)捕获TaskCanceledException异常。
     </mark>
    </p>
    <h2>
     <a id="_205">
     </a>
     四、实际调用
    </h2>
    <p>
     初始化服务器：
    </p>
    <pre><code class="prism language-csharp">        <span class="token class-name">httpServer<span class="token punctuation">.</span>HttpServer_DP</span> HttpServer<span class="token punctuation">;</span>
        <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">IniHttpServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            HttpServer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">httpServer<span class="token punctuation">.</span>HttpServer_DP</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name"><span class="token keyword">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span>
            <span class="token punctuation">{<!-- --></span>
               <span class="token string">"http://127.0.0.1:8080/"</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//绑定映射，处理函数</span>
            <span class="token comment">//当传入URL为"http://127.0.0.1:8080/PostAGVC_Data/"时将调用PostAGVC_Data函数接收和解析</span>
            HttpServer<span class="token punctuation">.</span><span class="token function">AddRoute</span><span class="token punctuation">(</span><span class="token string">"/PostAGVC_Data/"</span><span class="token punctuation">,</span> PostAGVC_Data<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//当传入URL为"http://127.0.0.1:8080/PostAGV_Data/"时将调用PostAGV_Data函数接收和解析</span>
            HttpServer<span class="token punctuation">.</span><span class="token function">AddRoute</span><span class="token punctuation">(</span><span class="token string">"/PostAGV_Data/"</span><span class="token punctuation">,</span> PostAGV_Data<span class="token punctuation">)</span><span class="token punctuation">;</span>
            HttpServer<span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>


		<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span><span class="token keyword">string</span><span class="token punctuation">&gt;</span></span> <span class="token function">PostAGVC_Data</span><span class="token punctuation">(</span><span class="token class-name">HttpListenerContext</span> context<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token class-name"><span class="token keyword">string</span></span> httpMethod <span class="token operator">=</span> context<span class="token punctuation">.</span>Request<span class="token punctuation">.</span>HttpMethod<span class="token punctuation">;</span>
            <span class="token class-name"><span class="token keyword">string</span></span> responseString <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>
            <span class="token comment">// 处理 POST 请求</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>context<span class="token punctuation">.</span>Request<span class="token punctuation">.</span>HasEntityBody<span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// 从请求主体中获取数据</span>
                <span class="token keyword">using</span> <span class="token punctuation">(</span><span class="token class-name">System<span class="token punctuation">.</span>IO<span class="token punctuation">.</span>Stream</span> body <span class="token operator">=</span> context<span class="token punctuation">.</span>Request<span class="token punctuation">.</span>InputStream<span class="token punctuation">)</span>
                <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">using</span> <span class="token punctuation">(</span><span class="token class-name">System<span class="token punctuation">.</span>IO<span class="token punctuation">.</span>StreamReader</span> reader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">System<span class="token punctuation">.</span>IO<span class="token punctuation">.</span>StreamReader</span><span class="token punctuation">(</span>body<span class="token punctuation">,</span> context<span class="token punctuation">.</span>Request<span class="token punctuation">.</span>ContentEncoding<span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token punctuation">{<!-- --></span>
                        <span class="token class-name"><span class="token keyword">string</span></span> postData <span class="token operator">=</span> reader<span class="token punctuation">.</span><span class="token function">ReadToEnd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 读取 POST 数据</span>
                            <span class="token comment">//处理数据</span>
                            <span class="token comment">//。。。。。。。。。。。。</span>
							<span class="token comment">//。。。。。。。。。。。。</span>
							<span class="token comment">//返回字符串</span>
                        responseString <span class="token operator">=</span> <span class="token string">"OK"</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> responseString<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

		<span class="token comment">//与PostAGVC_Data内部类似，处理数据的代码不一样</span>
		<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span><span class="token keyword">string</span><span class="token punctuation">&gt;</span></span> <span class="token function">PostAGV_Data</span><span class="token punctuation">(</span><span class="token class-name">HttpListenerContext</span> context<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token comment">//省略</span>
        <span class="token punctuation">}</span>
</code></pre>
    <p>
     由于Http的无连接性，客户端只需要实例化后，需要时进行连接就行，简单的初始化(如果需要的话)如下：
    </p>
    <pre><code class="prism language-csharp">		<span class="token class-name">Http<span class="token punctuation">.</span>HttpClient_DP</span> HttpClient <span class="token punctuation">;</span>
        <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">IniHttpClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>HttpClient <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                HttpClient <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Http<span class="token punctuation">.</span>HttpClient_DP</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                HttpClient<span class="token punctuation">.</span>TimeOut <span class="token operator">=</span> TimeSpan<span class="token punctuation">.</span><span class="token function">FromSeconds</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
</code></pre>
    <p>
     调用：
     <br/>
     其中JsonConvert只是将我的类实例序列化成Json字符串，在此可以仅当字符串来看。
    </p>
    <pre><code class="prism language-csharp">        <span class="token class-name"><span class="token keyword">string</span></span> ret <span class="token operator">=</span> <span class="token keyword">await</span> Global_Value<span class="token punctuation">.</span>HttpClient<span class="token punctuation">.</span><span class="token function">Post</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> JsonConvert<span class="token punctuation">.</span><span class="token function">SerializeObject</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">PLC_WorkState</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            name <span class="token operator">=</span> agvName<span class="token punctuation">,</span>
            workState <span class="token operator">=</span> workState
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre>
    <p>
     <mark>
      要注意一个问题，在不是本地回环地址（127.0.0.1）时，服务器启动会存在积极拒绝的情况，此时需要用管理员权限去打开应用程序或者是VS平台。
     </mark>
    </p>
    <h2>
     <a id="WinformHttpWebApi_282">
     </a>
     五、Winform中Http服务器和WebApi的区别？
    </h2>
    <p>
     在WinForms中编写的HTTP服务器类与WebAPI之间有几个主要区别：
    </p>
    <p>
     1.目的和设计用途：
    </p>
    <ul>
     <li>
      WinForms HTTP服务器类：
      <br/>
      通常是基于Socket或其他网络库手动实现的简单HTTP服务器。这样的服务器可能是为了特定目的而创建，比如在本地进行简单的通信或提供特定服务。
     </li>
     <li>
      WebAPI： 是一个在Web开发中常用的框架，用于构建基于HTTP的RESTful
      <br/>
      API。它是ASP.NET框架的一部分，提供了更完整、功能更丰富的API开发环境，包括路由、中间件、控制器、模型绑定等。
     </li>
    </ul>
    <p>
     2.功能和特性：
    </p>
    <ul>
     <li>
      WinForms HTTP服务器类：
      <br/>
      往往具有较少的功能，可能只实现了基本的HTTP请求/响应处理，而缺少高级特性和工具。它通常用于较小规模的需求。
     </li>
     <li>
      WebAPI：
      <br/>
      提供了许多功能强大的特性，例如路由，HTTP谓词（GET、POST、PUT等）的自动映射到相应的处理方法，参数绑定、模型验证等，使得开发者能够更轻松地构建和管理API。
     </li>
    </ul>
    <p>
     3.集成和扩展性：
    </p>
    <ul>
     <li>
      WinForms HTTP服务器类： 通常需要手动处理连接、请求、响应和其他网络层细节，灵活性较高，但也需要开发者自行处理许多功能。
     </li>
     <li>
      WebAPI：
      <br/>
      集成在ASP.NET中，可以利用ASP.NET提供的丰富特性和中间件，容易与其他ASP.NET组件集成，并且具有更强的扩展性。
     </li>
    </ul>
    <p>
     4.适用场景：
    </p>
    <ul>
     <li>
      <p>
       WinForms HTTP服务器类： 适用于需要在WinForms应用程序中实现简单的HTTP通信或提供基本服务的情况。
      </p>
     </li>
     <li>
      <p>
       WebAPI： 更适合构建大型的Web应用程序或服务，提供多种HTTP服务，满足各种复杂的需求，例如构建RESTfulAPI供移动应用或Web前端使用。
      </p>
     </li>
    </ul>
    <p>
     <mark>
      总体来说，WinForms中的简单HTTP服务器类适用于简单的、局部的HTTP通信需求，而WebAPI更适用于构建和管理完整的Web服务或RESTful API，并提供了更多现成的工具和功能来简化开发流程。
     </mark>
    </p>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f62:6c6f672e6373646e2e6e65742f71715f34323530343039372f:61727469636c652f64657461696c732f313335313932393235" class_="artid" style="display:none">
 </p>
</div>


