---
layout: post
title: "如何在-Java-中使用-MQTT"
date: 2022-08-30 15:43:15 +0800
description: "文章浏览阅读8.7k次，点赞11次，本文主要介绍如何在Java项目中使用MQTT，实现MQTT客户端"
keywords: "java mqtt"
categories: ['物联网', 'Mqtt', 'Iot']
tags: ['物联网', '客户端', 'Mqtt', 'Java', 'Iot']
artid: "126605202"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=126605202
    alt: "如何在-Java-中使用-MQTT"
render_with_liquid: false
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     如何在 Java 中使用 MQTT
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <p>
     <a href="https://www.emqx.com/zh/mqtt" rel="nofollow">
      MQTT
     </a>
     是一种基于发布/订阅模式的
     <strong>
      轻量级物联网消息传输协议
     </strong>
     ，可在严重受限的硬件设备和低带宽、高延迟的网络上实现稳定传输。它凭借简单易实现、支持 QoS、报文小等特点，占据了物联网协议的半壁江山。
    </p>
    <p>
     本文主要介绍如何在 Java 项目中使用 MQTT，实现客户端与服务器的连接、订阅和收发消息等功能。
    </p>
    <h3>
     <a id="_4">
     </a>
     引入客户端库
    </h3>
    <p>
     本文的开发环境为：
    </p>
    <ul>
     <li>
      构建工具：
      <a href="https://maven.apache.org/" rel="nofollow">
       Maven
      </a>
     </li>
     <li>
      IDE：
      <a href="https://www.jetbrains.com/idea/" rel="nofollow">
       IntelliJ IDEA
      </a>
     </li>
     <li>
      Java 版本：JDK 1.8.0
     </li>
    </ul>
    <p>
     本文将使用
     <a href="https://github.com/eclipse/paho.mqtt.java">
      Eclipse Paho Java Client
     </a>
     作为客户端，该客户端是 Java 语言中使用最为广泛的 MQTT 客户端库。
    </p>
    <p>
     添加以下依赖到项目 pom.xml 文件中。
    </p>
    <pre><code class="prism language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.eclipse.paho<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>org.eclipse.paho.client.mqttv3<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.2.5<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span>
</code></pre>
    <h3>
     <a id="_MQTT__26">
     </a>
     创建 MQTT 连接
    </h3>
    <h4>
     <a id="MQTT__28">
     </a>
     MQTT 服务器
    </h4>
    <p>
     本文将使用 EMQX 提供的
     <a href="https://www.emqx.com/zh/mqtt/public-mqtt5-broker" rel="nofollow">
      免费公共 MQTT 服务器
     </a>
     ，该服务基于 EMQX 的
     <a href="https://www.emqx.com/zh/cloud" rel="nofollow">
      MQTT 云平台
     </a>
     创建。服务器接入信息如下：
    </p>
    <ul>
     <li>
      Broker:
      <strong>
       broker.emqx.io
      </strong>
      （中国用户可以使用
      <strong>
       broker-cn.emqx.io
      </strong>
      ）
     </li>
     <li>
      TCP Port:
      <strong>
       1883
      </strong>
     </li>
     <li>
      SSL/TLS Port:
      <strong>
       8883
      </strong>
     </li>
    </ul>
    <h4>
     <a id="_TCP__36">
     </a>
     普通 TCP 连接
    </h4>
    <p>
     设置 MQTT Broker 基本连接参数，用户名、密码为非必选参数。
    </p>
    <pre><code class="prism language-abnf">String broker = "tcp://broker.emqx.io:1883";
// TLS/SSL
// String broker = "ssl://broker.emqx.io:8883";
String username = "emqx";
String password = "public";
String clientid = "publish_client";
</code></pre>
    <p>
     然后创建 MQTT 客户端并连接。
    </p>
    <pre><code class="prism language-reasonml">MqttClient client = new MqttClient(broker, clientid, new MemoryPersistence());
MqttConnectOptions options = new MqttConnectOptions();
options.setUserName(username);
options.setPassword(password.toCharArray());
client.connect(options);
</code></pre>
    <p>
     说明
    </p>
    <ul>
     <li>
      MqttClient: 同步调用客户端，使用阻塞方法通信。
     </li>
     <li>
      MqttClientPersistence: 代表一个持久的数据存储，用于在传输过程中存储出站和入站的信息，使其能够传递到指定的 QoS。
     </li>
     <li>
      MqttConnectOptions: 连接选项，用于指定连接的参数，下面列举一些常见的方法。
      <ul>
       <li>
        setUserName: 设置用户名
       </li>
       <li>
        setPassword: 设置密码
       </li>
       <li>
        setCleanSession: 设置是否清除会话
       </li>
       <li>
        setKeepAliveInterval: 设置心跳间隔
       </li>
       <li>
        setConnectionTimeout: 设置连接超时时间
       </li>
       <li>
        setAutomaticReconnect: 设置是否自动重连
       </li>
      </ul>
     </li>
    </ul>
    <h4>
     <a id="TLSSSL__71">
     </a>
     TLS/SSL 连接
    </h4>
    <p>
     如果要使用自签名证书进行 TLS/SSL 连接，需添加
     <a href="https://mvnrepository.com/artifact/org.bouncycastle/bcpkix-jdk15on" rel="nofollow">
      bcpkix-jdk15on
     </a>
     到 pom.xml 文件。
    </p>
    <pre><code class="prism language-xml"><span class="token comment">&lt;!-- https://mvnrepository.com/artifact/org.bouncycastle/bcpkix-jdk15on --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.bouncycastle<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>bcpkix-jdk15on<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.70<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre>
    <p>
     然后使用如下代码创建
     <code>
      SSLUtils.java
     </code>
     文件。
    </p>
    <pre><code class="prism language-java"><span class="token keyword">package</span> <span class="token namespace">io<span class="token punctuation">.</span>emqx<span class="token punctuation">.</span>mqtt</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>bouncycastle<span class="token punctuation">.</span>jce<span class="token punctuation">.</span>provider<span class="token punctuation">.</span></span><span class="token class-name">BouncyCastleProvider</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>bouncycastle<span class="token punctuation">.</span>openssl<span class="token punctuation">.</span></span><span class="token class-name">PEMKeyPair</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>bouncycastle<span class="token punctuation">.</span>openssl<span class="token punctuation">.</span></span><span class="token class-name">PEMParser</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>bouncycastle<span class="token punctuation">.</span>openssl<span class="token punctuation">.</span>jcajce<span class="token punctuation">.</span></span><span class="token class-name">JcaPEMKeyConverter</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>net<span class="token punctuation">.</span>ssl<span class="token punctuation">.</span></span><span class="token class-name">KeyManagerFactory</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>net<span class="token punctuation">.</span>ssl<span class="token punctuation">.</span></span><span class="token class-name">SSLContext</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>net<span class="token punctuation">.</span>ssl<span class="token punctuation">.</span></span><span class="token class-name">SSLSocketFactory</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>net<span class="token punctuation">.</span>ssl<span class="token punctuation">.</span></span><span class="token class-name">TrustManagerFactory</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">BufferedInputStream</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">FileInputStream</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">FileReader</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>security<span class="token punctuation">.</span></span><span class="token class-name">KeyPair</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>security<span class="token punctuation">.</span></span><span class="token class-name">KeyStore</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>security<span class="token punctuation">.</span></span><span class="token class-name">Security</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>security<span class="token punctuation">.</span>cert<span class="token punctuation">.</span></span><span class="token class-name">CertificateFactory</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>security<span class="token punctuation">.</span>cert<span class="token punctuation">.</span></span><span class="token class-name">X509Certificate</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SSLUtils</span> <span class="token punctuation">{<!-- --></span>
   <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">SSLSocketFactory</span> <span class="token function">getSocketFactory</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">String</span> caCrtFile<span class="token punctuation">,</span>
                                                   <span class="token keyword">final</span> <span class="token class-name">String</span> crtFile<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">String</span> keyFile<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">String</span> password<span class="token punctuation">)</span>
           <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
       <span class="token class-name">Security</span><span class="token punctuation">.</span><span class="token function">addProvider</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BouncyCastleProvider</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

       <span class="token comment">// load CA certificate</span>
       <span class="token class-name">X509Certificate</span> caCert <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

       <span class="token class-name">FileInputStream</span> fis <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileInputStream</span><span class="token punctuation">(</span>caCrtFile<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token class-name">BufferedInputStream</span> bis <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BufferedInputStream</span><span class="token punctuation">(</span>fis<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token class-name">CertificateFactory</span> cf <span class="token operator">=</span> <span class="token class-name">CertificateFactory</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token string">"X.509"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

       <span class="token keyword">while</span> <span class="token punctuation">(</span>bis<span class="token punctuation">.</span><span class="token function">available</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
           caCert <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">X509Certificate</span><span class="token punctuation">)</span> cf<span class="token punctuation">.</span><span class="token function">generateCertificate</span><span class="token punctuation">(</span>bis<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

       <span class="token comment">// load client certificate</span>
       bis <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BufferedInputStream</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">FileInputStream</span><span class="token punctuation">(</span>crtFile<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token class-name">X509Certificate</span> cert <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
       <span class="token keyword">while</span> <span class="token punctuation">(</span>bis<span class="token punctuation">.</span><span class="token function">available</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
           cert <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">X509Certificate</span><span class="token punctuation">)</span> cf<span class="token punctuation">.</span><span class="token function">generateCertificate</span><span class="token punctuation">(</span>bis<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

       <span class="token comment">// load client private key</span>
       <span class="token class-name">PEMParser</span> pemParser <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PEMParser</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">FileReader</span><span class="token punctuation">(</span>keyFile<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token class-name">Object</span> object <span class="token operator">=</span> pemParser<span class="token punctuation">.</span><span class="token function">readObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token class-name">JcaPEMKeyConverter</span> converter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JcaPEMKeyConverter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setProvider</span><span class="token punctuation">(</span><span class="token string">"BC"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token class-name">KeyPair</span> key <span class="token operator">=</span> converter<span class="token punctuation">.</span><span class="token function">getKeyPair</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">PEMKeyPair</span><span class="token punctuation">)</span> object<span class="token punctuation">)</span><span class="token punctuation">;</span>
       pemParser<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

       <span class="token comment">// CA certificate is used to authenticate server</span>
       <span class="token class-name">KeyStore</span> caKs <span class="token operator">=</span> <span class="token class-name">KeyStore</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token class-name">KeyStore</span><span class="token punctuation">.</span><span class="token function">getDefaultType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       caKs<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       caKs<span class="token punctuation">.</span><span class="token function">setCertificateEntry</span><span class="token punctuation">(</span><span class="token string">"ca-certificate"</span><span class="token punctuation">,</span> caCert<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token class-name">TrustManagerFactory</span> tmf <span class="token operator">=</span> <span class="token class-name">TrustManagerFactory</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token string">"X509"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       tmf<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span>caKs<span class="token punctuation">)</span><span class="token punctuation">;</span>

       <span class="token comment">// client key and certificates are sent to server so it can authenticate</span>
       <span class="token class-name">KeyStore</span> ks <span class="token operator">=</span> <span class="token class-name">KeyStore</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token class-name">KeyStore</span><span class="token punctuation">.</span><span class="token function">getDefaultType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       ks<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       ks<span class="token punctuation">.</span><span class="token function">setCertificateEntry</span><span class="token punctuation">(</span><span class="token string">"certificate"</span><span class="token punctuation">,</span> cert<span class="token punctuation">)</span><span class="token punctuation">;</span>
       ks<span class="token punctuation">.</span><span class="token function">setKeyEntry</span><span class="token punctuation">(</span><span class="token string">"private-key"</span><span class="token punctuation">,</span> key<span class="token punctuation">.</span><span class="token function">getPrivate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> password<span class="token punctuation">.</span><span class="token function">toCharArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
               <span class="token keyword">new</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>security<span class="token punctuation">.</span>cert<span class="token punctuation">.</span></span>Certificate</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{<!-- --></span>cert<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token class-name">KeyManagerFactory</span> kmf <span class="token operator">=</span> <span class="token class-name">KeyManagerFactory</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token class-name">KeyManagerFactory</span>
              <span class="token punctuation">.</span><span class="token function">getDefaultAlgorithm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       kmf<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span>ks<span class="token punctuation">,</span> password<span class="token punctuation">.</span><span class="token function">toCharArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

       <span class="token comment">// finally, create SSL socket factory</span>
       <span class="token class-name">SSLContext</span> context <span class="token operator">=</span> <span class="token class-name">SSLContext</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token string">"TLSv1.2"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       context<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span>kmf<span class="token punctuation">.</span><span class="token function">getKeyManagers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> tmf<span class="token punctuation">.</span><span class="token function">getTrustManagers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

       <span class="token keyword">return</span> context<span class="token punctuation">.</span><span class="token function">getSocketFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     参照如下设置
     <code>
      options
     </code>
     。
    </p>
    <pre><code class="prism language-reasonml">// 设置 SSL/TLS 连接地址
String broker = "ssl://broker.emqx.io:8883";
// 设置 socket factory
String caFilePath = "/cacert.pem";
String clientCrtFilePath = "/client.pem";
String clientKeyFilePath = "/client.key";
SSLSocketFactory socketFactory = getSocketFactory(caFilePath, clientCrtFilePath, clientKeyFilePath, "");
options.setSocketFactory(socketFactory);
</code></pre>
    <h3>
     <a id="_MQTT__177">
     </a>
     发布 MQTT 消息
    </h3>
    <p>
     创建一个发布客户端类
     <code>
      PublishSample
     </code>
     ，该类将发布一条
     <code>
      Hello MQTT
     </code>
     消息至主题
     <code>
      mqtt/test
     </code>
     。
    </p>
    <pre><code class="prism language-haxe">package io.emqx.mqtt;

import org.eclipse.paho.client.mqttv3.MqttClient;
import org.eclipse.paho.client.mqttv3.MqttConnectOptions;
import org.eclipse.paho.client.mqttv3.MqttException;
import org.eclipse.paho.client.mqttv3.MqttMessage;
import org.eclipse.paho.client.mqttv3.persist.MemoryPersistence;

public class PublishSample {

   public static void main(String[] args) {

       String broker = "tcp://broker.emqx.io:1883";
       String topic = "mqtt/test";
       String username = "emqx";
       String password = "public";
       String clientid = "publish_client";
       String content = "Hello MQTT";
       int qos = 0;

       try {
           MqttClient client = new MqttClient(broker, clientid, new MemoryPersistence());
           // 连接参数
           MqttConnectOptions options = new MqttConnectOptions();
           // 设置用户名和密码
           options.setUserName(username);
           options.setPassword(password.toCharArray());
           options.setConnectionTimeout(60);
      options.setKeepAliveInterval(60);
           // 连接
           client.connect(options);
           // 创建消息并设置 QoS
           MqttMessage message = new MqttMessage(content.getBytes());
           message.setQos(qos);
           // 发布消息
           client.publish(topic, message);
           System.out.println("Message published");
           System.out.println("topic: " + topic);
           System.out.println("message content: " + content);
           // 关闭连接
           client.disconnect();
           // 关闭客户端
           client.close();
      } catch (MqttException e) {
           throw new RuntimeException(e);
      }
  }
}
</code></pre>
    <h3>
     <a id="_MQTT__232">
     </a>
     订阅 MQTT 主题
    </h3>
    <p>
     创建一个订阅客户端类
     <code>
      SubscribeSample
     </code>
     ，该类将订阅主题
     <code>
      mqtt/test
     </code>
     。
    </p>
    <pre><code class="prism language-reasonml">package io.emqx.mqtt;

import org.eclipse.paho.client.mqttv3.*;
import org.eclipse.paho.client.mqttv3.persist.MemoryPersistence;

public class SubscribeSample {
   public static void main(String[] args) {
       String broker = "tcp://broker.emqx.io:1883";
       String topic = "mqtt/test";
       String username = "emqx";
       String password = "public";
       String clientid = "subscribe_client";
       int qos = 0;

       try {
           MqttClient client = new MqttClient(broker, clientid, new MemoryPersistence());
           // 连接参数
           MqttConnectOptions options = new MqttConnectOptions();
           options.setUserName(username);
           options.setPassword(password.toCharArray());
           options.setConnectionTimeout(60);
      options.setKeepAliveInterval(60);
           // 设置回调
           client.setCallback(new MqttCallback() {

               public void connectionLost(Throwable cause) {
                   System.out.println("connectionLost: " + cause.getMessage());
              }

               public void messageArrived(String topic, MqttMessage message) {
                   System.out.println("topic: " + topic);
                   System.out.println("Qos: " + message.getQos());
                   System.out.println("message content: " + new String(message.getPayload()));

              }

               public void deliveryComplete(IMqttDeliveryToken token) {
                   System.out.println("deliveryComplete---------" + token.isComplete());
              }

          });
           client.connect(options);
           client.subscribe(topic, qos);
      } catch (Exception e) {
           e.printStackTrace();
      }
  }
}
</code></pre>
    <p>
     MqttCallback 说明：
    </p>
    <ul>
     <li>
      connectionLost(Throwable cause): 连接丢失时被调用
     </li>
     <li>
      messageArrived(String topic, MqttMessage message): 接收到消息时被调用
     </li>
     <li>
      deliveryComplete(IMqttDeliveryToken token): 消息发送完成时被调用
     </li>
    </ul>
    <h3>
     <a id="_293">
     </a>
     测试
    </h3>
    <p>
     接下来运行
     <code>
      SubscribeSample
     </code>
     ，订阅
     <code>
      mqtt/test
     </code>
     主题。 然后运行
     <code>
      PublishSample
     </code>
     ，发布消息到
     <code>
      mqtt/test
     </code>
     主题。 我们将会看到发布端成功发布消息，同时订阅端接收到消息。
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/c755d6d18ea32c3fc2226430ca1cf71d.png#pic_center"/>
    </p>
    <p>
     至此，我们完成了在 Java 中使用 Paho Java Client 来作为 MQTT 客户端连接到
     <a href="https://www.emqx.com/zh/mqtt/public-mqtt5-broker" rel="nofollow">
      公共 MQTT 服务器
     </a>
     ，并实现了测试客户端与 MQTT 服务器的连接、消息发布和订阅。
    </p>
    <p>
     完整代码请见：
     <a href="https://github.com/emqx/MQTT-Client-Examples/tree/master/mqtt-client-Java">
      https://github.com/emqx/MQTT-Client-Examples/tree/master/mqtt-client-Java
     </a>
     。
    </p>
    <blockquote>
     <p>
      版权声明： 本文为 EMQ 原创，转载请注明出处。
     </p>
     <p>
      原文链接：
      <a href="https://www.emqx.com/zh/blog/how-to-use-mqtt-in-java" rel="nofollow">
       https://www.emqx.com/zh/blog/how-to-use-mqtt-in-java
      </a>
     </p>
    </blockquote>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f62:6c6f672e6373646e2e6e65742f656d71785f62726f6b65722f:61727469636c652f64657461696c732f313236363035323032" class_="artid" style="display:none">
 </p>
</div>


