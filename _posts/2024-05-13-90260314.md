---
layout: post
title: "iOSApp版本升级时数据库FMDB升级"
date: 2024-05-13 11:59:19 +0800
description: "1.数据库为什么升级？当我们对已经建立好的数据库进行修改（添加字段）用户单纯的升级app用到这个字段"
keywords: "iOSApp版本升级时数据库FMDB升级"
categories: ['数据库存储', 'Ios']
tags: ['数据库升级', 'Fmdb', 'App']
artid: "90260314"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=90260314
    alt: "iOSApp版本升级时数据库FMDB升级"
render_with_liquid: false
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     iOSApp版本升级时数据库FMDB升级
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-kimbie-light" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <p>
     <a href="https://github.com/miaoxiaojie/DatabaseDemo">
      FMDB数据库高级使用demo
     </a>
     <br/>
     <strong>
      1.数据库为什么升级？
     </strong>
    </p>
    <blockquote>
     <p>
      当我们对已经建立好的数据库进行修改（添加字段）用户单纯的升级app用到这个字段必须升级，升级，升级！！！
     </p>
    </blockquote>
    <p>
     2.
     <strong>
      为什么我们将版本信息放入数据库而不使用UserDefaults快速存储呢?
     </strong>
    </p>
    <blockquote>
     <p>
      原因是你需要考虑到
      <br/>
      当你的app有不同的用户登录时,UserDefaults是所有数据共享的,你不能根据不同的用户来处理他的信息
      <br/>
      判段他的信息是否需要更新
     </p>
    </blockquote>
    <p>
     <strong>
      3.思路
     </strong>
    </p>
    <ol>
     <li>
      在数据库增加一张存版本号的表
     </li>
     <li>
      当APP启动的时候判断是否是第一次安装
     </li>
     <li>
      第一次安装更新数据库，并且把数据库的版本号储存下来
     </li>
    </ol>
    <p>
     4.代码
    </p>
    <p>
     1.是否升级数据库
    </p>
    <blockquote>
     <p>
      从库里面和当前的版本信息进行对比
     </p>
    </blockquote>
    <pre><code>static BOOL isAppUpdate(void)
{
    BOOL isUpdate = NO;
    NSString *storePath = appInfoServerUtil.getDBFilePath();
    NSFileManager *fileManager = [NSFileManager defaultManager];
    if([fileManager fileExistsAtPath:storePath])
    {
        id&lt;FMDBAppUpgradeDBHelperInterface&gt;verSqlDBHelper = [FMDBAppUpgradeFactory getAppUpgradeDBHelper];
        NSString *sqlVersion = [verSqlDBHelper getAppVersionInfo];
        
        //数据库版本与程序版本不一致
        if (![sqlVersion isEqualToString:FMDBReleaseCurrentVersion])
        {
            isUpdate = YES;
        }
    }
    
    return isUpdate;
}
</code></pre>
    <p>
     2.升级数据库
    </p>
    <pre><code>-(void)p_setupdateCurrentDB
{
    NSFileManager *fileManager = [NSFileManager defaultManager];
    
    NSString *storePath = appInfoServerUtil.getDBFilePath();
    NSString *bundlePath = [[NSBundle mainBundle] pathForResource:kDatabaseDBName
                                                           ofType:kDBFileSuffix];
    NSError *error = nil;
    //如果bundle存在才会进行替换
    if(bundlePath)
    {
        [fileManager removeItemAtPath:storePath error:&amp;error];
        [fileManager copyItemAtPath:bundlePath toPath:storePath error:&amp;error];
       
    }
    //更新数据库版本字段
    if(!error)
    {
        id&lt;FMDBAppUpgradeDBHelperInterface&gt; verSqliteEngine = [FMDBAppUpgradeFactory getAppUpgradeDBHelper];
        [verSqliteEngine updateAppVersion:FMDBReleaseCurrentVersion];
    }
}
</code></pre>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="6874747073:3a2f2f626c6f672e6373646e2e6e65742f5a31353931303930:2f61727469636c652f64657461696c732f3930323630333134" class_="artid" style="display:none">
 </p>
</div>


