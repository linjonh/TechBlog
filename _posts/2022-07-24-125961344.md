---
layout: post
title: "游戏项目导出AAB包上传谷歌提示超过150M的解决方案"
date: 2022-07-24 18:40:50 +0800
description: "上传海外游戏项目到谷歌商店的时候遇到超过150M问题的解决方案_unity 超过150"
keywords: "unity 超过150"
categories: ['Android']
tags: ['游戏', 'Studio', 'Android', 'Android']
artid: "125961344"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=125961344
    alt: "游戏项目导出AAB包上传谷歌提示超过150M的解决方案"
render_with_liquid: false
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     游戏项目导出AAB包上传谷歌提示超过150M的解决方案
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <h3>
     <a id="_0">
     </a>
     发现问题
    </h3>
    <p>
     在上传海外游戏项目到谷歌商店的时候，遇到了提示初始安装大小超过150M上限的问题，导致游戏项目不能正常上线
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/7abfa21784eec0de8ba36212242b5e3a.png"/>
    </p>
    <br/>
    <h3>
     <a id="_7">
     </a>
     分析问题
    </h3>
    <p>
     后来查阅资料，得知上传游戏到谷歌商店提示包大小超过150M是指aab包里的base文件夹压缩后的大小，但是我对比了下（如下图）以前可以正常上架的游戏包（base文件夹158M）和不能上架的游戏包（base文件夹161M），我猜测是谷歌允许游戏包体积超过规定大小10M以内，也就是允许最大包体积是160M。
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/a8f12c4d8679c27813f2112bfa8cb45a.png">
      <br/>
      <br/>
     </img>
    </p>
    <h3>
     <a id="_13">
     </a>
     解决方案
    </h3>
    <p>
     对于这种情况，谷歌官方其实是有对应的方案的，就是Play Asset Delivery（游戏资源分发）
     <br/>
     官方文档：
     <a href="https://developer.android.google.cn/guide/app-bundle/asset-delivery" rel="nofollow">
      https://developer.android.google.cn/guide/app-bundle/asset-delivery
     </a>
    </p>
    <p>
     1、首先是新建Android Library做为存放资源的分包 ，命名：game_asset_pack
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/ccad901f0bccb4413d88c1dbf1da313c.png"/>
    </p>
    <p>
     2、在 game_asset_pack 目录中，创建一个 build.gradle 文件并添加以下代码：
    </p>
    <pre><code class="prism language-groovy">apply plugin<span class="token punctuation">:</span> <span class="token string">'com.android.asset-pack'</span>
assetPack <span class="token punctuation">{<!-- --></span>
    packName <span class="token operator">=</span> <span class="token string">'game_asset_pack'</span>
    dynamicDelivery <span class="token punctuation">{<!-- --></span>
        deliveryType <span class="token operator">=</span> <span class="token string">"install-time"</span> <span class="token comment">//PAD资源分发 安装时分发</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     deliveryType代表的是分发模式，共有三种：
     <br/>
     install-time:资源包在用户安装应用时分发,一般存放需要一打开游戏就用到的资源；
     <br/>
     fast-follow:资源包会在用户安装应用后立即自动下载；用户无需打开应用即可开始 fast-follow 下载;
     <br/>
     on-demand 资源包会在应用运行时下载。
    </p>
    <p>
     3、在项目的应用 build.gradle 文件中，添加项目中 Asset Pack 的名称:
    </p>
    <pre><code class="prism language-groovy"><span class="token comment">//项目中最可以有50个Asset Pack，需要将所有Asset Pack名称都添加到这里</span>
assetPacks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">":game_asset_pack"</span><span class="token punctuation">]</span> 
<span class="token comment">//assetPacks = [":asset_pack1", ":asset_pack2"]</span>
</code></pre>
    <br/>
    4、在settings.gradle中添加项目中所有的Asset Pack：
    <pre><code class="prism language-groovy">include <span class="token string">':game_asset_pack'</span>
<span class="token comment">//includ ':asset_pack2'</span>
</code></pre>
    <br/>
    5、将需要做分发处理的游戏资源放在game_asset_pack模块下的src/main/assets 目录下 游戏架构不同游戏资源的存放路径也不一样，laya架构的游戏项目一般存放其src/main/assets目录下的内容。 同时需要注意的是**不要将游戏启动相关的配置文件放进去**，不然可能会导致游戏不能正常启动的情况，比如 Unity 游戏的 assets 中的 bin 文件夹和 config 配置，如果放在资源分包的目录下的话，aab 安装后会出现黑屏或者 not enough storage space to install 的提示。
    <br/>
    <br/>
    6、将 Play Asset Delivery 集成到游戏项目中
    <br/>
    在应用级build.gradle中添加依赖：
    <pre><code class="prism language-groovy">implementation <span class="token string">'com.google.android.play:asset-delivery:2.0.0'</span>
</code></pre>
    <p>
     7、进行aab包打包、安装、测试
     <br/>
     （进行资源分发处理后，直接打apk包安装会出现游戏找不到资源的情况，需要先打包aab再通过aab安装到手机中）
     <br/>
     这是资源分发处理后打包好的aab游戏包
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/c169659c768ce068f8f82290f642d1c7.png"/>
    </p>
    <p>
     可以看到base目录只剩下31m，游戏资源都放到新的模块game_asset_pack里了，这时候提交到谷歌商店就可以正常过审了。
     <br/>
     <br/>
     <br/>
    </p>
    <h2>
     <a id="_73">
     </a>
     知识延伸：
    </h2>
    <h3>
     <a id="1aab_75">
     </a>
     1、aab包打包、安装测试方法
    </h3>
    <p>
     Android App Bundle （aab）是谷歌官方提供的一种新发布格式,其中包含应用的所有经过编译的代码和资源。 APK 生成及签名全部交由 Google Play 来处理。
     <br/>
     当用户在Google Play下载软件的时候，Google Play 会根据你上传的 aab ，针对用户设备的配置（比如CPU架构、语言等），为用户提供经过优化的 APK，因此只会下载特定设备所需的代码和资源来运行你的应用，以此来减小软件安装所需要的体积。
     <br/>
     打包好的aab包并不能直接安装到手机中，而是需要上传到 Google Play 后台，通过商店下载安装测试。
     <br/>
     但是我们在应用资源分发PAD模式的时候，打包成的apk是不能正常运行的，因为PAD模式是基于aab格式来运行的。
     <br/>
     那么，我们打包好的apk不能正常运行，aab又不能直接安装到手机中，如果我们需要测试打包好的aab游戏包是否有问题该怎么办呢？如果是上传到google play后台再下载安装，测试流程未免也太繁琐了。
     <br/>
     对于这个问题，谷歌官方是有提供一套工具bundletool来将aab安装到手机中的。
    </p>
    <p>
     <a href="https://github.com/google/bundletool/releases">
      bundleTool下载
     </a>
     <br/>
     <a href="https://developer.android.com/studio/command-line/bundletool" rel="nofollow">
      bundletool官方使用文档
     </a>
    </p>
    <p>
     aab安装过程如下：
     <br/>
     1.将aab包转化为apks格式：
    </p>
    <pre><code class="prism language-bash">java -jar <span class="token punctuation">[</span>bundletool文件名<span class="token punctuation">]</span> build-apks --bundle<span class="token operator">=</span><span class="token punctuation">[</span>aab文件名<span class="token punctuation">]</span> --output<span class="token operator">=</span><span class="token punctuation">[</span>apks文件名<span class="token punctuation">]</span>
--ks<span class="token operator">=</span><span class="token punctuation">[</span>签名文件名<span class="token punctuation">]</span>
--ks-pass<span class="token operator">=</span>pass:<span class="token punctuation">[</span>签名密码<span class="token punctuation">]</span>
--ks-key-alias<span class="token operator">=</span><span class="token punctuation">[</span>别名<span class="token punctuation">]</span>
--key-pass<span class="token operator">=</span>pass:<span class="token punctuation">[</span>别名密码<span class="token punctuation">]</span>
</code></pre>
    <p>
     <font color="red">
      需要注意的是，在将aab转换成apks时，如果不指定签名 ，会用安卓默认签名，这样可能会导致Google支付不能正常调起的问题。
     </font>
    </p>
    <font color="red">
     <p>
      2.安装apks到手机中
     </p>
     <pre><code class="prism language-bash">java -jar <span class="token punctuation">[</span>bundletool文件名<span class="token punctuation">]</span> install-apks --apks <span class="token punctuation">[</span>apks文件名<span class="token punctuation">]</span>
</code></pre>
     <p>
      操作完即安装成功。
     </p>
     <p>
      这个方法其实并不适用于将游戏包发给其他测试人员进行测试的场景，因为不是所有测试人员的电脑都具备使用bundletool的环境，那么，可以按照以下我的方案来操作：
     </p>
     <p>
      1、首先配置好PAD分发模式的项目结构，游戏资源仍然放在app模块中，这时候打包的apk包是可以正常运行的
      <br/>
      2、在Android studio中编写bat脚本，先 通过
     </p>
     <pre><code class="prism language-bash">call gradlew app:assembleRelease
</code></pre>
     <p>
      打包apk，完成后保存apk包，将需要使用PAD分发的游戏资源目录移动到分包模块的src/main目录下，然后再
     </p>
     <pre><code class="prism language-bash">call gradlew app:bundleRelease
</code></pre>
     <p>
      打包aab，完成后保存aab包
     </p>
     <p>
      脚本运行完后即可将apk包交给测试人员，若测试没有问题即可提交aab包（当然前提是需要自己先通过aab包安装到手机，分发的游戏模块能正常运行）
     </p>
     <h3>
      <a id="2PFDPAD_124">
      </a>
      2、PFD和PAD
     </h3>
     <p>
      对于超过150MB的新应用，谷歌提供了两种方案供大家使用，分别是
      <a href="https://developer.android.google.cn/guide/app-bundle/dynamic-delivery" rel="nofollow">
       Play Feature Delivery
      </a>
      和
      <a href="https://developer.android.google.cn/guide/app-bundle/asset-delivery" rel="nofollow">
       Play Asset Delivery
      </a>
      。
      <br/>
      <br/>
     </p>
     <h4>
      <a id="PFDPAD_127">
      </a>
      PFD和PAD的区别
     </h4>
     <p>
      PFD是利用功能模块来实现自定义分发的，它的设计更倾向于模块化性质，比较适合的项目有电商app。功能模块的独特优势在于能够自定义应用的不同功能如何以及何时下载到设备上。
      <br/>
      而PAD可以说是为游戏设计的，他的名称翻译过来就是资源分发，而我们游戏项目给到安卓端的资源往往就是asset形式。它允许超过 150 MB 的游戏替换旧版扩展文件 (OBB)，方法是将包含游戏所需的所有资源的单个工件发布到 Play。
      <br/>
     </p>
     <h4>
      <a id="PAD_131">
      </a>
      PAD分发模式
     </h4>
     <p>
      <strong>
       install-time
      </strong>
      资源包在用户安装应用时分发。
      <br/>
      <strong>
       fast-follow
      </strong>
      资源包会在用户安装应用后立即自动下载；用户无需打开应用即可开始 fast-follow 下载。此类下载不会阻止用户访问应用。
      <br/>
      <strong>
       on-demand
      </strong>
      资源包会在应用运行时下载。
      <br/>
     </p>
     <h4>
      <a id="PAD_136">
      </a>
      PAD下载大小上限
     </h4>
     <p>
      Asset Pack 因具有较高的大小上限而成为大型游戏的理想之选：
     </p>
     <ol>
      <li>
       每个 fast-follow 和 on-demand Asset Pack 的下载大小上限为 512 MB。
      </li>
      <li>
       所有 install-time Asset Pack 的总下载大小上限为 1 GB。
      </li>
      <li>
       一个 Android App Bundle 中的所有 Asset Pack 的总下载大小上限为 2 GB。
      </li>
      <li>
       一个 Android App Bundle 中最多可以使用 50 个资源包。
      </li>
     </ol>
    </font>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f62:6c6f672e6373646e2e6e65742f71715f33393739303633332f:61727469636c652f64657461696c732f313235393631333434" class_="artid" style="display:none">
 </p>
</div>


