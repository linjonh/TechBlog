---
layout: post
title: "小程序全局组件使用自动插入节点"
date: 2024-09-06 19:35:59 +0800
description: "小程序全局组件的实现方法_微信小程序动态添节点"
keywords: "微信小程序动态添节点"
categories: ["未分类"]
tags: ["小程序", "前端", "Javascript"]
artid: "125718295"
image:
  path: https://api.vvhan.com/api/bing?rand=sj&artid=125718295
  alt: "小程序全局组件使用自动插入节点"
render_with_liquid: false
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     小程序全局组件使用（自动插入节点）
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <h2>
     <a id="_0">
     </a>
     前言
    </h2>
    <p>
     小程序中没有全局环境，像vue的全局组件小程序实现起来非常困难，vue中可以直接在app.vue中注册，但是小程序需要每个page中都插入节点才可以使用
    </p>
    <h3>
     <a id="_4">
     </a>
     解决方案
    </h3>
    <p>
     在小程序中实现全局组件，首先，需要在app.json中注册，然后需要在所有的page中插入节点，可以通过node脚本实现
    </p>
    <p>
     新建文件generator/index.js
     <br/>
     代码如下
    </p>
    <pre><code>/**
 * @description: 将组件插入到小程序项目，包括app.json和page
 * @param {string} cpName 组件名
 * @param {string} cpPath 组件路径
 * @param {string} cpString 要插入的组件字符串内容
 * @param {Array&lt;string&gt;} whiteList 不需要插入的组件
 * @return {*}
 */
function insertComponent(
  cpName = 'new-user-dialog',
  cpPath = '/components/newUserDialog/newUserDialog',
  cpString = `&lt;new-user-dialog class="new-user-dialog"&gt;&lt;/new-user-dialog&gt;`,
  whiteList = [
    'pages/home/index',
  ]
) {
  try {
    const path = require('path');
    const fs = require('fs');
    const entryFilePath = './app.json';

    if (fs.statSync(entryFilePath)) {
      const { EOL } = require('os');

      // app.json 内容
      const contentMain = fs.readFileSync(path.resolve(entryFilePath), {
        encoding: 'utf-8',
      });
      // 获取每行内容
      const contentMainLine = contentMain.split(/\r?\n/g);
      // 组件（'new-user-dialog':）正则
      const compReg = eval(`/['"]?${cpName}['"]?:/`);
      // 组件正则
      const usingComponentReg = /['"]?usingComponents['"]?:/;
      // 检测组件配置项所在行
      const ucLineNum = contentMainLine.findIndex(line =&gt;
        line.match(usingComponentReg)
      );

      // TODO: 插入组件部分
      // 检测tabbar
      const tabBarStartReg = /['"]?tabBar['"]?:/;
      // app.json没有配置自定义组件，自定义添加
      if (!compReg.test(contentMain)) {
        // 如果没有usingComponent配置项的话，就找tabbar，放在后面
        if (ucLineNum &lt; 0) {
          const tabBarLineNum = contentMainLine.findIndex(line =&gt;
            line.match(tabBarStartReg)
          );
          contentMainLine[
            tabBarLineNum - 1
          ] += `${EOL}  "usingComponents": { "${cpName}": "${cpPath}" },`;
        } else {
          // 有配置项，放到配置项里面
          contentMainLine[ucLineNum] += `${EOL}    "${cpName}": "${cpPath}",`;
        }
        fs.writeFileSync(
          path.resolve(entryFilePath),
          contentMainLine.join(EOL),
          { encoding: 'utf-8' }
        );
      }

      // TODO: 插入page部分
      // pages开始，逗号结尾的部分
      const pageConfigReg = /['"]?pages['"]?: \[([^\]]+)\],/;
      // 将pages按照逗号分隔为数组
      const pageList = pageConfigReg
        .exec(contentMain)[1]
        .replace(/\s+/g, '')
        .replace(/"/g, '')
        .replace(/\n\s+/g, '')
        .split(',')
        .filter(pn =&gt; {
          return !whiteList.includes(pn);
        });
      pageList.forEach(pagePath =&gt; {
        insertFileToPage(pagePath, cpString);
      });
    }

} catch (error) {
console.warn(error);
}
}

/\*\*

- @description: 将组件插入到 page
- @param {string} pagePath 组件 page 路径
- @param {string} cpString 要插入的组件字符串内容
- @return {_}
  _/
  function insertFileToPage(pagePath, cpString) {
  const path = require('path');
  const fs = require('fs');
  if (pagePath.indexOf('wxml' &lt; 0)) {
  pagePath += '.wxml';
  }
  const pageContent = fs.readFileSync(path.resolve(pagePath), {
  encoding: 'utf-8',
  });
  // 组件（'new-user-dialog':）正则
  const compReg = new RegExp(cpString);

// 没有引用标签则添加标签引用
if (!compReg.test(pageContent)) {
const { EOL } = require('os');
const pageLine = pageContent.split(/\r?\n/g);
// 添加到最后一行
pageLine[pageLine.length - 1] += `${EOL}${cpString}`;
fs.writeFileSync(path.resolve(pagePath), pageLine.join(EOL), {
encoding: 'utf-8',
});
}
}

/\*\*

- @description: 将组件插入到小程序项目，包括 app.json 和 page
- @param {string} cpName 组件名
- @param {string} cpPath 组件路径
- @param {string} cpString 要插入的组件字符串内容
- @param {Array&lt;string&gt;} whiteList 不需要插入的组件
- @return {_}
  _/
  function deleteComponent(
  cpName = 'new-user-dialog',
  cpPath = '/components/newUserDialog/newUserDialog',
  cpString = `&lt;new-user-dialog class="new-user-dialog"&gt;&lt;/new-user-dialog&gt;`,
  whiteList = [
  'pages/mine/login/logout/logut',
  'pages/mine/login/method/method',
  'pages/mine/login/scan/scan',
  'pages/mine/login/people/people',
  'pages/mine/collect/collect',
  ]
  ) {
  try {
  const path = require('path');
  const fs = require('fs');
  const entryFilePath = './app.json';

      if (fs.statSync(entryFilePath)) {
        // app.json 内容
        const contentMain = fs.readFileSync(path.resolve(entryFilePath), {
          encoding: 'utf-8',
        });
        // pages开始，逗号结尾的部分
        const pageConfigReg = /['"]?pages['"]?: \[([^\]]+)\],/;
        // 将pages按照逗号分隔为数组
        const pageList = pageConfigReg
          .exec(contentMain)[1]
          .replace(/\s+/g, '')
          .replace(/"/g, '')
          .replace(/\n\s+/g, '')
          .split(',')
          .filter(pn =&gt; {
            return !whiteList.includes(pn);
          });
        pageList.forEach(pagePath =&gt; {
          deleteFileToPage(pagePath, cpString);
        });
      }

  } catch (error) {
  console.warn(error);
  }
  }

/\*\*

- @description: 将组件从 page 中删除
- @param {string} pagePath 组件 page 路径
- @param {string} cpString 要删除的组件字符串内容
- @return {_}
  _/
  function deleteFileToPage(pagePath, cpString) {
  const path = require('path');
  const fs = require('fs');
  if (pagePath.indexOf('wxml' &lt; 0)) {
  pagePath += '.wxml';
  }
  let pageContent = fs.readFileSync(path.resolve(pagePath), {
  encoding: 'utf-8',
  });
  // 组件（'new-user-dialog':）正则
  const compReg = new RegExp(cpString, 'g');

// 有引用标签则删除标签引用
if (compReg.test(pageContent)) {
pageContent = pageContent.replace(compReg, '');
fs.writeFileSync(path.resolve(pagePath), pageContent, {
encoding: 'utf-8',
});
}
}

// deleteComponent()
insertComponent();

</code></pre>
<p>
使用
<br/>
node .\generator\index.js
</p>
<p>
参考
<br/>
https://blog.csdn.net/weixin_43972437/article/details/124765077
</p>

   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f62:6c6f672e6373646e2e6e65742f71715f34333538353232392f:61727469636c652f64657461696c732f313235373138323935" class_="artid" style="display:none">
 </p>
</div>
