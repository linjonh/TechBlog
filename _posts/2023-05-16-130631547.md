---
layout: post
title: "QtQtWebApp开发笔记一QtWebApp介绍下载和搭建基础封装http轻量级服务器Demo"
date: 2023-05-16 10:01:47 +0800
description: "在arm上做了Qt的应用程序，为了在局域网实现web页的访问方式来配置arm上Qt的程序，局域网轻量"
keywords: "qt6没有qtwebapp"
categories: ['Qt']
tags: ['笔记', 'Qtwebapp', 'Qt', 'Http']
artid: "130631547"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=130631547
    alt: "QtQtWebApp开发笔记一QtWebApp介绍下载和搭建基础封装http轻量级服务器Demo"
render_with_liquid: false
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     Qt+QtWebApp开发笔记（一）：QtWebApp介绍、下载和搭建基础封装http轻量级服务器Demo
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <p>
     若该文为原创文章，转载请注明原文出处
     <br/>
     本文章博客地址：
     <a href="https://hpzwl.blog.csdn.net/article/details/130631547" rel="nofollow">
      https://hpzwl.blog.csdn.net/article/details/130631547
     </a>
    </p>
    <p>
     <a href="https://hpzwl.blog.csdn.net/article/details/102478062" rel="nofollow">
      红胖子网络科技博文大全：开发技术集合（包含Qt实用技术、树莓派、三维、OpenCV、OpenGL、ffmpeg、OSG、单片机、软硬结合等等）持续更新中…
     </a>
    </p>
    <h2>
     <a id="Qthttpsblogcsdnnetqq21497936articledetails102478062QtE5BC80E58F91E4B893E6A08FEFBC9AE887AAE5B8A6E5BA93E5928CE4B889E696B9E5BA93E79A84E4BDBFE794A8_4">
     </a>
     <a href="https://blog.csdn.net/qq21497936/article/details/102478062#Qt%E5%BC%80%E5%8F%91%E4%B8%93%E6%A0%8F%EF%BC%9A%E8%87%AA%E5%B8%A6%E5%BA%93%E5%92%8C%E4%B8%89%E6%96%B9%E5%BA%93%E7%9A%84%E4%BD%BF%E7%94%A8">
      Qt开发专栏：三方库开发技术
     </a>
    </h2>
    <p>
     上一篇：没有了
     <br/>
     下一篇：《
     <a href="https://hpzwl.blog.csdn.net/article/details/130762721" rel="nofollow">
      Qt+QtWebApp开发笔记（二）：http服务器日志系统介绍、添加日志系统至Demo测试
     </a>
     》
    </p>
    <br/>
    <h2>
     <a id="_10">
     </a>
     前言
    </h2>
    <p>
     在arm上做了Qt的应用程序，为了在局域网实现web页的访问方式来配置arm上Qt的程序，局域网轻量级http服务器是很好的实现方式之一，有机会做国产麒麟上Qt的http服务器，正好接触到了QtWebApp可以实现。
     <br/>
     本篇实战解说QtWebApp的轻量级Demo。
     <br/>
     本篇篇幅较长，为了保持基础的完整性将必要的东西都放在本篇。
    </p>
    <br/>
    <h2>
     <a id="Demo_17">
     </a>
     Demo
    </h2>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/e1932b356e546b372d786b40f7851c4b.png"/>
    </p>
    <h3>
     <a id="_19">
     </a>
     下载地址
    </h3>
    <p>
     链接：
     <a href="https://pan.baidu.com/s/1tSFWCTsbPY5c1rWo2Mxz_Q?pwd=1234" rel="nofollow">
      https://pan.baidu.com/s/1tSFWCTsbPY5c1rWo2Mxz_Q?pwd=1234
     </a>
    </p>
    <br/>
    <h2>
     <a id="QtWebAppHTTP_Server_in_C_24">
     </a>
     QtWebApp（HTTP Server in C++）
    </h2>
    <h3>
     <a id="_25">
     </a>
     概述
    </h3>
    <p>
     QtWepApp是一个C++中的HTTP服务器库，其灵感来自Java Servlet。适用于Linux、Windows、Mac OS和Qt Framework支持的许多其他操作系统。
     <br/>
     QtWebApp包含以下组件：
    </p>
    <ul>
     <li>
      <strong>
       HTTP(S)1.0和1.1服务器
      </strong>
     </li>
     <li>
      <strong>
       模板引擎
      </strong>
     </li>
     <li>
      <strong>
       缓冲记录器
      </strong>
      <br/>
      这些组件可以相互独立地使用。一个非常小的用法示例：
     </li>
    </ul>
    <pre><code class="prism language-cpp"><span class="token comment">// The main program starts the HTTP server</span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    QCoreApplication <span class="token function">app</span><span class="token punctuation">(</span>argc<span class="token punctuation">,</span>argv<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
    <span class="token keyword">new</span> <span class="token function">HttpListener</span><span class="token punctuation">(</span>
        <span class="token keyword">new</span> <span class="token function">QSettings</span><span class="token punctuation">(</span><span class="token string">"configfile.ini"</span><span class="token punctuation">,</span> QSettings<span class="token operator">::</span>IniFormat<span class="token punctuation">,</span> <span class="token operator">&amp;</span>app<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token keyword">new</span> <span class="token function">MyRequestHandler</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>app<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token operator">&amp;</span>app<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> app<span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token comment">// The request handler receives and responds HTTP requests</span>
<span class="token keyword">void</span> <span class="token class-name">MyRequestHandler</span><span class="token operator">::</span><span class="token function">service</span><span class="token punctuation">(</span>HttpRequest<span class="token operator">&amp;</span> request<span class="token punctuation">,</span> HttpResponse<span class="token operator">&amp;</span> response<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">// Get a request parameters</span>
    QByteArray username<span class="token operator">=</span>request<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span><span class="token string">"username"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Set a response header</span>
    response<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">"Content-Type"</span><span class="token punctuation">,</span> <span class="token string">"text/html; charset=UTF-8"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Generate the HTML document</span>
    response<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">"&lt;html&gt;&lt;body&gt;"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    response<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">"Hello "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    response<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span><span class="token punctuation">;</span>
    response<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">"&lt;/body&gt;&lt;/html&gt;"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     <strong>
      大约2MB的小内存需求使web服务器有资格用于嵌入式系统（PS：非常符合后续arm产品定位）。对于更大的网络服务来说，它也足够强大。
     </strong>
     <br/>
     <strong>
      记录器通过将调试消息保留在内存中直到出现错误来提高磁盘空间和性能。只要一切正常，就不会编写调试消息。
      <br/>
      对记录器配置的更改将自动变为活动状态，而无需重新启动程序。
     </strong>
     <br/>
     该库使用Qt 4.7至6.x版本运行。如果是Qt 6，则需要安装Qt5Compat库。它包含对许多8位字符编码的支持，Qt6默认情况下不再支持这些编码。可以在LGPL许可证的条件下使用该软件。
     <br/>
     作者项目的起源
     <br/>
     多年前，一位经验丰富的Java开发人员坚持认为Java是互联网语言，因为在其他编程语言中进行互联网通信要复杂得多。这不正确，但拒绝相信。所以开始挑战。
     <br/>
     任务：与Qt4相比，仅使用Java 6运行时库对具有一些基本功能的HTTP服务器进行编程。
     <br/>
     两个项目都很相似，实现了任务。同时，Qt/C++程序比Java版本小得多，也快得多。
     <br/>
     几年后，用这个原型制作了一个库，并将其用于一些私人项目。大学鼓励发布代码。从那以后，再也不用这个项目了，但还是进行了一些改进，让人们感到高兴。
     <br/>
     有趣的是，Qt制造商多年来一直在开发标准HTTP服务器，但到2022年，它仍然不包括在Qt库中。这也许可以解释为什么很多人使用的库。
    </p>
    <h3>
     <a id="QtWebApp_73">
     </a>
     QtWebApp下载地址
    </h3>
    <p>
     官方：
     <a href="http://www.stefanfrings.de/qtwebapp/QtWebApp.zip" rel="nofollow">
      http://www.stefanfrings.de/qtwebapp/QtWebApp.zip
     </a>
     <br/>
     链接：
     <a href="https://pan.baidu.com/s/1v9DTrajX8Mv-xnhScDhN8g?pwd=1234" rel="nofollow">
      https://pan.baidu.com/s/1v9DTrajX8Mv-xnhScDhN8g?pwd=1234
     </a>
    </p>
    <h3>
     <a id="Web_76">
     </a>
     编写Web服务器应用程序环境
    </h3>
    <p>
     使用Qt和QtWebApp在C++中开发HTTP Web服务器应用程序。必须已经了解C++和HTML的基本知识。
    </p>
    <h3>
     <a id="Windows_78">
     </a>
     Windows
    </h3>
    <p>
     安装好Qt，下载QtWebApp源码；
    </p>
    <h3>
     <a id="Linux_80">
     </a>
     Linux
    </h3>
    <p>
     安装好Qt，下载QtWebApp源码，然后对应不同linux安装一些软件如下：
    </p>
    <ul>
     <li>
      <strong>
       Debian, Ubuntu
      </strong>
     </li>
    </ul>
    <pre><code class="prism language-shell"><span class="token function">sudo</span> <span class="token function">apt</span> <span class="token function">install</span> build-essential gdb libgl1-mesa-dev
</code></pre>
    <ul>
     <li>
      <strong>
       Fedora, RedHat, CentOS sudo
      </strong>
     </li>
    </ul>
    <pre><code class="prism language-shell">yum groupDebian, Ubuntunstall <span class="token string">"C Development Tools and Libraries"</span>
<span class="token function">sudo</span> yum <span class="token function">install</span> mesa-libGL-devel
</code></pre>
    <ul>
     <li>
      <strong>
       openSUSE
      </strong>
     </li>
    </ul>
    <pre><code class="prism language-shell"><span class="token function">sudo</span> <span class="token function">zypper</span> <span class="token function">install</span> -t pattern devel_basis
</code></pre>
    <h4>
     <a id="Demoubuntu_95">
     </a>
     运行下载的Demo（这里是ubuntu环境）
    </h4>
    <p>
     为的编程项目创建一个目录，然后在那里下载并提取QtWebApp ZIP文件。启动QT Creator IDE并打开项目文件Demo1/Demo1.pro。这将打开“配置项目”对话框：
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/01649e43a696349e2b0e103854e9c466.png"/>
    </p>
    <p>
     只需点击突出显示的“配置项目”按钮即可。然后点击左边框中的绿色“Run”按钮，构建并运行演示程序。当的计算机正忙时，可以通过单击底部边框中的相关按钮来观看“编译输出”窗格。如果一切正常，将打开一个黑色控制台窗口，告诉演示应用程序正在使用哪个配置文件：
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/c68feb4637aab0d7e47f21ccb6604090.png"/>
    </p>
    <p>
     打开URL http://localhost:8080在web浏览器中检查演示web服务器是否正常工作：
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/04977620cfee8c60eeceeb98e2a181dc.png">
      <br/>
      如果在屏幕上看到那个网站，所有需要的软件都能正常工作。现在可以关闭演示应用程序。
     </img>
    </p>
    <h3>
     <a id="QtWebApp_105">
     </a>
     如何使用QtWebApp
    </h3>
    <p>
     如果曾经使用Java Servlet API开发过web服务器应用程序，会感觉像在家一样。的库提供了几乎相同的功能。将向展示如何使用QtWebApp编写一个最小的web服务器应用程序。
    </p>
    <h4>
     <a id="_107">
     </a>
     在自己的程序中构建
    </h4>
    <p>
     提取编程文件夹中的QtWebApp.zip文件，并创建一个名为“MyFirstWebApp”的新Qt控制台项目（如果尚未完成）。然后，应该拥有与相同的文件夹结构：
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/30a739323c9c3d60d05558d3a58ac9fd.png"/>
    </p>
    <p>
     将以下行添加到MyFirstWebApp项目的项目文件中：
    </p>
    <pre><code class="prism language-cpp">QT <span class="token operator">+=</span> network
<span class="token function">include</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token operator">/</span>QtWebApp<span class="token operator">/</span>QtWebApp<span class="token operator">/</span>httpserver<span class="token operator">/</span>httpserver<span class="token punctuation">.</span>pri<span class="token punctuation">)</span>
</code></pre>
    <p>
     第一行激活Qt的网络模块，第二行包括QtWebApp的HTTP服务器模块的源代码。因此，当编译程序时，HTTP服务器将成为可执行文件的一部分。
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/aba2dd671827de7d29cdf0efb30b7f37.png">
      <br/>
      作为替代方案，可以使用共享库。要生成它，请打开项目QtWebApp/QtWebApp-QtWebApp.pro并构建它。然后查看QtWebApp/Demo2/Demo2.pro，了解如何链接到共享库。然而，建议包含如上所示的源代码，因为这样不太容易出错。
     </img>
    </p>
    <h4>
     <a id="_119">
     </a>
     配置参数
    </h4>
    <p>
     下一步是创建配置文件MyFirstWebApp/etc/webapp1.ini。需要使用操作系统的文件管理器来执行此操作，因为Qt Creator无法创建新文件夹。文件内容为：
    </p>
    <pre><code class="prism language-cpp"><span class="token punctuation">[</span>listener<span class="token punctuation">]</span>
<span class="token punctuation">;</span>host<span class="token operator">=</span><span class="token number">192.168</span><span class="token punctuation">.</span><span class="token number">0.100</span>
port<span class="token operator">=</span><span class="token number">8080</span>
minThreads<span class="token operator">=</span><span class="token number">4</span>
maxThreads<span class="token operator">=</span><span class="token number">100</span>
cleanupInterval<span class="token operator">=</span><span class="token number">60000</span>
readTimeout<span class="token operator">=</span><span class="token number">60000</span>
maxRequestSize<span class="token operator">=</span><span class="token number">16000</span>
maxMultiPartSize<span class="token operator">=</span><span class="token number">10000000</span>
</code></pre>
    <p>
     主机和端口参数指定web服务器侦听的IP地址和端口。
     <strong>
      如果注释掉主机（如上所述），则服务器将侦听所有网络接口。
      <strong>
       公共web服务器使用端口80，而内部web服务器通常在端口8080上侦听。可以使用任何喜欢的自由端口。
       <br/>
       Unix用户应该记住，1024以下的端口号是为“root”用户保留的。Windows用户可能需要配置Windows防火墙以允许从其他计算机进行访问。
       <br/>
       <strong>
        QtWebApp可以同时处理多个HTTP请求，因此它是多线程的。由于启动一个新线程需要花费大量时间，QtWebApp会将线程重新用于后续的HTTP请求。
       </strong>
       <br/>
       <strong>
        maxThreads
       </strong>
       值指定并发工作线程的最大数量。在进入生产环境之前，应该使用负载生成器工具来了解服务器在不耗尽内存或变得迟缓的情况下可以处理多少负载。
       <br/>
       <strong>
        minThreads
       </strong>
       空闲时并发工作线程的最小数量。web服务器总是以一个空线程池开始。线程是在HTTP请求传入时按需创建的。空闲线程由计时器缓慢关闭。每个
      </strong>
      cleanupInterval
     </strong>
     （以毫秒为单位），服务器都会关闭一个空闲线程，但是minThreads的数量总是保持运行。使用给定的值，的服务器最多可以处理100个并发HTTP连接。它保持4个空闲的工作线程运行，以确保良好的响应时间。
     <br/>
     <strong>
      readTimeout
     </strong>
     设置通过打开大量连接而不使用这些连接来保护服务器免受简单的拒绝服务攻击的超时时间。空闲连接在该毫秒数之后关闭。在正常情况下，网络浏览器负责关闭连接。
     <br/>
     <strong>
      maxRequestSize
     </strong>
     保护服务器不受非常大的HTTP请求造成的内存过载的影响。此值适用于常规请求。
     <br/>
     <strong>
      maxMultiPartSize
     </strong>
     值适用于web浏览器将文件上载到服务器时发生的多部件请求。如果想接收10兆字节的文件，由于HTTP协议开销，必须将此值设置得稍大一些。
     <br/>
     上传的文件存储在临时文件中。临时文件夹的位置由操作系统定义。
     <br/>
     继续创建的第一个web应用程序。要使此配置文件在Qt Creator中可见，请在项目文件中添加一行：
    </p>
    <pre><code class="prism language-cpp">OTHER_FILES <span class="token operator">+=</span> etc<span class="token operator">/</span>webapp1<span class="token punctuation">.</span>ini
</code></pre>
    <p>
     现在添加一些代码来加载该文件：
    </p>
    <pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;QCoreApplication&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;QSettings&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    QCoreApplication <span class="token function">app</span><span class="token punctuation">(</span>argc<span class="token punctuation">,</span> argv<span class="token punctuation">)</span><span class="token punctuation">;</span>

    QSettings<span class="token operator">*</span> listenerSettings<span class="token operator">=</span>
         <span class="token keyword">new</span> <span class="token function">QSettings</span><span class="token punctuation">(</span><span class="token string">"/home/sfrings/programming/MyFirstWebApp/etc/webapp1.ini"</span><span class="token punctuation">,</span>QSettings<span class="token operator">::</span>IniFormat<span class="token punctuation">,</span><span class="token operator">&amp;</span>app<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">qDebug</span><span class="token punctuation">(</span><span class="token string">"config file loaded"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> app<span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     但更喜欢在几个文件夹中自动搜索配置文件，这样就可以在IDE内外运行应用程序，而无需更改路径：
    </p>
    <pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;QCoreApplication&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;QSettings&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;QFile&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;QDir&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;QString&gt;</span></span>

<span class="token comment">/**
 * Search the configuration file.
 * Aborts the application if not found.
 * @return The valid filename
 */</span>
QString <span class="token function">searchConfigFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    QString binDir<span class="token operator">=</span><span class="token class-name">QCoreApplication</span><span class="token operator">::</span><span class="token function">applicationDirPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    QString appName<span class="token operator">=</span><span class="token class-name">QCoreApplication</span><span class="token operator">::</span><span class="token function">applicationName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    QString <span class="token function">fileName</span><span class="token punctuation">(</span><span class="token string">"Demo1.ini"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    QStringList searchList<span class="token punctuation">;</span>
    searchList<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>binDir<span class="token punctuation">)</span><span class="token punctuation">;</span>
    searchList<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>binDir<span class="token operator">+</span><span class="token string">"/etc"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    searchList<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>binDir<span class="token operator">+</span><span class="token string">"/../etc"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    searchList<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>binDir<span class="token operator">+</span><span class="token string">"/../"</span><span class="token operator">+</span>appName<span class="token operator">+</span><span class="token string">"/etc"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">// for development with shadow build (Linux)</span>
    searchList<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>binDir<span class="token operator">+</span><span class="token string">"/../../"</span><span class="token operator">+</span>appName<span class="token operator">+</span><span class="token string">"/etc"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// for development with shadow build (Windows)</span>
    searchList<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token class-name">QDir</span><span class="token operator">::</span><span class="token function">rootPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">"etc/opt"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    searchList<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token class-name">QDir</span><span class="token operator">::</span><span class="token function">rootPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">"etc"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">foreach</span> <span class="token punctuation">(</span>QString dir<span class="token punctuation">,</span> searchList<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        QFile <span class="token function">file</span><span class="token punctuation">(</span>dir<span class="token operator">+</span><span class="token string">"/"</span><span class="token operator">+</span>fileName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>file<span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            fileName<span class="token operator">=</span><span class="token function">QDir</span><span class="token punctuation">(</span>file<span class="token punctuation">.</span><span class="token function">fileName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">canonicalPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">qDebug</span><span class="token punctuation">(</span><span class="token string">"Using config file %s"</span><span class="token punctuation">,</span><span class="token function">qPrintable</span><span class="token punctuation">(</span>fileName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> fileName<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// not found</span>
    <span class="token function">foreach</span> <span class="token punctuation">(</span>QString dir<span class="token punctuation">,</span> searchList<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">qWarning</span><span class="token punctuation">(</span><span class="token string">"%s/%s not found"</span><span class="token punctuation">,</span><span class="token function">qPrintable</span><span class="token punctuation">(</span>dir<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">qPrintable</span><span class="token punctuation">(</span>fileName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">qFatal</span><span class="token punctuation">(</span><span class="token string">"Cannot find config file %s"</span><span class="token punctuation">,</span><span class="token function">qPrintable</span><span class="token punctuation">(</span>fileName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    QCoreApplication <span class="token function">app</span><span class="token punctuation">(</span>argc<span class="token punctuation">,</span> argv<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Load the configuration file</span>
    QString configFileName<span class="token operator">=</span><span class="token function">searchConfigFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    QSettings<span class="token operator">*</span> listenerSettings<span class="token operator">=</span><span class="token keyword">new</span> <span class="token function">QSettings</span><span class="token punctuation">(</span>configFileName<span class="token punctuation">,</span> QSettings<span class="token operator">::</span>IniFormat<span class="token punctuation">,</span> <span class="token operator">&amp;</span>app<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">qDebug</span><span class="token punctuation">(</span><span class="token string">"config file loaded"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> app<span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     过程
     <strong>
      searchConfigFile
     </strong>
     ()在多个文件夹中搜索文件。
     <br/>
     方法**QDir::canonicalPath()
     <strong>
      将相对路径名转换为绝对形式，这在下面的调试消息中看起来更好。
      <br/>
      如果找不到该文件，则应用程序会输出一条带有
     </strong>
     qFatal()**的错误消息，这也会中止程序。
     <br/>
     一旦加载了配置文件，就可以创建一个HTTP侦听器对象，它是web服务器的核心：
    </p>
    <pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;QCoreApplication&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;QSettings&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;QFile&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;QDir&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;QString&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"httplistener.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"httprequesthandler.h"</span></span>

<span class="token keyword">using</span> <span class="token keyword">namespace</span> stefanfrings<span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    QCoreApplication <span class="token function">app</span><span class="token punctuation">(</span>argc<span class="token punctuation">,</span> argv<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// Load the configuration file</span>
    QString configFileName<span class="token operator">=</span><span class="token function">searchConfigFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    
    QSettings<span class="token operator">*</span> listenerSettings<span class="token operator">=</span><span class="token keyword">new</span> <span class="token function">QSettings</span><span class="token punctuation">(</span>configFileName<span class="token punctuation">,</span> QSettings<span class="token operator">::</span>IniFormat<span class="token punctuation">,</span> <span class="token operator">&amp;</span>app<span class="token punctuation">)</span><span class="token punctuation">;</span>
    listenerSettings<span class="token operator">-&gt;</span><span class="token function">beginGroup</span><span class="token punctuation">(</span><span class="token string">"listener"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// Start the HTTP server</span>
    <span class="token keyword">new</span> <span class="token function">HttpListener</span><span class="token punctuation">(</span>listenerSettings<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token function">HttpRequestHandler</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>app<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>app<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> app<span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     方法**QSettings::beginGroup()**从配置文件中选择组“[listener]”。稍后将添加更多组。
     <br/>
     <strong>
      HttpRequestHandler接收所有传入的HTTP请求，并生成响应。默认情况下，请求处理程序只返回一个错误页面。
     </strong>
     <br/>
     在堆上用“new”创建HttpListener是很重要的，否则它将在程序启动后立即终止。
     <br/>
     运行程序并打开URLhttp://localhost:8080在web浏览器中。将在控制台窗口中收到错误页面“501未实现”和调试消息。
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/47fdd44ff341761f31084d773d3fe35e.png">
      <br/>
      这是很多会减慢程序速度的消息，但它们对调试很有帮助。在Qt Creator的左边框中，可以通过单击紫色按钮将构建模式从“调试”更改为“发布”。发布版本不那么冗长：
      <br/>
      <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/094b926555459ce5ce7700f29734d373.png"/>
     </img>
    </p>
    <p>
     因此，对于生产，应该更喜欢发布版本。
    </p>
    <h4>
     <a id="_260">
     </a>
     编写自己的请求处理程序
    </h4>
    <p>
     为了输出“Hello World”消息，
     <strong>
      必须编写自己的请求处理程序
     </strong>
     。用鼠标右键单击src文件夹，选择“添加新…”，然后选择“C++类”。
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/0f59f498acba7bd468e2e8dbe39e1a70.png"/>
    </p>
    <h5>
     <a id="helloworldcontrollerh_263">
     </a>
     helloworldcontroller.h:
    </h5>
    <pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">HELLOWORLDCONTROLLER_H</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">HELLOWORLDCONTROLLER_H</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"httprequesthandler.h"</span></span>

<span class="token keyword">using</span> <span class="token keyword">namespace</span> stefanfrings<span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">HelloWorldController</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> <span class="token class-name">HttpRequestHandler</span></span> <span class="token punctuation">{<!-- --></span>
    Q_OBJECT
<span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token function">HelloWorldController</span><span class="token punctuation">(</span>QObject<span class="token operator">*</span> parent<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token function">service</span><span class="token punctuation">(</span>HttpRequest<span class="token operator">&amp;</span> request<span class="token punctuation">,</span> HttpResponse<span class="token operator">&amp;</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">// HELLOWORLDCONTROLLER_H</span></span>
</code></pre>
    <h5>
     <a id="helloworldcontrollercpp_281">
     </a>
     helloworldcontroller.cpp:
    </h5>
    <pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"helloworldcontroller.h"</span></span>

<span class="token class-name">HelloWorldController</span><span class="token operator">::</span><span class="token function">HelloWorldController</span><span class="token punctuation">(</span>QObject<span class="token operator">*</span> parent<span class="token punctuation">)</span>
    <span class="token operator">:</span> <span class="token function">HttpRequestHandler</span><span class="token punctuation">(</span>parent<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// empty</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token class-name">HelloWorldController</span><span class="token operator">::</span><span class="token function">service</span><span class="token punctuation">(</span>HttpRequest <span class="token operator">&amp;</span>request<span class="token punctuation">,</span> HttpResponse <span class="token operator">&amp;</span>response<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    response<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">"Hello World"</span><span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     可选参数“true”表示这是当前HTTP请求的最后一次write()调用。
     <br/>
     main.cpp中的两个更改：
    </p>
    <pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"helloworldcontroller.h"</span></span>

    <span class="token keyword">new</span> <span class="token function">HttpListener</span><span class="token punctuation">(</span>listenerSettings<span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token function">HelloWorldController</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>app<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>app<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <p>
     运行程序并打开URLhttp://localhost:8080在网络浏览器中。
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/11dfc49619abab1d55ec474fd3451dca.png"/>
    </p>
    <br/>
    <h2>
     <a id="QthttpDemowindows_306">
     </a>
     Qt的http服务Demo搭建流程（windows）
    </h2>
    <p>
     因为http很多时候是放在一个Qt界面里面，所以搭建的是QWidget工程模板，非控制台，有需要自行切换下。
    </p>
    <h3>
     <a id="QtWebApp_308">
     </a>
     步骤一：下载QtWebApp
    </h3>
    <p>
     略；
    </p>
    <h3>
     <a id="testHttpDemo_310">
     </a>
     步骤二：新建工程testHttpDemo
    </h3>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/d843f7dc717e7d1d1fbdc0f3cf6b6466.png"/>
    </p>
    <h3>
     <a id="http_313">
     </a>
     步骤三：拷贝http
    </h3>
    <p>
     将QtWebApp中的httpserver，符合模块化设计准则，如下图：
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/357782f6d66c06287c0ce121510fcb16.png"/>
    </p>
    <p>
     添加模块进入工程：
     <br/>
     httpserver模块，QtWebApp自带的三方模块
    </p>
    <pre><code class="prism language-shell"><span class="token comment"># httpserver模块，QtWebApp自带的三方模块</span>
include <span class="token punctuation">(</span>$<span class="token environment constant">$PWD</span>/modules/httpserver/httpserver.pri<span class="token punctuation">)</span>
</code></pre>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/8fcf0e211e6a19f6db7845d3f27e245c.png"/>
    </p>
    <p>
     第三方的模块。
    </p>
    <h3>
     <a id="http_326">
     </a>
     步骤四：自建http管理类用模块化
    </h3>
    <p>
     再建立一个http管理类来处理，如下：
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/65e74e033fbb7fa73e6a646a63342e0d.png"/>
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/93b24aea9717363f4b9469ad8c03dc54.png"/>
    </p>
    <p>
     再建立基本配置：
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/81a645c180e43b6d30223a72433d67e5.png"/>
    </p>
    <p>
     至此，基础模块搭建好，下面需要开始写http的消息处理过程。
    </p>
    <h3>
     <a id="Hello_world_335">
     </a>
     步骤五：写一个Hello world的展示消息处理
    </h3>
    <p>
     继承HttpRequestHandler消息处理类，开始新建一个类：
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/eeca92bc37ffb9165618c77e1f99b70f.png"/>
    </p>
    <p>
     引入头文件，命名空间，做一些基础处理：
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/a52694ac3a2a238125dcb55f7dbf65a9.png"/>
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/0d34fcbc4554353951884f02b3de0d6a.png"/>
    </p>
    <p>
     然后要实现service服务接口：
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/26fec69c6f7a2e6428be93b8046a0771.png"/>
    </p>
    <p>
     如下图：
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/1955255d0efb877d1983b78a39821830.png"/>
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/ea821cf62f3dd0d0a13c3d90170e8149.png"/>
    </p>
    <h3>
     <a id="http_350">
     </a>
     步骤六：在http运行管理类中启用这个监听
    </h3>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/5a0b6f536eb275a466558f22756ab4a3.png"/>
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/a73bd32a7b2cd5742e51e0492759c8bc.png"/>
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/60df53962af1320836bb7daff146d572.png"/>
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/b39cc22772dc39417ab8a7b213bc9aae.png"/>
     <br/>
     这里已经将http的轻量级服务器已经子线程模块化融入带界面的qt应用中（带不带界面融入过程都一样，只是QApplication和QCoreApplication以及在哪初始化的问题了）
    </p>
    <h4>
     <a id="_357">
     </a>
     步骤七：测试
    </h4>
    <p>
     测试127.0.0.1移植连接补上，查看 “
     <strong>
      入坑二
     </strong>
     ”。
     <br/>
     然后测试打开成功：
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/c0fcfb6061ba790139214e2fa87fd662.png"/>
    </p>
    <p>
     这里有个字符编码的问题也要同时解决一下，一般来说都是utf-8，所以要字符编码修改一下。
    </p>
    <h4>
     <a id="_363">
     </a>
     步骤八：编码一刀切处理
    </h4>
    <p>
     我们忽略系统编码，统一进行utf-8进行转换，避免因为系统问题而去单独处理这个问题：
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/72a06c253a9d9be853ed7ac4a1f5c23c.png"/>
    </p>
    <p>
     然后测试网页：
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/6e8fdcb43eeccea20871588752bbbc86.png"/>
    </p>
    <h4>
     <a id="_370">
     </a>
     步骤九：打成运行包单独运行再测试服务器
    </h4>
    <p>
     除了日志，没发现三方模块中有是否监听成功的反馈，所以日志就显得很重要，日志在下一篇再融于进来
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/c7ba68d60e47668585015e23a05053b5.png"/>
    </p>
    <p>
     <strong>
      至此，一个基础子线程模块化的http服务的qt界面应用Demo就完成了
     </strong>
     。
    </p>
    <br/>
    <h2>
     <a id="_378">
     </a>
     模块化
    </h2>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/e079cfe787ad8083f6489e31704aff5d.png"/>
    </p>
    <br/>
    <h2>
     <a id="Demo_383">
     </a>
     Demo源码
    </h2>
    <h3>
     <a id="HttpServerManagerh_384">
     </a>
     HttpServerManager.h
    </h3>
    <pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">HTTPSERVERMANAGER_H</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">HTTPSERVERMANAGER_H</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;QObject&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;QMutex&gt;</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"httplistener.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"HelloWorldRequestHandler.h"</span></span>

<span class="token keyword">class</span> <span class="token class-name">HttpServerManager</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> <span class="token class-name">QObject</span></span>
<span class="token punctuation">{<!-- --></span>
    Q_OBJECT
<span class="token keyword">private</span><span class="token operator">:</span>
    <span class="token keyword">explicit</span> <span class="token function">HttpServerManager</span><span class="token punctuation">(</span>QObject <span class="token operator">*</span>parent <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token keyword">static</span> HttpServerManager <span class="token operator">*</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">public</span><span class="token operator">:</span>
    QString <span class="token function">getIp</span><span class="token punctuation">(</span><span class="token punctuation">)</span>               <span class="token keyword">const</span><span class="token punctuation">;</span>            <span class="token comment">// 服务器监听ip（若为空，则表示监听所有ip</span>
    quint16 <span class="token function">getPort</span><span class="token punctuation">(</span><span class="token punctuation">)</span>             <span class="token keyword">const</span><span class="token punctuation">;</span>            <span class="token comment">// 服务器监听端口</span>
    <span class="token keyword">int</span>     <span class="token function">getMinThreads</span><span class="token punctuation">(</span><span class="token punctuation">)</span>       <span class="token keyword">const</span><span class="token punctuation">;</span>            <span class="token comment">// 空闲最小线程数</span>
    <span class="token keyword">int</span>     <span class="token function">getMaxThreads</span><span class="token punctuation">(</span><span class="token punctuation">)</span>       <span class="token keyword">const</span><span class="token punctuation">;</span>            <span class="token comment">// 负载最大线程数</span>
    <span class="token keyword">int</span>     <span class="token function">getCleanupInterval</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token keyword">const</span><span class="token punctuation">;</span>            <span class="token comment">// 空线程清空间隔（单位：毫秒）</span>
    <span class="token keyword">int</span>     <span class="token function">getReadTimeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span>      <span class="token keyword">const</span><span class="token punctuation">;</span>            <span class="token comment">// 保持连接空载超时时间（单位：毫秒）</span>
    <span class="token keyword">int</span>     <span class="token function">getMaxRequestSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span>   <span class="token keyword">const</span><span class="token punctuation">;</span>            <span class="token comment">// 最大请求数</span>
    <span class="token keyword">int</span>     <span class="token function">getMaxMultiPartSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span><span class="token punctuation">;</span>            <span class="token comment">// 上载文件最大数（单位：字节）</span>

<span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token keyword">void</span> <span class="token function">setIp</span><span class="token punctuation">(</span><span class="token keyword">const</span> QString <span class="token operator">&amp;</span>ip<span class="token punctuation">)</span><span class="token punctuation">;</span>                  <span class="token comment">// 服务器监听ip（若为空，则表示监听所有ip</span>
    <span class="token keyword">void</span> <span class="token function">setPort</span><span class="token punctuation">(</span><span class="token keyword">const</span> quint16 <span class="token operator">&amp;</span>port<span class="token punctuation">)</span><span class="token punctuation">;</span>              <span class="token comment">// 服务器监听端口</span>
    <span class="token keyword">void</span> <span class="token function">setMinThreads</span><span class="token punctuation">(</span><span class="token keyword">int</span> minThreads<span class="token punctuation">)</span><span class="token punctuation">;</span>             <span class="token comment">// 空闲最小线程数</span>
    <span class="token keyword">void</span> <span class="token function">setMaxThreads</span><span class="token punctuation">(</span><span class="token keyword">int</span> maxThreads<span class="token punctuation">)</span><span class="token punctuation">;</span>             <span class="token comment">// 负载最大线程数</span>
    <span class="token keyword">void</span> <span class="token function">setCleanupInterval</span><span class="token punctuation">(</span><span class="token keyword">int</span> cleanupInterval<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// 空线程清空间隔（单位：毫秒）</span>
    <span class="token keyword">void</span> <span class="token function">setReadTimeout</span><span class="token punctuation">(</span><span class="token keyword">int</span> readTimeout<span class="token punctuation">)</span><span class="token punctuation">;</span>           <span class="token comment">// 保持连接空载超时时间（单位：毫秒）</span>
    <span class="token keyword">void</span> <span class="token function">setMaxRequestSize</span><span class="token punctuation">(</span><span class="token keyword">int</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>              <span class="token comment">// 最大请求数</span>
    <span class="token keyword">void</span> <span class="token function">setMaxMultiPartSize</span><span class="token punctuation">(</span><span class="token keyword">int</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">// 上载文件最大数（单位：字节）</span>

<span class="token keyword">public</span> slots<span class="token operator">:</span>
    <span class="token keyword">void</span> <span class="token function">slot_start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token function">slot_stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">private</span><span class="token operator">:</span>
    <span class="token keyword">static</span> HttpServerManager <span class="token operator">*</span>_pInstance<span class="token punctuation">;</span>
    <span class="token keyword">static</span> QMutex _mutex<span class="token punctuation">;</span>

<span class="token keyword">private</span><span class="token operator">:</span>
    <span class="token keyword">bool</span> _running<span class="token punctuation">;</span>

<span class="token keyword">private</span><span class="token operator">:</span>
    HttpListener <span class="token operator">*</span>_pHttpListener<span class="token punctuation">;</span>                   <span class="token comment">// http服务监听器</span>
    QSettings <span class="token operator">*</span>_pSettings<span class="token punctuation">;</span>                          <span class="token comment">// 配置文件</span>

<span class="token keyword">private</span><span class="token operator">:</span>
    QString _ip<span class="token punctuation">;</span>                <span class="token comment">// 服务器监听ip（若为空，则表示监听所有ip）</span>
    quint16 _port<span class="token punctuation">;</span>              <span class="token comment">// 服务器监听端口</span>
    <span class="token keyword">int</span> _minThreads<span class="token punctuation">;</span>            <span class="token comment">// 空闲最小线程数</span>
    <span class="token keyword">int</span> _maxThreads<span class="token punctuation">;</span>            <span class="token comment">// 负载最大线程数</span>
    <span class="token keyword">int</span> _cleanupInterval<span class="token punctuation">;</span>       <span class="token comment">// 空线程清空间隔（单位：毫秒）</span>
    <span class="token keyword">int</span> _readTimeout<span class="token punctuation">;</span>           <span class="token comment">// 保持连接空载超时时间（单位：毫秒）</span>
    <span class="token keyword">int</span> _maxRequestSize<span class="token punctuation">;</span>        <span class="token comment">// 最大请求数</span>
    <span class="token keyword">int</span> _maxMultiPartSize<span class="token punctuation">;</span>      <span class="token comment">// 上载文件最大数（单位：字节）</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">// HTTPSERVERMANAGER_H</span></span>
</code></pre>
    <h3>
     <a id="HttpServerManagercpp_451">
     </a>
     HttpServerManager.cpp
    </h3>
    <pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"HttpServerManager.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;QApplication&gt;</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;QDebug&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;QDateTime&gt;</span></span>
<span class="token comment">//#define LOG qDebug()&lt;&lt;__FILE__&lt;&lt;__LINE__</span>
<span class="token comment">//#define LOG qDebug()&lt;&lt;__FILE__&lt;&lt;__LINE__&lt;&lt;__FUNCTION__</span>
<span class="token comment">//#define LOG qDebug()&lt;&lt;__FILE__&lt;&lt;__LINE__&lt;&lt;QThread()::currentThread()</span>
<span class="token comment">//#define LOG qDebug()&lt;&lt;__FILE__&lt;&lt;__LINE__&lt;&lt;QDateTime::currentDateTime().toString("yyyy-MM-dd")</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">LOG</span> <span class="token expression"><span class="token function">qDebug</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&lt;&lt;</span><span class="token constant">__FILE__</span><span class="token operator">&lt;&lt;</span><span class="token constant">__LINE__</span><span class="token operator">&lt;&lt;</span><span class="token class-name">QDateTime</span><span class="token operator">::</span><span class="token function">currentDateTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span></span><span class="token string">"yyyy-MM-dd hh:mm:ss:zzz"</span><span class="token expression"><span class="token punctuation">)</span></span></span>

HttpServerManager <span class="token operator">*</span>HttpServerManager<span class="token operator">::</span>_pInstance <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
QMutex HttpServerManager<span class="token operator">::</span>_mutex<span class="token punctuation">;</span>

<span class="token class-name">HttpServerManager</span><span class="token operator">::</span><span class="token function">HttpServerManager</span><span class="token punctuation">(</span>QObject <span class="token operator">*</span>parent<span class="token punctuation">)</span>
    <span class="token operator">:</span> <span class="token function">QObject</span><span class="token punctuation">(</span>parent<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">_pHttpListener</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">_pSettings</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">_running</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">_port</span><span class="token punctuation">(</span><span class="token number">8088</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">_minThreads</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">_maxThreads</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">_cleanupInterval</span><span class="token punctuation">(</span><span class="token number">60000</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">_readTimeout</span><span class="token punctuation">(</span><span class="token number">60000</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">_maxRequestSize</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">_maxMultiPartSize</span><span class="token punctuation">(</span><span class="token number">1024</span><span class="token operator">*</span><span class="token number">1024</span><span class="token operator">*</span><span class="token number">1024</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>

<span class="token punctuation">}</span>

HttpServerManager <span class="token operator">*</span><span class="token class-name">HttpServerManager</span><span class="token operator">::</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>_pInstance<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        QMutexLocker <span class="token function">lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>_mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>_pInstance<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            _pInstance <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">HttpServerManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> _pInstance<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token class-name">HttpServerManager</span><span class="token operator">::</span><span class="token function">slot_start</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>_running<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        LOG <span class="token operator">&lt;&lt;</span> <span class="token string">"It's running!!!"</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    _running <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    LOG <span class="token operator">&lt;&lt;</span> <span class="token string">"Succeed to run"</span><span class="token punctuation">;</span>

    <span class="token comment">// 启动http的监听</span>
    <span class="token punctuation">{<!-- --></span>
        QString httpServerPath <span class="token operator">=</span> <span class="token function">QString</span><span class="token punctuation">(</span><span class="token string">"%1/etc/httpServer.ini"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">arg</span><span class="token punctuation">(</span>qApp<span class="token operator">-&gt;</span><span class="token function">applicationDirPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>_pSettings<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            LOG <span class="token operator">&lt;&lt;</span> httpServerPath <span class="token operator">&lt;&lt;</span> <span class="token string">"exit:"</span> <span class="token operator">&lt;&lt;</span> <span class="token class-name">QFile</span><span class="token operator">::</span><span class="token function">exists</span><span class="token punctuation">(</span>httpServerPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
            _pSettings <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">QSettings</span><span class="token punctuation">(</span>httpServerPath<span class="token punctuation">,</span> QSettings<span class="token operator">::</span>IniFormat<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token number">0</span></span></span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>_ip<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            _pSettings<span class="token operator">-&gt;</span><span class="token function">setValue</span><span class="token punctuation">(</span><span class="token string">"host"</span>           <span class="token punctuation">,</span> _ip<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// ;在ini里面是注释了</span>
        <span class="token punctuation">}</span>
        _pSettings<span class="token operator">-&gt;</span><span class="token function">setValue</span><span class="token punctuation">(</span><span class="token string">"port"</span>            <span class="token punctuation">,</span> _port<span class="token punctuation">)</span><span class="token punctuation">;</span>
        _pSettings<span class="token operator">-&gt;</span><span class="token function">setValue</span><span class="token punctuation">(</span><span class="token string">"minThreads"</span>      <span class="token punctuation">,</span> _minThreads<span class="token punctuation">)</span><span class="token punctuation">;</span>
        _pSettings<span class="token operator">-&gt;</span><span class="token function">setValue</span><span class="token punctuation">(</span><span class="token string">"maxThreads"</span>      <span class="token punctuation">,</span> _maxThreads<span class="token punctuation">)</span><span class="token punctuation">;</span>
        _pSettings<span class="token operator">-&gt;</span><span class="token function">setValue</span><span class="token punctuation">(</span><span class="token string">"cleanupInterval"</span> <span class="token punctuation">,</span> _cleanupInterval<span class="token punctuation">)</span><span class="token punctuation">;</span>
        _pSettings<span class="token operator">-&gt;</span><span class="token function">setValue</span><span class="token punctuation">(</span><span class="token string">"readTimeout"</span>     <span class="token punctuation">,</span> _readTimeout<span class="token punctuation">)</span><span class="token punctuation">;</span>
        _pSettings<span class="token operator">-&gt;</span><span class="token function">setValue</span><span class="token punctuation">(</span><span class="token string">"maxRequestSize"</span>  <span class="token punctuation">,</span> _maxRequestSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
        _pSettings<span class="token operator">-&gt;</span><span class="token function">setValue</span><span class="token punctuation">(</span><span class="token string">"maxMultiPartSize"</span><span class="token punctuation">,</span> _maxMultiPartSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
        _pHttpListener <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">HttpListener</span><span class="token punctuation">(</span>_pSettings<span class="token punctuation">,</span> <span class="token keyword">new</span> HelloWorldRequestHandler<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token class-name">HttpServerManager</span><span class="token operator">::</span><span class="token function">slot_stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>_running<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        LOG <span class="token operator">&lt;&lt;</span><span class="token string">"It's not running!!!"</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    _running <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    LOG <span class="token operator">&lt;&lt;</span> <span class="token string">"Succeed to stop"</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token class-name">HttpServerManager</span><span class="token operator">::</span><span class="token function">getMaxMultiPartSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> _maxMultiPartSize<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token class-name">HttpServerManager</span><span class="token operator">::</span><span class="token function">setMaxMultiPartSize</span><span class="token punctuation">(</span><span class="token keyword">int</span> value<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    _maxMultiPartSize <span class="token operator">=</span> value<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token class-name">HttpServerManager</span><span class="token operator">::</span><span class="token function">getMaxRequestSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> _maxRequestSize<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token class-name">HttpServerManager</span><span class="token operator">::</span><span class="token function">setMaxRequestSize</span><span class="token punctuation">(</span><span class="token keyword">int</span> value<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    _maxRequestSize <span class="token operator">=</span> value<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token class-name">HttpServerManager</span><span class="token operator">::</span><span class="token function">getReadTimeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> _readTimeout<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token class-name">HttpServerManager</span><span class="token operator">::</span><span class="token function">setReadTimeout</span><span class="token punctuation">(</span><span class="token keyword">int</span> readTimeout<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    _readTimeout <span class="token operator">=</span> readTimeout<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token class-name">HttpServerManager</span><span class="token operator">::</span><span class="token function">getCleanupInterval</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> _cleanupInterval<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token class-name">HttpServerManager</span><span class="token operator">::</span><span class="token function">setCleanupInterval</span><span class="token punctuation">(</span><span class="token keyword">int</span> cleanupInterval<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    _cleanupInterval <span class="token operator">=</span> cleanupInterval<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token class-name">HttpServerManager</span><span class="token operator">::</span><span class="token function">getMaxThreads</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> _maxThreads<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token class-name">HttpServerManager</span><span class="token operator">::</span><span class="token function">setMaxThreads</span><span class="token punctuation">(</span><span class="token keyword">int</span> maxThreads<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    _maxThreads <span class="token operator">=</span> maxThreads<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token class-name">HttpServerManager</span><span class="token operator">::</span><span class="token function">getMinThreads</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> _minThreads<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token class-name">HttpServerManager</span><span class="token operator">::</span><span class="token function">setMinThreads</span><span class="token punctuation">(</span><span class="token keyword">int</span> minThreads<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    _minThreads <span class="token operator">=</span> minThreads<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

quint16 <span class="token class-name">HttpServerManager</span><span class="token operator">::</span><span class="token function">getPort</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> _port<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token class-name">HttpServerManager</span><span class="token operator">::</span><span class="token function">setPort</span><span class="token punctuation">(</span><span class="token keyword">const</span> quint16 <span class="token operator">&amp;</span>port<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    _port <span class="token operator">=</span> port<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

QString <span class="token class-name">HttpServerManager</span><span class="token operator">::</span><span class="token function">getIp</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> _ip<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token class-name">HttpServerManager</span><span class="token operator">::</span><span class="token function">setIp</span><span class="token punctuation">(</span><span class="token keyword">const</span> QString <span class="token operator">&amp;</span>ip<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    _ip <span class="token operator">=</span> ip<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <h3>
     <a id="HelloWorldRequestHandlerh_622">
     </a>
     HelloWorldRequestHandler.h
    </h3>
    <pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">HELLOWORLDREQUESTHANDLER_H</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">HELLOWORLDREQUESTHANDLER_H</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"httprequesthandler.h"</span></span>

<span class="token keyword">using</span> <span class="token keyword">namespace</span> stefanfrings<span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">HelloWorldRequestHandler</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> <span class="token class-name">HttpRequestHandler</span></span>
<span class="token punctuation">{<!-- --></span>
<span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token function">HelloWorldRequestHandler</span><span class="token punctuation">(</span>QObject <span class="token operator">*</span>parent <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token keyword">void</span> <span class="token function">service</span><span class="token punctuation">(</span>HttpRequest<span class="token operator">&amp;</span> request<span class="token punctuation">,</span> HttpResponse<span class="token operator">&amp;</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">private</span><span class="token operator">:</span>
    QTextCodec <span class="token operator">*</span>_pTextCodec<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">// HELLOWORLDREQUESTHANDLER_H</span></span>
</code></pre>
    <h3>
     <a id="HelloWorldRequestHandlercpp_645">
     </a>
     HelloWorldRequestHandler.cpp
    </h3>
    <pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"HelloWorldRequestHandler.h"</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;QTextCodec&gt;</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;QDebug&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;QDateTime&gt;</span></span>
<span class="token comment">//#define LOG qDebug()&lt;&lt;__FILE__&lt;&lt;__LINE__</span>
<span class="token comment">//#define LOG qDebug()&lt;&lt;__FILE__&lt;&lt;__LINE__&lt;&lt;__FUNCTION__</span>
<span class="token comment">//#define LOG qDebug()&lt;&lt;__FILE__&lt;&lt;__LINE__&lt;&lt;QThread()::currentThread()</span>
<span class="token comment">//#define LOG qDebug()&lt;&lt;__FILE__&lt;&lt;__LINE__&lt;&lt;QDateTime::currentDateTime().toString("yyyy-MM-dd")</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">LOG</span> <span class="token expression"><span class="token function">qDebug</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&lt;&lt;</span><span class="token constant">__FILE__</span><span class="token operator">&lt;&lt;</span><span class="token constant">__LINE__</span><span class="token operator">&lt;&lt;</span><span class="token class-name">QDateTime</span><span class="token operator">::</span><span class="token function">currentDateTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span></span><span class="token string">"yyyy-MM-dd hh:mm:ss:zzz"</span><span class="token expression"><span class="token punctuation">)</span></span></span>

<span class="token keyword">using</span> <span class="token keyword">namespace</span> stefanfrings<span class="token punctuation">;</span>

<span class="token class-name">HelloWorldRequestHandler</span><span class="token operator">::</span><span class="token function">HelloWorldRequestHandler</span><span class="token punctuation">(</span>QObject <span class="token operator">*</span>parent<span class="token punctuation">)</span>
    <span class="token operator">:</span> <span class="token function">HttpRequestHandler</span><span class="token punctuation">(</span>parent<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 返回文本(我们需要在浏览器上看，所以将Qt内部编码都转成GBK输出即可，不管他本身是哪个编码）</span>
    <span class="token comment">// WINDOWS: GBK  GB2312</span>
    <span class="token comment">// LINUX  : urf-8</span>
<span class="token comment">//    _pTextCodec = QTextCodec::codecForName("utf-8");</span>
    _pTextCodec <span class="token operator">=</span> <span class="token class-name">QTextCodec</span><span class="token operator">::</span><span class="token function">codecForName</span><span class="token punctuation">(</span><span class="token string">"GBK"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token class-name">HelloWorldRequestHandler</span><span class="token operator">::</span><span class="token function">service</span><span class="token punctuation">(</span>HttpRequest <span class="token operator">&amp;</span>request<span class="token punctuation">,</span> HttpResponse <span class="token operator">&amp;</span>response<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    LOG<span class="token punctuation">;</span>

    <span class="token comment">// 返回hello world</span>
    QString str <span class="token operator">=</span> <span class="token string">"Hello, world!!!"</span><span class="token punctuation">;</span>
    str <span class="token operator">+=</span> <span class="token string">"你好, 长沙红胖子 QQ:21497936 www.hpzwl.com"</span><span class="token punctuation">;</span>



    <span class="token comment">// 返回文本(我们需要在浏览器上看，所以将Qt内部编码都转成GBK输出即可，不管他本身是哪个编码）</span>
    QByteArray byteArray <span class="token operator">=</span> _pTextCodec<span class="token operator">-&gt;</span><span class="token function">fromUnicode</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span>
    response<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>byteArray<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <br/>
    <h2>
     <a id="_689">
     </a>
     入坑
    </h2>
    <h3>
     <a id="_690">
     </a>
     入坑一：监听配置代码动态写入失败
    </h3>
    <h4>
     <a id="_691">
     </a>
     问题
    </h4>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/048e4b8e2ab2b8b7a7d5e613e1769be0.png"/>
    </p>
    <h4>
     <a id="_693">
     </a>
     原因
    </h4>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/bc9fee5e48355e69bdf50e4652f5acb1.png"/>
     <br/>
     直接从配置文件读取的配置文件有前缀：
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/afc8be195bc184c392ef9d6b2ce25861.png"/>
     <br/>
     但是还是监听的是端口0，直接读取QtWebApp带过来的配置文件，端口也是0，无法理解直接定位源码：
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/5c46f583f37efcee97f2012ace6fe357.png"/>
     <br/>
     然后打印一下：
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/8dafbc9a5ac3a35999ff82216fd13a66.png"/>
     <br/>
     所以把这里调整好，后经过摸索发现，QSettings需要一个文件路径载体，空类路径是无法使用。
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/0bb1def72fcbde9a92cd595c6c576a06.png"/>
    </p>
    <h4>
     <a id="_703">
     </a>
     解决
    </h4>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/ac134a2e7adfb09ec137db91c41e2e61.png"/>
    </p>
    <h3>
     <a id="127001_705">
     </a>
     入坑二：127.0.0.1无法进入
    </h3>
    <h4>
     <a id="_706">
     </a>
     问题
    </h4>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/3b5f860846df80878ea3af8e8dd79b69.png"/>
    </p>
    <h4>
     <a id="_708">
     </a>
     原因
    </h4>
    <p>
     配置文件绑定了显性ip。
    </p>
    <h4>
     <a id="_710">
     </a>
     解决
    </h4>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/cd7e081c3f96e660c226200b38656701.png"/>
    </p>
    <p>
     去掉配置文件显性ip地址：
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/d8e5cc0b1f1e8d331ccfe9ac06a11ac3.png"/>
    </p>
    <p>
     再尝试：
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/d7f3a8c6ee53cf7fd367faf5889485a8.png"/>
    </p>
    <br/>
    <p>
     上一篇：没有了
     <br/>
     下一篇：《
     <a href="https://hpzwl.blog.csdn.net/article/details/130762721" rel="nofollow">
      Qt+QtWebApp开发笔记（二）：http服务器日志系统介绍、添加日志系统至Demo测试
     </a>
     》
    </p>
    <br/>
    <p>
     若该文为原创文章，转载请注明原文出处
     <br/>
     本文章博客地址：
     <a href="https://hpzwl.blog.csdn.net/article/details/130631547" rel="nofollow">
      https://hpzwl.blog.csdn.net/article/details/130631547
     </a>
    </p>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
  <div class="blog-extension-box" id="blogExtensionBox" style="width:400px;margin:auto;margin-top:12px">
  </div>
 </article>
 <p alt="68747470733a2f2f:626c6f672e6373646e2e6e65742f717132313439373933362f:61727469636c652f64657461696c732f313330363331353437" class_="artid" style="display:none">
 </p>
</div>


