---
layout: post
title: "MQTT协议发送GPS坐标到服务器"
date: 2025-01-25 23:27:39 +0800
description: "MQTT协议发送GPS坐标到服务器一、配置GPS二、配置MQTT三、用MQTT协议发送GPS到服务器"
keywords: "树莓派通过mqtt获取gps"
categories: ['笔记']
tags: ['无标签']
artid: "108679889"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=108679889
    alt: "MQTT协议发送GPS坐标到服务器"
render_with_liquid: false
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     MQTT协议发送GPS坐标到服务器
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <h3>
     <a id="MQTTGPS_0">
     </a>
     MQTT协议发送GPS坐标到服务器
    </h3>
    <p>
     <strong>
      一、配置GPS
     </strong>
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/d26be9eaaa1a5cb29e8fe47f425ced8c.png#pic_center">
      <br/>
      个人感觉USB的GPS好一些。感觉不好找的同学我这还有
      <a href="https://m.tb.cn/h.VBFMKxK?sm=70d1d1" rel="nofollow">
       淘宝链接
      </a>
      ，卖家没给钱，只是为了方便同学们。
      <br/>
      第一步买回来照着上图连线即可，我用了四根杜邦线：
      <br/>
      USB的TXD连接GPS模块的RXD，USB的RXD连接GPS模块的TXD，USB的GND连接GPS模块的GND，USB的VCC连接GPS模块的VCC。连好之后GPS天线放窗外，不然没信号；USB插在树莓派上。
     </img>
    </p>
    <p>
     第二部要用树莓派读取到GPS的信号
     <br/>
     首先查看一下这个USB，命令行输入：
    </p>
    <pre><code class="prism language-python">ls <span class="token operator">-</span>l <span class="token operator">/</span>dev<span class="token operator">/</span>tty<span class="token operator">*</span>
</code></pre>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/553a4bf2086982be0f4d2f257d83b5e1.png#pic_center"/>
    </p>
    <p>
     安装minicom
    </p>
    <pre><code class="prism language-python">sudo apt<span class="token operator">-</span>get install minicom
</code></pre>
    <p>
     安装好后使用minicom命令获取串口上的数据
    </p>
    <pre><code class="prism language-python">minicom <span class="token operator">-</span>b <span class="token number">9600</span> <span class="token operator">-</span>o <span class="token operator">-</span>D <span class="token operator">/</span>dev<span class="token operator">/</span>ttyUSB0
</code></pre>
    <p>
     顺利的话会出现下图这种数据：
    </p>
    <p>
     <img alt="图片图片图片图片图片图片图片图片图片图片" src="https://i-blog.csdnimg.cn/blog_migrate/399feb671f376def3abfbccc05b8c0e6.png#pic_center"/>
    </p>
    <p>
     第三部用Python实时读取GPS数据
     <br/>
     在终端依次输入
    </p>
    <pre><code class="prism language-python">mkdir GPS
cd GPS
touch GPS_test<span class="token punctuation">.</span>py
gedit GPS_test<span class="token punctuation">.</span>py
</code></pre>
    <p>
     把下面代码粘进去
    </p>
    <pre><code class="prism language-python"><span class="token keyword">import</span> serial <span class="token comment">#导入serial模块</span>

ser <span class="token operator">=</span> serial<span class="token punctuation">.</span>Serial<span class="token punctuation">(</span><span class="token string">"/dev/ttyUSB0"</span><span class="token punctuation">,</span><span class="token number">9600</span><span class="token punctuation">)</span><span class="token comment">#打开串口，存放到ser中，/dev/ttyUSB0是端口名，9600是波特率</span>

<span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
    line <span class="token operator">=</span> <span class="token builtin">str</span><span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>ser<span class="token punctuation">.</span>readline<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span>  <span class="token comment"># readline()是用于读取整行</span>
    <span class="token comment"># 这里如果从头取的话，就会出现b‘，所以要从第三个字符进行读取</span>
    <span class="token keyword">if</span> line<span class="token punctuation">.</span>startswith<span class="token punctuation">(</span><span class="token string">'$GPGGA'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        line <span class="token operator">=</span> <span class="token builtin">str</span><span class="token punctuation">(</span>line<span class="token punctuation">)</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">','</span><span class="token punctuation">)</span>  <span class="token comment"># 将line以“，”为分隔符</span>
        Longitude <span class="token operator">=</span> <span class="token builtin">float</span><span class="token punctuation">(</span>line<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token builtin">float</span><span class="token punctuation">(</span>line<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">60</span>
        <span class="token comment"># 读取第5个字符串信息，从0-2为经度，再加上后面的一串除60将分转化为度</span>
        Latitude <span class="token operator">=</span> <span class="token builtin">float</span><span class="token punctuation">(</span>line<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token builtin">float</span><span class="token punctuation">(</span>line<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">60</span>
        <span class="token comment"># 纬度同理</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"经度:"</span><span class="token punctuation">,</span>Longitude<span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"维度:"</span><span class="token punctuation">,</span>Latitude<span class="token punctuation">)</span>
</code></pre>
    <p>
     输出结果：
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/755069e179ce6e92e3c2c29fc012ca9e.png#pic_center"/>
    </p>
    <p>
     <strong>
      二、配置MQTT
     </strong>
     <br/>
     接下来配置MQTT，MQTT小伙伴们可以去
     <a href="https://baike.baidu.com/item/MQTT/3618851?fr=aladdin" rel="nofollow">
      百度百科
     </a>
     看一下，MQTT的话题、消息比较形象的例子是微信公众号。如果你关注了央视新闻，那么央视新闻发的消息都会给你推送；如果央视新闻也关注了你，那么你们就是互相关注，你发的消息也会给央视新闻推送。
     <br/>
     下面来看一下如何用python实现使用MQTT协议收发消息：
     <br/>
     需要用到的包为paho-mqtt
     <br/>
     在树莓派终端输入
    </p>
    <pre><code class="prism language-python">pip install paho<span class="token operator">-</span>mqtt
</code></pre>
    <p>
     来安装paho-mqtt
    </p>
    <p>
     在终端输入
    </p>
    <pre><code class="prism language-javascript">mkdir <span class="token constant">MQTT</span>
cd <span class="token constant">MQTT</span>
touch subscriber<span class="token punctuation">.</span>py
gedit subscriber<span class="token punctuation">.</span>py
</code></pre>
    <p>
     把下面的代码粘进去
    </p>
    <pre><code class="prism language-python"><span class="token comment"># subscriber.py</span>
<span class="token keyword">import</span> paho<span class="token punctuation">.</span>mqtt<span class="token punctuation">.</span>client <span class="token keyword">as</span> mqtt

<span class="token keyword">def</span> <span class="token function">on_connect</span><span class="token punctuation">(</span>client<span class="token punctuation">,</span> userdata<span class="token punctuation">,</span> flags<span class="token punctuation">,</span> rc<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>f<span class="token string">"Connected with result code {rc}"</span><span class="token punctuation">)</span>
    <span class="token comment"># 订阅，需要放在 on_connect 里</span>
    <span class="token comment"># 如果与 broker 失去连接后重连，仍然会继续订阅 raspberry/topic 主题</span>
    client<span class="token punctuation">.</span>subscribe<span class="token punctuation">(</span><span class="token string">"raspberry/topic"</span><span class="token punctuation">)</span>

<span class="token comment"># 回调函数，当收到消息时，触发该函数</span>
<span class="token keyword">def</span> <span class="token function">on_message</span><span class="token punctuation">(</span>client<span class="token punctuation">,</span> userdata<span class="token punctuation">,</span> msg<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>f<span class="token string">"{msg.topic} {msg.payload}"</span><span class="token punctuation">)</span>
    
client <span class="token operator">=</span> mqtt<span class="token punctuation">.</span>Client<span class="token punctuation">(</span><span class="token punctuation">)</span>
client<span class="token punctuation">.</span>on_connect <span class="token operator">=</span> on_connect
client<span class="token punctuation">.</span>on_message <span class="token operator">=</span> on_message

<span class="token comment"># 设置遗嘱消息，当树莓派断电，或者网络出现异常中断时，发送遗嘱消息给其他客户端</span>
client<span class="token punctuation">.</span>will_set<span class="token punctuation">(</span><span class="token string">'raspberry/status'</span><span class="token punctuation">,</span> <span class="token string">"OFF"</span><span class="token punctuation">)</span>

<span class="token comment"># 创建连接，三个参数分别为 broker 地址，broker 端口号，保活时间</span>
client<span class="token punctuation">.</span>connect<span class="token punctuation">(</span><span class="token string">"broker.emqx.io"</span><span class="token punctuation">,</span> <span class="token number">1883</span><span class="token punctuation">,</span> <span class="token number">60</span><span class="token punctuation">)</span>

<span class="token comment"># 设置网络循环堵塞，在调用 disconnect() 或程序崩溃前，不会主动结束程序</span>
client<span class="token punctuation">.</span>loop_forever<span class="token punctuation">(</span><span class="token punctuation">)</span>

</code></pre>
    <p>
     运行结果：
     <br/>
     <img alt="图片图片图片图片图片图片图片图片图片" src="https://i-blog.csdnimg.cn/blog_migrate/ddb8850f9c309d4bc9d39f2700483bfc.png#pic_center">
      <br/>
      code 0表示连接成功，其他数字不对。
     </img>
    </p>
    <p>
     到
     <a href="https://mqttx.app/cn/" rel="nofollow">
      MQTTX官网
     </a>
     下载MQTTX客户端给话题
     <code>
      raspberry/topic
     </code>
     发消息，测试能不能收到。
    </p>
    <p>
     下载安装好之后按照下图输入：
     <br/>
     Client ID是随机的。
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/f2b37cbe46dc928fa82d46288fa38b22.png#pic_center"/>
    </p>
    <p>
     然后点击右上角Connect：
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/464865cdeb513925c300d5bd6dad3a93.png#pic_center">
      <br/>
      <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/b7e960718177be9b293158b6624256df.png#pic_center">
       <br/>
       这时，回到树莓派终端运行
      </img>
     </img>
    </p>
    <pre><code class="prism language-python">python3 subscriber<span class="token punctuation">.</span>py
</code></pre>
    <p>
     然后用客户端发送消息，观察终端是否显示刚刚发布的消息。成功的话应该是这样的：
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/8e4b13788fe1fdf9786457caab132b06.png#pic_center"/>
    </p>
    <p>
     下面来试试用树莓派发送消息：
     <br/>
     在终端输入
    </p>
    <pre><code class="prism language-javascript">cd <span class="token constant">MQTT</span>
touch publisher<span class="token punctuation">.</span>py
gedit publisher<span class="token punctuation">.</span>py
</code></pre>
    <p>
     把下面的代码粘进去
    </p>
    <pre><code class="prism language-python"><span class="token keyword">import</span> paho<span class="token punctuation">.</span>mqtt<span class="token punctuation">.</span>client <span class="token keyword">as</span> mqtt
<span class="token keyword">import</span> time

<span class="token keyword">def</span> <span class="token function">on_connect</span><span class="token punctuation">(</span>client<span class="token punctuation">,</span> userdata<span class="token punctuation">,</span> flags<span class="token punctuation">,</span> rc<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>f<span class="token string">"Connected with result code {rc}"</span><span class="token punctuation">)</span>
    
client <span class="token operator">=</span> mqtt<span class="token punctuation">.</span>Client<span class="token punctuation">(</span><span class="token punctuation">)</span>
client<span class="token punctuation">.</span>on_connect <span class="token operator">=</span> on_connect
client<span class="token punctuation">.</span>connect<span class="token punctuation">(</span><span class="token string">"broker.emqx.io"</span><span class="token punctuation">,</span> <span class="token number">1883</span><span class="token punctuation">,</span> <span class="token number">60</span><span class="token punctuation">)</span>

<span class="token comment"># 每间隔 2 秒钟向 raspberry/topic 发送一个消息，连续发送 10 次</span>
<span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 四个参数分别为：主题，发送内容，QoS, 是否保留消息</span>
    client<span class="token punctuation">.</span>publish<span class="token punctuation">(</span><span class="token string">'raspberry/topic'</span><span class="token punctuation">,</span> payload<span class="token operator">=</span>i<span class="token punctuation">,</span> qos<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> retain<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>f<span class="token string">"send {i} to raspberry/topic"</span><span class="token punctuation">)</span>
    time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>

client<span class="token punctuation">.</span>loop_forever<span class="token punctuation">(</span><span class="token punctuation">)</span>

</code></pre>
    <p>
     运行
    </p>
    <pre><code class="prism language-python">python3 publisher<span class="token punctuation">.</span>py
</code></pre>
    <p>
     再打开一个终端进入MQTT文件夹
    </p>
    <pre><code class="prism language-python">python3 publisher<span class="token punctuation">.</span>py
</code></pre>
    <p>
     结果：
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/4b2db79432dc97e3aa139764989aaecc.png#pic_center"/>
     <br/>
     想用客户端查看的话
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/be92954d370ef11ba6b5d5972097c2ff.png#pic_center"/>
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/1c7bcfb3183c5ce68873d2c11a330f97.png#pic_center"/>
     <br/>
     点击 Confirm之后就能看到
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/7c5cdd5c3f6c2fb89db5c5be657ff1f7.png#pic_center"/>
    </p>
    <p>
     <strong>
      三、用MQTT协议发送GPS到服务器
     </strong>
     <br/>
     现在一般用
     <a href="https://baike.baidu.com/item/JSON/2462549?fr=aladdin" rel="nofollow">
      json
     </a>
     格式来传送数据，下面代码就是将GPS坐标进行简单的封装之后发送到服务器。
    </p>
    <pre><code class="prism language-python"><span class="token keyword">import</span> paho<span class="token punctuation">.</span>mqtt<span class="token punctuation">.</span>client <span class="token keyword">as</span> mqtt
<span class="token keyword">import</span> RPi<span class="token punctuation">.</span>GPIO <span class="token keyword">as</span> GPIO
<span class="token keyword">import</span> serial  <span class="token comment"># 导入serial模块</span>
<span class="token keyword">import</span> json
<span class="token keyword">import</span> time

GPIO<span class="token punctuation">.</span>setwarnings<span class="token punctuation">(</span><span class="token boolean">False</span><span class="token punctuation">)</span>
GPIO<span class="token punctuation">.</span>setmode<span class="token punctuation">(</span>GPIO<span class="token punctuation">.</span>BCM<span class="token punctuation">)</span>
start_time <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>
flag <span class="token operator">=</span> <span class="token number">17</span>
<span class="token comment">#jing = 105.753739</span>
<span class="token comment">#wei = 37.474912</span>
GPIO<span class="token punctuation">.</span>setup<span class="token punctuation">(</span>flag<span class="token punctuation">,</span> GPIO<span class="token punctuation">.</span>IN<span class="token punctuation">)</span>
<span class="token comment"># GPIO.add_event_detect(flag, GPIO.RISING)</span>

ser <span class="token operator">=</span> serial<span class="token punctuation">.</span>Serial<span class="token punctuation">(</span><span class="token string">"/dev/ttyUSB0"</span><span class="token punctuation">,</span> <span class="token number">9600</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">on_connect</span><span class="token punctuation">(</span>client<span class="token punctuation">,</span> userdata<span class="token punctuation">,</span> flags<span class="token punctuation">,</span> rc<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>f<span class="token string">"Connected with result code {rc}"</span><span class="token punctuation">)</span>
    <span class="token comment"># 订阅，需要放在 on_connect 里</span>
    <span class="token comment"># 如果与 broker 失去连接后重连，仍然会继续订阅 raspberry/topic 主题</span>
    client<span class="token punctuation">.</span>subscribe<span class="token punctuation">(</span><span class="token string">"raspberry/topic"</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">on_message</span><span class="token punctuation">(</span>client<span class="token punctuation">,</span> userdata<span class="token punctuation">,</span> msg<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># print(f"{msg.topic} {msg.payload}")</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"主题:"</span> <span class="token operator">+</span> msg<span class="token punctuation">.</span>topic <span class="token operator">+</span> <span class="token string">" 消息:"</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>payload<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>f<span class="token string">"receive message from raspberry/topic"</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">on_subscribe</span><span class="token punctuation">(</span>client<span class="token punctuation">,</span> userdata<span class="token punctuation">,</span> mid<span class="token punctuation">,</span> granted_qos<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"On Subscribed: qos = %d"</span> <span class="token operator">%</span> granted_qos<span class="token punctuation">)</span>


start_time <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>
client <span class="token operator">=</span> mqtt<span class="token punctuation">.</span>Client<span class="token punctuation">(</span><span class="token punctuation">)</span>
client<span class="token punctuation">.</span>on_connect <span class="token operator">=</span> on_connect
client<span class="token punctuation">.</span>connect<span class="token punctuation">(</span><span class="token string">"broker.emqx.io"</span><span class="token punctuation">,</span> <span class="token number">1883</span><span class="token punctuation">,</span> <span class="token number">60</span><span class="token punctuation">)</span>
<span class="token comment">#client.connect("broker.emqx.io", 1883, 60)</span>
client<span class="token punctuation">.</span>on_message <span class="token operator">=</span> on_message
client<span class="token punctuation">.</span>will_set<span class="token punctuation">(</span><span class="token string">'raspberry/status'</span><span class="token punctuation">,</span> <span class="token string">"OFF"</span><span class="token punctuation">)</span>

<span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>

    client<span class="token punctuation">.</span>on_message <span class="token operator">=</span> on_message
    client<span class="token punctuation">.</span>loop_start<span class="token punctuation">(</span><span class="token punctuation">)</span>
    line <span class="token operator">=</span> <span class="token builtin">str</span><span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>ser<span class="token punctuation">.</span>readline<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span>  <span class="token comment"># readline()是用于读取整行</span>
    <span class="token comment"># print(line)</span>
    <span class="token comment"># 这里如果从头取的话，就会出现b‘，所以要从第三个字符进行读取</span>

    <span class="token keyword">if</span> line<span class="token punctuation">.</span>startswith<span class="token punctuation">(</span><span class="token string">'$GPGGA'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># 我这里用的GPGGA，有的是GNGGA</span>
        <span class="token comment"># print('接收的数据：' + str(line))</span>
        line <span class="token operator">=</span> <span class="token builtin">str</span><span class="token punctuation">(</span>line<span class="token punctuation">)</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">','</span><span class="token punctuation">)</span>  <span class="token comment"># 将line以“，”为分隔符</span>
        jing <span class="token operator">=</span> <span class="token builtin">float</span><span class="token punctuation">(</span>line<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token builtin">float</span><span class="token punctuation">(</span>line<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">60</span>
        <span class="token comment"># 读取第5个字符串信息，从0-2为经度，即经度为116，再加上后面的一串除60将分转化为度</span>
        wei <span class="token operator">=</span> <span class="token builtin">float</span><span class="token punctuation">(</span>line<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token builtin">float</span><span class="token punctuation">(</span>line<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">60</span>
        <span class="token comment"># 纬度同理</span>
        <span class="token comment"># print(jing)</span>
        data1 <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>  <span class="token comment"># 1表示轨迹</span>
            <span class="token string">"data"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
                <span class="token string">"latitude"</span><span class="token punctuation">:</span> <span class="token punctuation">(</span>wei<span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token comment"># 纬度</span>
                <span class="token string">"longitude"</span><span class="token punctuation">:</span> <span class="token punctuation">(</span>jing<span class="token punctuation">)</span>
                <span class="token comment"># 经度</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        param1 <span class="token operator">=</span> json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>data1<span class="token punctuation">)</span>
        client<span class="token punctuation">.</span>publish<span class="token punctuation">(</span><span class="token string">"raspberry/topic"</span><span class="token punctuation">,</span> payload<span class="token operator">=</span>param1<span class="token punctuation">,</span> qos<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>f<span class="token string">"send message to raspberry/topic"</span><span class="token punctuation">)</span>
        time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>

    <span class="token keyword">if</span> GPIO<span class="token punctuation">.</span><span class="token builtin">input</span><span class="token punctuation">(</span>flag<span class="token punctuation">)</span> <span class="token operator">==</span> GPIO<span class="token punctuation">.</span>LOW<span class="token punctuation">:</span>
        data2 <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>

            <span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span>  <span class="token comment"># 2表示作业情况</span>
            <span class="token string">"data"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
                <span class="token string">"worktime"</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> start_time<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">3600</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># 表示作业3小时</span>
                <span class="token string">"working_area"</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> start_time<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">1.12</span> <span class="token operator">*</span> <span class="token number">6</span> <span class="token operator">*</span> <span class="token number">0.0015</span><span class="token punctuation">)</span>
                <span class="token comment"># 表示作业面积亩</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        param2 <span class="token operator">=</span> json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>data2<span class="token punctuation">)</span>
        <span class="token comment"># print("主题:"+msg.topic+" 消息:"+str(msg.payload.decode('utf-8')))</span>

        <span class="token keyword">print</span><span class="token punctuation">(</span>f<span class="token string">"data2"</span><span class="token punctuation">)</span>
        client<span class="token punctuation">.</span>publish<span class="token punctuation">(</span><span class="token string">"raspberry/topic"</span><span class="token punctuation">,</span> payload<span class="token operator">=</span>param2<span class="token punctuation">,</span> qos<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span>f<span class="token string">"OFF"</span><span class="token punctuation">)</span>
            time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>
            
GPIO<span class="token punctuation">.</span>cleanup<span class="token punctuation">(</span><span class="token punctuation">)</span>
client<span class="token punctuation">.</span>loop_forever<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
    <p>
     运行结果：
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/f7c5a459d01b45343fe16653d5d29b8e.png#pic_center"/>
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/9a5e45c51ce43afc2f8753283a437229.png#pic_center"/>
     <br/>
     客户端接收到消息。
     <br/>
     本次心得就分享到这，有什么不对的地方欢迎各位同学指正。
    </p>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f62:6c6f672e6373646e2e6e65742f71715f33383132393333312f:61727469636c652f64657461696c732f313038363739383839" class_="artid" style="display:none">
 </p>
</div>


