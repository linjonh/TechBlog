---
layout: post
title: 2021-06-08-STM32之CAN通信
date: 2021-06-08 16:16:49 +0800
categories: ['单片机']
tags: ['嵌入式', '物联网', 'Stm', '单片机']
image:
  path: https://img-blog.csdnimg.cn/20210608152032899.png?x-oss-process&#61;image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3RoaXN3YXlfZGl5,size_16,color_FFFFFF,t_70
  alt: STM32之CAN通信
artid: 117702782
render_with_liquid: false
---
<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     STM32之CAN通信
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-light" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <p>
     官网： https://www.100ask.net/
     <br/>
     视频中心：https://video.100ask.net/
     <br/>
     交流社区： https://forums.100ask.net/
     <br/>
     下载中心：http://download.100ask.net/
     <br/>
     嘉楠AI芯片开发学习站点: https://canaan-docs.100ask.net/
     <br/>
     瑞萨芯片开发学习站点: https://renesas-docs.100ask.net/
     <br/>
     单片机rtos开发学习站点: https://rtos.100ask.net/
     <br/>
     全志TinaSDK开发学习站点: https://tina.100ask.net/
     <br/>
     全志开发板学习站点: https://allwinner-docs.100ask.net/
     <br/>
     东山PI系列学习站点: https://dongshanpi.com/
     <br/>
     全志R128开发学习站点: https://aw-r128.100ask.net/
     <br/>
     东山Pi新板文档站点: https://dongshanpi.100ask.net/
     <br/>
     Bilibili https://space.bilibili.com/275908810
     <br/>
     Coding: https://weidongshan.coding.net/public/
     <br/>
     GitHub: https://github.com/100askTeam
     <br/>
     Gitee: https://gitee.com/weidongshan
     <br/>
     wiki维基百科: wiki.100ask.net
     <br/>
     代码中心： https://code.100ask.net/
     <br/>
     学习路线指引： https://www.100ask.net/video
    </p>
    <h3>
     <a id="231_CAN_20">
     </a>
     23.1关于 CAN
    </h3>
    <h4>
     <a id="2311_CAN__21">
     </a>
     23.1.1 CAN 电气特性与协议
    </h4>
    <p>
     控制器局域网（Controller Area Network，CAN），是由德国BOSCH（博世）公司开发，是目前国际上应用最为广泛的现场总线之一。其特点是可拓展性好，可承受大量数据的高速通信，高度稳定可靠，因此常应用于汽车电子领域、工业自动化、医疗设备等高要求环境。
    </p>
    <p>
     CAN总线有两个ISO国际标准：ISO11519 和ISO11898。
    </p>
    <ul>
     <li>
      ISO11519定义了通信速率为10～125Kbps的低速CAN通信标准，属于开环总线，传输速率为40Kbps时，总线长度可达1000米；
     </li>
     <li>
      ISO11898定义了通信速率为125Kbps～1 Mbps的高速CAN通信标准，属于闭环总线，传输速率可达1Mbps，总线长度≤40米；
     </li>
    </ul>
    <p>
     高速CAN主要应用在发动机、变速箱等对实时性、传输速度要求高的场景。低速CAN主要应用在车身控制系统等可靠性要求高的场景，低速CAN在断掉其任一导线后，仍可以继续接收数据，因此在汽车发生交通事故时，使用低速CAN能更大提高设备正常接收数据工作的可能性，提高安全性。
    </p>
    <p>
     如图 23.1.1 所示，是低速CAN的拓扑结构图，如图 23.1.2 是高速CAN的拓扑结构图。低速CAN总线为开环，高速CAN总线为闭环，总线由CAN_H和CAN_L两根线组成，总线上可以挂多个节点设备。每个节点设备由CAN控制器和CAN收发器组成，CAN控制器通常作为外设集成在MPU/MCU上，而CAN收发器则需要外围添加芯片电路。
    </p>
    <p>
     从两个网络拓扑结构可以看出，基于ISO11519标准的低速CAN，是一个“开环网络”，每根总线上个串联一个2.2KΩ的电阻；基于ISO11898标准的高速CAN，是一个“闭环网络”，总线的两端各需串联一个120Ω的电阻用于阻抗匹配，以减少回波反射。
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/fa8014a09831f6fb8ebd6c6171d9d2b8.png">
      <br/>
      <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/4d00f8eedc197e0ff54e4dee4ba59ae8.png">
       <br/>
       类似RS485，CAN也使用差分信号传输数据。CAN总线使用CAN_H和CAN_L的电位差来表示数据电平。电位差分为显性电平和隐性电平，分别表示逻辑0和1。如图 23.1.3 所示，是低速CAN（ISO11519标准）的电平定义，如图 23.1.4 是高速CAN（ISO11898标准）的电平定义，两者物理层电气特性不一样，因此不能将它们连接在一起。可以看到当CAN_H和CAN_L电压相近，则表示隐性电平，对应逻辑1，当两个电压相差较大，表示显性电平，对应逻辑0。
       <br/>
       <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/d2e7280c517b48472a7475e3340ad51e.png">
        <br/>
        <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/f94d0ecb004425a8cab4e4e85e4f9f07.png">
         <br/>
         <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/52d856d540690d87067e04a27dd17dbf.png">
          <br/>
          CAN是一种基于消息广播模式的串行通信总线，即在同一时刻网络上所有节点监测到的数据是一致的，各节点根据报文ID来甄别是否是发给自己的报文。
         </img>
        </img>
       </img>
      </img>
     </img>
    </p>
    <p>
     CAN总线以“帧”（Frame）的形式进行通信。CAN 总线协议规定了5种帧，分别是数据帧、远程帧、错误帧、超载帧以及帧间隔，其中数据帧最常用，表 23.1.2 是各个帧的用途。
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/25cad0e87669dae91c10737b85c361f6.png">
      <br/>
      数据帧由七段组成，如图 23.1.5 所示。数据帧又分为标准帧（CAN2.0A）和扩展帧（CAN2.0B），主要体现在在仲裁段和控制段上。
      <br/>
      <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/732dfc38beb5daa2b01304850714e4a3.png"/>
     </img>
    </p>
    <ul>
     <li>
      帧起始(Start Of Frame-SOF)：1bit，显性信号，表示数据帧（或远程帧）的开始；
     </li>
     <li>
      仲裁段(Arbitration Field)：包括标识符位（Identifier field-ID）和远程发送请求位（Remote Transfer Request，RTR）；
     </li>
     <li>
      标准帧的ID位是11位，即范围是0x000~0x7FF，而扩展帧的ID是11+18=29位；在CAN协议中，ID决定报文的优先级高低，也决定这拓扑结构的节点是否接收此ID的帧数据；
     </li>
     <li>
      远程发送请求位，用于区分该帧是数据帧还是远程帧，显性信号（0）代表数据帧（Data Frame），隐性信号（1）代表远程帧（Remote Frame）；
     </li>
     <li>
      控制段（Control Field）：标准帧中由扩展标识符位（Identifier Extension bit-IDE，1 bit）、保留位0（Reseved bit0-r0，1 bit）、数据长度编码位（Data Length Code-DLC，4 bits）组成；扩展帧用由两个保留位（Reseved bit，2 bit）、数据长度编码位（Data Length Code-DLC，4 bits）组成;
     </li>
     <li>
      数据段（Data Field）：发送数据的内容，最多8个字节（64bit），它的实际长度会写到前面的数据长度编码位DLC里。
     </li>
     <li>
      循环校验段（CRC Field）：包括循环校验序列（CRC Sequence）和界定符（Delimiter，DEL）；循环校验序列用于校验传输是否正确；界定符用于表示循环校验序列是否结束；
     </li>
     <li>
      确认段（ACK Field）：包括确认位（ACK SLOT）和界定符（Delimiter，DEL）；确认位在节点收到正确的CRC序列时，发送端的ACK位被置位；界定符表示确认是否正常接收；
     </li>
     <li>
      帧结束（End of Frame-EOF）：7位长度，隐性信号，表示帧的结束；
     </li>
    </ul>
    <p>
     当CAN总线网络中有多个CAN节点设备时，某一CAN设备发出数据帧，总线上所有设备(无过滤时)都获取该数据帧中仲裁段中的ID，如果是自己关注ID的数据，则获取数据段的内容，完成数据的传输。
    </p>
    <h4>
     <a id="2312_CAN__57">
     </a>
     23.1.2 CAN 控制器
    </h4>
    <p>
     STM32F103系列的CAN控制器（Basic Extended CAN，bxCAN），支持CAN 2.0A和CAN 2.0B Active版本协议。CAN 2.0A只能处理标准数据帧，扩展帧的内容会识别为错误；CAN 2.0B Active可以处理标准数据帧和扩展数据帧；CAN 2.0B Passive只能处理标准数据帧，扩展帧的内容会忽略。
    </p>
    <p>
     STM32F103系列只有一个CAN控制器，STM32F105/STM32F107互联型有两个CAN控制器，互联型内部CAN控制器结构如图 23.1.6 所示，⑤是CAN2，STM32F103系列没有，先忽略。
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/f7bc1ea95fbdb4863347d4df789a1e82.png">
      <br/>
      ①CAN1内核：包含各种控制、状态、配置寄存器。其中比较重要的是主控制寄存器（CAN_MCR）和位时序寄存器（CAN_BTR）。主控制寄存器主要控制CAN的工作模式，在后面设置CAN协议初始化时，实现对该寄存器的修改。位时序寄存器主要涉及CAN的工作速率，由于CAN是异步信号，同串口类似，需要收发双方提前统一通信速率。除此之外，为保证通信稳定，CAN采用“位同步”机制，实现对电平的正确采样。传输中的每位数据由四段组成：同步段（Synchronization Segment，SS）、传播时间段（Propagation TimeSegment，PTS）、相位缓冲段1（Phase Buffer Segment 1，PBS1）和相位缓冲段2（Phase Buffer Segment 2， PBS2）。每段又由多个位时序（Time Quantum，Tq）组成，如图 23.1.6 所示，为各段组成示意图。
      <br/>
      <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/657de866e3ebc15af6b21424ba3afef3.png"/>
      <br/>
      假设CAN对应逻辑电平持续的时间为9Tq，即一位数据持续的时间为9Tq。其中SS段长度为1Tq（只能为1Tq），PTS段长度为2Tq（范围为1
      <sub>
       8Tq），PSB1段长度为3Tq（范围为1
      </sub>
      8Tq），PSB2段长度为3Tq（范围为2~8Tq）。采样点在PSB1和PSB2之间，调整各段的长度，即可对采样点位置进行调整，实现补偿准确采样。
     </img>
    </p>
    <p>
     如图 23.1.8 所示，为STM32F103系列的CAN控制器位时序，和标准CAN协议的位时序略有不同。STM32只有三段，同步段长度为1Tq（只能为1Tq），标准CAN协议中的PTS段和PSB1合并为位段1（范围为1-16Tq），标准CAN协议中的PSB2段对应位段2（范围为1-8Tq）。
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/6b4f7f25b8e03eff914df39c4f94e61e.png"/>
     <br/>
     当知道CAN控制器的工作时钟频率、tBS1和tBS2的长度时，即可计算出CAN传输的波特率，关系如下：
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/4875dd81682608c28e9448ada868375a.png"/>
    </p>
    <ul>
     <li>
      Tq=(BRP[9:0]+1) x tPCLK，BRP[9:0]为Tq长度，tPCLK为APB时钟周期；
     </li>
     <li>
      tBS1=Tq x (TS1[3:0] + 1)，TS1[3:0]位于CAN_BTR寄存器中；
     </li>
     <li>
      tBS2=Tq x (TS2[2:0] + 1)，TS2[2:0]位于CAN_BTR寄存器中；由图 6.1.2 可知，bxCAN挂在APB1总线上，当系统时钟为最高72MHz时，APB1时钟最高为36MHz。此时若BRP[9:0]+1为8，TS1[3:0] + 1为6，TS2[2:0] + 1为2，则波特率为:
      <br/>
      <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/52fa129e043d929cf43b74e4584f7a45.png"/>
     </li>
    </ul>
    <p>
     ② 发送邮箱：STM32F103的CAN控制器有三个发送邮箱，可最多缓存三个待发送的报文。由传输调度负责决定邮箱报文的发送顺序。
    </p>
    <p>
     ③接收FIFO：STM32F103的CAN控制器有两个个接收FIFO来存储传入的数据，每个FIFO由三个邮箱存储三个接收到报文。
    </p>
    <p>
     ④：验收筛选器：STM32F105/STM32F107互联型有28个筛选器，STM32F103系列只有14个筛选器（编号0~13）。前面介绍CAN协议介绍到，在CAN总线网络中，总线上的所有设备都获取总线数据帧中ID，如果是自己关注的ID，则继续获取数据段的内容。当总线上报文过多时，每个CAN设备将频繁获取报文，消耗比较大。因此，提供筛选器实现选择性的获取报文，降低系统负担。
    </p>
    <p>
     每个筛选器组由两个32位寄存器CAN_FxR1和CAN_FxR2组成。根据不同的实际需求，筛选器支持设置筛选范围和筛选模式。
    </p>
    <p>
     筛选范围可设置为32位和16位，两种方式筛选的范围有所差异：
    </p>
    <ul>
     <li>
      32位方式：筛选报文的STDID[10:0]、EXTID[17:0]、IDE、RTR；
     </li>
     <li>
      16位方式：筛选报文的STDID[10:0]、EXTID[17:15]、IDE、RTR；筛选模式可设置为列表模式和掩码模式，前者常用于筛选单个标识符，后者常用于筛选单组标识符：
     </li>
     <li>
      列表模式：此时两个寄存器都作为标识符寄存器，这两个标识符寄存器组成一个表，只有在此列表中的ID，才能通过筛选器，存入FIFO；
     </li>
     <li>
      掩码模式：此时两个寄存器作为标识符寄存器和掩码寄存器，根据掩码寄存器指定的哪些位与标识符寄存器匹配的ID，才能通过筛选器，存入FIFO；
     </li>
    </ul>
    <p>
     举个例子，如表 23.1.3 所示，ID为0xF，掩码为0x7FC。掩码位为1表示必须与ID一致，掩码位为0表示可不与ID一致，因此结果bit[1:0]为任意值，其它都需要与ID一致，则最后结果为11XX，即0xC~0xF之间的ID都可经过筛选器存入FIFO，其它则无法通过；
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/b0f5293d555e9c18615e60a2a8150c93.png"/>
     <br/>
     如图 23.1.9 所示，通过设置筛选范围和筛选模式进行组合，每个筛选器有四种情况。
    </p>
    <p>
     ①FSCx=1，FBMx=0：处于32位掩码模式，此时两个32位寄存器CAN_FxR1和CAN_FxR2，一个存放ID，一个存放掩码；
    </p>
    <p>
     ②FSCx=1，FBMx=1：处于32位列表模式，此时两个32位寄存器CAN_FxR1和CAN_FxR2，两个都存放ID，组成列表；
    </p>
    <p>
     ③FSCx=0，FBMx=0：处于16位掩码模式，此时两个32位寄存器CAN_FxR1和CAN_FxR2，它们各自低16位存放ID，高16位存放掩码；
    </p>
    <p>
     ②FSCx=0，FBMx=1：处于16位列表模式，此时两个32位寄存器CAN_FxR1和CAN_FxR2，它们各自低16位和高16位都存放ID，组成列表；
    </p>
    <p>
     举个例子，假设CAN总线上有ID为0至99的100个报文，现在只需要ID为0-5的报文，筛选器该如何设置？首先设置筛选器组0处于32位掩码模式，ID为0x0，掩码为0x7FC，结果将筛选出0x0-0x3。接着设置筛选器组1处于32位列表模式，列表两个ID分别设为0x04和0x05。最后ID为0x0~0x05的报文将通过筛
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/0b95be8501f95a0db58f6d009da0b51e.png"/>
     <br/>
     关于CAN的基础介绍就到这里，读者重点理解CAN电气特性、数据帧结构、STM32的CAN控制器波特率和筛选器。
    </p>
    <h3>
     <a id="232__106">
     </a>
     23.2 硬件设计
    </h3>
    <p>
     如图 23.2.1 为开发板CAN部分的原理图。U17为CAN收发器TJA1042芯片，该芯片将MCU的CAN控制器的逻辑电平转换成差分信号，发送到CAN总线中。
    </p>
    <p>
     U17的1脚接MCU的CAN发送引脚（PB9），2脚接MCU的CAN接收引脚（PB8）, 7脚、8脚为CAN输出引脚，上面挂了一个120欧的终端电阻，工作在高速CAN模式。
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/a9b9ed6f95217cdad7f4cee8eaf9958c.png"/>
     <br/>
     另外，CAN和RS485都是半双工的差分信号，需要两个设备连接测试。百问网制作了一个CAN/RS485互转模块，可以直接连接到100ASK系列开发板上，实现RS485的CAN的透传，同时验证、学习两个接口，该模块外形如图 23.2.2 所示。
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/a1a4f96bbde7080bca4292dc658bfed3.png"/>
     <br/>
     该模块左边是RS485接口（波特率9600bps，无校验，8位数据位，1位停止位），右边是CAN接口（波特率500Kbps，屏蔽位模式，允许所有帧接收），中间是转换芯片，实现协议转换。由于CAN协议中包含有ID， 而RS485不存在ID。因此，当RS485转CAN时，模块会自动加上0x00的ID，当CAN转RS485时，RS485只会收到数据部分，扔掉ID部分。
    </p>
    <h3>
     <a id="233__115">
     </a>
     23.3 软件设计
    </h3>
    <h4>
     <a id="2331__116">
     </a>
     23.3.1 软件设计思路
    </h4>
    <p>
     实验目的：本实验通过RS485_CAN互转模块，实现RS485和CAN互传数据，让读者熟悉如何使用CAN。开发板的RS485首先发送数据，经过RS485_CAN互转模块变为CAN信号，传入开发板CAN接口；开发板CAN接口接到数据后，CAN再发送数据，经过RS485_CAN互转模块变为RS485信号，传入开发板R485接口。
    </p>
    <ol>
     <li>
      初始化CAN协议相关参数和筛选器：设置预分频、位段长度等实现需要的500Kbps波特率；
     </li>
     <li>
      初始化CAN硬件相关参数：CAN时钟使能、GPIO端口时钟使能、引脚重映射、中断优先级等；
     </li>
     <li>
      使用HAL提供的CAN收发函数，收发数据；
     </li>
     <li>
      主函数编写控制逻辑：按下按键KEY1（KEY_U），RS485发送数据，经过RS485_CAN互转模块传入CAN接口并打印，随后CAN接口发送数据，经过RS485_CAN互转模块传入RS485接口并打印；本实验配套代码位于“5_程序源码\15_通信—CAN\”。
     </li>
    </ol>
    <h4>
     <a id="2332__123">
     </a>
     23.3.2 软件设计讲解
    </h4>
    <ol>
     <li>
      初始化CAN
      <br/>
      CAN的初始化，包含两部分：协议部分和硬件部分。
      <br/>
      协议部分初始化如代码段 23.3.1 所示。
     </li>
    </ol>
    <p>
     代码段 23.3.1 CAN 协议初始化（driver_can.c）
    </p>
    <pre><code class="prism language-c"><span class="token comment">/*
* 函数名：void CAN_Init(void)
* 输入参数：无
* 输出参数：无
* 返回值：无
* 函数作用：初始化 CAN1
*/</span>
<span class="token keyword">void</span> <span class="token function">CAN_Init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
CAN_FilterTypeDef sFilterConfig<span class="token punctuation">;</span>
hcan<span class="token punctuation">.</span>Instance <span class="token operator">=</span> CAN1<span class="token punctuation">;</span>
<span class="token comment">/* 配置 CAN 的基本参数 */</span>
hcan<span class="token punctuation">.</span>Init<span class="token punctuation">.</span>Prescaler <span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">;</span> <span class="token comment">// 预分频,范围(1~1024)</span>
hcan<span class="token punctuation">.</span>Init<span class="token punctuation">.</span>Mode <span class="token operator">=</span> CAN_MODE_NORMAL<span class="token punctuation">;</span> <span class="token comment">// 正常工作模式</span>
hcan<span class="token punctuation">.</span>Init<span class="token punctuation">.</span>SyncJumpWidth <span class="token operator">=</span> CAN_SJW_1TQ<span class="token punctuation">;</span> <span class="token comment">// 再次同步跳跃宽度为 1Tq</span>
hcan<span class="token punctuation">.</span>Init<span class="token punctuation">.</span>TimeSeg1 <span class="token operator">=</span> CAN_BS1_6TQ<span class="token punctuation">;</span> <span class="token comment">// 位段 1(BS1)的长度为 6Tq</span>
hcan<span class="token punctuation">.</span>Init<span class="token punctuation">.</span>TimeSeg2 <span class="token operator">=</span> CAN_BS2_2TQ<span class="token punctuation">;</span> <span class="token comment">// 位段 2(BS2)的长度为 2Tq</span>
hcan<span class="token punctuation">.</span>Init<span class="token punctuation">.</span>TimeTriggeredMode <span class="token operator">=</span> DISABLE<span class="token punctuation">;</span> <span class="token comment">// 禁止时间触发通信模式</span>
hcan<span class="token punctuation">.</span>Init<span class="token punctuation">.</span>AutoBusOff <span class="token operator">=</span> DISABLE<span class="token punctuation">;</span> <span class="token comment">// 禁止总线自动关闭</span>
hcan<span class="token punctuation">.</span>Init<span class="token punctuation">.</span>AutoWakeUp <span class="token operator">=</span> DISABLE<span class="token punctuation">;</span> <span class="token comment">// 禁止自动唤醒</span>
hcan<span class="token punctuation">.</span>Init<span class="token punctuation">.</span>AutoRetransmission <span class="token operator">=</span> ENABLE<span class="token punctuation">;</span> <span class="token comment">// 使能自动重传</span>
hcan<span class="token punctuation">.</span>Init<span class="token punctuation">.</span>ReceiveFifoLocked <span class="token operator">=</span> DISABLE<span class="token punctuation">;</span> <span class="token comment">// 禁止接收 FIFO 锁定</span>
hcan<span class="token punctuation">.</span>Init<span class="token punctuation">.</span>TransmitFifoPriority <span class="token operator">=</span> DISABLE<span class="token punctuation">;</span> <span class="token comment">// 禁止传输 FIFO 优先级</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">HAL_CAN_Init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>hcan<span class="token punctuation">)</span> <span class="token operator">!=</span> HAL_OK<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
<span class="token function">Error_Handler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token comment">/* 配置 CAN 的筛选器，此处全部接收，不做过滤 */</span>
sFilterConfig<span class="token punctuation">.</span>FilterBank <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// 选择筛选器组 0</span>
sFilterConfig<span class="token punctuation">.</span>FilterMode <span class="token operator">=</span> CAN_FILTERMODE_IDMASK<span class="token punctuation">;</span> <span class="token comment">// 设置为掩码模式</span>
sFilterConfig<span class="token punctuation">.</span>FilterScale <span class="token operator">=</span> CAN_FILTERSCALE_32BIT<span class="token punctuation">;</span> <span class="token comment">// 32 位长度</span>
sFilterConfig<span class="token punctuation">.</span>FilterIdHigh <span class="token operator">=</span> <span class="token number">0x0000</span><span class="token punctuation">;</span> <span class="token comment">// ID 高字节</span>
sFilterConfig<span class="token punctuation">.</span>FilterIdLow <span class="token operator">=</span> <span class="token number">0x0000</span><span class="token punctuation">;</span> <span class="token comment">// ID 低字节</span>
sFilterConfig<span class="token punctuation">.</span>FilterMaskIdHigh <span class="token operator">=</span> <span class="token number">0x0000</span><span class="token punctuation">;</span> <span class="token comment">// 掩码高字节</span>
sFilterConfig<span class="token punctuation">.</span>FilterMaskIdLow <span class="token operator">=</span> <span class="token number">0x0000</span><span class="token punctuation">;</span> <span class="token comment">// 掩码低字节</span>
sFilterConfig<span class="token punctuation">.</span>FilterFIFOAssignment <span class="token operator">=</span> CAN_RX_FIFO0<span class="token punctuation">;</span> <span class="token comment">// 过滤器关联 FIFO</span>
sFilterConfig<span class="token punctuation">.</span>FilterActivation <span class="token operator">=</span> ENABLE<span class="token punctuation">;</span> <span class="token comment">// 使能筛选器</span>
<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">HAL_CAN_ConfigFilter</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>hcan<span class="token punctuation">,</span> <span class="token operator">&amp;</span>sFilterConfig<span class="token punctuation">)</span> <span class="token operator">!=</span> HAL_OK<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
<span class="token function">Error_Handler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token comment">// 启用 CAN</span>
<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">HAL_CAN_Start</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>hcan<span class="token punctuation">)</span> <span class="token operator">!=</span> HAL_OK<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
<span class="token function">Error_Handler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token comment">// 使能 CAN 接收 FIFO0 中断</span>
<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">HAL_CAN_ActivateNotification</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>hcan<span class="token punctuation">,</span> CAN_IT_RX_FIFO0_MSG_PENDING<span class="token punctuation">)</span> <span class="token operator">!=</span> HAL_OK<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
<span class="token function">Error_Handler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span>
</code></pre>
    <p>
     <strong>
      12~25行：设置CAN协议参数；
     </strong>
    </p>
    <ul>
     <li>
      12行：设置哪一个CAN控制器，STM32F103ZET6只有一个CAN控制器；
     </li>
     <li>
      15行：设置时钟的预分频，与后面的位段时间长度组合，实现需要的500Kbps，这里先设置为8分频；
     </li>
     <li>
      16行：设置CAN工作模式，CAN控制有四种模式：正常模式、静默模式、回环模式及静默回环模式，通常设置为正常模式即可；
     </li>
     <li>
      17行：设置再次同步补偿宽度，因时钟频率偏差、传送延迟等，各单元有同步误差，这里设置补偿此误差的最大值，范围为1~4Tq；
     </li>
     <li>
      18行：设置位段1（BS1）的长度为6Tq；
     </li>
     <li>
      19行：设置位段2（BS2）的长度为2Tq，由前面的波特率计算公式可得：36M/(1+6+2)/8 = 500Kbps；
     </li>
     <li>
      20行：设置间触发通信模式，禁止时间触发通信模式；
     </li>
     <li>
      21行：禁止总线自动关闭，控制CAN在退出总线关闭状态时的行为；
     </li>
     <li>
      22行：禁止自动唤醒，控制CAN在眠模式下接收到消息时的行为；
     </li>
     <li>
      23行：开启自动重传，CAN将自动重发消息，直到CAN消息发送成功；关闭后，无论成功、错误或仲裁丢失，都只发送一次；
     </li>
     <li>
      24行：禁止接收FIFO锁定，当接收FIFO装满后，下一条传入消息将覆盖前一条消息；使能后，接收FIFO装满后，下一条传入消息将被丢弃；
     </li>
     <li>
      25行：禁止传输FIFO优先级，则优先级由消息标识符决定；使能后，由请求顺序（时间顺序）决定；
     </li>
    </ul>
    <p>
     <strong>
      27~30行：初始化前面设置的CAN参数，同时会调用CAN硬件相关初始化函数“HAL_CAN_MspInit()”;
     </strong>
    </p>
    <p>
     <strong>
      32~41行：设置CAN筛选器；
     </strong>
    </p>
    <ul>
     <li>
      33行：设置哪一个CAN筛选器组，设置设置筛选器组0，STM32F103ZET6共有14个筛选器组；
     </li>
     <li>
      34行：“CAN_FILTERMODE_IDMASK”设置为掩码模式，“CAN_FILTERMODE_IDLIST”设置为列表模式；
     </li>
     <li>
      35行：设置筛选范围可设置为32位；
     </li>
     <li>
      36~37行：设置ID的高低字节，这里设置ID为0；
     </li>
     <li>
      38~39行：设置掩码的高低字节，这里设置掩码为0，则没有做任何过滤；
     </li>
     <li>
      40行：设置本筛选器的消息存储在哪个FIFO（接收FIFO共有两个）；
     </li>
     <li>
      41行：使能本筛选器；
     </li>
    </ul>
    <p>
     <strong>
      43~46行：配置前面设置的筛选器；
     </strong>
     <br/>
     <strong>
      48~52行：启动CAN；
     </strong>
     <br/>
     <strong>
      54~58行：使能CAN接收FIFO0的中断
     </strong>
     ；注意这里使能的是FIFO0，需要和前面设置筛选器的FIFO保持一致；这里可以设置三种类型FIFO中断，分别为“CAN_IT_RX_FIFO0_MSG_PENDING”FIFO接收到数据就
     <br/>
     产生中断、“CAN_IT_RX_FIFO0_FULL”FIFO接收满后产生中断“CAN_IT_RX_FIFO0_OVERRUN”FIFO溢出产生中断；
    </p>
    <p>
     前面“HAL_CAN_Init()”会调用CAN硬件相关初始化函数“HAL_CAN_MspInit()”，该函数需要我们自己完善，如代码段 23.3.2 所示。
    </p>
    <p>
     代码段 23.3.2 CAN 硬件初始化（driver_can.c）
    </p>
    <pre><code class="prism language-c"><span class="token comment">/*
* 函数名：void HAL_CAN_MspInit(CAN_HandleTypeDef *hcanhandle)
* 输入参数：hcanhandle-CAN 句柄
* 输出参数：无
* 返回值：无
* 函数作用：初始化 CAN 硬件相关
*/</span>
<span class="token keyword">void</span> <span class="token function">HAL_CAN_MspInit</span><span class="token punctuation">(</span>CAN_HandleTypeDef <span class="token operator">*</span>hcanhandle<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
GPIO_InitTypeDef GPIO_InitStruct<span class="token punctuation">;</span>
<span class="token function">__HAL_RCC_GPIOB_CLK_ENABLE</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">__HAL_RCC_CAN1_CLK_ENABLE</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">__HAL_RCC_AFIO_CLK_ENABLE</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 重映射时钟使能</span>
<span class="token function">__HAL_AFIO_REMAP_CAN1_2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 重映射</span>
GPIO_InitStruct<span class="token punctuation">.</span>Pin <span class="token operator">=</span> GPIO_PIN_9<span class="token punctuation">;</span>
GPIO_InitStruct<span class="token punctuation">.</span>Mode <span class="token operator">=</span> GPIO_MODE_AF_PP<span class="token punctuation">;</span>
GPIO_InitStruct<span class="token punctuation">.</span>Speed <span class="token operator">=</span> GPIO_SPEED_FREQ_HIGH<span class="token punctuation">;</span>
GPIO_InitStruct<span class="token punctuation">.</span>Pull <span class="token operator">=</span> GPIO_PULLUP<span class="token punctuation">;</span>
<span class="token function">HAL_GPIO_Init</span><span class="token punctuation">(</span>GPIOB<span class="token punctuation">,</span> <span class="token operator">&amp;</span>GPIO_InitStruct<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//PB9 CAN TX</span>
GPIO_InitStruct<span class="token punctuation">.</span>Pin <span class="token operator">=</span> GPIO_PIN_8<span class="token punctuation">;</span>
GPIO_InitStruct<span class="token punctuation">.</span>Mode <span class="token operator">=</span> GPIO_MODE_INPUT<span class="token punctuation">;</span>
GPIO_InitStruct<span class="token punctuation">.</span>Speed <span class="token operator">=</span> GPIO_SPEED_FREQ_HIGH<span class="token punctuation">;</span>
GPIO_InitStruct<span class="token punctuation">.</span>Pull <span class="token operator">=</span> GPIO_PULLUP<span class="token punctuation">;</span>
<span class="token function">HAL_GPIO_Init</span><span class="token punctuation">(</span>GPIOB<span class="token punctuation">,</span> <span class="token operator">&amp;</span>GPIO_InitStruct<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//PB8 CAN RX</span>
<span class="token comment">// HAL_Init()里默认优先级分组 4</span>
<span class="token function">HAL_NVIC_SetPriority</span><span class="token punctuation">(</span>CAN1_RX0_IRQn<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 设置 CAN 接收中断的优先级和使能</span>
<span class="token function">HAL_NVIC_EnableIRQ</span><span class="token punctuation">(</span>CAN1_RX0_IRQn<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">HAL_NVIC_SetPriority</span><span class="token punctuation">(</span>CAN1_TX_IRQn<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 设置 CAN 发送中断的优先级和使能</span>
<span class="token function">HAL_NVIC_EnableIRQ</span><span class="token punctuation">(</span>CAN1_TX_IRQn<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
</code></pre>
    <p>
     需要注意，PB8、PB9如果用于CAN引脚，不是引脚典型复用，而是需要引脚复用重映射，如图 23.3.1所示为《数据手册》部分引脚描述截图。因此代码段 23.3.2 中14~15行需要先使能重映射时钟，再重映射CAN功能。
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/9bbf1588748b01305377236adb9088ac.png"/>
    </p>
    <ol start="2">
     <li>
      封装CAN发送函数和接收回调函数
      <br/>
      初始化完CAN后，便可以调用HAL库提供的“HAL_CAN_AddTxMessage()”将报文放入发送信箱，供CAN控制器发送。在这之前，需要准备好报文，如代码段 23.3.3 所示。
     </li>
    </ol>
    <p>
     代码段 23.3.3 CAN 发送函数（driver_can.c）
    </p>
    <pre><code class="prism language-c"><span class="token comment">/*
* 函数名：void CAN_Transmit(uint16_t ID, uint8_t *pdata, uint8_t length)
* 输入参数：ID -&gt; CAN 发送报文的 ID
* pdata -&gt; 发送报文的首地址
* length-&gt; 发送报文的个数，最大 8 个字节
* 输出参数：无
* 返回值：无
* 函数作用：CAN1 发送函数
*/</span>
<span class="token keyword">void</span> <span class="token function">CAN_Transmit</span><span class="token punctuation">(</span><span class="token class-name">uint16_t</span> ID<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> <span class="token operator">*</span>pdata<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> length<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
<span class="token class-name">uint32_t</span> tx_mailbox <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">if</span><span class="token punctuation">(</span>length<span class="token operator">&gt;</span><span class="token number">8</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token keyword">return</span> <span class="token punctuation">;</span> <span class="token punctuation">}</span>
TxHeader<span class="token punctuation">.</span>StdId <span class="token operator">=</span> ID<span class="token punctuation">;</span> <span class="token comment">// 标准标识符</span>
TxHeader<span class="token punctuation">.</span>ExtId <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// 扩展标识符</span>
TxHeader<span class="token punctuation">.</span>IDE <span class="token operator">=</span> CAN_ID_STD<span class="token punctuation">;</span> <span class="token comment">// 帧模式(标准帧或扩展帧)</span>
TxHeader<span class="token punctuation">.</span>RTR <span class="token operator">=</span> CAN_RTR_DATA<span class="token punctuation">;</span> <span class="token comment">// 帧类型(数据帧或远程帧)</span>
TxHeader<span class="token punctuation">.</span>DLC <span class="token operator">=</span> length<span class="token punctuation">;</span> <span class="token comment">// 数据长度</span>
TxHeader<span class="token punctuation">.</span>TransmitGlobalTime <span class="token operator">=</span> DISABLE<span class="token punctuation">;</span> <span class="token comment">// 不发送时间标记</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">HAL_CAN_AddTxMessage</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>hcan<span class="token punctuation">,</span> <span class="token operator">&amp;</span>TxHeader<span class="token punctuation">,</span> pdata<span class="token punctuation">,</span> <span class="token operator">&amp;</span>tx_mailbox<span class="token punctuation">)</span> <span class="token operator">!=</span> HAL_OK<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
<span class="token function">Error_Handler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span>
</code></pre>
    <p>
     <strong>
      12~23行：准备发送报文；
     </strong>
    </p>
    <ol>
     <li>
      初始化CAN
      <br/>
      CAN的初始化，包含两部分：协议部分和硬件部分。
      <br/>
      协议部分初始化如代码段 23.3.1 所示。
     </li>
    </ol>
    <p>
     代码段 23.3.1 CAN 协议初始化（driver_can.c）
    </p>
    <pre><code class="prism language-c"><span class="token comment">/*
* 函数名：void CAN_Init(void)
* 输入参数：无
* 输出参数：无
* 返回值：无
* 函数作用：初始化 CAN1
*/</span>
<span class="token keyword">void</span> <span class="token function">CAN_Init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
CAN_FilterTypeDef sFilterConfig<span class="token punctuation">;</span>
hcan<span class="token punctuation">.</span>Instance <span class="token operator">=</span> CAN1<span class="token punctuation">;</span>
<span class="token comment">/* 配置 CAN 的基本参数 */</span>
hcan<span class="token punctuation">.</span>Init<span class="token punctuation">.</span>Prescaler <span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">;</span> <span class="token comment">// 预分频,范围(1~1024)</span>
hcan<span class="token punctuation">.</span>Init<span class="token punctuation">.</span>Mode <span class="token operator">=</span> CAN_MODE_NORMAL<span class="token punctuation">;</span> <span class="token comment">// 正常工作模式</span>
hcan<span class="token punctuation">.</span>Init<span class="token punctuation">.</span>SyncJumpWidth <span class="token operator">=</span> CAN_SJW_1TQ<span class="token punctuation">;</span> <span class="token comment">// 再次同步跳跃宽度为 1Tq</span>
hcan<span class="token punctuation">.</span>Init<span class="token punctuation">.</span>TimeSeg1 <span class="token operator">=</span> CAN_BS1_6TQ<span class="token punctuation">;</span> <span class="token comment">// 位段 1(BS1)的长度为 6Tq</span>
hcan<span class="token punctuation">.</span>Init<span class="token punctuation">.</span>TimeSeg2 <span class="token operator">=</span> CAN_BS2_2TQ<span class="token punctuation">;</span> <span class="token comment">// 位段 2(BS2)的长度为 2Tq</span>
hcan<span class="token punctuation">.</span>Init<span class="token punctuation">.</span>TimeTriggeredMode <span class="token operator">=</span> DISABLE<span class="token punctuation">;</span> <span class="token comment">// 禁止时间触发通信模式</span>
hcan<span class="token punctuation">.</span>Init<span class="token punctuation">.</span>AutoBusOff <span class="token operator">=</span> DISABLE<span class="token punctuation">;</span> <span class="token comment">// 禁止总线自动关闭</span>
hcan<span class="token punctuation">.</span>Init<span class="token punctuation">.</span>AutoWakeUp <span class="token operator">=</span> DISABLE<span class="token punctuation">;</span> <span class="token comment">// 禁止自动唤醒</span>
hcan<span class="token punctuation">.</span>Init<span class="token punctuation">.</span>AutoRetransmission <span class="token operator">=</span> ENABLE<span class="token punctuation">;</span> <span class="token comment">// 使能自动重传</span>
hcan<span class="token punctuation">.</span>Init<span class="token punctuation">.</span>ReceiveFifoLocked <span class="token operator">=</span> DISABLE<span class="token punctuation">;</span> <span class="token comment">// 禁止接收 FIFO 锁定</span>
hcan<span class="token punctuation">.</span>Init<span class="token punctuation">.</span>TransmitFifoPriority <span class="token operator">=</span> DISABLE<span class="token punctuation">;</span> <span class="token comment">// 禁止传输 FIFO 优先级</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">HAL_CAN_Init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>hcan<span class="token punctuation">)</span> <span class="token operator">!=</span> HAL_OK<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
<span class="token function">Error_Handler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token comment">/* 配置 CAN 的筛选器，此处全部接收，不做过滤 */</span>
sFilterConfig<span class="token punctuation">.</span>FilterBank <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// 选择筛选器组 0</span>
sFilterConfig<span class="token punctuation">.</span>FilterMode <span class="token operator">=</span> CAN_FILTERMODE_IDMASK<span class="token punctuation">;</span> <span class="token comment">// 设置为掩码模式</span>
sFilterConfig<span class="token punctuation">.</span>FilterScale <span class="token operator">=</span> CAN_FILTERSCALE_32BIT<span class="token punctuation">;</span> <span class="token comment">// 32 位长度</span>
sFilterConfig<span class="token punctuation">.</span>FilterIdHigh <span class="token operator">=</span> <span class="token number">0x0000</span><span class="token punctuation">;</span> <span class="token comment">// ID 高字节</span>
sFilterConfig<span class="token punctuation">.</span>FilterIdLow <span class="token operator">=</span> <span class="token number">0x0000</span><span class="token punctuation">;</span> <span class="token comment">// ID 低字节</span>
sFilterConfig<span class="token punctuation">.</span>FilterMaskIdHigh <span class="token operator">=</span> <span class="token number">0x0000</span><span class="token punctuation">;</span> <span class="token comment">// 掩码高字节</span>
sFilterConfig<span class="token punctuation">.</span>FilterMaskIdLow <span class="token operator">=</span> <span class="token number">0x0000</span><span class="token punctuation">;</span> <span class="token comment">// 掩码低字节</span>
sFilterConfig<span class="token punctuation">.</span>FilterFIFOAssignment <span class="token operator">=</span> CAN_RX_FIFO0<span class="token punctuation">;</span> <span class="token comment">// 过滤器关联 FIFO</span>
sFilterConfig<span class="token punctuation">.</span>FilterActivation <span class="token operator">=</span> ENABLE<span class="token punctuation">;</span> <span class="token comment">// 使能筛选器</span>
<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">HAL_CAN_ConfigFilter</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>hcan<span class="token punctuation">,</span> <span class="token operator">&amp;</span>sFilterConfig<span class="token punctuation">)</span> <span class="token operator">!=</span> HAL_OK<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
<span class="token function">Error_Handler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token comment">// 启用 CAN</span>
<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">HAL_CAN_Start</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>hcan<span class="token punctuation">)</span> <span class="token operator">!=</span> HAL_OK<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
<span class="token function">Error_Handler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token comment">// 使能 CAN 接收 FIFO0 中断</span>
<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">HAL_CAN_ActivateNotification</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>hcan<span class="token punctuation">,</span> CAN_IT_RX_FIFO0_MSG_PENDING<span class="token punctuation">)</span> <span class="token operator">!=</span> HAL_OK<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
<span class="token function">Error_Handler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span>
</code></pre>
    <p>
     <strong>
      12~25行：设置CAN协议参数；
     </strong>
    </p>
    <ul>
     <li>
      12行：设置哪一个CAN控制器，STM32F103ZET6只有一个CAN控制器；
     </li>
     <li>
      15行：设置时钟的预分频，与后面的位段时间长度组合，实现需要的500Kbps，这里先设置为8分频；
     </li>
     <li>
      16行：设置CAN工作模式，CAN控制有四种模式：正常模式、静默模式、回环模式及静默回环模式，通常设置为正常模式即可；
     </li>
     <li>
      17行：设置再次同步补偿宽度，因时钟频率偏差、传送延迟等，各单元有同步误差，这里设置补偿此误差的最大值，范围为1~4Tq；
     </li>
     <li>
      18行：设置位段1（BS1）的长度为6Tq；
     </li>
     <li>
      19行：设置位段2（BS2）的长度为2Tq，由前面的波特率计算公式可得：36M/(1+6+2)/8 = 500Kbps；
     </li>
     <li>
      20行：设置间触发通信模式，禁止时间触发通信模式；
     </li>
     <li>
      21行：禁止总线自动关闭，控制CAN在退出总线关闭状态时的行为；
     </li>
     <li>
      22行：禁止自动唤醒，控制CAN在眠模式下接收到消息时的行为；
     </li>
     <li>
      23行：开启自动重传，CAN将自动重发消息，直到CAN消息发送成功；关闭后，无论成功、错误或仲裁丢失，都只发送一次；
     </li>
     <li>
      24行：禁止接收FIFO锁定，当接收FIFO装满后，下一条传入消息将覆盖前一条消息；使能后，接收FIFO装满后，下一条传入消息将被丢弃；
     </li>
     <li>
      25行：禁止传输FIFO优先级，则优先级由消息标识符决定；使能后，由请求顺序（时间顺序）决定；
     </li>
    </ul>
    <p>
     <strong>
      27~30行：初始化前面设置的CAN参数，同时会调用CAN硬件相关初始化函数“HAL_CAN_MspInit()”;
     </strong>
    </p>
    <p>
     <strong>
      32~41行：设置CAN筛选器；
     </strong>
    </p>
    <ul>
     <li>
      33行：设置哪一个CAN筛选器组，设置设置筛选器组0，STM32F103ZET6共有14个筛选器组；
     </li>
     <li>
      34行：“CAN_FILTERMODE_IDMASK”设置为掩码模式，“CAN_FILTERMODE_IDLIST”设置为列表模式；
     </li>
     <li>
      35行：设置筛选范围可设置为32位；
     </li>
     <li>
      36~37行：设置ID的高低字节，这里设置ID为0；
     </li>
     <li>
      38~39行：设置掩码的高低字节，这里设置掩码为0，则没有做任何过滤；
     </li>
     <li>
      40行：设置本筛选器的消息存储在哪个FIFO（接收FIFO共有两个）；
     </li>
     <li>
      41行：使能本筛选器；
     </li>
    </ul>
    <p>
     <strong>
      43~46行：配置前面设置的筛选器；
     </strong>
     <br/>
     <strong>
      48~52行：启动CAN；
     </strong>
     <br/>
     <strong>
      54~58行：使能CAN接收FIFO0的中断
     </strong>
     ；注意这里使能的是FIFO0，需要和前面设置筛选器的FIFO保持一致；这里可以设置三种类型FIFO中断，分别为:“CAN_IT_RX_FIFO0_MSG_PENDING”FIFO接收到数据就产生中断、“CAN_IT_RX_FIFO0_FULL”FIFO接收满后产生中断、“CAN_IT_RX_FIFO0_OVERRUN”FIFO溢出产生中断；
    </p>
    <p>
     前面“HAL_CAN_Init()”会调用CAN硬件相关初始化函数“HAL_CAN_MspInit()”，该函数需要我们自己完善，如代码段 23.3.2 所示。
    </p>
    <p>
     代码段 23.3.2 CAN 硬件初始化（driver_can.c）
    </p>
    <pre><code class="prism language-c"><span class="token comment">/*
* 函数名：void HAL_CAN_MspInit(CAN_HandleTypeDef *hcanhandle)
* 输入参数：hcanhandle-CAN 句柄
* 输出参数：无
* 返回值：无
* 函数作用：初始化 CAN 硬件相关
*/</span>
<span class="token keyword">void</span> <span class="token function">HAL_CAN_MspInit</span><span class="token punctuation">(</span>CAN_HandleTypeDef <span class="token operator">*</span>hcanhandle<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
GPIO_InitTypeDef GPIO_InitStruct<span class="token punctuation">;</span>
<span class="token function">__HAL_RCC_GPIOB_CLK_ENABLE</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">__HAL_RCC_CAN1_CLK_ENABLE</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">__HAL_RCC_AFIO_CLK_ENABLE</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 重映射时钟使能</span>
<span class="token function">__HAL_AFIO_REMAP_CAN1_2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 重映射</span>
GPIO_InitStruct<span class="token punctuation">.</span>Pin <span class="token operator">=</span> GPIO_PIN_9<span class="token punctuation">;</span>
GPIO_InitStruct<span class="token punctuation">.</span>Mode <span class="token operator">=</span> GPIO_MODE_AF_PP<span class="token punctuation">;</span>
GPIO_InitStruct<span class="token punctuation">.</span>Speed <span class="token operator">=</span> GPIO_SPEED_FREQ_HIGH<span class="token punctuation">;</span>
GPIO_InitStruct<span class="token punctuation">.</span>Pull <span class="token operator">=</span> GPIO_PULLUP<span class="token punctuation">;</span>
<span class="token function">HAL_GPIO_Init</span><span class="token punctuation">(</span>GPIOB<span class="token punctuation">,</span> <span class="token operator">&amp;</span>GPIO_InitStruct<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//PB9 CAN TX</span>
GPIO_InitStruct<span class="token punctuation">.</span>Pin <span class="token operator">=</span> GPIO_PIN_8<span class="token punctuation">;</span>
GPIO_InitStruct<span class="token punctuation">.</span>Mode <span class="token operator">=</span> GPIO_MODE_INPUT<span class="token punctuation">;</span>
GPIO_InitStruct<span class="token punctuation">.</span>Speed <span class="token operator">=</span> GPIO_SPEED_FREQ_HIGH<span class="token punctuation">;</span>
GPIO_InitStruct<span class="token punctuation">.</span>Pull <span class="token operator">=</span> GPIO_PULLUP<span class="token punctuation">;</span>
<span class="token function">HAL_GPIO_Init</span><span class="token punctuation">(</span>GPIOB<span class="token punctuation">,</span> <span class="token operator">&amp;</span>GPIO_InitStruct<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//PB8 CAN RX</span>
<span class="token comment">// HAL_Init()里默认优先级分组 4</span>
<span class="token function">HAL_NVIC_SetPriority</span><span class="token punctuation">(</span>CAN1_RX0_IRQn<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 设置 CAN 接收中断的优先级和使能</span>
<span class="token function">HAL_NVIC_EnableIRQ</span><span class="token punctuation">(</span>CAN1_RX0_IRQn<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">HAL_NVIC_SetPriority</span><span class="token punctuation">(</span>CAN1_TX_IRQn<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 设置 CAN 发送中断的优先级和使能</span>
<span class="token function">HAL_NVIC_EnableIRQ</span><span class="token punctuation">(</span>CAN1_TX_IRQn<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
</code></pre>
    <p>
     需要注意，PB8、PB9如果用于CAN引脚，不是引脚典型复用，而是需要引脚复用重映射，如图 23.3.1所示为《数据手册》部分引脚描述截图。因此代码段 23.3.2 中14~15行需要先使能重映射时钟，再重映射CAN功能。
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/5550cd0f0d7a330c0b11e3c653240da1.png"/>
    </p>
    <ol start="2">
     <li>
      封装CAN发送函数和接收回调函数
      <br/>
      初始化完CAN后，便可以调用HAL库提供的“HAL_CAN_AddTxMessage()”将报文放入发送信箱，供CAN控制器发送。在这之前，需要准备好报文，如代码段 23.3.3 所示。
     </li>
    </ol>
    <p>
     代码段 23.3.3 CAN 发送函数（driver_can.c）
    </p>
    <pre><code class="prism language-c"><span class="token comment">/*
* 函数名：void CAN_Transmit(uint16_t ID, uint8_t *pdata, uint8_t length)
* 输入参数：ID -&gt; CAN 发送报文的 ID
* pdata -&gt; 发送报文的首地址
* length-&gt; 发送报文的个数，最大 8 个字节
* 输出参数：无
* 返回值：无
* 函数作用：CAN1 发送函数
*/</span>
<span class="token keyword">void</span> <span class="token function">CAN_Transmit</span><span class="token punctuation">(</span><span class="token class-name">uint16_t</span> ID<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> <span class="token operator">*</span>pdata<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> length<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
<span class="token class-name">uint32_t</span> tx_mailbox <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">if</span><span class="token punctuation">(</span>length<span class="token operator">&gt;</span><span class="token number">8</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token keyword">return</span> <span class="token punctuation">;</span> <span class="token punctuation">}</span>
TxHeader<span class="token punctuation">.</span>StdId <span class="token operator">=</span> ID<span class="token punctuation">;</span> <span class="token comment">// 标准标识符</span>
TxHeader<span class="token punctuation">.</span>ExtId <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// 扩展标识符</span>
TxHeader<span class="token punctuation">.</span>IDE <span class="token operator">=</span> CAN_ID_STD<span class="token punctuation">;</span> <span class="token comment">// 帧模式(标准帧或扩展帧)</span>
TxHeader<span class="token punctuation">.</span>RTR <span class="token operator">=</span> CAN_RTR_DATA<span class="token punctuation">;</span> <span class="token comment">// 帧类型(数据帧或远程帧)</span>
TxHeader<span class="token punctuation">.</span>DLC <span class="token operator">=</span> length<span class="token punctuation">;</span> <span class="token comment">// 数据长度</span>
TxHeader<span class="token punctuation">.</span>TransmitGlobalTime <span class="token operator">=</span> DISABLE<span class="token punctuation">;</span> <span class="token comment">// 不发送时间标记</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">HAL_CAN_AddTxMessage</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>hcan<span class="token punctuation">,</span> <span class="token operator">&amp;</span>TxHeader<span class="token punctuation">,</span> pdata<span class="token punctuation">,</span> <span class="token operator">&amp;</span>tx_mailbox<span class="token punctuation">)</span> <span class="token operator">!=</span> HAL_OK<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
<span class="token function">Error_Handler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span>
</code></pre>
    <p>
     <strong>
      12~23行：准备发送报文；
     </strong>
    </p>
    <ul>
     <li>
      12行：定义变量“tx_mailbox”，保存返回的邮箱编号；
     </li>
     <li>
      13~16行：限制每次报文，数据最多8字节；
     </li>
     <li>
      18行：设置报文的标准标识符；
     </li>
     <li>
      19行：设置报文的扩展标识符；
     </li>
     <li>
      20行：设置帧模式，这里设置为标准帧；
     </li>
     <li>
      21行：设置帧类型，这里设置为数据帧；
     </li>
     <li>
      22行：设置数据长度；
     </li>
     <li>
      23行：设置帧传输时是否获取时间标记，通常关闭；
     </li>
    </ul>
    <p>
     <strong>
      25~28行：调用“HAL_CAN_AddTxMessage()”发送报文；
     </strong>
    </p>
    <p>
     前面设置了CAN中断和中断优先级，当CAN控制器，发送完成或接收完成时，都将跳转到中断向量表的对应位置，执行中断处理函数，如代码段 23.3.4 所示。
    </p>
    <p>
     代码段 23.3.4 CAN 中断处理函数（driver_can.c）
    </p>
    <pre><code class="prism language-c"><span class="token comment">//CAN1 发送完成后，进入该中断</span>
<span class="token keyword">void</span> <span class="token function">CAN1_TX0_IRQHandler</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token function">HAL_CAN_IRQHandler</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>hcan<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token comment">//CAN1 接收完成后，进入该中断</span>
<span class="token keyword">void</span> <span class="token function">CAN1_RX0_IRQHandler</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token function">HAL_CAN_IRQHandler</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>hcan<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 回调 HAL_CAN_RxFifo0MsgPendingCallback()</span>
<span class="token punctuation">}</span>
<span class="token comment">/*
* 函数名：void HAL_CAN_RxFifo0MsgPendingCallback(CAN_HandleTypeDef *CanHandle)
* 输入参数：CanHandle -&gt; CAN 句柄
* 输出参数：无
* 返回值：无
* 函数作用：CAN1 接收回调函数
*/</span>
<span class="token keyword">void</span> <span class="token function">HAL_CAN_RxFifo0MsgPendingCallback</span><span class="token punctuation">(</span>CAN_HandleTypeDef <span class="token operator">*</span>CanHandle<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
<span class="token comment">/* Get RX message */</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">HAL_CAN_GetRxMessage</span><span class="token punctuation">(</span>CanHandle<span class="token punctuation">,</span> CAN_RX_FIFO0<span class="token punctuation">,</span> <span class="token operator">&amp;</span>RxHeader<span class="token punctuation">,</span> can_msg<span class="token punctuation">.</span>rx_msg<span class="token punctuation">)</span> <span class="token operator">!=</span> HAL_OK<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
<span class="token function">Error_Handler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
can_msg<span class="token punctuation">.</span>ID <span class="token operator">=</span> RxHeader<span class="token punctuation">.</span>StdId<span class="token punctuation">;</span> <span class="token comment">// 获取标准标识符</span>
can_msg<span class="token punctuation">.</span>length <span class="token operator">=</span> RxHeader<span class="token punctuation">.</span>DLC<span class="token punctuation">;</span> <span class="token comment">// 获取数据长度</span>
<span class="token function">CAN_SetRxFlag</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 设置接收标志位 }</span>
</code></pre>
    <ul>
     <li>
      1~5行：CAN1发送完成时，将进入中断向量“CAN1_TX0_IRQHandler”。这里发送完成后，不需要任何操作，因此没有编写发送完成的中断函数；
     </li>
     <li>
      7~11行：CAN1接收完成时，将进入中断向量“CAN1_RX0_IRQHandler”。这里接收完成后，会调用一系列中断函数，其中“HAL_CAN_RxFifo0MsgPendingCallback()”为接收FIFO0消息等待回调函数；
     </li>
     <li>
      13~30行：编写接收FIFO0消息等待回调函数，使用“HAL_CAN_GetRxMessage()”获取报文，随后修改接收标志位，以便其它函数查询是否接收到数据；
     </li>
    </ul>
    <p>
     本实验中涉及的RS485、串口打印、按键等实现，参考之前相关章节的讲解。
    </p>
    <ol start="3">
     <li>
      主函数控制逻辑
      <br/>
      在主函数里，每按一下按键，先构造RS485要发送的数据，然后调用“RS485_Tx()”发送数据。随后查询CAN是否收到数据，如果收到数据，打印CAN收到的数据。接着，构造CAN要发送的ID和数据，调用“CAN_Transmit()”发送报文，然后使用“RS485_Rx()”接收数据，并打印，如代码段 23.3.5 所示。
     </li>
    </ol>
    <p>
     代码段 23.3.5 主函数控制逻辑（main.c）
    </p>
    <pre><code class="prism language-c"><span class="token comment">// 初始化 CAN</span>
<span class="token function">CAN_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 初始化 USART1，设置波特率为 115200 bps</span>
<span class="token function">DEBUG_USART_Init</span><span class="token punctuation">(</span><span class="token number">115200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 初始化 USART2，设置波特率为 9600 bps</span>
<span class="token function">RS485_Init</span><span class="token punctuation">(</span><span class="token number">9600</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 初始化按键</span>
<span class="token function">KeyInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 在 windows 下字符串\n\r 表示回车</span>
<span class="token comment">// 如果工程在编译下面这句中文的时候报错，请在“Option for target”-&gt;"C/C++"-&gt;"Misc Controls"添加“ --locale=english”</span>
<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"**********************************************\n\r"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"--&gt;百问科技 www.100ask.net\n\r"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"--&gt;CAN 收发实验\n\r"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"**********************************************\n\r"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token comment">// RS485 开始发送数据给 CAN</span>
<span class="token keyword">if</span><span class="token punctuation">(</span>step<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token comment">// 初始化 RS485 发送信息</span>
RS485_Msg<span class="token punctuation">.</span>length <span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">;</span>
<span class="token keyword">for</span><span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span><span class="token number">8</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
RS485_Msg<span class="token punctuation">.</span>tx_data<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> i<span class="token punctuation">;</span>
<span class="token function">RS485_Tx</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>RS485_Msg<span class="token punctuation">.</span>tx_data<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//如果 CAN 收到了帧报文，即 RS485 的数据帧</span>
<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">CAN_GetRxFlag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token function">CAN_SetRxFlag</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
step <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\n\r"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"* RS485 发送数据: \n\r"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Tx Data: "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">for</span><span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span>can_msg<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"0x%x "</span><span class="token punctuation">,</span> RS485_Msg<span class="token punctuation">.</span>tx_data<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\n\r"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"* CAN 接收报文内容: \n\r"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"ID: 0x%x \n\r"</span><span class="token punctuation">,</span> can_msg<span class="token punctuation">.</span>ID<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Rx Data: "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">for</span><span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span>can_msg<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"0x%x "</span><span class="token punctuation">,</span> can_msg<span class="token punctuation">.</span>rx_msg<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\n\r"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span>
<span class="token comment">// CAN 发送帧 ID+帧数据给 RS485</span>
<span class="token keyword">if</span><span class="token punctuation">(</span>step<span class="token operator">==</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token comment">// 初始化 CAN 发送信息</span>
can_msg<span class="token punctuation">.</span>ID <span class="token operator">=</span> <span class="token number">0x306</span><span class="token punctuation">;</span>
can_msg<span class="token punctuation">.</span>length <span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">;</span>
<span class="token keyword">for</span><span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span><span class="token number">8</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
can_msg<span class="token punctuation">.</span>tx_msg<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> i<span class="token operator">|</span><span class="token number">0xF0</span><span class="token punctuation">;</span>
<span class="token function">CAN_Transmit</span><span class="token punctuation">(</span>can_msg<span class="token punctuation">.</span>ID<span class="token punctuation">,</span> can_msg<span class="token punctuation">.</span>tx_msg<span class="token punctuation">,</span> can_msg<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">RS485_Rx</span><span class="token punctuation">(</span>RS485_Msg<span class="token punctuation">.</span>rx_data<span class="token punctuation">,</span> RS485_Msg<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
step <span class="token operator">=</span> <span class="token number">0xFF</span><span class="token punctuation">;</span>
<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\n\r"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"* CAN 发送报文内容：\n\r"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"ID: 0x%x \n\r"</span><span class="token punctuation">,</span>can_msg<span class="token punctuation">.</span>ID<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Tx Data: "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">for</span><span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span>can_msg<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"0x%x "</span><span class="token punctuation">,</span> can_msg<span class="token punctuation">.</span>tx_msg<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\n\r"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"* RS485 接收数据：\n\r"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Rx Data: "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">for</span><span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span>RS485_Msg<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"0x%x "</span><span class="token punctuation">,</span> RS485_Msg<span class="token punctuation">.</span>rx_data<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\n\r"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span>
</code></pre>
    <h3>
     <a id="234__549">
     </a>
     23.4 实验效果
    </h3>
    <p>
     本实验对应配套资料的“5_程序源码\15_通信—CAN\”。打开工程后，编译，下载。按图 23.4.1 所示，将开发板、RS485_CAN互转模块连接，开发板的CAN接模块的CAN，开发板的RS485接模块的RS485，且线都不交叉，注意此时的J11（蓝色拨码开关）的1脚拨为ON。
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/a533122e30579235171328561603cbdd.png"/>
     <br/>
     按下按键KEY1（KEY_U），即可看到串口如图 23.4.2 所示。首先RS485发送数据，CAN接收到相同的数据，RS485_CAN互换模块为CAN添加了0x0的ID。随便CAN发送数据，RS485接收到相同的数据，CAN报文的ID被RS485_CAN互换模块省略。
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/6605aa96c94a5bafa1d21bd933c8650a.png"/>
    </p>
    <hr/>
    <p>
     百问网技术论坛：
     <br/>
     <a href="http://bbs.100ask.net/" rel="nofollow">
      http://bbs.100ask.net/
     </a>
    </p>
    <p>
     百问网嵌入式视频官网：
     <br/>
     <a href="https://www.100ask.net/index" rel="nofollow">
      https://www.100ask.net/index
     </a>
    </p>
    <p>
     百问网开发板：
     <br/>
     淘宝：
     <a href="https://100ask.taobao.com/" rel="nofollow">
      https://100ask.taobao.com/
     </a>
     <br/>
     天猫：
     <a href="https://weidongshan.tmall.com/" rel="nofollow">
      https://weidongshan.tmall.com/
     </a>
    </p>
    <p>
     技术交流群2（鸿蒙开发/Linux/嵌入式/驱动/资料下载）
     <br/>
     QQ群：752871361
    </p>
    <p>
     单片机-嵌入式Linux交流群：
     <br/>
     QQ群：536785813
    </p>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
</div>


<p class="artid" style="display:none">68747470733a2f2f62:6c6f672e6373646e2e6e65742f746869737761795f6469792f:61727469636c652f64657461696c732f313137373032373832</p>
