---
layout: post
title: "快速实现-WIFI-MQTT通信详解"
date: 2022-04-29 12:22:34 +0800
description: "WIFI+MQTT接入ONE NET云平台一、本例程实现功能介绍二、云平台操作流程三、硬件接线图、材"
keywords: "mqtt接上路由器之后’"
categories: ['物联网']
tags: ['物联网', '嵌入式硬件', '嵌入式', '单片机']
artid: "124493108"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=124493108
    alt: "快速实现-WIFI-MQTT通信详解"
render_with_liquid: false
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     快速实现 WIFI MQTT通信详解
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-tomorrow-night-eighties" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <p>
    </p>
    <div class="toc">
     <h4>
      WIFI+MQTT接入ONE NET云平台
     </h4>
     <ul>
      <li>
       <ul>
        <li>
         <a href="#_5" rel="nofollow">
          一、本例程实现功能介绍
         </a>
        </li>
        <li>
         <a href="#_8" rel="nofollow">
          二、云平台操作流程
         </a>
        </li>
        <li>
         <a href="#_38" rel="nofollow">
          三、硬件接线图、材料清单
         </a>
        </li>
        <li>
         <a href="#_41" rel="nofollow">
          四、完整代码&amp;代码解析
         </a>
        </li>
        <li>
         <a href="#_212" rel="nofollow">
          五、代码实验现象
         </a>
        </li>
       </ul>
      </li>
     </ul>
    </div>
    <p>
    </p>
    <blockquote>
     <p>
      前言：MQTT是一种基于TCP的物联网通信协议，在物联网领域应用非常广泛，基本上所有的云平台都支持设备以MQTT协议接入，所以如果您的设备支持MQTT连接，就可以很容易的对接各云平台（比如ONE
      <br/>
      NET、阿里云、腾讯云等）。CORE提供的MQTT库函数也十分简单，您只需根据各云平台的规则，在调用MQTT库函数时对传入的参数做相应的调整即可对接各家云平台。
     </p>
    </blockquote>
    <h3>
     <a id="_5">
     </a>
     一、本例程实现功能介绍
    </h3>
    <p>
     CORE向云端(ONE NET)上传温湿度数据，同时也接受云端下发的命令数据来控制CORE电路板上LED2灯的亮灭。
    </p>
    <h3>
     <a id="_8">
     </a>
     二、云平台操作流程
    </h3>
    <p>
     <strong>
      STEP 1: 注册并登录平台账号
     </strong>
     <br/>
     在ONE NET云平台官网(https://open.iot.10086.cn)注册并登录开发者账号
     <br/>
     注册账号方法： https://open.iot.10086.cn/doc/easy-manual/
     <br/>
     <strong>
      STEP 2: 创建产品
     </strong>
     <br/>
     产品相当于一个集合，该集合下面可以有成千上万的相同功能的设备。
    </p>
    <p>
     产品创建方法： https://open.iot.10086.cn/doc/mqtt/book/get-start/product&amp;device/createProduct.html
    </p>
    <p>
     下图是我创建的产品的概况：
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/bb9ea63694872a1cc68d7b466eb30b34.png">
      <br/>
      产品名称为: “mqtt_test”
     </img>
    </p>
    <p>
     产品ID:“353255”，该值在后面的代码解析中会提到，是设备和云端建立连接时的必要参数
    </p>
    <p>
     access_key：该值这里我们用不到，但您以后开发客户端和云平台对接时就必须要了
     <br/>
     <strong>
      STEP 3: 创建设备
     </strong>
     <br/>
     设备相当于一个具体的硬件实物。
    </p>
    <p>
     设备创建方法： https://open.iot.10086.cn/doc/mqtt/book/get-start/product&amp;device/createDevice.html
    </p>
    <p>
     注意：设备名称必须唯一，设备名称中可以包含产品的SN码，MAC地址，唯一ID等等来保证唯一性。
     <br/>
     下图是我创建的设备的详情：
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/6fb33731ee960897d799747ea99ccf82.png">
      <br/>
      设备名称为: “TestDevice001”，该值在后面的代码解析中会提到，是设备和云端建立连接时的必要参数
     </img>
    </p>
    <p>
     设备key为： HNC7fq0yREOYs3uQoWREmZJjbwW8kiT6mxsDoh/dyW4= ，该值在后面的代码解析中会提到，是设备和云端建立连接时的必要参数
     <br/>
     <strong>
      STEP 4: 完成
     </strong>
     <br/>
     至此，我们已完成产品的创建，并在产品中创建了一例设备，在接下来的示例代码中，我们会用到已创建的产品和设备中的一些关键参数。
    </p>
    <h3>
     <a id="_38">
     </a>
     三、硬件接线图、材料清单
    </h3>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/43687d6a8638f9a66172ca7093e72a3a.png"/>
    </p>
    <h3>
     <a id="_41">
     </a>
     四、完整代码&amp;代码解析
    </h3>
    <p>
     <strong>
      （1）完整代码
     </strong>
     <br/>
     代码功能：CORE每隔9秒向云端(ONE NET)上传温湿度数据，同时也接受云端下发的数据来控制CORE电路板上LED2灯的亮灭。
    </p>
    <pre><code class="prism language-c"><span class="token operator">--</span>路由器连接参数
ap_ssid <span class="token operator">=</span> <span class="token string">"MyRouterName"</span> <span class="token operator">--</span>路由器账号
ap_passwd <span class="token operator">=</span> <span class="token string">"MyRouterPswd123"</span> <span class="token operator">--</span>路由器密码
<span class="token operator">--</span>MQTT服务器地址（适用于ONE NET平台）
server_addr <span class="token operator">=</span> <span class="token string">"183.230.40.96"</span> <span class="token operator">--</span>OneNet服务器ip地址，也可以写成<span class="token string">"mqtts.heclouds.com"</span>（推荐）
server_port <span class="token operator">=</span> <span class="token number">1883</span>
<span class="token operator">--</span>MQTT 连接参数（适用于ONE NET平台）
mqtt_con_clientID <span class="token operator">=</span> <span class="token string">"TestDevice001"</span>
mqtt_con_username <span class="token operator">=</span> <span class="token string">"353255"</span>
mqtt_con_password <span class="token operator">=</span> <span class="token string">"version=2018-10-31&amp;res=products%2F353255%2Fdevices%2FTestDevice001&amp;et=1893427200&amp;method=md5&amp;sign=%2F5RJwGwytPWvVDB04K7rnw%3D%3D"</span>
<span class="token operator">--</span>MQTT topic相关参数（适用于ONE NET平台）
mqtt_sub_topic <span class="token operator">=</span> <span class="token string">"$sys/353255/TestDevice001/cmd/request/+"</span><span class="token operator">--</span>订阅用
mqtt_pub_topic <span class="token operator">=</span> <span class="token string">"$sys/353255/TestDevice001/dp/post/json"</span> <span class="token operator">--</span>发布用
<span class="token operator">--</span>配置D9为普通输出<span class="token punctuation">,</span>控制LED2
<span class="token function">LIB_GpioOutputConfig</span><span class="token punctuation">(</span><span class="token string">"D9"</span><span class="token punctuation">,</span><span class="token string">"STANDARD"</span><span class="token punctuation">)</span>
<span class="token operator">--</span>使能系统<span class="token number">10</span>毫秒定时器开始工作
<span class="token function">LIB_10msTimerConfig</span><span class="token punctuation">(</span><span class="token string">"ENABLE"</span><span class="token punctuation">)</span>
<span class="token operator">--</span>初始化esp8266 Wifi模块，配置心跳包间隔时间为<span class="token number">180</span>秒，该值最好三倍于MQTT的KeepAlive时间
<span class="token function">LIB_WifiTcpConfig</span><span class="token punctuation">(</span><span class="token string">"UART0"</span><span class="token punctuation">,</span><span class="token string">"D5"</span><span class="token punctuation">,</span>ap_ssid<span class="token punctuation">,</span>ap_passwd<span class="token punctuation">,</span>server_addr<span class="token punctuation">,</span>server_port<span class="token punctuation">,</span><span class="token number">180</span><span class="token punctuation">)</span> <span class="token operator">--</span><span class="token number">180</span>
<span class="token operator">--</span>配置MQTT底层为WIFI传输<span class="token punctuation">(</span>esp8266<span class="token punctuation">)</span>，并按照如下参数进行MQTT连接，KeepAlive时间<span class="token operator">=</span><span class="token number">60</span>秒
<span class="token function">LIB_MQTTConfig</span><span class="token punctuation">(</span><span class="token string">"WIFI"</span><span class="token punctuation">,</span>mqtt_con_clientID<span class="token punctuation">,</span>mqtt_con_username<span class="token punctuation">,</span>mqtt_con_password<span class="token punctuation">,</span><span class="token string">"60"</span><span class="token punctuation">,</span>mqtt_sub_topic<span class="token punctuation">,</span><span class="token string">"QOS0"</span><span class="token punctuation">)</span>
<span class="token operator">--</span>设置sht3x传感器占用SCL0和SDA0引脚，以每秒出<span class="token number">10</span>个数据的频率工作，<span class="token string">"HIGH"</span>表示最高精度
<span class="token function">LIB_Sht3xConfig</span><span class="token punctuation">(</span><span class="token string">"IIC0"</span><span class="token punctuation">,</span><span class="token string">"10"</span><span class="token punctuation">,</span><span class="token string">"HIGH"</span><span class="token punctuation">)</span>
<span class="token operator">--</span>变量初始化
cnt_10ms <span class="token operator">=</span> <span class="token number">0</span>
pub_id <span class="token operator">=</span> <span class="token number">0</span>
temprature <span class="token operator">=</span> <span class="token number">0.00</span>
humidity <span class="token operator">=</span> <span class="token number">0.00</span>
<span class="token operator">--</span>定义<span class="token number">10</span>ms中断回调函数
function <span class="token function">LIB_10msTimerCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    cnt_10ms <span class="token operator">=</span> cnt_10ms <span class="token operator">+</span> <span class="token number">1</span>
end
<span class="token operator">--</span>开始大循环
<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token function">GC</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">==</span> true<span class="token punctuation">)</span>
<span class="token keyword">do</span>
    sht3x_flag<span class="token punctuation">,</span>temp<span class="token punctuation">,</span>humi <span class="token operator">=</span> <span class="token function">LIB_Sht3xGetResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token operator">--</span>如果传感器有新的温湿度数据产生
    <span class="token keyword">if</span> sht3x_flag <span class="token operator">==</span> <span class="token number">1</span> then
        temprature <span class="token operator">=</span> temp
        humidity <span class="token operator">=</span> humi
    end
    <span class="token operator">--</span>查询是否收到服务器下发的cmd数据<span class="token punctuation">(</span>已订阅的<span class="token string">"$sys/353255/TestDevice001/cmd/request/+"</span><span class="token punctuation">)</span>
    recv_flag<span class="token punctuation">,</span>topic<span class="token punctuation">,</span>data <span class="token operator">=</span> <span class="token function">LIB_MqttRecvSub</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> recv_flag <span class="token operator">==</span> <span class="token number">1</span> then
        <span class="token operator">--</span>根据json路径<span class="token string">"$.LED"</span>解析服务器下发的json文本，并执行LED亮灭操作
        Json_Val <span class="token operator">=</span> <span class="token function">LIB_JsonParse</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token string">"$.LED"</span><span class="token punctuation">)</span>
        <span class="token operator">--</span>服务器下发的是<span class="token string">"{"</span>LED<span class="token string">":0}"</span>
        <span class="token keyword">if</span> Json_Val <span class="token operator">==</span> <span class="token string">"0"</span> then
            <span class="token function">LIB_GpioWrite</span><span class="token punctuation">(</span><span class="token string">"D9"</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">--</span>LED2灭
        <span class="token operator">--</span>服务器下发的是<span class="token string">"{"</span>LED<span class="token string">":1}"</span>
        elseif Json_Val <span class="token operator">==</span> <span class="token string">"1"</span> then
            <span class="token function">LIB_GpioWrite</span><span class="token punctuation">(</span><span class="token string">"D9"</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">--</span>LED2亮
        <span class="token operator">--</span>服务器下发的是<span class="token string">"{"</span>LED<span class="token string">":2}"</span>
        elseif Json_Val <span class="token operator">==</span> <span class="token string">"2"</span> then
            <span class="token function">LIB_GpioToggle</span><span class="token punctuation">(</span><span class="token string">"D9"</span><span class="token punctuation">)</span> <span class="token operator">--</span>LED2亮灭切换
        <span class="token keyword">else</span> 
            <span class="token function">LIB_GpioWrite</span><span class="token punctuation">(</span><span class="token string">"D9"</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">--</span>LED2灭
        end
        <span class="token operator">--</span>根据收到的topic中的cmdid应答服务器，
        <span class="token operator">--</span>将收到的topic中<span class="token string">"request"</span>替换成<span class="token string">"response"</span>后作为应答topic发给服务器
        topic <span class="token operator">=</span> string<span class="token punctuation">.</span><span class="token function">gsub</span><span class="token punctuation">(</span>topic<span class="token punctuation">,</span><span class="token string">"request"</span><span class="token punctuation">,</span><span class="token string">"response"</span><span class="token punctuation">)</span> 
        <span class="token operator">--</span>应答内容可自定义，这里为<span class="token string">"Got it!"</span>
        <span class="token function">LIB_MqttSendPub</span><span class="token punctuation">(</span><span class="token string">"QOS0"</span><span class="token punctuation">,</span> topic<span class="token punctuation">,</span> <span class="token string">"Got it!"</span><span class="token punctuation">)</span>
        <span class="token operator">--</span>延时<span class="token number">2</span>秒是为了保证本次publish不被之后的publish覆盖，所以该延时太少可能导致LIB_MqttSendPub失败
        <span class="token function">LIB_DelayMs</span><span class="token punctuation">(</span><span class="token number">2000</span><span class="token punctuation">)</span>
    end
    <span class="token operator">--</span>每<span class="token number">9</span>秒发送温湿度度数据给server
    <span class="token keyword">if</span> cnt_10ms <span class="token operator">&gt;=</span> <span class="token number">900</span> then
        cnt_10ms <span class="token operator">=</span> <span class="token number">0</span>
        pub_id <span class="token operator">=</span> pub_id <span class="token operator">+</span> <span class="token number">1</span>
        json_str <span class="token operator">=</span> string<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"{\"id\":%d, \"dp\":{\"temperatrue\":[{\"v\": %.2f,}], \"humidity\":[{\"v\":%.2f,}]}}"</span><span class="token punctuation">,</span> pub_id<span class="token punctuation">,</span> temprature<span class="token punctuation">,</span> humidity<span class="token punctuation">)</span>
        <span class="token operator">--</span>注意json_str的总长度不要超过<span class="token number">250</span>字节
        <span class="token function">LIB_MqttSendPub</span><span class="token punctuation">(</span><span class="token string">"QOS0"</span><span class="token punctuation">,</span> mqtt_pub_topic<span class="token punctuation">,</span> json_str<span class="token punctuation">)</span> <span class="token operator">--</span>publish
    end
end
</code></pre>
    <p>
     <strong>
      （2）代码关键部分解析
     </strong>
     <br/>
     <strong>
      PART 1 （路由器参数）
     </strong>
    </p>
    <pre><code class="prism language-c"><span class="token operator">--</span>路由器连接参数
ap_ssid <span class="token operator">=</span> <span class="token string">"MyRouterName"</span> <span class="token operator">--</span>路由器账号
ap_passwd <span class="token operator">=</span> <span class="token string">"MyRouterPswd123"</span> <span class="token operator">--</span>路由器密码
</code></pre>
    <p>
     ap_ssid和ap_passwd请使用你自己的路由器账号密码。
     <br/>
     <strong>
      PART 2（云平台地址）
     </strong>
    </p>
    <pre><code class="prism language-c"><span class="token operator">--</span>MQTT服务器地址（适用于ONE NET平台）
server_addr <span class="token operator">=</span> <span class="token string">"183.230.40.96"</span> <span class="token operator">--</span>OneNet服务器ip地址，也可以写成<span class="token string">"mqtts.heclouds.com"</span>（推荐）
server_port <span class="token operator">=</span> <span class="token number">1883</span>
</code></pre>
    <p>
     server_addr和server_port是中国移动物联网(ONE NET)MQTT服务的固定IP地址和端口号，请不要改动它。
     <br/>
     <strong>
      PART 3（MQTT连接参数）
     </strong>
    </p>
    <pre><code class="prism language-c"><span class="token operator">--</span>MQTT 连接参数（适用于ONE NET平台）
mqtt_con_clientID <span class="token operator">=</span> <span class="token string">"TestDevice001"</span>
mqtt_con_username <span class="token operator">=</span> <span class="token string">"353255"</span>
mqtt_con_password <span class="token operator">=</span> <span class="token string">"version=2018-10-31&amp;res=products%2F353255%2Fdevices%2FTestDevice001&amp;et=1893427200&amp;method=md5&amp;sign=%2F5RJwGwytPWvVDB04K7rnw%3D%3D"</span>
</code></pre>
    <p>
     mqtt_con_clientID、mqtt_con_username、mqtt_con_password 这三个参数是设备和服务端建立mqtt连接时所必须的三个参数，如果你曾接入过多个物联网云平台，你会发现它们的异同往往都在这三个参数上。这里我们介绍ONE NET云平台下关于这三个参数的定义规则：
     <br/>
     ① mqtt_con_clientID： 设备和服务端建立mqtt连接时，clientID用来标识设备的唯一性，我这里我们使用的是设备名称“TestDevice001”，设备名称应具有唯一性，比如可以用您定义的SN序列号等，这里是我在创建该设备时起的名字"TestDevice001"。
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/67fcd41a936f965177f9c6527f8972de.png">
      <br/>
      ② mqtt_con_username：设备和服务端建立mqtt连接时，username用来认证连接的用户名，该值为产品ID
      <br/>
      <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/31d67cc64f545d669fa06dd9b343743e.png">
       <br/>
       ③ mqtt_con_password：设备和服务端建立mqtt连接时，password用来认证连接的密码。该密码的计算途径有两种：一种是通过电脑生成，一种是通过代码生成（python）。关于计算原理，请参考此处。当然您也可以不用花精力去看这些，直接看接下来的例子即可。这里的例子我们仅介绍通过电脑软件的生成方法，软件下载地址。
      </img>
     </img>
    </p>
    <p>
     下图为我使用token.exe电脑软件生成password的方法：
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/34284d15350b8ef7621b70e820822780.png"/>
    </p>
    <blockquote>
     <p>
      下面介绍各个参数的来源，products、devices、md5这三个词汇固定不变
     </p>
     <p>
      上图中的“353255”即是我们在创建产品时云平台自动赋予的产品ID。
      <br/>
      上图中的“TestDevice001”即是我们在前面创建设备时我们给设备起的具有唯一性的设备名称。
      <br/>
      上图中的“1893427200”表示将要生成的password的有效期，Unix时间戳，有效期截至为2030/1/1 0:0:0。
      <br/>
      上图中的“HNC7fq0yREOYs3uQoWREmZJjbwW8kiT6mxsDoh/dyW4=”即是我们在前面创建设备时云平台自动赋予设备的设备key。
      <br/>
      上图中的“version=2018-10-31&amp;res=products%2F353255%2Fdevices%2FTestDevice001&amp;et=1893427200&amp;method=md5&amp;sign=%2F5RJwGwytPWvVDB04K7rnw%3D%3D”
      <br/>
      即是生成结果（设备和服务端建立连接所需要的password）。
     </p>
    </blockquote>
    <p>
     <strong>
      PART 4（MQTT订阅、发布）
     </strong>
     <br/>
     订阅和发布路径：
    </p>
    <pre><code class="prism language-c"><span class="token operator">--</span>MQTT topic相关参数（适用于ONE NET平台）
mqtt_sub_topic <span class="token operator">=</span> <span class="token string">"$sys/353255/TestDevice001/cmd/request/+"</span><span class="token operator">--</span>订阅用
mqtt_pub_topic <span class="token operator">=</span> <span class="token string">"$sys/353255/TestDevice001/dp/post/json"</span> <span class="token operator">--</span>发布用
</code></pre>
    <p>
     mqtt_sub_topic是用来给设备订阅服务器的命令消息（比如控制LED等）
     <br/>
     mqtt_pub_topic是用来给设备向服务器发布消息（比如温湿度）
    </p>
    <p>
     这两个字符串的中包含的”353255“和“TestDevice001”分别是产品ID和设备名称，其他部分保持固定不变即可
    </p>
    <p>
     注意：这两个路径的结构由ONE NET云平台定义，其结构不可随意更改，如果感兴趣可以参考此处，设备命令Topic簇、数据点Topic簇。
     <br/>
     <strong>
      回复云平台下发的命令：
     </strong>
    </p>
    <pre><code>--根据收到的topic中的cmdid应答服务器，
--将收到的topic中"request"替换成"response"后作为应答topic发给服务器
topic = string.gsub(topic,"request","response")
--应答内容可自定义，这里为"Got it!"
LIB_MqttSendPub("QOS0", topic, "Got it!")
</code></pre>
    <p>
     ONE NET平台中的关于设备如何应答平台下发的cmd命令的格式已做了定义，可以参考设备命令Topic簇。
    </p>
    <p>
     下面举个例子来说明：
     <br/>
     如果服务器下发cmd的topic为：
     <span class="katex--inline">
      <span class="katex">
       <span class="katex-mathml">
        s 
        
       
         y 
        
       
         s 
        
       
         / 
        
       
         353255 
        
       
         / 
        
       
         T 
        
       
         e 
        
       
         s 
        
       
         t 
        
       
         D 
        
       
         e 
        
       
         v 
        
       
         i 
        
       
         c 
        
       
         e 
        
       
         001 
        
       
         / 
        
       
         c 
        
       
         m 
        
       
         d 
        
       
         / 
        
       
         r 
        
       
         e 
        
       
         q 
        
       
         u 
        
       
         e 
        
       
         s 
        
       
         t 
        
       
         / 
        
       
         33 
        
       
         f 
        
       
         f 
        
       
         e 
        
       
         a 
        
       
         0 
        
       
         a 
        
       
         − 
        
       
         e 
        
       
         5 
        
       
         f 
        
       
         1 
        
       
         − 
        
       
         49 
        
       
         d 
        
       
         6 
        
       
         − 
        
       
         a 
        
       
         626 
        
       
         − 
        
       
         f 
        
       
         f 
        
       
         e 
        
       
         e 
        
       
         1 
        
       
         b 
        
       
         b 
        
       
         d 
        
       
         93 
        
       
         e 
        
       
         f 
        
       
         那 
        
       
         么 
        
       
         我 
        
       
         们 
        
       
         应 
        
       
         答 
        
       
         的 
        
       
         t 
        
       
         o 
        
       
         p 
        
       
         i 
        
       
         c 
        
       
         应 
        
       
         该 
        
       
         为 
        
       
         ： 
        
       
      
        sys/353255/TestDevice001/cmd/request/33ffea0a-e5f1-49d6-a626-ffee1bbd93ef 那么我们应答的topic应该为：
       </span>
       <span class="katex-html">
        <span class="base">
         <span class="strut" style="height: 1em; vertical-align: -0.25em;">
         </span>
         <span class="mord mathdefault">
          s
         </span>
         <span class="mord mathdefault" style="margin-right: 0.03588em;">
          y
         </span>
         <span class="mord mathdefault">
          s
         </span>
         <span class="mord">
          /
         </span>
         <span class="mord">
          3
         </span>
         <span class="mord">
          5
         </span>
         <span class="mord">
          3
         </span>
         <span class="mord">
          2
         </span>
         <span class="mord">
          5
         </span>
         <span class="mord">
          5
         </span>
         <span class="mord">
          /
         </span>
         <span class="mord mathdefault" style="margin-right: 0.13889em;">
          T
         </span>
         <span class="mord mathdefault">
          e
         </span>
         <span class="mord mathdefault">
          s
         </span>
         <span class="mord mathdefault">
          t
         </span>
         <span class="mord mathdefault" style="margin-right: 0.02778em;">
          D
         </span>
         <span class="mord mathdefault">
          e
         </span>
         <span class="mord mathdefault" style="margin-right: 0.03588em;">
          v
         </span>
         <span class="mord mathdefault">
          i
         </span>
         <span class="mord mathdefault">
          c
         </span>
         <span class="mord mathdefault">
          e
         </span>
         <span class="mord">
          0
         </span>
         <span class="mord">
          0
         </span>
         <span class="mord">
          1
         </span>
         <span class="mord">
          /
         </span>
         <span class="mord mathdefault">
          c
         </span>
         <span class="mord mathdefault">
          m
         </span>
         <span class="mord mathdefault">
          d
         </span>
         <span class="mord">
          /
         </span>
         <span class="mord mathdefault" style="margin-right: 0.02778em;">
          r
         </span>
         <span class="mord mathdefault">
          e
         </span>
         <span class="mord mathdefault" style="margin-right: 0.03588em;">
          q
         </span>
         <span class="mord mathdefault">
          u
         </span>
         <span class="mord mathdefault">
          e
         </span>
         <span class="mord mathdefault">
          s
         </span>
         <span class="mord mathdefault">
          t
         </span>
         <span class="mord">
          /
         </span>
         <span class="mord">
          3
         </span>
         <span class="mord">
          3
         </span>
         <span class="mord mathdefault" style="margin-right: 0.10764em;">
          f
         </span>
         <span class="mord mathdefault" style="margin-right: 0.10764em;">
          f
         </span>
         <span class="mord mathdefault">
          e
         </span>
         <span class="mord mathdefault">
          a
         </span>
         <span class="mord">
          0
         </span>
         <span class="mord mathdefault">
          a
         </span>
         <span class="mspace" style="margin-right: 0.222222em;">
         </span>
         <span class="mbin">
          −
         </span>
         <span class="mspace" style="margin-right: 0.222222em;">
         </span>
        </span>
        <span class="base">
         <span class="strut" style="height: 0.88888em; vertical-align: -0.19444em;">
         </span>
         <span class="mord mathdefault">
          e
         </span>
         <span class="mord">
          5
         </span>
         <span class="mord mathdefault" style="margin-right: 0.10764em;">
          f
         </span>
         <span class="mord">
          1
         </span>
         <span class="mspace" style="margin-right: 0.222222em;">
         </span>
         <span class="mbin">
          −
         </span>
         <span class="mspace" style="margin-right: 0.222222em;">
         </span>
        </span>
        <span class="base">
         <span class="strut" style="height: 0.77777em; vertical-align: -0.08333em;">
         </span>
         <span class="mord">
          4
         </span>
         <span class="mord">
          9
         </span>
         <span class="mord mathdefault">
          d
         </span>
         <span class="mord">
          6
         </span>
         <span class="mspace" style="margin-right: 0.222222em;">
         </span>
         <span class="mbin">
          −
         </span>
         <span class="mspace" style="margin-right: 0.222222em;">
         </span>
        </span>
        <span class="base">
         <span class="strut" style="height: 0.72777em; vertical-align: -0.08333em;">
         </span>
         <span class="mord mathdefault">
          a
         </span>
         <span class="mord">
          6
         </span>
         <span class="mord">
          2
         </span>
         <span class="mord">
          6
         </span>
         <span class="mspace" style="margin-right: 0.222222em;">
         </span>
         <span class="mbin">
          −
         </span>
         <span class="mspace" style="margin-right: 0.222222em;">
         </span>
        </span>
        <span class="base">
         <span class="strut" style="height: 0.88888em; vertical-align: -0.19444em;">
         </span>
         <span class="mord mathdefault" style="margin-right: 0.10764em;">
          f
         </span>
         <span class="mord mathdefault" style="margin-right: 0.10764em;">
          f
         </span>
         <span class="mord mathdefault">
          e
         </span>
         <span class="mord mathdefault">
          e
         </span>
         <span class="mord">
          1
         </span>
         <span class="mord mathdefault">
          b
         </span>
         <span class="mord mathdefault">
          b
         </span>
         <span class="mord mathdefault">
          d
         </span>
         <span class="mord">
          9
         </span>
         <span class="mord">
          3
         </span>
         <span class="mord mathdefault">
          e
         </span>
         <span class="mord mathdefault" style="margin-right: 0.10764em;">
          f
         </span>
         <span class="mord cjk_fallback">
          那
         </span>
         <span class="mord cjk_fallback">
          么
         </span>
         <span class="mord cjk_fallback">
          我
         </span>
         <span class="mord cjk_fallback">
          们
         </span>
         <span class="mord cjk_fallback">
          应
         </span>
         <span class="mord cjk_fallback">
          答
         </span>
         <span class="mord cjk_fallback">
          的
         </span>
         <span class="mord mathdefault">
          t
         </span>
         <span class="mord mathdefault">
          o
         </span>
         <span class="mord mathdefault">
          p
         </span>
         <span class="mord mathdefault">
          i
         </span>
         <span class="mord mathdefault">
          c
         </span>
         <span class="mord cjk_fallback">
          应
         </span>
         <span class="mord cjk_fallback">
          该
         </span>
         <span class="mord cjk_fallback">
          为
         </span>
         <span class="mord cjk_fallback">
          ：
         </span>
        </span>
       </span>
      </span>
     </span>
     sys/353255/TestDevice001/cmd/response/33ffea0a-e5f1-49d6-a626-ffee1bbd93ef
    </p>
    <p>
     云平台会自动为每条下发的cmd分配一个cmd id， 例子中的33ffea0a-e5f1-49d6-a626-ffee1bbd93ef即为cmdid。
     <br/>
     <strong>
      向云平台发布本地温湿度数
     </strong>
    </p>
    <pre><code class="prism language-c"><span class="token operator">--</span>每<span class="token number">9</span>秒发送温湿度度数据给server
<span class="token keyword">if</span> cnt_10ms <span class="token operator">&gt;=</span> <span class="token number">900</span> then
    cnt_10ms <span class="token operator">=</span> <span class="token number">0</span>
    pub_id <span class="token operator">=</span> pub_id <span class="token operator">+</span> <span class="token number">1</span>
    json_str <span class="token operator">=</span> string<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"{\"id\":%d, \"dp\":{\"temperatrue\":[{\"v\": %.2f,}], \"humidity\":[{\"v\":%.2f,}]}}"</span><span class="token punctuation">,</span> pub_id<span class="token punctuation">,</span> temprature<span class="token punctuation">,</span> humidity<span class="token punctuation">)</span>
    <span class="token operator">--</span>注意json_str的总长度不要超过<span class="token number">250</span>字节
    <span class="token function">LIB_MqttSendPub</span><span class="token punctuation">(</span><span class="token string">"QOS0"</span><span class="token punctuation">,</span> mqtt_pub_topic<span class="token punctuation">,</span> json_str<span class="token punctuation">)</span> <span class="token operator">--</span>publish
end
</code></pre>
    <p>
     每9秒向云平台pulish一次本地的温湿度数据，数据内容必须是json格式，
     <br/>
     例如：{“id”:1, “dp”:{“temperatrue”:[{“v”: 32.50,}], “humidity”:[{“v”:56.00,}]}}
     <br/>
     pub_id为pulish消息的标识符，每次发送时需递增加1
     <br/>
     <strong>
      PART 5（其他）
     </strong>
     <br/>
     其他部分代码已有详细注释，这里就不赘述了。
    </p>
    <h3>
     <a id="_212">
     </a>
     五、代码实验现象
    </h3>
    <p>
     <strong>
      STEP 1: 硬件准备工作
     </strong>
     <br/>
     按照上面的接线方式将CORE和ESP8266无线模块、SHT30传感器连接就位，然后将上面的完整代码拷贝入Core的TF卡中的main.lua文件，完成Core的代码更新。
     <br/>
     <strong>
      STEP 2: 在开发者控制台中找到设备
     </strong>
     <br/>
     从ONE NET开发者控制台界面中进入对应的产品 ，然后在产品界面中鼠标点击进入“设备列表” 后可以看到我们刚刚创建的一个设备硬件实例“TestDevice001”，如下图：
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/e22ccaff079f3bc503dd3f32208c248e.png">
      <br/>
      <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/daacc0ee0fb532484d4164e5d1fefb7f.png">
       <br/>
       STEP 3 查看设备的温湿度数据:
       <br/>
       <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/411af0dcfcf357a5ae8c8e742512704c.png"/>
       <br/>
       <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/8c8b4e330652adc9382d26ce89722464.png"/>
       <br/>
       STEP 4 从云平台下发cmd指令控制CORE上的LED2灯的亮灭:
      </img>
     </img>
    </p>
    <p>
     Ⅰ 鼠标点击进入在对应的设备的“更多操作”中的“下发命令” --&gt;
    </p>
    <p>
     Ⅱ 然后在弹出的界面中的命令内容中输入“{“LED”:2}”，超时时间5秒，返回结果中选择String格式
    </p>
    <p>
     Ⅲ 最后点击发送，待设备成功收到命令并返回正确的应答后（应答消息中包含“Got it”），我们就可以看到Core电路板上的LED2灯珠由亮变灭或者由灭变亮了。
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/ab628db4fdd3199efe32a086e476a4b5.png"/>
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/7c76a3de52d0e8280b373280c0f27ef5.png"/>
     <br/>
     <strong>
      更多详情请参看 shineblink.com
      <a href="http://www.shineblink.com" rel="nofollow">
       官网链接
      </a>
     </strong>
    </p>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a:2f2f626c6f672e6373646e2e6e65742f75636f735f6871752f:61727469636c652f64657461696c732f313234343933313038" class_="artid" style="display:none">
 </p>
</div>


