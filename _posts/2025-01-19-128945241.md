---
layout: post
title: "使用dperf测试dpvs性能"
date: 2025-01-19 09:51:06 +0800
description: "文章介绍了如何使用dperf这款基于DPDK的高性能网络压测工具来测试DPVS的性能，包括单向和双向"
keywords: "dperf"
categories: ['']
tags: ['Tcp']
artid: "128945241"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=128945241
    alt: "使用dperf测试dpvs性能"
render_with_liquid: false
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     使用dperf测试dpvs性能
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-light" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <h2>
     <a id="dperf_0">
     </a>
     为什么选择dperf
    </h2>
    <p>
     <a href="https://github.com/iqiyi/dpvs">
      dpvs
     </a>
     是一个基于dpdk实现的高性能四层负载均衡，最近在学习怎么测试四层lb各种性能指标。简单罗列了下dpvs需要关注的性能指标：
    </p>
    <table>
     <thead>
      <tr>
       <th>
        指标
       </th>
       <th>
        说明
       </th>
      </tr>
     </thead>
     <tbody>
      <tr>
       <td>
        单向pps
       </td>
       <td>
        指入向每秒可以处理的数据包个数极限值，测试单向pps性能一般使用udp小包（因为udp是无状态的，比较简单），当dpvs出现imiss的时候则达到极限值
       </td>
      </tr>
      <tr>
       <td>
        双向pps
       </td>
       <td>
        即入向+出向pps极限值，需要在rs上部署udp server
       </td>
      </tr>
      <tr>
       <td>
        bps
       </td>
       <td>
        指dpvs每秒可以处理的数据包长度的极限值，一半可以使用udp大包来测试
       </td>
      </tr>
      <tr>
       <td>
        cps
       </td>
       <td>
        指每秒新建连接的极限值，新建连接一般是指tcp三次握手后处于的establish状态
       </td>
      </tr>
      <tr>
       <td>
        cc
       </td>
       <td>
        最大并发连接数
       </td>
      </tr>
      <tr>
       <td>
        大象流
       </td>
       <td>
        单条流即单核最大bps/pps
       </td>
      </tr>
     </tbody>
    </table>
    <p>
     用测试仪其实很容易测到以上指标，但是一是测试仪比较昂贵，二是需要直连测试仪到测试环境，没有这些条件，只能使用其他性能测试工具。目前比较常用且简单的测试工具有两个：pktgen和wrk。
    </p>
    <ul>
     <li>
      pktgen是一个基于linux内核的发包工具，它有一个升级版pktgen-dpdk，可以单机达到更高pps的压力，不过对于dpvs来说pktgen就足够了，一台mlx 25G网卡的客户端可以轻松发送16M的pps。pktgen可以调整发送udp包的大小，适用于测试单向pps、bps。pktgen还可以控制源端口的范围和目的端口的范围，也适用于测试cc和大象流。
     </li>
     <li>
      wrk是一个七层的qps性能测试工具，对于短链接来说，我们可以近似的把qps看作cps，所以可以使用wrk来测试cps。
     </li>
    </ul>
    <p>
     上述两个工具很简单好用，但也有一些不足，比如pktgen没法测试双向pps，要测试双向pps，需要在rs上部署高性能的udp_server；wrk性能不够，一般只能测试1核或者2核的dpvs性能。。。
     <br/>
     <a href="https://github.com/baidu/dperf/blob/main/README-CN.md">
      dperf
     </a>
     是一个基于dpdk的高性能网络压测工具。dperf可用作client，也可用作server，所以可以测试双向pps；dperf的性能表现也比wrk强太多，所以我希望dperf可以解决上述工具的问题，并且可以独自测试dpvs所有的性能指标。
    </p>
    <h2>
     <a id="dperf_17">
     </a>
     部署dperf
    </h2>
    <ol>
     <li>
      编译dpdk
      <br/>
      由于dperf是基于dpdk的，所以首先要编译dpdk。编译dpdk又需要安装网卡驱动、配置大页内存等操作，可以参考我的以下操作：
     </li>
    </ol>
    <pre><code class="prism language-bash"><span class="token comment"># 由于我是mlx网卡，所以需要安装官方的ofed网卡驱动，需要注意的是cx6网卡需要安装ofed 5.4版本，</span>
<span class="token comment"># 可以登陆这个页面自行下载安装包https://www.mellanox.com/page/mlnx_ofed_eula?mtag=linux_sw_drivers&amp;mrequest=downloads&amp;mtype=ofed&amp;mver=MLNX_OFED-5.4-3.0.3.0&amp;mname=MLNX_OFED_LINUX-5.4-3.0.3.0-debian9.13-x86_64.tgz</span>
<span class="token comment"># 解压，安装ofed</span>
<span class="token function">tar</span> xvf MLNX_OFED_LINUX-5.0-2.1.8.0-debian9.11-x86_64.tgz
<span class="token builtin class-name">cd</span> MLNX_OFED_LINUX-5.0-2.1.8.0-debian9.11-x86_64/
./uninstall.sh <span class="token parameter variable">--force</span>
./mlnxofedinstall <span class="token parameter variable">--dpdk</span> --upstream-libs --skip-distro-check --add-kernel-support

<span class="token comment"># 配置大页内存</span>
<span class="token comment"># 修改grub文件</span>
<span class="token function">vim</span> /etc/default/grub
<span class="token assign-left variable">GRUB_CMDLINE_LINUX_DEFAULT</span><span class="token operator">=</span><span class="token string">"quiet default_hugepagesz=1G hugepagesz=1G hugepages=49 iommu=pt intel_iommu=on"</span>
<span class="token comment"># 生成启动脚本</span>
<span class="token function">update-grub</span>
<span class="token comment"># 重启机器</span>
<span class="token function">reboot</span> <span class="token parameter variable">-f</span>

<span class="token comment"># 下载dpdk-19.11.10安装包</span>
<span class="token comment"># 解压后，修改config/common_base，打开编译开关：CONFIG_RTE_LIBRTE_MLX5_PMD=y</span>
<span class="token comment"># X86_64环境下编译：</span>
<span class="token function">make</span> <span class="token function">install</span> <span class="token assign-left variable">T</span><span class="token operator">=</span>x86_64-native-linuxapp-gcc <span class="token parameter variable">-j16</span>

<span class="token comment"># 如需使用kni的话，加载kni：</span>
insmod x86_64-native-linuxapp-gcc/kmod/rte_kni.ko
</code></pre>
    <ol start="2">
     <li>
      编译dperf
     </li>
    </ol>
    <pre><code class="prism language-bash"><span class="token function">git</span> clone https://github.com/baidu/dperf
<span class="token builtin class-name">cd</span> /root/dperf
<span class="token function">make</span> <span class="token parameter variable">-j8</span> <span class="token assign-left variable">RTE_SDK</span><span class="token operator">=</span>/root/dpdk-stable-19.11.10 <span class="token assign-left variable">RTE_TARGET</span><span class="token operator">=</span>x86_64-native-linuxapp-gcc
</code></pre>
    <p>
     之后就可以执行./build/dperf -c test/http/server-cps.conf来启动dperf server，在客户端上修改test/http/client-cps.conf中的配置后，执行./build/dperf -c test/http/client-cps.conf即可启动dperf client，就可以进行cps压测了，具体配置详情请见：https://github.com/baidu/dperf/blob/main/docs/configuration-CN.md
    </p>
    <h2>
     <a id="pps_56">
     </a>
     测试单向pps
    </h2>
    <p>
     单向pps只需要起一个udp client，配置如下：
    </p>
    <pre><code class="prism language-bash">mode        client
cpu         <span class="token number">0</span>-15
duration    600s
cps         50k
cc          500k
rss         l3l4
flood
protocol    udp
packet_size <span class="token number">64</span>
keepalive   100ms
port        0000:aa:00.0    <span class="token number">10.10</span>.10.10   <span class="token number">10.10</span>.10.1
client      <span class="token number">10.10</span>.10.10     <span class="token number">1</span>
server      <span class="token number">10.10</span>.10.11      <span class="token number">1</span>
listen      <span class="token number">8050</span>              <span class="token number">50</span>
lport_range <span class="token number">1000</span> <span class="token number">65535</span>
kni
</code></pre>
    <p>
     pps的数量等于并发数除以keepalive的值，所以上述配置的pps可以达到5M。相对于pktgen来说，dperf并发数启动较慢，即使配置一个较大的cps值如500k，等待数秒之后才可以达到50w并发；pktgen基本可以瞬间达到50w并发。但是dperf有一个很大的优势就是可以较为精确的发出的pps值，用做自动化测试调参会比较方便。
    </p>
    <h2>
     <a id="pps_78">
     </a>
     测试双向pps
    </h2>
    <p>
     双向pps需要起两个dperf，一个作为udp client，一个作为udp server，配置如下：
    </p>
    <pre><code class="prism language-bash"><span class="token comment"># client</span>
mode        client
cpu         <span class="token number">0</span>-15
duration    600s
cps         50k
cc          500k
rss         l3l4
flood
protocol    udp
packet_size <span class="token number">64</span>
keepalive   100ms
port        0000:aa:00.0    <span class="token number">10.10</span>.10.10   <span class="token number">10.10</span>.10.1
client      <span class="token number">10.10</span>.10.10     <span class="token number">1</span>
server      <span class="token number">10.10</span>.10.11      <span class="token number">1</span>
listen      <span class="token number">8050</span>              <span class="token number">50</span>
lport_range <span class="token number">1000</span> <span class="token number">65535</span>
kni

<span class="token comment"># server</span>
mode            server
protocol        udp

keepalive       100ms
payload_size    <span class="token number">64</span>

cpu             <span class="token number">0</span>-15
rss             l3l4

duration    100m
port        0000:aa:00.0    <span class="token number">10.10</span>.10.11   <span class="token number">10.10</span>.10.1
client      <span class="token number">10.10</span>.10.10       <span class="token number">1</span>
server      <span class="token number">10.10</span>.10.11      <span class="token number">1</span>
listen          <span class="token number">8050</span>              <span class="token number">50</span>
kni
</code></pre>
    <p>
     上述配置可以达到入向5M+出向5M pps流量。
    </p>
    <h2>
     <a id="bps_118">
     </a>
     测试bps
    </h2>
    <p>
     测试bps用udp client发入向的udp大包即可，配置如下：
    </p>
    <pre><code class="prism language-bash">mode        client
cpu         <span class="token number">0</span>-15
duration    600s
cps         50k
cc          500k
rss         l3l4
flood
protocol    udp
packet_size <span class="token number">500</span>
keepalive   100ms
port        0000:aa:00.0    <span class="token number">10.10</span>.10.10   <span class="token number">10.10</span>.10.1
client      <span class="token number">10.10</span>.10.10     <span class="token number">1</span>
server      <span class="token number">10.10</span>.10.11      <span class="token number">1</span>
listen      <span class="token number">8050</span>              <span class="token number">50</span>
lport_range <span class="token number">1000</span> <span class="token number">65535</span>
kni

</code></pre>
    <p>
     这个和单向pps配置一样，只有包长不一样，通过包长和pps可以算出带宽，上述配置大概是20G左右
    </p>
    <h2>
     <a id="cps_141">
     </a>
     测试cps
    </h2>
    <p>
     dperf新建非常快，比dpvs释放连接的速度快很多，所以必须要配置非常多的四元组，才可以保证客户端的新建连接与dpvs上的cps一致。
     <br/>
     需要注意的是dperf显示的skOpen并不是dpvs真实的cps，建议把dpvs的timeout先调小，然后使用以下命令监控dpvs上的cps。ipvsadm --stats只统计dpvs的新建连接，不会统计复用的连接。
    </p>
    <pre><code class="prism language-bash"><span class="token shebang important">#!/bin/bash</span>
<span class="token keyword">while</span> <span class="token boolean">true</span>
<span class="token keyword">do</span>
	<span class="token assign-left variable">pre</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>/bin/ipvsadm <span class="token parameter variable">-ln</span> <span class="token parameter variable">--stats</span> <span class="token operator">|</span> <span class="token function">grep</span> <span class="token parameter variable">-E</span> <span class="token string">'UDP|TCP'</span> <span class="token operator">|</span> <span class="token function">awk</span> <span class="token string">'{sum += $3};END {print sum}'</span><span class="token variable">)</span></span>
	<span class="token function">sleep</span> <span class="token number">1</span>
	<span class="token assign-left variable">post</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>/bin/ipvsadm <span class="token parameter variable">-ln</span> <span class="token parameter variable">--stats</span> <span class="token operator">|</span> <span class="token function">grep</span> <span class="token parameter variable">-E</span> <span class="token string">'UDP|TCP'</span> <span class="token operator">|</span> <span class="token function">awk</span> <span class="token string">'{sum += $3};END {print sum}'</span><span class="token variable">)</span></span>
	<span class="token assign-left variable">res</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$((</span>${post}<span class="token operator">-</span>${pre}<span class="token variable">))</span></span>
	<span class="token builtin class-name">echo</span> <span class="token variable">${res}</span>
<span class="token keyword">done</span>
</code></pre>
    <p>
     dperf配置参考如下：
    </p>
    <pre><code class="prism language-bash">mode        client
cpu         <span class="token number">0</span>-15
duration    600s
cps         100k
rss         l3l4
protocol    tcp
port        0000:aa:00.0    <span class="token number">10.10</span>.10.10   <span class="token number">10.10</span>.10.1
client      <span class="token number">10.10</span>.10.10     <span class="token number">1</span>
server      <span class="token number">10.10</span>.10.11      <span class="token number">1</span>
listen      <span class="token number">8000</span>             <span class="token number">99</span>
lport_range <span class="token number">1000</span> <span class="token number">65535</span>
kni
</code></pre>
    <p>
     如果只有一个server ip，listen监听端口一定要配多一点。
    </p>
    <h2>
     <a id="cc_174">
     </a>
     测试cc
    </h2>
    <p>
     dperf测试cc非常方便，配置足够多的四元组即可。
    </p>
    <pre><code class="prism language-bash">mode        client
cpu         <span class="token number">0</span>-15
duration    600s
cps         500k
cc          5m
rss         l3l4
flood
protocol    udp
packet_size <span class="token number">64</span>
keepalive   1s
port        0000:aa:00.0    <span class="token number">10.10</span>.10.10   <span class="token number">10.10</span>.10.1
client      <span class="token number">10.10</span>.10.10     <span class="token number">1</span>
server      <span class="token number">10.10</span>.10.11      <span class="token number">1</span>
listen      <span class="token number">8000</span>              <span class="token number">99</span>
lport_range <span class="token number">1000</span> <span class="token number">65535</span>
kni
</code></pre>
    <p>
     上述配置可以轻松达到5m的并发数。
    </p>
    <h2>
     <a id="_196">
     </a>
     测试大象流
    </h2>
    <p>
     由于dperf配置中的keepalive最少只能配置10us，也就是单条流最大pps只有100k，而dpvs单核的pps性能约等于1M，所以pps大象流用dperf是无法达到极限值的；通过调大packet_size包长，最大是1500字节，所以单流bps最大1.2Gb，也没有办法达到dpvs的单核bps极限值，所以dperf无法测试dpvs的大象流场景，配置参考如下：
    </p>
    <pre><code class="prism language-bash">mode        client
cpu         <span class="token number">0</span>-15
duration    600s
cps         <span class="token number">1</span>
cc          <span class="token number">1</span>
rss         l3l4
flood
protocol    udp
packet_size <span class="token number">1500</span>
keepalive   100ms
port        0000:aa:00.0    <span class="token number">10.10</span>.10.10   <span class="token number">10.10</span>.10.1
client      <span class="token number">10.10</span>.10.10     <span class="token number">1</span>
server      <span class="token number">10.10</span>.10.11      <span class="token number">1</span>
listen      <span class="token number">8050</span>              <span class="token number">1</span>
lport_range <span class="token number">1000</span> <span class="token number">65535</span>
kni
</code></pre>
    <h2>
     <a id="_217">
     </a>
     结论
    </h2>
    <p>
     总而言之，dperf是一个非常好用的软件性能测试工具，可以很方便的测试出了大象流以外的其他场景，部署简单，配置简单，同时可以用做高性能的client和server。也希望dperf后续能开发出更多的功能，适用更多的性能测试场景。
    </p>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="6874747073:3a2f2f626c6f672e6373646e2e6e65742f79757562656b612f:61727469636c652f64657461696c732f313238393435323431" class_="artid" style="display:none">
 </p>
</div>


