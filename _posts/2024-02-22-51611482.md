---
layout: post
title: "Android版本更新时对SQLite数据库升级或者降级遇到的问题"
date: 2024-02-22 16:26:06 +0800
description: "SQLite是Android内置的一个很小的关系型数据库。SQLiteOpenHelper是一个用来"
keywords: "android 先安装高版本数据库,再安装低版本数据库崩溃"
categories: ['开发中常见问题大杂烩', 'Android', 'Android']
tags: ['数据库', '存储', 'Sqlite', 'App']
artid: "51611482"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=51611482
    alt: "Android版本更新时对SQLite数据库升级或者降级遇到的问题"
render_with_liquid: false
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     Android版本更新时对SQLite数据库升级或者降级遇到的问题
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="htmledit_views" id="content_views">
    <p style="margin-top:15px; margin-bottom:0px; padding-top:0px; padding-bottom:0px; text-indent:2em; color:rgb(68,68,68); font-family:'Helvetica Neue',Helvetica,Arial,sans-serif; font-size:14px; line-height:20.16px; text-align:justify; background-color:rgb(253,253,253)">
     SQLite是
     <a class="replace_word" href="http://lib.csdn.net/base/15" rel="nofollow noopener noreferrer" style="color:#df3434; font-weight:bold" target="_blank" title="Android知识库">
      Android
     </a>
     内置的一个很小的关系型
     <a class="replace_word" href="http://lib.csdn.net/base/14" rel="nofollow noopener noreferrer" style="color:#df3434; font-weight:bold" target="_blank" title="MySQL知识库">
      数据库
     </a>
     。SQLiteOpenHelper是一个用来辅助管理数据库创建和版本升级问题的抽象类。我们可以继承这个抽象类，实现它的一些方法来对数据库进行自定义操作。下面两个方法必须重写：
    </p>
    <ul style="margin:15px 0px 0px 20px; padding:0px; color:rgb(68,68,68); font-family:'Helvetica Neue',Helvetica,Arial,sans-serif; font-size:14px; line-height:20.16px; text-align:justify; background-color:rgb(253,253,253)">
     <li style="margin:0px; padding:0px">
      public void onCreate(SQLiteDatabase db)
     </li>
     <li style="margin:0px; padding:0px">
      public void onUpgrade(SQLiteDatabase db, int oldVersion, int newVersion)
     </li>
    </ul>
    <p style="margin-top:15px; margin-bottom:0px; padding-top:0px; padding-bottom:0px; text-indent:2em; color:rgb(68,68,68); font-family:'Helvetica Neue',Helvetica,Arial,sans-serif; font-size:14px; line-height:20.16px; text-align:justify; background-color:rgb(253,253,253)">
     另外SQLiteOpenHelper子类在构造实例时必须指定当前数据库的名称（name）、版本号（version）。而这里名称就决定了数据库存储时的文件名称，而这里的版本号与App在AndroidMainfest.xml定义的versionCode没有绝对关联。也就是在App更新时如果数据库的
     <a class="replace_word" href="http://lib.csdn.net/base/31" rel="nofollow noopener noreferrer" style="color:#df3434; font-weight:bold" target="_blank" title="算法与数据结构知识库">
      数据结构
     </a>
     没有发生变化那么数据库的版本号则不用增加。
    </p>
    <p style="margin-top:15px; margin-bottom:0px; padding-top:0px; padding-bottom:0px; text-indent:2em; color:rgb(68,68,68); font-family:'Helvetica Neue',Helvetica,Arial,sans-serif; font-size:14px; line-height:20.16px; text-align:justify; background-color:rgb(253,253,253)">
     onCreate：调用时机是用户首次安装应用后启动，或是清除App数据库文件后启动。这时可以在这个函数中完成初始的数据表的创建。
    </p>
    <p style="margin-top:15px; margin-bottom:0px; padding-top:0px; padding-bottom:0px; text-indent:2em; color:rgb(68,68,68); font-family:'Helvetica Neue',Helvetica,Arial,sans-serif; font-size:14px; line-height:20.16px; text-align:justify; background-color:rgb(253,253,253)">
     onUpgrade：调用时机是用户在做应用更新，覆盖安装后启动，如果新版本中数据库版本号要比旧版本中的数据库版本号高则会调用。这时可以在这个函数完成数据库版本升级带来的旧版本的兼容问题，以及数据迁移问题。
    </p>
    <span style="font-family:'Helvetica Neue',Helvetica,Arial,sans-serif; font-size:14px; color:#444444; line-height:20.16px; text-align:justify; background-color:rgb(253,253,253)">
    </span>
    <p style="margin-top:15px; margin-bottom:0px; padding-top:0px; padding-bottom:0px; text-indent:2em; color:rgb(68,68,68); font-family:'Helvetica Neue',Helvetica,Arial,sans-serif; font-size:14px; line-height:20.16px; text-align:justify; background-color:rgb(253,253,253)">
     还有一个一般情况下不需要重写，但在应用出现逆向降级（如应用由版本号4降级安装版本号为3的包）时必须重写的方法
     <span style="margin:0px; padding:0px">
      onDowngrade
     </span>
     ，如果应用降级覆盖安装时没有重写该方法则会崩溃。
    </p>
    <p style="margin-top:15px; margin-bottom:0px; padding-top:0px; padding-bottom:0px; text-indent:2em; color:rgb(68,68,68); font-family:'Helvetica Neue',Helvetica,Arial,sans-serif; font-size:14px; line-height:20.16px; text-align:justify; background-color:rgb(253,253,253)">
     在数据库版本升级时， 我们可能会遇到这样一些情况：
    </p>
    <ul style="margin:15px 0px 0px 20px; padding:0px; color:rgb(68,68,68); font-family:'Helvetica Neue',Helvetica,Arial,sans-serif; font-size:14px; line-height:20.16px; text-align:justify; background-color:rgb(253,253,253)">
     <li style="margin:0px; padding:0px">
      需要扩展一个表的字段
     </li>
     <li style="margin:0px; padding:0px">
      删除掉原来表上某个冗余的字段
     </li>
     <li style="margin:0px; padding:0px">
      新建一个表
     </li>
    </ul>
    <p style="margin-top:15px; margin-bottom:0px; padding-top:0px; padding-bottom:0px; text-indent:2em; color:rgb(68,68,68); font-family:'Helvetica Neue',Helvetica,Arial,sans-serif; font-size:14px; line-height:20.16px; text-align:justify; background-color:rgb(253,253,253)">
     而处理上面这些问题都要在不损害旧数据库历史数据的前提下完成。这里我们假设用户手机上之前安装的是数据库版本为1的包，升级安装的是数据库版本号为2的包。这时我们要在数据库版本为2的包在去处理这些升级逻辑。
    </p>
    <p style="margin-top:15px; margin-bottom:0px; padding-top:0px; padding-bottom:0px; text-indent:2em; color:rgb(68,68,68); font-family:'Helvetica Neue',Helvetica,Arial,sans-serif; font-size:14px; line-height:20.16px; text-align:justify; background-color:rgb(253,253,253)">
     首先是扩展一个表的字段在onUpgrade中的实现为：
    </p>
    <p style="margin-top:15px; margin-bottom:0px; padding-top:0px; padding-bottom:0px; text-indent:2em; color:rgb(68,68,68); font-family:'Helvetica Neue',Helvetica,Arial,sans-serif; font-size:14px; line-height:20.16px; text-align:justify; background-color:rgb(253,253,253)">
    </p>
    <div class="dp-highlighter bg_java">
     <div class="bar">
      <div class="tools">
       <strong>
        [java]
       </strong>
       <a class="ViewSource" href="http://blog.csdn.net/jie1991liu/article/details/50339797#" rel="noopener noreferrer" target="_blank" title="view plain">
        view plain
       </a>
       <a class="CopyToClipboard" href="http://blog.csdn.net/jie1991liu/article/details/50339797#" rel="noopener noreferrer" target="_blank" title="copy">
        copy
       </a>
      </div>
     </div>
     <ol class="dp-j" start="1">
      <li class="alt">
       <span class="annotation">
        @Override
       </span>
      </li>
      <li>
       <span class="keyword">
        public
       </span>
       <span class="keyword">
        void
       </span>
       onUpgrade(SQLiteDatabase db,
       <span class="keyword">
        int
       </span>
       oldVersion,
       <span class="keyword">
        int
       </span>
       newVersion) {
      </li>
      <li class="alt">
       <span class="comment">
        //旧数据库版本为1，才为表pedant添加一个student_name字段
       </span>
      </li>
      <li>
       <span class="keyword">
        if
       </span>
       (oldVersion &lt;
       <span class="number">
        2
       </span>
       ) {
      </li>
      <li class="alt">
       db.execSQL(
       <span class="string">
        "ALTER TABLE pedant ADD COLUMN student_name text"
       </span>
       );
      </li>
      <li>
       }
      </li>
      <li class="alt">
       }
      </li>
     </ol>
    </div>
    <p style="margin-top:15px; margin-bottom:0px; padding-top:0px; padding-bottom:0px; text-indent:2em; color:rgb(68,68,68); font-family:'Helvetica Neue',Helvetica,Arial,sans-serif; font-size:14px; line-height:20.16px; text-align:justify; background-color:rgb(253,253,253)">
     SQLite对ALTER TABLE的支持是有限的，你可以在一个存在表上添加一个字段到末尾，或者是改变表的名称。但如果你想做更复杂的操作，比如删除一个表已有的字段，就要重新创建这个表并完成数据迁移，而不能使用
     <span style="margin:0px; padding:0px">
      DROP COLUMN
     </span>
     这样方便的命令了。详见
     <a href="http://www.sqlite.org/faq.html#q11" rel="external noopener noreferrer" style="margin:0px; padding:0px; text-decoration:none; color:rgb(37,166,184)" target="_blank">
      SQLite Frequently Questions
     </a>
    </p>
    <p style="margin-top:15px; margin-bottom:0px; padding-top:0px; padding-bottom:0px; text-indent:2em; color:rgb(68,68,68); font-family:'Helvetica Neue',Helvetica,Arial,sans-serif; font-size:14px; line-height:20.16px; text-align:justify; background-color:rgb(253,253,253)">
     比如表pedant原来有三个字段a、b、c，现在想删除c字段，那么在onUpgrade中写法如下：
    </p>
    <div class="dp-highlighter bg_java">
     <div class="bar">
      <div class="tools">
       <strong>
        [java]
       </strong>
       <a class="ViewSource" href="http://blog.csdn.net/jie1991liu/article/details/50339797#" rel="noopener noreferrer" target="_blank" title="view plain">
        view plain
       </a>
       <a class="CopyToClipboard" href="http://blog.csdn.net/jie1991liu/article/details/50339797#" rel="noopener noreferrer" target="_blank" title="copy">
        copy
       </a>
      </div>
     </div>
     <ol class="dp-j" start="1">
      <li class="alt">
       <span class="annotation">
        @Override
       </span>
      </li>
      <li>
       <span class="keyword">
        public
       </span>
       <span class="keyword">
        void
       </span>
       onUpgrade(SQLiteDatabase db,
       <span class="keyword">
        int
       </span>
       oldVersion,
       <span class="keyword">
        int
       </span>
       newVersion) {
      </li>
      <li class="alt">
       <span class="comment">
        //旧数据库版本为1，删除表pedant的c字段
       </span>
      </li>
      <li>
       <span class="keyword">
        if
       </span>
       (oldVersion &lt;
       <span class="number">
        2
       </span>
       ) {
      </li>
      <li class="alt">
       db.beginTransaction();
      </li>
      <li>
       <span class="keyword">
        try
       </span>
       {
      </li>
      <li class="alt">
       db.execSQL(
       <span class="string">
        "CREATE TEMPORARY TABLE pe_backup (a, b);"
       </span>
       );
      </li>
      <li>
       db.execSQL(
       <span class="string">
        "INSERT INTO pe_backup SELECT a, b FROM pedant;"
       </span>
       );
      </li>
      <li class="alt">
       db.execSQL(
       <span class="string">
        "DROP TABLE pedant;"
       </span>
       );
      </li>
      <li>
       db.execSQL(
       <span class="string">
        "CREATE TABLE pedant(a text, b text);"
       </span>
       );
      </li>
      <li class="alt">
       db.execSQL(
       <span class="string">
        "INSERT INTO pedant SELECT a, b FROM pe_backup;"
       </span>
       );
      </li>
      <li>
       db.execSQL(
       <span class="string">
        "DROP TABLE pe_backup;"
       </span>
       );
      </li>
      <li class="alt">
       db.setTransactionSuccessful();
      </li>
      <li>
       }
       <span class="keyword">
        finally
       </span>
       {
      </li>
      <li class="alt">
       db.endTransaction();
      </li>
      <li>
       }
      </li>
      <li class="alt">
       }
      </li>
      <li>
       }
      </li>
     </ol>
    </div>
    <p style="margin-top:15px; margin-bottom:0px; padding-top:0px; padding-bottom:0px; text-indent:2em; color:rgb(68,68,68); font-family:'Helvetica Neue',Helvetica,Arial,sans-serif; font-size:14px; line-height:20.16px; text-align:justify; background-color:rgb(253,253,253)">
     这样就既完成了对c字段的删除也保留了原来表上的数据。
    </p>
    <p style="margin-top:15px; margin-bottom:0px; padding-top:0px; padding-bottom:0px; text-indent:2em; color:rgb(68,68,68); font-family:'Helvetica Neue',Helvetica,Arial,sans-serif; font-size:14px; line-height:20.16px; text-align:justify; background-color:rgb(253,253,253)">
     最后一种情况最简单直接执行CREATE语句就要可以了。
    </p>
    <div class="dp-highlighter bg_java">
     <div class="bar">
      <div class="tools">
       <strong>
        [java]
       </strong>
       <a class="ViewSource" href="http://blog.csdn.net/jie1991liu/article/details/50339797#" rel="noopener noreferrer" target="_blank" title="view plain">
        view plain
       </a>
       <a class="CopyToClipboard" href="http://blog.csdn.net/jie1991liu/article/details/50339797#" rel="noopener noreferrer" target="_blank" title="copy">
        copy
       </a>
      </div>
     </div>
     <ol class="dp-j" start="1">
      <li class="alt">
       <span class="annotation">
        @Override
       </span>
      </li>
      <li>
       <span class="keyword">
        public
       </span>
       <span class="keyword">
        void
       </span>
       onUpgrade(SQLiteDatabase db,
       <span class="keyword">
        int
       </span>
       oldVersion,
       <span class="keyword">
        int
       </span>
       newVersion) {
      </li>
      <li class="alt">
       <span class="comment">
        //旧数据库版本为1，创建新表newtb
       </span>
      </li>
      <li>
       <span class="keyword">
        if
       </span>
       (oldVersion &lt;
       <span class="number">
        2
       </span>
       ) {
      </li>
      <li class="alt">
       db.execSQL(
       <span class="string">
        "CREATE TABLE newtb(a text, b text);"
       </span>
       );
      </li>
      <li>
       }
      </li>
      <li class="alt">
       }
      </li>
     </ol>
    </div>
    <span style="font-family:'Helvetica Neue',Helvetica,Arial,sans-serif; font-size:14px; color:#444444; line-height:20.16px; text-align:justify; text-indent:28px; background-color:rgb(253,253,253)">
     数据库在做升级时我们能明确地知道当前我们要对各旧表进行什么样的操作来兼容新版本。但如果在数据库降级时，情况就不一样了，针对我们开发新版本2时， 我们不能明确地知道以后的新版本比如版本3、4的数据库结构走向是怎样的。比如以后用户从版本3回退到我们正在开发的版本2，由于我们开发当时不能预知版本3的表结构，不知版本3的数据表能否兼容到版本2（假如版本3升级时删除了一个版本2一直在用的表字段，这时回退数据结构可能就不兼容了），那么我们在开发版本2时最稳妥的做法是
    </span>
    <span style="font-family:'Helvetica Neue',Helvetica,Arial,sans-serif; font-size:14px; color:#444444; margin:0px; padding:0px; line-height:20.16px; text-align:justify; text-indent:28px; background-color:rgb(253,253,253)">
     重写onDowngrade时把所有当前版本将用到的表全部重建，即降级时扔掉以前全部的数据
    </span>
    <span style="font-family:'Helvetica Neue',Helvetica,Arial,sans-serif; font-size:14px; color:#444444; line-height:20.16px; text-align:justify; text-indent:28px; background-color:rgb(253,253,253)">
     。
    </span>
    <p style="margin-top:15px; margin-bottom:0px; padding-top:0px; padding-bottom:0px; text-indent:2em; color:rgb(68,68,68); font-family:'Helvetica Neue',Helvetica,Arial,sans-serif; font-size:14px; line-height:20.16px; text-align:justify; background-color:rgb(253,253,253)">
    </p>
    <pre style="margin-top:0px; margin-bottom:0px; padding:0px; font-family:Monaco,Menlo,Consolas,'Courier New',monospace; border:none; color:rgb(102,102,102); font-size:12.6px; line-height:16.128px; text-align:justify; background:rgb(238,238,238)"> 
 <div class="line" style="margin:0px; padding:0px">
  
  <span class="comment" style="color:#93a1a1; margin:0px; padding:0px; font-style:italic">// 因为我们无法预知未来版本的表结构，向下兼容时最稳妥的方法就是将该版本自己需要的表重构一次</span>
 
 </div>
 
 <div class="line" style="margin:0px; padding:0px">
  
  <span class="annotation" style="margin:0px; padding:0px">@Override</span>
 
 </div>
 
 <div class="line" style="margin:0px; padding:0px">
  
  <span class="keyword" style="color:#85990; margin:0px; padding:0px">public</span> 
  
  <span class="keyword" style="color:#85990; margin:0px; padding:0px">void</span> 
  
  <span class="title" style="color:#268bd2; margin:0px; padding:0px">onDowngrade</span> (SQLiteDatabase db, 
  
  <span class="keyword" style="color:#85990; margin:0px; padding:0px">int</span> oldVersion, 
  
  <span class="keyword" style="color:#85990; margin:0px; padding:0px">int</span> newVersion) {
 
 </div>
 
 <div class="line" style="margin:0px; padding:0px">
  
      db.execSQL(
  
  <span class="string" style="color:#2aa198; margin:0px; padding:0px">"DROP TABLE IF EXISTS t1;"</span>);
 
 </div>
 
 <div class="line" style="margin:0px; padding:0px">
  
      db.execSQL(
  
  <span class="string" style="color:#2aa198; margin:0px; padding:0px">"DROP TABLE IF EXISTS t2;"</span>);
 
 </div>
 
 <div class="line" style="margin:0px; padding:0px">
  
      db.execSQL(
  
  <span class="string" style="color:#2aa198; margin:0px; padding:0px">"DROP TABLE IF EXISTS t3;"</span>);
 
 </div>
 
 <div class="line" style="margin:0px; padding:0px">
  
      db.execSQL(
  
  <span class="string" style="color:#2aa198; margin:0px; padding:0px">"DROP TABLE IF EXISTS t4;"</span>);
 
 </div>
 
 <div class="line" style="margin:0px; padding:0px">
  
      ....
 
 </div>
 
 <div class="line" style="margin:0px; padding:0px">
  
      onCreate(db); 
  
  <span class="comment" style="color:#93a1a1; margin:0px; padding:0px; font-style:italic">// 建表</span>
 
 </div>
 
 <div class="line" style="margin:0px; padding:0px">
  
  }
 
 </div></pre>
   </div>
  </div>
 </article>
 <p alt="68747470733a2f2f:626c6f672e6373646e2e6e65742f71715f3332303539383237:2f61727469636c652f64657461696c732f3531363131343832" class_="artid" style="display:none">
 </p>
</div>


