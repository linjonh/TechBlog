---
layout: post
title: "基于redis实现最热搜索和最近搜索功能"
date: 2024-02-27 16:16:01 +0800
description: "文章浏览阅读2.3k次，点赞24次，redis实现最近搜索和最热搜索功能_redis 热搜"
keywords: "redis 热搜"
categories: ['Redis']
tags: ['缓存', '数据库', 'Redis']
artid: "136320916"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=136320916
    alt: "基于redis实现最热搜索和最近搜索功能"
render_with_liquid: false
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     基于redis实现【最热搜索】和【最近搜索】功能
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <p>
    </p>
    <div class="toc">
     <h4>
      目录
     </h4>
     <ul>
      <li>
       <a href="#_1" rel="nofollow">
        一、前言
       </a>
      </li>
      <li>
       <a href="#_11" rel="nofollow">
        二、分析问题
       </a>
      </li>
      <li>
       <a href="#redis_19" rel="nofollow">
        三、针对两个问题，使用redis怎么解决问题？
       </a>
      </li>
      <li>
       <ul>
        <li>
         <a href="#1String_23" rel="nofollow">
          1、字符串String
         </a>
        </li>
        <li>
         <a href="#2List_32" rel="nofollow">
          2、列表List
         </a>
        </li>
        <li>
         <a href="#3Hash_39" rel="nofollow">
          3、字典Hash
         </a>
        </li>
        <li>
         <a href="#4Set_47" rel="nofollow">
          4、集合Set
         </a>
        </li>
        <li>
         <a href="#5ZSet_55" rel="nofollow">
          5、有序集合ZSet
         </a>
        </li>
        <li>
         <a href="#6_61" rel="nofollow">
          6、需要解决的五大问题
         </a>
        </li>
       </ul>
      </li>
      <li>
       <a href="#_75" rel="nofollow">
        四、编写代码
       </a>
      </li>
      <li>
       <ul>
        <li>
         <a href="#1pom_77" rel="nofollow">
          1.pom依赖
         </a>
        </li>
        <li>
         <a href="#2applicationyml_87" rel="nofollow">
          2.application.yml配置
         </a>
        </li>
        <li>
         <a href="#3Product_102" rel="nofollow">
          3.Product商品实体
         </a>
        </li>
        <li>
         <a href="#4_118" rel="nofollow">
          4.用户最近搜索信息
         </a>
        </li>
        <li>
         <a href="#5redisSearchRedisHelper_136" rel="nofollow">
          5.redis辅助类SearchRedisHelper
         </a>
        </li>
        <li>
         <a href="#6service_245" rel="nofollow">
          6.业务service
         </a>
        </li>
        <li>
         <a href="#7controller_289" rel="nofollow">
          7.controller控制层
         </a>
        </li>
       </ul>
      </li>
      <li>
       <a href="#postman_346" rel="nofollow">
        五、postman测试
       </a>
      </li>
      <li>
       <ul>
        <li>
         <a href="#1_347" rel="nofollow">
          1.第一次搜索
         </a>
        </li>
        <li>
         <a href="#2_350" rel="nofollow">
          2.热点搜索
         </a>
        </li>
        <li>
         <a href="#3_354" rel="nofollow">
          3.最近搜索
         </a>
        </li>
        <li>
         <a href="#4_358" rel="nofollow">
          4.第二次第三次搜索
         </a>
        </li>
        <li>
         <a href="#5_364" rel="nofollow">
          5.再看热点搜索
         </a>
        </li>
        <li>
         <a href="#6_368" rel="nofollow">
          6.再看最近搜索变化
         </a>
        </li>
        <li>
         <a href="#7_372" rel="nofollow">
          7.第四次搜索
         </a>
        </li>
        <li>
         <a href="#8_376" rel="nofollow">
          8.热搜变化
         </a>
        </li>
        <li>
         <a href="#9_380" rel="nofollow">
          9.最近搜索变化
         </a>
        </li>
       </ul>
      </li>
      <li>
       <a href="#_384" rel="nofollow">
        六、总结
       </a>
      </li>
     </ul>
    </div>
    <p>
    </p>
    <h2>
     <a id="_1">
     </a>
     一、前言
    </h2>
    <p>
     大家在浏览各种网站，比如淘宝，京东，微博等网站，都会看到一些
     <mark>
      热门搜索
     </mark>
     和
     <mark>
      最近搜索
     </mark>
     的功能，大家有木有好奇，技术背后是如何实现的呢？今天我们一起来用redis解决这两个问题，并已在项目中实战！！！
     <br/>
     热搜如下图：
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/2736f69fa99ce659eac364bd93cb88fc.png">
      <br/>
      最近搜索如下图:
     </img>
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/ddbfb13069f91a63134fa00523cb5fa3.png"/>
    </p>
    <h2>
     <a id="_11">
     </a>
     二、分析问题
    </h2>
    <p>
     1、热门搜索：是指一定时间内、一定范围内，公众较为关心的热点问题，被搜索的次数越多，热搜榜越靠前。
    </p>
    <p>
     2、最近搜索：只显示当前用户最近一段时间内的搜索记录，按照时间进行排序，如果有重复搜索，覆盖到重复的数据，并且要排到最前面。
    </p>
    <p>
     3、针对于热门的搜索属于高并发的场景，还需要高性能显示给用户，用MySQL存储显然不太合适，流量过多会把MySQL撑爆，最近搜索和最热搜索也不需要持久化，最好的解决方案之一就是redis做缓存，单机redis可以承受
     <code>
      10万QPS
     </code>
     。
    </p>
    <h2>
     <a id="redis_19">
     </a>
     三、针对两个问题，使用redis怎么解决问题？
    </h2>
    <p>
     我们复习一下redis的五大数据类型，redis数据类型可以参考
     <a href="https://blog.csdn.net/weixin_45683778/article/details/130065424">
      Redis中5种基本数据类型结构详解
     </a>
    </p>
    <h3>
     <a id="1String_23">
     </a>
     1、字符串String
    </h3>
    <p>
     <strong>
      特性：
     </strong>
     <br/>
     （1）最基本的数据类型，二进制安全的字符串，最大
     <code>
      512M
     </code>
     。
     <br/>
     （2）支持字符串操作:strlen或取value的长度，返回的是字节的数量。
     <br/>
     （3）数据交互有个二进制安全的概念，给我数据的时候你自己编码，字节数组到达我这里整理，帮你存，客户端之间商量好。
     <br/>
     （4）支持数值计算操作:
     <code>
      incr,decr
     </code>
     <br/>
     <strong>
      应用场景
     </strong>
     ：做简单得键值对缓存，比如`Session，token，统计，限流，轻量级（kb级别）的FS内存级的文件系统—任何东西都可以变成字节数组（二进制），一些复杂的计数功能的缓存
    </p>
    <h3>
     <a id="2List_32">
     </a>
     2、列表List
    </h3>
    <p>
     <strong>
      特性：
     </strong>
     <br/>
     按照添加顺序保持顺序的字符串列表，也就是存储一些列表型得数据结构，类似粉丝列表、文字得评论列表之类得数据。
     <br/>
     <strong>
      应用场景：
     </strong>
     <br/>
     可以做简单的消息队列的功能。另外还有一个就是，可以利用
     <code>
      lrange
     </code>
     命令，做基于redis的分页功能，性能极佳，用户体验好。
    </p>
    <h3>
     <a id="3Hash_39">
     </a>
     3、字典Hash
    </h3>
    <p>
     <strong>
      特性：
     </strong>
     <br/>
     （1）
     <code>
      key-value
     </code>
     对的一种集合，存储结构化得数据，比如一个对象。
     <br/>
     （2）这里value存放的是结构化的对象，比较方便的就是操作其中的某个字段。
     <br/>
     <strong>
      应用场景：
     </strong>
     <br/>
     经常会用来做用户数据的管理，存储用户的信息。比如做单点登录的时候，就是用这种数据结构存储用户信息，以cookieId作为key，设置30分钟为缓存过期时间，能很好的模拟出类似session的效果。
    </p>
    <h3>
     <a id="4Set_47">
     </a>
     4、集合Set
    </h3>
    <p>
     <strong>
      特性:
     </strong>
     <br/>
     无序的字符串集合，不存在重复的元素.
     <br/>
     <strong>
      应用场景：
     </strong>
     <br/>
     去重，还可以利用交集、并集、差集等操作，可以计算共同喜好，全部的喜好，自己独有的喜好等功能。
    </p>
    <h3>
     <a id="5ZSet_55">
     </a>
     5、有序集合ZSet
    </h3>
    <p>
     <strong>
      特性：
     </strong>
     <br/>
     已排序的字符串集合。去重并排序，如获取排名前几名。
     <br/>
     <strong>
      应用场景：
     </strong>
     <br/>
     <code>
      sorted set
     </code>
     多了一个权重参数
     <code>
      score
     </code>
     ,集合中的元素能够按
     <code>
      score
     </code>
     进行排列。可以做排行榜应用，取
     <code>
      TOP N
     </code>
     操作。
    </p>
    <h3>
     <a id="6_61">
     </a>
     6、需要解决的五大问题
    </h3>
    <p>
     <strong>
      问题一
     </strong>
     ：很显然根据咱们的以上分析，热门搜索和最近搜索的功能需要去重并且排序，热门搜索点击率最高的在前面，最近搜索最新的数据搜索在最前面，所以使用
     <code>
      ZSet集合
     </code>
     实现最合适。针对于最近搜索的功能使用List也可以实现，但是删除的效率要比ZSet慢，还需要自己去重，所以还是Zset最合适。
    </p>
    <p>
     <strong>
      问题二
     </strong>
     ：用户可能无限制浏览商品，最近搜索的功能需要确保
     <code>
      zSet 不能无限制插入
     </code>
     ，需要
     <code>
      控制zSet 的大小
     </code>
     ，也就是指保存最近N条浏览记录。
    </p>
    <p>
     <strong>
      问题三
     </strong>
     ：最近搜索的功能需要在插入第N+1 条后移除最开始浏览的第一条。
    </p>
    <p>
     <strong>
      问题四
     </strong>
     ：热门搜索key值需要过期时间的。
    </p>
    <p>
     <strong>
      问题五
     </strong>
     ：热门搜索针对的是所有用户，而最近搜索针对的是当前用户。
    </p>
    <p>
     以上五大问题均在代码中详细解决，仔细看注释。
    </p>
    <h2>
     <a id="_75">
     </a>
     四、编写代码
    </h2>
    <h3>
     <a id="1pom_77">
     </a>
     1.pom依赖
    </h3>
    <pre><code class="prism language-java"><span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> redis <span class="token operator">--</span><span class="token operator">&gt;</span>
<span class="token generics"><span class="token punctuation">&lt;</span>dependency<span class="token punctuation">&gt;</span></span>
    <span class="token generics"><span class="token punctuation">&lt;</span>groupId<span class="token punctuation">&gt;</span></span>org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">&gt;</span>
    <span class="token generics"><span class="token punctuation">&lt;</span>artifactId<span class="token punctuation">&gt;</span></span>spring<span class="token operator">-</span>boot<span class="token operator">-</span>starter<span class="token operator">-</span>data<span class="token operator">-</span>redis<span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>dependency<span class="token operator">&gt;</span>
</code></pre>
    <h3>
     <a id="2applicationyml_87">
     </a>
     2.application.yml配置
    </h3>
    <pre><code class="prism language-java">server<span class="token operator">:</span>
  port<span class="token operator">:</span> <span class="token number">8889</span>

spring<span class="token operator">:</span>
  redis<span class="token operator">:</span>
    host<span class="token operator">:</span> <span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span>
    port<span class="token operator">:</span> <span class="token number">6379</span>
    password<span class="token operator">:</span> 
    database<span class="token operator">:</span> <span class="token number">2</span>
    timeout<span class="token operator">:</span> <span class="token number">5000</span>
</code></pre>
    <h3>
     <a id="3Product_102">
     </a>
     3.Product商品实体
    </h3>
    <pre><code class="prism language-java"><span class="token annotation punctuation">@Data</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Product</span> <span class="token keyword">implements</span> <span class="token class-name">Serializable</span> <span class="token punctuation">{<!-- --></span>

	<span class="token comment">//商品id</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> id<span class="token punctuation">;</span>

	<span class="token comment">//商品名称</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> productName<span class="token punctuation">;</span>

    <span class="token comment">//.....等属性</span>
<span class="token punctuation">}</span>
</code></pre>
    <h3>
     <a id="4_118">
     </a>
     4.用户最近搜索信息
    </h3>
    <pre><code class="prism language-java"><span class="token annotation punctuation">@Data</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserRecentSearch</span> <span class="token keyword">implements</span> <span class="token class-name">Serializable</span> <span class="token punctuation">{<!-- --></span>

    <span class="token comment">/**
     * 搜索信息
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> searchInfo<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 用户id
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> unionId<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <h3>
     <a id="5redisSearchRedisHelper_136">
     </a>
     5.redis辅助类SearchRedisHelper
    </h3>
    <pre><code class="prism language-java"><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SearchRedisHelper</span> <span class="token punctuation">{<!-- --></span>

    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">RedisTemplate</span> redisTemplate<span class="token punctuation">;</span>


    <span class="token comment">/**
     * 热搜的KEY
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">HOT_SEARCH</span> <span class="token operator">=</span> <span class="token string">"product_hot_search"</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * 最近搜索的KEY
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">RECENT_SEARCH</span> <span class="token operator">=</span> <span class="token string">"product_recent_search"</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * 最近搜索的大小
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Integer</span> <span class="token constant">CURRENT_SEARCH_SIZE</span> <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * 最热搜索KEY过期时间
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Integer</span> <span class="token constant">HOT_SEARCH_EXPIRE_TIME</span> <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * 设置redis的过期时间
     * expire其实是懒加载，不设置key的时候是不会执行的
     */</span>
    <span class="token annotation punctuation">@PostConstruct</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setHotSearchExpireTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        redisTemplate<span class="token punctuation">.</span><span class="token function">expire</span><span class="token punctuation">(</span><span class="token constant">HOT_SEARCH</span><span class="token punctuation">,</span> <span class="token constant">HOT_SEARCH_EXPIRE_TIME</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * redis添加最近搜索
     *
     * @param query
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addRedisRecentSearch</span><span class="token punctuation">(</span><span class="token class-name">String</span> query<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">UserRecentSearch</span> userRecentSearch <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UserRecentSearch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 用户id，当前用户id</span>
        userRecentSearch<span class="token punctuation">.</span><span class="token function">setUnionId</span><span class="token punctuation">(</span><span class="token number">100434L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 搜索信息</span>
        userRecentSearch<span class="token punctuation">.</span><span class="token function">setSearchInfo</span><span class="token punctuation">(</span>query<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// score为一个分值，需要把最近浏览的商品id的分值设为最大值，</span>
        <span class="token comment">// 此处我们可以设置为当前时间Instant.now().getEpochSecond()</span>
        <span class="token comment">// 这样最近浏览的商品id的分值一定最大，排在Zset集合最前面</span>
        <span class="token class-name">ZSetOperations</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">UserRecentSearch</span><span class="token punctuation">&gt;</span></span> zSet <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForZSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 由于zSet的集合特性当插入已经存在的V值（商品id）时只会更新score值，</span>
        zSet<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token constant">RECENT_SEARCH</span><span class="token punctuation">,</span> userRecentSearch<span class="token punctuation">,</span> <span class="token class-name">Instant</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getEpochSecond</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 获取到全部用户的最近搜索记录，用reverseRangeWithScores方法，可以获取到根据score排序之后的集合</span>
        <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ZSetOperations<span class="token punctuation">.</span>TypedTuple</span><span class="token punctuation">&lt;</span><span class="token class-name">UserRecentSearch</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> typedTuples <span class="token operator">=</span> zSet<span class="token punctuation">.</span><span class="token function">reverseRangeWithScores</span><span class="token punctuation">(</span><span class="token constant">RECENT_SEARCH</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//只得到当前用户的最近搜索记录,注意这里必须保证set集合的顺序</span>
        <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">UserRecentSearch</span><span class="token punctuation">&gt;</span></span> userRecentSearches <span class="token operator">=</span> <span class="token function">listRecentSearch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>userRecentSearches<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token constant">CURRENT_SEARCH_SIZE</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">//获取到最开始浏览的第一条</span>
            <span class="token class-name">UserRecentSearch</span> userRecentSearchLast <span class="token operator">=</span> userRecentSearches<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span>first<span class="token punctuation">,</span> second<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> second<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">orElse</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//删除最开始浏览的第一条</span>
            zSet<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token constant">RECENT_SEARCH</span><span class="token punctuation">,</span> userRecentSearchLast<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 热搜列表
     * @return
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Product</span><span class="token punctuation">&gt;</span></span> <span class="token function">listHotSearch</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//0 5 表示0-5下标对应的元素</span>
        <span class="token keyword">return</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForZSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">reverseRangeWithScores</span><span class="token punctuation">(</span><span class="token constant">HOT_SEARCH</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * redis添加热搜
     * @param productList
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addRedisHotSearch</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Product</span><span class="token punctuation">&gt;</span></span> productList<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//1：表示每调用一次，当前product的分数+1</span>
        productList<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>product <span class="token operator">-&gt;</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForZSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">incrementScore</span><span class="token punctuation">(</span><span class="token constant">HOT_SEARCH</span><span class="token punctuation">,</span> product<span class="token punctuation">,</span> <span class="token number">1D</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 最近搜索列表
     * @return
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">UserRecentSearch</span><span class="token punctuation">&gt;</span></span> <span class="token function">listRecentSearch</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ZSetOperations<span class="token punctuation">.</span>TypedTuple</span><span class="token punctuation">&lt;</span><span class="token class-name">UserRecentSearch</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> typedTuples <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForZSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">reverseRangeWithScores</span><span class="token punctuation">(</span><span class="token constant">RECENT_SEARCH</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">Optional</span><span class="token punctuation">.</span><span class="token function">ofNullable</span><span class="token punctuation">(</span>typedTuples<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>tuples <span class="token operator">-&gt;</span> tuples<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">ZSetOperations<span class="token punctuation">.</span>TypedTuple</span><span class="token operator">::</span><span class="token function">getValue</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token class-name">Objects</span><span class="token operator">::</span><span class="token function">nonNull</span><span class="token punctuation">)</span>
<span class="token comment">//                        .filter(userRecentSearch -&gt; Objects.equals(userRecentSearch.getUnionId(), ContextHolder.getUser().getId()))</span>
                        <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>userRecentSearch <span class="token operator">-&gt;</span> <span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>userRecentSearch<span class="token punctuation">.</span><span class="token function">getUnionId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">100434L</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">collectingAndThen</span><span class="token punctuation">(</span>
                                <span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toCollection</span><span class="token punctuation">(</span><span class="token class-name">LinkedHashSet</span><span class="token operator">::</span><span class="token keyword">new</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">LinkedHashSet</span><span class="token operator">::</span><span class="token keyword">new</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">orElseGet</span><span class="token punctuation">(</span><span class="token class-name">LinkedHashSet</span><span class="token operator">::</span><span class="token keyword">new</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre>
    <h3>
     <a id="6service_245">
     </a>
     6.业务service
    </h3>
    <pre><code class="prism language-java"><span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ProductService</span> <span class="token punctuation">{<!-- --></span>

    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">SearchRedisHelper</span> searchRedisHelper<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 搜索
     * @param query
     * @return
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Product</span><span class="token punctuation">&gt;</span></span> <span class="token function">search</span><span class="token punctuation">(</span><span class="token class-name">String</span> query<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//业务代码可用es.....此处略过....模拟数据库数据</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Product</span><span class="token punctuation">&gt;</span></span> productList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Product</span> product <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Product</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        product<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span><span class="token number">1L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        product<span class="token punctuation">.</span><span class="token function">setProductName</span><span class="token punctuation">(</span><span class="token string">"iphone15"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        productList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>product<span class="token punctuation">)</span><span class="token punctuation">;</span>
        searchRedisHelper<span class="token punctuation">.</span><span class="token function">addRedisRecentSearch</span><span class="token punctuation">(</span>query<span class="token punctuation">)</span><span class="token punctuation">;</span>
        searchRedisHelper<span class="token punctuation">.</span><span class="token function">addRedisHotSearch</span><span class="token punctuation">(</span>productList<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> productList<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 热搜列表
     * @return
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Product</span><span class="token punctuation">&gt;</span></span> <span class="token function">listHotSearch</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> searchRedisHelper<span class="token punctuation">.</span><span class="token function">listHotSearch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 最近搜索列表
     * @return
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">UserRecentSearch</span><span class="token punctuation">&gt;</span></span> <span class="token function">listRecentSearch</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> searchRedisHelper<span class="token punctuation">.</span><span class="token function">listRecentSearch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <h3>
     <a id="7controller_289">
     </a>
     7.controller控制层
    </h3>
    <pre><code class="prism language-java"><span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/redis/test"</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@RestController</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RedisController</span> <span class="token punctuation">{<!-- --></span>

    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">RedisTemplate</span> redisTemplate<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">ProductService</span> productService<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 删除redis
     * @param key
     * @return
     */</span>
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/w/remove/redis"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">removeRedis</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        redisTemplate<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 搜索
     * @param query
     * @return
     */</span>
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/r/search/product"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">listProduct</span><span class="token punctuation">(</span><span class="token class-name">String</span> query<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span>productService<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span>query<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 热搜列表
     * @return
     */</span>
    <span class="token annotation punctuation">@ResponseBody</span>
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/r/list/hot/search"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">listHotSearch</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span>productService<span class="token punctuation">.</span><span class="token function">listHotSearch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 最近搜索列表
     * @return
     */</span>
    <span class="token annotation punctuation">@ResponseBody</span>
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/r/list/recent/search"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">recentHotSearch</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span>productService<span class="token punctuation">.</span><span class="token function">listRecentSearch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre>
    <h2>
     <a id="postman_346">
     </a>
     五、postman测试
    </h2>
    <h3>
     <a id="1_347">
     </a>
     1.第一次搜索
    </h3>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/a0e23f09309a4aa27e444baae0c318e3.png"/>
    </p>
    <h3>
     <a id="2_350">
     </a>
     2.热点搜索
    </h3>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/374c922c0a8c30a4f676e6029ed93444.png"/>
    </p>
    <h3>
     <a id="3_354">
     </a>
     3.最近搜索
    </h3>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/b37ae7d8ae45fd746a364ae0ffebf069.png"/>
    </p>
    <h3>
     <a id="4_358">
     </a>
     4.第二次第三次搜索
    </h3>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/d99e6707801f52d0198c5c3cb50f7576.png"/>
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/e353cb3e97983793a115fc1b9e1bff7f.png"/>
    </p>
    <h3>
     <a id="5_364">
     </a>
     5.再看热点搜索
    </h3>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/b793e1523b4ac46bf48d633874ccfd2f.png"/>
    </p>
    <h3>
     <a id="6_368">
     </a>
     6.再看最近搜索变化
    </h3>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/aad00500c11cfc6627469effef9c1c22.png"/>
    </p>
    <h3>
     <a id="7_372">
     </a>
     7.第四次搜索
    </h3>
    <p>
     再搜索两次
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/3fd4fecd92a133dd7d5b54f71edc5e56.png"/>
    </p>
    <h3>
     <a id="8_376">
     </a>
     8.热搜变化
    </h3>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/73d7c6f0ec80f8906d4692a2b4c13441.png"/>
    </p>
    <h3>
     <a id="9_380">
     </a>
     9.最近搜索变化
    </h3>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/b8c83017baf8f1728dc8f6f23b7937f5.png"/>
    </p>
    <h2>
     <a id="_384">
     </a>
     六、总结
    </h2>
    <p>
     本文针对于网站热点搜索和最近搜索的问题，对redis的五大数据类型进行了解读，并且采用高并发利器redis的ZSet有序集合完美解决本文一开始引入的问题，保证了系统的高并发和高性能，提高用户体验。
    </p>
    <p>
     项目代码：
     <a href="https://github.com/huang-hanson/java_integration/tree/main/redis-hotAndRecentSearch-demo">
      Github
     </a>
    </p>
    <p>
     推荐好文：
     <br/>
     <a href="https://blog.csdn.net/weixin_45683778/article/details/136300976">
      Redis实现分布式锁详细方法
     </a>
    </p>
    <p>
     如果看到这里，说明你喜欢这篇文章，请转发，点赞
    </p>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f626c6f672e:6373646e2e6e65742f77656978696e5f34353638333737382f:61727469636c652f64657461696c732f313336333230393136" class_="artid" style="display:none">
 </p>
</div>


