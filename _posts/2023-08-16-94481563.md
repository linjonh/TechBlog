---
layout: post
title: "安卓控制新大陆云平台一"
date: 2023-08-16 15:41:05 +0800
description: "文章浏览阅读1.2w次，点赞24次，前言由于要参加比赛，因此必须学会用安卓来控制新大陆云平台，后期还"
keywords: "networkbusiness"
categories: ['新大陆']
tags: []
artid: "94481563"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=94481563
    alt: "安卓控制新大陆云平台一"
render_with_liquid: false
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     安卓控制新大陆云平台（一）
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-dracula" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <h2>
     <a id="_1">
     </a>
     前言
    </h2>
    <p>
     由于要参加比赛，因此必须学会用安卓来控制新大陆云平台，后期还会用C#控制，最后更新STM32部分代码
    </p>
    <p>
     新大陆云平台官网：http://www.nlecloud.com/
    </p>
    <p>
     本章主要先介绍如何写一个安卓登录云平台的程序.
    </p>
    <p>
     使用C#封装了部分API
     <a href="https://gitee.com/youryouth/CsharpNlecloud#%E4%B8%8A%E4%BC%A0%E4%BC%A0%E6%84%9F%E6%95%B0%E6%8D%AE" rel="nofollow">
      部分API接口
     </a>
     <br/>
     部分封装的安卓SDK会在后续给出
    </p>
    <br/>
    <hr/>
    <br/>
    <h3>
     <a id="_16">
     </a>
     一、云平台介绍
    </h3>
    <p>
     首先，我们从云平台的官网来看,如下图所示
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/b06861925f7a64290fe91c8abc8f4f13.png">
      <br/>
      先查看部分接口，可以知道我们要先登录获取AccessToken才能进行后续的操作
     </img>
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/58f4f1d7f90c9635c45d0ba8fb7afcaf.png">
      <br/>
      我们用post请求之后，可以获得对应的AccessToken
     </img>
    </p>
    <br/>
    <hr/>
    <br/>
    <h2>
     <a id="_29">
     </a>
     二、安卓开发介绍
    </h2>
    <p>
     这里，我假设大家掌握的基础是基本的布局和控件使用
    </p>
    <p>
     首先，我们先去官网下载新大陆云平台的Sdk
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/ba464e8793052bcedd46551b361aced5.png">
      <br/>
      接着，在Android studio中import Module
      <br/>
      <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/9927b6417ddbe16480fb0f00b529688a.png">
       <br/>
       接下来，对新导入的模块build
       <br/>
       <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/a1abc3080e2e66b2b8b5f2ab0bfe3cf2.png">
        <br/>
        成功后如下图所示
        <br/>
        <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/7fc4301cc2929f4c43d9f2fd580317da.png">
         <br/>
         如果导入nlecloud-sdk的包不存在，尝试以下操作
         <br/>
         在build.gradle(Module.app)中加入如下语句
        </img>
       </img>
      </img>
     </img>
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/4cc40264c942553c600e22288653b8e1.png">
      <br/>
      布局文件，大致如下
     </img>
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/1513b05113ee896447124109be2c7733.png"/>
    </p>
    <p>
     由于代码比较简单，这里我就不贴出布局文件的代码了
    </p>
    <p>
     接下来就是使用安卓来登录云平台，在这里，大家如果理解网页上如何使用post请求登录云平台的话，那么这里就会变得非常简单。
     <br/>
     首先，先看部分函数代码
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/2b4fe9bfcfe163ff96fd31ec580e49e7.png"/>
     <br/>
     我们在nlecloud-sdk中找到如下类,NewWorkBusiness，可以知道该类的包含了一个signIn登录函数，那么我们就需要使用这个类来登录新平台,该类，调用了apiService的signIn函数，我们接着往下看apiService类
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/3189a65bf824a1c52cb4294352afa510.png"/>
     <br/>
     看着很复杂，实际上，我们一点一点的理解,首先该类是一个api服务类，有点像第一张图的那样，该方法返回的是一个responseEntity，而ResponseEntity ：标识整个http相应：状态码、头部信息、响应体内容(spring)。基本意思就是这样，大致理解就是一个请求网页的响应，分析结束
    </p>
    <br/>
    <hr/>
    <br/>
    <h2>
     <a id="_62">
     </a>
     代码如下
    </h2>
    <pre><code class="prism language-java">	<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MainActivity</span> <span class="token keyword">extends</span> <span class="token class-name">AppCompatActivity</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">private</span> EditText username<span class="token punctuation">;</span>   <span class="token comment">//账户</span>
    <span class="token keyword">private</span> EditText password<span class="token punctuation">;</span>  <span class="token comment">//密码</span>
    <span class="token keyword">private</span> Button login<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">onCreate</span><span class="token punctuation">(</span>Bundle savedInstanceState<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onCreate</span><span class="token punctuation">(</span>savedInstanceState<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">setContentView</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>layout<span class="token punctuation">.</span>activity_main<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//登录</span>
        login <span class="token operator">=</span> <span class="token punctuation">(</span>Button<span class="token punctuation">)</span> <span class="token function">findViewById</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>id<span class="token punctuation">.</span>login<span class="token punctuation">)</span><span class="token punctuation">;</span>
        username <span class="token operator">=</span> <span class="token punctuation">(</span>EditText<span class="token punctuation">)</span><span class="token function">findViewById</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>id<span class="token punctuation">.</span>username<span class="token punctuation">)</span><span class="token punctuation">;</span>
        password <span class="token operator">=</span> <span class="token punctuation">(</span>EditText<span class="token punctuation">)</span><span class="token function">findViewById</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>id<span class="token punctuation">.</span>password<span class="token punctuation">)</span><span class="token punctuation">;</span>
        login<span class="token punctuation">.</span><span class="token function">setOnClickListener</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">View<span class="token punctuation">.</span>OnClickListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onClick</span><span class="token punctuation">(</span>View view<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token function">signIn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">signIn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        String platformAddress <span class="token operator">=</span> <span class="token string">"http://api.nlecloud.com:80/"</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> String _username <span class="token operator">=</span> username<span class="token punctuation">.</span><span class="token function">getText</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// "17674738454";</span>
        <span class="token keyword">final</span> String _password <span class="token operator">=</span> password<span class="token punctuation">.</span><span class="token function">getText</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//"123456";</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>_username<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span> <span class="token operator">||</span> _password<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            Toast<span class="token punctuation">.</span><span class="token function">makeText</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span><span class="token string">"用户名或密码不为空"</span><span class="token punctuation">,</span>Toast<span class="token punctuation">.</span>LENGTH_SHORT<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">final</span> NetWorkBusiness netWorkBusiness <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NetWorkBusiness</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">,</span>platformAddress<span class="token punctuation">)</span><span class="token punctuation">;</span>
        netWorkBusiness<span class="token punctuation">.</span><span class="token function">signIn</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">SignIn</span><span class="token punctuation">(</span>_username<span class="token punctuation">,</span> _password<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Callback</span><span class="token operator">&lt;</span>BaseResponseEntity<span class="token generics function"><span class="token punctuation">&lt;</span>User<span class="token punctuation">&gt;</span></span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onResponse</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> Call<span class="token operator">&lt;</span>BaseResponseEntity<span class="token generics function"><span class="token punctuation">&lt;</span>User<span class="token punctuation">&gt;</span></span><span class="token operator">&gt;</span> call<span class="token punctuation">,</span> <span class="token annotation punctuation">@NonNull</span> Response<span class="token operator">&lt;</span>BaseResponseEntity<span class="token generics function"><span class="token punctuation">&lt;</span>User<span class="token punctuation">&gt;</span></span><span class="token operator">&gt;</span> response<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                BaseResponseEntity<span class="token generics function"><span class="token punctuation">&lt;</span>User<span class="token punctuation">&gt;</span></span> baseResponseEntity <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">body</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//获得响应体</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>baseResponseEntity <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>baseResponseEntity<span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token comment">//需要传输秘钥</span>
                        String accessToken <span class="token operator">=</span> baseResponseEntity<span class="token punctuation">.</span><span class="token function">getResultObj</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAccessToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//json数据返回</span>
                        Intent intent <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Intent</span><span class="token punctuation">(</span>MainActivity<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">,</span> MenuActivity<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        Bundle bundle <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Bundle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        bundle<span class="token punctuation">.</span><span class="token function">putString</span><span class="token punctuation">(</span><span class="token string">"accessToken"</span><span class="token punctuation">,</span> accessToken<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        intent<span class="token punctuation">.</span><span class="token function">putExtras</span><span class="token punctuation">(</span>bundle<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token function">startActivity</span><span class="token punctuation">(</span>intent<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token function">finish</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                        Toast<span class="token punctuation">.</span><span class="token function">makeText</span><span class="token punctuation">(</span>MainActivity<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">,</span> baseResponseEntity<span class="token punctuation">.</span><span class="token function">getMsg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Toast<span class="token punctuation">.</span>LENGTH_SHORT<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//返回为空...</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onFailure</span><span class="token punctuation">(</span>Call<span class="token operator">&lt;</span>BaseResponseEntity<span class="token generics function"><span class="token punctuation">&lt;</span>User<span class="token punctuation">&gt;</span></span><span class="token operator">&gt;</span> call<span class="token punctuation">,</span> Throwable t<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                Toast<span class="token punctuation">.</span><span class="token function">makeText</span><span class="token punctuation">(</span>MainActivity<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">,</span><span class="token string">"登录失败 "</span> <span class="token operator">+</span> t<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>Toast<span class="token punctuation">.</span>LENGTH_SHORT<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <br/>
    <hr/>
    <br/>
    <h2>
     <a id="_125">
     </a>
     几个问题
    </h2>
    <p>
     1 由于该应用是一个联网应用，必须请求网络权限，添加如下语句
    </p>
    <pre><code class="prism language-java"><span class="token operator">&lt;</span>uses<span class="token operator">-</span>permission android<span class="token operator">:</span>name<span class="token operator">=</span><span class="token string">"android.permission.INTERNET"</span> <span class="token operator">/</span><span class="token operator">&gt;</span>
</code></pre>
    <p>
     2 一开始不知道怎么回事，一直登陆失败，尝试在onFailure中显示错误信息t.getMessage()，结果得到的反馈是
    </p>
    <blockquote>
     <p>
      java.net.UnknownServiceException: CLEARTEXT communication ** not
      <br/>
      permitted by network security polic
     </p>
    </blockquote>
    <p>
     百度了一下，得到的问题是Android P http网络请求的问题
    </p>
    <p>
     Google表示，为保证用户数据和设备的安全，针对下一代 Android 系统(Android P) 的应用程序，将要求默认使用加密连接，这意味着 Android P 将禁止 App 使用所有未加密的连接，因此运行 Android P 系统的安卓设备无论是接收或者发送流量，未来都不能明码传输，需要使用下一代(Transport Layer Security)传输层安全协议，而 Android Nougat 和 Oreo 则不受影响。
    </p>
    <p>
     解决方法如下：
    </p>
    <p>
     在 res 下新增一个 xml 目录，然后创建一个名为：network_security_config.xml 文件（名字自定） ，内容如下，大概意思就是允许开启http请求
    </p>
    <pre><code class="prism language-xml"><span class="token prolog">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>network-security-config</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>base-config</span> <span class="token attr-name">cleartextTrafficPermitted</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>network-security-config</span><span class="token punctuation">&gt;</span></span>
</code></pre>
    <p>
     然后在APP的AndroidManifest.xml文件下的application标签增加以下属性
    </p>
    <pre><code class="prism language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>application</span>
<span class="token attr-name">...</span>
 <span class="token attr-name"><span class="token namespace">android:</span>networkSecurityConfig</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>@xml/network_security_config<span class="token punctuation">"</span></span>
<span class="token attr-name">...</span>
    <span class="token punctuation">/&gt;</span></span>
</code></pre>
    <br/>
    <hr/>
    <br/>
    <h2>
     <a id="_164">
     </a>
     总结
    </h2>
    <p>
     遇到问题要学会使用debug，不然都不知道问题出现在哪里
    </p>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f:626c6f672e6373646e2e6e65742f71715f3430333138343938:2f61727469636c652f64657461696c732f3934343831353633" class_="artid" style="display:none">
 </p>
</div>


