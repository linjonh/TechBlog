---
layout: post
title: "Python加密Excel"
date: 2023-01-17 13:01:57 +0800
description: "Python加密Excel_openpyxl 加密"
keywords: "openpyxl 加密"
categories: ['Python']
tags: ['Python']
artid: "128708142"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=128708142
    alt: "Python加密Excel"
render_with_liquid: false
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     Python加密Excel
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-tomorrow-night-eighties" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <p>
     最近编写一个软件需要对Excel进行加密，因此学习一下。
    </p>
    <h3>
     <a id="Excel_2">
     </a>
     Excel提供的加密功能
    </h3>
    <p>
     工作簿密码
     <br/>
     工作表密码
     <br/>
     工作簿结构密码
     <br/>
     只读密码：这一种在excel软件中没有找到，但Python库提供了功能
    </p>
    <h3>
     <a id="ExcelPython_8">
     </a>
     可以对Excel进行加密的Python库
    </h3>
    <p>
     pywin32：作用是调用Windows API，可以操作所有Office，通过pywin32的win32com可以加密excel。
    </p>
    <p>
     xlwings：只是操作Excel文件。安装xlwings时会同时安装pywin32，底层也是调用win32com进行加密。
     <br/>
     <code>
      [1] https://stackoverflow.com/questions/64138287/how-to-force-xlwings-to-use-comretryobjectwrapper-instead-of-win32com-api
     </code>
     <br/>
     <code>
      [2] https://stackoverflow.com/questions/58328776/differences-between-xlwings-vs-openpyxl-reading-excel-workbooks
     </code>
    </p>
    <p>
     openpyxl：只能操作Excel 2010 xlsx/xlsm/xltx/xltm文件。与pywin32相比，openpyxl不需要安装excel软件也可以加密excel。
    </p>
    <p>
     msoffcrypto-tool：只是用来解密已经被加密的Office文件。
    </p>
    <p>
     EasyXLS：有Java与.NET两种版本，安装库（Pythonnet、Py4J、Pyjnius）使得Python可以调用Java与.NET，便可以间接调用EasyXLS。
     <br/>
     <code>
      [1] https://www.easyxls.com/manual/tutorials/python/encrypt-excel-file.html
     </code>
     <br/>
     <code>
      [2] https://stackoverflow.com/questions/60027039/protect-workbook-by-python
     </code>
    </p>
    <p>
     Aspose.Cells：有很多版本，同EasyXLS，也可通过Python调用Java与.NET来间接调用Aspose.Cells，两个Python库分别为JAVA
     <code>
      aspose-cells
     </code>
     与.NET
     <code>
      aspose-cells-python
     </code>
     。
     <br/>
     使用JAVA版本的库需要安装JAVA，使用.NET版本的则不需要（Windows自带.NET）。
     <br/>
     <code>
      [1] https://docs.aspose.com/cells/
     </code>
     <br/>
     <code>
      [2] https://docs.aspose.com/cells/python-java/getting-started/
     </code>
     <br/>
     <code>
      [3] https://docs.aspose.com/cells/python-net/getting-started/
     </code>
    </p>
    <p>
     由于后两种还会涉及到JAVA与.NET，使得事情变得复杂。因此研究前四种库。
    </p>
    <h3>
     <a id="_31">
     </a>
     导入库
    </h3>
    <pre><code class="prism language-python"><span class="token keyword">import</span> openpyxl
<span class="token keyword">import</span> xlwings
<span class="token keyword">from</span> win32com<span class="token punctuation">.</span>client <span class="token keyword">import</span> Dispatch

<span class="token keyword">import</span> msoffcrypto
<span class="token keyword">import</span> pandas
<span class="token keyword">import</span> io
</code></pre>
    <h3>
     <a id="win32com_42">
     </a>
     win32com
    </h3>
    <h4>
     <a id="Excel_43">
     </a>
     打开Excel，在单元格写入内容
    </h4>
    <pre><code class="prism language-python">xcl <span class="token operator">=</span> Dispatch<span class="token punctuation">(</span><span class="token string">"Excel.Application"</span><span class="token punctuation">)</span>
xcl<span class="token punctuation">.</span>Visible <span class="token operator">=</span> <span class="token number">1</span>
xcl<span class="token punctuation">.</span>Workbooks<span class="token punctuation">.</span>Add<span class="token punctuation">(</span><span class="token punctuation">)</span>
xcl<span class="token punctuation">.</span>Cells<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Value <span class="token operator">=</span> <span class="token string">"Hello"</span>
</code></pre>
    <p>
     如何知道还有什么函数？
     <br/>
     在命令行运行
     <code>
      python xxx\Lib\site-packages\win32com\client\combrowse.py
     </code>
     ，便可弹出窗口，去了解有哪些函数（发现不可行）。
     <br/>
     另外，发现微软网站
     <code>
      [2]
     </code>
     所提供的说明也可做参考。
    </p>
    <p>
     <code>
      [1] http://timgolden.me.uk/pywin32-docs/html/com/win32com/HTML/QuickStartClientCom.html
     </code>
     <br/>
     <code>
      [2] https://learn.microsoft.com/en-us/office/vba/api/Excel.Workbooks
     </code>
     <br/>
     <code>
      [3] https://www.cnblogs.com/tomato0906/articles/5994336.html
     </code>
    </p>
    <h5>
     <a id="Excel_59">
     </a>
     加密与解密Excel
    </h5>
    <pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">del_password</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> password1<span class="token punctuation">,</span> password2<span class="token punctuation">)</span><span class="token punctuation">:</span>
    xcl <span class="token operator">=</span> Dispatch<span class="token punctuation">(</span><span class="token string">"Excel.Application"</span><span class="token punctuation">)</span>
    xcl<span class="token punctuation">.</span>Visible <span class="token operator">=</span> <span class="token boolean">False</span>
    wb <span class="token operator">=</span> xcl<span class="token punctuation">.</span>Workbooks<span class="token punctuation">.</span>Open<span class="token punctuation">(</span>path<span class="token punctuation">,</span> UpdateLinks<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> ReadOnly<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> Format<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>
                            Password<span class="token operator">=</span>password1<span class="token punctuation">,</span>WriteResPassword<span class="token operator">=</span>password2<span class="token punctuation">)</span>
    xcl<span class="token punctuation">.</span>DisplayAlerts <span class="token operator">=</span> <span class="token boolean">False</span>

    <span class="token comment"># 保存时可设置访问密码</span>
    wb<span class="token punctuation">.</span>SaveAs<span class="token punctuation">(</span>path<span class="token punctuation">,</span> Password<span class="token operator">=</span><span class="token string">''</span><span class="token punctuation">,</span>WriteResPassword<span class="token operator">=</span><span class="token string">''</span><span class="token punctuation">)</span>
    xcl<span class="token punctuation">.</span>Quit<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">set_password</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> password1<span class="token punctuation">,</span> password2<span class="token punctuation">)</span><span class="token punctuation">:</span>
    xcl <span class="token operator">=</span> Dispatch<span class="token punctuation">(</span><span class="token string">"Excel.Application"</span><span class="token punctuation">)</span>
    <span class="token comment"># 路径为绝对路径，不能为相对路径报错</span>
    wb <span class="token operator">=</span> xcl<span class="token punctuation">.</span>Workbooks<span class="token punctuation">.</span>Open<span class="token punctuation">(</span>path<span class="token punctuation">)</span>
    xcl<span class="token punctuation">.</span>DisplayAlerts <span class="token operator">=</span> <span class="token boolean">False</span>

    <span class="token comment"># 保存时可设置访问密码</span>
    wb<span class="token punctuation">.</span>SaveAs<span class="token punctuation">(</span>path<span class="token punctuation">,</span> Password<span class="token operator">=</span>password1<span class="token punctuation">,</span> WriteResPassword<span class="token operator">=</span>password2<span class="token punctuation">)</span>
    xcl<span class="token punctuation">.</span>Quit<span class="token punctuation">(</span><span class="token punctuation">)</span>

set_password<span class="token punctuation">(</span>abspath<span class="token punctuation">,</span> <span class="token string">'123'</span><span class="token punctuation">,</span> <span class="token string">'456'</span><span class="token punctuation">)</span>
<span class="token comment"># del_password(abspath, '123', '456')</span>
</code></pre>
    <p>
     Path：绝对路径，如果是相对路径会报错
     <br/>
     Password：工作簿密码
     <br/>
     WriteResPassword：工作簿只读密码（可以修改，但无法以原文件名命名）
    </p>
    <p>
     <code>
      [1] https://www.cnblogs.com/vhills/p/9418860.html
     </code>
     <br/>
     <code>
      [2] http://t.csdn.cn/INOCQ
     </code>
    </p>
    <h3>
     <a id="xlwings_92">
     </a>
     xlwings
    </h3>
    <pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">set_password2</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> password<span class="token punctuation">)</span><span class="token punctuation">:</span>
    app<span class="token operator">=</span>xlwings<span class="token punctuation">.</span>App<span class="token punctuation">(</span>visible<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>add_book<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
    app<span class="token punctuation">.</span>display_alerts<span class="token operator">=</span><span class="token boolean">False</span>
    app<span class="token punctuation">.</span>screen_updating<span class="token operator">=</span><span class="token boolean">False</span> <span class="token comment">#关闭屏幕更新,可加快宏的执行速度</span>
    wb<span class="token operator">=</span>app<span class="token punctuation">.</span>books<span class="token punctuation">.</span><span class="token builtin">open</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span>
    wb<span class="token punctuation">.</span>save<span class="token punctuation">(</span>path<span class="token punctuation">,</span> password<span class="token operator">=</span>password<span class="token punctuation">)</span>
    wb<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
    app<span class="token punctuation">.</span>quit<span class="token punctuation">(</span><span class="token punctuation">)</span>
    
<span class="token keyword">def</span> <span class="token function">del_password2</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> password<span class="token punctuation">)</span><span class="token punctuation">:</span>
    app<span class="token operator">=</span>xlwings<span class="token punctuation">.</span>App<span class="token punctuation">(</span>visible<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>add_book<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
    app<span class="token punctuation">.</span>display_alerts<span class="token operator">=</span><span class="token boolean">False</span>
    app<span class="token punctuation">.</span>screen_updating<span class="token operator">=</span><span class="token boolean">False</span> <span class="token comment">#关闭屏幕更新,可加快宏的执行速度</span>
    wb<span class="token operator">=</span>app<span class="token punctuation">.</span>books<span class="token punctuation">.</span><span class="token builtin">open</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> password<span class="token operator">=</span>password<span class="token punctuation">)</span>
    wb<span class="token punctuation">.</span>save<span class="token punctuation">(</span>path<span class="token punctuation">,</span> password<span class="token operator">=</span><span class="token string">''</span><span class="token punctuation">)</span>
    wb<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
    app<span class="token punctuation">.</span>quit<span class="token punctuation">(</span><span class="token punctuation">)</span>

del_password2<span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token string">'123'</span><span class="token punctuation">)</span>
</code></pre>
    <p>
     Save函数没有
     <code>
      write_res_password
     </code>
     参数，Open函数有
     <code>
      write_res_password
     </code>
     参数，导致设置只读密码后，无法取消。
     <br/>
     用起来和win32com无异，只不过官方给出了文档。
    </p>
    <p>
     <code>
      [1] https://docs.xlwings.org/en/stable/api.html
     </code>
     <br/>
     <code>
      [2] Python操作Excel的Xlwings教程（一） - 那个百分十先生的文章 - 知乎 https://zhuanlan.zhihu.com/p/149878144
     </code>
    </p>
    <h3>
     <a id="openpyxl_120">
     </a>
     openpyxl
    </h3>
    <pre><code class="prism language-python"><span class="token comment"># -----------------读取excel</span>
wb <span class="token operator">=</span> openpyxl<span class="token punctuation">.</span>load_workbook<span class="token punctuation">(</span>path<span class="token punctuation">)</span>
ws <span class="token operator">=</span> wb<span class="token punctuation">.</span>active
<span class="token comment"># 密码</span>
<span class="token comment">#ws.protection.disable()</span>
ws<span class="token punctuation">.</span>protection<span class="token punctuation">.</span>password <span class="token operator">=</span> <span class="token string">'789'</span>
<span class="token comment"># 保存</span>
wb<span class="token punctuation">.</span>save<span class="token punctuation">(</span>path<span class="token punctuation">)</span>

<span class="token comment"># --------------------创建excel</span>
<span class="token comment"># 创建excel</span>
wb <span class="token operator">=</span> openpyxl<span class="token punctuation">.</span>Workbook<span class="token punctuation">(</span><span class="token punctuation">)</span>
ws <span class="token operator">=</span> wb<span class="token punctuation">.</span>active
ws<span class="token punctuation">.</span>protection<span class="token punctuation">.</span>password <span class="token operator">=</span> <span class="token string">'789'</span>
wb<span class="token punctuation">.</span>security<span class="token punctuation">.</span>lockStructure <span class="token operator">=</span> <span class="token boolean">True</span>
wb<span class="token punctuation">.</span>save<span class="token punctuation">(</span>path<span class="token punctuation">)</span>
</code></pre>
    <p>
     读取现有文件，只能对工作表加密，
     <code>
      ws.protection.password
     </code>
     可设置密码，
     <code>
      ws.protection.disable()
     </code>
     可取消密码。
     <br/>
     openpyxl较前两种速度快，但无法对工作簿加密。
    </p>
    <p>
     如果是创建新的excel，则还可以设置锁定工作簿结构，但由于不能设置密码，用户可以直接在excel中取消。
    </p>
    <p>
     <code>
      [1] https://www.osgeo.cn/openpyxl/protection.html
     </code>
    </p>
    <h3>
     <a id="msoffcrypto_145">
     </a>
     msoffcrypto
    </h3>
    <pre><code class="prism language-python"><span class="token builtin">file</span> <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token string">'rb'</span><span class="token punctuation">)</span>
decrypted <span class="token operator">=</span> io<span class="token punctuation">.</span>BytesIO<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">#在内存中创建一个字节流</span>
<span class="token keyword">if</span> msoffcrypto<span class="token punctuation">.</span>olefile<span class="token punctuation">.</span>isOleFile<span class="token punctuation">(</span><span class="token builtin">file</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token comment">#确定文件被加密</span>
    xlf <span class="token operator">=</span> msoffcrypto<span class="token punctuation">.</span>OfficeFile<span class="token punctuation">(</span><span class="token builtin">file</span><span class="token punctuation">)</span>   <span class="token comment">#用msoffcrypto打开加密文件,未加密文件用这个打开会报错</span>
    xlf<span class="token punctuation">.</span>load_key<span class="token punctuation">(</span>password<span class="token operator">=</span><span class="token string">'123'</span><span class="token punctuation">)</span>   <span class="token comment">#传入文件的密码</span>
    xlf<span class="token punctuation">.</span>decrypt<span class="token punctuation">(</span>decrypted<span class="token punctuation">)</span>   <span class="token comment"># 将文件解密并保存到内存中</span>
    pd_excel <span class="token operator">=</span> pandas<span class="token punctuation">.</span>read_excel<span class="token punctuation">(</span>decrypted<span class="token punctuation">,</span> sheet_name<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> header<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>  <span class="token comment"># 将保存到内存中的文件用pandas打开</span>
    <span class="token comment"># 输出表头</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>pd_excel<span class="token punctuation">.</span>head<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment"># 关闭</span>
decrypted<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token builtin">file</span><span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
    <p>
     <code>
      [1] http://t.csdn.cn/OZ609
     </code>
     <br/>
     <code>
      [2] https://www.runoob.com/python/python-func-open.html
     </code>
     <br/>
     <code>
      [3] https://msoffcrypto-tool.readthedocs.io/en/latest/msoffcrypto.html
     </code>
     <br/>
     <code>
      [4] pandas. https://www.cnblogs.com/yfacesclub/p/11232736.html
     </code>
     <br/>
     <code>
      [5] BytesIO. http://t.csdn.cn/1eyBR
     </code>
    </p>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f62:6c6f672e6373646e2e6e65742f71715f33373038333033382f:61727469636c652f64657461696c732f313238373038313432" class_="artid" style="display:none">
 </p>
</div>


