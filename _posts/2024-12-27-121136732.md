---
layout: post
title: "clickhouse数据库备份"
date: 2024-12-27 10:06:53 +0800
description: "1. 文本文件导入导出以下只备份数据，不包含创建库和表，需要事先创建在导人导出clickhouse-"
keywords: "clickhouse备份数据库命令"
categories: ['Clickhouse']
tags: ['数据库', 'Database']
artid: "121136732"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=121136732
    alt: "clickhouse数据库备份"
render_with_liquid: false
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     clickhouse数据库备份
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-dracula" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <h2>
     <a id="1__0">
     </a>
     1. 文本文件导入导出
    </h2>
    <p>
     以下只备份数据，不包含创建库和表，需要事先创建在导人
    </p>
    <h3>
     <a id="_2">
     </a>
     导出
    </h3>
    <pre><code class="prism language-bash">clickhouse-client -h <span class="token number">127.0</span>.0.1 --query<span class="token operator">=</span><span class="token string">"select * from db.test"</span> <span class="token operator">&gt;</span> test.csv
</code></pre>
    <h3>
     <a id="_FORMAT_test_8">
     </a>
     导入 (注意FORMAT后面大写) 多个文件导人可以用test.*
    </h3>
    <pre><code class="prism language-bash">clickhouse-client --query<span class="token operator">=</span><span class="token string">"insert into db.test FORMAT CSV"</span><span class="token operator">&lt;</span>test.csv
</code></pre>
    <p>
     报错
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/1b8ce302decc8144e57d765c2dbad705.png">
      <br/>
      以上是在ClickHouse数据搬迁时，将数据导入到CVS文件中，再从文件导入表时发生的
     </img>
    </p>
    <p>
     实际测试如下：中英文逗号和中文顿号都会报这个错误 Code: 27. DB::ParsingException: Cannot parse input: expected
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/c49ed43af1223b0c5d00f6166272f972.png">
      <br/>
      原因：
      <br/>
      TSV：tab separated values；即“制表符分隔值”，用制表符分隔数据
      <br/>
      CSV： comma separated values；即“逗号分隔值”，用逗号分隔数据
      <br/>
      特殊字符导致数据解析出错
     </img>
    </p>
    <p>
     解决办法：以TSV格式导入文件内容即可
    </p>
    <pre><code class="prism language-bash">clickhouse-client --query<span class="token operator">=</span><span class="token string">"insert into db.test FORMAT TSV"</span><span class="token operator">&lt;</span>test.csv
</code></pre>
    <h2>
     <a id="2_clickhousebackup_32">
     </a>
     2. 使用clickhouse-backup备份
    </h2>
    <p>
     一、官方资料和使用说明:
     <br/>
     参考文档资料如下:
     <br/>
     https://github.com/AlexAkulov/clickhouse-backup
     <br/>
     https://segmentfault.com/a/1190000038604737
     <br/>
     #使用限制：
    </p>
    <ul>
     <li>
      支持1.1.54390以上的ClickHouse
     </li>
     <li>
      仅MergeTree系列表引擎
     </li>
     <li>
      不支持备份Tiered storage或storage_policy
     </li>
     <li>
      云存储上的最大备份大小为5TB
     </li>
     <li>
      AWS S3上的parts数最大为10,000
     </li>
    </ul>
    <p>
     链接：
     <a href="https://pan.baidu.com/s/1OXv7Cy_nNV-_tMOLbmyaFg" rel="nofollow">
      https://pan.baidu.com/s/1OXv7Cy_nNV-_tMOLbmyaFg
     </a>
     <br/>
     提取码：8gx7
    </p>
    <blockquote>
     <p>
      我尝试过许多版本，不是缺少数据目录，就是表结构，最后是用我百度网盘的二进制文件成功的
     </p>
    </blockquote>
    <p>
     二、安装方式：
     <br/>
     2.1、二进制文件安装：
     <br/>
     clickhouse-backup下载:
    </p>
    <pre><code class="prism language-bash"><span class="token function">tar</span> -xf clickhouse-backup.tar.gz 
<span class="token builtin class-name">cd</span> clickhouse-backup / 
<span class="token function">sudo</span> <span class="token function">cp</span> clickhouse-backup  /usr/local/bin
</code></pre>
    <p>
     2.2、下载rpm安装包安装:
    </p>
    <pre><code class="prism language-bash"><span class="token function">rpm</span> -ivh clickhouse-backup-1.0.0-1.x86_64.rpm
</code></pre>
    <h2>
     <a id="_70">
     </a>
     编辑配置文件：
    </h2>
    <p>
     mkdir -p /etc/clickhouse-backup/
     <br/>
     vi /etc/clickhouse-backup/config.yml
     <br/>
     添加一些基本的配置信息
    </p>
    <pre><code>general:
  remote_storage: none
  max_file_size: 107374182400
  disable_progress_bar: true
  backups_to_keep_local: 0
  backups_to_keep_remote: 0
  log_level: info
  allow_empty_backups: false
  download_concurrency: 1
  upload_concurrency: 1
clickhouse:
  username: default
  password: ""
  host: 10.0.18.252
  port: 9000
  data_path: ""     #尝试过修改这个不起作用，应该是这个版本bug,默认在ck的数据目录
  skip_tables:
  - system.*
  timeout: 5m
  freeze_by_part: false
  secure: false
  skip_verify: false
</code></pre>
    <p>
     #查看全部默认的配置项
    </p>
    <pre><code class="prism language-bash">clickhouse-backup default-config
</code></pre>
    <p>
     #查看可备份的表
    </p>
    <pre><code class="prism language-bash">clickhouse-backup tables
</code></pre>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/ef8d9f74b4eca5f39241e264e7a1af1c.png"/>
    </p>
    <h2>
     <a id="_114">
     </a>
     创建备份
    </h2>
    <ol>
     <li>
      全库备份
     </li>
    </ol>
    <p>
     clickhouse-backup create
     <br/>
     备份存储在中 $data_path/backup 下，备份名称默认为时间戳，可手动指定备份名称。例如：
    </p>
    <pre><code class="prism language-bash">clickhouse-backup create ch_bk_20211123
</code></pre>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/2d8955a0ae75ab2281f10cc284f00e13.png">
      <br/>
      <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/3c36f361454ba977e54b6d0998ff3fdb.png">
       <br/>
       <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/fefe824c8c7c8934db3cbcd1545a28ca.png"/>
      </img>
     </img>
    </p>
    <p>
     备份包含两个目录：
    </p>
    <p>
     'metadata’目录: 包含重新创建所需的DDL SQL
    </p>
    <p>
     'shadow’目录: 包含作为ALTER TABLE … FREEZE操作结果的数据。
     <br/>
     2. 单表备份
    </p>
    <p>
     语法：
    </p>
    <pre><code class="prism language-bash">clickhouse-backup create <span class="token punctuation">[</span>-t, --tables<span class="token operator">=</span><span class="token operator">&lt;</span>db<span class="token operator">&gt;</span>.<span class="token operator">&lt;</span>table<span class="token operator">&gt;</span><span class="token punctuation">]</span> <span class="token operator">&lt;</span>backup_name<span class="token operator">&gt;</span>
</code></pre>
    <p>
     备份表caihao.ch_test_customer
    </p>
    <pre><code class="prism language-bash">clickhouse-backup create  -t caihao.ch_test_customer ch_test_customer 
</code></pre>
    <ol start="3">
     <li>
      备份多个表
     </li>
    </ol>
    <pre><code class="prism language-bash">clickhouse-backup create  -t caihao.test_restore_tab,caihao.ch1 ch_bak_2tab
</code></pre>
    <p>
     #查看备份文件
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/73cc10746b14f71ee01b2b5dc71882f2.png"/>
    </p>
    <p>
     #删除备份文件
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/a11927c4b9be649b95a2e5f22c07a853.png">
      <br/>
      #清除shadow下的临时备份文件
      <br/>
      <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/6e9fe92ebcae7c628f3e365d4538b24c.png"/>
     </img>
    </p>
    <h2>
     <a id="_160">
     </a>
     数据恢复
    </h2>
    <p>
     语法：
    </p>
    <pre><code class="prism language-bash">clickhouse-backup restore 备份名
</code></pre>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/c2fdd57758ea5d5d1fa40ea227db807e.png"/>
     <br/>
     进入数据库查看
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/460ba659370f8321b4aa9802bc704efc.png"/>
     <br/>
     成功，撒花
     <br/>
     一些参数：
    </p>
    <ul>
     <li>
      –table 只恢复特定表，可使用正则。
     </li>
     <li>
      如针对特定的数据库：–table=dbname.*
     </li>
     <li>
      –schema 只还原表结构
     </li>
     <li>
      –data 只还原数据
     </li>
    </ul>
    <p>
     总结有部分本地表没有备份，仅MergeTree系列表引擎表备份了
     <br/>
     如果需要迁移可以把metadata，'shadow’目录移动过去在安装clickhouse-backup进行数据恢复
    </p>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f:2f626c6f672e6373646e2e6e65742f613133353638686b692f:61727469636c652f64657461696c732f313231313336373332" class_="artid" style="display:none">
 </p>
</div>


