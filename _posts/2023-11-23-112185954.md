---
layout: post
title: "微信小程序云数据库定时清空云函数定时触发"
date: 2023-11-23 20:50:22 +0800
description: "需求：微信小程序云数据库某表仅保留当天数据，因此每天固定某时间清空一次实现：1.新建云函数timer"
keywords: "微信小程序云开发每天清空数据"
categories: ['小程序云开发', '小程序']
tags: ['小程序', '云开发']
artid: "112185954"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=112185954
    alt: "微信小程序云数据库定时清空云函数定时触发"
render_with_liquid: false
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     微信小程序云数据库定时清空（云函数定时触发）
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <p>
     <strong>
      需求
     </strong>
     ：
     <br/>
     微信小程序云数据库某表仅保留当天数据，因此每天固定某时间清空一次
     <br/>
     <strong>
      实现
     </strong>
     ：
    </p>
    <p>
     1.新建云函数timer
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/a30cba2b6ab2e508e690dfc7ed10fe80.png#pic_center"/>
    </p>
    <p>
     2.在timer/config.json中配置定时器
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/e6787e114afd45892dffaeae42b90f74.png#pic_center"/>
    </p>
    <pre><code class="prism language-javascript"><span class="token punctuation">{<!-- --></span>
  <span class="token string">"triggers"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{<!-- --></span>
      <span class="token string">"name"</span><span class="token punctuation">:</span> <span class="token string">"myTrigger"</span><span class="token punctuation">,</span>
      <span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"timer"</span><span class="token punctuation">,</span>
      <span class="token string">"config"</span><span class="token punctuation">:</span> <span class="token string">"0 25 16 * * * *"</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     其中，“config”格式为“秒 分 时 日 月 星期 年”，具体配置见
     <a href="https://www.bookstack.cn/read/wxcloud-201912/d0f824b49f9ba8a5.md" rel="nofollow">
      https://www.bookstack.cn/read/wxcloud-201912/d0f824b49f9ba8a5.md
     </a>
    </p>
    <p>
     按照我的设置，表示每天16：25触发一次。
    </p>
    <p>
     3.timer/index.js中，exports.main内写需要进行的操作
    </p>
    <pre><code class="prism language-javascript"><span class="token comment">// 云函数入口文件</span>
<span class="token keyword">const</span> cloud <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'wx-server-sdk'</span><span class="token punctuation">)</span>

cloud<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> db <span class="token operator">=</span> cloud<span class="token punctuation">.</span><span class="token function">database</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 云函数入口函数</span>
exports<span class="token punctuation">.</span>main <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span>event<span class="token punctuation">,</span> context<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
<span class="token comment">/*********写需要进行的操作
  try{
    return await db.collection('receive').where({
      all:null
    }).remove({
      success(res){
        return res
      },
      fail(err){
        return err
      }
    })
  }catch(e){
    console.log(e)
  }
  *************/</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     若使用注释间我写的代码，注意，若想将数据库某表内容全部清空，where中应为
     <strong>
      表中不存在的字段:null
     </strong>
    </p>
    <p>
     4.在微信开发者工具中右击timer文件夹，选择“
     <strong>
      在外部终端窗口中打开
     </strong>
     ”，输入命令行
    </p>
    <pre><code class="prism language-javascript">npm install <span class="token operator">--</span>save wx<span class="token operator">-</span>server<span class="token operator">-</span>sdk@latest
</code></pre>
    <p>
     等待依赖安装完毕后，右击timer，选择“
     <strong>
      上传并部署：云端安装依赖（不上传node_modules）
     </strong>
     ”；再选择“
     <strong>
      上传触发器
     </strong>
     ”。
    </p>
    <p>
     至此，定时触发功能的云函数部署完毕。
    </p>
    <p>
     4.查看云函数执行记录
     <br/>
     打开云开发控制台，选择“云函数”一项，点击“日志”。可以看到云函数调用情况
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/7ade48aefc11e3ea4e7947d915cba75f.png#pic_center"/>
    </p>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f626c6f672e:6373646e2e6e65742f77656978696e5f34333930303838382f:61727469636c652f64657461696c732f313132313835393534" class_="artid" style="display:none">
 </p>
</div>


