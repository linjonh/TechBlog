---
layout: post
title: "微信小程序登录后端开发流程附go后端实现代码"
date: 2025-01-12 16:38:25 +0800
description: "参考:微信官方文档 * 小程序登录流程微信官方文档 * 小程序本文参考以上文档, 加上自己理解整合写"
keywords: "微信小程序 gin post"
categories: ['其他']
tags: ['微信小程序登录']
artid: "102873903"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=102873903
    alt: "微信小程序登录后端开发流程附go后端实现代码"
render_with_liquid: false
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     微信小程序登录后端开发流程(附go后端实现代码)
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-github-gist" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <p>
     参考:
     <br/>
     <a href="https://developers.weixin.qq.com/miniprogram/dev/framework/open-ability/login.html" rel="nofollow">
      微信官方文档 * 小程序登录流程
     </a>
     <br/>
     <a href="https://developers.weixin.qq.com/miniprogram/dev/api-backend/open-api/login/auth.code2Session.html" rel="nofollow">
      微信官方文档 * 小程序
     </a>
    </p>
    <p>
     本文参考以上文档, 加上自己理解整合写出.
    </p>
    <h3>
     <a id="_7">
     </a>
     登录流程
    </h3>
    <ol>
     <li>
      前端调用
      <code>
       wx.login()
      </code>
      获取 临时登录凭证
      <code>
       code
      </code>
      ，并回传到开发者服务器。
     </li>
     <li>
      后端调用
      <code>
       auth.code2Session
      </code>
      接口，换取 用户唯一标识
      <code>
       OpenID
      </code>
      和
      <code>
       会话密钥 session_key
      </code>
      。
     </li>
     <li>
      开发者服务器可以根据用
      <code>
       户标识
      </code>
      来生成
      <code>
       自定义登录态
      </code>
      ，用于后续业务逻辑中前后端交互时识别用户身份。
      <br/>
      <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/f0938c6240a9f5dac735655fbdc5f6fe.png">
       <br/>
       上图就是小程序登录的基本流程.
      </img>
     </li>
    </ol>
    <p>
     作为一个后端开发人员, 看完上述描述后, 内心是这样的:
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/7dc19703b09120b5a86ad9d85072b5f7.png#pic_center">
      <br/>
      嗯, 道理我都懂, 代码怎么写?
     </img>
    </p>
    <p>
     接下来我们用go实现这个流程:
    </p>
    <p>
     首先
     <code>
      code
     </code>
     是前端获取传到后端的, 我们不用管, 只要在HTTP请求种拿到这个参数即可.
     <br/>
     ok, 第一步的code已经拿到.
    </p>
    <p>
     然后第二步, 利用code获取
     <code>
      openID
     </code>
     和
     <code>
      session_key
     </code>
     , 这里我们看微信官方文档给的接口:
    </p>
    <blockquote>
     <p>
      https://api.weixin.qq.com/sns/jscode2session?appid=APPID&amp;secret=SECRET&amp;js_code=JSCODE&amp;grant_type=authorization_code
     </p>
    </blockquote>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/9564966abe727404ab01e3cc58c4ff7d.png">
      <br/>
      <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/a5e89e039d39da32cee528c10b56d63f.png">
       <br/>
       <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/a72644de5b6d497b04b642d024b2417f.png">
        <br/>
        到这里有接口. 有返回值, 我们就可以通过HTTP请求获取
        <code>
         openID
        </code>
        和
        <code>
         session_key
        </code>
        了.
       </img>
      </img>
     </img>
    </p>
    <p>
     现在开始写代码实现, 我使用的是go语言, 其实道理都是一样的.
    </p>
    <p>
     定义返回值数据结构:
    </p>
    <pre><code class="prism language-go"><span class="token keyword">type</span> WXLoginResp <span class="token keyword">struct</span> <span class="token punctuation">{<!-- --></span>
	OpenId <span class="token builtin">string</span>			<span class="token string">`json:"openid"`</span>
	SessionKey <span class="token builtin">string</span>		<span class="token string">`json:"session_key"`</span>
	UnionId <span class="token builtin">string</span>			<span class="token string">`json:"unionid"`</span>
	ErrCode <span class="token builtin">int</span>				<span class="token string">`json:"errcode"`</span>
	ErrMsg <span class="token builtin">string</span> 			<span class="token string">`json:"errmsg"`</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     定义实现函数:
    </p>
    <pre><code class="prism language-go"><span class="token comment">// 这个函数以 code 作为输入, 返回调用微信接口得到的对象指针和异常情况</span>
<span class="token keyword">func</span> <span class="token function">WXLogin</span><span class="token punctuation">(</span>code <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>WXLoginResp<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	url <span class="token operator">:=</span> <span class="token string">"https://api.weixin.qq.com/sns/jscode2session?appid=%s&amp;secret=%s&amp;js_code=%s&amp;grant_type=authorization_code"</span>
	
	<span class="token comment">// 合成url, 这里的appId和secret是在微信公众平台上获取的</span>
	url <span class="token operator">=</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> appId<span class="token punctuation">,</span> secret<span class="token punctuation">,</span> code<span class="token punctuation">)</span>  

	<span class="token comment">// 创建http get请求</span>
	resp<span class="token punctuation">,</span>err <span class="token operator">:=</span> http<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
	<span class="token punctuation">}</span>
	<span class="token keyword">defer</span> resp<span class="token punctuation">.</span>Body<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	<span class="token comment">// 解析http请求中body 数据到我们定义的结构体中</span>
	wxResp <span class="token operator">:=</span> WXLoginResp<span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
	decoder <span class="token operator">:=</span> json<span class="token punctuation">.</span><span class="token function">NewDecoder</span><span class="token punctuation">(</span>resp<span class="token punctuation">.</span>Body<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">:=</span> decoder<span class="token punctuation">.</span><span class="token function">Decode</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>wxResp<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
	<span class="token punctuation">}</span>
		
	<span class="token comment">// 判断微信接口返回的是否是一个异常情况</span>
	<span class="token keyword">if</span> wxResp<span class="token punctuation">.</span>ErrCode <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span>fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"ErrCode:%s  ErrMsg:%s"</span><span class="token punctuation">,</span> wxResp<span class="token punctuation">.</span>ErrCode<span class="token punctuation">,</span> wxResp<span class="token punctuation">.</span>ErrMsg<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">return</span> <span class="token operator">&amp;</span>wxResp<span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     ok, 到这里, 我们已经获得了
     <code>
      openid
     </code>
     和
     <code>
      session_key
     </code>
     .
    </p>
    <p>
     接下来实现第三步, 这一步比较灵活, 根据自己的需求生成自定义登录态, 并返回前端;
    </p>
    <p>
     这里我们用
     <code>
      gin
     </code>
     框架实现一个路由接口, 将上面的内容串联起来, 形成一个完整的流程;下面的代码仅供参考
    </p>
    <pre><code class="prism language-go"><span class="token comment">// /wechat/applet_login?code=xxx [get]  路由</span>
<span class="token comment">// 微信小程序登录</span>
<span class="token keyword">func</span> <span class="token function">AppletWeChatLogin</span><span class="token punctuation">(</span>c <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	code <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">Query</span><span class="token punctuation">(</span><span class="token string">"code"</span><span class="token punctuation">)</span>     <span class="token comment">//  获取code</span>
	<span class="token comment">// 根据code获取 openID 和 session_key</span>
	wxLoginResp<span class="token punctuation">,</span>err <span class="token operator">:=</span> models<span class="token punctuation">.</span><span class="token function">WXLogin</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
		c<span class="token punctuation">.</span><span class="token function">JSON</span><span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">,</span> util<span class="token punctuation">.</span><span class="token function">Fail</span><span class="token punctuation">(</span>err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>
	<span class="token comment">// 保存登录态</span>
	session <span class="token operator">:=</span> sessions<span class="token punctuation">.</span><span class="token function">Default</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span>
	session<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span><span class="token string">"openid"</span><span class="token punctuation">,</span> wxLoginResp<span class="token punctuation">.</span>OpenId<span class="token punctuation">)</span>
	session<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span><span class="token string">"sessionKey"</span><span class="token punctuation">,</span> wxLoginResp<span class="token punctuation">.</span>SessionKey <span class="token punctuation">)</span>
	
	<span class="token comment">// 这里用openid和sessionkey的串接 进行MD5之后作为该用户的自定义登录态</span>
	mySession <span class="token operator">:=</span> <span class="token function">GetMD5Encode</span><span class="token punctuation">(</span>wxLoginResp<span class="token punctuation">.</span>OpenId <span class="token operator">+</span> wxLoginResp<span class="token punctuation">.</span>SessionKey<span class="token punctuation">)</span>
	<span class="token comment">// 接下来可以将openid 和 sessionkey, mySession 存储到数据库中, </span>
	<span class="token comment">// 但这里要保证mySession 唯一, 以便于用mySession去索引openid 和sessionkey</span>
	c<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span> mySession<span class="token punctuation">)</span>
	
<span class="token punctuation">}</span>
<span class="token comment">// 将一个字符串进行MD5加密后返回加密后的字符串</span>
<span class="token keyword">func</span> <span class="token function">GetMD5Encode</span><span class="token punctuation">(</span>data <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{<!-- --></span>
	h <span class="token operator">:=</span> md5<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	h<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span> hex<span class="token punctuation">.</span><span class="token function">EncodeToString</span><span class="token punctuation">(</span>h<span class="token punctuation">.</span><span class="token function">Sum</span><span class="token punctuation">(</span><span class="token boolean">nil</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     可能代码部分不太能看懂, 这里再用文字解释一下:
    </p>
    <ol>
     <li>
      获取路由中的
      <code>
       code
      </code>
      参数
     </li>
     <li>
      利用
      <code>
       code
      </code>
      调用我们之前写好的函数获取
      <code>
       openid
      </code>
      和
      <code>
       session_key
      </code>
     </li>
     <li>
      利用得到的
      <code>
       openid
      </code>
      和
      <code>
       session_key
      </code>
      生成我们自定义的登录态(这里方式有很多, 保证生成的值全局唯一即可, 这里我们简单化了, 直接利用
      <code>
       openid
      </code>
      和
      <code>
       session_key
      </code>
      进行MD5加密, 将得到的字符串作为我们的登录态(这里登录态理解为索引即可, 本质是一个字符串))
     </li>
     <li>
      最后将我们定义的登录态以及
      <code>
       openid
      </code>
      和
      <code>
       session_key
      </code>
      存储到数据库中, 并且保证能用自定义的登录态唯一查询到该用户的
      <code>
       openid
      </code>
      和
      <code>
       session_key
      </code>
      . 以便我们后期用到的时候可以查询到.
     </li>
    </ol>
    <p>
     到这里微信小程序登录已经基本完成了.
    </p>
    <p>
     这里, 微信官方还提供了一个校验接口, 用于校验小程序端获取的用户信息是否完整,这个也是我们之前获得的
     <code>
      session_key
     </code>
     的意义,
    </p>
    <p>
     这里可以参考:
     <a href="https://developers.weixin.qq.com/miniprogram/dev/framework/open-ability/signature.html" rel="nofollow">
      微信官方文档 * 后台校验与解密数据
     </a>
    </p>
    <p>
     我们也给出校验代码, 非常简单:
     <br/>
     实际上就是将前端提供的微信原始数据和我们之前获取的session_key进行MD5加密, 得到signature2, 与微信加密的结果进行比较, 相同即为没有改变, 不同即是原始数据发生了改变.
    </p>
    <pre><code class="prism language-go"><span class="token comment">// 校验微信返回的用户数据</span>
<span class="token keyword">func</span> <span class="token function">ValidateUserInfo</span><span class="token punctuation">(</span>rawData<span class="token punctuation">,</span> sessionKey<span class="token punctuation">,</span> signature <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{<!-- --></span>
	signature2 <span class="token operator">:=</span> <span class="token function">GetSha1</span><span class="token punctuation">(</span>rawData <span class="token operator">+</span> sessionKey<span class="token punctuation">)</span>
	<span class="token keyword">return</span> signature <span class="token operator">==</span> signature2
<span class="token punctuation">}</span>
<span class="token comment">// SHA-1 加密</span>
<span class="token keyword">func</span> <span class="token function">GetSha1</span><span class="token punctuation">(</span>str <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{<!-- --></span>
	data <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span>
	has <span class="token operator">:=</span> sha1<span class="token punctuation">.</span><span class="token function">Sum</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
	res <span class="token operator">:=</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"%x"</span><span class="token punctuation">,</span> has<span class="token punctuation">)</span> <span class="token comment">//将[]byte转成16进制</span>
	<span class="token keyword">return</span> res
<span class="token punctuation">}</span>
</code></pre>
    <p>
     以上就是微信小程序登录, 后台涉及到的所有操作.
    </p>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f626c6f672e:6373646e2e6e65742f77656978696e5f33383438313936332f:61727469636c652f64657461696c732f313032383733393033" class_="artid" style="display:none">
 </p>
</div>


